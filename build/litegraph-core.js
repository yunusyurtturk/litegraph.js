/*packed*/const LiteGraph={VERSION:.4,CANVAS_GRID_SIZE:10,NODE_TITLE_HEIGHT:30,NODE_TITLE_TEXT_Y:20,NODE_SLOT_HEIGHT:20,NODE_WIDGET_HEIGHT:20,NODE_WIDTH:140,NODE_MIN_WIDTH:50,NODE_COLLAPSED_RADIUS:10,NODE_COLLAPSED_WIDTH:80,NODE_TITLE_COLOR:"#999",NODE_SELECTED_TITLE_COLOR:"#FFF",NODE_TEXT_SIZE:14,NODE_TEXT_COLOR:"#AAA",NODE_SUBTEXT_SIZE:12,NODE_DEFAULT_COLOR:"#333",NODE_DEFAULT_BGCOLOR:"#353535",NODE_DEFAULT_BOXCOLOR:"#666",NODE_DEFAULT_SHAPE:"box",NODE_BOX_OUTLINE_COLOR:"#FFF",DEFAULT_SHADOW_COLOR:"rgba(0,0,0,0.5)",DEFAULT_GROUP_FONT:24,WIDGET_BGCOLOR:"#222",WIDGET_OUTLINE_COLOR:"#666",WIDGET_TEXT_COLOR:"#DDD",WIDGET_SECONDARY_TEXT_COLOR:"#999",LINK_COLOR:"#9A9",EVENT_LINK_COLOR:"#A86",CONNECTING_LINK_COLOR:"#AFA",MAX_NUMBER_OF_NODES:1e3,DEFAULT_POSITION:[100,100],VALID_SHAPES:["default","box","round","card"],BOX_SHAPE:1,ROUND_SHAPE:2,CIRCLE_SHAPE:3,CARD_SHAPE:4,ARROW_SHAPE:5,GRID_SHAPE:6,INPUT:1,OUTPUT:2,EVENT:-1,ACTION:-1,NODE_MODES:["Always","On Event","Never","On Trigger"],NODE_MODES_COLORS:["#666","#422","#333","#224","#626"],ALWAYS:0,ON_EVENT:1,NEVER:2,ON_TRIGGER:3,UP:1,DOWN:2,LEFT:3,RIGHT:4,CENTER:5,LINK_RENDER_MODES:["Straight","Linear","Spline"],STRAIGHT_LINK:0,LINEAR_LINK:1,SPLINE_LINK:2,NORMAL_TITLE:0,NO_TITLE:1,TRANSPARENT_TITLE:2,AUTOHIDE_TITLE:3,VERTICAL_LAYOUT:"vertical",proxy:null,node_images_path:"",debug:!1,catch_exceptions:!0,throw_errors:!0,allow_scripts:!1,use_deferred_actions:!0,registered_node_types:{},node_types_by_file_extension:{},Nodes:{},Globals:{},searchbox_extras:{},auto_sort_node_types:!1,node_box_coloured_when_on:!1,node_box_coloured_by_mode:!1,dialog_close_on_mouse_leave:!0,dialog_close_on_mouse_leave_delay:500,shift_click_do_break_link_from:!1,click_do_break_link_to:!1,search_hide_on_mouse_leave:!0,search_filter_enabled:!1,search_show_all_on_open:!0,auto_load_slot_types:!1,registered_slot_in_types:{},registered_slot_out_types:{},slot_types_in:[],slot_types_out:[],slot_types_default_in:[],slot_types_default_out:[],alt_drag_do_clone_nodes:!1,do_add_triggers_slots:!1,allow_multi_output_for_events:!0,middle_click_slot_add_default_node:!1,release_link_on_empty_shows_menu:!1,pointerevents_method:"mouse",ctrl_shift_v_paste_connect_unselected_outputs:!1,use_uuids:!1,registerNodeType:function(type,base_class){if(!base_class.prototype)throw"Cannot register a simple object, it must be a class with a prototype";base_class.type=type,LiteGraph.debug&&console.log("Node registered: "+type);var i,classname=base_class.name,pos=type.lastIndexOf("/");for(i in base_class.category=type.substring(0,pos),base_class.title||(base_class.title=classname),LGraphNode.prototype)base_class.prototype[i]||(base_class.prototype[i]=LGraphNode.prototype[i]);pos=this.registered_node_types[type];if(pos&&console.log("replacing node type: "+type),!Object.prototype.hasOwnProperty.call(base_class.prototype,"shape")&&(Object.defineProperty(base_class.prototype,"shape",{set:function(v){switch(v){case"default":delete this._shape;break;case"box":this._shape=LiteGraph.BOX_SHAPE;break;case"round":this._shape=LiteGraph.ROUND_SHAPE;break;case"circle":this._shape=LiteGraph.CIRCLE_SHAPE;break;case"card":this._shape=LiteGraph.CARD_SHAPE;break;default:this._shape=v}},get:function(){return this._shape},enumerable:!0,configurable:!0}),base_class.supported_extensions))for(let i in base_class.supported_extensions){var ext=base_class.supported_extensions[i];ext&&ext.constructor===String&&(this.node_types_by_file_extension[ext.toLowerCase()]=base_class)}(this.registered_node_types[type]=base_class).constructor.name&&(this.Nodes[classname]=base_class),LiteGraph.onNodeTypeRegistered&&LiteGraph.onNodeTypeRegistered(type,base_class),pos&&LiteGraph.onNodeTypeReplaced&&LiteGraph.onNodeTypeReplaced(type,base_class,pos),base_class.prototype.onPropertyChange&&console.warn("LiteGraph node class "+type+" has onPropertyChange method, it must be called onPropertyChanged with d at the end"),this.auto_load_slot_types&&new base_class(base_class.title||"tmpnode")},unregisterNodeType:function(type){var base_class=type.constructor===String?this.registered_node_types[type]:type;if(!base_class)throw"node type not found: "+type;delete this.registered_node_types[base_class.type],base_class.constructor.name&&delete this.Nodes[base_class.constructor.name]},registerNodeAndSlotType:function(type,slot_type,out){out=out||!1;var class_type=(type.constructor===String&&"anonymous"!==this.registered_node_types[type]?this.registered_node_types[type]:type).constructor.type;let allTypes=[];allTypes="string"==typeof slot_type?slot_type.split(","):slot_type==this.EVENT||slot_type==this.ACTION?["_event_"]:["*"];for(let i=0;i<allTypes.length;++i){let slotType=allTypes[i];""===slotType&&(slotType="*");var registerTo=out?"registered_slot_out_types":"registered_slot_in_types";void 0===this[registerTo][slotType]&&(this[registerTo][slotType]={nodes:[]}),this[registerTo][slotType].nodes.includes(class_type)||this[registerTo][slotType].nodes.push(class_type),out?this.slot_types_out.includes(slotType.toLowerCase())||(this.slot_types_out.push(slotType.toLowerCase()),this.slot_types_out.sort()):this.slot_types_in.includes(slotType.toLowerCase())||(this.slot_types_in.push(slotType.toLowerCase()),this.slot_types_in.sort())}},buildNodeClassFromObject:function(name,object){var _type,ctor_code="";if(object.inputs)for(var i=0;i<object.inputs.length;++i)ctor_code+="this.addInput('"+object.inputs[i][0]+"',"+(_type=(_type=object.inputs[i][1])&&_type.constructor===String?'"'+_type+'"':_type)+");\n";if(object.outputs)for(i=0;i<object.outputs.length;++i)ctor_code+="this.addOutput('"+object.outputs[i][0]+"',"+(_type=(_type=object.outputs[i][1])&&_type.constructor===String?'"'+_type+'"':_type)+");\n";if(object.properties)for(var i in object.properties){var prop=object.properties[i];ctor_code+="this.addProperty('"+i+"',"+(prop=prop&&prop.constructor===String?'"'+prop+'"':prop)+");\n"}ctor_code+="if(this.onCreate)this.onCreate()";var classobj=Function(ctor_code);for(i in object)"inputs"!=i&&"outputs"!=i&&"properties"!=i&&(classobj.prototype[i]=object[i]);return classobj.title=object.title||name.split("/").pop(),classobj.desc=object.desc||"Generated from object",this.registerNodeType(name,classobj),classobj},wrapFunctionAsNode:function(name,func,param_types,return_type,properties){var params=Array(func.length),code="";if(null!==param_types)for(var names=LiteGraph.getParameterNames(func),i=0;i<names.length;++i){var type=0;param_types&&(null!=param_types[i]&&param_types[i].constructor===String?type="'"+param_types[i]+"'":null!=param_types[i]&&(type=param_types[i])),code+="this.addInput('"+names[i]+"',"+type+");\n"}null!==return_type&&(code+="this.addOutput('out',"+(null!=return_type?return_type.constructor===String?"'"+return_type+"'":return_type:0)+");\n"),properties&&(code+="this.properties = "+JSON.stringify(properties)+";\n");return_type=Function(code);return return_type.title=name.split("/").pop(),return_type.desc="Generated from "+func.name,return_type.prototype.onExecute=function(){for(var i=0;i<params.length;++i)params[i]=this.getInputData(i);var r=func.apply(this,params);this.setOutputData(0,r)},this.registerNodeType(name,return_type),return_type},clearRegisteredTypes:function(){this.registered_node_types={},this.node_types_by_file_extension={},this.Nodes={},this.searchbox_extras={}},addNodeMethod:function(name,func){for(var i in LGraphNode.prototype[name]=func,this.registered_node_types){i=this.registered_node_types[i];i.prototype[name]&&(i.prototype["_"+name]=i.prototype[name]),i.prototype[name]=func}},createNode:function(type,title,options){var base_class=this.registered_node_types[type];if(!base_class)return LiteGraph.debug&&console.log('GraphNode type "'+type+'" not registered.'),null;title=title||base_class.title||type;var node=null;if(LiteGraph.catch_exceptions)try{node=new base_class(title)}catch(err){return console.error(err),null}else node=new base_class(title);if(node.type=type,!node.title&&title&&(node.title=title),node.properties||(node.properties={}),node.properties_info||(node.properties_info=[]),node.flags||(node.flags={}),node.size||(node.size=node.computeSize()),node.pos||(node.pos=LiteGraph.DEFAULT_POSITION.concat()),node.mode||(node.mode=LiteGraph.ALWAYS),options)for(var i in options)node[i]=options[i];return node.onNodeCreated&&node.onNodeCreated(),node},getNodeType:function(type){return this.registered_node_types[type]},getNodeTypesInCategory:function(category,filter){var i,r=[];for(i in this.registered_node_types){var type=this.registered_node_types[i];type.filter==filter&&(""==category?null==type.category&&r.push(type):type.category==category&&r.push(type))}return this.auto_sort_node_types&&r.sort(function(a,b){return a.title.localeCompare(b.title)}),r},getNodeTypesCategories:function(filter){var categories={"":1};for(i in this.registered_node_types){var type=this.registered_node_types[i];type.category&&!type.skip_list&&type.filter==filter&&(categories[type.category]=1)}var i,result=[];for(i in categories)result.push(i);return this.auto_sort_node_types?result.sort():result},reloadNodes:function(folder_wildcard){for(var tmp=document.getElementsByTagName("script"),script_files=[],i=0;i<tmp.length;i++)script_files.push(tmp[i]);var docHeadObj=document.getElementsByTagName("head")[0];folder_wildcard=document.location.href+folder_wildcard;for(i=0;i<script_files.length;i++){var src=script_files[i].src;if(src&&src.substr(0,folder_wildcard.length)==folder_wildcard)try{LiteGraph.debug&&console.log("Reloading: "+src);var dynamicScript=document.createElement("script");dynamicScript.type="text/javascript",dynamicScript.src=src,docHeadObj.appendChild(dynamicScript),docHeadObj.removeChild(script_files[i])}catch(err){if(LiteGraph.throw_errors)throw err;LiteGraph.debug&&console.log("Error while reloading "+src)}}LiteGraph.debug&&console.log("Nodes reloaded")},cloneObject:function(obj,target){if(null==obj)return null;var i,r=JSON.parse(JSON.stringify(obj));if(!target)return r;for(i in r)target[i]=r[i];return target},uuidv4:function(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,a=>(a^16*Math.random()>>a/4).toString(16))},isValidConnection:function(type_a,type_b){if(""!=type_b&&"*"!==type_b||(type_b=0),!(type_a=""!=type_a&&"*"!==type_a?type_a:0)||!type_b||type_a==type_b||type_a==LiteGraph.EVENT&&type_b==LiteGraph.ACTION)return!0;if(type_a=String(type_a),type_b=String(type_b),type_a=type_a.toLowerCase(),type_b=type_b.toLowerCase(),-1==type_a.indexOf(",")&&-1==type_b.indexOf(","))return type_a==type_b;for(var supported_types_a=type_a.split(","),supported_types_b=type_b.split(","),i=0;i<supported_types_a.length;++i)for(var j=0;j<supported_types_b.length;++j)if(this.isValidConnection(supported_types_a[i],supported_types_b[j]))return!0;return!1},registerSearchboxExtra:function(node_type,description,data){this.searchbox_extras[description.toLowerCase()]={type:node_type,desc:description,data:data}},fetchFile:function(url,type,on_complete,on_error){if(url){if(type=type||"text",url.constructor===String)return"http"==url.substr(0,4)&&LiteGraph.proxy&&(url=LiteGraph.proxy+url.substr(url.indexOf(":")+3)),fetch(url).then(function(response){if(response.ok)return"arraybuffer"==type?response.arrayBuffer():"text"==type||"string"==type?response.text():"json"==type?response.json():"blob"==type?response.blob():void 0;throw new Error("File not found")}).then(function(data){on_complete&&on_complete(data)}).catch(function(error){console.error("error fetching file:",url),on_error&&on_error(error)});if(url.constructor===File||url.constructor===Blob){var reader=new FileReader;if(reader.onload=function(e){e=e.target.result;"json"==type&&(e=JSON.parse(e)),on_complete&&on_complete(e)},"arraybuffer"==type)return reader.readAsArrayBuffer(url);if("text"==type||"json"==type)return reader.readAsText(url);if("blob"==type)return reader.readAsBinaryString(url)}}return null}};function LGraph(o){LiteGraph.debug&&console.log("Graph created"),this.list_of_graphcanvas=null,this.clear(),o&&this.configure(o)}function LLink(id,type,origin_id,origin_slot,target_id,target_slot){this.id=id,this.type=type,this.origin_id=origin_id,this.origin_slot=origin_slot,this.target_id=target_id,this.target_slot=target_slot,this._data=null,this._pos=new Float32Array(2)}function LGraphNode(title){this._ctor(title)}function LGraphGroup(title){this._ctor(title)}function DragAndScale(element,skip_events){this.offset=new Float32Array([0,0]),this.scale=1,this.max_scale=10,this.min_scale=.1,this.onredraw=null,this.enabled=!0,this.last_mouse=[0,0],this.element=null,this.visible_area=new Float32Array(4),element&&(this.element=element,skip_events||this.bindEvents(element))}function LGraphCanvas(canvas,graph,options){this.options=options=options||{},this.background_image=LGraphCanvas.DEFAULT_BACKGROUND_IMAGE,canvas&&canvas.constructor===String&&(canvas=document.querySelector(canvas)),this.ds=new DragAndScale,this.zoom_modify_alpha=!0,this.title_text_font=LiteGraph.NODE_TEXT_SIZE+"px Arial",this.inner_text_font="normal "+LiteGraph.NODE_SUBTEXT_SIZE+"px Arial",this.node_title_color=LiteGraph.NODE_TITLE_COLOR,this.default_link_color=LiteGraph.LINK_COLOR,this.default_connection_color={input_off:"#778",input_on:"#7F7",output_off:"#778",output_on:"#7F7"},this.default_connection_color_byType={},this.default_connection_color_byTypeOff={},this.highquality_render=!0,this.use_gradients=!1,this.editor_alpha=1,this.pause_rendering=!1,this.clear_background=!0,this.clear_background_color="#222",this.read_only=!1,this.render_only_selected=!0,this.live_mode=!1,this.show_info=!0,this.allow_dragcanvas=!0,this.allow_dragnodes=!0,this.allow_interaction=!0,this.multi_select=!1,this.allow_searchbox=!0,this.allow_reconnect_links=!0,this.align_to_grid=!1,this.drag_mode=!1,this.dragging_rectangle=null,this.filter=null,this.set_canvas_dirty_on_mouse_event=!0,this.always_render_background=!1,this.render_shadows=!0,this.render_canvas_border=!0,this.render_connections_shadows=!1,this.render_connections_border=!0,this.render_curved_connections=!1,this.render_connection_arrows=!1,this.render_collapsed_slots=!0,this.render_execution_order=!1,this.render_title_colored=!0,this.render_link_tooltip=!0,this.links_render_mode=LiteGraph.SPLINE_LINK,this.mouse=[0,0],this.graph_mouse=[0,0],this.canvas_mouse=this.graph_mouse,this.onSearchBox=null,this.onSearchBoxSelection=null,this.onMouse=null,this.onDrawBackground=null,this.onDrawForeground=null,this.onDrawOverlay=null,this.onDrawLinkTooltip=null,this.onNodeMoved=null,this.onSelectionChange=null,this.onConnectingChange=null,this.onBeforeChange=null,this.onAfterChange=null,this.connections_width=3,this.round_radius=8,this.current_node=null,this.node_widget=null,this.over_link_center=null,this.last_mouse_position=[0,0],this.visible_area=this.ds.visible_area,this.visible_links=[],this.viewport=options.viewport||null,graph&&graph.attachCanvas(this),this.setCanvas(canvas,options.skip_events),this.clear(),options.skip_render||this.startRendering(),this.autoresize=options.autoresize}"undefined"!=typeof performance?LiteGraph.getTime=performance.now.bind(performance):"undefined"!=typeof Date&&Date.now?LiteGraph.getTime=Date.now.bind(Date):"undefined"!=typeof process?LiteGraph.getTime=function(){var t=process.hrtime();return.001*t[0]+1e-6*t[1]}:LiteGraph.getTime=function(){return(new Date).getTime()},LGraph.supported_types=["number","string","boolean"],LGraph.prototype.getSupportedTypes=function(){return this.supported_types||LGraph.supported_types},LGraph.STATUS_STOPPED=1,LGraph.STATUS_RUNNING=2,LGraph.prototype.clear=function(){if(this.stop(),this.status=LGraph.STATUS_STOPPED,this.last_node_id=0,this.last_link_id=0,this._version=-1,this._nodes)for(var i=0;i<this._nodes.length;++i){var node=this._nodes[i];node.onRemoved&&node.onRemoved()}this._nodes=[],this._nodes_by_id={},this._nodes_in_order=[],this._nodes_executable=null,this._groups=[],this.links={},this.iteration=0,this.config={},this.vars={},this.extra={},this.globaltime=0,this.runningtime=0,this.fixedtime=0,this.fixedtime_lapse=.01,this.elapsed_time=.01,this.last_update_time=0,this.starttime=0,this.catch_errors=!0,this.nodes_executing=[],this.nodes_actioning=[],this.nodes_executedAction=[],this.inputs={},this.outputs={},this.change(),this.sendActionToCanvas("clear")},LGraph.prototype.attachCanvas=function(graphcanvas){if(graphcanvas.constructor!=LGraphCanvas)throw"attachCanvas expects a LGraphCanvas instance";graphcanvas.graph&&graphcanvas.graph!=this&&graphcanvas.graph.detachCanvas(graphcanvas),(graphcanvas.graph=this).list_of_graphcanvas||(this.list_of_graphcanvas=[]),this.list_of_graphcanvas.push(graphcanvas)},LGraph.prototype.detachCanvas=function(graphcanvas){var pos;this.list_of_graphcanvas&&-1!=(pos=this.list_of_graphcanvas.indexOf(graphcanvas))&&(graphcanvas.graph=null,this.list_of_graphcanvas.splice(pos,1))},LGraph.prototype.start=function(interval){var that;this.status!=LGraph.STATUS_RUNNING&&(this.status=LGraph.STATUS_RUNNING,this.onPlayEvent&&this.onPlayEvent(),this.sendEventToAllNodes("onStart"),this.starttime=LiteGraph.getTime(),this.last_update_time=this.starttime,that=this,0==(interval=interval||0)&&"undefined"!=typeof window&&window.requestAnimationFrame?(this.execution_timer_id=-1,function on_frame(){-1==that.execution_timer_id&&(window.requestAnimationFrame(on_frame),that.onBeforeStep&&that.onBeforeStep(),that.runStep(1,!that.catch_errors),that.onAfterStep)&&that.onAfterStep()}()):this.execution_timer_id=setInterval(function(){that.onBeforeStep&&that.onBeforeStep(),that.runStep(1,!that.catch_errors),that.onAfterStep&&that.onAfterStep()},interval))},LGraph.prototype.stop=function(){this.status!=LGraph.STATUS_STOPPED&&(this.status=LGraph.STATUS_STOPPED,this.onStopEvent&&this.onStopEvent(),null!=this.execution_timer_id&&(-1!=this.execution_timer_id&&clearInterval(this.execution_timer_id),this.execution_timer_id=null),this.sendEventToAllNodes("onStop"))},LGraph.prototype.runStep=function(num,do_not_catch_errors,limit){num=num||1;var start=LiteGraph.getTime(),nodes=(this.globaltime=.001*(start-this.starttime),this._nodes_executable||this._nodes);if(nodes){if(limit=limit||nodes.length,do_not_catch_errors){for(var i=0;i<num;i++){for(var j=0;j<limit;++j){var node=nodes[j];LiteGraph.use_deferred_actions&&node._waiting_actions&&node._waiting_actions.length&&node.executePendingActions(),node.mode==LiteGraph.ALWAYS&&node.onExecute&&node.doExecute()}this.fixedtime+=this.fixedtime_lapse,this.onExecuteStep&&this.onExecuteStep()}this.onAfterExecute&&this.onAfterExecute()}else try{for(i=0;i<num;i++){for(j=0;j<limit;++j){node=nodes[j];LiteGraph.use_deferred_actions&&node._waiting_actions&&node._waiting_actions.length&&node.executePendingActions(),node.mode==LiteGraph.ALWAYS&&node.onExecute&&node.onExecute()}this.fixedtime+=this.fixedtime_lapse,this.onExecuteStep&&this.onExecuteStep()}this.onAfterExecute&&this.onAfterExecute(),this.errors_in_execution=!1}catch(err){if(this.errors_in_execution=!0,LiteGraph.throw_errors)throw err;LiteGraph.debug&&console.log("Error during execution: "+err),this.stop()}do_not_catch_errors=LiteGraph.getTime(),start=do_not_catch_errors-start;this.execution_time=.001*(start=0==start?1:start),this.globaltime+=.001*start,this.iteration+=1,this.elapsed_time=.001*(do_not_catch_errors-this.last_update_time),this.last_update_time=do_not_catch_errors,this.nodes_executing=[],this.nodes_actioning=[],this.nodes_executedAction=[]}},LGraph.prototype.updateExecutionOrder=function(){this._nodes_in_order=this.computeExecutionOrder(!1),this._nodes_executable=[];for(var i=0;i<this._nodes_in_order.length;++i)this._nodes_in_order[i].onExecute&&this._nodes_executable.push(this._nodes_in_order[i])},LGraph.prototype.computeExecutionOrder=function(only_onExecute,set_level){for(var L=[],S=[],M={},visited_links={},remaining_links={},i=0,l=this._nodes.length;i<l;++i){var node=this._nodes[i];if(!only_onExecute||node.onExecute){var num=0;if((M[node.id]=node).inputs)for(var j=0,l2=node.inputs.length;j<l2;j++)node.inputs[j]&&null!=node.inputs[j].link&&(num+=1);0==num?(S.push(node),set_level&&(node._level=1)):(set_level&&(node._level=0),remaining_links[node.id]=num)}}for(;0!=S.length;){node=S.shift();if(L.push(node),delete M[node.id],node.outputs)for(var i=0;i<node.outputs.length;i++){var output=node.outputs[i];if(null!=output&&null!=output.links&&0!=output.links.length)for(j=0;j<output.links.length;j++){var target_node,link_id=output.links[j],link_id=this.links[link_id];!link_id||visited_links[link_id.id]||(null==(target_node=this.getNodeById(link_id.target_id))?visited_links[link_id.id]=!0:(set_level&&(!target_node._level||target_node._level<=node._level)&&(target_node._level=node._level+1),visited_links[link_id.id]=!0,--remaining_links[target_node.id],0==remaining_links[target_node.id]&&S.push(target_node)))}}}for(i in M)L.push(M[i]);L.length!=this._nodes.length&&LiteGraph.debug&&console.warn("something went wrong, nodes missing");for(l=L.length,i=0;i<l;++i)L[i].order=i;for(L=L.sort(function(A,B){var Ap=A.constructor.priority||A.priority||0,Bp=B.constructor.priority||B.priority||0;return Ap==Bp?A.order-B.order:Ap-Bp}),i=0;i<l;++i)L[i].order=i;return L},LGraph.prototype.getAncestors=function(node){for(var ancestors=[],pending=[node],visited={};pending.length;){var current=pending.shift();if(current.inputs){visited[current.id]||current==node||(visited[current.id]=!0,ancestors.push(current));for(var i=0;i<current.inputs.length;++i){var input=current.getInputNode(i);input&&-1==ancestors.indexOf(input)&&pending.push(input)}}}return ancestors.sort(function(a,b){return a.order-b.order}),ancestors},LGraph.prototype.arrange=function(margin,layout){margin=margin||100;var nodes=this.computeExecutionOrder(!1,!0),columns=[];for(let i=0;i<nodes.length;++i){var node=nodes[i],col=node._level||1;columns[col]||(columns[col]=[]),columns[col].push(node)}let x=margin;for(let i=0;i<columns.length;++i){var column=columns[i];if(column){let max_size=100,y=margin+LiteGraph.NODE_TITLE_HEIGHT;for(let j=0;j<column.length;++j){const node=column[j];node.pos[0]=layout==LiteGraph.VERTICAL_LAYOUT?y:x,node.pos[1]=layout==LiteGraph.VERTICAL_LAYOUT?x:y;var max_size_index=layout==LiteGraph.VERTICAL_LAYOUT?1:0,max_size_index=(node.size[max_size_index]>max_size&&(max_size=node.size[max_size_index]),layout==LiteGraph.VERTICAL_LAYOUT?0:1);y+=node.size[max_size_index]+margin+LiteGraph.NODE_TITLE_HEIGHT}x+=max_size+margin}}this.setDirtyCanvas(!0,!0)},LGraph.prototype.getTime=function(){return this.globaltime},LGraph.prototype.getFixedTime=function(){return this.fixedtime},LGraph.prototype.getElapsedTime=function(){return this.elapsed_time},LGraph.prototype.sendEventToAllNodes=function(eventname,params,mode){mode=mode||LiteGraph.ALWAYS;var nodes=this._nodes_in_order||this._nodes;if(nodes)for(var j=0,l=nodes.length;j<l;++j){var node=nodes[j];node.constructor===LiteGraph.Subgraph&&"onExecute"!=eventname?node.mode==mode&&node.sendEventToAllNodes(eventname,params,mode):node[eventname]&&node.mode==mode&&(void 0===params?node[eventname]():params&&params.constructor===Array?node[eventname].apply(node,params):node[eventname](params))}},LGraph.prototype.sendActionToCanvas=function(action,params){if(this.list_of_graphcanvas)for(var i=0;i<this.list_of_graphcanvas.length;++i){var c=this.list_of_graphcanvas[i];c[action]&&c[action].apply(c,params)}},LGraph.prototype.add=function(node,skip_compute_order){if(node){if(node.constructor!==LGraphGroup){if(-1!=node.id&&null!=this._nodes_by_id[node.id]&&(console.warn("LiteGraph: there is already a node with this ID, changing it"),LiteGraph.use_uuids?node.id=LiteGraph.uuidv4():node.id=++this.last_node_id),this._nodes.length>=LiteGraph.MAX_NUMBER_OF_NODES)throw"LiteGraph: max number of nodes in a graph reached";return LiteGraph.use_uuids?null!=node.id&&-1!=node.id||(node.id=LiteGraph.uuidv4()):null==node.id||-1==node.id?node.id=++this.last_node_id:this.last_node_id<node.id&&(this.last_node_id=node.id),(node.graph=this)._version++,this._nodes.push(node),(this._nodes_by_id[node.id]=node).onAdded&&node.onAdded(this),this.config.align_to_grid&&node.alignToGrid(),skip_compute_order||this.updateExecutionOrder(),this.onNodeAdded&&this.onNodeAdded(node),this.setDirtyCanvas(!0),this.change(),node}this._groups.push(node),this.setDirtyCanvas(!0),this.change(),(node.graph=this)._version++}},LGraph.prototype.remove=function(node){if(node.constructor===LGraphGroup)-1!=(index=this._groups.indexOf(node))&&this._groups.splice(index,1),node.graph=null,this._version++,this.setDirtyCanvas(!0,!0),this.change();else if(null!=this._nodes_by_id[node.id]&&!node.ignore_remove){if(this.beforeChange(),node.inputs)for(var i=0;i<node.inputs.length;i++)null!=(slot=node.inputs[i]).link&&node.disconnectInput(i);if(node.outputs)for(var slot,i=0;i<node.outputs.length;i++)null!=(slot=node.outputs[i]).links&&slot.links.length&&node.disconnectOutput(i);if(node.onRemoved&&node.onRemoved(),node.graph=null,this._version++,this.list_of_graphcanvas)for(i=0;i<this.list_of_graphcanvas.length;++i){var canvas=this.list_of_graphcanvas[i];canvas.selected_nodes[node.id]&&delete canvas.selected_nodes[node.id],canvas.node_dragged==node&&(canvas.node_dragged=null)}var index=this._nodes.indexOf(node);-1!=index&&this._nodes.splice(index,1),delete this._nodes_by_id[node.id],this.onNodeRemoved&&this.onNodeRemoved(node),this.sendActionToCanvas("checkPanels"),this.setDirtyCanvas(!0,!0),this.afterChange(),this.change(),this.updateExecutionOrder()}},LGraph.prototype.getNodeById=function(id){return null==id?null:this._nodes_by_id[id]},LGraph.prototype.findNodesByClass=function(classObject,result){for(var i=(result=result||[]).length=0,l=this._nodes.length;i<l;++i)this._nodes[i].constructor===classObject&&result.push(this._nodes[i]);return result},LGraph.prototype.findNodesByType=function(type,result){for(var type=type.toLowerCase(),i=(result=result||[]).length=0,l=this._nodes.length;i<l;++i)this._nodes[i].type.toLowerCase()==type&&result.push(this._nodes[i]);return result},LGraph.prototype.findNodeByTitle=function(title){for(var i=0,l=this._nodes.length;i<l;++i)if(this._nodes[i].title==title)return this._nodes[i];return null},LGraph.prototype.findNodesByTitle=function(title){for(var result=[],i=0,l=this._nodes.length;i<l;++i)this._nodes[i].title==title&&result.push(this._nodes[i]);return result},LGraph.prototype.getNodeOnPos=function(x,y,nodes_list,margin){for(var i=(nodes_list=nodes_list||this._nodes).length-1;0<=i;i--){var n=nodes_list[i];if(n.isPointInside(x,y,margin))return n}return null},LGraph.prototype.getGroupOnPos=function(x,y){for(var i=this._groups.length-1;0<=i;i--){var g=this._groups[i];if(g.isPointInside(x,y,2,!0))return g}return null},LGraph.prototype.checkNodeTypes=function(){for(var i=0;i<this._nodes.length;i++){var node=this._nodes[i],ctor=LiteGraph.registered_node_types[node.type];node.constructor!=ctor&&(console.log("node being replaced by newer version: "+node.type),ctor=LiteGraph.createNode(node.type),(this._nodes[i]=ctor).configure(node.serialize()),(ctor.graph=this)._nodes_by_id[ctor.id]=ctor,node.inputs&&(ctor.inputs=node.inputs.concat()),node.outputs)&&(ctor.outputs=node.outputs.concat())}this.updateExecutionOrder()},LGraph.prototype.onAction=function(action,param,options){this._input_nodes=this.findNodesByClass(LiteGraph.GraphInput,this._input_nodes);for(var i=0;i<this._input_nodes.length;++i){var node=this._input_nodes[i];if(node.properties.name==action){node.actionDo(action,param,options);break}}},LGraph.prototype.trigger=function(action,param){this.onTrigger&&this.onTrigger(action,param)},LGraph.prototype.addInput=function(name,type,value){this.inputs[name]||(this.beforeChange(),this.inputs[name]={name:name,type:type,value:value},this._version++,this.afterChange(),this.onInputAdded&&this.onInputAdded(name,type),this.onInputsOutputsChange&&this.onInputsOutputsChange())},LGraph.prototype.setInputData=function(name,data){name=this.inputs[name];name&&(name.value=data)},LGraph.prototype.getInputData=function(name){name=this.inputs[name];return name?name.value:null},LGraph.prototype.renameInput=function(old_name,name){if(name!=old_name)return!!this.inputs[old_name]&&(this.inputs[name]?(console.error("there is already one input with that name"),!1):(this.inputs[name]=this.inputs[old_name],delete this.inputs[old_name],this._version++,this.onInputRenamed&&this.onInputRenamed(old_name,name),void(this.onInputsOutputsChange&&this.onInputsOutputsChange())))},LGraph.prototype.changeInputType=function(name,type){if(!this.inputs[name])return!1;this.inputs[name].type&&String(this.inputs[name].type).toLowerCase()==String(type).toLowerCase()||(this.inputs[name].type=type,this._version++,this.onInputTypeChanged&&this.onInputTypeChanged(name,type))},LGraph.prototype.removeInput=function(name){return!!this.inputs[name]&&(delete this.inputs[name],this._version++,this.onInputRemoved&&this.onInputRemoved(name),this.onInputsOutputsChange&&this.onInputsOutputsChange(),!0)},LGraph.prototype.addOutput=function(name,type,value){this.outputs[name]={name:name,type:type,value:value},this._version++,this.onOutputAdded&&this.onOutputAdded(name,type),this.onInputsOutputsChange&&this.onInputsOutputsChange()},LGraph.prototype.setOutputData=function(name,value){name=this.outputs[name];name&&(name.value=value)},LGraph.prototype.getOutputData=function(name){name=this.outputs[name];return name?name.value:null},LGraph.prototype.renameOutput=function(old_name,name){return!!this.outputs[old_name]&&(this.outputs[name]?(console.error("there is already one output with that name"),!1):(this.outputs[name]=this.outputs[old_name],delete this.outputs[old_name],this._version++,this.onOutputRenamed&&this.onOutputRenamed(old_name,name),void(this.onInputsOutputsChange&&this.onInputsOutputsChange())))},LGraph.prototype.changeOutputType=function(name,type){if(!this.outputs[name])return!1;this.outputs[name].type&&String(this.outputs[name].type).toLowerCase()==String(type).toLowerCase()||(this.outputs[name].type=type,this._version++,this.onOutputTypeChanged&&this.onOutputTypeChanged(name,type))},LGraph.prototype.removeOutput=function(name){return!!this.outputs[name]&&(delete this.outputs[name],this._version++,this.onOutputRemoved&&this.onOutputRemoved(name),this.onInputsOutputsChange&&this.onInputsOutputsChange(),!0)},LGraph.prototype.triggerInput=function(name,value){for(var nodes=this.findNodesByTitle(name),i=0;i<nodes.length;++i)nodes[i].onTrigger(value)},LGraph.prototype.setCallback=function(name,func){for(var nodes=this.findNodesByTitle(name),i=0;i<nodes.length;++i)nodes[i].setTrigger(func)},LGraph.prototype.beforeChange=function(info){this.onBeforeChange&&this.onBeforeChange(this,info),this.sendActionToCanvas("onBeforeChange",this)},LGraph.prototype.afterChange=function(info){this.onAfterChange&&this.onAfterChange(this,info),this.sendActionToCanvas("onAfterChange",this)},LGraph.prototype.connectionChange=function(node,link_info){this.updateExecutionOrder(),this.onConnectionChange&&this.onConnectionChange(node),this._version++,this.sendActionToCanvas("onConnectionChange")},LGraph.prototype.isLive=function(){if(this.list_of_graphcanvas)for(var i=0;i<this.list_of_graphcanvas.length;++i)if(this.list_of_graphcanvas[i].live_mode)return!0;return!1},LGraph.prototype.clearTriggeredSlots=function(){for(var i in this.links){i=this.links[i];i&&i._last_time&&(i._last_time=0)}},LGraph.prototype.change=function(){LiteGraph.debug&&console.log("Graph changed"),this.sendActionToCanvas("setDirty",[!0,!0]),this.on_change&&this.on_change(this)},LGraph.prototype.setDirtyCanvas=function(fg,bg){this.sendActionToCanvas("setDirty",[fg,bg])},LGraph.prototype.removeLink=function(link_id){var node,link_id=this.links[link_id];link_id&&(node=this.getNodeById(link_id.target_id))&&node.disconnectInput(link_id.target_slot)},LGraph.prototype.serialize=function(){for(var nodes_info=[],i=0,l=this._nodes.length;i<l;++i)nodes_info.push(this._nodes[i].serialize());var links=[];for(i in this.links){var link=this.links[i];if(!link.serialize){console.warn("weird LLink bug, link info is not a LLink but a regular object");var j,link2=new LLink;for(j in link)link2[j]=link[j];link=this.links[i]=link2}links.push(link.serialize())}for(var groups_info=[],i=0;i<this._groups.length;++i)groups_info.push(this._groups[i].serialize());var data={last_node_id:this.last_node_id,last_link_id:this.last_link_id,nodes:nodes_info,links:links,groups:groups_info,config:this.config,extra:this.extra,version:LiteGraph.VERSION};return this.onSerialize&&this.onSerialize(data),data},LGraph.prototype.configure=function(data,keep_old){if(data){keep_old||this.clear();var nodes=data.nodes;if(data.links&&data.links.constructor===Array){for(var links=[],i=0;i<data.links.length;++i){var link,link_data=data.links[i];link_data?((link=new LLink).configure(link_data),links[link.id]=link):console.warn("serialized graph link data contains errors, skipping.")}data.links=links}for(i in data)"nodes"!=i&&"groups"!=i&&(this[i]=data[i]);var error=!1;if(this._nodes=[],nodes){for(var i=0,l=nodes.length;i<l;++i){var n_info=nodes[i];(node=LiteGraph.createNode(n_info.type,n_info.title))||(LiteGraph.debug&&console.log("Node not found or has errors: "+n_info.type),(node=new LGraphNode).last_serialization=n_info,error=node.has_errors=!0),node.id=n_info.id,this.add(node,!0)}for(i=0,l=nodes.length;i<l;++i){var node,n_info=nodes[i];(node=this.getNodeById(n_info.id))&&node.configure(n_info)}}if(this._groups.length=0,data.groups)for(i=0;i<data.groups.length;++i){var group=new LGraphGroup;group.configure(data.groups[i]),this.add(group)}return this.updateExecutionOrder(),this.extra=data.extra||{},this.onConfigure&&this.onConfigure(data),this._version++,this.setDirtyCanvas(!0,!0),error}},LGraph.prototype.load=function(url,callback){var reader,req,that=this;url.constructor===File||url.constructor===Blob?((reader=new FileReader).addEventListener("load",function(event){event=JSON.parse(event.target.result);that.configure(event),callback&&callback()}),reader.readAsText(url)):((req=new XMLHttpRequest).open("GET",url,!0),req.send(null),req.onload=function(oEvent){var data;200!==req.status?console.error("Error loading graph:",req.status,req.response):(data=JSON.parse(req.response),that.configure(data),callback&&callback())},req.onerror=function(err){console.error("Error loading graph:",err)})},LGraph.prototype.onNodeTrace=function(node,msg,color){},LLink.prototype.configure=function(o){o.constructor===Array?(this.id=o[0],this.origin_id=o[1],this.origin_slot=o[2],this.target_id=o[3],this.target_slot=o[4],this.type=o[5]):(this.id=o.id,this.type=o.type,this.origin_id=o.origin_id,this.origin_slot=o.origin_slot,this.target_id=o.target_id,this.target_slot=o.target_slot)},LLink.prototype.serialize=function(){return[this.id,this.origin_id,this.origin_slot,this.target_id,this.target_slot,this.type]},LGraphNode.prototype._ctor=function(title){this.title=title||"Unnamed",this.size=[LiteGraph.NODE_WIDTH,60],this.graph=null,this._pos=new Float32Array(10,10),Object.defineProperty(this,"pos",{set:function(v){!v||v.length<2||(this._pos[0]=v[0],this._pos[1]=v[1])},get:function(){return this._pos},enumerable:!0}),LiteGraph.use_uuids?this.id=LiteGraph.uuidv4():this.id=-1,this.type=null,this.inputs=[],this.outputs=[],this.connections=[],this.properties={},this.properties_info=[],this.flags={}},LGraphNode.prototype.configure=function(info){for(var j in this.graph&&this.graph._version++,info)if("properties"==j)for(var k in info.properties)this.properties[k]=info.properties[k],this.onPropertyChanged&&this.onPropertyChanged(k,info.properties[k]);else null!=info[j]&&("object"==typeof info[j]?this[j]&&this[j].configure?this[j].configure(info[j]):this[j]=LiteGraph.cloneObject(info[j],this[j]):this[j]=info[j]);if(info.title||(this.title=this.constructor.title),this.inputs)for(var i=0;i<this.inputs.length;++i){var input=this.inputs[i],link_info=this.graph?this.graph.links[input.link]:null;this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.INPUT,i,!0,link_info,input),this.onInputAdded&&this.onInputAdded(input)}if(this.outputs)for(i=0;i<this.outputs.length;++i){var output=this.outputs[i];if(output.links){for(j=0;j<output.links.length;++j){link_info=this.graph?this.graph.links[output.links[j]]:null;this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.OUTPUT,i,!0,link_info,output)}this.onOutputAdded&&this.onOutputAdded(output)}}if(this.widgets){for(i=0;i<this.widgets.length;++i){var w=this.widgets[i];w&&w.options&&w.options.property&&null!=this.properties[w.options.property]&&(w.value=JSON.parse(JSON.stringify(this.properties[w.options.property])))}if(info.widgets_values)for(i=0;i<info.widgets_values.length;++i)this.widgets[i]&&(this.widgets[i].value=info.widgets_values[i])}this.onConfigure&&this.onConfigure(info)},LGraphNode.prototype.serialize=function(){var o={id:this.id,type:this.type,pos:this.pos,size:this.size,flags:LiteGraph.cloneObject(this.flags),order:this.order,mode:this.mode};if(this.constructor===LGraphNode&&this.last_serialization)return this.last_serialization;if(this.inputs&&(o.inputs=this.inputs),this.outputs){for(var i=0;i<this.outputs.length;i++)delete this.outputs[i]._data;o.outputs=this.outputs}if(this.title&&this.title!=this.constructor.title&&(o.title=this.title),this.properties&&(o.properties=LiteGraph.cloneObject(this.properties)),this.widgets&&this.serialize_widgets){o.widgets_values=[];for(i=0;i<this.widgets.length;++i)this.widgets[i]?o.widgets_values[i]=this.widgets[i].value:o.widgets_values[i]=null}return o.type||(o.type=this.constructor.type),this.color&&(o.color=this.color),this.bgcolor&&(o.bgcolor=this.bgcolor),this.boxcolor&&(o.boxcolor=this.boxcolor),this.shape&&(o.shape=this.shape),this.onSerialize&&this.onSerialize(o)&&console.warn("node onSerialize shouldnt return anything, data should be stored in the object pass in the first parameter"),o},LGraphNode.prototype.clone=function(){var node=LiteGraph.createNode(this.type);if(!node)return null;var data=LiteGraph.cloneObject(this.serialize());if(data.inputs)for(var i=0;i<data.inputs.length;++i)data.inputs[i].link=null;if(data.outputs)for(i=0;i<data.outputs.length;++i)data.outputs[i].links&&(data.outputs[i].links.length=0);return delete data.id,LiteGraph.use_uuids&&(data.id=LiteGraph.uuidv4()),node.configure(data),node},LGraphNode.prototype.toString=function(){return JSON.stringify(this.serialize())},LGraphNode.prototype.getTitle=function(){return this.title||this.constructor.title},LGraphNode.prototype.setProperty=function(name,value){if(this.properties||(this.properties={}),value!==this.properties[name]){var prev_value=this.properties[name];if(this.properties[name]=value,this.onPropertyChanged&&!1===this.onPropertyChanged(name,value,prev_value)&&(this.properties[name]=prev_value),this.widgets)for(var i=0;i<this.widgets.length;++i){var w=this.widgets[i];if(w&&w.options.property==name){w.value=value;break}}}},LGraphNode.prototype.setOutputData=function(slot,data){if(this.outputs&&!(-1==slot||slot>=this.outputs.length)){var output_info=this.outputs[slot];if(output_info&&(output_info._data=data,this.outputs[slot].links))for(var i=0;i<this.outputs[slot].links.length;i++){var link_id=this.outputs[slot].links[i],link_id=this.graph.links[link_id];link_id&&(link_id.data=data)}}},LGraphNode.prototype.setOutputDataType=function(slot,type){if(this.outputs&&!(-1==slot||slot>=this.outputs.length)){var output_info=this.outputs[slot];if(output_info&&(output_info.type=type,this.outputs[slot].links))for(var i=0;i<this.outputs[slot].links.length;i++){var link_id=this.outputs[slot].links[i];this.graph.links[link_id].type=type}}},LGraphNode.prototype.getInputData=function(slot,force_update){if(this.inputs&&!(slot>=this.inputs.length||null==this.inputs[slot].link))return slot=this.inputs[slot].link,(slot=this.graph.links[slot])?(force_update&&(force_update=this.graph.getNodeById(slot.origin_id))&&(force_update.updateOutputData?force_update.updateOutputData(slot.origin_slot):force_update.onExecute&&force_update.onExecute()),slot.data):null},LGraphNode.prototype.getInputDataType=function(slot){var node;return this.inputs&&!(slot>=this.inputs.length||null==this.inputs[slot].link)&&(slot=this.inputs[slot].link,slot=this.graph.links[slot])?(node=this.graph.getNodeById(slot.origin_id))?(node=node.outputs[slot.origin_slot])?node.type:null:slot.type:null},LGraphNode.prototype.getInputDataByName=function(slot_name,force_update){slot_name=this.findInputSlot(slot_name);return-1==slot_name?null:this.getInputData(slot_name,force_update)},LGraphNode.prototype.isInputConnected=function(slot){return!!this.inputs&&slot<this.inputs.length&&null!=this.inputs[slot].link},LGraphNode.prototype.getInputInfo=function(slot){return this.inputs&&slot<this.inputs.length?this.inputs[slot]:null},LGraphNode.prototype.getInputLink=function(slot){return this.inputs&&slot<this.inputs.length?(slot=this.inputs[slot],this.graph.links[slot.link]):null},LGraphNode.prototype.getInputNode=function(slot){return this.inputs&&!(slot>=this.inputs.length)&&(slot=this.inputs[slot])&&null!==slot.link&&(slot=this.graph.links[slot.link])?this.graph.getNodeById(slot.origin_id):null},LGraphNode.prototype.getInputOrProperty=function(name){if(!this.inputs||!this.inputs.length)return this.properties?this.properties[name]:null;for(var i=0,l=this.inputs.length;i<l;++i){var input_info=this.inputs[i];if(name==input_info.name&&null!=input_info.link){input_info=this.graph.links[input_info.link];if(input_info)return input_info.data}}return this.properties[name]},LGraphNode.prototype.getOutputData=function(slot){return!this.outputs||slot>=this.outputs.length?null:this.outputs[slot]._data},LGraphNode.prototype.getOutputInfo=function(slot){return this.outputs&&slot<this.outputs.length?this.outputs[slot]:null},LGraphNode.prototype.isOutputConnected=function(slot){return!!this.outputs&&slot<this.outputs.length&&this.outputs[slot].links&&this.outputs[slot].links.length},LGraphNode.prototype.isAnyOutputConnected=function(){if(this.outputs)for(var i=0;i<this.outputs.length;++i)if(this.outputs[i].links&&this.outputs[i].links.length)return!0;return!1},LGraphNode.prototype.getOutputNodes=function(slot){if(!this.outputs||0==this.outputs.length)return null;if(slot>=this.outputs.length)return null;var output=this.outputs[slot];if(!output.links||0==output.links.length)return null;for(var r=[],i=0;i<output.links.length;i++){var link_id=output.links[i],link_id=this.graph.links[link_id];link_id&&(link_id=this.graph.getNodeById(link_id.target_id))&&r.push(link_id)}return r},LGraphNode.prototype.addOnTriggerInput=function(){var trigS=this.findInputSlot("onTrigger");return-1==trigS?(this.addInput("onTrigger",LiteGraph.EVENT,{optional:!0,nameLocked:!0}),this.findInputSlot("onTrigger")):trigS},LGraphNode.prototype.addOnExecutedOutput=function(){var trigS=this.findOutputSlot("onExecuted");return-1==trigS?(this.addOutput("onExecuted",LiteGraph.ACTION,{optional:!0,nameLocked:!0}),this.findOutputSlot("onExecuted")):trigS},LGraphNode.prototype.onAfterExecuteNode=function(param,options){var trigS=this.findOutputSlot("onExecuted");-1!=trigS&&this.triggerSlot(trigS,param,null,options)},LGraphNode.prototype.changeMode=function(modeTo){switch(modeTo){case LiteGraph.ON_EVENT:break;case LiteGraph.ON_TRIGGER:this.addOnTriggerInput(),this.addOnExecutedOutput();break;case LiteGraph.NEVER:case LiteGraph.ALWAYS:case LiteGraph.ON_REQUEST:break;default:return!1}return this.mode=modeTo,!0},LGraphNode.prototype.executePendingActions=function(){if(this._waiting_actions&&this._waiting_actions.length){for(var i=0;i<this._waiting_actions.length;++i){var p=this._waiting_actions[i];this.onAction(p[0],p[1],p[2],p[3],p[4])}this._waiting_actions.length=0}},LGraphNode.prototype.doExecute=function(param,options){options=options||{},this.onExecute&&(options.action_call||(options.action_call=this.id+"_exec_"+Math.floor(9999*Math.random())),this.graph.nodes_executing[this.id]=!0,this.onExecute(param,options),this.graph.nodes_executing[this.id]=!1,this.exec_version=this.graph.iteration,options)&&options.action_call&&(this.action_call=options.action_call,this.graph.nodes_executedAction[this.id]=options.action_call),this.execute_triggered=2,this.onAfterExecuteNode&&this.onAfterExecuteNode(param,options)},LGraphNode.prototype.actionDo=function(action,param,options,action_slot){options=options||{},this.onAction&&(options.action_call||(options.action_call=this.id+"_"+(action||"action")+"_"+Math.floor(9999*Math.random())),this.graph.nodes_actioning[this.id]=action||"actioning",this.onAction(action,param,options,action_slot),this.graph.nodes_actioning[this.id]=!1,options)&&options.action_call&&(this.action_call=options.action_call,this.graph.nodes_executedAction[this.id]=options.action_call),this.action_triggered=2,this.onAfterExecuteNode&&this.onAfterExecuteNode(param,options)},LGraphNode.prototype.trigger=function(action,param,options){if(this.outputs&&this.outputs.length){this.graph&&(this.graph._last_trigger_time=LiteGraph.getTime());for(var i=0;i<this.outputs.length;++i){var output=this.outputs[i];!output||output.type!==LiteGraph.EVENT||action&&output.name!=action||this.triggerSlot(i,param,null,options)}}},LGraphNode.prototype.triggerSlot=function(slot,param,link_id,options){if(options=options||{},this.outputs)if(null==slot)console.error("slot must be a number");else{slot.constructor!==Number&&console.warn("slot must be a number, use node.trigger('name') if you want to use a string");slot=this.outputs[slot];if(slot){var links=slot.links;if(links&&links.length){this.graph&&(this.graph._last_trigger_time=LiteGraph.getTime());for(var k=0;k<links.length;++k){var node,target_connection,id=links[k];null!=link_id&&link_id!=id||(id=this.graph.links[links[k]])&&(id._last_time=LiteGraph.getTime(),node=this.graph.getNodeById(id.target_id))&&(target_connection=node.inputs[id.target_slot],node.mode===LiteGraph.ON_TRIGGER?(options.action_call||(options.action_call=this.id+"_trigg_"+Math.floor(9999*Math.random())),node.onExecute&&node.doExecute(param,options)):node.onAction&&(options.action_call||(options.action_call=this.id+"_act_"+Math.floor(9999*Math.random())),target_connection=node.inputs[id.target_slot],LiteGraph.use_deferred_actions&&node.onExecute?(node._waiting_actions||(node._waiting_actions=[]),node._waiting_actions.push([target_connection.name,param,options,id.target_slot])):node.actionDo(target_connection.name,param,options,id.target_slot)))}}}}},LGraphNode.prototype.clearTriggeredSlot=function(slot,link_id){if(this.outputs){slot=this.outputs[slot];if(slot){var links=slot.links;if(links&&links.length)for(var k=0;k<links.length;++k){var id=links[k];null!=link_id&&link_id!=id||(id=this.graph.links[links[k]])&&(id._last_time=0)}}}},LGraphNode.prototype.setSize=function(size){this.size=size,this.onResize&&this.onResize(this.size)},LGraphNode.prototype.addProperty=function(name,default_value,type,extra_info){var o={name:name,type:type,default_value:default_value};if(extra_info)for(var i in extra_info)o[i]=extra_info[i];return this.properties_info||(this.properties_info=[]),this.properties_info.push(o),this.properties||(this.properties={}),this.properties[name]=default_value,o},LGraphNode.prototype.addOutput=function(name,type,extra_info){var output={name:name,type:type,links:null};if(extra_info)for(var i in extra_info)output[i]=extra_info[i];return this.outputs||(this.outputs=[]),this.outputs.push(output),this.onOutputAdded&&this.onOutputAdded(output),LiteGraph.auto_load_slot_types&&LiteGraph.registerNodeAndSlotType(this,type,!0),this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0),output},LGraphNode.prototype.addOutputs=function(array){for(var i=0;i<array.length;++i){var info=array[i],o={name:info[0],type:info[1],link:null};if(array[2])for(var j in info[2])o[j]=info[2][j];this.outputs||(this.outputs=[]),this.outputs.push(o),this.onOutputAdded&&this.onOutputAdded(o),LiteGraph.auto_load_slot_types&&LiteGraph.registerNodeAndSlotType(this,info[1],!0)}this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0)},LGraphNode.prototype.removeOutput=function(slot){this.disconnectOutput(slot),this.outputs.splice(slot,1);for(var i=slot;i<this.outputs.length;++i)if(this.outputs[i]&&this.outputs[i].links)for(var links=this.outputs[i].links,j=0;j<links.length;++j){var link=this.graph.links[links[j]];link&&--link.origin_slot}this.setSize(this.computeSize()),this.onOutputRemoved&&this.onOutputRemoved(slot),this.setDirtyCanvas(!0,!0)},LGraphNode.prototype.addInput=function(name,type,extra_info){var input={name:name,type:type=type||0,link:null};if(extra_info)for(var i in extra_info)input[i]=extra_info[i];return this.inputs||(this.inputs=[]),this.inputs.push(input),this.setSize(this.computeSize()),this.onInputAdded&&this.onInputAdded(input),LiteGraph.registerNodeAndSlotType(this,type),this.setDirtyCanvas(!0,!0),input},LGraphNode.prototype.addInputs=function(array){for(var i=0;i<array.length;++i){var info=array[i],o={name:info[0],type:info[1],link:null};if(array[2])for(var j in info[2])o[j]=info[2][j];this.inputs||(this.inputs=[]),this.inputs.push(o),this.onInputAdded&&this.onInputAdded(o),LiteGraph.registerNodeAndSlotType(this,info[1])}this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0)},LGraphNode.prototype.removeInput=function(slot){this.disconnectInput(slot);for(var link,slot_info=this.inputs.splice(slot,1),i=slot;i<this.inputs.length;++i)this.inputs[i]&&(link=this.graph.links[this.inputs[i].link])&&--link.target_slot;this.setSize(this.computeSize()),this.onInputRemoved&&this.onInputRemoved(slot,slot_info[0]),this.setDirtyCanvas(!0,!0)},LGraphNode.prototype.addConnection=function(name,type,pos,direction){name={name:name,type:type,pos:pos,direction:direction,links:null};return this.connections.push(name),name},LGraphNode.prototype.computeSize=function(out){if(this.constructor.size)return this.constructor.size.concat();var rows=Math.max(this.inputs?this.inputs.length:1,this.outputs?this.outputs.length:1),size=out||new Float32Array([0,0]),rows=Math.max(rows,1),font_size=LiteGraph.NODE_TEXT_SIZE,out=compute_text_size(this.title),input_width=0,output_width=0;if(this.inputs)for(var i=0,l=this.inputs.length;i<l;++i){var input=this.inputs[i];input_width<(text_width=compute_text_size(input.label||input.name||""))&&(input_width=text_width)}if(this.outputs)for(i=0,l=this.outputs.length;i<l;++i){var text_width,output=this.outputs[i];output_width<(text_width=compute_text_size(output.label||output.name||""))&&(output_width=text_width)}size[0]=Math.max(input_width+output_width+10,out),size[0]=Math.max(size[0],LiteGraph.NODE_WIDTH),this.widgets&&this.widgets.length&&(size[0]=Math.max(size[0],1.5*LiteGraph.NODE_WIDTH)),size[1]=(this.constructor.slot_start_y||0)+rows*LiteGraph.NODE_SLOT_HEIGHT;var widgets_height=0;if(this.widgets&&this.widgets.length){for(i=0,l=this.widgets.length;i<l;++i)this.widgets[i].computeSize?widgets_height+=this.widgets[i].computeSize(size[0])[1]+4:widgets_height+=LiteGraph.NODE_WIDGET_HEIGHT+4;widgets_height+=8}function compute_text_size(text){return text?font_size*text.length*.6:0}return this.widgets_up?size[1]=Math.max(size[1],widgets_height):null!=this.widgets_start_y?size[1]=Math.max(size[1],widgets_height+this.widgets_start_y):size[1]+=widgets_height,this.constructor.min_height&&size[1]<this.constructor.min_height&&(size[1]=this.constructor.min_height),size[1]+=6,size},LGraphNode.prototype.getPropertyInfo=function(property){var info=null;if(this.properties_info)for(var i=0;i<this.properties_info.length;++i)if(this.properties_info[i].name==property){info=this.properties_info[i];break}return this.constructor["@"+property]&&(info=this.constructor["@"+property]),(info=(info=!(info=this.constructor.widgets_info&&this.constructor.widgets_info[property]?this.constructor.widgets_info[property]:info)&&this.onGetPropertyInfo?this.onGetPropertyInfo(property):info)||{}).type||(info.type=typeof this.properties[property]),"combo"==info.widget&&(info.type="enum"),info},LGraphNode.prototype.addWidget=function(type,name,value,callback,options){this.widgets||(this.widgets=[]),!options&&callback&&callback.constructor===Object&&(options=callback,callback=null),options&&options.constructor===String&&(options={property:options}),callback&&callback.constructor===String&&((options=options||{}).property=callback,callback=null),callback&&callback.constructor!==Function&&(console.warn("addWidget: callback must be a function"),callback=null);name={type:type.toLowerCase(),name:name,value:value,callback:callback,options:options||{}};if(void 0!==name.options.y&&(name.y=name.options.y),callback||name.options.callback||name.options.property||console.warn("LiteGraph addWidget(...) without a callback or property assigned"),"combo"!=type||name.options.values)return this.widgets.push(name),this.setSize(this.computeSize()),name;throw"LiteGraph addWidget('combo',...) requires to pass values in options: { values:['red','blue'] }"},LGraphNode.prototype.addCustomWidget=function(custom_widget){return this.widgets||(this.widgets=[]),this.widgets.push(custom_widget),custom_widget},LGraphNode.prototype.getBounding=function(out,compute_outer){out=out||new Float32Array(4);var nodePos=this.pos,isCollapsed=this.flags.collapsed,nodeSize=this.size;let left_offset=0,right_offset=1,top_offset=0,bottom_offset=0;return compute_outer&&(left_offset=4,right_offset=6+left_offset,top_offset=4,bottom_offset=5+top_offset),out[0]=nodePos[0]-left_offset,out[1]=nodePos[1]-LiteGraph.NODE_TITLE_HEIGHT-top_offset,out[2]=isCollapsed?(this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH)+right_offset:nodeSize[0]+right_offset,out[3]=isCollapsed?LiteGraph.NODE_TITLE_HEIGHT+bottom_offset:nodeSize[1]+LiteGraph.NODE_TITLE_HEIGHT+bottom_offset,this.onBounding&&this.onBounding(out),out},LGraphNode.prototype.isPointInside=function(x,y,margin,skip_title){margin=margin||0;var margin_top=this.graph&&this.graph.isLive()?0:LiteGraph.NODE_TITLE_HEIGHT;if(skip_title&&(margin_top=0),this.flags&&this.flags.collapsed){if(isInsideRectangle(x,y,this.pos[0]-margin,this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT-margin,(this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH)+2*margin,LiteGraph.NODE_TITLE_HEIGHT+2*margin))return!0}else if(this.pos[0]-4-margin<x&&this.pos[0]+this.size[0]+4+margin>x&&this.pos[1]-margin_top-margin<y&&this.pos[1]+this.size[1]+margin>y)return!0;return!1},LGraphNode.prototype.getSlotInPosition=function(x,y){var link_pos=new Float32Array(2);if(this.inputs)for(var i=0,l=this.inputs.length;i<l;++i){var input=this.inputs[i];if(this.getConnectionPos(!0,i,link_pos),isInsideRectangle(x,y,link_pos[0]-10,link_pos[1]-5,20,10))return{input:input,slot:i,link_pos:link_pos}}if(this.outputs)for(i=0,l=this.outputs.length;i<l;++i){var output=this.outputs[i];if(this.getConnectionPos(!1,i,link_pos),isInsideRectangle(x,y,link_pos[0]-10,link_pos[1]-5,20,10))return{output:output,slot:i,link_pos:link_pos}}return null},LGraphNode.prototype.findInputSlot=function(name,returnObj){if(this.inputs)for(var i=0,l=this.inputs.length;i<l;++i)if(name==this.inputs[i].name)return returnObj?this.inputs[i]:i;return-1},LGraphNode.prototype.findOutputSlot=function(name,returnObj){if(returnObj=returnObj||!1,this.outputs)for(var i=0,l=this.outputs.length;i<l;++i)if(name==this.outputs[i].name)return returnObj?this.outputs[i]:i;return-1},LGraphNode.prototype.findInputSlotFree=function(optsIn){var optsIn=optsIn||{},opts=Object.assign({returnObj:!1,typesNotAccepted:[]},optsIn);if(this.inputs)for(var i=0,l=this.inputs.length;i<l;++i)if(!(this.inputs[i].link&&null!=this.inputs[i].link||opts.typesNotAccepted&&opts.typesNotAccepted.includes&&opts.typesNotAccepted.includes(this.inputs[i].type)))return opts.returnObj?this.inputs[i]:i;return-1},LGraphNode.prototype.findOutputSlotFree=function(optsIn){var optsIn=optsIn||{},opts=Object.assign({returnObj:!1,typesNotAccepted:[]},optsIn);if(this.outputs)for(var i=0,l=this.outputs.length;i<l;++i)if(!(this.outputs[i].links&&null!=this.outputs[i].links||opts.typesNotAccepted&&opts.typesNotAccepted.includes&&opts.typesNotAccepted.includes(this.outputs[i].type)))return opts.returnObj?this.outputs[i]:i;return-1},LGraphNode.prototype.findInputSlotByType=function(type,returnObj,preferFreeSlot,doNotUseOccupied){return this.findSlotByType(!0,type,returnObj,preferFreeSlot,doNotUseOccupied)},LGraphNode.prototype.findOutputSlotByType=function(type,returnObj,preferFreeSlot,doNotUseOccupied){return this.findSlotByType(!1,type,returnObj,preferFreeSlot,doNotUseOccupied)},LGraphNode.prototype.findSlotByType=function(input,type,returnObj,preferFreeSlot,doNotUseOccupied){returnObj=returnObj||!1,preferFreeSlot=preferFreeSlot||!1,doNotUseOccupied=doNotUseOccupied||!1;var aSlots=(input=input||!1)?this.inputs:this.outputs;if(aSlots){""!=type&&"*"!=type||(type=0);for(var i=0,l=aSlots.length;i<l;++i){var aSource=(type+"").toLowerCase().split(",");aDest=((aDest="0"==aSlots[i].type||"*"==aSlots[i].type?"0":aSlots[i].type)+"").toLowerCase().split(",");for(var sI=0;sI<aSource.length;sI++)for(var dI=0;dI<aDest.length;dI++)if("_event_"==aSource[sI]&&(aSource[sI]=LiteGraph.EVENT),"_event_"==aDest[sI]&&(aDest[sI]=LiteGraph.EVENT),"*"==aSource[sI]&&(aSource[sI]=0),"*"==aDest[sI]&&(aDest[sI]=0),!(aSource[sI]!=aDest[dI]||preferFreeSlot&&aSlots[i].links&&null!==aSlots[i].links))return returnObj?aSlots[i]:i}if(preferFreeSlot&&!doNotUseOccupied)for(i=0,l=aSlots.length;i<l;++i){var aDest,aSource=(type+"").toLowerCase().split(",");aDest=((aDest="0"==aSlots[i].type||"*"==aSlots[i].type?"0":aSlots[i].type)+"").toLowerCase().split(",");for(sI=0;sI<aSource.length;sI++)for(dI=0;dI<aDest.length;dI++)if("*"==aSource[sI]&&(aSource[sI]=0),"*"==aDest[sI]&&(aDest[sI]=0),aSource[sI]==aDest[dI])return returnObj?aSlots[i]:i}}return-1},LGraphNode.prototype.connectByType=function(slot,target_node,target_slotType,optsIn){var optsIn=optsIn||{},optsIn=Object.assign({createEventInCase:!0,firstFreeIfOutputGeneralInCase:!0,generalTypeInCase:!0},optsIn),target_slot=(target_node=target_node&&target_node.constructor===Number?this.graph.getNodeById(target_node):target_node).findInputSlotByType(target_slotType,!1,!0);return 0<=target_slot&&null!==target_slot?this.connect(slot,target_node,target_slot):optsIn.createEventInCase&&target_slotType==LiteGraph.EVENT?this.connect(slot,target_node,-1):optsIn.generalTypeInCase&&0<=(target_slot=target_node.findInputSlotByType(0,!1,!0,!0))||optsIn.firstFreeIfOutputGeneralInCase&&(0==target_slotType||"*"==target_slotType||""==target_slotType)&&0<=(target_slot=target_node.findInputSlotFree({typesNotAccepted:[LiteGraph.EVENT]}))?this.connect(slot,target_node,target_slot):(console.debug("no way to connect type: ",target_slotType," to targetNODE ",target_node),null)},LGraphNode.prototype.connectByTypeOutput=function(slot,source_node,source_slotType,optsIn){var optsIn=optsIn||{},optsIn=Object.assign({createEventInCase:!0,firstFreeIfInputGeneralInCase:!0,generalTypeInCase:!0},optsIn),source_slot=(source_node=source_node&&source_node.constructor===Number?this.graph.getNodeById(source_node):source_node).findOutputSlotByType(source_slotType,!1,!0);return 0<=source_slot&&null!==source_slot||optsIn.generalTypeInCase&&0<=(source_slot=source_node.findOutputSlotByType(0,!1,!0,!0))?source_node.connect(source_slot,this,slot):optsIn.createEventInCase&&source_slotType==LiteGraph.EVENT&&LiteGraph.do_add_triggers_slots?(source_slot=source_node.addOnExecutedOutput(),source_node.connect(source_slot,this,slot)):optsIn.firstFreeIfInputGeneralInCase&&(0==source_slotType||"*"==source_slotType||""==source_slotType)&&0<=(source_slot=source_node.findOutputSlotFree({typesNotAccepted:[LiteGraph.EVENT]}))?source_node.connect(source_slot,this,slot):(console.debug("no way to connect byOUT type: ",source_slotType," to sourceNODE ",source_node),null)},LGraphNode.prototype.connect=function(slot,target_node,target_slot){if(target_slot=target_slot||0,!this.graph)return console.log("Connect: Error, node doesn't belong to any graph. Nodes must be added first to a graph before connecting them."),null;if(slot.constructor===String){if(-1==(slot=this.findOutputSlot(slot)))return LiteGraph.debug&&console.log("Connect: Error, no slot of name "+slot),null}else if(!this.outputs||slot>=this.outputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),null;if(!(target_node=target_node&&target_node.constructor===Number?this.graph.getNodeById(target_node):target_node))throw"target node is null";if(target_node==this)return null;if(target_slot.constructor===String){if(-1==(target_slot=target_node.findInputSlot(target_slot)))return LiteGraph.debug&&console.log("Connect: Error, no slot of name "+target_slot),null}else if(target_slot===LiteGraph.EVENT){if(!LiteGraph.do_add_triggers_slots)return null;target_node.changeMode(LiteGraph.ON_TRIGGER),target_slot=target_node.findInputSlot("onTrigger")}else if(!target_node.inputs||target_slot>=target_node.inputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),null;var link_info,changed=!1,input=target_node.inputs[target_slot],output=this.outputs[slot];return this.outputs[slot]?!1!==(target_slot=target_node.onBeforeConnectInput?target_node.onBeforeConnectInput(target_slot):target_slot)&&null!==target_slot&&LiteGraph.isValidConnection(output.type,input.type)?target_node.onConnectInput&&!1===target_node.onConnectInput(target_slot,output.type,output,this,slot)||this.onConnectOutput&&!1===this.onConnectOutput(slot,input.type,input,target_node,target_slot)?null:(target_node.inputs[target_slot]&&null!=target_node.inputs[target_slot].link&&(this.graph.beforeChange(),target_node.disconnectInput(target_slot,{doProcessChange:!1}),changed=!0),null!==output.links&&output.links.length&&output.type===LiteGraph.EVENT&&!LiteGraph.allow_multi_output_for_events&&(this.graph.beforeChange(),this.disconnectOutput(slot,!1,{doProcessChange:!1}),changed=!0),link_info=new LLink(LiteGraph.use_uuids?LiteGraph.uuidv4():++this.graph.last_link_id,input.type||output.type,this.id,slot,target_node.id,target_slot),this.graph.links[link_info.id]=link_info,null==output.links&&(output.links=[]),output.links.push(link_info.id),target_node.inputs[target_slot].link=link_info.id,this.graph&&this.graph._version++,this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.OUTPUT,slot,!0,link_info,output),target_node.onConnectionsChange&&target_node.onConnectionsChange(LiteGraph.INPUT,target_slot,!0,link_info,input),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.INPUT,target_node,target_slot,this,slot),this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,slot,target_node,target_slot)),this.setDirtyCanvas(!1,!0),this.graph.afterChange(),this.graph.connectionChange(this,link_info),link_info):(this.setDirtyCanvas(!1,!0),changed&&this.graph.connectionChange(this,null),null):null},LGraphNode.prototype.disconnectOutput=function(slot,target_node){if(slot.constructor===String){if(-1==(slot=this.findOutputSlot(slot)))return LiteGraph.debug&&console.log("Connect: Error, no slot of name "+slot),!1}else if(!this.outputs||slot>=this.outputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),!1;var output=this.outputs[slot];if(!output||!output.links||0==output.links.length)return!1;if(target_node){if(!(target_node=target_node.constructor===Number?this.graph.getNodeById(target_node):target_node))throw"Target Node not found";for(var i=0,l=output.links.length;i<l;i++){var link_id=output.links[i];if((link_info=this.graph.links[link_id]).target_id==target_node.id){output.links.splice(i,1),(input=target_node.inputs[link_info.target_slot]).link=null,delete this.graph.links[link_id],this.graph&&this.graph._version++,target_node.onConnectionsChange&&target_node.onConnectionsChange(LiteGraph.INPUT,link_info.target_slot,!1,link_info,input),this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.OUTPUT,slot,!1,link_info,output),this.graph&&this.graph.onNodeConnectionChange&&this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,slot),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,slot),this.graph.onNodeConnectionChange(LiteGraph.INPUT,target_node,link_info.target_slot));break}}}else{for(i=0,l=output.links.length;i<l;i++){var link_info,input,link_id=output.links[i];(link_info=this.graph.links[link_id])&&(target_node=this.graph.getNodeById(link_info.target_id),input=null,this.graph&&this.graph._version++,target_node&&((input=target_node.inputs[link_info.target_slot]).link=null,target_node.onConnectionsChange&&target_node.onConnectionsChange(LiteGraph.INPUT,link_info.target_slot,!1,link_info,input),this.graph)&&this.graph.onNodeConnectionChange&&this.graph.onNodeConnectionChange(LiteGraph.INPUT,target_node,link_info.target_slot),delete this.graph.links[link_id],this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.OUTPUT,slot,!1,link_info,output),this.graph)&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,slot),this.graph.onNodeConnectionChange(LiteGraph.INPUT,target_node,link_info.target_slot))}output.links=null}return this.setDirtyCanvas(!1,!0),this.graph.connectionChange(this),!0},LGraphNode.prototype.disconnectInput=function(slot){if(slot.constructor===String){if(-1==(slot=this.findInputSlot(slot)))return LiteGraph.debug&&console.log("Connect: Error, no slot of name "+slot),!1}else if(!this.inputs||slot>=this.inputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),!1;var input=this.inputs[slot];if(!input)return!1;var link_id=this.inputs[slot].link;if(null!=link_id){this.inputs[slot].link=null;var link_info=this.graph.links[link_id];if(link_info){var target_node=this.graph.getNodeById(link_info.origin_id);if(!target_node)return!1;var output=target_node.outputs[link_info.origin_slot];if(!output||!output.links||0==output.links.length)return!1;for(var i=0,l=output.links.length;i<l;i++)if(output.links[i]==link_id){output.links.splice(i,1);break}delete this.graph.links[link_id],this.graph&&this.graph._version++,this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.INPUT,slot,!1,link_info,input),target_node.onConnectionsChange&&target_node.onConnectionsChange(LiteGraph.OUTPUT,i,!1,link_info,output),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,target_node,i),this.graph.onNodeConnectionChange(LiteGraph.INPUT,this,slot))}}return this.setDirtyCanvas(!1,!0),this.graph&&this.graph.connectionChange(this),!0},LGraphNode.prototype.getConnectionPos=function(is_input,slot_number,out){out=out||new Float32Array(2);var w,num_slots=0,offset=(is_input&&this.inputs&&(num_slots=this.inputs.length),!is_input&&this.outputs&&(num_slots=this.outputs.length),.5*LiteGraph.NODE_SLOT_HEIGHT);return this.flags.collapsed?(w=this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH,this.horizontal?(out[0]=this.pos[0]+.5*w,out[1]=is_input?this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT:this.pos[1]):(out[0]=is_input?this.pos[0]:this.pos[0]+w,out[1]=this.pos[1]-.5*LiteGraph.NODE_TITLE_HEIGHT)):is_input&&-1==slot_number?(out[0]=this.pos[0]+.5*LiteGraph.NODE_TITLE_HEIGHT,out[1]=this.pos[1]+.5*LiteGraph.NODE_TITLE_HEIGHT):is_input&&slot_number<num_slots&&this.inputs[slot_number].pos?(out[0]=this.pos[0]+this.inputs[slot_number].pos[0],out[1]=this.pos[1]+this.inputs[slot_number].pos[1]):!is_input&&slot_number<num_slots&&this.outputs[slot_number].pos?(out[0]=this.pos[0]+this.outputs[slot_number].pos[0],out[1]=this.pos[1]+this.outputs[slot_number].pos[1]):this.horizontal?(out[0]=this.pos[0]+(slot_number+.5)*(this.size[0]/num_slots),out[1]=is_input?this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT:this.pos[1]+this.size[1]):(out[0]=is_input?this.pos[0]+offset:this.pos[0]+this.size[0]+1-offset,out[1]=this.pos[1]+(slot_number+.7)*LiteGraph.NODE_SLOT_HEIGHT+(this.constructor.slot_start_y||0)),out},LGraphNode.prototype.alignToGrid=function(){this.pos[0]=LiteGraph.CANVAS_GRID_SIZE*Math.round(this.pos[0]/LiteGraph.CANVAS_GRID_SIZE),this.pos[1]=LiteGraph.CANVAS_GRID_SIZE*Math.round(this.pos[1]/LiteGraph.CANVAS_GRID_SIZE)},LGraphNode.prototype.trace=function(msg){this.console||(this.console=[]),this.console.push(msg),this.console.length>LGraphNode.MAX_CONSOLE&&this.console.shift(),this.graph.onNodeTrace&&this.graph.onNodeTrace(this,msg)},LGraphNode.prototype.setDirtyCanvas=function(dirty_foreground,dirty_background){this.graph&&this.graph.sendActionToCanvas("setDirty",[dirty_foreground,dirty_background])},LGraphNode.prototype.loadImage=function(url){var img=new Image,that=(img.src=LiteGraph.node_images_path+url,img.ready=!1,this);return img.onload=function(){this.ready=!0,that.setDirtyCanvas(!0)},img},LGraphNode.prototype.captureInput=function(v){if(this.graph&&this.graph.list_of_graphcanvas)for(var list=this.graph.list_of_graphcanvas,i=0;i<list.length;++i){var c=list[i];!v&&c.node_capturing_input!=this||(c.node_capturing_input=v?this:null)}},LGraphNode.prototype.collapse=function(force){this.graph._version++,!1===this.constructor.collapsable&&!force||(this.flags.collapsed?this.flags.collapsed=!1:this.flags.collapsed=!0,this.setDirtyCanvas(!0,!0))},LGraphNode.prototype.pin=function(v){this.graph._version++,this.flags.pinned=void 0===v?!this.flags.pinned:v},LGraphNode.prototype.localToScreen=function(x,y,graphcanvas){return[(x+this.pos[0])*graphcanvas.scale+graphcanvas.offset[0],(y+this.pos[1])*graphcanvas.scale+graphcanvas.offset[1]]},LGraphGroup.prototype._ctor=function(title){this.title=title||"Group",this.font_size=24,this.color=LGraphCanvas.node_colors.pale_blue?LGraphCanvas.node_colors.pale_blue.groupcolor:"#AAA",this._bounding=new Float32Array([10,10,140,80]),this._pos=this._bounding.subarray(0,2),this._size=this._bounding.subarray(2,4),this._nodes=[],this.graph=null,Object.defineProperty(this,"pos",{set:function(v){!v||v.length<2||(this._pos[0]=v[0],this._pos[1]=v[1])},get:function(){return this._pos},enumerable:!0}),Object.defineProperty(this,"size",{set:function(v){!v||v.length<2||(this._size[0]=Math.max(140,v[0]),this._size[1]=Math.max(80,v[1]))},get:function(){return this._size},enumerable:!0})},LGraphGroup.prototype.configure=function(o){this.title=o.title,this._bounding.set(o.bounding),this.color=o.color,this.font_size=o.font_size},LGraphGroup.prototype.serialize=function(){var b=this._bounding;return{title:this.title,bounding:[Math.round(b[0]),Math.round(b[1]),Math.round(b[2]),Math.round(b[3])],color:this.color,font_size:this.font_size}},LGraphGroup.prototype.move=function(deltax,deltay,ignore_nodes){if(this._pos[0]+=deltax,this._pos[1]+=deltay,!ignore_nodes)for(var i=0;i<this._nodes.length;++i){var node=this._nodes[i];node.pos[0]+=deltax,node.pos[1]+=deltay}},LGraphGroup.prototype.recomputeInsideNodes=function(){this._nodes.length=0;for(var nodes=this.graph._nodes,node_bounding=new Float32Array(4),i=0;i<nodes.length;++i){var node=nodes[i];node.getBounding(node_bounding),overlapBounding(this._bounding,node_bounding)&&this._nodes.push(node)}},LGraphGroup.prototype.isPointInside=LGraphNode.prototype.isPointInside,LGraphGroup.prototype.setDirtyCanvas=LGraphNode.prototype.setDirtyCanvas,DragAndScale.prototype.bindEvents=function(element){this.last_mouse=new Float32Array(2),this._binded_mouse_callback=this.onMouse.bind(this),LiteGraph.pointerListenerAdd(element,"down",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(element,"move",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(element,"up",this._binded_mouse_callback),element.addEventListener("mousewheel",this._binded_mouse_callback,!1),element.addEventListener("wheel",this._binded_mouse_callback,!1)},DragAndScale.prototype.computeVisibleArea=function(viewport){var height,startx,starty,width;this.element?(width=this.element.width,height=this.element.height,startx=-this.offset[0],starty=-this.offset[1],viewport&&(startx+=viewport[0]/this.scale,starty+=viewport[1]/this.scale,width=viewport[2],height=viewport[3]),viewport=startx+width/this.scale,width=starty+height/this.scale,this.visible_area[0]=startx,this.visible_area[1]=starty,this.visible_area[2]=viewport-startx,this.visible_area[3]=width-starty):this.visible_area[0]=this.visible_area[1]=this.visible_area[2]=this.visible_area[3]=0},DragAndScale.prototype.onMouse=function(e){var canvas,x,rect,is_inside,ignore,deltay;if(this.enabled)return rect=(canvas=this.element).getBoundingClientRect(),x=e.clientX-rect.left,rect=e.clientY-rect.top,e.canvasx=x,e.canvasy=rect,e.dragging=this.dragging,is_inside=!this.viewport||this.viewport&&x>=this.viewport[0]&&x<this.viewport[0]+this.viewport[2]&&rect>=this.viewport[1]&&rect<this.viewport[1]+this.viewport[3],ignore=!1,this.onmouse&&(ignore=this.onmouse(e)),e.type==LiteGraph.pointerevents_method+"down"&&is_inside?(this.dragging=!0,LiteGraph.pointerListenerRemove(canvas,"move",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(document,"move",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(document,"up",this._binded_mouse_callback)):e.type==LiteGraph.pointerevents_method+"move"?ignore||(ignore=x-this.last_mouse[0],deltay=rect-this.last_mouse[1],this.dragging&&this.mouseDrag(ignore,deltay)):e.type==LiteGraph.pointerevents_method+"up"?(this.dragging=!1,LiteGraph.pointerListenerRemove(document,"move",this._binded_mouse_callback),LiteGraph.pointerListenerRemove(document,"up",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(canvas,"move",this._binded_mouse_callback)):!is_inside||"mousewheel"!=e.type&&"wheel"!=e.type&&"DOMMouseScroll"!=e.type||(e.eventType="mousewheel","wheel"==e.type?e.wheel=-e.deltaY:e.wheel=null!=e.wheelDeltaY?e.wheelDeltaY:-60*e.detail,e.delta=e.wheelDelta?e.wheelDelta/40:e.deltaY?-e.deltaY/3:0,this.changeDeltaScale(1+.05*e.delta)),this.last_mouse[0]=x,this.last_mouse[1]=rect,is_inside?(e.preventDefault(),e.stopPropagation(),!1):void 0},DragAndScale.prototype.toCanvasContext=function(ctx){ctx.scale(this.scale,this.scale),ctx.translate(this.offset[0],this.offset[1])},DragAndScale.prototype.convertOffsetToCanvas=function(pos){return[(pos[0]+this.offset[0])*this.scale,(pos[1]+this.offset[1])*this.scale]},DragAndScale.prototype.convertCanvasToOffset=function(pos,out){return(out=out||[0,0])[0]=pos[0]/this.scale-this.offset[0],out[1]=pos[1]/this.scale-this.offset[1],out},DragAndScale.prototype.mouseDrag=function(x,y){this.offset[0]+=x/this.scale,this.offset[1]+=y/this.scale,this.onredraw&&this.onredraw(this)},DragAndScale.prototype.changeScale=function(value,zooming_center){var rect;value<this.min_scale?value=this.min_scale:value>this.max_scale&&(value=this.max_scale),value!=this.scale&&this.element&&(rect=this.element.getBoundingClientRect())&&(zooming_center=zooming_center||[.5*rect.width,.5*rect.height],rect=this.convertCanvasToOffset(zooming_center),this.scale=value,Math.abs(this.scale-1)<.01&&(this.scale=1),zooming_center=[(value=this.convertCanvasToOffset(zooming_center))[0]-rect[0],value[1]-rect[1]],this.offset[0]+=zooming_center[0],this.offset[1]+=zooming_center[1],this.onredraw)&&this.onredraw(this)},DragAndScale.prototype.changeDeltaScale=function(value,zooming_center){this.changeScale(this.scale*value,zooming_center)},DragAndScale.prototype.reset=function(){this.scale=1,this.offset[0]=0,this.offset[1]=0},LGraphCanvas.DEFAULT_BACKGROUND_IMAGE="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAIAAAD/gAIDAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQBJREFUeNrs1rEKwjAUhlETUkj3vP9rdmr1Ysammk2w5wdxuLgcMHyptfawuZX4pJSWZTnfnu/lnIe/jNNxHHGNn//HNbbv+4dr6V+11uF527arU7+u63qfa/bnmh8sWLBgwYJlqRf8MEptXPBXJXa37BSl3ixYsGDBMliwFLyCV/DeLIMFCxYsWLBMwSt4Be/NggXLYMGCBUvBK3iNruC9WbBgwYJlsGApeAWv4L1ZBgsWLFiwYJmCV/AK3psFC5bBggULloJX8BpdwXuzYMGCBctgwVLwCl7Be7MMFixYsGDBsu8FH1FaSmExVfAxBa/gvVmwYMGCZbBg/W4vAQYA5tRF9QYlv/QAAAAASUVORK5CYII=",LGraphCanvas.link_type_colors={"-1":LiteGraph.EVENT_LINK_COLOR,number:"#AAA",node:"#DCA"},LGraphCanvas.gradients={},LGraphCanvas.prototype.clear=function(){this.frame=0,this.last_draw_time=0,this.render_time=0,this.fps=0,this.dragging_rectangle=null,this.selected_nodes={},this.selected_group=null,this.visible_nodes=[],this.node_dragged=null,this.node_over=null,this.node_capturing_input=null,this.connecting_node=null,this.highlighted_links={},this.dragging_canvas=!1,this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.dirty_area=null,this.node_in_panel=null,this.node_widget=null,this.last_mouse=[0,0],this.last_mouseclick=0,this.pointer_is_down=!1,this.pointer_is_double=!1,this.visible_area.set([0,0,0,0]),this.onClear&&this.onClear()},LGraphCanvas.prototype.setGraph=function(graph,skip_clear){this.graph!=graph&&(skip_clear||this.clear(),!graph&&this.graph?this.graph.detachCanvas(this):(graph.attachCanvas(this),this._graph_stack&&(this._graph_stack=null),this.setDirty(!0,!0)))},LGraphCanvas.prototype.getTopGraph=function(){return this._graph_stack.length?this._graph_stack[0]:this.graph},LGraphCanvas.prototype.openSubgraph=function(graph){if(!graph)throw"graph cannot be null";if(this.graph==graph)throw"graph cannot be the same";this.clear(),this.graph&&(this._graph_stack||(this._graph_stack=[]),this._graph_stack.push(this.graph)),graph.attachCanvas(this),this.checkPanels(),this.setDirty(!0,!0)},LGraphCanvas.prototype.closeSubgraph=function(){var subgraph_node,graph;this._graph_stack&&0!=this._graph_stack.length&&(subgraph_node=this.graph._subgraph_node,graph=this._graph_stack.pop(),this.selected_nodes={},this.highlighted_links={},graph.attachCanvas(this),this.setDirty(!0,!0),subgraph_node&&(this.centerOnNode(subgraph_node),this.selectNodes([subgraph_node])),this.ds.offset=[0,0],this.ds.scale=1)},LGraphCanvas.prototype.getCurrentGraph=function(){return this.graph},LGraphCanvas.prototype.setCanvas=function(canvas,skip_events){if(canvas&&canvas.constructor===String&&!(canvas=document.getElementById(canvas)))throw"Error creating LiteGraph canvas: Canvas not found";if(canvas!==this.canvas&&(canvas||!this.canvas||skip_events||this.unbindEvents(),this.canvas=canvas,this.ds.element=canvas)){if(canvas.className+=" lgraphcanvas",canvas.data=this,canvas.tabindex="1",this.bgcanvas=null,this.bgcanvas||(this.bgcanvas=document.createElement("canvas"),this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height),null==canvas.getContext){if("canvas"!=canvas.localName)throw"Element supplied for LGraphCanvas must be a <canvas> element, you passed a "+canvas.localName;throw"This browser doesn't support Canvas"}null==(this.ctx=canvas.getContext("2d"))&&(canvas.webgl_enabled||console.warn("This canvas seems to be WebGL, enabling WebGL renderer"),this.enableWebGL()),skip_events||this.bindEvents()}},LGraphCanvas.prototype._doNothing=function(e){return e.preventDefault(),!1},LGraphCanvas.prototype._doReturnTrue=function(e){return e.preventDefault(),!0},LGraphCanvas.prototype.bindEvents=function(){var canvas,document;this._events_binded?console.warn("LGraphCanvas: events already binded"):(canvas=this.canvas,document=this.getCanvasWindow().document,this._mousedown_callback=this.processMouseDown.bind(this),this._mousewheel_callback=this.processMouseWheel.bind(this),this._mousemove_callback=this.processMouseMove.bind(this),this._mouseup_callback=this.processMouseUp.bind(this),LiteGraph.pointerListenerAdd(canvas,"down",this._mousedown_callback,!0),canvas.addEventListener("mousewheel",this._mousewheel_callback,!1),LiteGraph.pointerListenerAdd(canvas,"up",this._mouseup_callback,!0),LiteGraph.pointerListenerAdd(canvas,"move",this._mousemove_callback),canvas.addEventListener("contextmenu",this._doNothing),canvas.addEventListener("DOMMouseScroll",this._mousewheel_callback,!1),this._key_callback=this.processKey.bind(this),canvas.setAttribute("tabindex",1),canvas.addEventListener("keydown",this._key_callback,!0),document.addEventListener("keyup",this._key_callback,!0),this._ondrop_callback=this.processDrop.bind(this),canvas.addEventListener("dragover",this._doNothing,!1),canvas.addEventListener("dragend",this._doNothing,!1),canvas.addEventListener("drop",this._ondrop_callback,!1),canvas.addEventListener("dragenter",this._doReturnTrue,!1),this._events_binded=!0)},LGraphCanvas.prototype.unbindEvents=function(){var document;this._events_binded?(document=this.getCanvasWindow().document,LiteGraph.pointerListenerRemove(this.canvas,"move",this._mousedown_callback),LiteGraph.pointerListenerRemove(this.canvas,"up",this._mousedown_callback),LiteGraph.pointerListenerRemove(this.canvas,"down",this._mousedown_callback),this.canvas.removeEventListener("mousewheel",this._mousewheel_callback),this.canvas.removeEventListener("DOMMouseScroll",this._mousewheel_callback),this.canvas.removeEventListener("keydown",this._key_callback),document.removeEventListener("keyup",this._key_callback),this.canvas.removeEventListener("contextmenu",this._doNothing),this.canvas.removeEventListener("drop",this._ondrop_callback),this.canvas.removeEventListener("dragenter",this._doReturnTrue),this._mousedown_callback=null,this._mousewheel_callback=null,this._key_callback=null,this._ondrop_callback=null,this._events_binded=!1):console.warn("LGraphCanvas: no events binded")},LGraphCanvas.getFileExtension=function(url){var question=url.indexOf("?"),question=(url=-1!=question?url.substr(0,question):url).lastIndexOf(".");return-1==question?"":url.substr(question+1).toLowerCase()},LGraphCanvas.prototype.enableWebGL=function(){if("undefined"==typeof GL)throw"litegl.js must be included to use a WebGL canvas";if("undefined"==typeof enableWebGLCanvas)throw"webglCanvas.js must be included to use this feature";this.gl=this.ctx=enableWebGLCanvas(this.canvas),this.ctx.webgl=!0,this.bgcanvas=this.canvas,this.bgctx=this.gl,this.canvas.webgl_enabled=!0},LGraphCanvas.prototype.setDirty=function(fgcanvas,bgcanvas){fgcanvas&&(this.dirty_canvas=!0),bgcanvas&&(this.dirty_bgcanvas=!0)},LGraphCanvas.prototype.getCanvasWindow=function(){var doc;return this.canvas?(doc=this.canvas.ownerDocument).defaultView||doc.parentWindow:window},LGraphCanvas.prototype.startRendering=function(){function renderFrame(){this.pause_rendering||this.draw();var window=this.getCanvasWindow();this.is_rendering&&window.requestAnimationFrame(renderFrame.bind(this))}this.is_rendering||(this.is_rendering=!0,renderFrame.call(this))},LGraphCanvas.prototype.stopRendering=function(){this.is_rendering=!1},LGraphCanvas.prototype.blockClick=function(){this.block_click=!0,this.last_mouseclick=0},LGraphCanvas.prototype.processMouseDown=function(e){if(this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),this.graph){this.adjustMouseEvent(e);var ref_window=this.getCanvasWindow(),that=LGraphCanvas.active_canvas=this,x=e.clientX,y=e.clientY,x=(this.ds.viewport=this.viewport,!this.viewport||this.viewport&&x>=this.viewport[0]&&x<this.viewport[0]+this.viewport[2]&&y>=this.viewport[1]&&y<this.viewport[1]+this.viewport[3]);if(this.options.skip_events||(LiteGraph.pointerListenerRemove(this.canvas,"move",this._mousemove_callback),LiteGraph.pointerListenerAdd(ref_window.document,"move",this._mousemove_callback,!0),LiteGraph.pointerListenerAdd(ref_window.document,"up",this._mouseup_callback,!0)),x){var node=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes,5),skip_action=!1,y=LiteGraph.getTime(),x=void 0===e.isPrimary||!e.isPrimary,is_double_click=y-this.last_mouseclick<300&&x;if(this.mouse[0]=e.clientX,this.mouse[1]=e.clientY,this.graph_mouse[0]=e.canvasX,this.graph_mouse[1]=e.canvasY,this.last_click_position=[this.mouse[0],this.mouse[1]],this.pointer_is_down&&x?this.pointer_is_double=!0:this.pointer_is_double=!1,this.pointer_is_down=!0,this.canvas.focus(),LiteGraph.closeAllContextMenus(ref_window),!this.onMouse||!this.onMouse(e)){if(1!=e.which||this.pointer_is_double)if(2==e.which)if(LiteGraph.middle_click_slot_add_default_node){if(node&&this.allow_interaction&&!skip_action&&!this.read_only&&!this.connecting_node&&!node.flags.collapsed&&!this.live_mode){var mClikSlot=!1,mClikSlot_index=!1,mClikSlot_isOut=!1;if(node.outputs)for(i=0,l=node.outputs.length;i<l;++i){output=node.outputs[i],link_pos=node.getConnectionPos(!1,i);if(isInsideRectangle(e.canvasX,e.canvasY,link_pos[0]-15,link_pos[1]-10,30,20)){mClikSlot=output,mClikSlot_index=i,mClikSlot_isOut=!0;break}}if(node.inputs)for(i=0,l=node.inputs.length;i<l;++i){input=node.inputs[i],link_pos=node.getConnectionPos(!0,i);if(isInsideRectangle(e.canvasX,e.canvasY,link_pos[0]-15,link_pos[1]-10,30,20)){mClikSlot=input,mClikSlot_index=i,mClikSlot_isOut=!1;break}}mClikSlot&&!1!==mClikSlot_index&&(y=.5-(mClikSlot_index+1)/(mClikSlot_isOut?node.outputs:node.inputs).length,x=node.getBounding(),x=[mClikSlot_isOut?x[0]+x[2]:x[0],e.canvasY-80],this.createDefaultNodeForSlot({nodeFrom:mClikSlot_isOut?node:null,slotFrom:mClikSlot_isOut?mClikSlot_index:null,nodeTo:mClikSlot_isOut?null:node,slotTo:mClikSlot_isOut?null:mClikSlot_index,position:x,nodeType:"AUTO",posAdd:[mClikSlot_isOut?30:-30,130*-y],posSizeFix:[mClikSlot_isOut?0:-1,0]}))}}else!skip_action&&this.allow_dragcanvas&&(this.dragging_canvas=!0);else 3!=e.which&&!this.pointer_is_double||!this.allow_interaction||skip_action||this.read_only||(node&&(Object.keys(this.selected_nodes).length&&(this.selected_nodes[node.id]||e.shiftKey||e.ctrlKey||e.metaKey)?this.selected_nodes[node.id]||this.selectNodes([node],!0):this.selectNodes([node])),this.processContextMenu(node,e));else{e.ctrlKey&&(this.dragging_rectangle=new Float32Array(4),this.dragging_rectangle[0]=e.canvasX,this.dragging_rectangle[1]=e.canvasY,this.dragging_rectangle[2]=1,this.dragging_rectangle[3]=1,skip_action=!0),LiteGraph.alt_drag_do_clone_nodes&&e.altKey&&node&&this.allow_interaction&&!skip_action&&!this.read_only&&(cloned=node.clone())&&(cloned.pos[0]+=5,cloned.pos[1]+=5,this.graph.add(cloned,!1,{doCalcSize:!1}),node=cloned,skip_action=!0,block_drag_node||(this.allow_dragnodes&&(this.graph.beforeChange(),this.node_dragged=node),this.selected_nodes[node.id])||this.processNodeSelected(node,e));var block_drag_node,widget,x=!1;if(!node||!this.allow_interaction&&!node.flags.allow_interaction||skip_action||this.read_only){if(!skip_action){if(!this.read_only)for(var i=0;i<this.visible_links.length;++i){var link=this.visible_links[i],center=link._pos;if(!(!center||e.canvasX<center[0]-4||e.canvasX>center[0]+4||e.canvasY<center[1]-4||e.canvasY>center[1]+4)){this.showLinkMenu(link,e),this.over_link_center=null;break}}this.selected_group=this.graph.getGroupOnPos(e.canvasX,e.canvasY),this.selected_group_resizing=!1,this.selected_group&&!this.read_only&&(e.ctrlKey&&(this.dragging_rectangle=null),distance([e.canvasX,e.canvasY],[this.selected_group.pos[0]+this.selected_group.size[0],this.selected_group.pos[1]+this.selected_group.size[1]])*this.ds.scale<10?this.selected_group_resizing=!0:this.selected_group.recomputeInsideNodes()),is_double_click&&!this.read_only&&this.allow_searchbox&&(this.showSearchBox(e),e.preventDefault(),e.stopPropagation()),x=!0}}else{if(this.live_mode||node.flags.pinned||this.bringToFront(node),this.allow_interaction&&!this.connecting_node&&!node.flags.collapsed&&!this.live_mode)if(!skip_action&&!1!==node.resizable&&isInsideRectangle(e.canvasX,e.canvasY,node.pos[0]+node.size[0]-5,node.pos[1]+node.size[1]-5,10,10))this.graph.beforeChange(),this.resizing_node=node,this.canvas.style.cursor="se-resize",skip_action=!0;else{if(node.outputs)for(var i=0,l=node.outputs.length;i<l;++i){var output=node.outputs[i],link_pos=node.getConnectionPos(!1,i);if(isInsideRectangle(e.canvasX,e.canvasY,link_pos[0]-15,link_pos[1]-10,30,20)){this.connecting_node=node,this.connecting_output=output,this.connecting_output.slot_index=i,this.connecting_pos=node.getConnectionPos(!1,i),this.connecting_slot=i,LiteGraph.shift_click_do_break_link_from&&e.shiftKey&&node.disconnectOutput(i),is_double_click?node.onOutputDblClick&&node.onOutputDblClick(i,e):node.onOutputClick&&node.onOutputClick(i,e),skip_action=!0;break}}if(node.inputs)for(var i=0,l=node.inputs.length;i<l;++i){var link_info,input=node.inputs[i],link_pos=node.getConnectionPos(!0,i);isInsideRectangle(e.canvasX,e.canvasY,link_pos[0]-15,link_pos[1]-10,30,20)&&(is_double_click?node.onInputDblClick&&node.onInputDblClick(i,e):node.onInputClick&&node.onInputClick(i,e),null!==input.link&&(link_info=this.graph.links[input.link],LiteGraph.click_do_break_link_to&&(node.disconnectInput(i),skip_action=this.dirty_bgcanvas=!0),this.allow_reconnect_links||e.shiftKey)&&(LiteGraph.click_do_break_link_to||node.disconnectInput(i),this.connecting_node=this.graph._nodes_by_id[link_info.origin_id],this.connecting_slot=link_info.origin_slot,this.connecting_output=this.connecting_node.outputs[this.connecting_slot],this.connecting_pos=this.connecting_node.getConnectionPos(!1,this.connecting_slot),skip_action=this.dirty_bgcanvas=!0),skip_action||(this.connecting_node=node,this.connecting_input=input,this.connecting_input.slot_index=i,this.connecting_pos=node.getConnectionPos(!0,i),this.connecting_slot=i,skip_action=this.dirty_bgcanvas=!0))}}skip_action||(block_drag_node=!1,y=[e.canvasX-node.pos[0],e.canvasY-node.pos[1]],(widget=this.processNodeWidgets(node,this.graph_mouse,e))&&(block_drag_node=!0,this.node_widget=[node,widget]),this.allow_interaction&&is_double_click&&this.selected_nodes[node.id]&&(node.onDblClick&&node.onDblClick(e,y,this),this.processNodeDblClicked(node),block_drag_node=!0),node.onMouseDown&&node.onMouseDown(e,y,this)?block_drag_node=!0:(node.subgraph&&!node.skip_subgraph_button&&!node.flags.collapsed&&y[0]>node.size[0]-LiteGraph.NODE_TITLE_HEIGHT&&y[1]<0&&(that=this,setTimeout(function(){that.openSubgraph(node.subgraph)},10)),this.live_mode&&(block_drag_node=x=!0)),block_drag_node?node.is_selected||this.processNodeSelected(node,e):(this.allow_dragnodes&&(this.graph.beforeChange(),this.node_dragged=node),this.processNodeSelected(node,e)),this.dirty_canvas=!0)}!skip_action&&x&&this.allow_dragcanvas&&(this.dragging_canvas=!0)}return this.last_mouse[0]=e.clientX,this.last_mouse[1]=e.clientY,this.last_mouseclick=LiteGraph.getTime(),this.last_mouse_dragging=!0,this.graph.change(),ref_window.document.activeElement&&("input"==ref_window.document.activeElement.nodeName.toLowerCase()||"textarea"==ref_window.document.activeElement.nodeName.toLowerCase())||e.preventDefault(),e.stopPropagation(),this.onMouseDown&&this.onMouseDown(e),!1}}}},LGraphCanvas.prototype.processMouseMove=function(e){if(this.autoresize&&this.resize(),this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),this.graph){(LGraphCanvas.active_canvas=this).adjustMouseEvent(e);var mouse=[e.clientX,e.clientY],delta=(this.mouse[0]=mouse[0],this.mouse[1]=mouse[1],[mouse[0]-this.last_mouse[0],mouse[1]-this.last_mouse[1]]);if(this.last_mouse=mouse,this.graph_mouse[0]=e.canvasX,this.graph_mouse[1]=e.canvasY,!this.block_click){e.dragging=this.last_mouse_dragging,this.node_widget&&(this.processNodeWidgets(this.node_widget[0],this.graph_mouse,e,this.node_widget[1]),this.dirty_canvas=!0);var node=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes);if(this.dragging_rectangle)this.dragging_rectangle[2]=e.canvasX-this.dragging_rectangle[0],this.dragging_rectangle[3]=e.canvasY-this.dragging_rectangle[1],this.dirty_canvas=!0;else if(this.selected_group&&!this.read_only)this.selected_group_resizing?this.selected_group.size=[e.canvasX-this.selected_group.pos[0],e.canvasY-this.selected_group.pos[1]]:(mouse=delta[0]/this.ds.scale,deltay=delta[1]/this.ds.scale,this.selected_group.move(mouse,deltay,e.ctrlKey),this.selected_group._nodes.length&&(this.dirty_canvas=!0)),this.dirty_bgcanvas=!0;else if(this.dragging_canvas)this.ds.offset[0]+=delta[0]/this.ds.scale,this.ds.offset[1]+=delta[1]/this.ds.scale,this.dirty_canvas=!0,this.dirty_bgcanvas=!0;else if((this.allow_interaction||node&&node.flags.allow_interaction)&&!this.read_only){this.connecting_node&&(this.dirty_canvas=!0);for(var pos,slot,slot_type,deltay,i=0,l=this.graph._nodes.length;i<l;++i)this.graph._nodes[i].mouseOver&&node!=this.graph._nodes[i]&&(this.graph._nodes[i].mouseOver=!1,this.node_over&&this.node_over.onMouseLeave&&this.node_over.onMouseLeave(e),this.node_over=null,this.dirty_canvas=!0);if(node)node.redraw_on_mouse&&(this.dirty_canvas=!0),node.mouseOver||(node.mouseOver=!0,this.node_over=node,this.dirty_canvas=!0,node.onMouseEnter&&node.onMouseEnter(e)),node.onMouseMove&&node.onMouseMove(e,[e.canvasX-node.pos[0],e.canvasY-node.pos[1]],this),this.connecting_node&&(this.connecting_output?(pos=this._highlight_input||[0,0],this.isOverNodeBox(node,e.canvasX,e.canvasY)||(-1!=(slot=this.isOverNodeInput(node,e.canvasX,e.canvasY,pos))&&node.inputs[slot]?(slot_type=node.inputs[slot].type,LiteGraph.isValidConnection(this.connecting_output.type,slot_type)&&(this._highlight_input=pos,this._highlight_input_slot=node.inputs[slot])):(this._highlight_input=null,this._highlight_input_slot=null))):this.connecting_input&&(pos=this._highlight_output||[0,0],this.isOverNodeBox(node,e.canvasX,e.canvasY)||(-1!=(slot=this.isOverNodeOutput(node,e.canvasX,e.canvasY,pos))&&node.outputs[slot]?(slot_type=node.outputs[slot].type,LiteGraph.isValidConnection(this.connecting_input.type,slot_type)&&(this._highlight_output=pos)):this._highlight_output=null))),this.canvas&&(isInsideRectangle(e.canvasX,e.canvasY,node.pos[0]+node.size[0]-5,node.pos[1]+node.size[1]-5,5,5)?this.canvas.style.cursor="se-resize":this.canvas.style.cursor="crosshair");else{for(var over_link=null,i=0;i<this.visible_links.length;++i){var link=this.visible_links[i],center=link._pos;if(!(!center||e.canvasX<center[0]-4||e.canvasX>center[0]+4||e.canvasY<center[1]-4||e.canvasY>center[1]+4)){over_link=link;break}}over_link!=this.over_link_center&&(this.over_link_center=over_link,this.dirty_canvas=!0),this.canvas&&(this.canvas.style.cursor="")}if(this.node_capturing_input&&this.node_capturing_input!=node&&this.node_capturing_input.onMouseMove&&this.node_capturing_input.onMouseMove(e,[e.canvasX-this.node_capturing_input.pos[0],e.canvasY-this.node_capturing_input.pos[1]],this),this.node_dragged&&!this.live_mode){for(var i in this.selected_nodes){var n=this.selected_nodes[i];n.pos[0]+=delta[0]/this.ds.scale,n.pos[1]+=delta[1]/this.ds.scale,n.is_selected||this.processNodeSelected(n,e)}this.dirty_canvas=!0,this.dirty_bgcanvas=!0}this.resizing_node&&!this.live_mode&&(mouse=[e.canvasX-this.resizing_node.pos[0],e.canvasY-this.resizing_node.pos[1]],deltay=this.resizing_node.computeSize(),mouse[0]=Math.max(deltay[0],mouse[0]),mouse[1]=Math.max(deltay[1],mouse[1]),this.resizing_node.setSize(mouse),this.canvas.style.cursor="se-resize",this.dirty_canvas=!0,this.dirty_bgcanvas=!0)}}return e.preventDefault(),!1}},LGraphCanvas.prototype.processMouseUp=function(e){var is_primary=void 0===e.isPrimary||e.isPrimary;if(!is_primary)return!1;if(this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),this.graph){var document=this.getCanvasWindow().document,document=((LGraphCanvas.active_canvas=this).options.skip_events||(LiteGraph.pointerListenerRemove(document,"move",this._mousemove_callback,!0),LiteGraph.pointerListenerAdd(this.canvas,"move",this._mousemove_callback,!0),LiteGraph.pointerListenerRemove(document,"up",this._mouseup_callback,!0)),this.adjustMouseEvent(e),LiteGraph.getTime());if(e.click_time=document-this.last_mouseclick,this.last_mouse_dragging=!1,this.last_click_position=null,this.block_click&&(this.block_click=!1),1==e.which){this.node_widget&&this.processNodeWidgets(this.node_widget[0],this.graph_mouse,e),this.node_widget=null,this.selected_group&&(document=this.selected_group.pos[0]-Math.round(this.selected_group.pos[0]),diffy=this.selected_group.pos[1]-Math.round(this.selected_group.pos[1]),this.selected_group.move(document,diffy,e.ctrlKey),this.selected_group.pos[0]=Math.round(this.selected_group.pos[0]),this.selected_group.pos[1]=Math.round(this.selected_group.pos[1]),this.selected_group._nodes.length&&(this.dirty_canvas=!0),this.selected_group=null),this.selected_group_resizing=!1;var slot,document=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes);if(this.dragging_rectangle){if(this.graph){var nodes=this.graph._nodes,node_bounding=new Float32Array(4),diffy=Math.abs(this.dragging_rectangle[2]),h=Math.abs(this.dragging_rectangle[3]),startx=this.dragging_rectangle[2]<0?this.dragging_rectangle[0]-diffy:this.dragging_rectangle[0],starty=this.dragging_rectangle[3]<0?this.dragging_rectangle[1]-h:this.dragging_rectangle[1];if(this.dragging_rectangle[0]=startx,this.dragging_rectangle[1]=starty,this.dragging_rectangle[2]=diffy,this.dragging_rectangle[3]=h,!document||10<diffy&&10<h){for(var to_select=[],i=0;i<nodes.length;++i){var nodeX=nodes[i];nodeX.getBounding(node_bounding),overlapBounding(this.dragging_rectangle,node_bounding)&&to_select.push(nodeX)}to_select.length&&this.selectNodes(to_select,e.shiftKey)}else this.selectNodes([document],e.shiftKey||e.ctrlKey)}this.dragging_rectangle=null}else this.connecting_node?(this.dirty_canvas=!0,this.dirty_bgcanvas=!0,startx=(this.connecting_output||this.connecting_input).type,document?this.connecting_output?-1!=(slot=this.isOverNodeInput(document,e.canvasX,e.canvasY))?this.connecting_node.connect(this.connecting_slot,document,slot):this.connecting_node.connectByType(this.connecting_slot,document,startx):this.connecting_input&&(-1!=(slot=this.isOverNodeOutput(document,e.canvasX,e.canvasY))?document.connect(slot,this.connecting_node,this.connecting_slot):this.connecting_node.connectByTypeOutput(this.connecting_slot,document,startx)):LiteGraph.release_link_on_empty_shows_menu&&(e.shiftKey&&this.allow_searchbox?this.connecting_output?this.showSearchBox(e,{node_from:this.connecting_node,slot_from:this.connecting_output,type_filter_in:this.connecting_output.type}):this.connecting_input&&this.showSearchBox(e,{node_to:this.connecting_node,slot_from:this.connecting_input,type_filter_out:this.connecting_input.type}):this.connecting_output?this.showConnectionMenu({nodeFrom:this.connecting_node,slotFrom:this.connecting_output,e:e}):this.connecting_input&&this.showConnectionMenu({nodeTo:this.connecting_node,slotTo:this.connecting_input,e:e})),this.connecting_output=null,this.connecting_input=null,this.connecting_pos=null,this.connecting_node=null,this.connecting_slot=-1):this.resizing_node?(this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.graph.afterChange(this.resizing_node),this.resizing_node=null):this.node_dragged?((document=this.node_dragged)&&e.click_time<300&&isInsideRectangle(e.canvasX,e.canvasY,document.pos[0],document.pos[1]-LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT)&&document.collapse(),this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.node_dragged.pos[0]=Math.round(this.node_dragged.pos[0]),this.node_dragged.pos[1]=Math.round(this.node_dragged.pos[1]),(this.graph.config.align_to_grid||this.align_to_grid)&&this.node_dragged.alignToGrid(),this.onNodeMoved&&this.onNodeMoved(this.node_dragged),this.graph.afterChange(this.node_dragged),this.node_dragged=null):(!(document=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes))&&e.click_time<300&&this.deselectAllNodes(),this.dirty_canvas=!0,this.dragging_canvas=!1,this.node_over&&this.node_over.onMouseUp&&this.node_over.onMouseUp(e,[e.canvasX-this.node_over.pos[0],e.canvasY-this.node_over.pos[1]],this),this.node_capturing_input&&this.node_capturing_input.onMouseUp&&this.node_capturing_input.onMouseUp(e,[e.canvasX-this.node_capturing_input.pos[0],e.canvasY-this.node_capturing_input.pos[1]]))}else(2==e.which||3==e.which)&&(this.dirty_canvas=!0,this.dragging_canvas=!1);return is_primary&&(this.pointer_is_down=!1,this.pointer_is_double=!1),this.graph.change(),e.stopPropagation(),e.preventDefault(),!1}},LGraphCanvas.prototype.processMouseWheel=function(e){if(this.graph&&this.allow_dragcanvas){var delta=null!=e.wheelDeltaY?e.wheelDeltaY:-60*e.detail,x=(this.adjustMouseEvent(e),e.clientX),y=e.clientY;if(!this.viewport||this.viewport&&x>=this.viewport[0]&&x<this.viewport[0]+this.viewport[2]&&y>=this.viewport[1]&&y<this.viewport[1]+this.viewport[3])return x=this.ds.scale,0<delta?x*=1.1:delta<0&&(x*=1/1.1),this.ds.changeScale(x,[e.clientX,e.clientY]),this.graph.change(),e.preventDefault(),!1}},LGraphCanvas.prototype.isOverNodeBox=function(node,canvasx,canvasy){var title_height=LiteGraph.NODE_TITLE_HEIGHT;return!!isInsideRectangle(canvasx,canvasy,node.pos[0]+2,node.pos[1]+2-title_height,title_height-4,title_height-4)},LGraphCanvas.prototype.isOverNodeInput=function(node,canvasx,canvasy,slot_pos){if(node.inputs)for(var i=0,l=node.inputs.length;i<l;++i){var link_pos=node.getConnectionPos(!0,i);if(node.horizontal?isInsideRectangle(canvasx,canvasy,link_pos[0]-5,link_pos[1]-10,10,20):isInsideRectangle(canvasx,canvasy,link_pos[0]-10,link_pos[1]-5,40,10))return slot_pos&&(slot_pos[0]=link_pos[0],slot_pos[1]=link_pos[1]),i}return-1},LGraphCanvas.prototype.isOverNodeOutput=function(node,canvasx,canvasy,slot_pos){if(node.outputs)for(var i=0,l=node.outputs.length;i<l;++i){var link_pos=node.getConnectionPos(!1,i);if(node.horizontal?isInsideRectangle(canvasx,canvasy,link_pos[0]-5,link_pos[1]-10,10,20):isInsideRectangle(canvasx,canvasy,link_pos[0]-10,link_pos[1]-5,40,10))return slot_pos&&(slot_pos[0]=link_pos[0],slot_pos[1]=link_pos[1]),i}return-1},LGraphCanvas.prototype.processKey=function(e){if(this.graph){var block_default=!1;if("input"!=e.target.localName){if("keydown"==e.type){if(32==e.keyCode&&(block_default=this.dragging_canvas=!0),27==e.keyCode&&(this.node_panel&&this.node_panel.close(),this.options_panel&&this.options_panel.close(),block_default=!0),65==e.keyCode&&e.ctrlKey&&(this.selectNodes(),block_default=!0),67!==e.keyCode||!e.metaKey&&!e.ctrlKey||e.shiftKey||this.selected_nodes&&(this.copyToClipboard(),block_default=!0),86===e.keyCode&&(e.metaKey||e.ctrlKey)&&this.pasteFromClipboard(e.shiftKey),46!=e.keyCode&&8!=e.keyCode||"input"!=e.target.localName&&"textarea"!=e.target.localName&&(this.deleteSelectedNodes(),block_default=!0),this.selected_nodes)for(var i in this.selected_nodes)this.selected_nodes[i].onKeyDown&&this.selected_nodes[i].onKeyDown(e)}else if("keyup"==e.type&&(32==e.keyCode&&(this.dragging_canvas=!1),this.selected_nodes))for(var i in this.selected_nodes)this.selected_nodes[i].onKeyUp&&this.selected_nodes[i].onKeyUp(e);return this.graph.change(),block_default?(e.preventDefault(),e.stopImmediatePropagation(),!1):void 0}}},LGraphCanvas.prototype.copyToClipboard=function(){var clipboard_info={nodes:[],links:[]},index=0,selected_nodes_array=[];for(i in this.selected_nodes)!1!==(node=this.selected_nodes[i]).clonable&&(node._relative_id=index,selected_nodes_array.push(node),index+=1);for(var i=0;i<selected_nodes_array.length;++i){var node=selected_nodes_array[i];if(!1!==node.clonable){var cloned=node.clone();if(cloned){if(clipboard_info.nodes.push(cloned.serialize()),node.inputs&&node.inputs.length)for(var j=0;j<node.inputs.length;++j){var target_node,input=node.inputs[j];input&&null!=input.link&&(input=this.graph.links[input.link])&&(target_node=this.graph.getNodeById(input.origin_id))&&clipboard_info.links.push([target_node._relative_id,input.origin_slot,node._relative_id,input.target_slot,target_node.id])}}else console.warn("node type not found: "+node.type)}}localStorage.setItem("litegrapheditor_clipboard",JSON.stringify(clipboard_info))},LGraphCanvas.prototype.pasteFromClipboard=function(isConnectUnselected=!1){if(LiteGraph.ctrl_shift_v_paste_connect_unselected_outputs||!isConnectUnselected){var data=localStorage.getItem("litegrapheditor_clipboard");if(data){this.graph.beforeChange();for(var clipboard_info=JSON.parse(data),posMin=!1,posMinIndexes=!1,i=0;i<clipboard_info.nodes.length;++i)posMin?(posMin[0]>clipboard_info.nodes[i].pos[0]&&(posMin[0]=clipboard_info.nodes[i].pos[0],posMinIndexes[0]=i),posMin[1]>clipboard_info.nodes[i].pos[1]&&(posMin[1]=clipboard_info.nodes[i].pos[1],posMinIndexes[1]=i)):(posMin=[clipboard_info.nodes[i].pos[0],clipboard_info.nodes[i].pos[1]],posMinIndexes=[i,i]);for(var nodes=[],i=0;i<clipboard_info.nodes.length;++i){var node_data=clipboard_info.nodes[i],node=LiteGraph.createNode(node_data.type);node&&(node.configure(node_data),node.pos[0]+=this.graph_mouse[0]-posMin[0],node.pos[1]+=this.graph_mouse[1]-posMin[1],this.graph.add(node,{doProcessChange:!1}),nodes.push(node))}for(i=0;i<clipboard_info.links.length;++i){var origin_node,link_info=clipboard_info.links[i],origin_node_relative_id=link_info[0],origin_node_relative_id=(null!=origin_node_relative_id?origin_node=nodes[origin_node_relative_id]:LiteGraph.ctrl_shift_v_paste_connect_unselected_outputs&&isConnectUnselected&&(origin_node_relative_id=link_info[4])&&(origin_node=this.graph.getNodeById(origin_node_relative_id)),nodes[link_info[2]]);origin_node&&origin_node_relative_id?origin_node.connect(link_info[1],origin_node_relative_id,link_info[3]):console.warn("Warning, nodes missing on pasting")}this.selectNodes(nodes),this.graph.afterChange()}}},LGraphCanvas.prototype.processDrop=function(e){e.preventDefault(),this.adjustMouseEvent(e);var x=e.clientX,y=e.clientY;if(!this.viewport||this.viewport&&x>=this.viewport[0]&&x<this.viewport[0]+this.viewport[2]&&y>=this.viewport[1]&&y<this.viewport[1]+this.viewport[3]){var x=[e.canvasX,e.canvasY],node=this.graph?this.graph.getNodeOnPos(x[0],x[1]):null;if(node){if(node.onDropFile||node.onDropData){var files=e.dataTransfer.files;if(files&&files.length)for(var i=0;i<files.length;i++){var reader,type,file=e.dataTransfer.files[0],filename=file.name;node.onDropFile&&node.onDropFile(file),node.onDropData&&((reader=new FileReader).onload=function(event){event=event.target.result;node.onDropData(event,filename,file)},"text"==(type=file.type.split("/")[0])||""==type?reader.readAsText(file):"image"==type?reader.readAsDataURL(file):reader.readAsArrayBuffer(file))}}return!(!node.onDropItem||!node.onDropItem(event))||!!this.onDropItem&&this.onDropItem(event)}y=null,(y=this.onDropItem?this.onDropItem(event):y)||this.checkDropItem(e)}},LGraphCanvas.prototype.checkDropItem=function(e){var file,ext;e.dataTransfer.files.length&&(file=e.dataTransfer.files[0],ext=LGraphCanvas.getFileExtension(file.name).toLowerCase(),ext=LiteGraph.node_types_by_file_extension[ext])&&(this.graph.beforeChange(),(ext=LiteGraph.createNode(ext.type)).pos=[e.canvasX,e.canvasY],this.graph.add(ext),ext.onDropFile&&ext.onDropFile(file),this.graph.afterChange())},LGraphCanvas.prototype.processNodeDblClicked=function(n){this.onShowNodePanel?this.onShowNodePanel(n):this.showShowNodePanel(n),this.onNodeDblClicked&&this.onNodeDblClicked(n),this.setDirty(!0)},LGraphCanvas.prototype.processNodeSelected=function(node,e){this.selectNode(node,e&&(e.shiftKey||e.ctrlKey||this.multi_select)),this.onNodeSelected&&this.onNodeSelected(node)},LGraphCanvas.prototype.selectNode=function(node,add_to_current_selection){null==node?this.deselectAllNodes():this.selectNodes([node],add_to_current_selection)},LGraphCanvas.prototype.selectNodes=function(nodes,add_to_current_selection){for(var i in add_to_current_selection||this.deselectAllNodes(),nodes="string"==typeof(nodes=nodes||this.graph._nodes)?[nodes]:nodes){var node=nodes[i];if(node.is_selected)this.deselectNode(node);else{if(!node.is_selected&&node.onSelected&&node.onSelected(),node.is_selected=!0,(this.selected_nodes[node.id]=node).inputs)for(var j=0;j<node.inputs.length;++j)this.highlighted_links[node.inputs[j].link]=!0;if(node.outputs)for(j=0;j<node.outputs.length;++j){var out=node.outputs[j];if(out.links)for(var k=0;k<out.links.length;++k)this.highlighted_links[out.links[k]]=!0}}}this.onSelectionChange&&this.onSelectionChange(this.selected_nodes),this.setDirty(!0)},LGraphCanvas.prototype.deselectNode=function(node){if(node.is_selected){if(node.onDeselected&&node.onDeselected(),node.is_selected=!1,this.onNodeDeselected&&this.onNodeDeselected(node),node.inputs)for(var i=0;i<node.inputs.length;++i)delete this.highlighted_links[node.inputs[i].link];if(node.outputs)for(i=0;i<node.outputs.length;++i){var out=node.outputs[i];if(out.links)for(var j=0;j<out.links.length;++j)delete this.highlighted_links[out.links[j]]}}},LGraphCanvas.prototype.deselectAllNodes=function(){if(this.graph){for(var nodes=this.graph._nodes,i=0,l=nodes.length;i<l;++i){var node=nodes[i];node.is_selected&&(node.onDeselected&&node.onDeselected(),node.is_selected=!1,this.onNodeDeselected)&&this.onNodeDeselected(node)}this.selected_nodes={},this.current_node=null,this.highlighted_links={},this.onSelectionChange&&this.onSelectionChange(this.selected_nodes),this.setDirty(!0)}},LGraphCanvas.prototype.deleteSelectedNodes=function(){for(var i in this.graph.beforeChange(),this.selected_nodes){var input_link,output_link,input_node,output_node,i=this.selected_nodes[i];i.block_delete||(i.inputs&&i.inputs.length&&i.outputs&&i.outputs.length&&LiteGraph.isValidConnection(i.inputs[0].type,i.outputs[0].type)&&i.inputs[0].link&&i.outputs[0].links&&i.outputs[0].links.length&&(input_link=i.graph.links[i.inputs[0].link],output_link=i.graph.links[i.outputs[0].links[0]],input_node=i.getInputNode(0),output_node=i.getOutputNodes(0)[0],input_node)&&output_node&&input_node.connect(input_link.origin_slot,output_node,output_link.target_slot),this.graph.remove(i),this.onNodeDeselected&&this.onNodeDeselected(i))}this.selected_nodes={},this.current_node=null,this.highlighted_links={},this.setDirty(!0),this.graph.afterChange()},LGraphCanvas.prototype.centerOnNode=function(node){this.ds.offset[0]=-node.pos[0]-.5*node.size[0]+.5*this.canvas.width/this.ds.scale,this.ds.offset[1]=-node.pos[1]-.5*node.size[1]+.5*this.canvas.height/this.ds.scale,this.setDirty(!0,!0)},LGraphCanvas.prototype.adjustMouseEvent=function(e){var b,clientX_rel=0,clientY_rel=0;clientY_rel=this.canvas?(b=this.canvas.getBoundingClientRect(),clientX_rel=e.clientX-b.left,e.clientY-b.top):(clientX_rel=e.clientX,e.clientY),this.last_mouse_position[0]=clientX_rel,this.last_mouse_position[1]=clientY_rel,e.canvasX=clientX_rel/this.ds.scale-this.ds.offset[0],e.canvasY=clientY_rel/this.ds.scale-this.ds.offset[1]},LGraphCanvas.prototype.setZoom=function(value,zooming_center){this.ds.changeScale(value,zooming_center),this.dirty_canvas=!0,this.dirty_bgcanvas=!0},LGraphCanvas.prototype.convertOffsetToCanvas=function(pos,out){return this.ds.convertOffsetToCanvas(pos,out)},LGraphCanvas.prototype.convertCanvasToOffset=function(pos,out){return this.ds.convertCanvasToOffset(pos,out)},LGraphCanvas.prototype.convertEventToCanvasOffset=function(e){var rect=this.canvas.getBoundingClientRect();return this.convertCanvasToOffset([e.clientX-rect.left,e.clientY-rect.top])},LGraphCanvas.prototype.bringToFront=function(node){var i=this.graph._nodes.indexOf(node);-1!=i&&(this.graph._nodes.splice(i,1),this.graph._nodes.push(node))},LGraphCanvas.prototype.sendToBack=function(node){var i=this.graph._nodes.indexOf(node);-1!=i&&(this.graph._nodes.splice(i,1),this.graph._nodes.unshift(node))};var temp=new Float32Array(4),temp_vec2=(LGraphCanvas.prototype.computeVisibleNodes=function(nodes,out){for(var visible_nodes=out||[],i=visible_nodes.length=0,l=(nodes=nodes||this.graph._nodes).length;i<l;++i){var n=nodes[i];(!this.live_mode||n.onDrawBackground||n.onDrawForeground)&&overlapBounding(this.visible_area,n.getBounding(temp,!0))&&visible_nodes.push(n)}return visible_nodes},LGraphCanvas.prototype.draw=function(force_canvas,force_bgcanvas){var now;this.canvas&&0!=this.canvas.width&&0!=this.canvas.height&&(now=LiteGraph.getTime(),this.render_time=.001*(now-this.last_draw_time),this.last_draw_time=now,this.graph&&this.ds.computeVisibleArea(this.viewport),(this.dirty_bgcanvas||force_bgcanvas||this.always_render_background||this.graph&&this.graph._last_trigger_time&&now-this.graph._last_trigger_time<1e3)&&this.drawBackCanvas(),(this.dirty_canvas||force_canvas)&&this.drawFrontCanvas(),this.fps=this.render_time?1/this.render_time:0,this.frame+=1)},LGraphCanvas.prototype.drawFrontCanvas=function(){this.dirty_canvas=!1,this.ctx||(this.ctx=this.bgcanvas.getContext("2d"));var ctx=this.ctx;if(ctx){var canvas=this.canvas,area=(ctx.start2D&&!this.viewport&&(ctx.start2D(),ctx.restore(),ctx.setTransform(1,0,0,1,0,0)),this.viewport||this.dirty_area);if(area&&(ctx.save(),ctx.beginPath(),ctx.rect(area[0],area[1],area[2],area[3]),ctx.clip()),this.clear_background&&(area?ctx.clearRect(area[0],area[1],area[2],area[3]):ctx.clearRect(0,0,canvas.width,canvas.height)),this.bgcanvas==this.canvas?this.drawBackCanvas():ctx.drawImage(this.bgcanvas,0,0),this.onRender&&this.onRender(canvas,ctx),this.show_info&&this.renderInfo(ctx,area?area[0]:0,area?area[1]:0),this.graph){ctx.save(),this.ds.toCanvasContext(ctx);for(var connType,connDir,shape,link_color,visible_nodes=this.computeVisibleNodes(null,this.visible_nodes),i=0;i<visible_nodes.length;++i){var node=visible_nodes[i];ctx.save(),ctx.translate(node.pos[0],node.pos[1]),this.drawNode(node,ctx),ctx.restore()}this.render_execution_order&&this.drawExecutionOrder(ctx),!this.graph.config.links_ontop||this.live_mode||this.drawConnections(ctx),null!=this.connecting_pos&&(ctx.lineWidth=this.connections_width,connType=(canvas=this.connecting_output||this.connecting_input).type,(link_color=null)==(connDir=canvas.dir)&&(connDir=this.connecting_output?this.connecting_node.horizontal?LiteGraph.DOWN:LiteGraph.RIGHT:this.connecting_node.horizontal?LiteGraph.UP:LiteGraph.LEFT),canvas=canvas.shape,link_color=connType===LiteGraph.EVENT?LiteGraph.EVENT_LINK_COLOR:LiteGraph.CONNECTING_LINK_COLOR,this.renderLink(ctx,this.connecting_pos,[this.graph_mouse[0],this.graph_mouse[1]],null,!1,null,link_color,connDir,LiteGraph.CENTER),ctx.beginPath(),connType===LiteGraph.EVENT||canvas===LiteGraph.BOX_SHAPE?(ctx.rect(this.connecting_pos[0]-6+.5,this.connecting_pos[1]-5+.5,14,10),ctx.fill(),ctx.beginPath(),ctx.rect(this.graph_mouse[0]-6+.5,this.graph_mouse[1]-5+.5,14,10)):canvas===LiteGraph.ARROW_SHAPE?(ctx.moveTo(this.connecting_pos[0]+8,this.connecting_pos[1]+.5),ctx.lineTo(this.connecting_pos[0]-4,this.connecting_pos[1]+6+.5),ctx.lineTo(this.connecting_pos[0]-4,this.connecting_pos[1]-6+.5),ctx.closePath()):(ctx.arc(this.connecting_pos[0],this.connecting_pos[1],4,0,2*Math.PI),ctx.fill(),ctx.beginPath(),ctx.arc(this.graph_mouse[0],this.graph_mouse[1],4,0,2*Math.PI)),ctx.fill(),ctx.fillStyle="#ffcc00",this._highlight_input&&(ctx.beginPath(),(shape=this._highlight_input_slot.shape)===LiteGraph.ARROW_SHAPE?(ctx.moveTo(this._highlight_input[0]+8,this._highlight_input[1]+.5),ctx.lineTo(this._highlight_input[0]-4,this._highlight_input[1]+6+.5),ctx.lineTo(this._highlight_input[0]-4,this._highlight_input[1]-6+.5),ctx.closePath()):ctx.arc(this._highlight_input[0],this._highlight_input[1],6,0,2*Math.PI),ctx.fill()),this._highlight_output)&&(ctx.beginPath(),shape===LiteGraph.ARROW_SHAPE?(ctx.moveTo(this._highlight_output[0]+8,this._highlight_output[1]+.5),ctx.lineTo(this._highlight_output[0]-4,this._highlight_output[1]+6+.5),ctx.lineTo(this._highlight_output[0]-4,this._highlight_output[1]-6+.5),ctx.closePath()):ctx.arc(this._highlight_output[0],this._highlight_output[1],6,0,2*Math.PI),ctx.fill()),this.dragging_rectangle&&(ctx.strokeStyle="#FFF",ctx.strokeRect(this.dragging_rectangle[0],this.dragging_rectangle[1],this.dragging_rectangle[2],this.dragging_rectangle[3])),this.over_link_center&&this.render_link_tooltip?this.drawLinkTooltip(ctx,this.over_link_center):this.onDrawLinkTooltip&&this.onDrawLinkTooltip(ctx,null),this.onDrawForeground&&this.onDrawForeground(ctx,this.visible_rect),ctx.restore()}this._graph_stack&&this._graph_stack.length&&this.drawSubgraphPanel(ctx),this.onDrawOverlay&&this.onDrawOverlay(ctx),area&&ctx.restore(),ctx.finish2D&&ctx.finish2D()}},LGraphCanvas.prototype.drawSubgraphPanel=function(ctx){var subgraph=this.graph,subnode=subgraph._subgraph_node;subnode?(this.drawSubgraphPanelLeft(subgraph,subnode,ctx),this.drawSubgraphPanelRight(subgraph,subnode,ctx)):console.warn("subgraph without subnode")},LGraphCanvas.prototype.drawSubgraphPanelLeft=function(subgraph,subnode,ctx){var num=subnode.inputs?subnode.inputs.length:0,w=200,h=Math.floor(1.6*LiteGraph.NODE_SLOT_HEIGHT);if(ctx.fillStyle="#111",ctx.globalAlpha=.8,ctx.beginPath(),ctx.roundRect(10,10,w,(num+1)*h+50,[8]),ctx.fill(),ctx.globalAlpha=1,ctx.fillStyle="#888",ctx.font="14px Arial",ctx.textAlign="left",ctx.fillText("Graph Inputs",20,34),this.drawButton(180,20,20,20,"X","#151515"))this.closeSubgraph();else{var y=50;if(ctx.font="14px Arial",subnode.inputs)for(var i=0;i<subnode.inputs.length;++i){var type,newnode,input=subnode.inputs[i];input.not_subgraph_input||(this.drawButton(20,y+2,180,h-2)&&(type=subnode.constructor.input_node_type||"graph/input",this.graph.beforeChange(),(newnode=LiteGraph.createNode(type))?(subgraph.add(newnode),this.block_click=!1,this.last_click_position=null,this.selectNodes([newnode]),this.node_dragged=newnode,this.dragging_canvas=!1,newnode.setProperty("name",input.name),newnode.setProperty("type",input.type),this.node_dragged.pos[0]=this.graph_mouse[0]-5,this.node_dragged.pos[1]=this.graph_mouse[1]-5,this.graph.afterChange()):console.error("graph input node not found:",type)),ctx.fillStyle="#9C9",ctx.beginPath(),ctx.arc(184,y+.5*h,5,0,2*Math.PI),ctx.fill(),ctx.fillStyle="#AAA",ctx.fillText(input.name,30,y+.75*h),ctx.fillStyle="#777",ctx.fillText(input.type,130,y+.75*h),y+=h)}this.drawButton(20,y+2,180,h-2,"+","#151515","#222")&&this.showSubgraphPropertiesDialog(subnode)}},LGraphCanvas.prototype.drawSubgraphPanelRight=function(subgraph,subnode,ctx){var num=subnode.outputs?subnode.outputs.length:0,canvas_w=this.bgcanvas.width,w=200,h=Math.floor(1.6*LiteGraph.NODE_SLOT_HEIGHT),num=(ctx.fillStyle="#111",ctx.globalAlpha=.8,ctx.beginPath(),ctx.roundRect(canvas_w-w-10,10,w,(num+1)*h+50,[8]),ctx.fill(),ctx.globalAlpha=1,ctx.fillStyle="#888",ctx.font="14px Arial",ctx.textAlign="left",ctx.measureText("Graph Outputs").width);if(ctx.fillText("Graph Outputs",canvas_w-num-20,34),this.drawButton(canvas_w-w,20,20,20,"X","#151515"))this.closeSubgraph();else{var y=50;if(ctx.font="14px Arial",subnode.outputs)for(var i=0;i<subnode.outputs.length;++i){var type,newnode,output=subnode.outputs[i];output.not_subgraph_input||(this.drawButton(canvas_w-w,y+2,180,h-2)&&(type=subnode.constructor.output_node_type||"graph/output",this.graph.beforeChange(),(newnode=LiteGraph.createNode(type))?(subgraph.add(newnode),this.block_click=!1,this.last_click_position=null,this.selectNodes([newnode]),this.node_dragged=newnode,this.dragging_canvas=!1,newnode.setProperty("name",output.name),newnode.setProperty("type",output.type),this.node_dragged.pos[0]=this.graph_mouse[0]-5,this.node_dragged.pos[1]=this.graph_mouse[1]-5,this.graph.afterChange()):console.error("graph input node not found:",type)),ctx.fillStyle="#9C9",ctx.beginPath(),ctx.arc(canvas_w-w+16,y+.5*h,5,0,2*Math.PI),ctx.fill(),ctx.fillStyle="#AAA",ctx.fillText(output.name,canvas_w-w+30,y+.75*h),ctx.fillStyle="#777",ctx.fillText(output.type,canvas_w-w+130,y+.75*h),y+=h)}this.drawButton(canvas_w-w,y+2,180,h-2,"+","#151515","#222")&&this.showSubgraphPropertiesDialogRight(subnode)}},LGraphCanvas.prototype.drawButton=function(x,y,w,h,text,bgcolor,hovercolor,textcolor){var ctx=this.ctx,pos=(bgcolor=bgcolor||LiteGraph.NODE_DEFAULT_COLOR,hovercolor=hovercolor||"#555",textcolor=textcolor||LiteGraph.NODE_TEXT_COLOR,this.ds.convertOffsetToCanvas(this.graph_mouse)),hover=LiteGraph.isInsideRectangle(pos[0],pos[1],x,y,w,h),rect=((pos=this.last_click_position?[this.last_click_position[0],this.last_click_position[1]]:null)&&(rect=this.canvas.getBoundingClientRect(),pos[0]-=rect.left,pos[1]-=rect.top),pos&&LiteGraph.isInsideRectangle(pos[0],pos[1],x,y,w,h)),pos=(ctx.fillStyle=hover?hovercolor:bgcolor,rect&&(ctx.fillStyle="#AAA"),ctx.beginPath(),ctx.roundRect(x,y,w,h,[4]),ctx.fill(),null!=text&&text.constructor==String&&(ctx.fillStyle=textcolor,ctx.textAlign="center",ctx.font=(.65*h|0)+"px Arial",ctx.fillText(text,x+.5*w,y+.75*h),ctx.textAlign="left"),rect&&!this.block_click);return rect&&this.blockClick(),pos},LGraphCanvas.prototype.isAreaClicked=function(x,y,w,h,hold_click){var pos=this.last_click_position,pos=pos&&LiteGraph.isInsideRectangle(pos[0],pos[1],x,y,w,h),x=pos&&!this.block_click;return pos&&hold_click&&this.blockClick(),x},LGraphCanvas.prototype.renderInfo=function(ctx,x,y){x=x||10,y=y||this.canvas.height-80,ctx.save(),ctx.translate(x,y),ctx.font="10px Arial",ctx.fillStyle="#888",ctx.textAlign="left",this.graph?(ctx.fillText("T: "+this.graph.globaltime.toFixed(2)+"s",5,13),ctx.fillText("I: "+this.graph.iteration,5,26),ctx.fillText("N: "+this.graph._nodes.length+" ["+this.visible_nodes.length+"]",5,39),ctx.fillText("V: "+this.graph._version,5,52),ctx.fillText("FPS:"+this.fps.toFixed(2),5,65)):ctx.fillText("No graph selected",5,13),ctx.restore()},LGraphCanvas.prototype.drawBackCanvas=function(){var canvas=this.bgcanvas,ctx=(canvas.width==this.canvas.width&&canvas.height==this.canvas.height||(canvas.width=this.canvas.width,canvas.height=this.canvas.height),this.bgctx||(this.bgctx=this.bgcanvas.getContext("2d")),this.bgctx),viewport=(ctx.start&&ctx.start(),this.viewport||[0,0,ctx.canvas.width,ctx.canvas.height]);if(this.clear_background&&ctx.clearRect(viewport[0],viewport[1],viewport[2],viewport[3]),this._graph_stack&&this._graph_stack.length){ctx.save();for(var viewport=this.graph._subgraph_node,title=(ctx.strokeStyle=viewport.bgcolor,ctx.lineWidth=10,ctx.strokeRect(1,1,canvas.width-2,canvas.height-2),ctx.lineWidth=1,ctx.font="40px Arial",ctx.textAlign="center",ctx.fillStyle=viewport.bgcolor||"#AAA",""),i=1;i<this._graph_stack.length;++i)title+=this._graph_stack[i]._subgraph_node.getTitle()+" >> ";ctx.fillText(title+viewport.getTitle(),.5*canvas.width,40),ctx.restore()}var that,viewport=!1;this.onRenderBackground&&(viewport=this.onRenderBackground(canvas,ctx)),this.viewport||(ctx.restore(),ctx.setTransform(1,0,0,1,0,0)),this.visible_links.length=0,this.graph&&(ctx.save(),this.ds.toCanvasContext(ctx),this.ds.scale<1.5&&!viewport&&this.clear_background_color&&(ctx.fillStyle=this.clear_background_color,ctx.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3])),this.background_image&&.5<this.ds.scale&&!viewport&&(this.zoom_modify_alpha?ctx.globalAlpha=(1-.5/this.ds.scale)*this.editor_alpha:ctx.globalAlpha=this.editor_alpha,ctx.imageSmoothingEnabled=ctx.imageSmoothingEnabled=!1,this._bg_img&&this._bg_img.name==this.background_image||(this._bg_img=new Image,this._bg_img.name=this.background_image,this._bg_img.src=this.background_image,(that=this)._bg_img.onload=function(){that.draw(!0,!0)}),(viewport=null)==this._pattern&&0<this._bg_img.width?(viewport=ctx.createPattern(this._bg_img,"repeat"),this._pattern_img=this._bg_img,this._pattern=viewport):viewport=this._pattern,viewport&&(ctx.fillStyle=viewport,ctx.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3]),ctx.fillStyle="transparent"),ctx.globalAlpha=1,ctx.imageSmoothingEnabled=ctx.imageSmoothingEnabled=!0),this.graph._groups.length&&!this.live_mode&&this.drawGroups(canvas,ctx),this.onDrawBackground&&this.onDrawBackground(ctx,this.visible_area),this.onBackgroundRender&&(console.error("WARNING! onBackgroundRender deprecated, now is named onDrawBackground "),this.onBackgroundRender=null),this.render_canvas_border&&(ctx.strokeStyle="#235",ctx.strokeRect(0,0,canvas.width,canvas.height)),this.render_connections_shadows?(ctx.shadowColor="#000",ctx.shadowOffsetX=0,ctx.shadowOffsetY=0,ctx.shadowBlur=6):ctx.shadowColor="rgba(0,0,0,0)",this.live_mode||this.drawConnections(ctx),ctx.shadowColor="rgba(0,0,0,0)",ctx.restore()),ctx.finish&&ctx.finish(),this.dirty_bgcanvas=!1,this.dirty_canvas=!0},new Float32Array(2)),tmp_area=(LGraphCanvas.prototype.drawNode=function(node,ctx){var color=(this.current_node=node).color||node.constructor.color||LiteGraph.NODE_DEFAULT_COLOR,bgcolor=node.bgcolor||node.constructor.bgcolor||LiteGraph.NODE_DEFAULT_BGCOLOR,low_quality=this.ds.scale<.6;if(this.live_mode)node.flags.collapsed||(ctx.shadowColor="transparent",node.onDrawForeground&&node.onDrawForeground(ctx,this,this.canvas));else{var editor_alpha=this.editor_alpha;if(ctx.globalAlpha=editor_alpha,this.render_shadows&&!low_quality?(ctx.shadowColor=LiteGraph.DEFAULT_SHADOW_COLOR,ctx.shadowOffsetX=2*this.ds.scale,ctx.shadowOffsetY=2*this.ds.scale,ctx.shadowBlur=3*this.ds.scale):ctx.shadowColor="transparent",!(node.flags.collapsed&&node.onDrawCollapsed&&node.onDrawCollapsed(ctx,this))){var title,shape=node._shape||LiteGraph.BOX_SHAPE,size=temp_vec2,horizontal=(temp_vec2.set(node.size),node.horizontal),render_text=(node.flags.collapsed&&(ctx.font=this.inner_text_font,null!=(title=node.getTitle?node.getTitle():node.title))&&(node._collapsed_width=Math.min(node.size[0],ctx.measureText(title).width+2*LiteGraph.NODE_TITLE_HEIGHT),size[0]=node._collapsed_width,size[1]=0),node.clip_area&&(ctx.save(),ctx.beginPath(),shape==LiteGraph.BOX_SHAPE?ctx.rect(0,0,size[0],size[1]):shape==LiteGraph.ROUND_SHAPE?ctx.roundRect(0,0,size[0],size[1],[10]):shape==LiteGraph.CIRCLE_SHAPE&&ctx.arc(.5*size[0],.5*size[1],.5*size[0],0,2*Math.PI),ctx.clip()),node.has_errors&&(bgcolor="red"),this.drawNodeShape(node,ctx,size,color,bgcolor,node.is_selected,node.mouseOver),ctx.shadowColor="transparent",node.onDrawForeground&&node.onDrawForeground(ctx,this,this.canvas),ctx.textAlign=horizontal?"center":"left",ctx.font=this.inner_text_font,!low_quality),out_slot=this.connecting_output,in_slot=this.connecting_input,max_y=(ctx.lineWidth=1,0),slot_pos=new Float32Array(2);if(node.flags.collapsed){if(this.render_collapsed_slots){var x,y,input_slot=null,output_slot=null;if(node.inputs)for(i=0;i<node.inputs.length;i++){slot=node.inputs[i];if(null!=slot.link){input_slot=slot;break}}if(node.outputs)for(i=0;i<node.outputs.length;i++)(slot=node.outputs[i]).links&&slot.links.length&&(output_slot=slot);input_slot&&(x=0,y=-.5*LiteGraph.NODE_TITLE_HEIGHT,horizontal&&(x=.5*node._collapsed_width,y=-LiteGraph.NODE_TITLE_HEIGHT),ctx.fillStyle="#686",ctx.beginPath(),slot.type===LiteGraph.EVENT||slot.shape===LiteGraph.BOX_SHAPE?ctx.rect(x-7+.5,y-4,14,8):slot.shape===LiteGraph.ARROW_SHAPE?(ctx.moveTo(x+8,y),ctx.lineTo(x+-4,y-4),ctx.lineTo(x+-4,y+4),ctx.closePath()):ctx.arc(x,y,4,0,2*Math.PI),ctx.fill()),output_slot&&(x=node._collapsed_width,y=-.5*LiteGraph.NODE_TITLE_HEIGHT,horizontal&&(x=.5*node._collapsed_width,y=0),ctx.fillStyle="#686",ctx.strokeStyle="black",ctx.beginPath(),slot.type===LiteGraph.EVENT||slot.shape===LiteGraph.BOX_SHAPE?ctx.rect(x-7+.5,y-4,14,8):slot.shape===LiteGraph.ARROW_SHAPE?(ctx.moveTo(x+6,y),ctx.lineTo(x-6,y-4),ctx.lineTo(x-6,y+4),ctx.closePath()):ctx.arc(x,y,4,0,2*Math.PI),ctx.fill())}}else{if(node.inputs)for(var i=0;i<node.inputs.length;i++){var slot_type=(slot=node.inputs[i]).type,slot_shape=slot.shape;ctx.globalAlpha=editor_alpha,this.connecting_output&&!LiteGraph.isValidConnection(slot.type,out_slot.type)&&(ctx.globalAlpha=.4*editor_alpha),ctx.fillStyle=null!=slot.link?slot.color_on||this.default_connection_color_byType[slot_type]||this.default_connection_color.input_on:slot.color_off||this.default_connection_color_byTypeOff[slot_type]||this.default_connection_color_byType[slot_type]||this.default_connection_color.input_off;(pos=node.getConnectionPos(!0,i,slot_pos))[0]-=node.pos[0],pos[1]-=node.pos[1],max_y<pos[1]+.5*LiteGraph.NODE_SLOT_HEIGHT&&(max_y=pos[1]+.5*LiteGraph.NODE_SLOT_HEIGHT),ctx.beginPath(),"array"==slot_type&&(slot_shape=LiteGraph.GRID_SHAPE);var doStroke=!0;slot.type===LiteGraph.EVENT||slot.shape===LiteGraph.BOX_SHAPE?horizontal?ctx.rect(pos[0]-5+.5,pos[1]-8+.5,10,14):ctx.rect(pos[0]-6+.5,pos[1]-5+.5,14,10):slot_shape===LiteGraph.ARROW_SHAPE?(ctx.moveTo(pos[0]+8,pos[1]+.5),ctx.lineTo(pos[0]-4,pos[1]+6+.5),ctx.lineTo(pos[0]-4,pos[1]-6+.5),ctx.closePath()):slot_shape===LiteGraph.GRID_SHAPE?(ctx.rect(pos[0]-4,pos[1]-4,2,2),ctx.rect(pos[0]-1,pos[1]-4,2,2),ctx.rect(pos[0]+2,pos[1]-4,2,2),ctx.rect(pos[0]-4,pos[1]-1,2,2),ctx.rect(pos[0]-1,pos[1]-1,2,2),ctx.rect(pos[0]+2,pos[1]-1,2,2),ctx.rect(pos[0]-4,pos[1]+2,2,2),ctx.rect(pos[0]-1,pos[1]+2,2,2),ctx.rect(pos[0]+2,pos[1]+2,2,2),doStroke=!1):low_quality?ctx.rect(pos[0]-4,pos[1]-4,8,8):ctx.arc(pos[0],pos[1],4,0,2*Math.PI),ctx.fill(),render_text&&(text=null!=slot.label?slot.label:slot.name)&&(ctx.fillStyle=LiteGraph.NODE_TEXT_COLOR,horizontal||slot.dir==LiteGraph.UP?ctx.fillText(text,pos[0],pos[1]-10):ctx.fillText(text,pos[0]+10,pos[1]+5))}if(ctx.textAlign=horizontal?"center":"right",ctx.strokeStyle="black",node.outputs)for(var i=0;i<node.outputs.length;i++){var slot,slot_type=(slot=node.outputs[i]).type,slot_shape=slot.shape;this.connecting_input&&!LiteGraph.isValidConnection(slot_type,in_slot.type)&&(ctx.globalAlpha=.4*editor_alpha);(pos=node.getConnectionPos(!1,i,slot_pos))[0]-=node.pos[0],pos[1]-=node.pos[1],max_y<pos[1]+.5*LiteGraph.NODE_SLOT_HEIGHT&&(max_y=pos[1]+.5*LiteGraph.NODE_SLOT_HEIGHT),ctx.fillStyle=slot.links&&slot.links.length?slot.color_on||this.default_connection_color_byType[slot_type]||this.default_connection_color.output_on:slot.color_off||this.default_connection_color_byTypeOff[slot_type]||this.default_connection_color_byType[slot_type]||this.default_connection_color.output_off,ctx.beginPath(),"array"==slot_type&&(slot_shape=LiteGraph.GRID_SHAPE);var pos,text,doStroke=!0;slot_type===LiteGraph.EVENT||slot_shape===LiteGraph.BOX_SHAPE?horizontal?ctx.rect(pos[0]-5+.5,pos[1]-8+.5,10,14):ctx.rect(pos[0]-6+.5,pos[1]-5+.5,14,10):slot_shape===LiteGraph.ARROW_SHAPE?(ctx.moveTo(pos[0]+8,pos[1]+.5),ctx.lineTo(pos[0]-4,pos[1]+6+.5),ctx.lineTo(pos[0]-4,pos[1]-6+.5),ctx.closePath()):slot_shape===LiteGraph.GRID_SHAPE?(ctx.rect(pos[0]-4,pos[1]-4,2,2),ctx.rect(pos[0]-1,pos[1]-4,2,2),ctx.rect(pos[0]+2,pos[1]-4,2,2),ctx.rect(pos[0]-4,pos[1]-1,2,2),ctx.rect(pos[0]-1,pos[1]-1,2,2),ctx.rect(pos[0]+2,pos[1]-1,2,2),ctx.rect(pos[0]-4,pos[1]+2,2,2),ctx.rect(pos[0]-1,pos[1]+2,2,2),ctx.rect(pos[0]+2,pos[1]+2,2,2),doStroke=!1):low_quality?ctx.rect(pos[0]-4,pos[1]-4,8,8):ctx.arc(pos[0],pos[1],4,0,2*Math.PI),ctx.fill(),!low_quality&&doStroke&&ctx.stroke(),render_text&&(text=null!=slot.label?slot.label:slot.name)&&(ctx.fillStyle=LiteGraph.NODE_TEXT_COLOR,horizontal||slot.dir==LiteGraph.DOWN?ctx.fillText(text,pos[0],pos[1]-8):ctx.fillText(text,pos[0]-10,pos[1]+5))}ctx.textAlign="left",ctx.globalAlpha=1,node.widgets&&(title=max_y,(horizontal||node.widgets_up)&&(title=2),null!=node.widgets_start_y&&(title=node.widgets_start_y),this.drawNodeWidgets(node,title,ctx,this.node_widget&&this.node_widget[0]==node?this.node_widget[1]:null))}node.clip_area&&ctx.restore(),ctx.globalAlpha=1}}},LGraphCanvas.prototype.drawLinkTooltip=function(ctx,link){var text,pos=link._pos;ctx.fillStyle="black",ctx.beginPath(),ctx.arc(pos[0],pos[1],3,0,2*Math.PI),ctx.fill(),null==link.data||this.onDrawLinkTooltip&&this.onDrawLinkTooltip(ctx,link,this)||(text=null)!=(text=(link=link.data).constructor===Number?link.toFixed(2):link.constructor===String?'"'+link+'"':link.constructor===Boolean?String(link):link.toToolTip?link.toToolTip():"["+link.constructor.name+"]")&&(text=text.substr(0,30),ctx.font="14px Courier New",link=ctx.measureText(text).width+20,ctx.shadowColor="black",ctx.shadowOffsetX=2,ctx.shadowOffsetY=2,ctx.shadowBlur=3,ctx.fillStyle="#454",ctx.beginPath(),ctx.roundRect(pos[0]-.5*link,pos[1]-15-24,link,24,[3]),ctx.moveTo(pos[0]-10,pos[1]-15),ctx.lineTo(pos[0]+10,pos[1]-15),ctx.lineTo(pos[0],pos[1]-5),ctx.fill(),ctx.shadowColor="transparent",ctx.textAlign="center",ctx.fillStyle="#CEC",ctx.fillText(text,pos[0],pos[1]-15-24*.3))},new Float32Array(4)),margin_area=(LGraphCanvas.prototype.drawNodeShape=function(node,ctx,size,fgcolor,bgcolor,selected,mouse_over){ctx.strokeStyle=fgcolor,ctx.fillStyle=bgcolor;var grad,bgcolor=LiteGraph.NODE_TITLE_HEIGHT,low_quality=this.ds.scale<.5,shape=node._shape||node.constructor.shape||LiteGraph.ROUND_SHAPE,title_mode=node.constructor.title_mode,render_title=!0,mouse_over=(title_mode==LiteGraph.TRANSPARENT_TITLE||title_mode==LiteGraph.NO_TITLE?render_title=!1:title_mode==LiteGraph.AUTOHIDE_TITLE&&mouse_over&&(render_title=!0),tmp_area),old_alpha=(mouse_over[0]=0,mouse_over[1]=render_title?-bgcolor:0,mouse_over[2]=size[0]+1,mouse_over[3]=render_title?size[1]+bgcolor:size[1],ctx.globalAlpha);ctx.beginPath(),shape==LiteGraph.BOX_SHAPE||low_quality?ctx.fillRect(mouse_over[0],mouse_over[1],mouse_over[2],mouse_over[3]):shape==LiteGraph.ROUND_SHAPE||shape==LiteGraph.CARD_SHAPE?ctx.roundRect(mouse_over[0],mouse_over[1],mouse_over[2],mouse_over[3],shape==LiteGraph.CARD_SHAPE?[this.round_radius,this.round_radius,0,0]:[this.round_radius]):shape==LiteGraph.CIRCLE_SHAPE&&ctx.arc(.5*size[0],.5*size[1],.5*size[0],0,2*Math.PI),ctx.fill(),!node.flags.collapsed&&render_title&&(ctx.shadowColor="transparent",ctx.fillStyle="rgba(0,0,0,0.2)",ctx.fillRect(0,-1,mouse_over[2],2)),ctx.shadowColor="transparent",node.onDrawBackground&&node.onDrawBackground(ctx,this,this.canvas,this.graph_mouse),(render_title||title_mode==LiteGraph.TRANSPARENT_TITLE)&&(node.onDrawTitleBar?node.onDrawTitleBar(ctx,bgcolor,size,this.ds.scale,fgcolor):title_mode!=LiteGraph.TRANSPARENT_TITLE&&(node.constructor.title_color||this.render_title_colored)&&(render_title=node.constructor.title_color||fgcolor,node.flags.collapsed&&(ctx.shadowColor=LiteGraph.DEFAULT_SHADOW_COLOR),this.use_gradients?((grad=LGraphCanvas.gradients[render_title])||((grad=LGraphCanvas.gradients[render_title]=ctx.createLinearGradient(0,0,400,0)).addColorStop(0,render_title),grad.addColorStop(1,"#000")),ctx.fillStyle=grad):ctx.fillStyle=render_title,ctx.beginPath(),shape==LiteGraph.BOX_SHAPE||low_quality?ctx.rect(0,-bgcolor,size[0]+1,bgcolor):shape!=LiteGraph.ROUND_SHAPE&&shape!=LiteGraph.CARD_SHAPE||ctx.roundRect(0,-bgcolor,size[0]+1,bgcolor,node.flags.collapsed?[this.round_radius]:[this.round_radius,this.round_radius,0,0]),ctx.fill(),ctx.shadowColor="transparent"),grad=!1,LiteGraph.node_box_coloured_by_mode&&LiteGraph.NODE_MODES_COLORS[node.mode]&&(grad=LiteGraph.NODE_MODES_COLORS[node.mode]),LiteGraph.node_box_coloured_when_on&&(grad=node.action_triggered?"#FFF":node.execute_triggered?"#AAA":grad),node.onDrawTitleBox?node.onDrawTitleBox(ctx,bgcolor,size,this.ds.scale):shape==LiteGraph.ROUND_SHAPE||shape==LiteGraph.CIRCLE_SHAPE||shape==LiteGraph.CARD_SHAPE?(low_quality&&(ctx.fillStyle="black",ctx.beginPath(),ctx.arc(.5*bgcolor,-.5*bgcolor,6,0,2*Math.PI),ctx.fill()),ctx.fillStyle=node.boxcolor||grad||LiteGraph.NODE_DEFAULT_BOXCOLOR,low_quality?ctx.fillRect(.5*bgcolor-5,-.5*bgcolor-5,10,10):(ctx.beginPath(),ctx.arc(.5*bgcolor,-.5*bgcolor,5,0,2*Math.PI),ctx.fill())):(low_quality&&(ctx.fillStyle="black",ctx.fillRect(.5*(bgcolor-10)-1,-.5*(bgcolor+10)-1,12,12)),ctx.fillStyle=node.boxcolor||grad||LiteGraph.NODE_DEFAULT_BOXCOLOR,ctx.fillRect(.5*(bgcolor-10),-.5*(bgcolor+10),10,10)),ctx.globalAlpha=old_alpha,node.onDrawTitleText&&node.onDrawTitleText(ctx,bgcolor,size,this.ds.scale,this.title_text_font,selected),!low_quality&&(ctx.font=this.title_text_font,render_title=String(node.getTitle()))&&(ctx.fillStyle=selected?LiteGraph.NODE_SELECTED_TITLE_COLOR:node.constructor.title_text_color||this.node_title_color,node.flags.collapsed?(ctx.textAlign="left",ctx.measureText(render_title),ctx.fillText(render_title.substr(0,20),bgcolor,LiteGraph.NODE_TITLE_TEXT_Y-bgcolor),ctx.textAlign="left"):(ctx.textAlign="left",ctx.fillText(render_title,bgcolor,LiteGraph.NODE_TITLE_TEXT_Y-bgcolor))),node.flags.collapsed||!node.subgraph||node.skip_subgraph_button||(grad=LiteGraph.NODE_TITLE_HEIGHT,old_alpha=node.size[0]-grad,render_title=LiteGraph.isInsideRectangle(this.graph_mouse[0]-node.pos[0],this.graph_mouse[1]-node.pos[1],2+old_alpha,2-grad,grad-4,grad-4),ctx.fillStyle=render_title?"#888":"#555",shape==LiteGraph.BOX_SHAPE||low_quality?ctx.fillRect(2+old_alpha,2-grad,grad-4,grad-4):(ctx.beginPath(),ctx.roundRect(2+old_alpha,2-grad,grad-4,grad-4,[4]),ctx.fill()),ctx.fillStyle="#333",ctx.beginPath(),ctx.moveTo(old_alpha+.2*grad,.6*-grad),ctx.lineTo(old_alpha+.8*grad,.6*-grad),ctx.lineTo(old_alpha+.5*grad,.3*-grad),ctx.fill()),node.onDrawTitle)&&node.onDrawTitle(ctx),selected&&(node.onBounding&&node.onBounding(mouse_over),title_mode==LiteGraph.TRANSPARENT_TITLE&&(mouse_over[1]-=bgcolor,mouse_over[3]+=bgcolor),ctx.lineWidth=1,ctx.globalAlpha=.8,ctx.beginPath(),shape==LiteGraph.BOX_SHAPE?ctx.rect(-6+mouse_over[0],-6+mouse_over[1],12+mouse_over[2],12+mouse_over[3]):shape==LiteGraph.ROUND_SHAPE||shape==LiteGraph.CARD_SHAPE&&node.flags.collapsed?ctx.roundRect(-6+mouse_over[0],-6+mouse_over[1],12+mouse_over[2],12+mouse_over[3],[2*this.round_radius]):shape==LiteGraph.CARD_SHAPE?ctx.roundRect(-6+mouse_over[0],-6+mouse_over[1],12+mouse_over[2],12+mouse_over[3],[2*this.round_radius,2,2*this.round_radius,2]):shape==LiteGraph.CIRCLE_SHAPE&&ctx.arc(.5*size[0],.5*size[1],.5*size[0]+6,0,2*Math.PI),ctx.strokeStyle=LiteGraph.NODE_BOX_OUTLINE_COLOR,ctx.stroke(),ctx.strokeStyle=fgcolor,ctx.globalAlpha=1),0<node.execute_triggered&&node.execute_triggered--,0<node.action_triggered&&node.action_triggered--},new Float32Array(4)),link_bounding=new Float32Array(4),tempA=new Float32Array(2),tempB=new Float32Array(2);function compareObjects(a,b){for(var i in a)if(a[i]!=b[i])return!1;return!0}function distance(a,b){return Math.sqrt((b[0]-a[0])*(b[0]-a[0])+(b[1]-a[1])*(b[1]-a[1]))}function colorToString(c){return"rgba("+Math.round(255*c[0]).toFixed()+","+Math.round(255*c[1]).toFixed()+","+Math.round(255*c[2]).toFixed()+","+(4==c.length?c[3].toFixed(2):"1.0")+")"}function isInsideRectangle(x,y,left,top,width,height){return left<x&&x<left+width&&top<y&&y<top+height}function growBounding(bounding,x,y){x<bounding[0]?bounding[0]=x:x>bounding[2]&&(bounding[2]=x),y<bounding[1]?bounding[1]=y:y>bounding[3]&&(bounding[3]=y)}function isInsideBounding(p,bb){return!(p[0]<bb[0][0]||p[1]<bb[0][1]||p[0]>bb[1][0]||p[1]>bb[1][1])}function overlapBounding(a,b){var A_end_x=a[0]+a[2],A_end_y=a[1]+a[3],B_end_x=b[0]+b[2],B_end_y=b[1]+b[3];return!(a[0]>B_end_x||a[1]>B_end_y||A_end_x<b[0]||A_end_y<b[1])}function hex2num(hex){hex=(hex="#"==hex.charAt(0)?hex.slice(1):hex).toUpperCase();for(var int1,int2,value=new Array(3),k=0,i=0;i<6;i+=2)int1="0123456789ABCDEF".indexOf(hex.charAt(i)),int2="0123456789ABCDEF".indexOf(hex.charAt(i+1)),value[k]=16*int1+int2,k++;return value}function num2hex(triplet){for(var int1,int2,hex="#",i=0;i<3;i++)int1=triplet[i]/16,int2=triplet[i]%16,hex+="0123456789ABCDEF".charAt(int1)+"0123456789ABCDEF".charAt(int2);return hex}function ContextMenu(values,options){options=options||{},this.options=options;var that=this,eventClass=(options.parentMenu&&(options.parentMenu.constructor!==this.constructor?(console.error("parentMenu must be of class ContextMenu, ignoring it"),options.parentMenu=null):(this.parentMenu=options.parentMenu,this.parentMenu.lock=!0,this.parentMenu.current_submenu=this)),null),root=("MouseEvent"!==(eventClass=options.event?options.event.constructor.name:eventClass)&&"CustomEvent"!==eventClass&&"PointerEvent"!==eventClass&&(console.error("Event passed to ContextMenu is not of type MouseEvent or CustomEvent. Ignoring it. ("+eventClass+")"),options.event=null),document.createElement("div"));function on_mouse_wheel(e){var pos=parseInt(root.style.top);return root.style.top=(pos+e.deltaY*options.scroll_speed).toFixed()+"px",e.preventDefault(),!0}root.className="litegraph litecontextmenu litemenubar-panel",options.className&&(root.className+=" "+options.className),root.style.minWidth=100,root.style.minHeight=100,root.style.pointerEvents="none",setTimeout(function(){root.style.pointerEvents="auto"},100),LiteGraph.pointerListenerAdd(root,"up",function(e){return e.preventDefault(),!0},!0),root.addEventListener("contextmenu",function(e){return 2==e.button&&e.preventDefault(),!1},!0),LiteGraph.pointerListenerAdd(root,"down",function(e){if(2==e.button)return that.close(),e.preventDefault(),!0},!0),options.scroll_speed||(options.scroll_speed=.1),root.addEventListener("wheel",on_mouse_wheel,!0),root.addEventListener("mousewheel",on_mouse_wheel,!0),this.root=root,options.title&&((eventClass=document.createElement("div")).className="litemenu-title",eventClass.innerHTML=options.title,root.appendChild(eventClass));for(var i=0;i<values.length;i++){var name=values.constructor==Array?values[i]:i,value=(null!=name&&name.constructor!==String&&(name=void 0===name.content?String(name):name.content),values[i]);this.addItem(name,value,options),0}LiteGraph.pointerListenerAdd(root,"enter",function(e){root.closing_timer&&clearTimeout(root.closing_timer)});var rect,root_rect,eventClass=document,eventClass=(((eventClass=(eventClass=options.event?options.event.target.ownerDocument:eventClass)||document).fullscreenElement||eventClass.body).appendChild(root),options.left||0),top=options.top||0;options.event&&(eventClass=options.event.clientX-10,top=options.event.clientY-10,options.title&&(top-=20),options.parentMenu&&(eventClass=(rect=options.parentMenu.root.getBoundingClientRect()).left+rect.width),rect=document.body.getBoundingClientRect(),root_rect=root.getBoundingClientRect(),0==rect.height&&console.error("document.body height is 0. That is dangerous, set html,body { height: 100%; }"),rect.width&&eventClass>rect.width-root_rect.width-10&&(eventClass=rect.width-root_rect.width-10),rect.height)&&top>rect.height-root_rect.height-10&&(top=rect.height-root_rect.height-10),root.style.left=eventClass+"px",root.style.top=top+"px",options.scale&&(root.style.transform="scale("+options.scale+")")}function CurveEditor(points){this.points=points,this.selected=-1,this.nearest=-1,this.size=null,this.must_update=!0,this.margin=5}LGraphCanvas.prototype.drawConnections=function(ctx){for(var now=LiteGraph.getTime(),visible_area=this.visible_area,nodes=(margin_area[0]=visible_area[0]-20,margin_area[1]=visible_area[1]-20,margin_area[2]=visible_area[2]+40,margin_area[3]=visible_area[3]+40,ctx.lineWidth=this.connections_width,ctx.fillStyle="#AAA",ctx.strokeStyle="#AAA",ctx.globalAlpha=this.editor_alpha,this.graph._nodes),n=0,l=nodes.length;n<l;++n){var node=nodes[n];if(node.inputs&&node.inputs.length)for(var i=0;i<node.inputs.length;++i){var start_node_slotpos,end_node_slotpos,start_node_slot,start_node,end_slot,tmp,input=node.inputs[i];input&&null!=input.link&&(input=input.link,input=this.graph.links[input])&&null!=(start_node=this.graph.getNodeById(input.origin_id))&&(start_node_slotpos=null,start_node_slotpos=-1==(start_node_slot=input.origin_slot)?[start_node.pos[0]+10,start_node.pos[1]+10]:start_node.getConnectionPos(!1,start_node_slot,tempA),end_node_slotpos=node.getConnectionPos(!0,i,tempB),link_bounding[0]=start_node_slotpos[0],link_bounding[1]=start_node_slotpos[1],link_bounding[2]=end_node_slotpos[0]-start_node_slotpos[0],link_bounding[3]=end_node_slotpos[1]-start_node_slotpos[1],link_bounding[2]<0&&(link_bounding[0]+=link_bounding[2],link_bounding[2]=Math.abs(link_bounding[2])),link_bounding[3]<0&&(link_bounding[1]+=link_bounding[3],link_bounding[3]=Math.abs(link_bounding[3])),overlapBounding(link_bounding,margin_area))&&(start_node_slot=start_node.outputs[start_node_slot],end_slot=node.inputs[i],start_node_slot)&&end_slot&&(start_node_slot=start_node_slot.dir||(start_node.horizontal?LiteGraph.DOWN:LiteGraph.RIGHT),start_node=end_slot.dir||(node.horizontal?LiteGraph.UP:LiteGraph.LEFT),this.renderLink(ctx,start_node_slotpos,end_node_slotpos,input,!1,0,null,start_node_slot,start_node),input)&&input._last_time&&now-input._last_time<1e3&&(end_slot=2-.002*(now-input._last_time),tmp=ctx.globalAlpha,ctx.globalAlpha=tmp*end_slot,this.renderLink(ctx,start_node_slotpos,end_node_slotpos,input,!0,end_slot,"white",start_node_slot,start_node),ctx.globalAlpha=tmp)}}ctx.globalAlpha=1},LGraphCanvas.prototype.renderLink=function(ctx,a,b,link,skip_border,flow,color,start_dir,end_dir,num_sublines){link&&this.visible_links.push(link),color=(color=!color&&link?link.color||LGraphCanvas.link_type_colors[link.type]:color)||this.default_link_color,null!=link&&this.highlighted_links[link.id]&&(color="#FFF"),start_dir=start_dir||LiteGraph.RIGHT,end_dir=end_dir||LiteGraph.LEFT;var dist=distance(a,b);this.render_connections_border&&.6<this.ds.scale&&(ctx.lineWidth=this.connections_width+4),ctx.lineJoin="round",1<(num_sublines=num_sublines||1)&&(ctx.lineWidth=.5),ctx.beginPath();for(var i=0;i<num_sublines;i+=1){var offsety=5*(i-.5*(num_sublines-1));if(this.links_render_mode==LiteGraph.SPLINE_LINK){ctx.moveTo(a[0],a[1]+offsety);var start_offset_x=0,start_offset_y=0,end_offset_x=0,end_offset_y=0;switch(start_dir){case LiteGraph.LEFT:start_offset_x=-.25*dist;break;case LiteGraph.RIGHT:start_offset_x=.25*dist;break;case LiteGraph.UP:start_offset_y=-.25*dist;break;case LiteGraph.DOWN:start_offset_y=.25*dist}switch(end_dir){case LiteGraph.LEFT:end_offset_x=-.25*dist;break;case LiteGraph.RIGHT:end_offset_x=.25*dist;break;case LiteGraph.UP:end_offset_y=-.25*dist;break;case LiteGraph.DOWN:end_offset_y=.25*dist}ctx.bezierCurveTo(a[0]+start_offset_x,a[1]+start_offset_y+offsety,b[0]+end_offset_x,b[1]+end_offset_y+offsety,b[0],b[1]+offsety)}else if(this.links_render_mode==LiteGraph.LINEAR_LINK){ctx.moveTo(a[0],a[1]+offsety);start_offset_x=0,start_offset_y=0,end_offset_x=0,end_offset_y=0;switch(start_dir){case LiteGraph.LEFT:start_offset_x=-1;break;case LiteGraph.RIGHT:start_offset_x=1;break;case LiteGraph.UP:start_offset_y=-1;break;case LiteGraph.DOWN:start_offset_y=1}switch(end_dir){case LiteGraph.LEFT:end_offset_x=-1;break;case LiteGraph.RIGHT:end_offset_x=1;break;case LiteGraph.UP:end_offset_y=-1;break;case LiteGraph.DOWN:end_offset_y=1}ctx.lineTo(a[0]+15*start_offset_x,a[1]+15*start_offset_y+offsety),ctx.lineTo(b[0]+15*end_offset_x,b[1]+15*end_offset_y+offsety),ctx.lineTo(b[0],b[1]+offsety)}else{if(this.links_render_mode!=LiteGraph.STRAIGHT_LINK)return;ctx.moveTo(a[0],a[1]);var offsety=a[0],start_y=a[1],end_x=b[0],end_y=b[1];start_dir==LiteGraph.RIGHT?offsety+=10:start_y+=10,end_dir==LiteGraph.LEFT?end_x-=10:end_y-=10,ctx.lineTo(offsety,start_y),ctx.lineTo(.5*(offsety+end_x),start_y),ctx.lineTo(.5*(offsety+end_x),end_y),ctx.lineTo(end_x,end_y),ctx.lineTo(b[0],b[1])}}this.render_connections_border&&.6<this.ds.scale&&!skip_border&&(ctx.strokeStyle="rgba(0,0,0,0.5)",ctx.stroke()),ctx.lineWidth=this.connections_width,ctx.fillStyle=ctx.strokeStyle=color,ctx.stroke();var posC,posD,angleA,angleB,pos=this.computeConnectionPoint(a,b,.5,start_dir,end_dir);if(link&&link._pos&&(link._pos[0]=pos[0],link._pos[1]=pos[1]),.6<=this.ds.scale&&this.highquality_render&&end_dir!=LiteGraph.CENTER&&(this.render_connection_arrows&&(skip_border=this.computeConnectionPoint(a,b,.25,start_dir,end_dir),link=this.computeConnectionPoint(a,b,.26,start_dir,end_dir),posC=this.computeConnectionPoint(a,b,.75,start_dir,end_dir),posD=this.computeConnectionPoint(a,b,.76,start_dir,end_dir),angleB=angleA=0,angleB=this.render_curved_connections?(angleA=-Math.atan2(link[0]-skip_border[0],link[1]-skip_border[1]),-Math.atan2(posD[0]-posC[0],posD[1]-posC[1])):angleA=b[1]>a[1]?0:Math.PI,ctx.save(),ctx.translate(skip_border[0],skip_border[1]),ctx.rotate(angleA),ctx.beginPath(),ctx.moveTo(-5,-3),ctx.lineTo(0,7),ctx.lineTo(5,-3),ctx.fill(),ctx.restore(),ctx.save(),ctx.translate(posC[0],posC[1]),ctx.rotate(angleB),ctx.beginPath(),ctx.moveTo(-5,-3),ctx.lineTo(0,7),ctx.lineTo(5,-3),ctx.fill(),ctx.restore()),ctx.beginPath(),ctx.arc(pos[0],pos[1],5,0,2*Math.PI),ctx.fill()),flow){ctx.fillStyle=color;for(i=0;i<5;++i){var f=(.001*LiteGraph.getTime()+.2*i)%1,pos=this.computeConnectionPoint(a,b,f,start_dir,end_dir);ctx.beginPath(),ctx.arc(pos[0],pos[1],5,0,2*Math.PI),ctx.fill()}}},LGraphCanvas.prototype.computeConnectionPoint=function(a,b,t,start_dir,end_dir){start_dir=start_dir||LiteGraph.RIGHT,end_dir=end_dir||LiteGraph.LEFT;var dist=distance(a,b),p0=a,p1=[a[0],a[1]],p2=[b[0],b[1]],a=b;switch(start_dir){case LiteGraph.LEFT:p1[0]+=-.25*dist;break;case LiteGraph.RIGHT:p1[0]+=.25*dist;break;case LiteGraph.UP:p1[1]+=-.25*dist;break;case LiteGraph.DOWN:p1[1]+=.25*dist}switch(end_dir){case LiteGraph.LEFT:p2[0]+=-.25*dist;break;case LiteGraph.RIGHT:p2[0]+=.25*dist;break;case LiteGraph.UP:p2[1]+=-.25*dist;break;case LiteGraph.DOWN:p2[1]+=.25*dist}b=(1-t)*(1-t)*(1-t),start_dir=(1-t)*(1-t)*3*t,end_dir=3*(1-t)*(t*t),t*=t*t;return[b*p0[0]+start_dir*p1[0]+end_dir*p2[0]+t*a[0],b*p0[1]+start_dir*p1[1]+end_dir*p2[1]+t*a[1]]},LGraphCanvas.prototype.drawExecutionOrder=function(ctx){ctx.shadowColor="transparent",ctx.globalAlpha=.25,ctx.textAlign="center",ctx.strokeStyle="white",ctx.globalAlpha=.75;for(var visible_nodes=this.visible_nodes,i=0;i<visible_nodes.length;++i){var node=visible_nodes[i];ctx.fillStyle="black",ctx.fillRect(node.pos[0]-LiteGraph.NODE_TITLE_HEIGHT,node.pos[1]-LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT),0==node.order&&ctx.strokeRect(node.pos[0]-LiteGraph.NODE_TITLE_HEIGHT+.5,node.pos[1]-LiteGraph.NODE_TITLE_HEIGHT+.5,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT),ctx.fillStyle="#FFF",ctx.fillText(node.order,node.pos[0]+-.5*LiteGraph.NODE_TITLE_HEIGHT,node.pos[1]-6)}ctx.globalAlpha=1},LGraphCanvas.prototype.drawNodeWidgets=function(node,posY,ctx,active_widget){if(!node.widgets||!node.widgets.length)return 0;for(var width=node.size[0],widgets=node.widgets,H=(posY+=2,LiteGraph.NODE_WIDGET_HEIGHT),show_text=.5<this.ds.scale,outline_color=(ctx.save(),ctx.globalAlpha=this.editor_alpha,LiteGraph.WIDGET_OUTLINE_COLOR),background_color=LiteGraph.WIDGET_BGCOLOR,text_color=LiteGraph.WIDGET_TEXT_COLOR,secondary_text_color=LiteGraph.WIDGET_SECONDARY_TEXT_COLOR,i=0;i<widgets.length;++i){var values,w=widgets[i],y=posY,widget_width=(w.y&&(y=w.y),w.last_y=y,ctx.strokeStyle=outline_color,ctx.fillStyle="#222",ctx.textAlign="left",w.disabled&&(ctx.globalAlpha*=.5),w.width||width);switch(w.type){case"button":w.clicked&&(ctx.fillStyle="#AAA",w.clicked=!1,this.dirty_canvas=!0),ctx.fillRect(15,y,widget_width-30,H),show_text&&!w.disabled&&ctx.strokeRect(15,y,widget_width-30,H),show_text&&(ctx.textAlign="center",ctx.fillStyle=text_color,ctx.fillText(w.label||w.name,.5*widget_width,y+.7*H));break;case"toggle":ctx.textAlign="left",ctx.strokeStyle=outline_color,ctx.fillStyle=background_color,ctx.beginPath(),show_text?ctx.roundRect(15,y,widget_width-30,H,[.5*H]):ctx.rect(15,y,widget_width-30,H),ctx.fill(),show_text&&!w.disabled&&ctx.stroke(),ctx.fillStyle=w.value?"#89A":"#333",ctx.beginPath(),ctx.arc(widget_width-30,y+.5*H,.36*H,0,2*Math.PI),ctx.fill(),show_text&&(ctx.fillStyle=secondary_text_color,null!=(label=w.label||w.name)&&ctx.fillText(label,30,y+.7*H),ctx.fillStyle=w.value?text_color:secondary_text_color,ctx.textAlign="right",ctx.fillText(w.value?w.options.on||"true":w.options.off||"false",widget_width-40,y+.7*H));break;case"slider":ctx.fillStyle=background_color,ctx.fillRect(15,y,widget_width-30,H);var label=w.options.max-w.options.min,nvalue=(w.value-w.options.min)/label;1<(nvalue=nvalue<0?0:nvalue)&&(nvalue=1),ctx.fillStyle=w.options.hasOwnProperty("slider_color")?w.options.slider_color:active_widget==w?"#89A":"#678",ctx.fillRect(15,y,nvalue*(widget_width-30),H),show_text&&!w.disabled&&ctx.strokeRect(15,y,widget_width-30,H),w.marker&&(1<(nvalue=(nvalue=(w.marker-w.options.min)/label)<0?0:nvalue)&&(nvalue=1),ctx.fillStyle=w.options.hasOwnProperty("marker_color")?w.options.marker_color:"#AA9",ctx.fillRect(15+nvalue*(widget_width-30),y,2,H)),show_text&&(ctx.textAlign="center",ctx.fillStyle=text_color,ctx.fillText(w.label||w.name+"  "+Number(w.value).toFixed(null!=w.options.precision?w.options.precision:3),.5*widget_width,y+.7*H));break;case"number":case"combo":ctx.textAlign="left",ctx.strokeStyle=outline_color,ctx.fillStyle=background_color,ctx.beginPath(),show_text?ctx.roundRect(15,y,widget_width-30,H,[.5*H]):ctx.rect(15,y,widget_width-30,H),ctx.fill(),show_text&&(w.disabled||ctx.stroke(),ctx.fillStyle=text_color,w.disabled||(ctx.beginPath(),ctx.moveTo(31,y+5),ctx.lineTo(21,y+.5*H),ctx.lineTo(31,y+H-5),ctx.fill(),ctx.beginPath(),ctx.moveTo(widget_width-15-16,y+5),ctx.lineTo(widget_width-15-6,y+.5*H),ctx.lineTo(widget_width-15-16,y+H-5),ctx.fill()),ctx.fillStyle=secondary_text_color,ctx.fillText(w.label||w.name,35,y+.7*H),ctx.fillStyle=text_color,ctx.textAlign="right","number"==w.type?ctx.fillText(Number(w.value).toFixed(void 0!==w.options.precision?w.options.precision:3),widget_width-30-20,y+.7*H):(nvalue=w.value,w.options.values&&(values=(values=w.options.values).constructor===Function?values():values)&&values.constructor!==Array&&(nvalue=values[w.value]),ctx.fillText(nvalue,widget_width-30-20,y+.7*H)));break;case"string":case"text":if(ctx.textAlign="left",ctx.strokeStyle=outline_color,ctx.fillStyle=background_color,ctx.beginPath(),show_text?ctx.roundRect(15,y,widget_width-30,H,[.5*H]):ctx.rect(15,y,widget_width-30,H),ctx.fill(),show_text){w.disabled||ctx.stroke(),ctx.save(),ctx.beginPath(),ctx.rect(15,y,widget_width-30,H),ctx.clip(),ctx.fillStyle=secondary_text_color;const label=w.label||w.name;null!=label&&ctx.fillText(label,30,y+.7*H),ctx.fillStyle=text_color,ctx.textAlign="right",ctx.fillText(String(w.value).substr(0,30),widget_width-30,y+.7*H),ctx.restore()}break;default:w.draw&&w.draw(ctx,node,widget_width,y,H)}posY+=(w.computeSize?w.computeSize(widget_width)[1]:H)+4,ctx.globalAlpha=this.editor_alpha}ctx.restore(),ctx.textAlign="left"},LGraphCanvas.prototype.processNodeWidgets=function(node,pos,event,active_widget){if(node.widgets&&node.widgets.length&&(this.allow_interaction||node.flags.allow_interaction))for(var x=pos[0]-node.pos[0],y=pos[1]-node.pos[1],width=node.size[0],deltaX=event.deltaX||event.deltax||0,that=this,ref_window=this.getCanvasWindow(),i=0;i<node.widgets.length;++i){var w=node.widgets[i];if(w&&!w.disabled){var widget_height=w.computeSize?w.computeSize(width)[1]:LiteGraph.NODE_WIDGET_HEIGHT,widget_width=w.width||width;if(w==active_widget||!(x<6||widget_width-12<x||y<w.last_y||y>w.last_y+widget_height||void 0===w.last_y)){var old_value=w.value;switch(w.type){case"button":event.type===LiteGraph.pointerevents_method+"down"&&(w.callback&&setTimeout(function(){w.callback(w,that,node,pos,event)},20),w.clicked=!0,this.dirty_canvas=!0);break;case"slider":var old_value=w.value,nvalue=LiteGraph.clamp((x-15)/(widget_width-30),0,1);w.options.read_only||(w.value=w.options.min+(w.options.max-w.options.min)*nvalue,old_value!=w.value&&setTimeout(function(){inner_value_change(w,w.value)},20),this.dirty_canvas=!0);break;case"number":case"combo":var old_value=w.value,values,values_list,delta,index,text_values,menu,delta;function inner_clicked(v,option,event){return values!=values_list&&(v=text_values.indexOf(v)),this.value=v,inner_value_change(this,v),!(that.dirty_canvas=!0)}event.type==LiteGraph.pointerevents_method+"move"&&"number"==w.type?(deltaX&&(w.value+=.1*deltaX*(w.options.step||1)),null!=w.options.min&&w.value<w.options.min&&(w.value=w.options.min),null!=w.options.max&&w.value>w.options.max&&(w.value=w.options.max)):event.type==LiteGraph.pointerevents_method+"down"?(values=w.options.values,values&&values.constructor===Function&&(values=w.options.values(w,node)),values_list=null,"number"!=w.type&&(values_list=values.constructor===Array?values:Object.keys(values)),delta=x<40?-1:widget_width-40<x?1:0,"number"==w.type?(w.value+=.1*delta*(w.options.step||1),null!=w.options.min&&w.value<w.options.min&&(w.value=w.options.min),null!=w.options.max&&w.value>w.options.max&&(w.value=w.options.max)):delta?(index=-1,this.last_mouseclick=0,index=values.constructor===Object?values_list.indexOf(String(w.value))+delta:values_list.indexOf(w.value)+delta,index>=values_list.length&&(index=values_list.length-1),index<0&&(index=0),values.constructor===Array?w.value=values[index]:w.value=index):(text_values=values!=values_list?Object.values(values):values,menu=new ContextMenu(text_values,{scale:Math.max(1,this.ds.scale),event:event,className:"dark",callback:inner_clicked.bind(w)},ref_window))):event.type==LiteGraph.pointerevents_method+"up"&&"number"==w.type&&(delta=x<40?-1:widget_width-40<x?1:0,event.click_time<200)&&0==delta&&this.prompt("Value",w.value,function(v){if(/^[0-9+\-*/()\s]+|\d+\.\d+$/.test(v))try{v=eval(v)}catch(e){}this.value=Number(v),inner_value_change(this,this.value)}.bind(w),event),old_value!=w.value&&setTimeout(function(){inner_value_change(this,this.value)}.bind(w),20),this.dirty_canvas=!0;break;case"toggle":event.type==LiteGraph.pointerevents_method+"down"&&(w.value=!w.value,setTimeout(function(){inner_value_change(w,w.value)},20));break;case"string":case"text":event.type==LiteGraph.pointerevents_method+"down"&&this.prompt("Value",w.value,function(v){inner_value_change(this,v)}.bind(w),event,!!w.options&&w.options.multiline);break;default:w.mouse&&(this.dirty_canvas=w.mouse(event,[x,y],node))}return old_value!=w.value&&(node.onWidgetChanged&&node.onWidgetChanged(w.name,w.value,old_value,w),node.graph._version++),w}}}return null;function inner_value_change(widget,value){"number"==widget.type&&(value=Number(value)),widget.value=value,widget.options&&widget.options.property&&void 0!==node.properties[widget.options.property]&&node.setProperty(widget.options.property,value),widget.callback&&widget.callback(widget.value,that,node,pos,event)}},LGraphCanvas.prototype.drawGroups=function(canvas,ctx){if(this.graph){var groups=this.graph._groups;ctx.save(),ctx.globalAlpha=.5*this.editor_alpha;for(var i=0;i<groups.length;++i){var pos,size,group=groups[i];overlapBounding(this.visible_area,group._bounding)&&(ctx.fillStyle=group.color||"#335",ctx.strokeStyle=group.color||"#335",pos=group._pos,size=group._size,ctx.globalAlpha=.25*this.editor_alpha,ctx.beginPath(),ctx.rect(pos[0]+.5,pos[1]+.5,size[0],size[1]),ctx.fill(),ctx.globalAlpha=this.editor_alpha,ctx.stroke(),ctx.beginPath(),ctx.moveTo(pos[0]+size[0],pos[1]+size[1]),ctx.lineTo(pos[0]+size[0]-10,pos[1]+size[1]),ctx.lineTo(pos[0]+size[0],pos[1]+size[1]-10),ctx.fill(),size=group.font_size||LiteGraph.DEFAULT_GROUP_FONT_SIZE,ctx.font=size+"px Arial",ctx.textAlign="left",ctx.fillText(group.title,pos[0]+4,pos[1]+size))}ctx.restore()}},LGraphCanvas.prototype.adjustNodesSize=function(){for(var nodes=this.graph._nodes,i=0;i<nodes.length;++i)nodes[i].size=nodes[i].computeSize();this.setDirty(!0,!0)},LGraphCanvas.prototype.resize=function(width,height){var parent;width||height||(width=(parent=this.canvas.parentNode).offsetWidth,height=parent.offsetHeight),this.canvas.width==width&&this.canvas.height==height||(this.canvas.width=width,this.canvas.height=height,this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height,this.setDirty(!0,!0))},LGraphCanvas.prototype.switchLiveMode=function(transition){var self,delta,t;transition?(delta=(self=this).live_mode?1.1:.9,this.live_mode&&(this.live_mode=!1,this.editor_alpha=.1),t=setInterval(function(){self.editor_alpha*=delta,self.dirty_canvas=!0,self.dirty_bgcanvas=!0,delta<1&&self.editor_alpha<.01&&(clearInterval(t),delta<1)&&(self.live_mode=!0),1<delta&&.99<self.editor_alpha&&(clearInterval(t),self.editor_alpha=1)},1)):(this.live_mode=!this.live_mode,this.dirty_canvas=!0,this.dirty_bgcanvas=!0)},LGraphCanvas.prototype.onNodeSelectionChange=function(node){},LGraphCanvas.onGroupAdd=function(info,entry,mouse_event){var canvas=LGraphCanvas.active_canvas,group=(canvas.getCanvasWindow(),new LGraphGroup);group.pos=canvas.convertEventToCanvasOffset(mouse_event),canvas.graph.add(group)},LGraphCanvas.getBoundaryNodes=function(nodes){let top=null,right=null,bottom=null,left=null;for(const nID in nodes){var node=nodes[nID],[x,y]=node.pos,[width,height]=node.size;(null===top||y<top.pos[1])&&(top=node),(null===right||x+width>right.pos[0]+right.size[0])&&(right=node),(null===bottom||y+height>bottom.pos[1]+bottom.size[1])&&(bottom=node),(null===left||x<left.pos[0])&&(left=node)}return{top:top,right:right,bottom:bottom,left:left}},LGraphCanvas.prototype.boundaryNodesForSelection=function(){return LGraphCanvas.getBoundaryNodes(Object.values(this.selected_nodes))},LGraphCanvas.alignNodes=function(nodes,direction,align_to){if(nodes){var _,node,canvas=LGraphCanvas.active_canvas;let boundaryNodes=[];boundaryNodes=void 0===align_to?LGraphCanvas.getBoundaryNodes(nodes):{top:align_to,right:align_to,bottom:align_to,left:align_to};for([_,node]of Object.entries(canvas.selected_nodes))switch(direction){case"right":node.pos[0]=boundaryNodes.right.pos[0]+boundaryNodes.right.size[0]-node.size[0];break;case"left":node.pos[0]=boundaryNodes.left.pos[0];break;case"top":node.pos[1]=boundaryNodes.top.pos[1];break;case"bottom":node.pos[1]=boundaryNodes.bottom.pos[1]+boundaryNodes.bottom.size[1]-node.size[1]}canvas.dirty_canvas=!0,canvas.dirty_bgcanvas=!0}},LGraphCanvas.onNodeAlign=function(value,options,event,prev_menu,node){new ContextMenu(["Top","Bottom","Left","Right"],{event:event,callback:function(value){LGraphCanvas.alignNodes(LGraphCanvas.active_canvas.selected_nodes,value.toLowerCase(),node)},parentMenu:prev_menu})},LGraphCanvas.onGroupAlign=function(value,options,event,prev_menu){new ContextMenu(["Top","Bottom","Left","Right"],{event:event,callback:function(value){LGraphCanvas.alignNodes(LGraphCanvas.active_canvas.selected_nodes,value.toLowerCase())},parentMenu:prev_menu})},LGraphCanvas.onMenuAdd=function(node,options,e,prev_menu,callback){var canvas=LGraphCanvas.active_canvas,ref_window=canvas.getCanvasWindow(),graph=canvas.graph;if(graph)return function inner_onMenuAdded(base_category,prev_menu){var categories=LiteGraph.getNodeTypesCategories(canvas.filter||graph.filter).filter(function(category){return category.startsWith(base_category)}),entries=[];categories.map(function(category){var category_path,base_category_regex;category&&(base_category_regex=new RegExp("^("+base_category+")"),category=category.replace(base_category_regex,"").split("/")[0],category_path=""===base_category?category+"/":base_category+category+"/",-1!=(base_category_regex=category).indexOf("::")&&(base_category_regex=base_category_regex.split("::")[1]),-1===entries.findIndex(function(entry){return entry.value===category_path}))&&entries.push({value:category_path,content:base_category_regex,has_submenu:!0,callback:function(value,event,mouseEvent,contextMenu){inner_onMenuAdded(value.value,contextMenu)}})}),LiteGraph.getNodeTypesInCategory(base_category.slice(0,-1),canvas.filter||graph.filter).map(function(node){node.skip_list||(node={value:node.type,content:node.title,has_submenu:!1,callback:function(value,event,mouseEvent,contextMenu){contextMenu=contextMenu.getFirstEvent(),canvas.graph.beforeChange(),(value=LiteGraph.createNode(value.value))&&(value.pos=canvas.convertEventToCanvasOffset(contextMenu),canvas.graph.add(value)),callback&&callback(value),canvas.graph.afterChange()}},entries.push(node))}),new ContextMenu(entries,{event:e,parentMenu:prev_menu},ref_window)}("",prev_menu),!1},LGraphCanvas.onMenuCollapseAll=function(){},LGraphCanvas.onMenuNodeEdit=function(){},LGraphCanvas.showMenuNodeOptionalInputs=function(v,options,e,prev_menu,node){if(node){var retEntries,that=this,ref_window=LGraphCanvas.active_canvas.getCanvasWindow(),options=node.optional_inputs,entries=[];if(options=node.onGetInputs?node.onGetInputs():options)for(var i=0;i<options.length;i++){var label,entry=options[i];entry?(label=entry[0],label=(entry[2]||(entry[2]={}),entry[2].label&&(label=entry[2].label),entry[2].removable=!0,{content:label,value:entry}),entry[1]==LiteGraph.ACTION&&(label.className="event"),entries.push(label)):entries.push(null)}if((entries=node.onMenuNodeInputs&&(retEntries=node.onMenuNodeInputs(entries))?retEntries:entries).length)return new ContextMenu(entries,{event:e,callback:function(v,e,prev){node&&(v.callback&&v.callback.call(that,node,v,e,prev),v.value)&&(node.graph.beforeChange(),node.addInput(v.value[0],v.value[1],v.value[2]),node.onNodeInputAdd&&node.onNodeInputAdd(v.value),node.setDirtyCanvas(!0,!0),node.graph.afterChange())},parentMenu:prev_menu,node:node},ref_window),!1;console.log("no input entries")}},LGraphCanvas.showMenuNodeOptionalOutputs=function(v,options,e,prev_menu,node){if(node){var retEntries,that=this,ref_window=LGraphCanvas.active_canvas.getCanvasWindow(),options=node.optional_outputs,entries=[];if(options=node.onGetOutputs?node.onGetOutputs():options)for(var i=0;i<options.length;i++){var label,entry=options[i];entry?node.flags&&node.flags.skip_repeated_outputs&&-1!=node.findOutputSlot(entry[0])||(label=entry[0],entry[2]||(entry[2]={}),entry[2].label&&(label=entry[2].label),entry[2].removable=!0,label={content:label,value:entry},entry[1]==LiteGraph.EVENT&&(label.className="event"),entries.push(label)):entries.push(null)}if(this.onMenuNodeOutputs&&(entries=this.onMenuNodeOutputs(entries)),LiteGraph.do_add_triggers_slots&&-1==node.findOutputSlot("onExecuted")&&entries.push({content:"On Executed",value:["onExecuted",LiteGraph.EVENT,{nameLocked:!0}],className:"event"}),(entries=node.onMenuNodeOutputs&&(retEntries=node.onMenuNodeOutputs(entries))?retEntries:entries).length)return new ContextMenu(entries,{event:e,callback:function inner_clicked(v,e,prev){if(!node)return;v.callback&&v.callback.call(that,node,v,e,prev);if(!v.value)return;var value=v.value[1];{if(value&&(value.constructor===Object||value.constructor===Array)){var i,entries=[];for(i in value)entries.push({content:i,value:value[i]});return new ContextMenu(entries,{event:e,callback:inner_clicked,parentMenu:prev_menu,node:node}),!1}node.graph.beforeChange(),node.addOutput(v.value[0],v.value[1],v.value[2]),node.onNodeOutputAdd&&node.onNodeOutputAdd(v.value),node.setDirtyCanvas(!0,!0),node.graph.afterChange()}},parentMenu:prev_menu,node:node},ref_window),!1}},LGraphCanvas.onShowMenuNodeProperties=function(value,options,e,prev_menu,node){if(node&&node.properties){var i,canvas=LGraphCanvas.active_canvas,ref_window=canvas.getCanvasWindow(),entries=[];for(i in node.properties){"object"==typeof(value=void 0!==node.properties[i]?node.properties[i]:" ")&&(value=JSON.stringify(value));var info=node.getPropertyInfo(i);"enum"!=info.type&&"combo"!=info.type||(value=LGraphCanvas.getPropertyPrintableValue(value,info.values)),value=LGraphCanvas.decodeHTML(value),entries.push({content:"<span class='property_name'>"+(info.label||i)+"</span><span class='property_value'>"+value+"</span>",value:i})}if(entries.length)return new ContextMenu(entries,{event:e,callback:function(v,options,e,prev){var rect;node&&(rect=this.getBoundingClientRect(),canvas.showEditPropertyValue(node,v.value,{position:[rect.left,rect.top]}))},parentMenu:prev_menu,allow_html:!0,node:node},ref_window),!1}},LGraphCanvas.decodeHTML=function(str){var e=document.createElement("div");return e.innerText=str,e.innerHTML},LGraphCanvas.onMenuResizeNode=function(value,options,e,menu,node){if(node){var fApplyMultiNode=node=>{node.size=node.computeSize(),node.onResize&&node.onResize(node.size)},graphcanvas=LGraphCanvas.active_canvas;if(!graphcanvas.selected_nodes||Object.keys(graphcanvas.selected_nodes).length<=1)fApplyMultiNode(node);else for(var i in graphcanvas.selected_nodes)fApplyMultiNode(graphcanvas.selected_nodes[i]);node.setDirtyCanvas(!0,!0)}},LGraphCanvas.prototype.showLinkMenu=function(link,e){var that=this,node_left=that.graph.getNodeById(link.origin_id),node_right=that.graph.getNodeById(link.target_id),fromType=!1,destType=(node_left&&node_left.outputs&&node_left.outputs[link.origin_slot]&&(fromType=node_left.outputs[link.origin_slot].type),!1),menu=(node_right&&node_right.outputs&&node_right.outputs[link.target_slot]&&(destType=node_right.inputs[link.target_slot].type),new ContextMenu(options,{event:e,title:null!=link.data?link.data.constructor.name:null,callback:function(v,options,e){switch(v){case"Add Node":LGraphCanvas.onMenuAdd(null,null,e,menu,function(node){node.inputs&&node.inputs.length&&node.outputs&&node.outputs.length&&node_left.connectByType(link.origin_slot,node,fromType)&&(node.connectByType(link.target_slot,node_right,destType),node.pos[0]-=.5*node.size[0])});break;case"Delete":that.graph.removeLink(link.id)}}}));return!1},LGraphCanvas.prototype.createDefaultNodeForSlot=function(optPass){var optPass=optPass||{},opts=Object.assign({nodeFrom:null,slotFrom:null,nodeTo:null,slotTo:null,position:[],nodeType:null,posAdd:[0,0],posSizeFix:[0,0]},optPass),isFrom=opts.nodeFrom&&null!==opts.slotFrom,optPass=!isFrom&&opts.nodeTo&&null!==opts.slotTo;if(isFrom||optPass)if(opts.nodeType){var nodeX=isFrom?opts.nodeFrom:opts.nodeTo,slotX=isFrom?opts.slotFrom:opts.slotTo,iSlotConn=!1;switch(typeof slotX){case"string":iSlotConn=isFrom?nodeX.findOutputSlot(slotX,!1):nodeX.findInputSlot(slotX,!1),slotX=(isFrom?nodeX.outputs:nodeX.inputs)[slotX];break;case"object":iSlotConn=isFrom?nodeX.findOutputSlot(slotX.name):nodeX.findInputSlot(slotX.name);break;case"number":iSlotConn=slotX,slotX=(isFrom?nodeX.outputs:nodeX.inputs)[slotX];break;default:return console.warn("Cant get slot information "+slotX),!1}!1!==slotX&&!1!==iSlotConn||console.warn("createDefaultNodeForSlot bad slotX "+slotX+" "+iSlotConn);var fromSlotType=slotX.type==LiteGraph.EVENT?"_event_":slotX.type,slotTypesDefault=isFrom?LiteGraph.slot_types_default_out:LiteGraph.slot_types_default_in;if(slotTypesDefault&&slotTypesDefault[fromSlotType]){slotX.link;var nodeNewType=!1;if("object"==typeof slotTypesDefault[fromSlotType]||"array"==typeof slotTypesDefault[fromSlotType]){for(var typeX in slotTypesDefault[fromSlotType])if(opts.nodeType==slotTypesDefault[fromSlotType][typeX]||"AUTO"==opts.nodeType){nodeNewType=slotTypesDefault[fromSlotType][typeX];break}}else opts.nodeType!=slotTypesDefault[fromSlotType]&&"AUTO"!=opts.nodeType||(nodeNewType=slotTypesDefault[fromSlotType]);if(nodeNewType){var nodeNewOpts=!1,newNode=("object"==typeof nodeNewType&&nodeNewType.node&&(nodeNewType=(nodeNewOpts=nodeNewType).node),LiteGraph.createNode(nodeNewType));if(newNode){if(nodeNewOpts){if(nodeNewOpts.properties)for(var i in nodeNewOpts.properties)newNode.addProperty(i,nodeNewOpts.properties[i]);if(nodeNewOpts.inputs)for(var i in newNode.inputs=[],nodeNewOpts.inputs)newNode.addOutput(nodeNewOpts.inputs[i][0],nodeNewOpts.inputs[i][1]);if(nodeNewOpts.outputs)for(var i in newNode.outputs=[],nodeNewOpts.outputs)newNode.addOutput(nodeNewOpts.outputs[i][0],nodeNewOpts.outputs[i][1]);nodeNewOpts.title&&(newNode.title=nodeNewOpts.title),nodeNewOpts.json&&newNode.configure(nodeNewOpts.json)}return this.graph.add(newNode),newNode.pos=[opts.position[0]+opts.posAdd[0]+(opts.posSizeFix[0]?opts.posSizeFix[0]*newNode.size[0]:0),opts.position[1]+opts.posAdd[1]+(opts.posSizeFix[1]?opts.posSizeFix[1]*newNode.size[1]:0)],isFrom?opts.nodeFrom.connectByType(iSlotConn,newNode,fromSlotType):opts.nodeTo.connectByTypeOutput(iSlotConn,newNode,fromSlotType),!0}console.log("failed creating "+nodeNewType)}}}else console.warn("No type to createDefaultNodeForSlot");else console.warn("No data passed to createDefaultNodeForSlot "+opts.nodeFrom+" "+opts.slotFrom+" "+opts.nodeTo+" "+opts.slotTo);return!1},LGraphCanvas.prototype.showConnectionMenu=function(optPass){var optPass=optPass||{},opts=Object.assign({nodeFrom:null,slotFrom:null,nodeTo:null,slotTo:null,e:null},optPass),that=this,isFrom=opts.nodeFrom&&opts.slotFrom,optPass=!isFrom&&opts.nodeTo&&opts.slotTo;if(isFrom||optPass){var nodeX=isFrom?opts.nodeFrom:opts.nodeTo,slotX=isFrom?opts.slotFrom:opts.slotTo,iSlotConn=!1;switch(typeof slotX){case"string":iSlotConn=isFrom?nodeX.findOutputSlot(slotX,!1):nodeX.findInputSlot(slotX,!1),slotX=(isFrom?nodeX.outputs:nodeX.inputs)[slotX];break;case"object":iSlotConn=isFrom?nodeX.findOutputSlot(slotX.name):nodeX.findInputSlot(slotX.name);break;case"number":iSlotConn=slotX,slotX=(isFrom?nodeX.outputs:nodeX.inputs)[slotX];break;default:return console.warn("Cant get slot information "+slotX),!1}var options=["Add Node",null],fromSlotType=(that.allow_searchbox&&(options.push("Search"),options.push(null)),slotX.type==LiteGraph.EVENT?"_event_":slotX.type),slotTypesDefault=isFrom?LiteGraph.slot_types_default_out:LiteGraph.slot_types_default_in;if(slotTypesDefault&&slotTypesDefault[fromSlotType])if("object"==typeof slotTypesDefault[fromSlotType]||"array"==typeof slotTypesDefault[fromSlotType])for(var typeX in slotTypesDefault[fromSlotType])options.push(slotTypesDefault[fromSlotType][typeX]);else options.push(slotTypesDefault[fromSlotType]);var menu=new ContextMenu(options,{event:opts.e,title:(slotX&&""!=slotX.name?slotX.name+(fromSlotType?" | ":""):"")+(slotX&&fromSlotType?fromSlotType:""),callback:function(v,options,e){switch(v){case"Add Node":LGraphCanvas.onMenuAdd(null,null,e,menu,function(node){isFrom?opts.nodeFrom.connectByType(iSlotConn,node,fromSlotType):opts.nodeTo.connectByTypeOutput(iSlotConn,node,fromSlotType)});break;case"Search":isFrom?that.showSearchBox(e,{node_from:opts.nodeFrom,slot_from:slotX,type_filter_in:fromSlotType}):that.showSearchBox(e,{node_to:opts.nodeTo,slot_from:slotX,type_filter_out:fromSlotType});break;default:that.createDefaultNodeForSlot(Object.assign(opts,{position:[opts.e.canvasX,opts.e.canvasY],nodeType:v}))}}})}else console.warn("No data passed to showConnectionMenu");return!1},LGraphCanvas.onShowPropertyEditor=function(item,options,e,menu,node){var property=item.property||"title",value=node[property],dialog=document.createElement("div");dialog.is_modified=!1,dialog.className="graphdialog",dialog.innerHTML="<span class='name'></span><input autofocus type='text' class='value'/><button>OK</button>",dialog.close=function(){dialog.parentNode&&dialog.parentNode.removeChild(dialog)};dialog.querySelector(".name").innerText=property;var input=dialog.querySelector(".value");input&&(input.value=value,input.addEventListener("blur",function(e){this.focus()}),input.addEventListener("keydown",function(e){if(dialog.is_modified=!0,27==e.keyCode)dialog.close();else if(13==e.keyCode)inner();else if(13!=e.keyCode&&"textarea"!=e.target.localName)return;e.preventDefault(),e.stopPropagation()}));var value=LGraphCanvas.active_canvas.canvas,rect=value.getBoundingClientRect(),offsetx=-20,offsety=-20;rect&&(offsetx-=rect.left,offsety-=rect.top),event?(dialog.style.left=event.clientX+offsetx+"px",dialog.style.top=event.clientY+offsety+"px"):(dialog.style.left=.5*value.width+offsetx+"px",dialog.style.top=.5*value.height+offsety+"px");dialog.querySelector("button").addEventListener("click",inner),value.parentNode.appendChild(dialog),input&&input.focus();var dialogCloseTimer=null;function inner(){var value;input&&(value=input.value,"Number"==item.type?value=Number(value):"Boolean"==item.type&&(value=Boolean(value)),node[property]=value,dialog.parentNode&&dialog.parentNode.removeChild(dialog),node.setDirtyCanvas(!0,!0))}dialog.addEventListener("mouseleave",function(e){LiteGraph.dialog_close_on_mouse_leave&&!dialog.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(dialogCloseTimer=setTimeout(dialog.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),dialog.addEventListener("mouseenter",function(e){LiteGraph.dialog_close_on_mouse_leave&&dialogCloseTimer&&clearTimeout(dialogCloseTimer)})},LGraphCanvas.prototype.prompt=function(title,value,callback,event,multiline){var that=this,dialog=(title=title||"",document.createElement("div"));dialog.is_modified=!1,dialog.className="graphdialog rounded",dialog.innerHTML=multiline?"<span class='name'></span> <textarea autofocus class='value'></textarea><button class='rounded'>OK</button>":"<span class='name'></span> <input autofocus type='text' class='value'/><button class='rounded'>OK</button>",dialog.close=function(){that.prompt_box=null,dialog.parentNode&&dialog.parentNode.removeChild(dialog)};var multiline=LGraphCanvas.active_canvas.canvas,dialogCloseTimer=(multiline.parentNode.appendChild(dialog),1<this.ds.scale&&(dialog.style.transform="scale("+this.ds.scale+")"),null),prevent_timeout=!1,selInDia=(LiteGraph.pointerListenerAdd(dialog,"leave",function(e){prevent_timeout||LiteGraph.dialog_close_on_mouse_leave&&!dialog.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(dialogCloseTimer=setTimeout(dialog.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),LiteGraph.pointerListenerAdd(dialog,"enter",function(e){LiteGraph.dialog_close_on_mouse_leave&&dialogCloseTimer&&clearTimeout(dialogCloseTimer)}),dialog.querySelectorAll("select"));selInDia&&selInDia.forEach(function(selIn){selIn.addEventListener("click",function(e){prevent_timeout++}),selIn.addEventListener("blur",function(e){prevent_timeout=0}),selIn.addEventListener("change",function(e){prevent_timeout=-1})}),that.prompt_box&&that.prompt_box.close();(that.prompt_box=dialog).querySelector(".name").innerText=title;var selInDia=dialog.querySelector(".value"),input=(selInDia.value=value,selInDia);input.addEventListener("keydown",function(e){if(dialog.is_modified=!0,27!=e.keyCode){if(13!=e.keyCode||"textarea"==e.target.localName)return;callback&&callback(this.value)}dialog.close(),e.preventDefault(),e.stopPropagation()});dialog.querySelector("button").addEventListener("click",function(e){callback&&callback(input.value),that.setDirty(!0),dialog.close()});title=multiline.getBoundingClientRect(),value=-20,selInDia=-20;return title&&(value-=title.left,selInDia-=title.top),event?(dialog.style.left=event.clientX+value+"px",dialog.style.top=event.clientY+selInDia+"px"):(dialog.style.left=.5*multiline.width+value+"px",dialog.style.top=.5*multiline.height+selInDia+"px"),setTimeout(function(){input.focus()},10),dialog},LGraphCanvas.search_limit=-1,LGraphCanvas.prototype.showSearchBox=function(event,options){var selIn,selOut,prevent_timeout,timeout_close,def_options={slot_from:null,node_from:null,node_to:null,do_type_filter:LiteGraph.search_filter_enabled,type_filter_in:!1,type_filter_out:!1,show_general_if_none_on_typefilter:!0,show_general_after_typefiltered:!0,hide_on_mouse_leave:LiteGraph.search_hide_on_mouse_leave,show_all_if_empty:!0,show_all_on_open:LiteGraph.search_show_all_on_open},that=(options=Object.assign(def_options,options||{}),this),graphcanvas=LGraphCanvas.active_canvas,canvas=graphcanvas.canvas,root_document=canvas.ownerDocument||document,dialog=document.createElement("div"),helper=(dialog.className="litegraph litesearchbox graphdialog rounded",dialog.innerHTML="<span class='name'>Search</span> <input autofocus type='text' class='value rounded'/>",options.do_type_filter&&(dialog.innerHTML+="<select class='slot_in_type_filter'><option value=''></option></select>",dialog.innerHTML+="<select class='slot_out_type_filter'><option value=''></option></select>"),dialog.innerHTML+="<div class='helper'></div>",root_document.fullscreenElement?root_document.fullscreenElement.appendChild(dialog):(root_document.body.appendChild(dialog),root_document.body.style.overflow="hidden"),options.do_type_filter&&(selIn=dialog.querySelector(".slot_in_type_filter"),selOut=dialog.querySelector(".slot_out_type_filter")),dialog.close=function(){that.search_box=null,this.blur(),canvas.focus(),root_document.body.style.overflow="",setTimeout(function(){that.canvas.focus()},20),dialog.parentNode&&dialog.parentNode.removeChild(dialog)},1<this.ds.scale&&(dialog.style.transform="scale("+this.ds.scale+")"),options.hide_on_mouse_leave&&(prevent_timeout=!1,timeout_close=null,LiteGraph.pointerListenerAdd(dialog,"enter",function(e){timeout_close&&(clearTimeout(timeout_close),timeout_close=null)}),LiteGraph.pointerListenerAdd(dialog,"leave",function(e){prevent_timeout||(timeout_close=setTimeout(function(){dialog.close()},500))}),options.do_type_filter)&&(selIn.addEventListener("click",function(e){prevent_timeout++}),selIn.addEventListener("blur",function(e){prevent_timeout=0}),selIn.addEventListener("change",function(e){prevent_timeout=-1}),selOut.addEventListener("click",function(e){prevent_timeout++}),selOut.addEventListener("blur",function(e){prevent_timeout=0}),selOut.addEventListener("change",function(e){prevent_timeout=-1})),that.search_box&&that.search_box.close(),(that.search_box=dialog).querySelector(".helper")),first=null,timeout=null,selected=null,input=dialog.querySelector("input");if(input&&(input.addEventListener("blur",function(e){that.search_box&&this.focus()}),input.addEventListener("keydown",function(e){if(38==e.keyCode)changeSelection(!1);else if(40==e.keyCode)changeSelection(!0);else if(27==e.keyCode)dialog.close();else{if(13!=e.keyCode)return timeout&&clearInterval(timeout),void(timeout=setTimeout(refreshHelper,250));refreshHelper(),selected?select(selected.innerHTML):first?select(first):dialog.close()}return e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),!0})),options.do_type_filter){if(selIn){var nSlots=(aSlots=LiteGraph.slot_types_in).length;options.type_filter_in!=LiteGraph.EVENT&&options.type_filter_in!=LiteGraph.ACTION||(options.type_filter_in="_event_");for(var iK=0;iK<nSlots;iK++)(opt=document.createElement("option")).value=aSlots[iK],opt.innerHTML=aSlots[iK],selIn.appendChild(opt),!1!==options.type_filter_in&&(options.type_filter_in+"").toLowerCase()==(aSlots[iK]+"").toLowerCase()&&(opt.selected=!0);selIn.addEventListener("change",function(){refreshHelper()})}if(selOut){var aSlots,nSlots=(aSlots=LiteGraph.slot_types_out).length;options.type_filter_out!=LiteGraph.EVENT&&options.type_filter_out!=LiteGraph.ACTION||(options.type_filter_out="_event_");for(var opt,iK=0;iK<nSlots;iK++)(opt=document.createElement("option")).value=aSlots[iK],opt.innerHTML=aSlots[iK],selOut.appendChild(opt),!1!==options.type_filter_out&&(options.type_filter_out+"").toLowerCase()==(aSlots[iK]+"").toLowerCase()&&(opt.selected=!0);selOut.addEventListener("change",function(){refreshHelper()})}}var def_options=canvas.getBoundingClientRect(),left=(event?event.clientX:def_options.left+.5*def_options.width)-80,top=(event?event.clientY:def_options.top+.5*def_options.height)-20;function select(name){if(name)if(that.onSearchBoxSelection)that.onSearchBoxSelection(name,event,graphcanvas);else{var extra=LiteGraph.searchbox_extras[name.toLowerCase()],node=(extra&&(name=extra.type),graphcanvas.graph.beforeChange(),LiteGraph.createNode(name));if(node&&(node.pos=graphcanvas.convertEventToCanvasOffset(event),graphcanvas.graph.add(node,!1)),extra&&extra.data){if(extra.data.properties)for(var i in extra.data.properties)node.addProperty(i,extra.data.properties[i]);if(extra.data.inputs)for(var i in node.inputs=[],extra.data.inputs)node.addOutput(extra.data.inputs[i][0],extra.data.inputs[i][1]);if(extra.data.outputs)for(var i in node.outputs=[],extra.data.outputs)node.addOutput(extra.data.outputs[i][0],extra.data.outputs[i][1]);extra.data.title&&(node.title=extra.data.title),extra.data.json&&node.configure(extra.data.json)}if(options.node_from){var iS=!1;switch(typeof options.slot_from){case"string":iS=options.node_from.findOutputSlot(options.slot_from);break;case"object":-1==(iS=options.slot_from.name?options.node_from.findOutputSlot(options.slot_from.name):-1)&&void 0!==options.slot_from.slot_index&&(iS=options.slot_from.slot_index);break;case"number":iS=options.slot_from;break;default:iS=0}void 0!==options.node_from.outputs[iS]&&!1!==iS&&-1<iS&&options.node_from.connectByType(iS,node,options.node_from.outputs[iS].type)}if(options.node_to){iS=!1;switch(typeof options.slot_from){case"string":iS=options.node_to.findInputSlot(options.slot_from);break;case"object":-1==(iS=options.slot_from.name?options.node_to.findInputSlot(options.slot_from.name):-1)&&void 0!==options.slot_from.slot_index&&(iS=options.slot_from.slot_index);break;case"number":iS=options.slot_from;break;default:iS=0}void 0!==options.node_to.inputs[iS]&&!1!==iS&&-1<iS&&options.node_to.connectByTypeOutput(iS,node,options.node_to.inputs[iS].type)}graphcanvas.graph.afterChange()}dialog.close()}function changeSelection(forward){var prev=selected;selected&&selected.classList.remove("selected"),(selected=selected?(selected=forward?selected.nextSibling:selected.previousSibling)||prev:forward?helper.childNodes[0]:helper.childNodes[helper.childNodes.length])&&(selected.classList.add("selected"),selected.scrollIntoView({block:"end",behavior:"smooth"}))}function refreshHelper(){timeout=null;var str=input.value;if(first=null,helper.innerHTML="",str||options.show_all_if_empty)if(that.onSearchBox){var list=that.onSearchBox(helper,str,graphcanvas);if(list)for(var i=0;i<list.length;++i)addResult(list[i])}else{var sIn,sOut,c=0,str=str.toLowerCase(),filter=graphcanvas.filter||graphcanvas.graph.filter;for(i in sOut=options.do_type_filter&&that.search_box?(sIn=that.search_box.querySelector(".slot_in_type_filter"),that.search_box.querySelector(".slot_out_type_filter")):sIn=!1,LiteGraph.searchbox_extras){var extra=LiteGraph.searchbox_extras[i];if(options.show_all_if_empty&&!str||-1!==extra.desc.toLowerCase().indexOf(str)){var ctor=LiteGraph.registered_node_types[extra.type];if((!ctor||ctor.filter==filter)&&inner_test_filter(extra.type)&&(addResult(extra.desc,"searchbox_extra"),-1!==LGraphCanvas.search_limit)&&c++>LGraphCanvas.search_limit)break}}var filtered=null;if(Array.prototype.filter)filtered=Object.keys(LiteGraph.registered_node_types).filter(inner_test_filter);else for(var i in filtered=[],LiteGraph.registered_node_types)inner_test_filter(i)&&filtered.push(i);for(i=0;i<filtered.length&&(addResult(filtered[i]),!(-1!==LGraphCanvas.search_limit&&c++>LGraphCanvas.search_limit));i++);if(options.show_general_after_typefiltered&&(sIn.value||sOut.value)){for(var i in filtered_extra=[],LiteGraph.registered_node_types)inner_test_filter(i,{inTypeOverride:!(!sIn||!sIn.value)&&"*",outTypeOverride:!(!sOut||!sOut.value)&&"*"})&&filtered_extra.push(i);for(i=0;i<filtered_extra.length&&(addResult(filtered_extra[i],"generic_type"),!(-1!==LGraphCanvas.search_limit&&c++>LGraphCanvas.search_limit));i++);}if((sIn.value||sOut.value)&&0==helper.childNodes.length&&options.show_general_if_none_on_typefilter){for(var i in filtered_extra=[],LiteGraph.registered_node_types)inner_test_filter(i,{skipFilter:!0})&&filtered_extra.push(i);for(i=0;i<filtered_extra.length&&(addResult(filtered_extra[i],"not_in_filter"),!(-1!==LGraphCanvas.search_limit&&c++>LGraphCanvas.search_limit));i++);}function inner_test_filter(type,optsIn){var optsIn=optsIn||{},optsIn=Object.assign({skipFilter:!1,inTypeOverride:!1,outTypeOverride:!1},optsIn),ctor=LiteGraph.registered_node_types[type];if(filter&&ctor.filter!=filter)return!1;if((!options.show_all_if_empty||str)&&-1===type.toLowerCase().indexOf(str))return!1;if(options.do_type_filter&&!optsIn.skipFilter){ctor=type,type=sIn.value;if(!1!==optsIn.inTypeOverride&&(type=optsIn.inTypeOverride),sIn&&type&&LiteGraph.registered_slot_in_types[type]&&LiteGraph.registered_slot_in_types[type].nodes){var doesInc=LiteGraph.registered_slot_in_types[type].nodes.includes(ctor);if(!1===doesInc)return!1}type=sOut.value;if(!1!==optsIn.outTypeOverride&&(type=optsIn.outTypeOverride),sOut&&type&&LiteGraph.registered_slot_out_types[type]&&LiteGraph.registered_slot_out_types[type].nodes){doesInc=LiteGraph.registered_slot_out_types[type].nodes.includes(ctor);if(!1===doesInc)return!1}}return!0}}function addResult(type,className){var help=document.createElement("div");first=first||type,help.innerText=type,help.dataset.type=escape(type),help.className="litegraph lite-search-item",className&&(help.className+=" "+className),help.addEventListener("click",function(e){select(unescape(this.dataset.type))}),helper.appendChild(help)}}return dialog.style.left=left+"px",dialog.style.top=top+"px",event.layerY>def_options.height-200&&(helper.style.maxHeight=def_options.height-event.layerY-20+"px"),input.focus(),options.show_all_on_open&&refreshHelper(),dialog},LGraphCanvas.prototype.showEditPropertyValue=function(node,property,options){if(node&&void 0!==node.properties[property]){options=options||{};var info=node.getPropertyInfo(property),type=info.type;let input_html;if("string"==type||"number"==type||"array"==type||"object"==type)input_html="<input autofocus type='text' class='value'/>";else if("enum"!=type&&"combo"!=type||!info.values){if("boolean"!=type&&"toggle"!=type)return void console.warn("unknown type: "+type);input_html="<input autofocus type='checkbox' class='value' "+(node.properties[property]?"checked":"")+"/>"}else{for(var i in input_html="<select autofocus type='text' class='value'>",info.values){var v=i;info.values.constructor===Array&&(v=info.values[i]),input_html+="<option value='"+v+"' "+(v==node.properties[property]?"selected":"")+">"+info.values[i]+"</option>"}input_html+="</select>"}var dialog=this.createDialog("<span class='name'>"+(info.label||property)+"</span>"+input_html+"<button>OK</button>",options),input=!1;return"enum"!=type&&"combo"!=type||!info.values?"boolean"==type||"toggle"==type?(input=dialog.querySelector("input"))&&input.addEventListener("click",function(e){dialog.modified(),setValue(!!input.checked)}):(input=dialog.querySelector("input"))&&(input.addEventListener("blur",function(e){this.focus()}),v=void 0!==node.properties[property]?node.properties[property]:"","string"!==type&&(v=JSON.stringify(v)),input.value=v,input.addEventListener("keydown",function(e){if(27==e.keyCode)dialog.close();else if(13==e.keyCode)inner();else if(13!=e.keyCode)return void dialog.modified();e.preventDefault(),e.stopPropagation()})):(input=dialog.querySelector("select")).addEventListener("change",function(e){dialog.modified(),setValue(e.target.value)}),input&&input.focus(),dialog.querySelector("button").addEventListener("click",inner),dialog;function inner(){setValue(input.value)}function setValue(value){info&&info.values&&info.values.constructor===Object&&null!=info.values[value]&&(value=info.values[value]),"number"==typeof node.properties[property]&&(value=Number(value)),"array"!=type&&"object"!=type||(value=JSON.parse(value)),node.properties[property]=value,node.graph&&node.graph._version++,node.onPropertyChanged&&node.onPropertyChanged(property,value),options.onclose&&options.onclose(),dialog.close(),node.setDirtyCanvas(!0,!0)}}},LGraphCanvas.prototype.createDialog=function(html,options){options=Object.assign({checkForInput:!1,closeOnLeave:!0,closeOnLeave_checkModified:!0},options||{});var dialog=document.createElement("div"),html=(dialog.className="graphdialog",dialog.innerHTML=html,dialog.is_modified=!1,this.canvas.getBoundingClientRect()),offsetx=-20,offsety=-20,dialogCloseTimer=(html&&(offsetx-=html.left,offsety-=html.top),options.position?(offsetx+=options.position[0],offsety+=options.position[1]):options.event?(offsetx+=options.event.clientX,offsety+=options.event.clientY):(offsetx+=.5*this.canvas.width,offsety+=.5*this.canvas.height),dialog.style.left=offsetx+"px",dialog.style.top=offsety+"px",this.canvas.parentNode.appendChild(dialog),options.checkForInput&&(html=[],html=dialog.querySelectorAll("input"))&&html.forEach(function(iX){iX.addEventListener("keydown",function(e){if(dialog.modified(),27==e.keyCode)dialog.close();else if(13!=e.keyCode)return;e.preventDefault(),e.stopPropagation()}),iX.focus()}),dialog.modified=function(){dialog.is_modified=!0},dialog.close=function(){dialog.parentNode&&dialog.parentNode.removeChild(dialog)},null),prevent_timeout=!1,offsetx=(dialog.addEventListener("mouseleave",function(e){prevent_timeout||(options.closeOnLeave||LiteGraph.dialog_close_on_mouse_leave)&&!dialog.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(dialogCloseTimer=setTimeout(dialog.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),dialog.addEventListener("mouseenter",function(e){(options.closeOnLeave||LiteGraph.dialog_close_on_mouse_leave)&&dialogCloseTimer&&clearTimeout(dialogCloseTimer)}),dialog.querySelectorAll("select"));return offsetx&&offsetx.forEach(function(selIn){selIn.addEventListener("click",function(e){prevent_timeout++}),selIn.addEventListener("blur",function(e){prevent_timeout=0}),selIn.addEventListener("change",function(e){prevent_timeout=-1})}),dialog},LGraphCanvas.prototype.createPanel=function(title,options){var ref_window=(options=options||{}).window||window,root=document.createElement("div");return root.className="litegraph dialog",root.innerHTML="<div class='dialog-header'><span class='dialog-title'></span></div><div class='dialog-content'></div><div style='display:none;' class='dialog-alt-content'></div><div class='dialog-footer'></div>",root.header=root.querySelector(".dialog-header"),options.width&&(root.style.width=options.width+(options.width.constructor===Number?"px":"")),options.height&&(root.style.height=options.height+(options.height.constructor===Number?"px":"")),options.closable&&((options=document.createElement("span")).innerHTML="&#10005;",options.classList.add("close"),options.addEventListener("click",function(){root.close()}),root.header.appendChild(options)),root.title_element=root.querySelector(".dialog-title"),root.title_element.innerText=title,root.content=root.querySelector(".dialog-content"),root.alt_content=root.querySelector(".dialog-alt-content"),root.footer=root.querySelector(".dialog-footer"),root.close=function(){root.onClose&&"function"==typeof root.onClose&&root.onClose(),root.parentNode&&root.parentNode.removeChild(root),this.parentNode&&this.parentNode.removeChild(this)},root.toggleAltContent=function(force){var vTo;force=void 0!==force?(vTo=force?"block":"none",force?"none":"block"):(vTo="block"!=root.alt_content.style.display?"block":"none","block"!=root.alt_content.style.display?"none":"block"),root.alt_content.style.display=vTo,root.content.style.display=force},root.toggleFooterVisibility=function(force){force=void 0!==force?force?"block":"none":"block"!=root.footer.style.display?"block":"none",root.footer.style.display=force},root.clear=function(){this.content.innerHTML=""},root.addHTML=function(code,classname,on_footer){var elem=document.createElement("div");return classname&&(elem.className=classname),elem.innerHTML=code,(on_footer?root.footer:root.content).appendChild(elem),elem},root.addButton=function(name,callback,options){var elem=document.createElement("button");return elem.innerText=name,elem.options=options,elem.classList.add("btn"),elem.addEventListener("click",callback),root.footer.appendChild(elem),elem},root.addSeparator=function(){var elem=document.createElement("div");elem.className="separator",root.content.appendChild(elem)},root.addWidget=function(type,name,value,options,callback){options=options||{};var str_value=String(value),elem=("number"==(type=type.toLowerCase())&&(str_value=value.toFixed(3)),document.createElement("div")),value_element=(elem.className="property",elem.innerHTML="<span class='property_name'></span><span class='property_value'></span>",elem.querySelector(".property_name").innerText=options.label||name,elem.querySelector(".property_value"));function innerChange(name,value){options.callback&&options.callback(name,value,options),callback&&callback(name,value,options)}return value_element.innerText=str_value,elem.dataset.property=name,elem.dataset.type=options.type||type,elem.options=options,elem.value=value,"code"==type?elem.addEventListener("click",function(e){root.inner_showCodePad(this.dataset.property)}):"boolean"==type?(elem.classList.add("boolean"),value&&elem.classList.add("bool-on"),elem.addEventListener("click",function(){var propname=this.dataset.property;this.value=!this.value,this.classList.toggle("bool-on"),this.querySelector(".property_value").innerText=this.value?"true":"false",innerChange(propname,this.value)})):"string"==type||"number"==type?(value_element.setAttribute("contenteditable",!0),value_element.addEventListener("keydown",function(e){"Enter"!=e.code||"string"==type&&e.shiftKey||(e.preventDefault(),this.blur())}),value_element.addEventListener("blur",function(){var v=this.innerText;innerChange(this.parentNode.dataset.property,v="number"==this.parentNode.dataset.type?Number(v):v)})):"enum"!=type&&"combo"!=type||(str_value=LGraphCanvas.getPropertyPrintableValue(value,options.values),value_element.innerText=str_value,value_element.addEventListener("click",function(event){var values=options.values||[],propname=this.parentNode.dataset.property,elem_that=this;new ContextMenu(values,{event:event,className:"dark",callback:function(v,option,event){return elem_that.innerText=v,innerChange(propname,v),!1}},ref_window)})),root.content.appendChild(elem),elem},root.onOpen&&"function"==typeof root.onOpen&&root.onOpen(),root},LGraphCanvas.getPropertyPrintableValue=function(value,values){if(!values)return String(value);if(values.constructor===Array)return String(value);if(values.constructor===Object){var k,desc_value="";for(k in values)if(values[k]==value){desc_value=k;break}return String(value)+" ("+desc_value+")"}},LGraphCanvas.prototype.closePanels=function(){var panel=document.querySelector("#node-panel");panel&&panel.close(),(panel=document.querySelector("#option-panel"))&&panel.close()},LGraphCanvas.prototype.showShowGraphOptionsPanel=function(refOpts,obEv,refMenu,refMenu2){if(this.constructor&&"HTMLDivElement"==this.constructor.name){if(!(obEv&&obEv.event&&obEv.event.target&&obEv.event.target.lgraphcanvas))return void console.warn("Canvas not found");var graphcanvas=obEv.event.target.lgraphcanvas}else graphcanvas=this;graphcanvas.closePanels();obEv=graphcanvas.getCanvasWindow();panel=graphcanvas.createPanel("Options",{closable:!0,window:obEv,onOpen:function(){graphcanvas.OPTIONPANEL_IS_OPEN=!0},onClose:function(){graphcanvas.OPTIONPANEL_IS_OPEN=!1,graphcanvas.options_panel=null}}),(graphcanvas.options_panel=panel).id="option-panel",panel.classList.add("settings"),panel.content.innerHTML="";var pI,fUpdate=(name,value,options)=>{options&&options.key&&(name=options.key),options.values&&(value=Object.values(options.values).indexOf(value)),graphcanvas[name]=value},aProps=LiteGraph.availableCanvasOptions;for(pI in aProps.sort(),aProps){var pX=aProps[pI];panel.addWidget("boolean",pX,graphcanvas[pX],{key:pX,on:"True",off:"False"},fUpdate)}panel.addWidget("combo","Render mode",LiteGraph.LINK_RENDER_MODES[graphcanvas.links_render_mode],{key:"links_render_mode",values:LiteGraph.LINK_RENDER_MODES},fUpdate),panel.addSeparator(),panel.footer.innerHTML="",graphcanvas.canvas.parentNode.appendChild(panel)},LGraphCanvas.prototype.showShowNodePanel=function(node){this.SELECTED_NODE=node,this.closePanels();var ref_window=this.getCanvasWindow(),graphcanvas=this,panel=this.createPanel(node.title||"",{closable:!0,window:ref_window,onOpen:function(){graphcanvas.NODEPANEL_IS_OPEN=!0},onClose:function(){graphcanvas.NODEPANEL_IS_OPEN=!1,graphcanvas.node_panel=null}});function inner_refresh(){panel.content.innerHTML="",panel.addHTML("<span class='node_type'>"+node.type+"</span><span class='node_desc'>"+(node.constructor.desc||"")+"</span><span class='separator'></span>"),panel.addHTML("<h3>Properties</h3>");var pName,fUpdate=(name,value)=>{switch(graphcanvas.graph.beforeChange(node),name){case"Title":node.title=value;break;case"Mode":var kV=Object.values(LiteGraph.NODE_MODES).indexOf(value);0<=kV&&LiteGraph.NODE_MODES[kV]?node.changeMode(kV):console.warn("unexpected mode: "+value);break;case"Color":LGraphCanvas.node_colors[value]?(node.color=LGraphCanvas.node_colors[value].color,node.bgcolor=LGraphCanvas.node_colors[value].bgcolor):console.warn("unexpected color: "+value);break;default:node.setProperty(name,value)}graphcanvas.graph.afterChange(),graphcanvas.dirty_canvas=!0},nodeCol=(panel.addWidget("string","Title",node.title,{},fUpdate),panel.addWidget("combo","Mode",LiteGraph.NODE_MODES[node.mode],{values:LiteGraph.NODE_MODES},fUpdate),"");for(pName in void 0!==node.color&&(nodeCol=Object.keys(LGraphCanvas.node_colors).filter(function(nK){return LGraphCanvas.node_colors[nK].color==node.color})),panel.addWidget("combo","Color",nodeCol,{values:Object.keys(LGraphCanvas.node_colors)},fUpdate),node.properties){var value=node.properties[pName],info=node.getPropertyInfo(pName);node.onAddPropertyToPanel&&node.onAddPropertyToPanel(pName,panel)||panel.addWidget(info.widget||info.type,pName,value,info,fUpdate)}panel.addSeparator(),node.onShowCustomPanelInfo&&node.onShowCustomPanelInfo(panel),panel.footer.innerHTML="",panel.addButton("Delete",function(){node.block_delete||(node.graph.remove(node),panel.close())}).classList.add("delete")}(graphcanvas.node_panel=panel).id="node-panel",panel.node=node,panel.classList.add("settings"),panel.inner_showCodePad=function(propname){panel.classList.remove("settings"),panel.classList.add("centered"),panel.alt_content.innerHTML="<textarea class='code'></textarea>";var textarea=panel.alt_content.querySelector("textarea"),assign=(fDoneWith=()=>{panel.toggleAltContent(!1),panel.toggleFooterVisibility(!0),textarea.parentNode.removeChild(textarea),panel.classList.add("settings"),panel.classList.remove("centered"),inner_refresh()},textarea.value=node.properties[propname],textarea.addEventListener("keydown",function(e){"Enter"==e.code&&e.ctrlKey&&(node.setProperty(propname,textarea.value),fDoneWith())}),panel.toggleAltContent(!0),panel.toggleFooterVisibility(!1),textarea.style.height="calc(100% - 40px)",panel.addButton("Assign",function(){node.setProperty(propname,textarea.value),fDoneWith()})),assign=(panel.alt_content.appendChild(assign),panel.addButton("Close",fDoneWith));assign.style.float="right",panel.alt_content.appendChild(assign)},inner_refresh(),this.canvas.parentNode.appendChild(panel)},LGraphCanvas.prototype.showSubgraphPropertiesDialog=function(node){console.log("showing subgraph properties dialog");var old_panel=this.canvas.parentNode.querySelector(".subgraph_dialog"),panel=(old_panel&&old_panel.close(),this.createPanel("Subgraph Inputs",{closable:!0,width:500}));function inner_refresh(){if(panel.clear(),node.inputs)for(var i=0;i<node.inputs.length;++i){var elem,input=node.inputs[i];input.not_subgraph_input||((elem=panel.addHTML("<button>&#10005;</button> <span class='bullet_icon'></span><span class='name'></span><span class='type'></span>","subgraph_property")).dataset.name=input.name,elem.dataset.slot=i,elem.querySelector(".name").innerText=input.name,elem.querySelector(".type").innerText=input.type,elem.querySelector("button").addEventListener("click",function(e){node.removeInput(Number(this.parentNode.dataset.slot)),inner_refresh()}))}}panel.node=node,panel.classList.add("subgraph_dialog");return panel.addHTML(" + <span class='label'>Name</span><input class='name'/><span class='label'>Type</span><input class='type'></input><button>+</button>","subgraph_property extra",!0).querySelector("button").addEventListener("click",function(e){var elem=this.parentNode,name=elem.querySelector(".name").value,type=elem.querySelector(".type").value;name&&-1==node.findInputSlot(name)&&(node.addInput(name,type),elem.querySelector(".name").value="",elem.querySelector(".type").value="",inner_refresh())}),inner_refresh(),this.canvas.parentNode.appendChild(panel),panel},LGraphCanvas.prototype.showSubgraphPropertiesDialogRight=function(node){var old_panel=this.canvas.parentNode.querySelector(".subgraph_dialog"),panel=(old_panel&&old_panel.close(),this.createPanel("Subgraph Outputs",{closable:!0,width:500}));function inner_refresh(){if(panel.clear(),node.outputs)for(var i=0;i<node.outputs.length;++i){var elem,input=node.outputs[i];input.not_subgraph_output||((elem=panel.addHTML("<button>&#10005;</button> <span class='bullet_icon'></span><span class='name'></span><span class='type'></span>","subgraph_property")).dataset.name=input.name,elem.dataset.slot=i,elem.querySelector(".name").innerText=input.name,elem.querySelector(".type").innerText=input.type,elem.querySelector("button").addEventListener("click",function(e){node.removeOutput(Number(this.parentNode.dataset.slot)),inner_refresh()}))}}panel.node=node,panel.classList.add("subgraph_dialog");old_panel=panel.addHTML(" + <span class='label'>Name</span><input class='name'/><span class='label'>Type</span><input class='type'></input><button>+</button>","subgraph_property extra",!0);function addOutput(){var elem=this.parentNode,name=elem.querySelector(".name").value,type=elem.querySelector(".type").value;name&&-1==node.findOutputSlot(name)&&(node.addOutput(name,type),elem.querySelector(".name").value="",elem.querySelector(".type").value="",inner_refresh())}return old_panel.querySelector(".name").addEventListener("keydown",function(e){13==e.keyCode&&addOutput.apply(this)}),old_panel.querySelector("button").addEventListener("click",function(e){addOutput.apply(this)}),inner_refresh(),this.canvas.parentNode.appendChild(panel),panel},LGraphCanvas.prototype.checkPanels=function(){if(this.canvas)for(var panels=this.canvas.parentNode.querySelectorAll(".litegraph.dialog"),i=0;i<panels.length;++i){var panel=panels[i];!panel.node||panel.node.graph&&panel.graph==this.graph||panel.close()}},LGraphCanvas.onMenuNodeCollapse=function(value,options,e,menu,node){node.graph.beforeChange();var graphcanvas=LGraphCanvas.active_canvas;if(!graphcanvas.selected_nodes||Object.keys(graphcanvas.selected_nodes).length<=1)node.collapse();else for(var i in graphcanvas.selected_nodes)graphcanvas.selected_nodes[i].collapse();node.graph.afterChange()},LGraphCanvas.onMenuNodePin=function(value,options,e,menu,node){node.pin()},LGraphCanvas.onMenuNodeMode=function(value,options,e,menu,node){return new ContextMenu(LiteGraph.NODE_MODES,{event:e,callback:function(v){if(node){var kV=Object.values(LiteGraph.NODE_MODES).indexOf(v),graphcanvas=(fApplyMultiNode=node=>{0<=kV&&LiteGraph.NODE_MODES[kV]?node.changeMode(kV):(console.warn("unexpected mode: "+v),node.changeMode(LiteGraph.ALWAYS))},LGraphCanvas.active_canvas);if(!graphcanvas.selected_nodes||Object.keys(graphcanvas.selected_nodes).length<=1)fApplyMultiNode(node);else for(var i in graphcanvas.selected_nodes)fApplyMultiNode(graphcanvas.selected_nodes[i])}},parentMenu:menu,node:node}),!1},LGraphCanvas.onMenuNodeColors=function(value,options,e,menu,node){if(!node)throw"no node for color";var i,values=[];for(i in values.push({value:null,content:"<span style='display: block; padding-left: 4px;'>No color</span>"}),LGraphCanvas.node_colors){var color=LGraphCanvas.node_colors[i],value={value:i,content:"<span style='display: block; color: #999; padding-left: 4px; border-left: 8px solid "+color.color+"; background-color:"+color.bgcolor+"'>"+i+"</span>"};values.push(value)}return new ContextMenu(values,{event:e,callback:function(v){if(node){var color=v.value?LGraphCanvas.node_colors[v.value]:null,fApplyColor=node=>{color?node.constructor===LGraphGroup?node.color=color.groupcolor:(node.color=color.color,node.bgcolor=color.bgcolor):(delete node.color,delete node.bgcolor)},graphcanvas=LGraphCanvas.active_canvas;if(!graphcanvas.selected_nodes||Object.keys(graphcanvas.selected_nodes).length<=1)fApplyColor(node);else for(var i in graphcanvas.selected_nodes)fApplyColor(graphcanvas.selected_nodes[i]);node.setDirtyCanvas(!0,!0)}},parentMenu:menu,node:node}),!1},LGraphCanvas.onMenuNodeShapes=function(value,options,e,menu,node){if(node)return new ContextMenu(LiteGraph.VALID_SHAPES,{event:e,callback:function(v){if(node){node.graph.beforeChange();var fApplyMultiNode=node=>{node.shape=v},graphcanvas=LGraphCanvas.active_canvas;if(!graphcanvas.selected_nodes||Object.keys(graphcanvas.selected_nodes).length<=1)fApplyMultiNode(node);else for(var i in graphcanvas.selected_nodes)fApplyMultiNode(graphcanvas.selected_nodes[i]);node.graph.afterChange(),node.setDirtyCanvas(!0)}},parentMenu:menu,node:node}),!1;throw"no node passed"},LGraphCanvas.onMenuNodeRemove=function(value,options,e,menu,node){if(!node)throw"no node passed";var graph=node.graph,fApplyMultiNode=(graph.beforeChange(),node=>{!1!==node.removable&&graph.remove(node)}),graphcanvas=LGraphCanvas.active_canvas;if(!graphcanvas.selected_nodes||Object.keys(graphcanvas.selected_nodes).length<=1)fApplyMultiNode(node);else for(var i in graphcanvas.selected_nodes)fApplyMultiNode(graphcanvas.selected_nodes[i]);graph.afterChange(),node.setDirtyCanvas(!0,!0)},LGraphCanvas.onMenuNodeToSubgraph=function(value,options,e,menu,node){var nodes_list,subgraph_node,graph=node.graph,graphcanvas=LGraphCanvas.active_canvas;graphcanvas&&((nodes_list=Object.values(graphcanvas.selected_nodes||{})).length||(nodes_list=[node]),(subgraph_node=LiteGraph.createNode("graph/subgraph")).pos=node.pos.concat(),graph.add(subgraph_node),subgraph_node.buildFromNodes(nodes_list),graphcanvas.deselectAllNodes(),node.setDirtyCanvas(!0,!0))},LGraphCanvas.onMenuNodeClone=function(value,options,e,menu,node){node.graph.beforeChange();var newSelected={},fApplyMultiNode=node=>{var newnode;!1!==node.clonable&&(newnode=node.clone())&&(newnode.pos=[node.pos[0]+5,node.pos[1]+5],node.graph.add(newnode),newSelected[newnode.id]=newnode)},graphcanvas=LGraphCanvas.active_canvas;if(!graphcanvas.selected_nodes||Object.keys(graphcanvas.selected_nodes).length<=1)fApplyMultiNode(node);else for(var i in graphcanvas.selected_nodes)fApplyMultiNode(graphcanvas.selected_nodes[i]);Object.keys(newSelected).length&&graphcanvas.selectNodes(newSelected),node.graph.afterChange(),node.setDirtyCanvas(!0,!0)},LGraphCanvas.node_colors={red:{color:"#322",bgcolor:"#533",groupcolor:"#A88"},brown:{color:"#332922",bgcolor:"#593930",groupcolor:"#b06634"},green:{color:"#232",bgcolor:"#353",groupcolor:"#8A8"},blue:{color:"#223",bgcolor:"#335",groupcolor:"#88A"},pale_blue:{color:"#2a363b",bgcolor:"#3f5159",groupcolor:"#3f789e"},cyan:{color:"#233",bgcolor:"#355",groupcolor:"#8AA"},purple:{color:"#323",bgcolor:"#535",groupcolor:"#a1309b"},yellow:{color:"#432",bgcolor:"#653",groupcolor:"#b58b2a"},black:{color:"#222",bgcolor:"#000",groupcolor:"#444"}},LGraphCanvas.prototype.getCanvasMenuOptions=function(){var extra,options=null;return this.getMenuOptions?options=this.getMenuOptions():(options=[{content:"Add Node",has_submenu:!0,callback:LGraphCanvas.onMenuAdd},{content:"Add Group",callback:LGraphCanvas.onGroupAdd}],1<Object.keys(this.selected_nodes).length&&options.push({content:"Align",has_submenu:!0,callback:LGraphCanvas.onGroupAlign}),this._graph_stack&&0<this._graph_stack.length&&options.push(null,{content:"Close subgraph",callback:this.closeSubgraph.bind(this)})),options=this.getExtraMenuOptions&&(extra=this.getExtraMenuOptions(this,options))?options.concat(extra):options},LGraphCanvas.prototype.getNodeMenuOptions=function(node){var inputs,options=null;return node.getMenuOptions?options=node.getMenuOptions(this):(!(options=[{content:"Inputs",has_submenu:!0,disabled:!0,callback:LGraphCanvas.showMenuNodeOptionalInputs},{content:"Outputs",has_submenu:!0,disabled:!0,callback:LGraphCanvas.showMenuNodeOptionalOutputs},null,{content:"Properties",has_submenu:!0,callback:LGraphCanvas.onShowMenuNodeProperties},null,{content:"Title",callback:LGraphCanvas.onShowPropertyEditor},{content:"Mode",has_submenu:!0,callback:LGraphCanvas.onMenuNodeMode}])!==node.resizable&&options.push({content:"Resize",callback:LGraphCanvas.onMenuResizeNode}),options.push({content:"Collapse",callback:LGraphCanvas.onMenuNodeCollapse},{content:"Pin",callback:LGraphCanvas.onMenuNodePin},{content:"Colors",has_submenu:!0,callback:LGraphCanvas.onMenuNodeColors},{content:"Shapes",has_submenu:!0,callback:LGraphCanvas.onMenuNodeShapes},null)),node.onGetInputs&&(inputs=node.onGetInputs())&&inputs.length&&(options[0].disabled=!1),node.onGetOutputs&&(inputs=node.onGetOutputs())&&inputs.length&&(options[1].disabled=!1),node.getExtraMenuOptions&&(inputs=node.getExtraMenuOptions(this,options))&&(inputs.push(null),options=inputs.concat(options)),!1!==node.clonable&&options.push({content:"Clone",callback:LGraphCanvas.onMenuNodeClone}),1<Object.keys(this.selected_nodes).length&&options.push({content:"Align Selected To",has_submenu:!0,callback:LGraphCanvas.onNodeAlign}),options.push(null,{content:"Remove",disabled:!(!1!==node.removable&&!node.block_delete),callback:LGraphCanvas.onMenuNodeRemove}),node.graph&&node.graph.onGetNodeMenuOptions&&node.graph.onGetNodeMenuOptions(options,node),options},LGraphCanvas.prototype.getGroupMenuOptions=function(node){return[{content:"Title",callback:LGraphCanvas.onShowPropertyEditor},{content:"Color",has_submenu:!0,callback:LGraphCanvas.onMenuNodeColors},{content:"Font size",property:"font_size",type:"Number",callback:LGraphCanvas.onShowPropertyEditor},null,{content:"Remove",callback:LGraphCanvas.onMenuNodeRemove}]},LGraphCanvas.prototype.processContextMenu=function(node,event){var _slot,that=this,ref_window=LGraphCanvas.active_canvas.getCanvasWindow(),menu_info=null,options={event:event,callback:function(v,options,e){var info,slot_info,dialog,input,inner;v&&("Remove Slot"==v.content?(info=v.slot,node.graph.beforeChange(),info.input?node.removeInput(info.slot):info.output&&node.removeOutput(info.slot),node.graph.afterChange()):"Disconnect Links"==v.content?(info=v.slot,node.graph.beforeChange(),info.output?node.disconnectOutput(info.slot):info.input&&node.disconnectInput(info.slot),node.graph.afterChange()):"Rename Slot"==v.content&&(slot_info=(info=v.slot).input?node.getInputInfo(info.slot):node.getOutputInfo(info.slot),dialog=that.createDialog("<span class='name'>Name</span><input autofocus type='text'/><button>OK</button>",options),(input=dialog.querySelector("input"))&&slot_info&&(input.value=slot_info.label||""),inner=function(){node.graph.beforeChange(),input.value&&(slot_info&&(slot_info.label=input.value),that.setDirty(!0)),dialog.close(),node.graph.afterChange()},dialog.querySelector("button").addEventListener("click",inner),input.addEventListener("keydown",function(e){if(dialog.is_modified=!0,27==e.keyCode)dialog.close();else if(13==e.keyCode)inner();else if(13!=e.keyCode&&"textarea"!=e.target.localName)return;e.preventDefault(),e.stopPropagation()}),input.focus()))},extra:node},slot=(node&&(options.title=node.type),null);node&&(slot=node.getSlotInPosition(event.canvasX,event.canvasY),LGraphCanvas.active_node=node),slot?(menu_info=[],node.getSlotMenuOptions?menu_info=node.getSlotMenuOptions(slot):(slot&&slot.output&&slot.output.links&&slot.output.links.length&&menu_info.push({content:"Disconnect Links",slot:slot}),(_slot=slot.input||slot.output).removable&&menu_info.push(_slot.locked?"Cannot remove":{content:"Remove Slot",slot:slot}),_slot.nameLocked||menu_info.push({content:"Rename Slot",slot:slot})),options.title=(slot.input||slot.output).type||"*",slot.input&&slot.input.type==LiteGraph.ACTION&&(options.title="Action"),slot.output&&slot.output.type==LiteGraph.EVENT&&(options.title="Event")):node?menu_info=this.getNodeMenuOptions(node):(menu_info=this.getCanvasMenuOptions(),(_slot=this.graph.getGroupOnPos(event.canvasX,event.canvasY))&&menu_info.push(null,{content:"Edit Group",has_submenu:!0,submenu:{title:"Group",extra:_slot,options:this.getGroupMenuOptions(_slot)}})),menu_info&&new ContextMenu(menu_info,options,ref_window)},LiteGraph.compareObjects=compareObjects,LiteGraph.distance=distance,LiteGraph.colorToString=colorToString,LiteGraph.isInsideRectangle=isInsideRectangle,LiteGraph.growBounding=growBounding,LiteGraph.isInsideBounding=isInsideBounding,LiteGraph.overlapBounding=overlapBounding,LiteGraph.hex2num=hex2num,LiteGraph.num2hex=num2hex,ContextMenu.prototype.addItem=function(name,value,options){var that=this,element=(options=options||{},document.createElement("div")),disabled=!(element.className="litemenu-entry submenu");function inner_onclick(e){var value=this.value,close_parent=!0;if((that.current_submenu&&that.current_submenu.close(e),options.callback&&!0===options.callback.call(this,value,options,e,that,options.node)&&(close_parent=!1),value)&&(value.callback&&!options.ignore_item_callbacks&&!0!==value.disabled&&!0===value.callback.call(this,value,options,e,that,options.extra)&&(close_parent=!1),value.submenu)){if(!value.submenu.options)throw"ContextMenu submenu needs options";new that.constructor(value.submenu.options,{callback:value.submenu.callback,event:e,parentMenu:that,ignore_item_callbacks:value.submenu.ignore_item_callbacks,title:value.submenu.title,extra:value.submenu.extra,autoopen:options.autoopen}),close_parent=!1}close_parent&&!that.lock&&that.close()}return null===value?element.classList.add("separator"):(element.innerHTML=value&&value.title?value.title:name,(element.value=value)&&(value.disabled&&(disabled=!0,element.classList.add("disabled")),value.submenu||value.has_submenu)&&element.classList.add("has_submenu"),"function"==typeof value?(element.dataset.value=name,element.onclick_callback=value):element.dataset.value=value,value.className&&(element.className+=" "+value.className)),this.root.appendChild(element),disabled||element.addEventListener("click",inner_onclick),!disabled&&options.autoopen&&LiteGraph.pointerListenerAdd(element,"enter",function(e){var value=this.value;value&&value.has_submenu&&inner_onclick.call(this,e)}),element},ContextMenu.prototype.close=function(e,ignore_parent_menu){this.root.parentNode&&this.root.parentNode.removeChild(this.root),this.parentMenu&&!ignore_parent_menu&&(this.parentMenu.lock=!1,this.parentMenu.current_submenu=null,void 0===e?this.parentMenu.close():e&&!ContextMenu.isCursorOverElement(e,this.parentMenu.root)&&ContextMenu.trigger(this.parentMenu.root,LiteGraph.pointerevents_method+"leave",e)),this.current_submenu&&this.current_submenu.close(e,!0),this.root.closing_timer&&clearTimeout(this.root.closing_timer)},ContextMenu.trigger=function(element,event_name,params,origin){var evt=document.createEvent("CustomEvent");return evt.initCustomEvent(event_name,!0,!0,params),evt.srcElement=origin,element.dispatchEvent?element.dispatchEvent(evt):element.__events&&element.__events.dispatchEvent(evt),evt},ContextMenu.prototype.getTopMenu=function(){return this.options.parentMenu?this.options.parentMenu.getTopMenu():this},ContextMenu.prototype.getFirstEvent=function(){return this.options.parentMenu?this.options.parentMenu.getFirstEvent():this.options.event},ContextMenu.isCursorOverElement=function(event,element){var left=event.clientX,event=event.clientY,element=element.getBoundingClientRect();return!!element&&event>element.top&&event<element.top+element.height&&left>element.left&&left<element.left+element.width},LiteGraph.closeAllContextMenus=function(ref_window){var elements=(ref_window=ref_window||window).document.querySelectorAll(".litecontextmenu");if(elements.length){for(var result=[],i=0;i<elements.length;i++)result.push(elements[i]);for(i=0;i<result.length;i++)result[i].close?result[i].close():result[i].parentNode&&result[i].parentNode.removeChild(result[i])}},LiteGraph.extendClass=function(target,origin){for(var i in origin)target.hasOwnProperty(i)||(target[i]=origin[i]);if(origin.prototype)for(var i in origin.prototype)!origin.prototype.hasOwnProperty(i)||target.prototype.hasOwnProperty(i)||(origin.prototype.__lookupGetter__(i)?target.prototype.__defineGetter__(i,origin.prototype.__lookupGetter__(i)):target.prototype[i]=origin.prototype[i],origin.prototype.__lookupSetter__(i)&&target.prototype.__defineSetter__(i,origin.prototype.__lookupSetter__(i)))},CurveEditor.sampleCurve=function(f,points){if(points){for(var i=0;i<points.length-1;++i){var r,p=points[i],pn=points[i+1];if(!(pn[0]<f))return r=pn[0]-p[0],Math.abs(r)<1e-5?p[1]:(r=(f-p[0])/r,p[1]*(1-r)+pn[1]*r)}return 0}},CurveEditor.prototype.draw=function(ctx,size,graphcanvas,background_color,line_color,inactive){var points=this.points;if(points){var w=(this.size=size)[0]-2*this.margin,h=size[1]-2*this.margin;line_color=line_color||"#666",ctx.save(),ctx.translate(this.margin,this.margin),background_color&&(ctx.fillStyle="#111",ctx.fillRect(0,0,w,h),ctx.fillStyle="#222",ctx.fillRect(.5*w,0,1,h),ctx.strokeStyle="#333",ctx.strokeRect(0,0,w,h)),ctx.strokeStyle=line_color,inactive&&(ctx.globalAlpha=.5),ctx.beginPath();for(var i=0;i<points.length;++i){var p=points[i];ctx.lineTo(p[0]*w,(1-p[1])*h)}if(ctx.stroke(),ctx.globalAlpha=1,!inactive)for(i=0;i<points.length;++i){p=points[i];ctx.fillStyle=this.selected==i?"#FFF":this.nearest==i?"#DDD":"#AAA",ctx.beginPath(),ctx.arc(p[0]*w,(1-p[1])*h,2,0,2*Math.PI),ctx.fill()}ctx.restore()}},CurveEditor.prototype.onMouseDown=function(localpos,graphcanvas){var w,h,x,points=this.points;if(points&&!(localpos[1]<0))return w=this.size[0]-2*this.margin,h=this.size[1]-2*this.margin,x=localpos[0]-this.margin,localpos=localpos[1]-this.margin,graphcanvas=30/graphcanvas.ds.scale,this.selected=this.getCloserPoint([x,localpos],graphcanvas),-1==this.selected&&(points.push(graphcanvas=[x/w,1-localpos/h]),points.sort(function(a,b){return a[0]-b[0]}),this.selected=points.indexOf(graphcanvas),this.must_update=!0),-1!=this.selected||void 0},CurveEditor.prototype.onMouseMove=function(localpos,graphcanvas){var s,x,y,curvepos,points=this.points;!points||(s=this.selected)<0||(x=(localpos[0]-this.margin)/(this.size[0]-2*this.margin),y=(localpos[1]-this.margin)/(this.size[1]-2*this.margin),curvepos=[localpos[0]-this.margin,localpos[1]-this.margin],graphcanvas=30/graphcanvas.ds.scale,this._nearest=this.getCloserPoint(curvepos,graphcanvas),(curvepos=points[s])&&(!(graphcanvas=0==s||s==points.length-1)&&(localpos[0]<-10||localpos[0]>this.size[0]+10||localpos[1]<-10||localpos[1]>this.size[1]+10)?(points.splice(s,1),this.selected=-1):(curvepos[0]=graphcanvas?0==s?0:1:LiteGraph.clamp(x,0,1),curvepos[1]=1-LiteGraph.clamp(y,0,1),points.sort(function(a,b){return a[0]-b[0]}),this.selected=points.indexOf(curvepos),this.must_update=!0)))},CurveEditor.prototype.onMouseUp=function(localpos,graphcanvas){return!(this.selected=-1)},CurveEditor.prototype.getCloserPoint=function(pos,max_dist){var points=this.points;if(!points)return-1;max_dist=max_dist||30;for(var w=this.size[0]-2*this.margin,h=this.size[1]-2*this.margin,num=points.length,p2=[0,0],min_dist=1e6,closest=-1,i=0;i<num;++i){var p=points[i],p=(p2[0]=p[0]*w,p2[1]=(1-p[1])*h,p2[0]<pos[0]&&0,vec2.distance(pos,p2));min_dist<p||max_dist<p||(closest=i,min_dist=p)}return closest},LiteGraph.CurveEditor=CurveEditor,LiteGraph.getParameterNames=function(func){return(func+"").replace(/[/][/].*$/gm,"").replace(/\s+/g,"").replace(/[/][*][^/*]*[*][/]/g,"").split("){",1)[0].replace(/^[^(]*[(]/,"").replace(/=[^,]+/g,"").split(",").filter(Boolean)},LiteGraph.pointerListenerAdd=function(oDOM,sEvIn,fCall,capture=!1){if(oDOM&&oDOM.addEventListener&&sEvIn&&"function"==typeof fCall){var sMethod=LiteGraph.pointerevents_method,sEvent=sEvIn;if("pointer"==sMethod&&!window.PointerEvent)switch(console.warn("sMethod=='pointer' && !window.PointerEvent"),console.log("Converting pointer["+sEvent+"] : down move up cancel enter TO touchstart touchmove touchend, etc .."),sEvent){case"down":sMethod="touch",sEvent="start";break;case"move":sMethod="touch";break;case"up":sMethod="touch",sEvent="end";break;case"cancel":sMethod="touch";break;case"enter":console.log("debug: Should I send a move event?");break;default:console.warn("PointerEvent not available in this browser ? The event "+sEvent+" would not be called")}switch(sEvent){case"down":case"up":case"move":case"over":case"out":case"enter":oDOM.addEventListener(sMethod+sEvent,fCall,capture);case"leave":case"cancel":case"gotpointercapture":case"lostpointercapture":if("mouse"!=sMethod)return oDOM.addEventListener(sMethod+sEvent,fCall,capture);default:return oDOM.addEventListener(sEvent,fCall,capture)}}},LiteGraph.pointerListenerRemove=function(oDOM,sEvent,fCall,capture=!1){if(oDOM&&oDOM.removeEventListener&&sEvent&&"function"==typeof fCall)switch(sEvent){case"down":case"up":case"move":case"over":case"out":case"enter":"pointer"!=LiteGraph.pointerevents_method&&"mouse"!=LiteGraph.pointerevents_method||oDOM.removeEventListener(LiteGraph.pointerevents_method+sEvent,fCall,capture);case"leave":case"cancel":case"gotpointercapture":case"lostpointercapture":if("pointer"==LiteGraph.pointerevents_method)return oDOM.removeEventListener(LiteGraph.pointerevents_method+sEvent,fCall,capture);default:return oDOM.removeEventListener(sEvent,fCall,capture)}},LiteGraph.clamp=(v,a,b)=>v<a?a:b<v?b:v,"undefined"==typeof window||window.requestAnimationFrame||(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(callback){window.setTimeout(callback,1e3/60)});export{LiteGraph,LGraph,LLink,LGraphNode,LGraphGroup,DragAndScale,LGraphCanvas,ContextMenu};

