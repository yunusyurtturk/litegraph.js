/*packed*/
function getGlobalObject(){if("undefined"!=typeof globalThis)return globalThis;if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("Unable to determine global object")}function setGlobalVariable(key,value){getGlobalObject()[key]=value}function getGlobalVariable(key){return getGlobalObject()[key]}class LiteGraphClass{VERSION="a0.11.0";LLink=null;LGraph=null;LGraphNode=null;LGraphGroup=null;LGraphCanvas=null;Subgraph=null;GraphInput=null;GraphOutput=null;DragAndScale=null;ContextMenuClass=null;ContextMenu=null;CallbackHandler=null;CANVAS_GRID_SIZE=10;NODE_TITLE_HEIGHT=30;NODE_TITLE_TEXT_Y=20;NODE_SLOT_HEIGHT=20;NODE_WIDGET_HEIGHT=20;NODE_WIDTH=140;NODE_MIN_WIDTH=50;NODE_MIN_SIZE=[50,0];NODE_COLLAPSED_RADIUS=10;NODE_COLLAPSED_WIDTH=80;NODE_TITLE_COLOR="#999";NODE_SELECTED_TITLE_COLOR="#FFF";NODE_TEXT_SIZE=14;NODE_TEXT_COLOR="#AAA";NODE_SUBTEXT_SIZE=12;NODE_DEFAULT_COLOR="#333";NODE_DEFAULT_BGCOLOR="#353535";NODE_DEFAULT_BOXCOLOR="#666";NODE_DEFAULT_SHAPE="box";NODE_BOX_OUTLINE_COLOR="#FFF";DEFAULT_SHADOW_COLOR="rgba(0,0,0,0.5)";DEFAULT_GROUP_FONT=24;WIDGET_BGCOLOR="#222";WIDGET_OUTLINE_COLOR="#666";WIDGET_TEXT_COLOR="#DDD";WIDGET_SECONDARY_TEXT_COLOR="#999";LINK_COLOR="#9A9";EVENT_LINK_COLOR="#A86";CONNECTING_LINK_COLOR="#AFA";MAX_NUMBER_OF_NODES=1e3;DEFAULT_POSITION=[100,100];VALID_SHAPES=["default","box","round","card"];BOX_SHAPE=1;ROUND_SHAPE=2;CIRCLE_SHAPE=3;CARD_SHAPE=4;ARROW_SHAPE=5;GRID_SHAPE=6;INPUT=1;OUTPUT=2;EVENT=-1;ACTION=-1;NODE_MODES=["Always","On Event","Never","On Trigger","On Request"];NODE_MODES_COLORS=["#666","#422","#333","#224","#626"];ALWAYS=0;ON_EVENT=1;NEVER=2;ON_TRIGGER=3;ON_REQUEST=4;UP=1;DOWN=2;LEFT=3;RIGHT=4;CENTER=5;LINK_RENDER_MODES=["Straight","Linear","Spline"];STRAIGHT_LINK=0;LINEAR_LINK=1;SPLINE_LINK=2;NORMAL_TITLE=0;NO_TITLE=1;TRANSPARENT_TITLE=2;AUTOHIDE_TITLE=3;VERTICAL_LAYOUT="vertical";proxy=null;node_images_path="";catch_exceptions=!0;throw_errors=!0;allow_scripts=!1;use_deferred_actions=!0;registered_node_types={};node_types_by_file_extension={};Nodes={};Globals={};searchbox_extras={};auto_sort_node_types=!1;node_box_coloured_when_on=!1;node_box_coloured_by_mode=!1;dialog_close_on_mouse_leave=!0;dialog_close_on_mouse_leave_delay=500;shift_click_do_break_link_from=!0;click_do_break_link_to=!1;search_filter_enabled=!1;search_hide_on_mouse_leave=!0;search_hide_on_mouse_leave_time=1200;search_show_all_on_open=!0;show_node_tooltip=!1;show_node_tooltip_use_descr_property=!1;auto_load_slot_types=!1;registered_slot_in_types={};registered_slot_out_types={};slot_types_in=[];slot_types_out=[];slot_types_default_in=[];slot_types_default_out=[];graphDefaultConfig={align_to_grid:!0,links_ontop:!1};alt_drag_do_clone_nodes=!1;alt_shift_drag_connect_clone_with_input=!0;do_add_triggers_slots=!1;allow_multi_output_for_events=!0;middle_click_slot_add_default_node=!1;release_link_on_empty_shows_menu=!1;two_fingers_opens_menu=!1;backspace_delete=!0;ctrl_shift_v_paste_connect_unselected_outputs=!1;actionHistory_enabled=!1;actionHistoryMaxSave=300;refreshAncestorsOnTriggers=!1;refreshAncestorsOnActions=!1;ensureUniqueExecutionAndActionCall=!1;use_uuids=!1;context_menu_filter_enabled=!1;canRemoveSlots=!0;canRemoveSlots_onlyOptional=!0;canRenameSlots=!0;canRenameSlots_onlyOptional=!0;ensureNodeSingleExecution=!1;ensureNodeSingleAction=!1;preventAncestorRecalculation=!1;allowMultiOutputForEvents=!1;reprocess_slot_while_node_configure=!1;properties_allow_input_binding=!1;log_methods=["error","warn","info","log","debug"];cb_handler=!1;debug=!0;debug_level=2;constructor(){}initialize(){this.callbackhandler_setup(),this.LLink=LLink,this.LGraph=LGraph,this.LGraphNode=LGraphNode,this.LGraphGroup=LGraphGroup,this.LGraphCanvas=LGraphCanvas,this.Subgraph=Subgraph,this.GraphInput=GraphInput,this.GraphOutput=GraphOutput,this.DragAndScale=DragAndScale,this.ContextMenuClass=ContextMenu,this.ContextMenu=function(){return new ContextMenu(...arguments)},this.CallbackHandler=CallbackHandler,this.includeBasicNodes()}includeBasicNodes(){this.registerNodeType("graph/subgraph",Subgraph),this.registerNodeType("graph/input",GraphInput),this.registerNodeType("graph/output",GraphOutput)}callbackhandler_setup(){this.cb_handler||(this.cb_handler=new CallbackHandler(this),this.registerCallbackHandler=function(){return this.cb_handler.registerCallbackHandler(...arguments)},this.unregisterCallbackHandler=function(){return this.cb_handler.unregisterCallbackHandler(...arguments)},this.processCallbackHandlers=function(){return this.cb_handler.processCallbackHandlers(...arguments)})}registerCallbackHandler(){this.callbackhandler_setup(),this.cb_handler.registerCallbackHandler(...arguments)}unregisterCallbackHandler(){this.callbackhandler_setup(),this.cb_handler.unregisterCallbackHandler(...arguments)}processCallbackHandlers(){this.callbackhandler_setup(),this.cb_handler.processCallbackHandlers(...arguments)}logging_set_level(v){this.debug_level=Number(v)}logging(lvl){if(!this.debug&&0<this.debug_level&&(this.debug_level=0),!(lvl>this.debug_level)){let lvl_txt=0<=lvl&&lvl<=4?["error","warn","info","log","debug"][lvl]:"debug";if("function"!=typeof console[lvl_txt])throw console.warn("[LG-log] invalid console method",lvl_txt,clean_args(arguments)),new RangeError;function clean_args(args){var aRet=[];(lvl<0||4<lvl)&&aRet.push("loglvl:"+lvl);for(let iA=1;iA<args.length;iA++)void 0!==args[iA]&&aRet.push(args[iA]);return aRet}console[lvl_txt]("[LG]",...clean_args(arguments))}}log_error(){this.logging(0,...arguments)}log_warn(){this.logging(1,...arguments)}log_info(){this.logging(2,...arguments)}log_log(){this.logging(3,...arguments)}log_debug(){this.logging(4,...arguments)}log_verbose(){this.logging(5,...arguments)}registerNodeType(type,base_class){if(!base_class.prototype)throw new Error("Cannot register a simple object, it must be a class with a prototype");base_class.type=type,this.log_debug("registerNodeType","start",type);var classname=base_class.name,pos=type.lastIndexOf("/");base_class.category=type.substring(0,pos),base_class.title||(base_class.title=classname);const propertyDescriptors=Object.getOwnPropertyDescriptors(LGraphNode.prototype);Object.keys(propertyDescriptors).forEach(propertyName=>{base_class.prototype.hasOwnProperty(propertyName)||Object.defineProperty(base_class.prototype,propertyName,propertyDescriptors[propertyName])});pos=this.registered_node_types[type];if(pos&&this.log_debug("registerNodeType","replacing node type",type,pos),!Object.prototype.hasOwnProperty.call(base_class.prototype,"shape")&&(Object.defineProperty(base_class.prototype,"shape",{set:function(v){switch(v){case"default":delete this._shape;break;case"box":this._shape=LiteGraph.BOX_SHAPE;break;case"round":this._shape=LiteGraph.ROUND_SHAPE;break;case"circle":this._shape=LiteGraph.CIRCLE_SHAPE;break;case"card":this._shape=LiteGraph.CARD_SHAPE;break;default:this._shape=v}},get:function(){return this._shape},enumerable:!0,configurable:!0}),base_class.supported_extensions))for(let i in base_class.supported_extensions){const ext=base_class.supported_extensions[i];ext&&ext.constructor===String&&(this.node_types_by_file_extension[ext.toLowerCase()]=base_class)}if((this.registered_node_types[type]=base_class).constructor.name&&(this.Nodes[classname]=base_class),this.processCallbackHandlers("onNodeTypeRegistered",{def_cb:this.onNodeTypeRegistered},type,base_class),pos&&this.processCallbackHandlers("onNodeTypeReplaced",{def_cb:this.onNodeTypeReplaced},type,base_class,pos),base_class.prototype.onPropertyChange&&LiteGraph.log_warn("LiteGraph node class "+type+" has onPropertyChange method, it must be called onPropertyChanged with d at the end"),base_class.supported_extensions)for(var i=0;i<base_class.supported_extensions.length;i++){var ext=base_class.supported_extensions[i];ext&&ext.constructor===String&&(this.node_types_by_file_extension[ext.toLowerCase()]=base_class)}this.log_debug("registerNodeType","type registered",type),this.auto_load_slot_types&&(this.log_debug("registerNodeType","auto_load_slot_types, create empy tmp node",type),new base_class(base_class.title??"tmpnode").post_constructor())}unregisterNodeType(type){var base_class=type.constructor===String?this.registered_node_types[type]:type;if(!base_class)throw new Error("node type not found to unregister: "+type);delete this.registered_node_types[base_class.type],base_class.constructor.name&&delete this.Nodes[base_class.constructor.name]}registerNodeAndSlotType(type,slot_type,out=!1){var class_type=(type.constructor===String&&"anonymous"!==this.registered_node_types[type]?this.registered_node_types[type]:type).constructor.type;let allTypes=[];allTypes="string"==typeof slot_type?slot_type.split(","):slot_type==this.EVENT||slot_type==this.ACTION?["_event_"]:["*"];for(let i=0;i<allTypes.length;++i){let slotType=allTypes[i];""===slotType&&(slotType="*");var registerTo=out?"registered_slot_out_types":"registered_slot_in_types";void 0===this[registerTo][slotType]&&(this[registerTo][slotType]={nodes:[]}),this[registerTo][slotType].nodes.includes(class_type)||this[registerTo][slotType].nodes.push(class_type),out?this.slot_types_out.includes(slotType.toLowerCase())||(this.slot_types_out.push(slotType.toLowerCase()),this.slot_types_out.sort()):this.slot_types_in.includes(slotType.toLowerCase())||(this.slot_types_in.push(slotType.toLowerCase()),this.slot_types_in.sort())}}buildNodeClassFromObject(name,object){var ctor_code="";if(object.inputs)for(let i=0;i<object.inputs.length;++i){var _name=object.inputs[i][0];let _type=object.inputs[i][1];ctor_code+="this.addInput('"+_name+"',"+(_type=_type&&_type.constructor===String?'"'+_type+'"':_type)+");\n"}if(object.outputs)for(let i=0;i<object.outputs.length;++i){let _name=object.outputs[i][0],_type=object.outputs[i][1];ctor_code+="this.addOutput('"+_name+"',"+(_type=_type&&_type.constructor===String?'"'+_type+'"':_type)+");\n"}if(object.properties)for(var i in object.properties){let prop=object.properties[i];prop&&prop.constructor===String&&(prop='"'+prop+'"'),ctor_code+="this.addProperty('"+i+"',"+prop+");\n"}ctor_code+="if(this.onCreate)this.onCreate()";var classobj=Function(ctor_code);for(let i in object)"inputs"!=i&&"outputs"!=i&&"properties"!=i&&(classobj.prototype[i]=object[i]);return classobj.title=object.title||name.split("/").pop(),classobj.desc=object.desc||"Generated from object",this.registerNodeType(name,classobj),classobj}wrapFunctionAsNode(name,func,param_types,return_type,properties){const names=LiteGraph.getParameterNames(func);var code=names.map((name,i)=>{return`this.addInput('${name}', ${param_types?.[i]?`'${param_types[i]}'`:"0"});`}).join("\n"),return_type=return_type?`'${return_type}'`:0,properties=properties?`this.properties = ${JSON.stringify(properties)};`:"",code=new Function(`
            ${code}
            this.addOutput('out', ${return_type});
            ${properties}
        `);return code.title=name.split("/").pop(),code.desc="Generated from "+func.name,code.prototype.onExecute=function(){var params=names.map((name,i)=>this.getInputData(i)),params=func.apply(this,params);this.setOutputData(0,params)},this.registerNodeType(name,code),code}clearRegisteredTypes(){this.registered_node_types={},this.node_types_by_file_extension={},this.Nodes={},this.searchbox_extras={}}addNodeMethod(name,func){for(var i in LGraphNode.prototype[name]=func,this.registered_node_types){i=this.registered_node_types[i];i.prototype[name]&&(i.prototype["_"+name]=i.prototype[name]),i.prototype[name]=func}}createNode(type,title,options={}){var base_class=this.registered_node_types[type]??null;if(!base_class)return this.log_debug(`GraphNode type "${type}" not registered.`),null;LiteGraph.log_verbose("createNode",type,title,options,base_class),title=title??base_class.title??type;let node=null;if(LiteGraph.catch_exceptions)try{node=new base_class(title)}catch(err){return this.log_error("createNode",err),null}else node=new base_class(title);return node.post_constructor(),node.size_basic=node.size,node.type=type,node.title??=title,node.properties??={},node.properties_info??=[],node.flags??={},node.size??=node.computeSize(),node.pos??=LiteGraph.DEFAULT_POSITION.concat(),node.mode??=LiteGraph.ALWAYS,Object.assign(node,options),LiteGraph.log_verbose("createNode","created",node,node.processCallbackHandlers),node.processCallbackHandlers("onNodeCreated",{def_cb:node.onNodeCreated}),node}getNodeType(type){return this.registered_node_types[type]}getNodeTypesInCategory(category,filter){var filteredTypes=Object.values(this.registered_node_types).filter(type=>type.filter===filter&&(""===category?null===type.category:type.category===category));return this.auto_sort_node_types&&filteredTypes.sort((a,b)=>a.title.localeCompare(b.title)),filteredTypes}getNodeTypesCategories(filter){const categories={"":1};Object.values(this.registered_node_types).forEach(type=>{type.category&&!type.skip_list&&type.filter===filter&&(categories[type.category]=1)});var result=Object.keys(categories);return this.auto_sort_node_types?result.sort():result}reloadNodes(folder_wildcard){var tmp=document.getElementsByTagName("script"),script_files=[];for(let i=0;i<tmp.length;i++)script_files.push(tmp[i]);var docHeadObj=document.getElementsByTagName("head")[0];folder_wildcard=document.location.href+folder_wildcard;for(let i=0;i<script_files.length;i++){var src=script_files[i].src;if(src&&src.substr(0,folder_wildcard.length)==folder_wildcard)try{this.log_debug("Reloading: "+src);var dynamicScript=document.createElement("script");dynamicScript.type="text/javascript",dynamicScript.src=src,docHeadObj.appendChild(dynamicScript),docHeadObj.removeChild(script_files[i])}catch(err){if(LiteGraph.throw_errors)throw err;this.log_debug("Error while reloading "+src)}}this.log_debug("Nodes reloaded")}parseStringifyObject(obj,target){return this.cloneObject(obj,target)}cloneObject(obj,target){if(null==obj)return null;var clonedObj=JSON.parse(JSON.stringify(obj));if(!target)return clonedObj;for(const key in clonedObj)Object.prototype.hasOwnProperty.call(clonedObj,key)&&(target[key]=clonedObj[key]);return target}uuidv4(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,a=>(a^16*Math.random()>>a/4).toString(16))}isValidConnection(type_a,type_b){if(""!==type_b&&"*"!==type_b||(type_b=0),!(type_a=""!==type_a&&"*"!==type_a?type_a:0)||!type_b||type_a===type_b||type_a===LiteGraph.EVENT&&type_b===LiteGraph.ACTION)return!0;if(type_a=String(type_a).toLowerCase(),type_b=String(type_b).toLowerCase(),!type_a.includes(",")&&!type_b.includes(","))return type_a===type_b;var type_a=type_a.split(","),supported_types_b=type_b.split(",");for(const supported_type_a of type_a)for(const supported_type_b of supported_types_b)if(this.isValidConnection(supported_type_a,supported_type_b))return!0;return!1}registerSearchboxExtra(node_type,description,data){this.searchbox_extras[description.toLowerCase()]={type:node_type,desc:description,data:data}}fetchFile(url,type,on_complete,on_error){if(url){if(type=type||"text",url.constructor===String)return"http"==url.substr(0,4)&&LiteGraph.proxy&&(url=LiteGraph.proxy+url.substr(url.indexOf(":")+3)),fetch(url).then(response=>{if(response.ok)return"arraybuffer"==type?response.arrayBuffer():"text"==type||"string"==type?response.text():"json"==type?response.json():"blob"==type?response.blob():void 0;throw new Error("File not found")}).then(data=>{on_complete&&on_complete(data)}).catch(error=>{this.log_error("error fetching file:",url),on_error&&on_error(error)});if(url.constructor===File||url.constructor===Blob){var reader=new FileReader;if(reader.onload=e=>{e=e.target.result;"json"==type&&(e=JSON.parse(e)),on_complete&&on_complete(e)},"arraybuffer"==type)return reader.readAsArrayBuffer(url);if("text"==type||"json"==type)return reader.readAsText(url);if("blob"==type)return reader.readAsBinaryString(url)}}return null}compareObjects(a,b){var aKeys=Object.keys(a);return aKeys.length===Object.keys(b).length&&aKeys.every(key=>a[key]===b[key])}distance(a,b){var[a,yA]=a,[b,yB]=b;return Math.sqrt((b-a)**2+(yB-yA)**2)}colorToString(c){return"rgba("+Math.round(255*c[0]).toFixed()+","+Math.round(255*c[1]).toFixed()+","+Math.round(255*c[2]).toFixed()+","+(4==c.length?c[3].toFixed(2):"1.0")+")"}textCalculateMaxWidth(text){}canvasFillTextMultiline(context,text,x,y,maxWidth,lineHeight){var words=(text+"").trim().split(" "),line="",ret={lines:[],maxW:0,height:0};if(1<words.length)for(var n=0;n<words.length;n++){var testLine=line+words[n]+" ",testWidth=context.measureText(testLine).width;maxWidth<testWidth&&0<n?(context.fillText(line,x,y+lineHeight*ret.lines.length),line=words[n]+" ",ret.max=testWidth,ret.lines.push(line)):line=testLine}else line=words[0];return context.fillText(line,x,y+lineHeight*ret.lines.length),ret.lines.push(line),ret.height=lineHeight*ret.lines.length||lineHeight,ret}isInsideRectangle(x,y,left,top,width,height){return left<x&&x<left+width&&top<y&&y<top+height}isBoundingInsideRectangle(bounding,left,top,width,height){var x=bounding[0],y=bounding[1];return left<x&&x<left+width&&top<y&&y<top+height&&(x=bounding[0]+bounding[2],y=bounding[1]+bounding[3],left<x)&&x<left+width&&top<y&&y<top+height}growBounding(bounding,x,y){x<bounding[0]?bounding[0]=x:x>bounding[2]&&(bounding[2]=x),y<bounding[1]?bounding[1]=y:y>bounding[3]&&(bounding[3]=y)}isInsideBounding(p,bb){return p[0]>=bb[0][0]&&p[1]>=bb[0][1]&&p[0]<=bb[1][0]&&p[1]<=bb[1][1]}overlapBounding(a,b,add){var A_end_x=a[0]+a[2]+(add=add||0),A_end_y=a[1]+a[3]+add,B_end_x=b[0]+b[2]+add,add=b[1]+b[3]+add;return!(a[0]>B_end_x||a[1]>add||A_end_x<b[0]||A_end_y<b[1])}hex2num(hex){hex=(hex="#"==hex.charAt(0)?hex.slice(1):hex).toUpperCase();for(var int1,int2,value=new Array(3),k=0,i=0;i<6;i+=2)int1="0123456789ABCDEF".indexOf(hex.charAt(i)),int2="0123456789ABCDEF".indexOf(hex.charAt(i+1)),value[k]=16*int1+int2,k++;return value}num2hex(triplet){for(var int1,int2,hex="#",i=0;i<3;i++)int1=triplet[i]/16,int2=triplet[i]%16,hex+="0123456789ABCDEF".charAt(int1)+"0123456789ABCDEF".charAt(int2);return hex}extendClass=(target,origin)=>{for(var i in origin)target.hasOwnProperty(i)||(target[i]=origin[i]);if(origin.prototype)for(let i in origin.prototype)!origin.prototype.hasOwnProperty(i)||target.prototype.hasOwnProperty(i)||(origin.prototype.__lookupGetter__(i)?target.prototype.__defineGetter__(i,origin.prototype.__lookupGetter__(i)):target.prototype[i]=origin.prototype[i],origin.prototype.__lookupSetter__(i)&&target.prototype.__defineSetter__(i,origin.prototype.__lookupSetter__(i)))};getParameterNames=function(func){return(func+"").replace(/[/][/].*$/gm,"").replace(/\s+/g,"").replace(/[/][*][^/*]*[*][/]/g,"").split("){",1)[0].replace(/^[^(]*[(]/,"").replace(/=[^,]+/g,"").split(",").filter(Boolean)};clamp=(v,a,b)=>v<a?a:b<v?b:v;closeAllContextMenus=()=>{LiteGraph.log_verbose("LiteGraph.closeAllContextMenus is deprecated in favor of ContextMenu.closeAll()"),ContextMenu.closeAll()};getTime(){var t;return"undefined"!=typeof performance?performance.now():"undefined"!=typeof Date&&Date.now?void Date.now():"undefined"!=typeof process?.001*(t=process.hrtime())[0]+1e-6*t[1]:(new Date).getTime()}formatNumber(n,precision=3){return NaN===(n=Number(n))?"":n.toFixed(precision).replace(/(\.\d*[1-9])0+$|\.0*$/,"$1")}}"undefined"==typeof window||window.requestAnimationFrame||(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||(callback=>{window.setTimeout(callback,1e3/60)}));const root=getGlobalObject();if(!getGlobalVariable("LiteGraph")){setGlobalVariable("LiteGraph",new LiteGraphClass);let LGInst=getGlobalVariable("LiteGraph");LGInst.log_info("LiteGraph instantiated",LGInst.getTime())}var LiteGraph=getGlobalVariable("LiteGraph");class CallbackHandler{debug=!1;constructor(ref){this.callbacks_handlers={},this.ob_ref=ref,this.debug&&void 0!==LiteGraph&&LiteGraph.log_debug("CallbackHandler Initialize callbacks",ref)}registerCallbackHandler=function(name,callback,opts){opts&&"object"==typeof opts||(opts={});if(opts=Object.assign({priority:0,is_default:!1,call_once:!1},opts),"function"!=typeof callback)return this.debug&&void 0!==LiteGraph&&LiteGraph.log_error("registerCallbackHandler","Invalid callback"),!1;void 0===this.callbacks_handlers[name]&&(this.callbacks_handlers[name]={last_id:0,handlers:[]});var h_id=this.callbacks_handlers[name].last_id++;return this.debug&&void 0!==LiteGraph&&LiteGraph.log_debug("registerCallbackHandler","new callback handler",name,h_id),this.callbacks_handlers[name].handlers.push({id:h_id,priority:opts.priority,callback:callback,data:opts}),this.callbacks_handlers[name].handlers.sort((a,b)=>b.priority-a.priority),h_id};unregisterCallbackHandler(name,h_id){if(void 0!==this.callbacks_handlers[name]){var nHandlers=this.callbacks_handlers[name].handlers.length;if(this.callbacks_handlers[name].handlers=this.callbacks_handlers[name].handlers.filter(function(obj){return obj.id===h_id&&LiteGraph.log_info("unregisterCallbackHandler",name,h_id),obj.id!==h_id}),this.callbacks_handlers[name].handlers.length<nHandlers)return!0}return LiteGraph.log_warn("unregisterCallbackHandler","no handlers for",name,h_id),!1}processCallbackHandlers(name,opts){opts&&"object"==typeof opts||(opts={});function executeDefaultCb(){preventDefCb||"function"!=typeof opts.def_cb?"function"==typeof opts.def_cb&&cbHandle.debug&&void 0!==LiteGraph&&LiteGraph.log_debug("processCallbackHandlers","preventing default passed",opts.def_cb):(cbHandle.debug&&void 0!==LiteGraph&&LiteGraph.log_verbose("Calling DEFAULT w Args",...aArgs),stepRet=opts.def_cb.call(cbHandle.ob_ref,...aArgs),cbHandle.debug&&void 0!==LiteGraph&&LiteGraph.log_debug("processCallbackHandlers","default callback executed",stepRet),checkStepRet()),defCbChecked=!0}opts=Object.assign({def_cb:!1},opts);var cbhX,cbHandle=this,aArgs=(this.debug&&void 0!==LiteGraph&&LiteGraph.log_verbose("**processCallbackHandlers**",...arguments),void 0===this.callbacks_handlers[name]&&(this.callbacks_handlers[name]={last_id:0,handlers:[]}),[].slice.call(arguments).slice(2)),stepRet=null,cbRet=null,aResChain=[],oCbInfo={},cbResPriority=0,defCbChecked=!1,preventDefCb=!1,breakCycle=!1,checkStepRet=function(){aResChain.push(stepRet),cbHandle.debug&&void 0!==LiteGraph&&LiteGraph.log_debug("processCallbackHandlers","checkStepRet","stepRet check",stepRet),"object"==typeof stepRet?(cbHandle.debug&&void 0!==LiteGraph&&LiteGraph.log_debug("processCallbackHandlers","checkStepRet","result is object",stepRet),void 0!==stepRet.prevent_default&&stepRet.prevent_default&&(preventDefCb=!0),void 0!==stepRet.return_value?(!cbResPriority||void 0!==stepRet.result_priority&&cbResPriority<=stepRet.result_priority||void 0===stepRet.result_priority&&(!cbResPriority||cbResPriority<=0))&&(cbHandle.debug&&void 0!==LiteGraph&&LiteGraph.log_debug("processCallbackHandlers","checkStepRet","set result from object",stepRet,oCbInfo),cbRet=stepRet):(cbHandle.debug&&void 0!==LiteGraph&&LiteGraph.log_debug("processCallbackHandlers","checkStepRet","set result, not object",stepRet,oCbInfo),cbRet=stepRet),void 0!==stepRet.stop_replication&&stepRet.stop_replication&&(cbHandle.debug&&void 0!==LiteGraph&&LiteGraph.log_debug("processCallbackHandlers","checkStepRet","stop_replication",oCbInfo),breakCycle=!0)):(cbHandle.debug&&void 0!==LiteGraph&&LiteGraph.log_debug("processCallbackHandlers","checkStepRet","result NOT object",stepRet),null!=stepRet&&(cbRet=stepRet))};for(cbhX of this.callbacks_handlers[name].handlers)if(preventDefCb&&cbhX.is_default)this.debug&&void 0!==LiteGraph&&LiteGraph.log_verbose("processCallbackHandlers","preventing default registered",cbhX);else{if(cbhX.priority<0&&!defCbChecked&&(this.debug&&void 0!==LiteGraph&&LiteGraph.log_verbose("processCallbackHandlers","process default passed","nextCb:",cbhX),executeDefaultCb(),breakCycle))break;if(oCbInfo={name:name,id:cbhX.id,current_return_value:cbRet,data:cbhX.data,results_chain:aResChain},stepRet=cbhX.callback.call(this.ob_ref,oCbInfo,...aArgs),this.debug&&void 0!==LiteGraph&&LiteGraph.log_debug("processCallbackHandlers","callback executed",stepRet,oCbInfo),checkStepRet(),this.debug&&void 0!==LiteGraph&&LiteGraph.log_debug("processCallbackHandlers","result checked","cbRet",cbRet,"aResChain",aResChain,"cbResPriority",cbResPriority,"defCbChecked",defCbChecked,"preventDefCb",preventDefCb,"breakCycle",breakCycle),breakCycle)break;cbhX.data.call_once&&(this.unregisterCallbackHandler(name,cbhX.id),this.debug)&&void 0!==LiteGraph&&LiteGraph.log_debug("processCallbackHandlers","unregistered call_once",oCbInfo)}return defCbChecked||executeDefaultCb(),cbRet}}class ContextMenu{constructor(values,options={}){(this.options=options).scroll_speed??=.1,options.filter_enabled??=!0,this.menu_elements=[],this.#linkToParent(),this.#validateEventClass(),this.#createRoot(),this.#bindEvents(),this.setTitle(this.options.title),this.addItems(values),this.#insertMenu(),this.#calculateBestPosition(),LiteGraph.context_menu_filter_enabled&&options.filter_enabled&&this.createFilter(values,options)}#createRoot(){var root=this.root=document.createElement("div");return this.options.className&&(root.className=this.options.className),root.classList.add("litegraph","litecontextmenu","litemenubar-panel"),root.style.minWidth="80px",root.style.minHeight="10px",root}#bindEvents(){const root=this.root;root.style.pointerEvents="none",setTimeout(()=>{root.style.pointerEvents="auto"},100),root.addEventListener("pointerup",e=>(e.preventDefault(),!0)),root.addEventListener("contextmenu",e=>(2==e.button&&e.preventDefault(),!1)),root.addEventListener("pointerdown",e=>{if(2==e.button)return this.close(),e.preventDefault(),!0}),root.addEventListener("wheel",e=>{var pos=parseInt(root.style.top);return root.style.top=(pos+e.deltaY*this.options.scroll_speed).toFixed()+"px",e.preventDefault(),!0}),root.addEventListener("pointerenter",_event=>{root.closing_timer&&clearTimeout(root.closing_timer)})}#linkToParent(){var parentMenu=this.options.parentMenu;parentMenu&&(parentMenu.constructor!==this.constructor?(LiteGraph.log_error("contextmenu","linkToParent","parentMenu must be of class ContextMenu, ignoring it"),this.options.parentMenu=null):(this.parentMenu=parentMenu,this.parentMenu.lock=!0,this.parentMenu.current_submenu=this))}#validateEventClass(){var eventClass;this.options.event&&(this.options.isCustomEvent?LiteGraph.log_verbose("contextmenu","linkToParent","Custom event for ContextMenu.",this.options.event):"MouseEvent"!==(eventClass=this.options.event.constructor.name)&&"CustomEvent"!==eventClass&&"PointerEvent"!==eventClass&&LiteGraph.log_warn(`Event passed to ContextMenu is not of type MouseEvent or CustomEvent. Was originally ignoring it. (${eventClass})`))}createFilter(values,options){if(values&&values.length&&1!=values.length){const filter=document.createElement("input"),items=(filter.classList.add("context-menu-filter"),filter.placeholder="Filter list",this.root.prepend(filter),Array.from(this.root.querySelectorAll(".litemenu-entry")));let displayedItems=[...items],itemCount=displayedItems.length;console.info(options),requestAnimationFrame(()=>{const clickedComboValue=options.extra?.widgets?.filter(w=>"combo"===w.type&&w.options.values.length===values.length).find(w=>w.options.values.every((v,i)=>v===values[i]))?.value;let selectedIndex=clickedComboValue?values.findIndex(v=>v===clickedComboValue):0,selectedItem=(selectedIndex<0&&(selectedIndex=0),displayedItems[selectedIndex]);function updateSelected(){selectedItem?.style.setProperty("background-color",""),selectedItem?.style.setProperty("color",""),(selectedItem=displayedItems[selectedIndex])?.style.setProperty("background-color","#ccc","important"),selectedItem?.style.setProperty("color","#000","important")}updateSelected();const positionList=()=>{var scale;this.root.getBoundingClientRect().top<0&&(scale=1-this.root.getBoundingClientRect().height/this.root.clientHeight,scale=this.root.clientHeight*scale/2,this.root.style.top=-scale+"px")};filter.addEventListener("keydown",event=>{switch(event.key){case"ArrowUp":event.preventDefault(),0===selectedIndex?selectedIndex=itemCount-1:selectedIndex--,updateSelected();break;case"ArrowRight":selectedItem?.do_click(event);break;case"ArrowDown":event.preventDefault(),selectedIndex===itemCount-1?selectedIndex=0:selectedIndex++,updateSelected();break;case"ArrowLeft":var parentMenu=this.parentMenu;this.close(event,!0),parentMenu&&(parentMenu=Array.from(parentMenu.root.querySelectorAll(".context-menu-filter")))&&parentMenu.length&&(parentMenu[0].style.display="block",parentMenu[0].focus());break;case"Enter":selectedItem?.do_click(event);break;case"Escape":this.close()}}),filter.addEventListener("input",()=>{const term=filter.value.toLocaleLowerCase();if(displayedItems=items.filter(item=>{var isVisible=!term||item.textContent.toLocaleLowerCase().includes(term);return item.style.display=isVisible?"block":"none",isVisible}),selectedIndex=0,displayedItems.includes(selectedItem)&&(selectedIndex=displayedItems.findIndex(d=>d===selectedItem)),itemCount=displayedItems.length,updateSelected(),options.event){let top=options.event.clientY-10;var bodyRect=document.body.getBoundingClientRect(),rootRect=this.root.getBoundingClientRect();bodyRect.height&&top>bodyRect.height-rootRect.height-10&&(top=Math.max(0,bodyRect.height-rootRect.height-10)),this.root.style.top=top+"px",positionList()}}),requestAnimationFrame(()=>{filter.focus(),positionList()})})}}setTitle(title){var element;title&&(this.titleElement??=document.createElement("div"),(element=this.titleElement).className="litemenu-title",element.innerHTML=title,this.root.parentElement||this.root.appendChild(element))}addItems(values){for(let i=0;i<values.length;i++){let name=values[i];"string"!=typeof name&&(name=name&&void 0!==name.content?String(name.content):String(name));var value=values[i];this.addItem(name,value,this.options)}}#insertMenu(){var doc=this.options.event?.target.ownerDocument??document,doc=doc.fullscreenElement??doc.body;this.root;doc.appendChild(this.root)}#calculateBestPosition(){var rect,root_rect,options=this.options,root=this.root;let left=options.left||0,top=options.top||0;this.top_original=top,options.event?(left=options.event.clientX-10,top=options.event.clientY-10,options.title&&(top-=20),this.top_original=top,options.parentMenu&&(rect=options.parentMenu.root.getBoundingClientRect(),left=rect.left+rect.width),rect=document.body.getBoundingClientRect(),root_rect=root.getBoundingClientRect(),0===rect.height&&LiteGraph.log_error("document.body height is 0. That is dangerous, set html,body { height: 100%; }"),rect.width&&left>rect.width-root_rect.width-10&&(left=rect.width-root_rect.width-10),rect.height&&top>rect.height-root_rect.height-10&&(top=rect.height-root_rect.height-10)):LiteGraph.log_debug("contextmenu","calculateBestPosition","has no event"),root.style.left=left+"px",root.style.top=top+"px",options.scale&&(root.style.transform=`scale(${options.scale})`)}addItem(name,value,options={}){LiteGraph.log_verbose("contextmenu","addItem",...arguments);const element=document.createElement("div");let disabled=!(element.className="litemenu-entry submenu");var thisMenu,thisItem=element,that=(null===value?element.classList.add("separator"):(element.innerHTML=value?.title??name,(element.value=value)&&(value.disabled&&(disabled=!0,element.classList.add("disabled")),value.submenu||value.has_submenu)&&element.classList.add("has_submenu"),"function"==typeof value?(element.dataset.value=name,element.onclick_callback=value):element.dataset.value=value,value.className&&(element.className+=" "+value.className),void 0!==value.callbacks_on_element_created&&("function"==typeof value.callbacks_on_element_created&&(value.callbacks_on_element_created=[value.callbacks_on_element_created]),thisMenu=this,value.callbacks_on_element_created.forEach(fun=>{"function"==typeof fun&&(LiteGraph.log_debug("contextmenu","addItem","callbacks_on_element_created",element,fun),fun(element,thisMenu))}))),this.root.appendChild(element),disabled||(element.addEventListener("click",handleMenuItemClick),element.do_click=function(event,ignore_parent_menu){event?event.clientX?LiteGraph.log_verbose("contextmenu","addItem","do_click","has clientX",event):LiteGraph.log_warn("contextmenu","addItem","do_click","event has no clientX info",event):LiteGraph.log_warn("contextmenu","addItem","do_click","has no event",...arguments),handleMenuItemClick.call(thisItem,event,ignore_parent_menu)}),!disabled&&options.autoopen&&element.addEventListener("pointerenter",event=>{var value=this.value;value&&value.has_submenu&&handleMenuItemClick.call(this,event)}),this);function handleMenuItemClick(event){var value=this.value;let closeParent=!0;LiteGraph.log_debug("contextmenu","handleMenuItemClick","process",value,event,options,closeParent,this.current_submenu,this),that.current_submenu?.close(event);var thisFilter=Array.from(that.root.querySelectorAll(".context-menu-filter"));if((thisFilter&&thisFilter.length&&(thisFilter[0].style.display="none"),options.callback&&(LiteGraph.log_debug("contextmenu","handleMenuItemClick","global callback",this,value,options,event,that,options.node),!0===(thisFilter=options.callback.call(this,value,options,event,that,options.node))?(LiteGraph.log_debug("contextmenu","handleMenuItemClick","global callback processed, dont close parent?",thisFilter),closeParent=!1):LiteGraph.log_debug("contextmenu","handleMenuItemClick","global callback processed, will close parent",thisFilter)),value)&&(value.callback&&!options.ignore_item_callbacks&&!0!==value.disabled&&(LiteGraph.log_debug("contextmenu","handleMenuItemClick","using value callback and !ignore_item_callbacks",this,value,options,event,that,options.node),!0===value.callback.call(this,value,options,event,that,options.extra))&&(closeParent=!1),value.submenu)){if(LiteGraph.log_debug("contextmenu","handleMenuItemClick","SUBMENU",this,value,value.submenu.options,event,that,options),!value.submenu.options)return void LiteGraph.log_warn("contextmenu","handleMenuItemClick","SUBMENU","submenu needs options");new that.constructor(value.submenu.options,{callback:value.submenu.callback,event:event,parentMenu:that,ignore_item_callbacks:value.submenu.ignore_item_callbacks,title:value.submenu.title,extra:value.submenu.extra,autoopen:options.autoopen}),closeParent=!1}closeParent&&!that.lock&&that.close()}return this.menu_elements.push(element),element}close(e,ignore_parent_menu){this.parentMenu&&!ignore_parent_menu&&(this.parentMenu.lock=!1,this.parentMenu.current_submenu=null,void 0===e?this.parentMenu.close():e&&!ContextMenu.isCursorOverElement(e,this.parentMenu.root)&&ContextMenu.trigger(this.parentMenu.root,"pointerleave",e)),this.current_submenu?.close(e,!0),this.root.closing_timer&&clearTimeout(this.root.closing_timer),this.root.parentNode&&this.root.parentNode.removeChild(this.root)}static closeAll=(ref_window=window)=>{ref_window=ref_window?.document?.querySelectorAll(".litecontextmenu");ref_window&&ref_window.length&&ref_window.forEach(element=>{element.close?element.close():element.parentNode?.removeChild(element)})};static trigger(element,event_name,params,origin){event_name=new CustomEvent(event_name,{bubbles:!0,cancelable:!0,detail:params});return Object.defineProperty(event_name,"target",{value:origin}),element.dispatchEvent?element.dispatchEvent(event_name):element.__events&&element.__events.dispatchEvent(event_name),event_name}getTopMenu(){return this.options.parentMenu?.getTopMenu()??this}getFirstEvent(){return this.options.parentMenu?.getFirstEvent()??this.options.event}static isCursorOverElement(event,element){return LiteGraph.isInsideRectangle(event.clientX,event.clientY,element.left,element.top,element.width,element.height)}}class CurveEditor{constructor(points){this.points=points,this.selected=-1,this.nearest=-1,this.size=null,this.must_update=!0,this.margin=5}static sampleCurve(f,points){if(points){for(var i=0;i<points.length-1;++i){var r,p=points[i],pn=points[i+1];if(!(pn[0]<f))return r=pn[0]-p[0],Math.abs(r)<1e-5?p[1]:(r=(f-p[0])/r,p[1]*(1-r)+pn[1]*r)}return 0}}draw(ctx,size,graphcanvas,background_color,line_color,inactive){var points=this.points;if(points){var w=(this.size=size)[0]-2*this.margin,h=size[1]-2*this.margin;line_color=line_color||"#666",ctx.save(),ctx.translate(this.margin,this.margin),background_color&&(ctx.fillStyle="#111",ctx.fillRect(0,0,w,h),ctx.fillStyle="#222",ctx.fillRect(.5*w,0,1,h),ctx.strokeStyle="#333",ctx.strokeRect(0,0,w,h)),ctx.strokeStyle=line_color,inactive&&(ctx.globalAlpha=.5),ctx.beginPath();for(let i=0;i<points.length;++i){var p=points[i];ctx.lineTo(p[0]*w,(1-p[1])*h)}if(ctx.stroke(),ctx.globalAlpha=1,!inactive)for(let i=0;i<points.length;++i){let p=points[i];ctx.fillStyle=this.selected==i?"#FFF":this.nearest==i?"#DDD":"#AAA",ctx.beginPath(),ctx.arc(p[0]*w,(1-p[1])*h,2,0,2*Math.PI),ctx.fill()}ctx.restore()}}onMouseDown(localpos,graphcanvas){var w,h,x,points=this.points;if(points&&!(localpos[1]<0))return w=this.size[0]-2*this.margin,h=this.size[1]-2*this.margin,x=localpos[0]-this.margin,localpos=localpos[1]-this.margin,graphcanvas=30/graphcanvas.ds.scale,this.selected=this.getCloserPoint([x,localpos],graphcanvas),-1==this.selected&&(points.push(graphcanvas=[x/w,1-localpos/h]),points.sort((a,b)=>a[0]-b[0]),this.selected=points.indexOf(graphcanvas),this.must_update=!0),-1!=this.selected||void 0}onMouseMove(localpos,graphcanvas){var s,x,y,curvepos,points=this.points;!points||(s=this.selected)<0||(x=(localpos[0]-this.margin)/(this.size[0]-2*this.margin),y=(localpos[1]-this.margin)/(this.size[1]-2*this.margin),curvepos=[localpos[0]-this.margin,localpos[1]-this.margin],graphcanvas=30/graphcanvas.ds.scale,this._nearest=this.getCloserPoint(curvepos,graphcanvas),(curvepos=points[s])&&(!(graphcanvas=0==s||s==points.length-1)&&(localpos[0]<-10||localpos[0]>this.size[0]+10||localpos[1]<-10||localpos[1]>this.size[1]+10)?(points.splice(s,1),this.selected=-1):(curvepos[0]=graphcanvas?0==s?0:1:LiteGraph.clamp(x,0,1),curvepos[1]=1-LiteGraph.clamp(y,0,1),points.sort((a,b)=>a[0]-b[0]),this.selected=points.indexOf(curvepos),this.must_update=!0)))}onMouseUp(){return!(this.selected=-1)}getCloserPoint(pos,max_dist){var points=this.points;if(!points)return-1;max_dist=max_dist||30;for(var w=this.size[0]-2*this.margin,h=this.size[1]-2*this.margin,num=points.length,p2=[0,0],min_dist=1e6,closest=-1,i=0;i<num;++i){var p=points[i],p=(p2[0]=p[0]*w,p2[1]=(1-p[1])*h,p2[0]<pos[0]&&(last_valid=i),vec2.distance(pos,p2));min_dist<p||max_dist<p||(closest=i,min_dist=p)}return closest}}class DragAndScale{constructor(element,skip_events){this.offset=new Float32Array([0,0]),this.scale=1,this.max_scale=10,this.min_scale=.1,this.onredraw=null,this.enabled=!0,this.last_mouse=[0,0],this.element=null,this.visible_area=new Float32Array(4),element&&(this.element=element,skip_events||this.bindEvents(element))}bindEvents(element){this.last_mouse=new Float32Array(2),element.addEventListener("pointerdown",this.onMouseDown),element.addEventListener("wheel",this.onWheel)}onMouseDown=event=>{var x,rect;this.enabled&&(rect=this.element.getBoundingClientRect(),x=event.clientX-rect.left,rect=event.clientY-rect.top,event.canvasx=x,event.canvasy=rect,event.dragging=this.dragging,(!this.viewport||this.viewport&&x>=this.viewport[0]&&x<this.viewport[0]+this.viewport[2]&&rect>=this.viewport[1]&&rect<this.viewport[1]+this.viewport[3])&&(this.dragging=!0,this.abortController=new AbortController,document.addEventListener("pointermove",this.onMouseMove,{signal:this.abortController.signal}),document.addEventListener("pointerup",this.onMouseUp,{signal:this.abortController.signal})),this.last_mouse[0]=x,this.last_mouse[1]=rect)};onMouseMove=event=>{var x,rect,deltay;this.enabled&&(rect=this.element.getBoundingClientRect(),x=event.clientX-rect.left,rect=event.clientY-rect.top,event.canvasx=x,event.canvasy=rect,event.dragging=this.dragging,event=x-this.last_mouse[0],deltay=rect-this.last_mouse[1],this.dragging&&this.mouseDrag(event,deltay),this.last_mouse[0]=x,this.last_mouse[1]=rect)};onMouseUp=_event=>{this.dragging=!1,this.abortController?.abort()};onWheel=event=>{event.wheel=-event.deltaY,event.delta=event.wheelDelta?event.wheelDelta/40:event.deltaY?-event.deltaY/3:0,this.changeDeltaScale(1+.05*event.delta)};computeVisibleArea(viewport){if(this.element){let width=this.element.width,height=this.element.height,startx=-this.offset[0],starty=-this.offset[1];viewport&&(startx+=viewport[0]/this.scale,starty+=viewport[1]/this.scale,[viewport,vpHeight]=viewport.slice(2),width=viewport,height=vpHeight);var viewport=startx+width/this.scale,vpHeight=starty+height/this.scale,viewport=[startx,starty,viewport-startx,vpHeight-starty];return this.visible_area.set(viewport),viewport}this.visible_area.set([0,0,0,0])}toCanvasContext(ctx){ctx.scale(this.scale,this.scale),ctx.translate(this.offset[0],this.offset[1])}convertOffsetToCanvas(pos){return[(pos[0]+this.offset[0])*this.scale,(pos[1]+this.offset[1])*this.scale]}convertCanvasToOffset(pos,out=[0,0]){return out[0]=pos[0]/this.scale-this.offset[0],out[1]=pos[1]/this.scale-this.offset[1],out}mouseDrag(x,y){this.offset[0]+=x/this.scale,this.offset[1]+=y/this.scale,this.onredraw?.(this)}changeScale(value,zooming_center){var rect,new_center;LiteGraph.log_debug("dragandscale","changeScale",value,zooming_center),(value=LiteGraph.clamp(value,this.min_scale,this.max_scale))!=this.scale&&this.element&&(rect=this.element.getBoundingClientRect())&&(zooming_center=zooming_center||[.5*rect.width,.5*rect.height],rect=this.convertCanvasToOffset(zooming_center),LiteGraph.log_debug("dragandscale","changeScale","center",rect),this.scale=value,Math.abs(this.scale-1)<.01&&(this.scale=1),new_center=this.convertCanvasToOffset(zooming_center),LiteGraph.log_debug("dragandscale","changeScale","new center",new_center),new_center=[new_center[0]-rect[0],new_center[1]-rect[1]],LiteGraph.log_debug("dragandscale","changeScale",value,zooming_center),this.offset[0]+=new_center[0],this.offset[1]+=new_center[1],this.onredraw?.(this))}changeDeltaScale(value,zooming_center){this.changeScale(this.scale*value,zooming_center)}reset(){this.scale=1,this.offset[0]=0,this.offset[1]=0}}class LGraph{static supported_types=["number","string","boolean"];static STATUS_STOPPED=1;static STATUS_RUNNING=2;constructor(o){LiteGraph.log_debug("Graph created",o),this.list_of_graphcanvas=null,this.callbackhandler_setup(),this.clear(),o&&this.configure(o),LiteGraph.processCallbackHandlers("on_lgraph_construct",{def_cb:LiteGraph.on_lgraph_construct},this)}callbackhandler_setup(){this.cb_handler=new CallbackHandler(this)}registerCallbackHandler(){return this.cb_handler.registerCallbackHandler(...arguments)}unregisterCallbackHandler(){return this.cb_handler.unregisterCallbackHandler(...arguments)}processCallbackHandlers(){return this.cb_handler.processCallbackHandlers(...arguments)}getSupportedTypes(){return this.supported_types??LGraph.supported_types}clear(){this.stop(),this.status=LGraph.STATUS_STOPPED,this.last_node_id=0,this.last_link_id=0,this._version=-1,this._nodes?.forEach(node=>{node.processCallbackHandlers("onRemoved",{def_cb:node.onRemoved})}),this._nodes=[],this._nodes_by_id={},this._nodes_in_order=[],this._nodes_executable=null,this._groups=[],this.links={},this.iteration=0,this.config={},this.configApplyDefaults(),this.vars={},this.extra={},this.globaltime=0,this.runningtime=0,this.fixedtime=0,this.fixedtime_lapse=.01,this.elapsed_time=.01,this.last_update_time=0,this.starttime=0,this.catch_errors=!0,this.history={actionHistory:[],actionHistoryVersions:[],actionHistoryPtr:0},this.nodes_executing=[],this.nodes_actioning=[],this.node_ancestorsCalculated=[],this.nodes_executedAction=[],this.inputs={},this.outputs={},this.change(),this.sendActionToCanvas("clear")}configApply(opts){this.config=Object.assign(this.config,opts)}configApplyDefaults(){var opts=LiteGraph.graphDefaultConfig;this.configApply(opts)}attachCanvas(graphcanvas){if(!(graphcanvas instanceof LGraphCanvas))throw new Error("attachCanvas expects a LiteGraph.LGraphCanvas instance");graphcanvas.graph&&graphcanvas.graph!=this&&(LiteGraph.log_debug("lgraph","attachCanvas","detaching previous"),graphcanvas.graph.detachCanvas(graphcanvas)),(graphcanvas.graph=this).list_of_graphcanvas??=[],-1==this.list_of_graphcanvas.indexOf(graphcanvas)?(LiteGraph.log_debug("lgraph","attachCanvas","attaching canvas"),this.list_of_graphcanvas.push(graphcanvas)):LiteGraph.log_debug("lgraph","attachCanvas","canvas was already attached")}detachCanvas(graphcanvas){this.list_of_graphcanvas&&-1!=(graphcanvas=this.list_of_graphcanvas.indexOf(graphcanvas))&&(LiteGraph.log_debug("lgraph","detachCanvas",graphcanvas,this.list_of_graphcanvas,this),this.list_of_graphcanvas.splice(graphcanvas,1))}start(interval=0){if(this.status!==LGraph.STATUS_RUNNING){this.status=LGraph.STATUS_RUNNING,this.processCallbackHandlers("onPlayEvent",{def_cb:this.onPlayEvent}),this.sendEventToAllNodes("onStart"),this.starttime=LiteGraph.getTime(),this.last_update_time=this.starttime;const onAnimationFrame=()=>{-1===this.execution_timer_id&&(window.requestAnimationFrame(onAnimationFrame),this.processCallbackHandlers("onBeforeStep",{def_cb:this.onBeforeStep}),this.runStep(1,!this.catch_errors),this.processCallbackHandlers("onAfterStep",{def_cb:this.onAfterStep}))};0===interval&&"object"==typeof window&&window.requestAnimationFrame?(this.execution_timer_id=-1,onAnimationFrame()):this.execution_timer_id=setInterval(()=>{this.processCallbackHandlers("onBeforeStep",{def_cb:this.onBeforeStep}),this.runStep(1,!this.catch_errors),this.processCallbackHandlers("onAfterStep",{def_cb:this.onAfterStep})},interval)}}stop(){this.status!=LGraph.STATUS_STOPPED&&(this.status=LGraph.STATUS_STOPPED,this.processCallbackHandlers("onStopEvent",{def_cb:this.onStopEvent}),null!=this.execution_timer_id&&(-1!=this.execution_timer_id&&clearInterval(this.execution_timer_id),this.execution_timer_id=null),this.sendEventToAllNodes("onStop"))}runStep(num=1,do_not_catch_errors,limit){var start=LiteGraph.getTime(),nodes=(this.globaltime=.001*(start-this.starttime),this._nodes_executable??this._nodes);if(nodes){if(limit||=nodes.length,do_not_catch_errors){for(let i=0;i<num;i++)nodes.forEach(node=>{LiteGraph.use_deferred_actions&&node._waiting_actions?.length&&node.executePendingActions(),node.mode===LiteGraph.ALWAYS&&node.doExecute?.()}),this.fixedtime+=this.fixedtime_lapse,this.processCallbackHandlers("onExecuteStep",{def_cb:this.onExecuteStep});this.processCallbackHandlers("onAfterExecute",{def_cb:this.onAfterExecute})}else try{for(let i=0;i<num;i++)nodes.forEach(node=>{LiteGraph.use_deferred_actions&&node._waiting_actions?.length&&node.executePendingActions(),node.mode===LiteGraph.ALWAYS&&node.doExecute?.()}),this.fixedtime+=this.fixedtime_lapse,this.processCallbackHandlers("onExecuteStep",{def_cb:this.onExecuteStep});this.processCallbackHandlers("onAfterExecute",{def_cb:this.onAfterExecute}),this.errors_in_execution=!1}catch(err){if(this.errors_in_execution=!0,LiteGraph.throw_errors)throw err;LiteGraph.log_warn("lgraph","Error during execution",err),this.stop()}limit=LiteGraph.getTime(),do_not_catch_errors=limit-start;this.execution_time=.001*(do_not_catch_errors=0==do_not_catch_errors?1:do_not_catch_errors),this.globaltime+=.001*do_not_catch_errors,this.iteration+=1,this.elapsed_time=.001*(limit-this.last_update_time),this.last_update_time=limit,this.nodes_executing=[],this.nodes_actioning=[],this.node_ancestorsCalculated=[],this.nodes_executedAction=[]}}updateExecutionOrder(){this._nodes_in_order=this.computeExecutionOrder(!1),this._nodes_executable=[];for(var i=0;i<this._nodes_in_order.length;++i)this._nodes_in_order[i].onExecute&&this._nodes_executable.push(this._nodes_in_order[i])}computeExecutionOrder(only_onExecute,set_level){var i,L=[],S=[],M={},visited_links={},remaining_links={};for(let i=0,l=this._nodes.length;i<l;++i){let node=this._nodes[i];if(!only_onExecute||node.onExecute){var num=0;if((M[node.id]=node).inputs)for(var j=0,l2=node.inputs.length;j<l2;j++)node.inputs[j]&&null!=node.inputs[j].link&&(num+=1);0==num?(S.push(node),set_level&&(node._level=1)):(set_level&&(node._level=0),remaining_links[node.id]=num)}}for(;0!=S.length;){var node=S.shift();if(L.push(node),delete M[node.id],node.outputs)for(let i=0;i<node.outputs.length;i++){var output=node.outputs[i];if(null!=output&&null!=output.links&&0!=output.links.length)for(let j=0;j<output.links.length;j++){var target_node,link_id=output.links[j],link_id=this.links[link_id];!link_id||visited_links[link_id.id]||(null==(target_node=this.getNodeById(link_id.target_id))?visited_links[link_id.id]=!0:(set_level&&(!target_node._level||target_node._level<=node._level)&&(target_node._level=node._level+1),visited_links[link_id.id]=!0,--remaining_links[target_node.id],0==remaining_links[target_node.id]&&S.push(target_node)))}}}for(i in M)L.push(M[i]);L.length!=this._nodes.length&&LiteGraph.debug&&LiteGraph.log_warn("lgraph","computeExecutionOrder","something went wrong, nodes missing");var l=L.length;for(let i=0;i<l;++i)L[i].order=i;L=L.sort((A,B)=>{var Ap=A.constructor.priority||A.priority||0,Bp=B.constructor.priority||B.priority||0;return Ap==Bp?A.order-B.order:Ap-Bp});for(let i=0;i<l;++i)L[i].order=i;return L}getAncestors(node,optsIn={}){for(var opts=Object.assign({modesSkip:[],modesOnly:[],typesSkip:[],typesOnly:[]},optsIn),ancestors=[],ancestorsIds=[],pending=[node],visited={};pending.length;){var current=pending.shift();if(current&&!visited[current.id]){if(visited[current.id]=!0,current.id!=node.id){if(opts.modesSkip&&opts.modesSkip.length&&-1!=opts.modesSkip.indexOf(current.mode))continue;if(opts.modesOnly&&opts.modesOnly.length&&-1==opts.modesOnly.indexOf(current.mode))continue;-1==ancestorsIds.indexOf(current.id)&&(ancestors.push(current),ancestorsIds.push(current.id))}if(current.inputs)for(var i=0;i<current.inputs.length;++i){var inputType,input=current.getInputNode(i);input&&(inputType=current.inputs[i].type,opts.typesSkip&&opts.typesSkip.length&&-1!=opts.typesSkip.indexOf(inputType)||opts.typesOnly&&opts.typesOnly.length&&-1==opts.typesOnly.indexOf(input.mode)||-1!=ancestorsIds.indexOf(input.id)||visited[input.id]||pending.push(input))}}}return ancestors.sort((a,b)=>a.order-b.order),ancestors}arrange(margin=100,layout){var nodes=this.computeExecutionOrder(!1,!0),columns=[];for(let i=0;i<nodes.length;++i){var node=nodes[i],col=node._level||1;columns[col]??=[],columns[col].push(node)}let x=margin;for(let i=0;i<columns.length;++i){var column=columns[i];if(column){let max_size=100,y=margin+LiteGraph.NODE_TITLE_HEIGHT;for(let j=0;j<column.length;++j){const node=column[j];node.pos[0]=layout==LiteGraph.VERTICAL_LAYOUT?y:x,node.pos[1]=layout==LiteGraph.VERTICAL_LAYOUT?x:y;var max_size_index=layout==LiteGraph.VERTICAL_LAYOUT?1:0,max_size_index=(node.size[max_size_index]>max_size&&(max_size=node.size[max_size_index]),layout==LiteGraph.VERTICAL_LAYOUT?0:1);y+=node.size[max_size_index]+margin+LiteGraph.NODE_TITLE_HEIGHT}x+=max_size+margin}}this.setDirtyCanvas(!0,!0)}getTime(){return this.globaltime}getFixedTime(){return this.fixedtime}getElapsedTime(){return this.elapsed_time}sendEventToAllNodes(eventname,params,mode=LiteGraph.ALWAYS){var nodes=this._nodes_in_order||this._nodes;if(nodes)for(let j=0,l=nodes.length;j<l;++j){var node=nodes[j];node.constructor===LiteGraph.Subgraph&&"onExecute"!==eventname?node.mode==mode&&node.sendEventToAllNodes(eventname,params,mode):"function"==typeof node[eventname]&&node.mode===mode&&(void 0===params?node[eventname]():Array.isArray(params)?node[eventname].apply(node,params):node[eventname](params))}}sendActionToCanvas(action,params){if(this.list_of_graphcanvas)for(const c of this.list_of_graphcanvas)"function"==typeof c[action]&&c[action]&&params&&c[action](...params)}add(node,skip_compute_order,optsIn={}){optsIn=Object.assign({doProcessChange:!0,doCalcSize:!0},optsIn);if(node)if(node.constructor===LiteGraph.LGraphGroup)this._groups.push(node),this.setDirtyCanvas(!0),this.change(),(node.graph=this).onGraphChanged({action:"groupAdd",doSave:optsIn.doProcessChange});else{if(-1!=node.id&&null!=this._nodes_by_id[node.id]&&(LiteGraph.log_debug("lgraph","add","there is already a node with this ID, changing it",node),LiteGraph.use_uuids?node.id=LiteGraph.uuidv4():node.id=++this.last_node_id),!(0<LiteGraph.MAX_NUMBER_OF_NODES&&this._nodes.length>=LiteGraph.MAX_NUMBER_OF_NODES))return LiteGraph.use_uuids?null!=node.id&&-1!=node.id||(node.id=LiteGraph.uuidv4()):null==node.id||-1==node.id?node.id=++this.last_node_id:this.last_node_id<node.id&&(this.last_node_id=node.id),(node.graph=this).onGraphChanged({action:"nodeAdd",doSave:optsIn.doProcessChange}),this._nodes.push(node),(this._nodes_by_id[node.id]=node).processCallbackHandlers("onAdded",{def_cb:node.onAdded},this),this.config.align_to_grid&&node.alignToGrid(),skip_compute_order||this.updateExecutionOrder(),this.processCallbackHandlers("onNodeAdded",{def_cb:this.onNodeAdded},node),optsIn.doCalcSize&&node.setSize(node.computeSize()),this.setDirtyCanvas(!0),this.change(),node;LiteGraph.log_error("lgraph","add","max number of nodes in a graph reached",LiteGraph.MAX_NUMBER_OF_NODES)}}remove(node){if(node.constructor===LiteGraph.LGraphGroup)-1!=(index=this._groups.indexOf(node))&&this._groups.splice(index,1),node.graph=null,this.onGraphChanged({action:"groupRemove"}),this.setDirtyCanvas(!0,!0),this.change();else if(null!=this._nodes_by_id[node.id]&&!node.ignore_remove){if(node.inputs)for(let i=0;i<node.inputs.length;i++)null!=node.inputs[i].link&&node.disconnectInput(i,{doProcessChange:!1});if(node.outputs)for(let i=0;i<node.outputs.length;i++){let slot=node.outputs[i];null!=slot.links&&slot.links.length&&node.disconnectOutput(i,!1,{doProcessChange:!1})}if(node.processCallbackHandlers("onRemoved",{def_cb:node.onRemoved},this),node.graph=null,this.list_of_graphcanvas)for(let i=0;i<this.list_of_graphcanvas.length;++i){var canvas=this.list_of_graphcanvas[i];canvas.selected_nodes[node.id]&&delete canvas.selected_nodes[node.id],canvas.node_dragged==node&&(canvas.node_dragged=null)}var index=this._nodes.indexOf(node);-1!=index&&this._nodes.splice(index,1),delete this._nodes_by_id[node.id],this.processCallbackHandlers("onNodeRemoved",{def_cb:this.onNodeRemoved},node),this.onGraphChanged({action:"nodeRemove"}),this.sendActionToCanvas("checkPanels"),this.setDirtyCanvas(!0,!0),this.change(),this.updateExecutionOrder()}}getNodeById(id){return null==id?null:this._nodes_by_id[id]}findNodesByClass(classObject,result=0){return this._nodes.filter(node=>node.constructor===classObject)}findNodesByType(type,result=0){const lowerCaseType=type.toLowerCase();return this._nodes.filter(node=>node.type.toLowerCase()===lowerCaseType)}findNodeByTitle(title){return this._nodes.find(node=>node.title===title)??null}findNodesByTitle(title){return this._nodes.filter(node=>node.title===title)}getNodeOnPos(x,y,nodes_list=this._nodes,margin=0){return nodes_list.reverse().find(node=>node.isPointInside(x,y,margin))??null}getGroupOnPos(x,y){var aMatchingGroups=this._groups.filter((group,index)=>group.isPointInside(x,y,2,!0));if(!aMatchingGroups.length)return null;LiteGraph.log_verbose("lgraph","getGroupOnPos","matching groups by x,y",x,y,aMatchingGroups);aMatchingGroups=aMatchingGroups.sort((a,b)=>Math.abs(a._pos[1]-y)>Math.abs(b._pos[1]-y));return LiteGraph.log_verbose("lgraph","getGroupOnPos","sorted groups y distance",aMatchingGroups),aMatchingGroups[0]}checkNodeTypes(){for(var i=0;i<this._nodes.length;i++){var node=this._nodes[i],ctor=LiteGraph.registered_node_types[node.type];node.constructor!=ctor&&(LiteGraph.log_debug("lgraph","checkNodeTypes","node being replaced by newer version",node.type),ctor=LiteGraph.createNode(node.type),(this._nodes[i]=ctor).configure(node.serialize()),(ctor.graph=this)._nodes_by_id[ctor.id]=ctor,node.inputs&&(ctor.inputs=node.inputs.concat()),node.outputs)&&(ctor.outputs=node.outputs.concat())}this.updateExecutionOrder()}onAction(action,param,options){this._input_nodes=this.findNodesByClass(LiteGraph.GraphInput,this._input_nodes),LiteGraph.log_debug("lgraph","onAction","will trigger actionDo on input nodes",this._input_nodes,"with name(?!)",...arguments);for(var i=0;i<this._input_nodes.length;++i){var node=this._input_nodes[i];if(node.properties.name==action){LiteGraph.log_debug("lgraph","onAction",node,"node actionDo",...arguments),node.actionDo(action,param,options);break}}}trigger(action,param){LiteGraph.log_debug("lgraph","trigger",action,param),this.processCallbackHandlers("onTrigger",{def_cb:this.onTrigger},action,param)}addInput(name,type,value){this.inputs[name]||(this.beforeChange(),this.inputs[name]={name:name,type:type,value:value},this.onGraphChanged({action:"addInput"}),this.afterChange(),this.processCallbackHandlers("onInputAdded",{def_cb:this.onInputAdded},name,type),this.processCallbackHandlers("onInputsOutputsChange",{def_cb:this.onInputsOutputsChange}))}setInputData(name,data){name=this.inputs[name];name&&(name.value=data)}getInputData(name){name=this.inputs[name];return name?name.value:null}renameInput(old_name,name){if(name!=old_name)return!!this.inputs[old_name]&&(this.inputs[name]?(LiteGraph.log_error("lgraph","renameInut","there is already one input with that name"),!1):(this.inputs[name]=this.inputs[old_name],delete this.inputs[old_name],this.onGraphChanged({action:"renameInput"}),this.processCallbackHandlers("onInputRenamed",{def_cb:this.onInputRenamed},old_name,name),void this.processCallbackHandlers("onInputsOutputsChange",{def_cb:this.onInputsOutputsChange})))}changeInputType(name,type){if(!this.inputs[name])return!1;this.inputs[name].type&&String(this.inputs[name].type).toLowerCase()==String(type).toLowerCase()||(this.inputs[name].type=type,this.onGraphChanged({action:"changeInputType"}),this.processCallbackHandlers("onInputTypeChanged",{def_cb:this.onInputTypeChanged},name,type),this.processCallbackHandlers("onInputsOutputsChange",{def_cb:this.onInputsOutputsChange}))}removeInput(name){return!!this.inputs[name]&&(delete this.inputs[name],this.onGraphChanged({action:"graphRemoveInput"}),this.processCallbackHandlers("onInputRemoved",{def_cb:this.onInputRemoved},name),this.processCallbackHandlers("onInputsOutputsChange",{def_cb:this.onInputsOutputsChange}),!0)}addOutput(name,type,value){this.outputs[name]={name:name,type:type,value:value},this.onGraphChanged({action:"addOutput"}),this.processCallbackHandlers("onOutputAdded",{def_cb:this.onOutputAdded},name,type),this.processCallbackHandlers("onInputsOutputsChange",{def_cb:this.onInputsOutputsChange})}setOutputData(name,value){name=this.outputs[name];name&&(name.value=value)}getOutputData(name){name=this.outputs[name];return name?name.value:null}renameOutput(old_name,name){return!!this.outputs[old_name]&&(this.outputs[name]?(LiteGraph.log_error("lgraph","renameOutput","there is already one output with that name"),!1):(this.outputs[name]=this.outputs[old_name],delete this.outputs[old_name],this._version++,this.processCallbackHandlers("onOutputRenamed",{def_cb:this.onOutputRenamed},old_name,name),void this.processCallbackHandlers("onInputsOutputsChange",{def_cb:this.onInputsOutputsChange})))}changeOutputType(name,type){if(!this.outputs[name])return!1;this.outputs[name].type&&String(this.outputs[name].type).toLowerCase()==String(type).toLowerCase()||(this.outputs[name].type=type,this.onGraphChanged({action:"changeOutputType"}),this.processCallbackHandlers("onOutputTypeChanged",{def_cb:this.onOutputTypeChanged},name,type),this.processCallbackHandlers("onInputsOutputsChange",{def_cb:this.onInputsOutputsChange}))}removeOutput(name){return!!this.outputs[name]&&(delete this.outputs[name],this.onGraphChanged({action:"removeOutput"}),this.processCallbackHandlers("onOutputRemoved",{def_cb:this.onOutputRemoved},name),this.processCallbackHandlers("onInputsOutputsChange",{def_cb:this.onInputsOutputsChange}),!0)}triggerInput(name,value){for(var nodes=this.findNodesByTitle(name),i=0;i<nodes.length;++i)nodes[i].onTrigger(value)}setCallback(name,func){for(var nodes=this.findNodesByTitle(name),i=0;i<nodes.length;++i)nodes[i].setTrigger(func)}beforeChange(info){this.processCallbackHandlers("onBeforeChange",{def_cb:this.onBeforeChange},this,info),this.sendActionToCanvas("onBeforeChange",this)}afterChange(info){this.processCallbackHandlers("onAfterChange",{def_cb:this.onAfterChange},this,info),this.sendActionToCanvas("onAfterChange",this)}connectionChange(node){this.updateExecutionOrder(),this.processCallbackHandlers("onConnectionChange",{def_cb:this.onConnectionChange},node),this.onGraphChanged({action:"connectionChange",doSave:!1}),this.sendActionToCanvas("onConnectionChange")}isLive(){if(this.list_of_graphcanvas)for(var i=0;i<this.list_of_graphcanvas.length;++i)if(this.list_of_graphcanvas[i].live_mode)return!0;return!1}clearTriggeredSlots(){for(var i in this.links){i=this.links[i];i&&(i._last_time&&=0)}}change(){LiteGraph.log_verbose("lgraph","change","Graph visually changed"),this.sendActionToCanvas("setDirty",[!0,!0]),this.processCallbackHandlers("on_change",{def_cb:this.on_change},this)}setDirtyCanvas(fg,bg){this.sendActionToCanvas("setDirty",[fg,bg])}removeLink(link_id){var node,link_id=this.links[link_id];link_id&&(node=this.getNodeById(link_id.target_id))&&(this.beforeChange(),node.disconnectInput(link_id.target_slot),this.afterChange())}serialize(){var i,nodesInfo=this._nodes.map(node=>node.serialize()),links=[];for(i in this.links){var link=this.links[i];if(!link.serialize){LiteGraph.log_warn("lgraph","serialize","weird LLink bug, link info is not a LLink but a regular object");var j,link2=new LLink;for(j in link)link2[j]=link[j];link=this.links[i]=link2}links.push(link.serialize())}var groupsInfo=this._groups.map(group=>group.serialize()),nodesInfo={last_node_id:this.last_node_id,last_link_id:this.last_link_id,nodes:nodesInfo,links:links,groups:groupsInfo,config:this.config,extra:this.extra,version:LiteGraph.VERSION};return this.processCallbackHandlers("onSerialize",{def_cb:this.onSerialize},nodesInfo),LiteGraph.log_verbose("lgraph","serialize",nodesInfo),nodesInfo}configure(data,keep_old){if(data){keep_old||this.clear();var nodes=data.nodes;if(data.links&&data.links.constructor===Array){for(var links=[],i=0;i<data.links.length;++i){var link,link_data=data.links[i];link_data?((link=new LLink).configure(link_data),links[link.id]=link):LiteGraph.log_warn("lgraph","configure","serialized graph link data contains errors, skipping.",link_data,i,data.links)}data.links=links}for(let i in data)["nodes","groups"].includes(i)||(this[i]=data[i]);var error=!1;if(this._nodes=[],nodes){for(let i=0,l=nodes.length;i<l;++i){var n_info=nodes[i],node=LiteGraph.createNode(n_info.type,n_info.title);node||(LiteGraph.log_warn("lgraph","configure","Node not found or has errors",n_info.type,n_info),(node=new LiteGraph.LGraphNode).last_serialization=n_info,error=node.has_errors=!0),node.id=n_info.id,this.add(node,!0,{doProcessChange:!1})}nodes.forEach(n_info=>{this.getNodeById(n_info.id)?.configure(n_info)})}return this._groups.length=0,data.groups&&data.groups.forEach(groupData=>{var group=new LiteGraph.LGraphGroup;group.configure(groupData),this.add(group,!0,{doProcessChange:!1})}),this.updateExecutionOrder(),this.extra=data.extra??{},this.processCallbackHandlers("onConfigure",{def_cb:this.onConfigure},data),data._version?LiteGraph.log_debug("lgraph","configure","skip onGraphChanged when configure passing version too!"):this.onGraphChanged({action:"graphConfigure",doSave:!1}),this.setDirtyCanvas(!0,!0),error}}load(url,callback){var reader,req,that=this;url.constructor===File||url.constructor===Blob?((reader=new FileReader).addEventListener("load",event=>{event=JSON.parse(event.target.result);that.configure(event),callback?.()}),reader.readAsText(url)):((req=new XMLHttpRequest).open("GET",url,!0),req.send(null),req.onload=_event=>{var data;200!==req.status?LiteGraph.log_error("Error loading graph:",req.status,req.response):(data=JSON.parse(req.response),that.configure(data),callback?.())},req.onerror=err=>{LiteGraph.log_error("Error loading graph:",err)})}onGraphSaved(optsIn={}){optsIn=Object.assign({},optsIn);LiteGraph.log_debug("onGraphSaved",optsIn),this.savedVersion=this._version}onGraphLoaded(optsIn={}){optsIn=Object.assign({},optsIn);LiteGraph.log_debug("onGraphLoaded",optsIn),this.savedVersion=this._version}onGraphChanged(optsIn={}){optsIn=Object.assign({action:"",doSave:!0,doSaveGraph:!0},optsIn);if(this._version++,optsIn.action?LiteGraph.log_debug("Graph change",optsIn.action):LiteGraph.log_debug("Graph change, no action",optsIn),optsIn.doSave&&LiteGraph.actionHistory_enabled){LiteGraph.log_debug("LG_history","onGraphChanged SAVE :: "+optsIn.action);for(var oHistory={actionName:optsIn.action},obH=(optsIn.doSaveGraph&&(oHistory=Object.assign(oHistory,{graphSave:this.serialize()})),this.history);obH.actionHistoryPtr<obH.actionHistoryVersions.length-1;)LiteGraph.log_debug("LG_history","popping: gone back? "+obH.actionHistoryPtr+" < "+(obH.actionHistoryVersions.length-1)),obH.actionHistoryVersions.pop();obH.actionHistoryVersions.length>=LiteGraph.actionHistoryMaxSave&&(optsIn=obH.actionHistoryVersions.shift(),LiteGraph.log_debug("LG_history","maximum saves reached: "+obH.actionHistoryVersions.length+", remove older: "+optsIn),obH.actionHistory[optsIn]=!1),obH.actionHistoryPtr=obH.actionHistoryVersions.length,obH.actionHistoryVersions.push(obH.actionHistoryPtr),obH.actionHistory[obH.actionHistoryPtr]=oHistory,this.onGraphSaved({iVersion:obH.actionHistoryPtr}),LiteGraph.log_debug("LG_history","saved: "+obH.actionHistoryPtr,oHistory.actionName)}}actionHistoryBack(optsIn={}){var optsIn=Object.assign({steps:1},optsIn),obH=this.history;return null!=obH.actionHistoryPtr&&0<=obH.actionHistoryPtr?(obH.actionHistoryPtr-=optsIn.steps,LiteGraph.log_debug("LG_history","step back: "+obH.actionHistoryPtr),this.actionHistoryLoad({iVersion:obH.actionHistoryPtr})?(LiteGraph.log_debug("LG_history","loaded back: "+obH.actionHistoryPtr),LiteGraph.log_debug(this.history),!0):(LiteGraph.log_warn("LG_history","Load failed, restore pointer? "+obH.actionHistoryPtr),obH.actionHistoryPtr+=optsIn.steps,!1)):(LiteGraph.log_debug("LG_history","is already at older state"),!1)}actionHistoryForward(optsIn={}){var optsIn=Object.assign({steps:1},optsIn),obH=this.history;return obH.actionHistoryPtr<obH.actionHistoryVersions.length?(obH.actionHistoryPtr+=optsIn.steps,LiteGraph.log_debug("LG_history","step forward: "+obH.actionHistoryPtr),this.actionHistoryLoad({iVersion:obH.actionHistoryPtr})?(LiteGraph.log_debug("LG_history","loaded forward: "+obH.actionHistoryPtr),!0):(LiteGraph.log_warn("LG_history","Load failed, restore pointer? "+obH.actionHistoryPtr),obH.actionHistoryPtr-=optsIn.steps,!1)):(LiteGraph.log_debug("LG_history","is already at newer state"),!1)}actionHistoryLoad(optsIn={}){var tmpHistory,optsIn=Object.assign({iVersion:!1,backStep:!1},optsIn),obH=this.history;return!(!obH.actionHistory[optsIn.iVersion]||!obH.actionHistory[optsIn.iVersion].graphSave||(tmpHistory=JSON.stringify(this.history),this.configure(obH.actionHistory[optsIn.iVersion].graphSave),this.history=JSON.parse(tmpHistory),LiteGraph.log_debug("history loaded: "+optsIn.iVersion,obH.actionHistory[optsIn.iVersion].actionName),this.onGraphLoaded({iVersion:optsIn.iVersion}),0))}autoConnectNodes(node_from,node_to,optsIn={}){var opts=Object.assign({keep_alredy_connected:!0},optsIn);if(!(node_from&&node_to&&node_from.outputs&&node_from.outputs.length&&node_to.inputs&&node_to.inputs.length))return!1;for(let iO=0;iO<node_from.outputs.length;iO++){var output=node_from.outputs[iO];!opts.keep_alredy_connected&&null!==output.links&&0<output.links.length||node_from.connectByType(iO,node_to,output.type,{preferFreeSlot:!0})}}updateNodeLinks(node,is_input,slots_from,slots_to){for(var i in LiteGraph.log_debug("lgraph","updateNodeLinks","looking for links",node.id,is_input,slots_from,slots_to),this.links){var link_info=this.links[i];null!==link_info&&link_info&&(is_input?link_info.target_id==node.id&&link_info.target_slot==slots_from&&(LiteGraph.log_debug("lgraph","updateNodeLinks","updating link input",this.links[i],node,is_input,slots_from,slots_to),this.links[i].target_slot=slots_to):link_info.origin_id==node.id&&link_info.origin_slot==slots_from&&(LiteGraph.log_debug("lgraph","updateNodeLinks","updating link output",this.links[i],node,is_input,slots_from,slots_to),this.links[i].origin_slot=slots_to))}}}class LGraphCanvas{constructor(canvas,graph,options){this.options=options??={skip_render:!1,autoresize:!1,clip_all_nodes:!1,free_resize:!0,groups_alpha:.21,groups_border_alpha:.45,groups_triangle_handler_size:15,groups_title_font:"Arial",groups_title_alignment:"left",groups_title_font_size:24,groups_title_wrap:!0,groups_add_around_selected:!0,groups_add_default_spacing:15,hide_widget_label_when_small:150},this.callbackhandler_setup(),this.background_image=LGraphCanvas.DEFAULT_BACKGROUND_IMAGE,canvas&&canvas.constructor===String&&(canvas=document.querySelector(canvas)),this.ds=new DragAndScale,this.zoom_modify_alpha=!0,this.title_text_font=LiteGraph.NODE_TEXT_SIZE+"px Arial",this.inner_text_font=`normal ${LiteGraph.NODE_SUBTEXT_SIZE}px Arial`,this.node_title_color=LiteGraph.NODE_TITLE_COLOR,this.default_link_color=LiteGraph.LINK_COLOR,this.default_connection_color={input_off:"#778",input_on:"#7F7",output_off:"#778",output_on:"#7F7"},this.default_connection_color_byType={},this.default_connection_color_byTypeOff={},this.drag_mode=!1,this.dragging_rectangle=null,this.filter=null,this.highquality_render=!0,this.use_gradients=!1,this.editor_alpha=1,this.pause_rendering=!1,this.clear_background=!0,this.clear_background_color="#222",this.read_only=!1,this.live_mode=!1,this.show_info=!0,this.allow_dragcanvas=!0,this.allow_dragnodes=!0,this.allow_interaction=!0,this.multi_select=!1,this.allow_searchbox=!0,this.move_destination_link_without_shift=!1,this.align_to_grid=!1,this.drag_mode=!1,this.dragging_rectangle=null,this.filter=null,this.set_canvas_dirty_on_mouse_event=!0,this.always_render_background=!1,this.render_shadows=!0,this.render_canvas_border=!0,this.render_connections_shadows=!1,this.render_connections_border=!0,this.render_curved_connections=!0,this.render_connection_arrows=!1,this.render_collapsed_slots=!0,this.render_execution_order=!1,this.render_title_colored=!0,this.render_link_tooltip=!0,this.links_render_mode=LiteGraph.SPLINE_LINK,this.autoresize=options.autoresize,this.skip_render=options.skip_render,this.clip_all_nodes=options.clip_all_nodes,this.free_resize=options.free_resize,this.mouse=[0,0],this.graph_mouse=[0,0],this.canvas_mouse=this.graph_mouse,this.onSearchBox=null,this.onSearchBoxSelection=null,this.onMouse=null,this.onDrawBackground=null,this.onDrawForeground=null,this.onDrawOverlay=null,this.onDrawLinkTooltip=null,this.onNodeMoved=null,this.onSelectionChange=null,this.onConnectingChange=null,this.onBeforeChange=null,this.onAfterChange=null,this.connections_width=3,this.round_radius=8,this.current_node=null,this.node_widget=null,this.over_widget=null,this.over_node=null,this.over_link_center=null,this.last_mouse_position=[0,0],this.visible_area=this.ds.visible_area,this.visible_links=[],this.viewport=options.viewport||null,this.low_quality_rendering_threshold=5,graph?.attachCanvas(this),this.setCanvas(canvas,options.skip_events),this.clear(),this.skip_render||options.skip_render||this.startRendering(),this.callbackhandler_setup(),LiteGraph.processCallbackHandlers("on_lgraphcanvas_construct",{def_cb:LiteGraph.on_lgraphcanvas_construct},this)}callbackhandler_setup(){this.cb_handler=new CallbackHandler(this)}registerCallbackHandler(){return this.cb_handler.registerCallbackHandler(...arguments)}unregisterCallbackHandler(){return this.cb_handler.unregisterCallbackHandler(...arguments)}processCallbackHandlers(){return this.cb_handler.processCallbackHandlers(...arguments)}clear(){this.frame=0,this.last_draw_time=0,this.render_time=0,this.fps=0,this.low_quality_rendering_counter=0,this.dragging_rectangle=null,this.selected_nodes={},this.selected_group=null,this.visible_nodes=[],this.node_dragged=null,this.node_over=null,this.node_capturing_input=null,this.connecting_node=null,this.connecting=!1,this.highlighted_links={},this.dragging_canvas=!1,this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.dirty_area=null,this.node_in_panel=null,this.node_widget=null,this.last_mouse=[0,0],this.last_mouseclick=0,this.pointer_is_down=!1,this.pointer_is_double=!1,this.visible_area.set([0,0,0,0]),this.processCallbackHandlers("onClear",{def_cb:this.onClear})}setGraph(graph,skip_clear){this.graph!=graph&&(skip_clear||this.clear(),graph?(graph.attachCanvas(this),LiteGraph.log_debug("lgraphcanvas","setGraph",graph,this),this._graph_stack&&=null,this.setDirty(!0,!0)):this.graph?.detachCanvas(this))}getTopGraph(){return this._graph_stack.length?this._graph_stack[0]:this.graph}openSubgraph(graph){if(!graph)throw new Error("graph cannot be null");if(this.graph==graph)throw new Error("graph cannot be the same");this.clear(),this.graph&&(this._graph_stack||=[],this._graph_stack.push(this.graph));var prev_graph=this.graph;this.processCallbackHandlers("onOpenSubgraph",{def_cb:this.onOpenSubgraph},graph,prev_graph);graph.attachCanvas(this),this.checkPanels(),this.setDirty(!0,!0)}closeSubgraph(){var subgraph_node,prev_graph,graph;this._graph_stack&&0!=this._graph_stack.length&&(subgraph_node=this.graph._subgraph_node,prev_graph=this.graph,graph=this._graph_stack.pop(),this.selected_nodes={},this.highlighted_links={},this.processCallbackHandlers("onCloseSubgraph",{def_cb:this.onCloseSubgraph},graph,prev_graph,subgraph_node),graph.attachCanvas(this),this.setDirty(!0,!0),subgraph_node&&(this.centerOnNode(subgraph_node),this.selectNodes([subgraph_node])),this.ds.offset=[0,0],this.ds.scale=1)}getCurrentGraph(){return this.graph}setCanvas(canvas,skip_events){if(canvas&&canvas.constructor===String&&!(canvas=document.getElementById(canvas)))throw new Error("Error creating LiteGraph canvas: Canvas not found");if(canvas!==this.canvas&&(canvas||!this.canvas||skip_events||this.unbindEvents(),this.canvas=canvas,this.ds.element=canvas)){if(canvas.className+=" lgraphcanvas",canvas.data=this,canvas.tabindex="1",this.bgcanvas=document.createElement("canvas"),this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height,null==canvas.getContext){if("canvas"!=canvas.localName)throw new Error("Element supplied for LGraphCanvas must be a <canvas> element, you passed a "+canvas.localName);throw new Error("This browser doesn't support Canvas")}null==(this.ctx=canvas.getContext("2d"))&&(canvas.webgl_enabled||LiteGraph.log_info("This canvas seems to be WebGL, enabling WebGL renderer"),this.enableWebGL()),skip_events||this.bindEvents()}}_doNothing(e){return LiteGraph.log_verbose("pointerevents: _doNothing "+e.type),e.preventDefault(),!1}_doReturnTrue(e){return e.preventDefault(),!0}bindEvents(){var canvas,document;this._events_binded?LiteGraph.log_warn("LGraphCanvas: events already binded"):(this._events_binded=!0,canvas=this.canvas,document=this.getCanvasWindow().document,this._mousedown_callback=this.processMouseDown.bind(this),this._mousemove_callback=this.processMouseMove.bind(this),this._mouseup_callback=this.processMouseUp.bind(this),canvas.addEventListener("pointerdown",this._mousedown_callback),canvas.addEventListener("pointermove",this._mousemove_callback),canvas.addEventListener("pointerup",this._mouseup_callback),canvas.addEventListener("contextmenu",this._doNothing),canvas.addEventListener("wheel",this.processMouseWheel),canvas.addEventListener("keydown",this.processKey),document.addEventListener("keyup",this.processKey),canvas.addEventListener("dragover",this._doNothing,!1),canvas.addEventListener("dragend",this._doNothing,!1),canvas.addEventListener("drop",this.processDrop),canvas.addEventListener("dragenter",this._doReturnTrue,!1))}unbindEvents(){var canvas,document;this._events_binded?(this._events_binded=!1,canvas=this.canvas,document=this.getCanvasWindow().document,canvas.removeEventListener("pointerdown",this._mousedown_callback),canvas.removeEventListener("pointermove",this._mousemove_callback),canvas.removeEventListener("pointerup",this._mouseup_callback),canvas.removeEventListener("contextmenu",this._doNothing),canvas.removeEventListener("wheel",this.processMouseWheel),canvas.removeEventListener("keydown",this.processKey),document.removeEventListener("keyup",this.processKey),canvas.removeEventListener("dragover",this._doNothing,!1),canvas.removeEventListener("dragend",this._doNothing,!1),canvas.removeEventListener("drop",this.processDrop),canvas.removeEventListener("dragenter",this._doReturnTrue,!1),this._mousedown_callback=null):LiteGraph.log_warn("LGraphCanvas: no events binded")}static getFileExtension(url){return(url=url?url+"":"").slice(2+(url.lastIndexOf(".")-1>>>0)).toLowerCase()}enableWebGL(){if("undefined"==typeof GL)throw new Error("litegl.js must be included to use a WebGL canvas");if("undefined"==typeof enableWebGLCanvas)throw new Error("webglCanvas.js must be included to use this feature");this.gl=this.ctx=enableWebGLCanvas(this.canvas),this.ctx.webgl=!0,this.bgcanvas=this.canvas,this.bgctx=this.gl,this.canvas.webgl_enabled=!0}setDirty(fgcanvas,bgcanvas){fgcanvas&&(this.dirty_canvas=!0),bgcanvas&&(this.dirty_bgcanvas=!0)}getCanvasWindow(){var doc;return this.canvas?(doc=this.canvas.ownerDocument).defaultView??doc.parentWindow:window}startRendering(){function renderFrame(){this.pause_rendering||this.draw();var window=this.getCanvasWindow();this.is_rendering&&window.requestAnimationFrame(renderFrame.bind(this))}this.is_rendering||(this.is_rendering=!0,renderFrame.call(this))}stopRendering(){this.is_rendering=!1}blockClick(){this.block_click=!0,this.last_mouseclick=0}processUserInputDown(e){if(this.pointer_is_down&&void 0!==e.isPrimary&&!e.isPrimary?this.userInput_isNotPrimary=!0:this.userInput_isNotPrimary=!1,this.userInput_type=e.pointerType||!1,this.userInput_id=e.pointerId||!1,e.pointerType)switch(e.pointerType){case"mouse":case"pen":case"touch":break;default:LiteGraph.log_debug("pointerType unknown "+ev.pointerType)}return void 0!==e.button&&(this.userInput_button=e.button,LiteGraph.log_verbose("input button ",e.button),e.button),void 0!==e.buttons&&(this.userInput_button_s=e.buttons,LiteGraph.log_verbose("input button_S ",e.buttons)),this.userInput_touches=void 0!==e.changedTouches&&void 0!==e.changedTouches.length&&e.changedTouches,this.userInput_touches&&this.userInput_touches.length&&LiteGraph.log_debug("check multiTouches",e.changedTouches),this.processMouseDown(e)}processMouseDown(e){if(this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),this.graph){this.adjustMouseEvent(e);var ref_window=this.getCanvasWindow(),x=(LGraphCanvas.active_canvas=this,e.clientX),y=e.clientY,x=(LiteGraph.log_debug("lgraphcanvas","processMouseDown","pointerId:"+e.pointerId+" which:"+e.which+" isPrimary:"+e.isPrimary+" :: x y "+x+" "+y,"previousClick",this.last_mouseclick,"diffTimeClick",this.last_mouseclick?LiteGraph.getTime()-this.last_mouseclick:"notlast"),LiteGraph.log_verbose("coordinates",x,y,this.viewport,"canvas coordinates",e.canvasX,e.canvasY),this.ds.viewport=this.viewport,!this.viewport||this.viewport&&x>=this.viewport[0]&&x<this.viewport[0]+this.viewport[2]&&y>=this.viewport[1]&&y<this.viewport[1]+this.viewport[3]);if(this.options.skip_events||(this.canvas.removeEventListener("pointermove",this._mousemove_callback),ref_window.document.addEventListener("pointermove",this._mousemove_callback,!0),ref_window.document.addEventListener("pointerup",this._mouseup_callback,!0)),x){var node=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes,5),skip_action=!1,y=LiteGraph.getTime(),x=void 0===e.isPrimary||e.isPrimary,is_double_click=y-this.last_mouseclick<300&&x,y=(this.mouse[0]=e.clientX,this.mouse[1]=e.clientY,this.graph_mouse[0]=e.canvasX,this.graph_mouse[1]=e.canvasY,this.last_click_position=[this.mouse[0],this.mouse[1]],this.pointer_is_down&&x?(this.pointer_is_double=!0,LiteGraph.log_verbose("pointerevents: pointer_is_double start")):this.pointer_is_double=!1,this.pointer_is_down=!0,this.canvas.focus(),LiteGraph.ContextMenuClass.closeAll(ref_window),this.processCallbackHandlers("onClear",{def_cb:this.onMouse},e));if(null==y||!1!==y&&("object"!=typeof y||!1!==y.return_value)){if(1!=e.which||this.userInput_isNotPrimary)if(2==e.which)if(LiteGraph.middle_click_slot_add_default_node){if(node&&this.allow_interaction&&!skip_action&&!this.read_only&&!this.connecting_node&&!node.flags.collapsed&&!this.live_mode){var mClikSlot=!1,mClikSlot_index=!1,mClikSlot_isOut=!1;if(node.outputs)for(let i=0,l=node.outputs.length;i<l;++i){var output=node.outputs[i];let link_pos=node.getConnectionPos(!1,i);if(LiteGraph.isInsideRectangle(e.canvasX,e.canvasY,link_pos[0]-15,link_pos[1]-10,30,20)){mClikSlot=output,mClikSlot_index=i,mClikSlot_isOut=!0;break}}if(node.inputs)for(let i=0,l=node.inputs.length;i<l;++i){var input_clk=node.inputs[i];let link_pos=node.getConnectionPos(!0,i);if(LiteGraph.isInsideRectangle(e.canvasX,e.canvasY,link_pos[0]-15,link_pos[1]-10,30,20)){mClikSlot=input_clk,mClikSlot_index=i,mClikSlot_isOut=!1;break}}LiteGraph.log_verbose("middleClickSlots? "+mClikSlot+" & "+(!1!==mClikSlot_index)),mClikSlot&&!1!==mClikSlot_index&&(x=.5-(mClikSlot_index+1)/(mClikSlot_isOut?node.outputs:node.inputs).length,y=node.getBounding(),y=[mClikSlot_isOut?y[0]+y[2]:y[0],e.canvasY-80],this.createDefaultNodeForSlot({nodeFrom:mClikSlot_isOut?node:null,slotFrom:mClikSlot_isOut?mClikSlot_index:null,nodeTo:mClikSlot_isOut?null:node,slotTo:mClikSlot_isOut?null:mClikSlot_index,position:y,nodeType:"AUTO",posAdd:[mClikSlot_isOut?30:-30,130*-x],posSizeFix:[mClikSlot_isOut?0:-1,0]}))}}else!skip_action&&this.allow_dragcanvas&&(LiteGraph.log_verbose("pointerevents: dragging_canvas start from middle button"),this.dragging_canvas=!0);else!(3==e.which||LiteGraph.two_fingers_opens_menu&&this.userInput_isNotPrimary)||!this.allow_interaction||skip_action||this.read_only||(node&&(Object.keys(this.selected_nodes).length&&(this.selected_nodes[node.id]||e.shiftKey||e.ctrlKey||e.metaKey)?this.selected_nodes[node.id]||this.selectNodes([node],!0):this.selectNodes([node])),this.processContextMenu(node,e));else{if(e.ctrlKey&&(LiteGraph.log_debug("lgraphcanvas","processMouseDown","starting box selection"),this.dragging_rectangle=new Float32Array(4),this.dragging_rectangle[0]=e.canvasX,this.dragging_rectangle[1]=e.canvasY,this.dragging_rectangle[2]=1,this.dragging_rectangle[3]=1,skip_action=!0),LiteGraph.alt_drag_do_clone_nodes&&e.altKey&&node&&this.allow_interaction&&!skip_action&&!this.read_only){LiteGraph.log_debug("lgraphcanvas","processMouseDown","cloning node");var original_node=node,y=node.clone();if(y){if(y.pos[0]+=5,y.pos[1]+=5,this.graph.add(y,!1,{doCalcSize:!1}),node=y,LiteGraph.alt_shift_drag_connect_clone_with_input&&e.shiftKey&&(LiteGraph.log_verbose("lgraphcanvas","processMouseDown","altCloned",original_node,node),original_node.inputs)&&original_node.inputs.length)for(var j=0;j<original_node.inputs.length;++j){var ob_link,source_node,target_node,input=original_node.inputs[j];input&&null!=input.link&&((ob_link=this.graph.links[input.link])?ob_link.type===LiteGraph.EVENT?LiteGraph.log_info("lgraphcanvas","processMouseDown","alt drag cloning","skip moving events",input):(ob_link.origin_id&&(source_node=this.graph.getNodeById(ob_link.origin_id)),target_node=node,source_node&&target_node&&(LiteGraph.log_verbose("lgraphcanvas","processMouseDown","alt drag cloning","connect newly created",source_node,target_node,ob_link),source_node.connect(ob_link.origin_slot,target_node,ob_link.target_slot))):LiteGraph.log_warn("lgraphcanvas","processMouseDown","not graph link info for input",input,original_node))}skip_action=!0,block_drag_node||(this.allow_dragnodes&&(this.graph.beforeChange(),this.node_dragged=node),this.selected_nodes[node.id])||this.processNodeSelected(node,e)}}var link_info,x=!1;if(!node||!this.allow_interaction&&!node.flags.allow_interaction||skip_action||this.read_only){if(LiteGraph.log_debug("lgraphcanvas","processMouseDown","clicked outside nodes"),!skip_action){if(!this.read_only)for(let i=0;i<this.visible_links.length;++i){var link=this.visible_links[i],center=link._pos;if(!(!center||e.canvasX<center[0]-4||e.canvasX>center[0]+4||e.canvasY<center[1]-4||e.canvasY>center[1]+4)){LiteGraph.log_debug("lgraphcanvas","processMouseDown","clicked on link",link),this.showLinkMenu(link,e),this.over_link_center=null;break}}this.selected_group=this.graph.getGroupOnPos(e.canvasX,e.canvasY),this.selected_group_resizing=!1,this.selected_group&&!this.read_only&&(LiteGraph.log_debug("lgraphcanvas","processMouseDown","clicked on group",link),e.ctrlKey&&(this.dragging_rectangle=null),LiteGraph.distance([e.canvasX,e.canvasY],[this.selected_group.pos[0]+this.selected_group.size[0],this.selected_group.pos[1]+this.selected_group.size[1]])*this.ds.scale<this.options.groups_triangle_handler_size?this.selected_group_resizing=!0:this.selected_group.recomputeInsideNodes()),is_double_click&&!this.read_only&&this.allow_searchbox&&(LiteGraph.log_debug("lgraphcanvas","processMouseDown","showing search box"),this.showSearchBox(e),e.preventDefault(),e.stopPropagation()),LiteGraph.log_debug("DEBUG canvas click is_double_click,this.allow_searchbox",is_double_click,this.allow_searchbox),x=!0}}else{if(LiteGraph.log_debug("lgraphcanvas","processMouseDown","clicking on node"),this.live_mode||node.flags.pinned||this.bringToFront(node),this.allow_interaction&&!this.connecting_node&&!node.flags.collapsed&&!this.live_mode)if(!skip_action&&!1!==node.resizable&&LiteGraph.isInsideRectangle(e.canvasX,e.canvasY,node.pos[0]+node.size[0]-9,node.pos[1]+node.size[1]-9,18,18))LiteGraph.log_debug("lgraphcanvas","processMouseDown","start resizing node"),this.graph.beforeChange(),this.resizing_node=node,this.canvas.style.cursor="se-resize",skip_action=!0;else{if(node.outputs)for(let i=0,l=node.outputs.length;i<l;++i){let output=node.outputs[i];var link_pos=node.getConnectionPos(!1,i);if(LiteGraph.isInsideRectangle(e.canvasX,e.canvasY,link_pos[0]-15,link_pos[1]-10,30,20)){if(this.connecting_node=node,this.connecting_output=output,this.connecting_output.slot_index=i,this.connecting_pos=node.getConnectionPos(!1,i),this.connecting_slot=i,LiteGraph.log_debug("lgraphcanvas","processMouseDown","clicked on output slot",node,output),LiteGraph.shift_click_do_break_link_from)e.shiftKey&&node.disconnectOutput(i);else if(e.shiftKey){LiteGraph.log_debug("lgraphcanvas","processMouseDown","will move link source slot",this.connecting_node,this.connecting_slot,this.connecting_output,this.connecting_pos);var aOLinks=[],aONodes=[],aOSlots=[],aConnectingInputs=[];if(null!==output.links&&output.links.length)for(var il in output.links){var oNodeX,il=this.graph.links[output.links[il]];il&&this.graph._nodes_by_id[il.target_id]&&(oNodeX=this.graph._nodes_by_id[il.target_id])&&(aOLinks.push(il),aONodes.push(oNodeX),aOSlots.push(il.target_slot),aConnectingInputs.push({node:oNodeX,slot:il.target_slot,link:il}))}if(aOLinks.length){node.disconnectOutput(i),this.connecting_output=!1,this.connecting={inputs:aConnectingInputs},LiteGraph.log_debug("lgraphcanvas","processMouseDown","moving links source slot",this.connecting);let link_info=aOLinks[0];this.connecting_node=this.graph._nodes_by_id[link_info.target_id],this.connecting_slot=link_info.target_slot,this.connecting_input=this.connecting_node.inputs[this.connecting_slot],this.connecting_pos=this.connecting_node.getConnectionPos(!0,this.connecting_slot),skip_action=this.dirty_bgcanvas=!0}}is_double_click?node.processCallbackHandlers("onOutputDblClick",{def_cb:node.onOutputDblClick},i,e):node.processCallbackHandlers("onOutputClick",{def_cb:node.onOutputClick},i,e),skip_action=!0;break}}if(node.inputs)for(let i=0,l=node.inputs.length;i<l;++i){let input=node.inputs[i],link_pos=node.getConnectionPos(!0,i);LiteGraph.isInsideRectangle(e.canvasX,e.canvasY,link_pos[0]-15,link_pos[1]-10,30,20)&&(LiteGraph.log_debug("lgraphcanvas","processMouseDown","clicked on input slot",node,input),is_double_click?node.processCallbackHandlers("onInputDblClick",{def_cb:node.onInputDblClick},i,e):node.processCallbackHandlers("onInputClick",{def_cb:node.onInputDblClick},i,e),null!==input.link&&(link_info=this.graph.links[input.link],LiteGraph.click_do_break_link_to&&(node.disconnectInput(i),skip_action=this.dirty_bgcanvas=!0),e.shiftKey)&&(LiteGraph.click_do_break_link_to||node.disconnectInput(i),this.connecting_node=this.graph._nodes_by_id[link_info.origin_id],this.connecting_slot=link_info.origin_slot,this.connecting_output=this.connecting_node.outputs[this.connecting_slot],this.connecting_pos=this.connecting_node.getConnectionPos(!1,this.connecting_slot),LiteGraph.log_debug("lgraphcanvas","processMouseDown","moving link destination slot",this.connecting_node,this.connecting_slot,this.connecting_output,this.connecting_pos),skip_action=this.dirty_bgcanvas=!0),skip_action||(this.connecting_node=node,this.connecting_input=input,this.connecting_input.slot_index=i,this.connecting_pos=node.getConnectionPos(!0,i),this.connecting_slot=i,skip_action=this.dirty_bgcanvas=!0))}}if(!skip_action){LiteGraph.log_debug("lgraphcanvas","processMouseDown","check clicked on node",node);var block_drag_node=!1,y=[e.canvasX-node.pos[0],e.canvasY-node.pos[1]],widget=this.processNodeWidgets(node,this.graph_mouse,e);widget&&(block_drag_node=!0,this.node_widget=[node,widget]);let cbRet=null;this.allow_interaction&&is_double_click&&this.selected_nodes[node.id]&&(LiteGraph.log_debug("lgraphcanvas","processMouseDown","double clicked on node",node),null!==(cbRet=node.processCallbackHandlers("onDblClick",{def_cb:node.onDblClick},e,y,this))&&(!0===cbRet||"object"==typeof cbRet&&cbRet.return_value)?LiteGraph.log_debug("lgraphcanvas","processMouseDown","dragging blocked by onDblClick",cbRet):this.processNodeDblClicked(node),block_drag_node=!0),null!==(cbRet=node.processCallbackHandlers("onMouseDown",{def_cb:node.onMouseDown},e,y,this))&&(!0===cbRet||"object"==typeof cbRet&&cbRet.return_value)?(LiteGraph.log_debug("lgraphcanvas","processMouseDown","dragging blocked by onMouseDownCbRet",cbRet),block_drag_node=!0):(node.subgraph&&!node.skip_subgraph_button&&(LiteGraph.log_debug("lgraphcanvas","processMouseDown","clicked on subgraph"),!node.flags.collapsed)&&y[0]>node.size[0]-LiteGraph.NODE_TITLE_HEIGHT&&y[1]<0&&setTimeout(()=>{this.openSubgraph(node.subgraph)},10),this.live_mode&&(block_drag_node=x=!0)),block_drag_node?node.is_selected||(LiteGraph.log_debug("lgraphcanvas","processMouseDown","node selected",node),this.processNodeSelected(node,e)):(this.allow_dragnodes&&(LiteGraph.log_debug("lgraphcanvas","processMouseDown","started dragging",node),this.graph.beforeChange(),this.node_dragged=node),this.processNodeSelected(node,e)),this.dirty_canvas=!0}}!skip_action&&x&&this.allow_dragcanvas&&(LiteGraph.log_debug("lgraphcanvas","processMouseDown","dragging_canvas start"),this.dragging_canvas=!0)}return this.last_mouse[0]=e.clientX,this.last_mouse[1]=e.clientY,this.last_mouseclick=LiteGraph.getTime(),this.last_mouse_dragging=!0,this.graph.change(),ref_window.document.activeElement&&("input"==ref_window.document.activeElement.nodeName.toLowerCase()||"textarea"==ref_window.document.activeElement.nodeName.toLowerCase())||e.preventDefault(),e.stopPropagation(),this.processCallbackHandlers("onMouseDown",{def_cb:this.onMouseDown},e),!1}LiteGraph.log_info("lgraphcanvas","processMouseDown","callback prevents continue")}}}processMouseMove(e){if(this.autoresize&&this.resize(),this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),this.graph){(LGraphCanvas.active_canvas=this).adjustMouseEvent(e);var mouse=[e.clientX,e.clientY],delta=(this.mouse[0]=mouse[0],this.mouse[1]=mouse[1],[mouse[0]-this.last_mouse[0],mouse[1]-this.last_mouse[1]]);if(this.last_mouse=mouse,this.graph_mouse[0]=e.canvasX,this.graph_mouse[1]=e.canvasY,this.block_click)LiteGraph.log_verbose("lgraphcanvas","processMouseMove","block_click");else{this.over_widget=!1,e.dragging=this.last_mouse_dragging,this.node_widget&&(this.processNodeWidgets(this.node_widget[0],this.graph_mouse,e,this.node_widget[1]),this.dirty_canvas=!0);var node=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes);if(this.over_node=node,this.dragging_rectangle)LiteGraph.log_verbose("lgraphcanvas","processMouseMove","making rectangle"),this.dragging_rectangle[2]=e.canvasX-this.dragging_rectangle[0],this.dragging_rectangle[3]=e.canvasY-this.dragging_rectangle[1],this.dirty_canvas=!0;else if(this.selected_group&&!this.read_only)this.selected_group_resizing?(LiteGraph.log_verbose("lgraphcanvas","processMouseMove","resizing group"),this.selected_group.size=[e.canvasX-this.selected_group.pos[0],e.canvasY-this.selected_group.pos[1]]):(LiteGraph.log_verbose("lgraphcanvas","processMouseMove","dragging group"),mouse=delta[0]/this.ds.scale,deltay=delta[1]/this.ds.scale,this.selected_group.move(mouse,deltay,e.ctrlKey),this.selected_group._nodes.length&&(this.dirty_canvas=!0),(mouse||deltay)&&this.processCallbackHandlers("onGroupMoving",{def_cb:this.onGroupMoving},this.selected_group,mouse,deltay)),this.dirty_bgcanvas=!0;else if(this.dragging_canvas)LiteGraph.log_verbose("lgraphcanvas","processMouseMove","dragging_canvas"),this.ds.offset[0]+=delta[0]/this.ds.scale,this.ds.offset[1]+=delta[1]/this.ds.scale,this.dirty_canvas=!0,this.dirty_bgcanvas=!0;else if((this.allow_interaction||node&&node.flags.allow_interaction)&&!this.read_only){this.connecting_node&&(this.dirty_canvas=!0);for(let i=0,l=this.graph._nodes.length;i<l;++i)this.graph._nodes[i].mouseOver&&node!=this.graph._nodes[i]&&(this.graph._nodes[i].mouseOver=!1,this.node_over&&this.node_over.processCallbackHandlers("onMouseLeave",{def_cb:this.node_over.onMouseLeave},e),this.node_over=null,this.dirty_canvas=!0);if(node){node.redraw_on_mouse&&(this.dirty_canvas=!0),node.mouseOver||(node.mouseOver=!0,this.node_over=node,this.dirty_canvas=!0,node.processCallbackHandlers("onMouseEnter",{def_cb:node.onMouseEnter},e)),node.processCallbackHandlers("onMouseMove",{def_cb:node.onMouseMove},e,[e.canvasX-node.pos[0],e.canvasY-node.pos[1]],this);var deltay,mouse=this.processNodeWidgets(node,this.graph_mouse);if(mouse&&(this.over_widget=mouse),this.connecting_node){let pos;if(this.connecting_output)pos=this._highlight_input||[0,0],this.isOverNodeBox(node,e.canvasX,e.canvasY)||(-1!=(deltay=this.isOverNodeInput(node,e.canvasX,e.canvasY,pos))&&node.inputs[deltay]?(mouse=node.inputs[deltay].type,LiteGraph.isValidConnection(this.connecting_output.type,mouse)&&(this._highlight_input=pos,this._highlight_input_slot=node.inputs[deltay])):(this._highlight_input=null,this._highlight_input_slot=null));else if(this.connecting_input&&(pos=this._highlight_output||[0,0],this.isOverNodeBox(node,e.canvasX,e.canvasY))){let slot=this.isOverNodeOutput(node,e.canvasX,e.canvasY,pos);if(-1!=slot&&node.outputs[slot]){let slot_type=node.outputs[slot].type;LiteGraph.isValidConnection(this.connecting_input.type,slot_type)&&(this._highlight_output=pos)}else this._highlight_output=null}}this.canvas&&(LiteGraph.isInsideRectangle(e.canvasX,e.canvasY,node.pos[0]+node.size[0]-5,node.pos[1]+node.size[1]-5,5,5)?this.canvas.style.cursor="se-resize":this.canvas.style.cursor="crosshair")}else{var over_link=null;for(let i=0;i<this.visible_links.length;++i){var link=this.visible_links[i],center=link._pos;if(!(!center||e.canvasX<center[0]-4||e.canvasX>center[0]+4||e.canvasY<center[1]-4||e.canvasY>center[1]+4)){over_link=link;break}}over_link!=this.over_link_center&&(this.over_link_center=over_link,this.dirty_canvas=!0),this.canvas&&(this.canvas.style.cursor="")}if(this.node_capturing_input&&this.node_capturing_input!=node&&this.node_capturing_input.processCallbackHandlers("onMouseMove",{def_cb:this.node_capturing_input.onMouseMove},e,[e.canvasX-this.node_capturing_input.pos[0],e.canvasY-this.node_capturing_input.pos[1]],this),this.node_dragged&&!this.live_mode){for(var i in LiteGraph.log_verbose("lgraphcanvas","processMouseMove","draggin!",this.selected_nodes),this.selected_nodes){var i=this.selected_nodes[i],off=[delta[0]/this.ds.scale,delta[1]/this.ds.scale];i.pos[0]+=off[0],i.pos[1]+=off[1],i.is_selected||this.processNodeSelected(i,e),i.processCallbackHandlers("onDrag",{def_cb:i.onDrag},off)}this.dirty_canvas=!0,this.dirty_bgcanvas=!0}this.resizing_node&&!this.live_mode&&(mouse=[e.canvasX-this.resizing_node.pos[0],e.canvasY-this.resizing_node.pos[1]],deltay=this.free_resize?LiteGraph.NODE_MIN_SIZE:this.resizing_node.computeSize(),mouse[0]=Math.max(deltay[0],mouse[0]),mouse[1]=Math.max(deltay[1],mouse[1]),this.resizing_node.setSize(mouse),this.canvas.style.cursor="se-resize",this.dirty_canvas=!0,this.dirty_bgcanvas=!0)}else this.read_only?LiteGraph.log_verbose("lgraphcanvas","processMouseMove","canvas is read only",this):LiteGraph.log_verbose("lgraphcanvas","processMouseMove","interaction not allowed (nor canvas and node)",this.allow_interaction,node.flags)}return e.preventDefault(),!1}LiteGraph.log_warn("lgraphcanvas","processMouseMove","no canvas ref")}processMouseUp(e){var is_primary=void 0===e.isPrimary||e.isPrimary;if(!is_primary)return LiteGraph.log_verbose("pointerevents: processMouseUp pointerN_stop "+e.pointerId+" "+e.isPrimary),!1;if(LiteGraph.log_verbose("pointerevents: processMouseUp "+e.pointerId+" "+e.isPrimary+" :: "+e.clientX+" "+e.clientY),this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),this.graph){var document=this.getCanvasWindow().document,document=((LGraphCanvas.active_canvas=this).options.skip_events||(LiteGraph.log_verbose("pointerevents: processMouseUp adjustEventListener"),document.removeEventListener("pointermove",this._mousemove_callback,!0),this.canvas.addEventListener("pointermove",this._mousemove_callback),document.removeEventListener("pointerup",this._mouseup_callback,!0)),this.adjustMouseEvent(e),LiteGraph.getTime());if(e.click_time=document-this.last_mouseclick,this.last_mouse_dragging=!1,this.last_click_position=null,this.block_click&&(LiteGraph.log_verbose("pointerevents: processMouseUp block_clicks"),this.block_click=!1),LiteGraph.log_verbose("pointerevents: processMouseUp which: "+e.which),1==e.which){this.node_widget&&this.processNodeWidgets(this.node_widget[0],this.graph_mouse,e),this.node_widget=null,this.selected_group&&(document=this.selected_group.pos[0]-Math.round(this.selected_group.pos[0]),diffy=this.selected_group.pos[1]-Math.round(this.selected_group.pos[1]),this.selected_group.move(document,diffy,e.ctrlKey),this.selected_group.pos[0]=Math.round(this.selected_group.pos[0]),this.selected_group.pos[1]=Math.round(this.selected_group.pos[1]),this.selected_group._nodes.length&&(this.dirty_canvas=!0),this.selected_group.recomputeInsideNodes(),this.selected_group_resizing?(this.processCallbackHandlers("onGroupResized",{def_cb:this.onGroupResized},this.selected_group),this.graph.onGraphChanged({action:"groupResize",doSave:!0}),this.graph.afterChange()):(document||diffy)&&(this.processCallbackHandlers("onGroupMoved",{def_cb:this.onGroupMoved},this.selected_group),this.graph.onGraphChanged({action:"groupMove",doSave:!0}),this.graph.afterChange()),this.selected_group=null),this.selected_group_resizing=!1;var node=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes);if(this.dragging_rectangle){if(this.graph){var nodes=this.graph._nodes,node_bounding=new Float32Array(4),document=Math.abs(this.dragging_rectangle[2]),diffy=Math.abs(this.dragging_rectangle[3]),startx=this.dragging_rectangle[2]<0?this.dragging_rectangle[0]-document:this.dragging_rectangle[0],starty=this.dragging_rectangle[3]<0?this.dragging_rectangle[1]-diffy:this.dragging_rectangle[1];if(this.dragging_rectangle[0]=startx,this.dragging_rectangle[1]=starty,this.dragging_rectangle[2]=document,this.dragging_rectangle[3]=diffy,!node||10<document&&10<diffy){LiteGraph.log_debug("lgraphcanvas","processMouseUp","computing box selection for nodes",this.dragging_rectangle);var to_select=[];for(let i=0;i<nodes.length;++i){var nodeX=nodes[i];nodeX.getBounding(node_bounding),LiteGraph.overlapBounding(this.dragging_rectangle,node_bounding)&&to_select.push(nodeX)}to_select.length&&(LiteGraph.log_debug("lgraphcanvas","processMouseUp","selecting nodes",to_select),this.selectNodes(to_select,e.shiftKey))}else this.selectNodes([node],e.shiftKey||e.ctrlKey)}this.dragging_rectangle=null}else if(this.connecting_node){this.dirty_canvas=!0,this.dirty_bgcanvas=!0;startx=(this.connecting_output||this.connecting_input).type;if(node=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes)){let slot;if(this.connecting_output)LiteGraph.log_debug("lgraphcanvas","processMouseUp","connecting_output",this.connecting_output,"connecting_node",this.connecting_node,"connecting_slot",this.connecting_slot),-1!=(slot=this.isOverNodeInput(node,e.canvasX,e.canvasY))?this.connecting_node.connect(this.connecting_slot,node,slot):this.connecting_node.connectByType(this.connecting_slot,node,startx);else if(this.connecting_input)if(LiteGraph.log_debug("lgraphcanvas","processMouseUp","connecting_input",this.connecting_input,"connecting_node",this.connecting_node,"connecting_slot",this.connecting_slot),-1!=(slot=this.isOverNodeOutput(node,e.canvasX,e.canvasY)))if(this.connecting&&this.connecting.inputs)for(var iC in this.connecting.inputs)node.connect(slot,this.connecting.inputs[iC].node,this.connecting.inputs[iC].slot);else node.connect(slot,this.connecting_node,this.connecting_slot);else this.connecting_node.connectByTypeOutput(this.connecting_slot,node,startx)}else LiteGraph.release_link_on_empty_shows_menu&&(e.shiftKey&&this.allow_searchbox?this.connecting_output?this.showSearchBox(e,{node_from:this.connecting_node,slot_from:this.connecting_output,type_filter_in:this.connecting_output.type}):this.connecting_input&&this.showSearchBox(e,{node_to:this.connecting_node,slot_from:this.connecting_input,type_filter_out:this.connecting_input.type}):this.connecting_output?this.showConnectionMenu({nodeFrom:this.connecting_node,slotFrom:this.connecting_output,e:e}):this.connecting_input&&this.showConnectionMenu({nodeTo:this.connecting_node,slotTo:this.connecting_input,e:e}));this.connecting_output=null,this.connecting_input=null,this.connecting_pos=null,this.connecting_node=null,this.connecting_slot=-1,this.connecting=!1}else if(this.resizing_node)this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.graph.afterChange(this.resizing_node),this.resizing_node=null;else if(this.node_dragged){for(var i in(node=this.node_dragged)&&e.click_time<300&&LiteGraph.isInsideRectangle(e.canvasX,e.canvasY,node.pos[0],node.pos[1]-LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT)&&node.collapse(),this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.node_dragged.pos[0]=Math.round(this.node_dragged.pos[0]),this.node_dragged.pos[1]=Math.round(this.node_dragged.pos[1]),(this.graph.config.align_to_grid||this.align_to_grid)&&this.node_dragged.alignToGrid(),this.processCallbackHandlers("onNodeMoved",{def_cb:this.onNodeMoved},this.node_dragged,this.selected_nodes),this.selected_nodes){i=this.selected_nodes[i];i.processCallbackHandlers("onMoved",{def_cb:i.onMoved},this.node_dragged,this.selected_nodes)}this.graph.onGraphChanged({action:"nodeDrag",doSave:!0}),this.graph.afterChange(this.node_dragged),this.node_dragged=null}else!(node=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes))&&e.click_time<300&&this.deselectAllNodes(),this.dirty_canvas=!0,this.dragging_canvas=!1,this.node_over&&this.node_over.processCallbackHandlers("onMouseUp",{def_cb:this.node_over.onMouseUp},e,[e.canvasX-this.node_over.pos[0],e.canvasY-this.node_over.pos[1]],this),this.node_capturing_input&&this.node_capturing_input.processCallbackHandlers("onMouseUp",{def_cb:this.node_capturing_input.onMouseUp},e,[e.canvasX-this.node_capturing_input.pos[0],e.canvasY-this.node_capturing_input.pos[1]])}else(2==e.which||3==e.which)&&(this.dirty_canvas=!0,this.dragging_canvas=!1);return is_primary&&(this.pointer_is_down=!1,this.pointer_is_double=!1),this.graph.change(),LiteGraph.log_verbose("pointerevents: processMouseUp stopPropagation"),e.stopPropagation(),e.preventDefault(),!1}}processMouseWheel=e=>{if(this.graph&&this.allow_dragcanvas){var delta=null!=e.wheelDeltaY?e.wheelDeltaY:-60*e.detail,x=(this.adjustMouseEvent(e),e.clientX),y=e.clientY;if(!this.viewport||this.viewport&&x>=this.viewport[0]&&x<this.viewport[0]+this.viewport[2]&&y>=this.viewport[1]&&y<this.viewport[1]+this.viewport[3])return x=this.ds.scale,0<delta?x*=1.1:delta<0&&(x*=1/1.1),y=e.target.getBoundingClientRect(),this.setZoom(x,[e.clientX-y.left,e.clientY-y.top]),this.graph.change(),e.preventDefault(),!1}};isOverNodeBox(node,canvasx,canvasy){var title_height=LiteGraph.NODE_TITLE_HEIGHT;return!!LiteGraph.isInsideRectangle(canvasx,canvasy,node.pos[0]+2,node.pos[1]+2-title_height,title_height-4,title_height-4)}isOverNodeInput(node,canvasx,canvasy,slot_pos){if(node.inputs)for(let i=0,l=node.inputs.length;i<l;++i){var link_pos=node.getConnectionPos(!0,i);if(node.horizontal?LiteGraph.isInsideRectangle(canvasx,canvasy,link_pos[0]-5,link_pos[1]-10,10,20):LiteGraph.isInsideRectangle(canvasx,canvasy,link_pos[0]-10,link_pos[1]-5,40,10))return slot_pos&&(slot_pos[0]=link_pos[0],slot_pos[1]=link_pos[1]),i}return-1}isOverNodeOutput(node,canvasx,canvasy,slot_pos){if(node.outputs)for(let i=0,l=node.outputs.length;i<l;++i){var link_pos=node.getConnectionPos(!1,i);if(node.horizontal?LiteGraph.isInsideRectangle(canvasx,canvasy,link_pos[0]-5,link_pos[1]-10,10,20):LiteGraph.isInsideRectangle(canvasx,canvasy,link_pos[0]-10,link_pos[1]-5,40,10))return slot_pos&&(slot_pos[0]=link_pos[0],slot_pos[1]=link_pos[1]),i}return-1}processKey=e=>{if(this.graph){var block_default=!1;let r=null;if(LiteGraph.log_verbose("lgraphcanvas","processKey",e),"input"!=e.target.localName){if("keydown"==e.type){if(32==e.keyCode&&(block_default=this.dragging_canvas=!0),27==e.keyCode&&(this.node_panel&&this.node_panel.close(),block_default=!0),65==e.keyCode&&e.ctrlKey&&(this.selectNodes(),block_default=!0),67!==e.keyCode||!e.metaKey&&!e.ctrlKey||e.shiftKey||this.selected_nodes&&(this.copyToClipboard(),block_default=!0),86===e.keyCode&&(e.metaKey||e.ctrlKey)&&this.pasteFromClipboard(e.shiftKey),(46==e.keyCode||LiteGraph.backspace_delete&&8==e.keyCode)&&"input"!=e.target.localName&&"textarea"!=e.target.localName&&(this.deleteSelectedNodes(),block_default=!0),LiteGraph.actionHistory_enabled&&(89==e.keyCode&&e.ctrlKey||90==e.keyCode&&e.ctrlKey&&e.shiftKey?this.graph.actionHistoryForward():90==e.keyCode&&e.ctrlKey&&this.graph.actionHistoryBack()),Object.keys(this.selected_nodes).length)for(var i in this.selected_nodes)null!==(r=this.selected_nodes[i].processCallbackHandlers("onKeyDown",{def_cb:this.selected_nodes[i].onKeyDown},e))&&(!0===r||"object"==typeof r&&!0===r.return_value)&&(LiteGraph.log_debug("lgraphcanvas","processKey","onKeyDown has been processed with result true, prevent event bubbling"),block_default=!0);null!==(r=this.processCallbackHandlers("onKeyDown",{def_cb:this.onKeyDown},e))&&(!0===r||"object"==typeof r&&!0===r.return_value)?(LiteGraph.log_debug("lgraphcanvas","processKey","onKeyDown has been processed with result true, prevent event bubbling"),block_default=!0):LiteGraph.log_verbose("lgraphcanvas","processKey","onKeyDown processed by CB handlers",r)}else if("keyup"==e.type&&(32==e.keyCode&&(this.dragging_canvas=!1),this.selected_nodes))for(let i in this.selected_nodes)this.selected_nodes[i].processCallbackHandlers("onKeyUp",{def_cb:this.selected_nodes[i].onKeyUp},e);return this.graph.change(),block_default?(e.preventDefault(),e.stopImmediatePropagation(),!1):void 0}}};copyToClipboard(){var i,clipboard_info={nodes:[],links:[]},index=0,selected_nodes_array=[];for(i in this.selected_nodes){var node=this.selected_nodes[i];!1!==node.clonable&&(node._relative_id=index,selected_nodes_array.push(node),index+=1)}for(let i=0;i<selected_nodes_array.length;++i){let node=selected_nodes_array[i];if(!1!==node.clonable){var cloned=node.clone();if(cloned){if(clipboard_info.nodes.push(cloned.serialize()),node.inputs&&node.inputs.length)for(var j=0;j<node.inputs.length;++j){var target_node,input=node.inputs[j];input&&null!=input.link&&(input=this.graph.links[input.link])&&(target_node=this.graph.getNodeById(input.origin_id))&&clipboard_info.links.push([target_node._relative_id,input.origin_slot,node._relative_id,input.target_slot,target_node.id])}}else LiteGraph.log_warn("node type not found: "+node.type)}}LiteGraph.log_verbose("copyToClipboard",clipboard_info),localStorage.setItem("litegrapheditor_clipboard",JSON.stringify(clipboard_info))}pasteFromClipboard(isConnectUnselected=!1){if(LiteGraph.ctrl_shift_v_paste_connect_unselected_outputs||!isConnectUnselected){var data=localStorage.getItem("litegrapheditor_clipboard");if(data){this.graph.beforeChange();var clipboard_info=JSON.parse(data),posMin=!1,posMinIndexes=!1;for(let i=0;i<clipboard_info.nodes.length;++i)posMin?(posMin[0]>clipboard_info.nodes[i].pos[0]&&(posMin[0]=clipboard_info.nodes[i].pos[0],posMinIndexes[0]=i),posMin[1]>clipboard_info.nodes[i].pos[1]&&(posMin[1]=clipboard_info.nodes[i].pos[1],posMinIndexes[1]=i)):(posMin=[clipboard_info.nodes[i].pos[0],clipboard_info.nodes[i].pos[1]],posMinIndexes=[i,i]);var nodes=[];for(let i=0;i<clipboard_info.nodes.length;++i){var node_data=clipboard_info.nodes[i],node=LiteGraph.createNode(node_data.type);node&&(node.configure(node_data),node.pos[0]+=this.graph_mouse[0]-posMin[0],node.pos[1]+=this.graph_mouse[1]-posMin[1],this.graph.add(node,{doProcessChange:!1}),nodes.push(node))}for(let i=0;i<clipboard_info.links.length;++i){var link_info=clipboard_info.links[i],origin_node=void 0,origin_node_relative_id=link_info[0],origin_node_relative_id=(null!=origin_node_relative_id?origin_node=nodes[origin_node_relative_id]:LiteGraph.ctrl_shift_v_paste_connect_unselected_outputs&&isConnectUnselected&&(origin_node_relative_id=link_info[4])&&(origin_node=this.graph.getNodeById(origin_node_relative_id)),nodes[link_info[2]]);origin_node&&origin_node_relative_id?origin_node.connect(link_info[1],origin_node_relative_id,link_info[3]):LiteGraph.log_warn("Warning, nodes missing on pasting")}this.selectNodes(nodes),this.graph.onGraphChanged({action:"paste",doSave:!0}),this.graph.afterChange()}}}processDrop=e=>{e.preventDefault(),this.adjustMouseEvent(e);let r=null;var x=e.clientX,y=e.clientY;if(!this.viewport||this.viewport&&x>=this.viewport[0]&&x<this.viewport[0]+this.viewport[2]&&y>=this.viewport[1]&&y<this.viewport[1]+this.viewport[3]){if(x=e.localX,y=e.localY,!this.viewport||this.viewport&&x>=this.viewport[0]&&x<this.viewport[0]+this.viewport[2]&&y>=this.viewport[1]&&y<this.viewport[1]+this.viewport[3]){var pos=[e.canvasX,e.canvasY],node=this.graph?this.graph.getNodeOnPos(pos[0],pos[1]):null;if(LiteGraph.log_verbose("graphcanvas processDrop","going to process",pos,node),node){var files=e.dataTransfer.files;if(files&&files.length)for(let i=0;i<files.length;i++){var reader,type,file=e.dataTransfer.files[0],filename=file.name;LiteGraph.log_debug("lgraphcanvas","processDrop","file on node",file),(r=node.processCallbackHandlers("onDropFile",{def_cb:node.onDropFile},file))&&("object"!=typeof r||r.return_value)||((reader=new FileReader).onload=function(event){event=event.target.result;LiteGraph.log_debug("lgraphcanvas","processDrop","data on node",event,filename,file),node.processCallbackHandlers("onDropData",{def_cb:node.onDropData},event,filename,file)},"text"==(type=file.type.split("/")[0])||""==type?reader.readAsText(file):"image"==type?reader.readAsDataURL(file):reader.readAsArrayBuffer(file))}return!0===(r=node.processCallbackHandlers("onDropItem",{def_cb:node.onDropItem},e))||"object"==typeof r&&r.return_value?!0:!!(!0===(r=this.processCallbackHandlers("onDropItem",{def_cb:this.onDropItem},e))||"object"==typeof r&&r.return_value)||(LiteGraph.log_info("lgraphcanvas","processDrop","neither node and canvas has processed the drop"),!1)}return LiteGraph.log_verbose("lgraphcanvas","processDrop","look for drop implemetation in CANVAS",e),(null===(r=this.processCallbackHandlers("onDropItem",{def_cb:this.onDropItem},e))||!r||"object"==typeof r&&!r.return_value)&&(LiteGraph.log_verbose("lgraphcanvas","processDrop","running default implementation",e),this.checkDropItem(e),null!==r)&&"object"==typeof r?r.return_value:r}LiteGraph.log_debug("graphcanvas processDrop","Outside viewport (local)",x,y)}else LiteGraph.log_debug("graphcanvas processDrop","Outside viewport (client)",x,y)};checkDropItem(e){var file,ext;e.dataTransfer.files.length&&(file=e.dataTransfer.files[0],ext=LGraphCanvas.getFileExtension(file.name),ext=LiteGraph.node_types_by_file_extension[ext])&&(this.graph.beforeChange(),(ext=LiteGraph.createNode(ext.type)).pos=[e.canvasX,e.canvasY],this.graph.add(ext,!1,{doProcessChange:!1}),ext.processCallbackHandlers("onDropFile",{def_cb:ext.onDropFile},file),this.graph.onGraphChanged({action:"fileDrop",doSave:!0}),this.graph.afterChange())}processNodeDblClicked(n){var r=this.processCallbackHandlers("onShowNodePanel",{def_cb:this.onShowNodePanel},n);null!==r&&("object"!=typeof r||null!==r.return_value&&r.return_value)||this.showShowNodePanel(n),this.processCallbackHandlers("onNodeDblClicked",{def_cb:this.onNodeDblClicked},n),this.setDirty(!0)}processNodeSelected(node,e){this.selectNode(node,e&&(e.shiftKey||e.ctrlKey||this.multi_select)),this.processCallbackHandlers("onNodeSelected",{def_cb:this.onNodeSelected},node)}selectNode(node,add_to_current_selection){null==node?this.deselectAllNodes():this.selectNodes([node],add_to_current_selection)}selectNodes(nodes,add_to_current_selection){add_to_current_selection||this.deselectAllNodes(),void 0===(nodes="string"==typeof(nodes=nodes||this.graph._nodes)?[nodes]:nodes).length&&(nodes=[nodes]),Object.values(nodes).forEach(node=>{node.is_selected?this.deselectNode(node):(node.is_selected=!0,(this.selected_nodes[node.id]=node).processCallbackHandlers("onSelected",{def_cb:node.onSelected}),node.inputs?.forEach(input=>{this.highlighted_links[input.link]=!0}),node.outputs?.forEach(out=>{out.links?.forEach(link=>{this.highlighted_links[link]=!0})}))}),this.processCallbackHandlers("onSelectionChange",{def_cb:this.onSelectionChange},this.selected_nodes),this.setDirty(!0)}deselectNode(node){node.is_selected&&(node.processCallbackHandlers("onDeselected",{def_cb:node.onDeselected}),node.is_selected=!1,this.processCallbackHandlers("onNodeDeselected",{def_cb:this.onNodeDeselected},node),node.inputs?.forEach(input=>{delete this.highlighted_links?.[input.link]}),node.outputs?.forEach(out=>{out.links?.forEach(link=>delete this.highlighted_links?.[link])}))}deselectAllNodes(){this.graph&&(this.graph._nodes?.forEach(node=>{node.is_selected&&(node.processCallbackHandlers("onDeselected",{def_cb:node.onDeselected}),node.is_selected=!1,this.processCallbackHandlers("onNodeDeselected",{def_cb:this.onNodeDeselected},node))}),this.selected_nodes={},this.current_node=null,this.highlighted_links={},this.processCallbackHandlers("onSelectionChange",{def_cb:this.onSelectionChange},this.selected_nodes),this.setDirty(!0))}deleteSelectedNodes(){for(var i in this.graph.beforeChange(),this.selected_nodes){var input_link,output_link,input_node,output_node,i=this.selected_nodes[i];i.block_delete||(i.inputs&&i.inputs.length&&i.outputs&&i.outputs.length&&LiteGraph.isValidConnection(i.inputs[0].type,i.outputs[0].type)&&i.inputs[0].link&&i.outputs[0].links&&i.outputs[0].links.length&&(input_link=i.graph.links[i.inputs[0].link],output_link=i.graph.links[i.outputs[0].links[0]],input_node=i.getInputNode(0),output_node=i.getOutputNodes(0)[0],input_node)&&output_node&&input_node.connect(input_link.origin_slot,output_node,output_link.target_slot),this.graph.remove(i),this.processCallbackHandlers("onNodeDeselected",{def_cb:this.onNodeDeselected},i))}this.selected_nodes={},this.current_node=null,this.highlighted_links={},this.setDirty(!0),this.graph.afterChange()}centerOnNode(node){this.ds.offset[0]=-node.pos[0]-.5*node.size[0]+.5*this.canvas.width/this.ds.scale,this.ds.offset[1]=-node.pos[1]-.5*node.size[1]+.5*this.canvas.height/this.ds.scale,this.setDirty(!0,!0)}recenter(){this.ds.offset[0]=0,this.ds.offset[1]=0,this.setDirty(!0,!0)}getMouseCoordinates(){return this.graph_mouse}adjustMouseEvent(e){let clientX_rel=0,clientX=0,clientY_rel=0,clientY=0;if(e.clientX)clientX=e.clientX,clientY=e.clientY;else{var mouseCoord=this.getMouseCoordinates(),mouseCoord=this.convertOffsetToEditorArea(mouseCoord);try{e.clientX=mouseCoord[0],e.clientY=mouseCoord[1]}catch(error){LiteGraph.log_debug("lgraphcanvas","adjustMouseEvent","failed set custom prop on event",e)}clientX=mouseCoord[0],clientY=mouseCoord[1]}clientY_rel=this.canvas?(mouseCoord=this.canvas.getBoundingClientRect(),clientX_rel=clientX-mouseCoord.left,clientY-mouseCoord.top):(clientX_rel=clientX,clientY),this.last_mouse_position[0]=clientX_rel,this.last_mouse_position[1]=clientY_rel,e.canvasX=clientX_rel/this.ds.scale-this.ds.offset[0],e.canvasY=clientY_rel/this.ds.scale-this.ds.offset[1]}setZoom(value,zooming_center){this.ds.changeScale(value,zooming_center),this.dirty_canvas=!0,this.dirty_bgcanvas=!0}convertOffsetToCanvas(pos,out){return this.ds.convertOffsetToCanvas(pos,out)}convertCanvasToOffset(pos,out){return this.ds.convertCanvasToOffset(pos,out)}convertOffsetToEditorArea(pos){var rect=this.canvas.getBoundingClientRect(),pos=this.convertOffsetToCanvas(pos);return[pos[0]+rect.left,pos[1]+rect.top]}convertEventToCanvasOffset(e){var rect=this.canvas.getBoundingClientRect();return this.convertCanvasToOffset([e.clientX-rect.left,e.clientY-rect.top])}cumulativeOffset(element){for(var top=0,left=0;top+=element.offsetTop||0,left+=element.offsetLeft||0,element=element.offsetParent;);return[left,top]}bringToFront(node){var i=this.graph._nodes.indexOf(node);-1!=i&&(this.graph._nodes.splice(i,1),this.graph._nodes.push(node))}sendToBack(node){var i=this.graph._nodes.indexOf(node);-1!=i&&(this.graph._nodes.splice(i,1),this.graph._nodes.unshift(node))}computeVisibleNodes(nodes,out){for(var visible_nodes=out||[],i=visible_nodes.length=0,l=(nodes=nodes||this.graph._nodes).length;i<l;++i){var n=nodes[i];(!this.live_mode||n.onDrawBackground||n.onDrawForeground)&&LiteGraph.overlapBounding(this.visible_area,n.getBounding(temp,!0))&&visible_nodes.push(n)}return visible_nodes}draw(force_canvas,force_bgcanvas){var now;this.canvas&&0!=this.canvas.width&&0!=this.canvas.height&&(now=LiteGraph.getTime(),this.render_time=.001*(now-this.last_draw_time),this.last_draw_time=now,this.graph&&this.ds.computeVisibleArea(this.viewport),(this.dirty_bgcanvas||force_bgcanvas||this.always_render_background||this.graph&&this.graph._last_trigger_time&&now-this.graph._last_trigger_time<1e3)&&this.drawBackCanvas(),(force_bgcanvas=this.dirty_canvas||force_canvas)&&this.drawFrontCanvas(),this.fps=this.render_time?1/this.render_time:0,this.frame+=1,this.ds.scale<.7?force_bgcanvas&&(now=this.low_quality_rendering_threshold,this.fps<45?(this.low_quality_rendering_counter+=45/this.fps,this.low_quality_rendering_counter=Math.min(this.low_quality_rendering_counter,2*now)):(this.low_quality_rendering_counter-=this.fps/45*.01,this.low_quality_rendering_counter=Math.max(this.low_quality_rendering_counter,0))):this.low_quality_rendering_counter=0)}drawFrontCanvas(){this.dirty_canvas=!1,this.ctx||(this.ctx=this.bgcanvas.getContext("2d"));var ctx=this.ctx;if(ctx){var canvas=this.canvas,area=(ctx.start2D&&!this.viewport&&(ctx.start2D(),ctx.restore(),ctx.setTransform(1,0,0,1,0,0)),this.viewport||this.dirty_area);if(area&&(ctx.save(),ctx.beginPath(),ctx.rect(area[0],area[1],area[2],area[3]),ctx.clip()),this.clear_background&&(area?ctx.clearRect(area[0],area[1],area[2],area[3]):ctx.clearRect(0,0,canvas.width,canvas.height)),this.bgcanvas==this.canvas?this.drawBackCanvas():ctx.drawImage(this.bgcanvas,0,0),this.processCallbackHandlers("onRender",{def_cb:this.onRender},canvas,ctx),this.show_info&&this.renderInfo(ctx,area?area[0]:0,area?area[1]:0),this.graph){ctx.save(),this.ds.toCanvasContext(ctx);var visible_nodes=this.computeVisibleNodes(null,this.visible_nodes);for(let i=0;i<visible_nodes.length;++i){var node=visible_nodes[i];ctx.save(),ctx.translate(node.pos[0],node.pos[1]),this.drawNode(node,ctx),ctx.restore()}if(this.render_execution_order&&this.drawExecutionOrder(ctx),!this.graph.config.links_ontop||this.live_mode||this.drawConnections(ctx),null!=this.connecting_pos){ctx.lineWidth=this.connections_width;var shape,link_color=null,canvas=this.connecting_output||this.connecting_input,connType=canvas.type,connDir=canvas.dir,canvas=(null==connDir&&(connDir=this.connecting_output?this.connecting_node.horizontal?LiteGraph.DOWN:LiteGraph.RIGHT:this.connecting_node.horizontal?LiteGraph.UP:LiteGraph.LEFT),canvas.shape);switch(connType){case LiteGraph.EVENT:case LiteGraph.ACTION:link_color=LiteGraph.EVENT_LINK_COLOR;break;default:link_color=LiteGraph.CONNECTING_LINK_COLOR}this.renderLink(ctx,this.connecting_pos,[this.graph_mouse[0],this.graph_mouse[1]],null,!1,null,link_color,connDir,LiteGraph.CENTER),ctx.beginPath(),connType===LiteGraph.EVENT||connType===LiteGraph.ACTION||canvas===LiteGraph.BOX_SHAPE?(ctx.rect(this.connecting_pos[0]-6+.5,this.connecting_pos[1]-5+.5,14,10),ctx.fill(),ctx.beginPath(),ctx.rect(this.graph_mouse[0]-6+.5,this.graph_mouse[1]-5+.5,14,10)):canvas===LiteGraph.ARROW_SHAPE?(ctx.moveTo(this.connecting_pos[0]+8,this.connecting_pos[1]+.5),ctx.lineTo(this.connecting_pos[0]-4,this.connecting_pos[1]+6+.5),ctx.lineTo(this.connecting_pos[0]-4,this.connecting_pos[1]-6+.5),ctx.closePath()):(ctx.arc(this.connecting_pos[0],this.connecting_pos[1],4,0,2*Math.PI),ctx.fill(),ctx.beginPath(),ctx.arc(this.graph_mouse[0],this.graph_mouse[1],4,0,2*Math.PI)),ctx.fill(),ctx.fillStyle="#ffcc00",this._highlight_input&&(ctx.beginPath(),(shape=this._highlight_input_slot.shape)===LiteGraph.ARROW_SHAPE?(ctx.moveTo(this._highlight_input[0]+8,this._highlight_input[1]+.5),ctx.lineTo(this._highlight_input[0]-4,this._highlight_input[1]+6+.5),ctx.lineTo(this._highlight_input[0]-4,this._highlight_input[1]-6+.5),ctx.closePath()):ctx.arc(this._highlight_input[0],this._highlight_input[1],6,0,2*Math.PI),ctx.fill()),this._highlight_output&&(ctx.beginPath(),shape===LiteGraph.ARROW_SHAPE?(ctx.moveTo(this._highlight_output[0]+8,this._highlight_output[1]+.5),ctx.lineTo(this._highlight_output[0]-4,this._highlight_output[1]+6+.5),ctx.lineTo(this._highlight_output[0]-4,this._highlight_output[1]-6+.5),ctx.closePath()):ctx.arc(this._highlight_output[0],this._highlight_output[1],6,0,2*Math.PI),ctx.fill())}this.dragging_rectangle&&(ctx.strokeStyle="#FFF",ctx.strokeRect(this.dragging_rectangle[0],this.dragging_rectangle[1],this.dragging_rectangle[2],this.dragging_rectangle[3])),this.over_link_center&&this.render_link_tooltip?this.drawLinkTooltip(ctx,this.over_link_center):this.processCallbackHandlers("onDrawLinkTooltip",{def_cb:this.onDrawLinkTooltip},ctx,null),this.processCallbackHandlers("onDrawForeground",{def_cb:this.onDrawForeground},ctx,this.visible_rect),ctx.restore()}else LiteGraph.log_warn("lgraphcanvas","drawFrontCanvas","no graph",this);this._graph_stack&&this._graph_stack.length&&this.drawSubgraphPanel(ctx),this.processCallbackHandlers("onDrawOverlay",{def_cb:this.onDrawOverlay},ctx),area&&ctx.restore(),ctx.finish2D?.()}else LiteGraph.log_warn("lgraphcanvas","drawFrontCanvas","no ctx",this)}drawSubgraphPanel(ctx){var subnode,subgraph=this.graph;subgraph&&((subnode=subgraph._subgraph_node)?(this.drawSubgraphPanelLeft(subgraph,subnode,ctx),this.drawSubgraphPanelRight(subgraph,subnode,ctx)):LiteGraph.log_warn("subgraph without subnode"))}drawSubgraphPanelLeft(subgraph,subnode,ctx){var num=subnode.inputs?subnode.inputs.length:0,w=200,h=Math.floor(1.6*LiteGraph.NODE_SLOT_HEIGHT);if(ctx.fillStyle="#111",ctx.globalAlpha=.8,ctx.beginPath(),ctx.roundRect(10,10,w,(num+1)*h+50,[8]),ctx.fill(),ctx.globalAlpha=1,ctx.fillStyle="#888",ctx.font="14px Arial",ctx.textAlign="left",ctx.fillText("Graph Inputs",20,34),this.drawButton(180,20,20,20,"X","#151515"))this.closeSubgraph();else{var y=50;if(ctx.font="14px Arial",subnode.inputs)for(var i=0;i<subnode.inputs.length;++i){var type,newnode,input=subnode.inputs[i];input.not_subgraph_input||(this.drawButton(20,y+2,180,h-2)&&(type=subnode.constructor.input_node_type||"graph/input",this.graph.beforeChange(),(newnode=LiteGraph.createNode(type))?(subgraph.add(newnode,!1,{doProcessChange:!1}),this.block_click=!1,this.last_click_position=null,this.selectNodes([newnode]),this.node_dragged=newnode,this.dragging_canvas=!1,newnode.setProperty("name",input.name),newnode.setProperty("type",input.type),this.node_dragged.pos[0]=this.graph_mouse[0]-5,this.node_dragged.pos[1]=this.graph_mouse[1]-5,this.graph.afterChange()):LiteGraph.log_error("graph input node not found:",type)),ctx.fillStyle="#9C9",ctx.beginPath(),ctx.arc(184,y+.5*h,5,0,2*Math.PI),ctx.fill(),ctx.fillStyle="#AAA",ctx.fillText(input.name,30,y+.75*h),ctx.fillStyle="#777",ctx.fillText(input.type,130,y+.75*h),y+=h)}this.drawButton(20,y+2,180,h-2,"+","#151515","#222")&&this.showSubgraphPropertiesDialog(subnode)}}drawSubgraphPanelRight(subgraph,subnode,ctx){var num=subnode.outputs?subnode.outputs.length:0,canvas_w=this.bgcanvas.width,w=200,h=Math.floor(1.6*LiteGraph.NODE_SLOT_HEIGHT),num=(ctx.fillStyle="#111",ctx.globalAlpha=.8,ctx.beginPath(),ctx.roundRect(canvas_w-w-10,10,w,(num+1)*h+50,[8]),ctx.fill(),ctx.globalAlpha=1,ctx.fillStyle="#888",ctx.font="14px Arial",ctx.textAlign="left",ctx.measureText("Graph Outputs").width);if(ctx.fillText("Graph Outputs",canvas_w-num-20,34),this.drawButton(canvas_w-w,20,20,20,"X","#151515"))this.closeSubgraph();else{var y=50;if(ctx.font="14px Arial",subnode.outputs)for(var i=0;i<subnode.outputs.length;++i){var type,newnode,output=subnode.outputs[i];output.not_subgraph_input||(this.drawButton(canvas_w-w,y+2,180,h-2)&&(type=subnode.constructor.output_node_type||"graph/output",this.graph.beforeChange(),(newnode=LiteGraph.createNode(type))?(subgraph.add(newnode,!1,{doProcessChange:!1}),this.block_click=!1,this.last_click_position=null,this.selectNodes([newnode]),this.node_dragged=newnode,this.dragging_canvas=!1,newnode.setProperty("name",output.name),newnode.setProperty("type",output.type),this.node_dragged.pos[0]=this.graph_mouse[0]-5,this.node_dragged.pos[1]=this.graph_mouse[1]-5,this.graph.afterChange()):LiteGraph.log_error("graph input node not found:",type)),ctx.fillStyle="#9C9",ctx.beginPath(),ctx.arc(canvas_w-w+16,y+.5*h,5,0,2*Math.PI),ctx.fill(),ctx.fillStyle="#AAA",ctx.fillText(output.name,canvas_w-w+30,y+.75*h),ctx.fillStyle="#777",ctx.fillText(output.type,canvas_w-w+130,y+.75*h),y+=h)}this.drawButton(canvas_w-w,y+2,180,h-2,"+","#151515","#222")&&this.showSubgraphPropertiesDialogRight(subnode)}}drawButton(x,y,w,h,text,bgcolor,hovercolor,textcolor){var ctx=this.ctx,pos=(bgcolor=bgcolor||LiteGraph.NODE_DEFAULT_COLOR,hovercolor=hovercolor||"#555",textcolor=textcolor||LiteGraph.NODE_TEXT_COLOR,this.ds.convertOffsetToCanvas(this.graph_mouse)),hover=LiteGraph.isInsideRectangle(pos[0],pos[1],x,y,w,h),rect=((pos=this.last_click_position?[this.last_click_position[0],this.last_click_position[1]]:null)&&(rect=this.canvas.getBoundingClientRect(),pos[0]-=rect.left,pos[1]-=rect.top),pos&&LiteGraph.isInsideRectangle(pos[0],pos[1],x,y,w,h)),pos=(ctx.fillStyle=hover?hovercolor:bgcolor,rect&&(ctx.fillStyle="#AAA"),ctx.beginPath(),ctx.roundRect(x,y,w,h,[4]),ctx.fill(),null!=text&&text.constructor==String&&(ctx.fillStyle=textcolor,ctx.textAlign="center",ctx.font=(.65*h|0)+"px Arial",ctx.fillText(text,x+.5*w,y+.75*h),ctx.textAlign="left"),rect&&!this.block_click);return rect&&this.blockClick(),pos}isAreaClicked(x,y,w,h,hold_click){var pos=this.last_click_position,pos=pos&&LiteGraph.isInsideRectangle(pos[0],pos[1],x,y,w,h),x=pos&&!this.block_click;return pos&&hold_click&&this.blockClick(),x}renderInfo(ctx,x,y){x=x||10,y=y||this.canvas.height-80,ctx.save(),ctx.translate(x,y),ctx.font="10px Arial",ctx.fillStyle="#888",ctx.textAlign="left",this.graph?(ctx.fillText("T: "+this.graph.globaltime.toFixed(2)+"s",5,13),ctx.fillText("I: "+this.graph.iteration,5,26),ctx.fillText("N: "+this.graph._nodes.length+" ["+this.visible_nodes.length+"]",5,39),ctx.fillText("V: "+this.graph._version,5,52),ctx.fillText("FPS:"+this.fps.toFixed(2),5,65)):ctx.fillText("No graph selected",5,13),ctx.restore()}drawBackCanvas(){var canvas=this.bgcanvas,ctx=(this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height,this.bgctx||(this.bgctx=this.bgcanvas.getContext("2d")),this.bgctx),viewport=(ctx.start&&ctx.start(),this.viewport||[0,0,ctx.canvas.width,ctx.canvas.height]);if(this.clear_background&&ctx.clearRect(viewport[0],viewport[1],viewport[2],viewport[3]),this._graph_stack&&this._graph_stack.length){ctx.save();viewport=this.graph._subgraph_node;ctx.strokeStyle=viewport.bgcolor,ctx.lineWidth=10,ctx.strokeRect(1,1,canvas.width-2,canvas.height-2),ctx.lineWidth=1,ctx.font="40px Arial",ctx.textAlign="center",ctx.fillStyle=viewport.bgcolor||"#AAA";let title="";this._graph_stack.slice(1).forEach((item,index)=>{title+=item._subgraph_node.getTitle()+" "+(index<this._graph_stack.length-2?">> ":"")}),ctx.fillText(title+viewport.getTitle(),.5*canvas.width,40),ctx.restore()}var that,viewport=!1,r=this.processCallbackHandlers("onRenderBackground",{def_cb:this.onRenderBackground},canvas,ctx);null!==r&&(!0===r||"object"==typeof r&&!0===r.return_value)&&(viewport=!0),this.viewport||(ctx.restore(),ctx.setTransform(1,0,0,1,0,0)),this.visible_links.length=0,this.graph&&(ctx.save(),this.ds.toCanvasContext(ctx),this.ds.scale<1.5&&!viewport&&this.clear_background_color&&(ctx.fillStyle=this.clear_background_color,ctx.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3])),this.background_image&&.5<this.ds.scale&&!viewport&&(this.zoom_modify_alpha?ctx.globalAlpha=(1-.5/this.ds.scale)*this.editor_alpha:ctx.globalAlpha=this.editor_alpha,ctx.imageSmoothingEnabled=ctx.imageSmoothingEnabled=!1,this._bg_img&&this._bg_img.name==this.background_image||(this._bg_img=new Image,this._bg_img.name=this.background_image,this._bg_img.src=this.background_image,(that=this)._bg_img.onload=function(){that.draw(!0,!0)}),(r=null)==this._pattern&&0<this._bg_img.width?(r=ctx.createPattern(this._bg_img,"repeat"),this._pattern_img=this._bg_img,this._pattern=r):r=this._pattern,r&&(ctx.fillStyle=r,ctx.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3]),ctx.fillStyle="transparent"),ctx.globalAlpha=1,ctx.imageSmoothingEnabled=ctx.imageSmoothingEnabled=!0),this.graph._groups.length&&!this.live_mode&&this.drawGroups(canvas,ctx),this.processCallbackHandlers("onDrawBackground",{def_cb:this.onDrawBackground},ctx,this.visible_area),this.onBackgroundRender&&(LiteGraph.log_error("WARNING! onBackgroundRender deprecated, now is named onDrawBackground "),this.onBackgroundRender=null),this.render_canvas_border&&(ctx.strokeStyle="#235",ctx.strokeRect(0,0,canvas.width,canvas.height)),this.render_connections_shadows?(ctx.shadowColor="#000",ctx.shadowOffsetX=0,ctx.shadowOffsetY=0,ctx.shadowBlur=6):ctx.shadowColor="rgba(0,0,0,0)",this.live_mode||this.drawConnections(ctx),ctx.shadowColor="rgba(0,0,0,0)",ctx.restore()),ctx.finish?.(),this.dirty_bgcanvas=!1,this.dirty_canvas=!0}drawNode(node,ctx){var color=(this.current_node=node).color||node.constructor.color||LiteGraph.NODE_DEFAULT_COLOR,bgcolor=node.bgcolor||node.constructor.bgcolor||LiteGraph.NODE_DEFAULT_BGCOLOR,low_quality=this.ds.scale<.6;if(this.live_mode)node.flags.collapsed||(ctx.shadowColor="transparent",node.processCallbackHandlers("onDrawForeground",{def_cb:node.onDrawForeground},ctx,this,this.canvas));else{var editor_alpha=this.editor_alpha;if(ctx.globalAlpha=editor_alpha,this.render_shadows&&!low_quality?(ctx.shadowColor=LiteGraph.DEFAULT_SHADOW_COLOR,ctx.shadowOffsetX=2*this.ds.scale,ctx.shadowOffsetY=2*this.ds.scale,ctx.shadowBlur=3*this.ds.scale):ctx.shadowColor="transparent",node.flags.collapsed){var r=node.processCallbackHandlers("onDrawCollapsed",{def_cb:node.onDrawCollapsed},ctx,this);if(null!==r&&(!0===r||"object"==typeof r&&!0===r.return_value))return}var doStroke,title,r=node._shape||LiteGraph.BOX_SHAPE,size=temp_vec2,horizontal=(temp_vec2.set(node.size),node.horizontal),render_text=(node.flags.collapsed&&(ctx.font=this.title_text_font,null!=(title=node.getTitle?node.getTitle():node.title))&&(node._collapsed_width=Math.min(node.size[0],ctx.measureText(title).width+2*LiteGraph.NODE_TITLE_HEIGHT),size[0]=node._collapsed_width,size[1]=0),(node.clip_area||this.clip_all_nodes)&&(ctx.save(),ctx.beginPath(),r==LiteGraph.BOX_SHAPE?ctx.rect(0,0,size[0],size[1]):r==LiteGraph.ROUND_SHAPE?ctx.roundRect(0,0,size[0],size[1],[10]):r==LiteGraph.CIRCLE_SHAPE&&ctx.arc(.5*size[0],.5*size[1],.5*size[0],0,2*Math.PI),ctx.clip()),node.has_errors&&(bgcolor="red"),this.drawNodeShape(node,ctx,size,color,bgcolor,node.is_selected,node.mouseOver),ctx.shadowColor="transparent",node.processCallbackHandlers("onDrawForeground",{def_cb:node.onDrawForeground},ctx,this,this.canvas),LiteGraph.show_node_tooltip&&node.mouseOver&&node.is_selected&&(!this.selected_nodes||Object.keys(this.selected_nodes).length<=1)&&this.drawNodeTooltip(ctx,node),ctx.textAlign=horizontal?"center":"left",ctx.font=this.inner_text_font,!this.lowQualityRenderingRequired(.6)),out_slot=this.connecting_output,in_slot=this.connecting_input,max_y=(ctx.lineWidth=1,0),slot_pos=new Float32Array(2);if(node.flags.collapsed){if(this.render_collapsed_slots){var input_slot=null,output_slot=null;if(node.inputs)for(let i=0;i<node.inputs.length;i++){var slot_i=node.inputs[i];if(null!=slot_i.link){input_slot=slot_i;break}}if(node.outputs)for(let i=0;i<node.outputs.length;i++){var slot_o=node.outputs[i];slot_o.links&&slot_o.links.length&&(output_slot=slot_o)}if(input_slot){let x=0,y=-.5*LiteGraph.NODE_TITLE_HEIGHT;horizontal&&(x=.5*node._collapsed_width,y=-LiteGraph.NODE_TITLE_HEIGHT),ctx.fillStyle="#686",ctx.beginPath(),input_slot.type===LiteGraph.EVENT||input_slot.type===LiteGraph.ACTION||input_slot.shape===LiteGraph.BOX_SHAPE?ctx.rect(x-7+.5,y-4,14,8):input_slot.shape===LiteGraph.ARROW_SHAPE?(ctx.moveTo(x+8,y),ctx.lineTo(x+-4,y-4),ctx.lineTo(x+-4,y+4),ctx.closePath()):ctx.arc(x,y,4,0,2*Math.PI),ctx.fill()}if(output_slot){let x=node._collapsed_width,y=-.5*LiteGraph.NODE_TITLE_HEIGHT;horizontal&&(x=.5*node._collapsed_width,y=0),ctx.fillStyle="#686",ctx.strokeStyle="black",ctx.beginPath(),output_slot.type===LiteGraph.EVENT||output_slot.type===LiteGraph.ACTION||output_slot.shape===LiteGraph.BOX_SHAPE?ctx.rect(x-7+.5,y-4,14,8):output_slot.shape===LiteGraph.ARROW_SHAPE?(ctx.moveTo(x+6,y),ctx.lineTo(x-6,y-4),ctx.lineTo(x-6,y+4),ctx.closePath()):ctx.arc(x,y,4,0,2*Math.PI),ctx.fill()}}}else{if(node.inputs)for(let i=0;i<node.inputs.length;i++){var slot=node.inputs[i],slot_type=slot.type;let slot_shape=slot.shape;ctx.globalAlpha=editor_alpha,this.connecting_output&&!LiteGraph.isValidConnection(slot.type,out_slot.type)&&(ctx.globalAlpha=.4*editor_alpha),ctx.fillStyle=null!=slot.link?slot.color_on||this.default_connection_color_byType[slot_type]||this.default_connection_color.input_on:slot.color_off||this.default_connection_color_byTypeOff[slot_type]||this.default_connection_color_byType[slot_type]||this.default_connection_color.input_off;var pos=node.getConnectionPos(!0,i,slot_pos);pos[0]-=node.pos[0],pos[1]-=node.pos[1],max_y<pos[1]+.5*LiteGraph.NODE_SLOT_HEIGHT&&(max_y=pos[1]+.5*LiteGraph.NODE_SLOT_HEIGHT),ctx.beginPath(),"array"==slot_type?slot_shape=LiteGraph.GRID_SHAPE:"onTrigger"==slot.name||"onExecuted"==slot.name?slot_shape=LiteGraph.ARROW_SHAPE:slot_type!==LiteGraph.EVENT&&slot_type!==LiteGraph.ACTION||(slot_shape=LiteGraph.BOX_SHAPE),doStroke=!0,slot_shape===LiteGraph.BOX_SHAPE?horizontal?ctx.rect(pos[0]-5+.5,pos[1]-8+.5,10,14):ctx.rect(pos[0]-6+.5,pos[1]-5+.5,14,10):slot_shape===LiteGraph.ARROW_SHAPE?(ctx.moveTo(pos[0]+8,pos[1]+.5),ctx.lineTo(pos[0]-4,pos[1]+6+.5),ctx.lineTo(pos[0]-4,pos[1]-6+.5),ctx.closePath()):slot_shape===LiteGraph.GRID_SHAPE?(ctx.rect(pos[0]-4,pos[1]-4,2,2),ctx.rect(pos[0]-1,pos[1]-4,2,2),ctx.rect(pos[0]+2,pos[1]-4,2,2),ctx.rect(pos[0]-4,pos[1]-1,2,2),ctx.rect(pos[0]-1,pos[1]-1,2,2),ctx.rect(pos[0]+2,pos[1]-1,2,2),ctx.rect(pos[0]-4,pos[1]+2,2,2),ctx.rect(pos[0]-1,pos[1]+2,2,2),ctx.rect(pos[0]+2,pos[1]+2,2,2),doStroke=!1):low_quality?ctx.rect(pos[0]-4,pos[1]-4,8,8):ctx.arc(pos[0],pos[1],4,0,2*Math.PI),ctx.fill(),render_text&&"onTrigger"!=slot.name&&"onExecuted"!=slot.name&&(slot_type=null!=slot.label?slot.label:slot.name)&&(ctx.fillStyle=LiteGraph.NODE_TEXT_COLOR,horizontal||slot.dir==LiteGraph.UP?ctx.fillText(slot_type,pos[0],pos[1]-10):ctx.fillText(slot_type,pos[0]+10,pos[1]+5))}if(ctx.textAlign=horizontal?"center":"right",ctx.strokeStyle="black",node.outputs)for(let i=0;i<node.outputs.length;i++){let slot=node.outputs[i],slot_type=slot.type,slot_shape=slot.shape,pos=(this.connecting_input&&!LiteGraph.isValidConnection(slot_type,in_slot.type)&&(ctx.globalAlpha=.4*editor_alpha),node.getConnectionPos(!1,i,slot_pos));if(pos[0]-=node.pos[0],pos[1]-=node.pos[1],max_y<pos[1]+.5*LiteGraph.NODE_SLOT_HEIGHT&&(max_y=pos[1]+.5*LiteGraph.NODE_SLOT_HEIGHT),ctx.fillStyle=slot.links&&slot.links.length?slot.color_on||this.default_connection_color_byType[slot_type]||this.default_connection_color.output_on:slot.color_off||this.default_connection_color_byTypeOff[slot_type]||this.default_connection_color_byType[slot_type]||this.default_connection_color.output_off,ctx.beginPath(),"array"==slot_type?slot_shape=LiteGraph.GRID_SHAPE:"onTrigger"==slot.name||"onExecuted"==slot.name?slot_shape=LiteGraph.ARROW_SHAPE:slot_type!==LiteGraph.EVENT&&slot_type!==LiteGraph.ACTION||(slot_shape=LiteGraph.BOX_SHAPE),doStroke=!0,slot_shape===LiteGraph.BOX_SHAPE?horizontal?ctx.rect(pos[0]-5+.5,pos[1]-8+.5,10,14):ctx.rect(pos[0]-6+.5,pos[1]-5+.5,14,10):slot_shape===LiteGraph.ARROW_SHAPE?(ctx.moveTo(pos[0]+8,pos[1]+.5),ctx.lineTo(pos[0]-4,pos[1]+6+.5),ctx.lineTo(pos[0]-4,pos[1]-6+.5),ctx.closePath()):slot_shape===LiteGraph.GRID_SHAPE?(ctx.rect(pos[0]-4,pos[1]-4,2,2),ctx.rect(pos[0]-1,pos[1]-4,2,2),ctx.rect(pos[0]+2,pos[1]-4,2,2),ctx.rect(pos[0]-4,pos[1]-1,2,2),ctx.rect(pos[0]-1,pos[1]-1,2,2),ctx.rect(pos[0]+2,pos[1]-1,2,2),ctx.rect(pos[0]-4,pos[1]+2,2,2),ctx.rect(pos[0]-1,pos[1]+2,2,2),ctx.rect(pos[0]+2,pos[1]+2,2,2),doStroke=!1):low_quality?ctx.rect(pos[0]-4,pos[1]-4,8,8):ctx.arc(pos[0],pos[1],4,0,2*Math.PI),ctx.fill(),!low_quality&&doStroke&&ctx.stroke(),render_text&&"onTrigger"!=slot.name&&"onExecuted"!=slot.name){let text=null!=slot.label?slot.label:slot.name;text&&(ctx.fillStyle=LiteGraph.NODE_TEXT_COLOR,horizontal||slot.dir==LiteGraph.DOWN?ctx.fillText(text,pos[0],pos[1]-8):ctx.fillText(text,pos[0]-10,pos[1]+5))}}ctx.textAlign="left",ctx.globalAlpha=1,node.widgets&&(title=max_y,(horizontal||node.widgets_up)&&(title=2),null!=node.widgets_start_y&&(title=node.widgets_start_y),this.drawNodeWidgets(node,title,ctx,this.node_widget&&this.node_widget[0]==node?this.node_widget[1]:null))}(node.clip_area||this.clip_all_nodes)&&ctx.restore(),ctx.globalAlpha=1}}drawNodeTooltip(ctx,node){var pos,size,w,h,text;node&&ctx?((text=null!=node.properties.tooltip?node.properties.tooltip:"")&&""!=text||LiteGraph.show_node_tooltip_use_descr_property&&node.constructor.desc&&(text=node.constructor.desc),(text=(text+"").trim())&&""!=text&&(pos=[0,-LiteGraph.NODE_TITLE_HEIGHT],size=node.flags.collapsed?[LiteGraph.NODE_COLLAPSED_WIDTH,LiteGraph.NODE_TITLE_HEIGHT]:node.size,ctx.font="14px Courier New",w=Math.max(node.size[0],160)+20,h=node.ttip_oTMultiRet?node.ttip_oTMultiRet.height+15:21,ctx.globalAlpha=.7*this.editor_alpha,ctx.shadowColor=node.ttip_oTMultiRet?"black":"transparent",ctx.shadowOffsetX=2,ctx.shadowOffsetY=2,ctx.shadowBlur=3,ctx.fillStyle=node.ttip_oTMultiRet?"#454":"transparent",ctx.beginPath(),ctx.roundRect(pos[0]-.5*w+size[0]/2,pos[1]-15-h,w,h,[3]),ctx.moveTo(pos[0]-10+size[0]/2,pos[1]-15),ctx.lineTo(pos[0]+10+size[0]/2,pos[1]-15),ctx.lineTo(pos[0]+size[0]/2,pos[1]-5),ctx.fill(),ctx.shadowColor="transparent",ctx.textAlign="center",ctx.fillStyle=node.ttip_oTMultiRet?"#CEC":"transparent",ctx.globalAlpha=this.editor_alpha,text=LiteGraph.canvasFillTextMultiline(ctx,text,pos[0]+size[0]/2,pos[1]-h,w,14),node.ttip_oTMultiRet=text,ctx.closePath())):LiteGraph.log_warn("drawNodeTooltip: invalid node or ctx",node,ctx)}drawLinkTooltip(ctx,link){var r,pos=link._pos;ctx.fillStyle="black",ctx.beginPath(),ctx.arc(pos[0],pos[1],3,0,2*Math.PI),ctx.fill(),null==link.data||null!==(r=this.processCallbackHandlers("onDrawLinkTooltip",{def_cb:this.onDrawLinkTooltip},ctx,link,this))&&(!0===r||"object"==typeof r&&!0===r.return_value)||(r=null)==(r=(link=link.data).constructor===Number?link.toFixed(2):link.constructor===String?'"'+link+'"':link.constructor===Boolean?String(link):link.toToolTip?link.toToolTip():"["+link.constructor.name+"]")||(r=r.substr(0,30),ctx.font="14px Courier New",link=ctx.measureText(r).width+20,ctx.shadowColor="black",ctx.shadowOffsetX=2,ctx.shadowOffsetY=2,ctx.shadowBlur=3,ctx.fillStyle="#454",ctx.beginPath(),ctx.roundRect(pos[0]-.5*link,pos[1]-15-24,link,24,[3]),ctx.moveTo(pos[0]-10,pos[1]-15),ctx.lineTo(pos[0]+10,pos[1]-15),ctx.lineTo(pos[0],pos[1]-5),ctx.fill(),ctx.shadowColor="transparent",ctx.textAlign="center",ctx.fillStyle="#CEC",ctx.fillText(r,pos[0],pos[1]-15-24*.3))}drawNodeShape(node,ctx,size,fgcolor,bgcolor,selected,mouse_over){ctx.strokeStyle=fgcolor,ctx.fillStyle=bgcolor;var bgcolor=LiteGraph.NODE_TITLE_HEIGHT,low_quality=this.lowQualityRenderingRequired(.5),shape=node._shape||node.constructor.shape||LiteGraph.ROUND_SHAPE,title_mode=node.constructor.title_mode,render_title=!0,mouse_over=(title_mode==LiteGraph.TRANSPARENT_TITLE||title_mode==LiteGraph.NO_TITLE?render_title=!1:title_mode==LiteGraph.AUTOHIDE_TITLE&&mouse_over&&(render_title=!0),tmp_area),old_alpha=(mouse_over[0]=0,mouse_over[1]=render_title?-bgcolor:0,mouse_over[2]=size[0]+1,mouse_over[3]=render_title?size[1]+bgcolor:size[1],ctx.globalAlpha);if(ctx.beginPath(),shape==LiteGraph.BOX_SHAPE||low_quality?ctx.fillRect(mouse_over[0],mouse_over[1],mouse_over[2],mouse_over[3]):shape==LiteGraph.ROUND_SHAPE||shape==LiteGraph.CARD_SHAPE?ctx.roundRect(mouse_over[0],mouse_over[1],mouse_over[2],mouse_over[3],shape==LiteGraph.CARD_SHAPE?[this.round_radius,this.round_radius,0,0]:[this.round_radius]):shape==LiteGraph.CIRCLE_SHAPE&&ctx.arc(.5*size[0],.5*size[1],.5*size[0],0,2*Math.PI),ctx.fill(),!node.flags.collapsed&&render_title&&(ctx.shadowColor="transparent",ctx.fillStyle="rgba(0,0,0,0.2)",ctx.fillRect(0,-1,mouse_over[2],2)),ctx.shadowColor="transparent",node.processCallbackHandlers("onDrawBackground",{def_cb:node.onDrawBackground},ctx,this,this.canvas,this.graph_mouse),render_title||title_mode==LiteGraph.TRANSPARENT_TITLE){null!==(render_title=node.processCallbackHandlers("onDrawTitleBar",{def_cb:node.onDrawTitleBar},ctx,bgcolor,size,this.ds.scale,fgcolor))&&(!0===render_title||"object"==typeof render_title&&!0===render_title.return_value)||title_mode!=LiteGraph.TRANSPARENT_TITLE&&(node.constructor.title_color||this.render_title_colored)&&(title_color=node.constructor.title_color||fgcolor,node.flags.collapsed&&(ctx.shadowColor=LiteGraph.DEFAULT_SHADOW_COLOR),this.use_gradients?((grad=LGraphCanvas.gradients[title_color])||((grad=LGraphCanvas.gradients[title_color]=ctx.createLinearGradient(0,0,400,0)).addColorStop(0,title_color),grad.addColorStop(1,"#000")),ctx.fillStyle=grad):ctx.fillStyle=title_color,ctx.beginPath(),shape==LiteGraph.BOX_SHAPE||low_quality?ctx.rect(0,-bgcolor,size[0]+1,bgcolor):shape!=LiteGraph.ROUND_SHAPE&&shape!=LiteGraph.CARD_SHAPE||ctx.roundRect(0,-bgcolor,size[0]+1,bgcolor,node.flags.collapsed?[this.round_radius]:[this.round_radius,this.round_radius,0,0]),ctx.fill(),ctx.shadowColor="transparent");let colState=!1;LiteGraph.node_box_coloured_by_mode&&LiteGraph.NODE_MODES_COLORS[node.mode]&&(colState=LiteGraph.NODE_MODES_COLORS[node.mode]),LiteGraph.node_box_coloured_when_on&&(colState=node.action_triggered?"#FFF":node.execute_triggered?"#AAA":colState);var grad,title_color;null!==(render_title=node.processCallbackHandlers("onDrawTitleBox",{def_cb:node.onDrawTitleBox},ctx,bgcolor,size,this.ds.scale))&&(!0===render_title||"object"==typeof render_title&&!0===render_title.return_value)||(shape==LiteGraph.ROUND_SHAPE||shape==LiteGraph.CIRCLE_SHAPE||shape==LiteGraph.CARD_SHAPE?(low_quality&&(ctx.fillStyle="black",ctx.beginPath(),ctx.arc(.5*bgcolor,-.5*bgcolor,6,0,2*Math.PI),ctx.fill()),ctx.fillStyle=node.boxcolor||colState||LiteGraph.NODE_DEFAULT_BOXCOLOR,low_quality?ctx.fillRect(.5*bgcolor-5,-.5*bgcolor-5,10,10):(ctx.beginPath(),ctx.arc(.5*bgcolor,-.5*bgcolor,5,0,2*Math.PI),ctx.fill())):(low_quality&&(ctx.fillStyle="black",ctx.fillRect(.5*(bgcolor-10)-1,-.5*(bgcolor+10)-1,12,12)),ctx.fillStyle=node.boxcolor||colState||LiteGraph.NODE_DEFAULT_BOXCOLOR,ctx.fillRect(.5*(bgcolor-10),-.5*(bgcolor+10),10,10))),ctx.globalAlpha=old_alpha,node.processCallbackHandlers("onDrawTitleText",{def_cb:node.onDrawTitleText},ctx,bgcolor,size,this.ds.scale,this.title_text_font,selected),!low_quality&&(ctx.font=this.title_text_font,grad=String(node.getTitle()))&&(ctx.fillStyle=selected?LiteGraph.NODE_SELECTED_TITLE_COLOR:node.constructor.title_text_color||this.node_title_color,node.flags.collapsed?(ctx.textAlign="left",ctx.fillText(grad,bgcolor,LiteGraph.NODE_TITLE_TEXT_Y-bgcolor),ctx.textAlign="left"):(ctx.textAlign="left",ctx.fillText(grad,bgcolor,LiteGraph.NODE_TITLE_TEXT_Y-bgcolor))),node.flags.collapsed||!node.subgraph||node.skip_subgraph_button||(title_color=LiteGraph.NODE_TITLE_HEIGHT,render_title=node.size[0]-title_color,old_alpha=LiteGraph.isInsideRectangle(this.graph_mouse[0]-node.pos[0],this.graph_mouse[1]-node.pos[1],2+render_title,2-title_color,title_color-4,title_color-4),ctx.fillStyle=old_alpha?"#888":"#555",shape==LiteGraph.BOX_SHAPE||low_quality?ctx.fillRect(2+render_title,2-title_color,title_color-4,title_color-4):(ctx.beginPath(),ctx.roundRect(2+render_title,2-title_color,title_color-4,title_color-4,[4]),ctx.fill()),ctx.fillStyle="#333",ctx.beginPath(),ctx.moveTo(render_title+.2*title_color,.6*-title_color),ctx.lineTo(render_title+.8*title_color,.6*-title_color),ctx.lineTo(render_title+.5*title_color,.3*-title_color),ctx.fill()),node.processCallbackHandlers("onDrawTitle",{def_cb:node.onDrawTitle},ctx)}selected&&(node.processCallbackHandlers("onBounding",{def_cb:node.onBounding},mouse_over),title_mode==LiteGraph.TRANSPARENT_TITLE&&(mouse_over[1]-=bgcolor,mouse_over[3]+=bgcolor),ctx.lineWidth=1,ctx.globalAlpha=.8,ctx.beginPath(),shape==LiteGraph.BOX_SHAPE?ctx.rect(-6+mouse_over[0],-6+mouse_over[1],12+mouse_over[2],12+mouse_over[3]):shape==LiteGraph.ROUND_SHAPE||shape==LiteGraph.CARD_SHAPE&&node.flags.collapsed?ctx.roundRect(-6+mouse_over[0],-6+mouse_over[1],12+mouse_over[2],12+mouse_over[3],[2*this.round_radius]):shape==LiteGraph.CARD_SHAPE?ctx.roundRect(-6+mouse_over[0],-6+mouse_over[1],12+mouse_over[2],12+mouse_over[3],[2*this.round_radius,2,2*this.round_radius,2]):shape==LiteGraph.CIRCLE_SHAPE&&ctx.arc(.5*size[0],.5*size[1],.5*size[0]+6,0,2*Math.PI),ctx.strokeStyle=LiteGraph.NODE_BOX_OUTLINE_COLOR,ctx.stroke(),ctx.strokeStyle=fgcolor,ctx.globalAlpha=1),0<node.execute_triggered&&node.execute_triggered--,0<node.action_triggered&&node.action_triggered--}drawConnections(ctx){for(var now=LiteGraph.getTime(),visible_area=this.visible_area,nodes=(margin_area[0]=visible_area[0]-20,margin_area[1]=visible_area[1]-20,margin_area[2]=visible_area[2]+40,margin_area[3]=visible_area[3]+40,ctx.lineWidth=this.connections_width,ctx.fillStyle="#AAA",ctx.strokeStyle="#AAA",ctx.globalAlpha=this.editor_alpha,this.graph._nodes),n=0,l=nodes.length;n<l;++n){var node=nodes[n];if(node.inputs&&node.inputs.length)for(let i=0;i<node.inputs.length;++i){var start_node_slotpos,end_node_slotpos,start_node_slot,start_node,end_slot,tmp,input=node.inputs[i];input&&null!=input.link&&(input=input.link,input=this.graph.links[input])&&null!=(start_node=this.graph.getNodeById(input.origin_id))&&(start_node_slotpos=null,start_node_slotpos=-1==(start_node_slot=input.origin_slot)?[start_node.pos[0]+10,start_node.pos[1]+10]:start_node.getConnectionPos(!1,start_node_slot,tempA),end_node_slotpos=node.getConnectionPos(!0,i,tempB),link_bounding[0]=start_node_slotpos[0],link_bounding[1]=start_node_slotpos[1],link_bounding[2]=end_node_slotpos[0]-start_node_slotpos[0],link_bounding[3]=end_node_slotpos[1]-start_node_slotpos[1],link_bounding[2]<0&&(link_bounding[0]+=link_bounding[2],link_bounding[2]=Math.abs(link_bounding[2])),link_bounding[3]<0&&(link_bounding[1]+=link_bounding[3],link_bounding[3]=Math.abs(link_bounding[3])),LiteGraph.overlapBounding(link_bounding,margin_area))&&(start_node_slot=start_node.outputs[start_node_slot],end_slot=node.inputs[i],start_node_slot)&&end_slot&&(start_node_slot=start_node_slot.dir||(start_node.horizontal?LiteGraph.DOWN:LiteGraph.RIGHT),start_node=end_slot.dir||(node.horizontal?LiteGraph.UP:LiteGraph.LEFT),this.renderLink(ctx,start_node_slotpos,end_node_slotpos,input,!1,0,null,start_node_slot,start_node),input)&&input._last_time&&now-input._last_time<1e3&&(end_slot=2-.002*(now-input._last_time),tmp=ctx.globalAlpha,ctx.globalAlpha=tmp*end_slot,this.renderLink(ctx,start_node_slotpos,end_node_slotpos,input,!0,end_slot,"white",start_node_slot,start_node),ctx.globalAlpha=tmp)}}ctx.globalAlpha=1}renderLink(ctx,a,b,link,skip_border,flow,color,start_dir,end_dir,num_sublines){link&&this.visible_links.push(link),color=(color=!color&&link?link.color||LGraphCanvas.link_type_colors[link.type]:color)||this.default_link_color,null!=link&&this.highlighted_links[link.id]&&(color="#FFF"),start_dir=start_dir||LiteGraph.RIGHT,end_dir=end_dir||LiteGraph.LEFT;var dist=LiteGraph.distance(a,b);this.render_connections_border&&.6<this.ds.scale&&(ctx.lineWidth=this.connections_width+4),ctx.lineJoin="round",1<(num_sublines=num_sublines||1)&&(ctx.lineWidth=.5),ctx.beginPath();for(let i=0;i<num_sublines;i+=1){var offsety=5*(i-.5*(num_sublines-1));if(this.links_render_mode==LiteGraph.SPLINE_LINK){ctx.moveTo(a[0],a[1]+offsety);let start_offset_x=0,start_offset_y=0,end_offset_x=0,end_offset_y=0;switch(start_dir){case LiteGraph.LEFT:start_offset_x=-.25*dist;break;case LiteGraph.RIGHT:start_offset_x=.25*dist;break;case LiteGraph.UP:start_offset_y=-.25*dist;break;case LiteGraph.DOWN:start_offset_y=.25*dist}switch(end_dir){case LiteGraph.LEFT:end_offset_x=-.25*dist;break;case LiteGraph.RIGHT:end_offset_x=.25*dist;break;case LiteGraph.UP:end_offset_y=-.25*dist;break;case LiteGraph.DOWN:end_offset_y=.25*dist}ctx.bezierCurveTo(a[0]+start_offset_x,a[1]+start_offset_y+offsety,b[0]+end_offset_x,b[1]+end_offset_y+offsety,b[0],b[1]+offsety)}else if(this.links_render_mode==LiteGraph.LINEAR_LINK){ctx.moveTo(a[0],a[1]+offsety);let start_offset_x=0,start_offset_y=0,end_offset_x=0,end_offset_y=0;switch(start_dir){case LiteGraph.LEFT:start_offset_x=-1;break;case LiteGraph.RIGHT:start_offset_x=1;break;case LiteGraph.UP:start_offset_y=-1;break;case LiteGraph.DOWN:start_offset_y=1}switch(end_dir){case LiteGraph.LEFT:end_offset_x=-1;break;case LiteGraph.RIGHT:end_offset_x=1;break;case LiteGraph.UP:end_offset_y=-1;break;case LiteGraph.DOWN:end_offset_y=1}ctx.lineTo(a[0]+15*start_offset_x,a[1]+15*start_offset_y+offsety),ctx.lineTo(b[0]+15*end_offset_x,b[1]+15*end_offset_y+offsety),ctx.lineTo(b[0],b[1]+offsety)}else{if(this.links_render_mode!=LiteGraph.STRAIGHT_LINK)return;ctx.moveTo(a[0],a[1]);var offsety=a[0],start_y=a[1],end_x=b[0],end_y=b[1];start_dir==LiteGraph.RIGHT?offsety+=10:start_y+=10,end_dir==LiteGraph.LEFT?end_x-=10:end_y-=10,ctx.lineTo(offsety,start_y),ctx.lineTo(.5*(offsety+end_x),start_y),ctx.lineTo(.5*(offsety+end_x),end_y),ctx.lineTo(end_x,end_y),ctx.lineTo(b[0],b[1])}}this.render_connections_border&&.6<this.ds.scale&&!skip_border&&(ctx.strokeStyle="rgba(0,0,0,0.5)",ctx.stroke()),ctx.lineWidth=this.connections_width,ctx.fillStyle=ctx.strokeStyle=color,ctx.stroke();var posC,posD,angleA,angleB,pos=this.computeConnectionPoint(a,b,.5,start_dir,end_dir);if(link&&link._pos&&(link._pos[0]=pos[0],link._pos[1]=pos[1]),.6<=this.ds.scale&&this.highquality_render&&end_dir!=LiteGraph.CENTER&&(this.render_connection_arrows&&(skip_border=this.computeConnectionPoint(a,b,.25,start_dir,end_dir),link=this.computeConnectionPoint(a,b,.26,start_dir,end_dir),posC=this.computeConnectionPoint(a,b,.75,start_dir,end_dir),posD=this.computeConnectionPoint(a,b,.76,start_dir,end_dir),angleB=angleA=0,angleB=this.render_curved_connections?(angleA=-Math.atan2(link[0]-skip_border[0],link[1]-skip_border[1]),-Math.atan2(posD[0]-posC[0],posD[1]-posC[1])):angleA=b[1]>a[1]?0:Math.PI,ctx.save(),ctx.translate(skip_border[0],skip_border[1]),ctx.rotate(angleA),ctx.beginPath(),ctx.moveTo(-5,-3),ctx.lineTo(0,7),ctx.lineTo(5,-3),ctx.fill(),ctx.restore(),ctx.save(),ctx.translate(posC[0],posC[1]),ctx.rotate(angleB),ctx.beginPath(),ctx.moveTo(-5,-3),ctx.lineTo(0,7),ctx.lineTo(5,-3),ctx.fill(),ctx.restore()),ctx.beginPath(),ctx.arc(pos[0],pos[1],5,0,2*Math.PI),ctx.fill()),flow){ctx.fillStyle=color;for(let i=0;i<5;++i){var f=(.001*LiteGraph.getTime()+.2*i)%1,pos=this.computeConnectionPoint(a,b,f,start_dir,end_dir);ctx.beginPath(),ctx.arc(pos[0],pos[1],5,0,2*Math.PI),ctx.fill()}}}computeConnectionPoint(a,b,t,start_dir,end_dir){start_dir=start_dir||LiteGraph.RIGHT,end_dir=end_dir||LiteGraph.LEFT;var dist=LiteGraph.distance(a,b),p0=a,p1=[a[0],a[1]],p2=[b[0],b[1]],a=b;switch(start_dir){case LiteGraph.LEFT:p1[0]+=-.25*dist;break;case LiteGraph.RIGHT:p1[0]+=.25*dist;break;case LiteGraph.UP:p1[1]+=-.25*dist;break;case LiteGraph.DOWN:p1[1]+=.25*dist}switch(end_dir){case LiteGraph.LEFT:p2[0]+=-.25*dist;break;case LiteGraph.RIGHT:p2[0]+=.25*dist;break;case LiteGraph.UP:p2[1]+=-.25*dist;break;case LiteGraph.DOWN:p2[1]+=.25*dist}b=(1-t)*(1-t)*(1-t),start_dir=(1-t)*(1-t)*3*t,end_dir=3*(1-t)*(t*t),t*=t*t;return[b*p0[0]+start_dir*p1[0]+end_dir*p2[0]+t*a[0],b*p0[1]+start_dir*p1[1]+end_dir*p2[1]+t*a[1]]}drawExecutionOrder(ctx){ctx.shadowColor="transparent",ctx.globalAlpha=.25,ctx.textAlign="center",ctx.strokeStyle="white",ctx.globalAlpha=.75;var visible_nodes=this.visible_nodes;for(let i=0;i<visible_nodes.length;++i){var node=visible_nodes[i];ctx.fillStyle="black",ctx.fillRect(node.pos[0]-LiteGraph.NODE_TITLE_HEIGHT,node.pos[1]-LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT),0==node.order&&ctx.strokeRect(node.pos[0]-LiteGraph.NODE_TITLE_HEIGHT+.5,node.pos[1]-LiteGraph.NODE_TITLE_HEIGHT+.5,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT),ctx.fillStyle="#FFF",ctx.fillText(node.order,node.pos[0]+-.5*LiteGraph.NODE_TITLE_HEIGHT,node.pos[1]-6)}ctx.globalAlpha=1}drawNodeWidgets(node,posY,ctx,active_widget){if(!node.widgets||!node.widgets.length)return 0;var width=node.size[0],widgets=node.widgets,H=(posY+=2,LiteGraph.NODE_WIDGET_HEIGHT),show_text=!this.lowQualityRenderingRequired(.5),outline_color=(ctx.save(),ctx.globalAlpha=this.editor_alpha,LiteGraph.WIDGET_OUTLINE_COLOR),background_color=LiteGraph.WIDGET_BGCOLOR,text_color=LiteGraph.WIDGET_TEXT_COLOR,secondary_text_color=LiteGraph.WIDGET_SECONDARY_TEXT_COLOR;for(let i=0;i<widgets.length;++i){var values,w=widgets[i],y=posY,widget_width=(w.y&&(y=w.y),w.last_y=y,ctx.strokeStyle=outline_color,ctx.fillStyle="#222",ctx.textAlign="left",w.disabled&&(ctx.globalAlpha*=.5),w.width||width),is_over_widget=this.over_widget==w;switch(w.type){case"button":w.clicked&&(ctx.fillStyle="#AAA",w.clicked=!1,this.dirty_canvas=!0),ctx.fillRect(15,y,widget_width-30,H),show_text&&!w.disabled&&ctx.strokeRect(15,y,widget_width-30,H),show_text&&(ctx.textAlign="center",ctx.fillStyle=text_color,is_over_widget||!0===this.options.hide_widget_label_when_small||this.options.hide_widget_label_when_small<width)&&ctx.fillText(w.label||w.name,.5*widget_width,y+.7*H);break;case"toggle":ctx.textAlign="left",ctx.strokeStyle=outline_color,ctx.fillStyle=background_color,ctx.beginPath(),show_text?ctx.roundRect(15,y,widget_width-30,H,[.5*H]):ctx.rect(15,y,widget_width-30,H),ctx.fill(),show_text&&!w.disabled&&ctx.stroke(),ctx.fillStyle=w.value?"#89A":"#333",ctx.beginPath(),ctx.arc(widget_width-30,y+.5*H,.36*H,0,2*Math.PI),ctx.fill(),show_text&&(ctx.fillStyle=secondary_text_color,null!=(label=w.label||w.name)&&(is_over_widget||!0===this.options.hide_widget_label_when_small||this.options.hide_widget_label_when_small<width)&&ctx.fillText(label,30,y+.7*H),ctx.fillStyle=w.value?text_color:secondary_text_color,ctx.textAlign="right",ctx.fillText(w.value?w.options.on||"on":w.options.off||"off",widget_width-40,y+.7*H));break;case"slider":ctx.fillStyle=background_color,ctx.fillRect(15,y,widget_width-30,H);var label=w.options.max-w.options.min,nvalue=(w.value-w.options.min)/label;1<(nvalue=nvalue<0?0:nvalue)&&(nvalue=1),ctx.fillStyle=w.options.hasOwnProperty("slider_color")?w.options.slider_color:active_widget==w?"#89A":"#678",ctx.fillRect(15,y,nvalue*(widget_width-30),H),show_text&&!w.disabled&&ctx.strokeRect(15,y,widget_width-30,H),w.marker&&(1<(nvalue=(nvalue=(w.marker-w.options.min)/label)<0?0:nvalue)&&(nvalue=1),ctx.fillStyle=w.options.hasOwnProperty("marker_color")?w.options.marker_color:"#AA9",ctx.fillRect(15+nvalue*(widget_width-30),y,2,H)),show_text&&(ctx.textAlign="center",ctx.fillStyle=text_color,is_over_widget||!0===this.options.hide_widget_label_when_small||this.options.hide_widget_label_when_small<width)&&ctx.fillText(w.label||w.name+"  "+LiteGraph.formatNumber(w.value,null!=w.options.precision?w.options.precision:3),.5*widget_width,y+.7*H);break;case"number":case"combo":ctx.textAlign="left",ctx.strokeStyle=outline_color,ctx.fillStyle=background_color,ctx.beginPath(),show_text?ctx.roundRect(15,y,widget_width-30,H,[.5*H]):ctx.rect(15,y,widget_width-30,H),ctx.fill(),show_text&&(w.disabled||ctx.stroke(),ctx.fillStyle=text_color,w.disabled||(ctx.beginPath(),ctx.moveTo(31,y+5),ctx.lineTo(21,y+.5*H),ctx.lineTo(31,y+H-5),ctx.fill(),ctx.beginPath(),ctx.moveTo(widget_width-15-16,y+5),ctx.lineTo(widget_width-15-6,y+.5*H),ctx.lineTo(widget_width-15-16,y+H-5),ctx.fill()),ctx.fillStyle=secondary_text_color,(is_over_widget||!0===this.options.hide_widget_label_when_small||this.options.hide_widget_label_when_small<width)&&ctx.fillText(w.label||w.name,35,y+.7*H),ctx.fillStyle=text_color,ctx.textAlign="right","number"==w.type?ctx.fillText(LiteGraph.formatNumber(w.value,void 0!==w.options.precision?w.options.precision:3),widget_width-30-20,y+.7*H):(nvalue=w.value,w.options.values&&(values=(values=w.options.values).constructor===Function?values():values)&&values.constructor!==Array&&(nvalue=values[w.value]),ctx.fillText(nvalue,widget_width-30-20,y+.7*H)));break;case"string":case"text":if(ctx.textAlign="left",ctx.strokeStyle=outline_color,ctx.fillStyle=background_color,ctx.beginPath(),show_text?ctx.roundRect(15,y,widget_width-30,H,[.5*H]):ctx.rect(15,y,widget_width-30,H),ctx.fill(),show_text){w.disabled||ctx.stroke(),ctx.save(),ctx.beginPath(),ctx.rect(15,y,widget_width-30,H),ctx.clip(),ctx.fillStyle=secondary_text_color;const label=w.label||w.name;null!=label&&(is_over_widget||!0===this.options.hide_widget_label_when_small||this.options.hide_widget_label_when_small<width)&&ctx.fillText(label,30,y+.7*H),ctx.fillStyle=text_color,ctx.textAlign="right",ctx.fillText(String(w.value).substr(0,30),widget_width-30,y+.7*H),ctx.restore()}break;default:w.draw&&w.draw(ctx,node,widget_width,y,H)}posY+=(w.computeSize?w.computeSize(widget_width)[1]:H)+4,ctx.globalAlpha=this.editor_alpha}ctx.restore(),ctx.textAlign="left"}processNodeWidgets(node,pos,event,active_widget){if(node.widgets&&node.widgets.length&&(this.allow_interaction||node.flags.allow_interaction)){var x=pos[0]-node.pos[0],y=pos[1]-node.pos[1],width=node.size[0],height=LiteGraph.NODE_WIDGET_HEIGHT,deltaX=event?.deltaX||event?.deltax||0,that=this,ref_window=this.getCanvasWindow(),widget_width=width,widget_height=height;for(let i=0;i<node.widgets.length;++i){var w=node.widgets[i];if(w&&!w.disabled){if("function"==typeof w.computeSize){const wSize=w.computeSize(node.size[0],node.size[1]);widget_width=wSize[0],widget_height=wSize[1]}else widget_width=w.width||width,widget_height=w.height||height;if(w==active_widget||!(x<6||widget_width-12<x||y<w.last_y||y>w.last_y+widget_height||void 0===w.last_y)){var old_value=w.value;if(LiteGraph.log_verbose("graph processNodeWidgets","has widget",w),event)switch(w.type){case"button":"pointerdown"===event.type?(w.callback?(LiteGraph.log_debug("graph processNodeWidgets","button, calling callback",w.callback),setTimeout(function(){w.callback(w,that,node,pos,event)},20)):LiteGraph.log_verbose("graph processNodeWidgets","button, has not callback",w),w.clicked=!0,this.dirty_canvas=!0):LiteGraph.log_verbose("graph processNodeWidgets","button, event is not pointer down",event);break;case"slider":var nvalue=LiteGraph.clamp((x-15)/(widget_width-30),0,1);w.options.read_only||(w.value=w.options.min+(w.options.max-w.options.min)*nvalue,old_value!=w.value&&setTimeout(function(){inner_value_change(w,w.value,old_value)},20),this.dirty_canvas=!0);break;case"number":case"combo":case"enum":if("pointermove"==event.type&&"number"==w.type)deltaX&&(w.value+=.1*deltaX*(w.options.step||1)),null!=w.options.min&&w.value<w.options.min&&(w.value=w.options.min),null!=w.options.max&&w.value>w.options.max&&(w.value=w.options.max);else if("pointerdown"==event.type){var values=w.options.values,values_list=(values&&values.constructor===Function&&(values=w.options.values(w,node)),null);"number"!=w.type&&(values_list=values.constructor===Array?values:Object.keys(values));let delta=x<40?-1:widget_width-40<x?1:0;if("number"==w.type)w.value+=delta*(w.options.step||1),null!=w.options.min&&w.value<w.options.min&&(w.value=w.options.min),null!=w.options.max&&w.value>w.options.max&&(w.value=w.options.max);else if(delta){var index=-1;this.last_mouseclick=0,index=values.constructor===Object?values_list.indexOf(String(w.value))+delta:values_list.indexOf(w.value)+delta,index>=values_list.length&&(index=values_list.length-1),index<0&&(index=0),values.constructor===Array?w.value=values[index]:w.value=index}else{var text_values=values!=values_list?Object.values(values):values;let inner_clicked=function(v){return values!=values_list&&(v=text_values.indexOf(v)),this.value=v,inner_value_change(this,v,old_value),!(that.dirty_canvas=!0)};LiteGraph.ContextMenu(text_values,{scale:Math.max(1,this.ds.scale),event:event,className:"dark",callback:inner_clicked.bind(w)},ref_window)}}else if("pointerup"==event.type&&"number"==w.type){let delta=x<40?-1:widget_width-40<x?1:0;event.click_time<200&&0==delta&&this.prompt("Value",w.value,function(v){if(/^[0-9+\-*/()\s]+|\d+\.\d+$/.test(v))try{v=eval(v)}catch(error){LiteGraph.log_warn(error)}this.value=Number(v),inner_value_change(this,this.value,old_value)}.bind(w),event)}old_value!=w.value&&setTimeout(function(){inner_value_change(this,this.value,old_value)}.bind(w),20),this.dirty_canvas=!0;break;case"toggle":"pointerdown"==event.type&&(w.value=!w.value,setTimeout(function(){inner_value_change(w,w.value)},20));break;case"string":case"text":"pointerdown"==event.type&&this.prompt("Value",w.value,function(v){inner_value_change(this,v)}.bind(w),event,!!w.options&&w.options.multiline);break;default:w.mouse&&(this.dirty_canvas=w.mouse(event,[x,y],node))}return w}}}}else node.widgets&&node.widgets.length||LiteGraph.log_verbose("graph processNodeWidgets","no widgets for node",node),this.allow_interaction||node.flags.allow_interaction||LiteGraph.log_verbose("graph processNodeWidgets","interaction not allowed on graph and not overridden on node",node);return null;function inner_value_change(widget,value,old_value){LiteGraph.log_debug("inner_value_change for processNodeWidgets",widget,value),old_value!=w.value&&(node.processCallbackHandlers("onWidgetChanged",{def_cb:node.onWidgetChanged},w.name,w.value,old_value,w),node.graph.onGraphChanged({action:"widgetChanged",doSave:!0})),"number"==widget.type&&(value=Number(value)),widget.value=value,widget.options&&widget.options.property&&void 0!==node.properties[widget.options.property]&&node.setProperty(widget.options.property,value),widget.callback&&widget.callback(widget.value,that,node,pos,event)}}drawGroups(canvas,ctx){if(this.graph){var groups=this.graph._groups;ctx.save();for(let i=0;i<groups.length;++i){var pos,size,font_size,group=groups[i];LiteGraph.overlapBounding(this.visible_area,group._bounding)&&(ctx.fillStyle=group.color||"#335",ctx.strokeStyle=group.color||"#335",0<=this.options.groups_border_alpha&&ctx.setStrokeColor&&ctx.setStrokeColor(ctx.strokeStyle,this.options.groups_border_alpha),pos=group._pos,size=group._size,ctx.globalAlpha=this.options.groups_alpha*this.editor_alpha,ctx.beginPath(),ctx.rect(pos[0]+.5,pos[1]+.5,size[0],size[1]),ctx.fill(),ctx.globalAlpha=this.editor_alpha,ctx.stroke(),ctx.beginPath(),ctx.moveTo(pos[0]+size[0],pos[1]+size[1]),ctx.lineTo(pos[0]+size[0]-this.options.groups_triangle_handler_size,pos[1]+size[1]),ctx.lineTo(pos[0]+size[0],pos[1]+size[1]-this.options.groups_triangle_handler_size),ctx.fill(),font_size=group.font_size||this.options.groups_title_font_size||LiteGraph.DEFAULT_GROUP_FONT_SIZE,ctx.font=font_size+"px "+this.options.groups_title_font,ctx.textAlign=this.options.groups_title_alignment,this.options.groups_title_wrap?LiteGraph.canvasFillTextMultiline(ctx,group.title,pos[0]+4,pos[1]+font_size,size[0],font_size):ctx.fillText(group.title,pos[0]+4,pos[1]+font_size))}ctx.restore()}}adjustNodesSize(){var nodes=this.graph._nodes;for(let i=0;i<nodes.length;++i)nodes[i].size=nodes[i].computeSize();this.setDirty(!0,!0)}resize(width,height){var parent;width||height?LiteGraph.log_debug("lgraphcanvas","resize","passed",width,height,parent):(width=(parent=this.canvas.parentNode).offsetWidth,height=parent.offsetHeight,LiteGraph.log_debug("lgraphcanvas","resize","not passed: AUTO",parent,width,height)),this.canvas.width==width&&this.canvas.height==height||(this.canvas.width=width,this.canvas.height=height,this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height,this.setDirty(!0,!0))}switchLiveMode(transition){var self,delta,t;transition?(delta=(self=this).live_mode?1.1:.9,this.live_mode&&(this.live_mode=!1,this.editor_alpha=.1),t=setInterval(function(){self.editor_alpha*=delta,self.dirty_canvas=!0,self.dirty_bgcanvas=!0,delta<1&&self.editor_alpha<.01&&(clearInterval(t),delta<1)&&(self.live_mode=!0),1<delta&&.99<self.editor_alpha&&(clearInterval(t),self.editor_alpha=1)},1)):(this.live_mode=!this.live_mode,this.dirty_canvas=!0,this.dirty_bgcanvas=!0)}static onGroupAdd(info,entry,mouse_event){var bounds,spacing,titleSpace,canvas=LGraphCanvas.active_canvas,group=new LiteGraph.LGraphGroup;canvas.options.groups_add_around_selected&&Object.keys(canvas.selected_nodes).length&&(bounds=canvas.getBoundaryForSelection())?(spacing=canvas.options.groups_add_default_spacing,titleSpace=1.5*canvas.options.groups_title_font_size,group.pos=[bounds[0]-spacing,bounds[1]-titleSpace-spacing],group.size=[bounds[2]+2*spacing,bounds[3]+titleSpace+2*spacing],LiteGraph.log_debug("lgraphcanvas","onGroupAdd","groups_add_around_selected",bounds,group)):group.pos=canvas.convertEventToCanvasOffset(mouse_event),canvas.graph.add(group)}static getBoundaryNodes(nodes){let top=null,right=null,bottom=null,left=null;for(const nID in nodes){var node=nodes[nID],[x,y]=node.pos,[width,height]=node.size;(null===top||y<top.pos[1])&&(top=node),(null===right||x+width>right.pos[0]+right.size[0])&&(right=node),(null===bottom||y+height>bottom.pos[1]+bottom.size[1])&&(bottom=node),(null===left||x<left.pos[0])&&(left=node)}return{top:top,right:right,bottom:bottom,left:left}}boundaryNodesForSelection(){return LGraphCanvas.getBoundaryNodes(Object.values(this.selected_nodes))}getBoundaryForSelection(){var ln,tn,rn,nodesBounds=this.boundaryNodesForSelection();return!(!nodesBounds||null===nodesBounds.left)&&(ln=nodesBounds.left.getBounding(),tn=nodesBounds.top.getBounding(),rn=nodesBounds.right.getBounding(),nodesBounds=nodesBounds.bottom.getBounding(),[ln[0],tn[1],rn[0]+rn[2]-ln[0],nodesBounds[1]+nodesBounds[3]-tn[1]])}getCoordinateCenter(ob4v){return[ob4v[0]+ob4v[2]/2,ob4v[1]+ob4v[3]/2]}static alignNodes(nodes,direction,align_to){if(nodes){var _,node,canvas=LGraphCanvas.active_canvas;let boundaryNodes=[];boundaryNodes=void 0===align_to?LGraphCanvas.getBoundaryNodes(nodes):{top:align_to,right:align_to,bottom:align_to,left:align_to};for([_,node]of Object.entries(canvas.selected_nodes))switch(direction){case"right":node.pos[0]=boundaryNodes.right.pos[0]+boundaryNodes.right.size[0]-node.size[0];break;case"left":node.pos[0]=boundaryNodes.left.pos[0];break;case"top":node.pos[1]=boundaryNodes.top.pos[1];break;case"bottom":node.pos[1]=boundaryNodes.bottom.pos[1]+boundaryNodes.bottom.size[1]-node.size[1]}canvas.dirty_canvas=!0,canvas.dirty_bgcanvas=!0}}static onNodeAlign(value,options,event,prev_menu,node){LiteGraph.ContextMenu(["Top","Bottom","Left","Right"],{event:event,callback:function(value){LGraphCanvas.alignNodes(LGraphCanvas.active_canvas.selected_nodes,value.toLowerCase(),node)},parentMenu:prev_menu})}static onGroupAlign(value,options,event,prev_menu){LiteGraph.ContextMenu(["Top","Bottom","Left","Right"],{event:event,callback:function(value){LGraphCanvas.alignNodes(LGraphCanvas.active_canvas.selected_nodes,value.toLowerCase())},parentMenu:prev_menu})}static onMenuAdd(node,options,e,prev_menu,callback){var canvas=LGraphCanvas.active_canvas,ref_window=canvas.getCanvasWindow(),graph=canvas.graph;if(graph)return function inner_onMenuAdded(base_category,prev_menu){var categories=LiteGraph.getNodeTypesCategories(canvas.filter||graph.filter).filter(function(category){return category.startsWith(base_category)}),entries=[];categories.map(function(category){var category_path,base_category_regex;category&&(base_category_regex=new RegExp("^("+base_category+")"),category=category.replace(base_category_regex,"").split("/")[0],category_path=""===base_category?category+"/":base_category+category+"/",-1!=(base_category_regex=category).indexOf("::")&&(base_category_regex=base_category_regex.split("::")[1]),-1===entries.findIndex(function(entry){return entry.value===category_path}))&&entries.push({value:category_path,content:base_category_regex,has_submenu:!0,callback:function(value,event,mouseEvent,contextMenu){LiteGraph.log_debug("onMenuAdd","inner_onMenuAdded","categories callback",...arguments),inner_onMenuAdded(value.value,contextMenu)}})});LiteGraph.getNodeTypesInCategory(base_category.slice(0,-1),canvas.filter||graph.filter).map(function(node){node.skip_list||(node={value:node.type,content:node.title,has_submenu:!1,callback:function(value,event,mouseEvent,contextMenu){contextMenu=contextMenu.getFirstEvent(),canvas.graph.beforeChange(),value=LiteGraph.createNode(value.value),LiteGraph.log_debug("onMenuAdd","inner_onMenuAdded","node entry callback",contextMenu,...arguments),value&&(value.pos=canvas.convertEventToCanvasOffset(contextMenu),canvas.graph.add(value)),callback&&callback(value),canvas.graph.afterChange()}},entries.push(node))});categories=e||options.event;LiteGraph.log_debug("lgraphcanvas","onMenuAdd","inner_onMenuAdded","opening ContextMenu",entries,{event:categories,parentMenu:prev_menu},ref_window),LiteGraph.ContextMenu(entries,{event:categories,parentMenu:prev_menu},ref_window)}("",prev_menu),!1}static onMenuCollapseAll(){}static onMenuNodeEdit(){}static showMenuNodeOptionalInputs(v,options,e,prev_menu,node){if(node){var r,that=this,ref_window=LGraphCanvas.active_canvas.getCanvasWindow(),entries=(options=node.optional_inputs,null!==(r=node.processCallbackHandlers("onGetInputs",{def_cb:node.onGetInputs}))&&"object"==typeof r&&("object"==typeof r.return_value?options=r.return_value:void 0!==r.length&&(options=r)),[]);if(options)for(let i=0;i<options.length;i++){var label,entry=options[i];entry?(label=entry[0],label=(entry[2]||(entry[2]={}),entry[2].label&&(label=entry[2].label),entry[2].removable=!0,entry[2].optional=!0,{content:label,value:entry}),entry[1]==LiteGraph.ACTION&&(label.className="event"),entries.push(label)):entries.push(null)}if(null!==(r=node.processCallbackHandlers("onMenuNodeInputs",{def_cb:node.onMenuNodeInputs},entries))&&"object"==typeof r&&"object"==typeof r.return_value&&(entries=r.return_value),LiteGraph.do_add_triggers_slots&&-1==node.findInputSlot("onTrigger")&&entries.push({content:"On Trigger",value:["onTrigger",LiteGraph.EVENT,{nameLocked:!0,removable:!0,optional:!0}],className:"event"}),entries.length)return LiteGraph.ContextMenu(entries,{event:e,callback:function(v,e,prev){node&&(v.callback&&v.callback.call(that,node,v,e,prev),v.value)&&(node.graph.beforeChange(),e={},v.value[2]&&(e=Object.assign(e,v.value[2])),node.addInput(v.value[0],v.value[1],e),node.processCallbackHandlers("onNodeInputAdd",{def_cb:node.onNodeInputAdd},v.value),node.setDirtyCanvas(!0,!0),node.graph.afterChange())},parentMenu:prev_menu,node:node},ref_window),!1;LiteGraph.log_debug("lgraphcanvas","showMenuNodeOptionalInputs","no input entries")}}static showMenuNodeOptionalOutputs(v,options,e,prev_menu,node){if(node){var that=this,ref_window=LGraphCanvas.active_canvas.getCanvasWindow(),r=(options=node.optional_outputs,node.processCallbackHandlers("onGetOutputs",{def_cb:node.onGetOutputs})),entries=(null!==r&&"object"==typeof r&&("object"==typeof r.return_value?options=r.return_value:void 0!==r.length&&(options=r)),[]);if(options)for(let i=0;i<options.length;i++){var label,entry=options[i];entry?node.flags&&node.flags.skip_repeated_outputs&&-1!=node.findOutputSlot(entry[0])||(label=entry[0],entry[2]||(entry[2]={}),entry[2].label&&(label=entry[2].label),entry[2].removable=!0,entry[2].optional=!0,label={content:label,value:entry},entry[1]==LiteGraph.EVENT&&(label.className="event"),entries.push(label)):entries.push(null)}if(null!==(r=node.processCallbackHandlers("onMenuNodeOutputs",{def_cb:node.onMenuNodeOutputs},entries))&&"object"==typeof r&&"object"==typeof r.return_value&&(entries=r.return_value),LiteGraph.do_add_triggers_slots&&-1==node.findOutputSlot("onExecuted")&&entries.push({content:"On Executed",value:["onExecuted",LiteGraph.EVENT,{nameLocked:!0,removable:!0,optional:!0}],className:"event"}),entries.length)return LiteGraph.ContextMenu(entries,{event:e,callback:function inner_clicked(v,e,prev){if(!node)return;v.callback&&v.callback.call(that,node,v,e,prev);if(!v.value)return;var value=v.value[1];{if(value&&(value.constructor===Object||value.constructor===Array)){var i,entries=[];for(i in value)entries.push({content:i,value:value[i]});return LiteGraph.ContextMenu(entries,{event:e,callback:inner_clicked,parentMenu:prev_menu,node:node}),!1}node.graph.beforeChange();prev={};v.value[2]&&(prev=Object.assign(prev,v.value[2])),node.addOutput(v.value[0],v.value[1],prev),node.processCallbackHandlers("onNodeOutputAdd",{def_cb:node.onNodeOutputAdd},v.value),node.setDirtyCanvas(!0,!0),node.graph.afterChange()}},parentMenu:prev_menu,node:node},ref_window),!1}}doShowMenuNodeProperties(element,options,e,prev_menu,node){LGraphCanvas.onShowMenuNodeProperties(element,options,e,prev_menu,node)}static onShowMenuNodeProperties(element,options,e,prev_menu,node){if(node&&node.properties){var i,canvas=LGraphCanvas.active_canvas,ref_window=canvas.getCanvasWindow(),entries=[];for(i in node.properties){let value=void 0!==node.properties[i]?node.properties[i]:" ";"object"==typeof value&&(value=JSON.stringify(value));var info=node.getPropertyInfo(i);let info_type=info&&null!==info?info.type:"string",propName=info&&null!==info&&info.label?info.label:i,htmlEntry=("enum"!=info_type&&"combo"!=info_type||(value=LGraphCanvas.getPropertyPrintableValue(value,info.values)),value=LGraphCanvas.decodeHTML(value),"<span class='property_name'>"+propName+"</span><span class='property_value'>"+value+"</span>");info=[];if(LiteGraph.properties_allow_input_binding){let relSlotOb=node.findInputSlot(propName,!0),hasSlotByName=-1!==relSlotOb,slotBinded=!!hasSlotByName&&relSlotOb.param_bind;htmlEntry+="<span class='property_input_bind'>"+(slotBinded?"<span class='property_input_binded'>linked</span>":hasSlotByName?"<span class='property_input_exist'><input type='button' class='btn_confirm btn_bind_property_to_input' value='link input' /></span>":"<span class=''><input type='button' class='btn_confirm btn_bind_property_to_input' value='create input' /></span>")+"</span>",info.push(function(el,menu){LiteGraph.log_debug("lgraphcanvas","showLinkMenu","onShowMenuNodeProperties","calling callback_on_element_created",propName,el,slotBinded,relSlotOb);var btnConfirm=el.querySelector(".btn_confirm");btnConfirm?(LiteGraph.log_info("lgraphcanvas","showLinkMenu","onShowMenuNodeProperties",".btn_confirm binding!",btnConfirm,propName),btnConfirm.addEventListener("click",function(ev){relSlotOb=node.findInputSlot(propName,!0),hasSlotByName=-1!==relSlotOb,(slotBinded=!!hasSlotByName&&relSlotOb.param_bind)?LiteGraph.log_debug("lgraphcanvas","showLinkMenu","onShowMenuNodeProperties","callback_on_element_created","properties_allow_input_binding","btnConfirm","Property already binded",relSlotOb,propName):(hasSlotByName||(LiteGraph.log_info("lgraphcanvas","showLinkMenu","onShowMenuNodeProperties","callback_on_element_created","properties_allow_input_binding","btnConfirm","CREATING NEW INPUT ON NODE",relSlotOb,propName),node.addInput(propName,info_type,{removable:!0,nameLocked:!0}),relSlotOb=node.findInputSlot(propName,!0)),LiteGraph.log_debug("lgraphcanvas","showLinkMenu","onShowMenuNodeProperties","callback_on_element_created","properties_allow_input_binding","btnConfirm","Linking property to input",relSlotOb),relSlotOb.param_bind=!0,menu.close?.(ev,!0)),ev.preventDefault(),ev.stopPropagation()})):(el.disabled="disabled",LiteGraph.log_warn("lgraphcanvas","showLinkMenu","onShowMenuNodeProperties",".btn_confirm not found",propName,el))})}LiteGraph.properties_allow_widget_binding&&node.widgets?.find(widget=>widget&&widget.options?.property===propName),entries.push({content:htmlEntry,value:i,callbacks_on_element_created:info})}if(entries.length)return LiteGraph.ContextMenu(entries,{event:e,callback:function(v,options,event,parent_menu,rel_node){var rect;LiteGraph.log_debug("lgraphcanvas","onShowMenuNodeProperties","inncer_clicked",this,...arguments),!node||this.disabled||v.disabled||(rect=this.getBoundingClientRect(),canvas.showEditPropertyValue(node,v.value,{position:[rect.left,rect.top]}))},parentMenu:prev_menu,allow_html:!0,node:node},ref_window),!1}}static decodeHTML(str){var e=document.createElement("div");return e.innerText=str,e.innerHTML}static onMenuResizeNode(value,options,e,menu,node){if(node){var canvas=LGraphCanvas.active_canvas,fApplyMultiNode=(canvas.getCanvasWindow(),canvas.graph?.onGraphChanged({action:"resize",doSave:!0}),node=>{node.size=node.computeSize(),node.processCallbackHandlers("onResize",{def_cb:node.onResize},node.size)}),graphcanvas=LGraphCanvas.active_canvas;if(!graphcanvas.selected_nodes||Object.keys(graphcanvas.selected_nodes).length<=1)fApplyMultiNode(node);else for(var i in graphcanvas.selected_nodes)fApplyMultiNode(graphcanvas.selected_nodes[i]);node.setDirtyCanvas(!0,!0)}}showLinkMenu(link,e){var that=this,node_left=(LiteGraph.log_verbose(link),that.graph.getNodeById(link.origin_id)),node_right=that.graph.getNodeById(link.target_id),fromType=!1,destType=(node_left&&node_left.outputs&&node_left.outputs[link.origin_slot]&&(fromType=node_left.outputs[link.origin_slot].type),!1),menu=(node_right&&node_right.outputs&&node_right.outputs[link.target_slot]&&(destType=node_right.inputs[link.target_slot].type),LiteGraph.ContextMenu(["Add Node",null,"Delete",null],{event:e,title:null!=link.data?link.data.constructor.name:null,callback:function(v,options,e){switch(v){case"Add Node":LiteGraph.log_debug("lgraphcanvas","showLinkMenu","inner_clicked","calling onMenuAdd"),LGraphCanvas.onMenuAdd(null,null,e,menu,function(node){node.inputs&&node.inputs.length&&node.outputs&&node.outputs.length&&(LiteGraph.log_debug("lgraphcanvas","showLinkMenu","inner_clicked","node autoconnect on add node on link"),node_left.connectByType(link.origin_slot,node,fromType))&&(node.connectByType(link.target_slot,node_right,destType),node.pos[0]-=.5*node.size[0])});break;case"Delete":LiteGraph.log_debug("lgraphcanvas","showLinkMenu","inner_clicked","remove link"),that.graph.removeLink(link.id);break;default:LiteGraph.log_debug("lgraphcanvas","showLinkMenu","inner_clicked","node in the middle or other operation",...arguments)}}}));return!1}createDefaultNodeForSlot(optPass={}){var opts=Object.assign({nodeFrom:null,slotFrom:null,nodeTo:null,slotTo:null,position:[],nodeType:null,posAdd:[0,0],posSizeFix:[0,0]},optPass),isFrom=opts.nodeFrom&&null!==opts.slotFrom,optPass=!isFrom&&opts.nodeTo&&null!==opts.slotTo;if(isFrom||optPass)if(opts.nodeType){var nodeX=isFrom?opts.nodeFrom:opts.nodeTo,slotX=isFrom?opts.slotFrom:opts.slotTo,iSlotConn=!1;switch(typeof slotX){case"string":iSlotConn=isFrom?nodeX.findOutputSlot(slotX,!1):nodeX.findInputSlot(slotX,!1),slotX=(isFrom?nodeX.outputs:nodeX.inputs)[slotX];break;case"object":iSlotConn=isFrom?nodeX.findOutputSlot(slotX.name):nodeX.findInputSlot(slotX.name);break;case"number":iSlotConn=slotX,slotX=(isFrom?nodeX.outputs:nodeX.inputs)[slotX];break;default:return LiteGraph.log_warn("lgraphcanvas","createDefaultNodeForSlot","Cant get slot information "+slotX),!1}!1!==slotX&&!1!==iSlotConn||LiteGraph.log_warn("lgraphcanvas","createDefaultNodeForSlot","bad slotX "+slotX+" "+iSlotConn);var fromSlotType=slotX.type==LiteGraph.EVENT?"_event_":slotX.type,slotTypesDefault=isFrom?LiteGraph.slot_types_default_out:LiteGraph.slot_types_default_in;if(slotTypesDefault&&slotTypesDefault[fromSlotType]){slotX.link;var nodeNewType=!1;if("object"==typeof slotTypesDefault[fromSlotType]){for(var typeX in slotTypesDefault[fromSlotType])if(opts.nodeType==slotTypesDefault[fromSlotType][typeX]||"AUTO"==opts.nodeType){nodeNewType=slotTypesDefault[fromSlotType][typeX],LiteGraph.log_verbose("lgraphcanvas","createDefaultNodeForSlot","opts.nodeType == slotTypesDefault[fromSlotType][typeX] :: "+opts.nodeType);break}}else opts.nodeType!=slotTypesDefault[fromSlotType]&&"AUTO"!=opts.nodeType||(nodeNewType=slotTypesDefault[fromSlotType]);if(nodeNewType){var optPass=!1,newNode=("object"==typeof nodeNewType&&nodeNewType.node&&(nodeNewType=(optPass=nodeNewType).node),LiteGraph.createNode(nodeNewType));if(newNode){if(optPass){if(optPass.properties)for(var[key,value]of Object.entries(optPass.properties))newNode.addProperty(key,value);optPass.inputs&&(newNode.inputs=[],Object.values(optPass.inputs).forEach(value=>{newNode.addOutput(value[0],value[1])})),optPass.outputs&&(newNode.outputs=[],Object.values(optPass.outputs).forEach(value=>{newNode.addOutput(value[0],value[1])})),optPass.title&&(newNode.title=optPass.title),optPass.json&&newNode.configure(optPass.json)}return this.graph.add(newNode),newNode.pos=[opts.position[0]+opts.posAdd[0]+(opts.posSizeFix[0]?opts.posSizeFix[0]*newNode.size[0]:0),opts.position[1]+opts.posAdd[1]+(opts.posSizeFix[1]?opts.posSizeFix[1]*newNode.size[1]:0)],isFrom?opts.nodeFrom.connectByType(iSlotConn,newNode,fromSlotType):opts.nodeTo.connectByTypeOutput(iSlotConn,newNode,fromSlotType),!0}LiteGraph.log_warn("lgraphcanvas","createDefaultNodeForSlot","failed creating "+nodeNewType)}}}else LiteGraph.log_warn("lgraphcanvas","createDefaultNodeForSlot","No type");else LiteGraph.log_warn("lgraphcanvas","createDefaultNodeForSlot","No data passed "+opts.nodeFrom+" "+opts.slotFrom+" "+opts.nodeTo+" "+opts.slotTo);return!1}showConnectionMenu(optPass={}){var opts=Object.assign({nodeFrom:null,slotFrom:null,nodeTo:null,slotTo:null,e:null,isCustomEvent:!1},optPass),that=this,isFrom=opts.nodeFrom&&opts.slotFrom,optPass=!isFrom&&opts.nodeTo&&opts.slotTo;if(isFrom||optPass){var nodeX=isFrom?opts.nodeFrom:opts.nodeTo,slotX=isFrom?opts.slotFrom:opts.slotTo,iSlotConn=!1;switch(typeof slotX){case"string":iSlotConn=isFrom?nodeX.findOutputSlot(slotX,!1):nodeX.findInputSlot(slotX,!1),slotX=(isFrom?nodeX.outputs:nodeX.inputs)[slotX];break;case"object":iSlotConn=isFrom?nodeX.findOutputSlot(slotX.name):nodeX.findInputSlot(slotX.name);break;case"number":iSlotConn=slotX,slotX=(isFrom?nodeX.outputs:nodeX.inputs)[slotX];break;default:return LiteGraph.log_warn("lgraphcanvas","showConnectionMenu","Cant get slot information "+slotX),!1}var options=["Add Node",null];that.allow_searchbox&&(options.push("Search"),options.push(null));const fromSlotType=slotX.type===LiteGraph.EVENT?"_event_":slotX.type;var optPass=isFrom?LiteGraph.slot_types_default_out:LiteGraph.slot_types_default_in,menu=(optPass&&optPass[fromSlotType]&&(optPass=optPass[fromSlotType],Array.isArray(optPass)||"object"==typeof optPass?Object.values(optPass).forEach(typeX=>{options.push(typeX)}):options.push(optPass)),LiteGraph.ContextMenu(options,{event:opts.e,isCustomEvent:opts.isCustomEvent,title:(slotX&&""!=slotX.name?slotX.name+(fromSlotType?" | ":""):"")+(slotX&&fromSlotType?fromSlotType:""),callback:(v,options,e)=>{var cases={"Add Node":()=>{LiteGraph.log_debug("lgraphcanvas","showConnectionMenu","callback","Add Node calling onMenuAdd",v,options,e),LGraphCanvas.onMenuAdd(null,null,e,menu,node=>{isFrom?opts.nodeFrom.connectByType(iSlotConn,node,fromSlotType):opts.nodeTo.connectByTypeOutput(iSlotConn,node,fromSlotType)})},Search:()=>{isFrom?that.showSearchBox(e,{node_from:opts.nodeFrom,slot_from:slotX,type_filter_in:fromSlotType}):that.showSearchBox(e,{node_to:opts.nodeTo,slot_from:slotX,type_filter_out:fromSlotType})},default:()=>{LiteGraph.log_debug("lgraphcanvas","showConnectionMenu","callback","createDefaultNodeForSlot",v,options,e);var new_pos=[opts.e.canvasX,opts.e.canvasY];that.createDefaultNodeForSlot(Object.assign(opts,{position:new_pos,nodeType:v}))}};(cases[v]||cases.default)()}}))}else LiteGraph.log_warn("lgraphcanvas","showConnectionMenu","No data passed to showConnectionMenu");return!1}doShowNodeInfoEditor(node,item,e,options){LGraphCanvas.onShowNodeInfoEditor(item,options,e,null,node)}static onShowNodeInfoEditor(item,options,e,menu,node){var property=item.property||"title",value=node[property],dialog=document.createElement("div");dialog.is_modified=!1,dialog.className="graphdialog",dialog.innerHTML="<span class='name'></span><input autofocus type='text' class='value'/><button>OK</button>",dialog.close=()=>{dialog.parentNode?.removeChild(dialog)};dialog.querySelector(".name").innerText=property;var input=dialog.querySelector(".value");const inner=()=>{input&&setValue(input.value)};input&&(input.value=value,input.addEventListener("blur",function(_event){this.focus()}),input.addEventListener("keydown",function(e){if(dialog.is_modified=!0,27==e.keyCode)dialog.close();else if(13==e.keyCode)inner();else if(13!=e.keyCode&&"textarea"!=e.target.localName)return;e.preventDefault(),e.stopPropagation()}));var value=LGraphCanvas.active_canvas.canvas,rect=value.getBoundingClientRect(),offsetx=-20,offsety=-20;rect&&(offsetx-=rect.left,offsety-=rect.top),event?(dialog.style.left=event.clientX+offsetx+"px",dialog.style.top=event.clientY+offsety+"px"):(dialog.style.left=.5*value.width+offsetx+"px",dialog.style.top=.5*value.height+offsety+"px"),dialog.querySelector("button").addEventListener("click",inner),value.parentNode.appendChild(dialog),input&&input.focus();let dialogCloseTimer=null;dialog.addEventListener("pointerleave",_event=>{LiteGraph.dialog_close_on_mouse_leave&&!dialog.is_modified&&(dialogCloseTimer=setTimeout(dialog.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),dialog.addEventListener("pointerenter",_event=>{LiteGraph.dialog_close_on_mouse_leave&&dialogCloseTimer&&clearTimeout(dialogCloseTimer)});const setValue=value=>{switch(item.type){case"Number":value=Number(value);break;case"Boolean":value=Boolean(value)}node[property]=value,dialog.parentNode?.removeChild(dialog),node.setDirtyCanvas(!0,!0)}}prompt(title="",value,callback,event,multiline){var dialog=document.createElement("div");dialog.is_modified=!1,dialog.className="graphdialog rounded",dialog.innerHTML=multiline?"<span class='name'></span> <textarea autofocus class='value'></textarea><button class='rounded'>OK</button>":"<span class='name'></span> <input autofocus type='text' class='value'/><button class='rounded'>OK</button>",dialog.close=()=>{this.prompt_box=null,dialog.parentNode?.removeChild(dialog)};var multiline=LGraphCanvas.active_canvas.canvas,dialogCloseTimer=(multiline.parentNode.appendChild(dialog),1<this.ds.scale&&(dialog.style.transform=`scale(${this.ds.scale})`),null),selInDia=(dialog.addEventListener("pointerleave",_event=>{LiteGraph.dialog_close_on_mouse_leave&&!dialog.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(dialogCloseTimer=setTimeout(dialog.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),dialog.addEventListener("pointerenter",_event=>{LiteGraph.dialog_close_on_mouse_leave&&dialogCloseTimer&&clearTimeout(dialogCloseTimer)}),dialog.querySelectorAll("select"));if(selInDia){let prevent_timeout=0;selInDia.forEach(selIn=>{selIn.addEventListener("click",_event=>{prevent_timeout++}),selIn.addEventListener("blur",_event=>{prevent_timeout=0}),selIn.addEventListener("change",_event=>{prevent_timeout=-1})})}this.prompt_box?.close();(this.prompt_box=dialog).querySelector(".name").innerText=title;selInDia=dialog.querySelector(".value");selInDia.value=value;const input=selInDia;input.addEventListener("keydown",e=>{switch(dialog.is_modified=!0,e.keyCode){case 27:dialog.close();break;case 13:"textarea"!==e.target.localName&&"function"==typeof callback&&(callback(input.value),this.setDirty(!0)),LiteGraph.log_debug("lgraphcanvas","prompt","prompt v2 ENTER",input.value,e.target.localName,callback),dialog.close();break;default:return}e.preventDefault(),e.stopPropagation()});dialog.querySelector("button").addEventListener("click",_event=>{"function"==typeof callback&&(callback(input.value),this.setDirty(!0)),LiteGraph.log_debug("lgraphcanvas","prompt","prompt v2 OK",input.value,callback),dialog.close()});title=multiline.getBoundingClientRect(),value=-20,selInDia=-20;return title&&(value-=title.left,selInDia-=title.top),event?(dialog.style.left=event.clientX+value+"px",dialog.style.top=event.clientY+selInDia+"px"):(dialog.style.left=.5*multiline.width+value+"px",dialog.style.top=.5*multiline.height+selInDia+"px"),setTimeout(function(){input.focus()},10),dialog}showSearchBox(event,options){var that,selIn,selOut,prevent_timeout,timeout_close,def_options={slot_from:null,node_from:null,node_to:null,do_type_filter:LiteGraph.search_filter_enabled,type_filter_in:!1,type_filter_out:!1,show_general_if_none_on_typefilter:!0,show_general_after_typefiltered:!0,hide_on_mouse_leave:LiteGraph.search_hide_on_mouse_leave,hide_on_mouse_leave_time:LiteGraph.search_hide_on_mouse_leave_time,show_all_if_empty:!0,show_all_on_open:LiteGraph.search_show_all_on_open},graphcanvas=(options=Object.assign(def_options,options||{}),"object"==typeof event&&void 0!==event.target||void 0!==options.event&&(LiteGraph.log_debug("lgraphcanvas","showSearchBox","event not passed directly, using event from options",options.event,"first par was:",event),event=options.event),LiteGraph.log_debug("lgraphcanvas","showSearchBox",event,options),void 0===that?that=this:LiteGraph.log_debug("lgraphcanvas","showSearchBox","using already present graphcanvas reference",that,"this is other?",this),LGraphCanvas.active_canvas),canvas=graphcanvas.canvas,root_document=canvas.ownerDocument||document,dialog=document.createElement("div"),helper=(dialog.className="litegraph litesearchbox graphdialog rounded",dialog.innerHTML="<span class='name'>Search</span> <input autofocus type='text' class='value rounded'/>",options.do_type_filter&&(dialog.innerHTML+="<select class='slot_in_type_filter'><option value=''></option></select>",dialog.innerHTML+="<select class='slot_out_type_filter'><option value=''></option></select>"),options.show_close_button&&(dialog.innerHTML+="<button class='close_searchbox close'>X</button>"),dialog.innerHTML+="<div class='helper'></div>",root_document.fullscreenElement?root_document.fullscreenElement.appendChild(dialog):(root_document.body.appendChild(dialog),root_document.body.style.overflow="hidden"),options.do_type_filter&&(selIn=dialog.querySelector(".slot_in_type_filter"),selOut=dialog.querySelector(".slot_out_type_filter")),dialog.close=function(){that.search_box=null,this.blur(),canvas.focus(),root_document.body.style.overflow="",setTimeout(function(){that.canvas?.focus(),that.canvas||LiteGraph.log_debug("lgraphcanvas","showSearchBox","dont have reference to canvas",that,"this is other?",this)},20),dialog.parentNode&&dialog.parentNode.removeChild(dialog)},void 0!==that.ds?1<that.ds.scale&&(dialog.style.transform=`scale(${that.ds.scale})`):LiteGraph.log_debug("lgraphcanvas","showSearchBox","ds reference not found, is this graphcanvas or what","that",that,"this",this),options.hide_on_mouse_leave&&(prevent_timeout=!1,timeout_close=null,dialog.addEventListener("pointerenter",function(_event){timeout_close&&(clearTimeout(timeout_close),timeout_close=null)}),dialog.addEventListener("pointerleave",function(_event){prevent_timeout||(timeout_close=setTimeout(function(){dialog.close()},options.hide_on_mouse_leave_time))}),options.do_type_filter)&&(selIn.addEventListener("click",function(_event){prevent_timeout++}),selIn.addEventListener("blur",function(_event){prevent_timeout=0}),selIn.addEventListener("change",function(_event){prevent_timeout=-1}),selOut.addEventListener("click",function(_event){prevent_timeout++}),selOut.addEventListener("blur",function(_event){prevent_timeout=0}),selOut.addEventListener("change",function(_event){prevent_timeout=-1})),that.search_box&&that.search_box.close(),(that.search_box=dialog).querySelector(".helper")),first=null,timeout=null,selected=null,input=dialog.querySelector("input");if(input&&(input.addEventListener("blur",function(_event){that.search_box&&this.focus()}),input.addEventListener("keydown",function(e){if(38==e.keyCode)changeSelection(!1);else if(40==e.keyCode)changeSelection(!0);else if(27==e.keyCode)dialog.close();else{if(13!=e.keyCode)return timeout&&clearInterval(timeout),void(timeout=setTimeout(refreshHelper,250));refreshHelper(),selected?select(selected.innerHTML):first?select(first):dialog.close()}return e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),!0})),options.do_type_filter){if(selIn){var aSlots=LiteGraph.slot_types_in,nSlots=aSlots.length;options.type_filter_in!=LiteGraph.EVENT&&options.type_filter_in!=LiteGraph.ACTION||(options.type_filter_in="_event_");for(let iK=0;iK<nSlots;iK++){var opt=document.createElement("option");opt.value=aSlots[iK],opt.innerHTML=aSlots[iK],selIn.appendChild(opt),!1!==options.type_filter_in&&(options.type_filter_in+"").toLowerCase()==(aSlots[iK]+"").toLowerCase()&&(opt.selected=!0)}selIn.addEventListener("change",function(){refreshHelper()})}if(selOut){let aSlots=LiteGraph.slot_types_out,nSlots=aSlots.length;options.type_filter_out!=LiteGraph.EVENT&&options.type_filter_out!=LiteGraph.ACTION||(options.type_filter_out="_event_");for(let iK=0;iK<nSlots;iK++){let opt=document.createElement("option");opt.value=aSlots[iK],opt.innerHTML=aSlots[iK],selOut.appendChild(opt),!1!==options.type_filter_out&&(options.type_filter_out+"").toLowerCase()==(aSlots[iK]+"").toLowerCase()&&(opt.selected=!0)}selOut.addEventListener("change",function(){refreshHelper()})}}options.show_close_button&&dialog.querySelector(".close").addEventListener("click",dialog.close);var def_options=canvas.getBoundingClientRect(),left=(event?event.clientX:def_options.left+.5*def_options.width)-80,top=(event?event.clientY:def_options.top+.5*def_options.height)-20;function select(name){if(name){var r=that.processCallbackHandlers("onSearchBoxSelection",{def_cb:that.onSearchBoxSelection},name,event,graphcanvas);if(null===r||!0!==r&&("object"!=typeof r||!0!==r.return_value)){var extra=LiteGraph.searchbox_extras[name.toLowerCase()],node=(extra&&(name=extra.type),graphcanvas.graph.beforeChange(),LiteGraph.createNode(name));if(!node)return LiteGraph.log_warn("lgraphcanvas","showSearchBox","select","failed creating the node",node),void dialog.close();if(node.pos=graphcanvas.convertEventToCanvasOffset(event),graphcanvas.graph.add(node,!1,{doProcessChange:!1}),extra&&extra.data){if(extra.data.properties)for(var i in extra.data.properties)node.addProperty(i,extra.data.properties[i]);if(extra.data.inputs){node.inputs=[];for(let i in extra.data.inputs)node.addOutput(extra.data.inputs[i][0],extra.data.inputs[i][1])}if(extra.data.outputs){node.outputs=[];for(let i in extra.data.outputs)node.addOutput(extra.data.outputs[i][0],extra.data.outputs[i][1])}extra.data.title&&(node.title=extra.data.title),extra.data.json&&node.configure(extra.data.json)}let iS;if(options.node_from){switch(iS=!1,typeof options.slot_from){case"string":iS=options.node_from.findOutputSlot(options.slot_from);break;case"object":-1==(iS=options.slot_from.name?options.node_from.findOutputSlot(options.slot_from.name):-1)&&void 0!==options.slot_from.slot_index&&(iS=options.slot_from.slot_index);break;case"number":iS=options.slot_from;break;default:iS=0}void 0!==options.node_from.outputs[iS]?!1!==iS&&-1<iS&&options.node_from.connectByType(iS,node,options.node_from.outputs[iS].type):LiteGraph.log_warn("lgraphcanvas","showSearchBox","select","cant find slot node_from to join using from slot type",options.slot_from,options.node_from.outputs)}if(options.node_to){switch(iS=!1,typeof options.slot_from){case"string":iS=options.node_to.findInputSlot(options.slot_from);break;case"object":-1==(iS=options.slot_from.name?options.node_to.findInputSlot(options.slot_from.name):-1)&&void 0!==options.slot_from.slot_index&&(iS=options.slot_from.slot_index);break;case"number":iS=options.slot_from;break;default:iS=0}void 0!==options.node_to.inputs[iS]?!1!==iS&&-1<iS&&options.node_to.connectByTypeOutput(iS,node,options.node_to.inputs[iS].type):LiteGraph.log_warn("lgraphcanvas","showSearchBox","select","cant find slot node_to to join using from slot type",options.slot_from,options.node_to.inputs)}graphcanvas.graph.afterChange()}}dialog.close()}function changeSelection(forward){var prev=selected;selected&&selected.classList.remove("selected"),(selected=selected?(selected=forward?selected.nextSibling:selected.previousSibling)||prev:forward?helper.childNodes[0]:helper.childNodes[helper.childNodes.length])&&(selected.classList.add("selected"),selected.scrollIntoView({block:"end",behavior:"smooth"}))}function refreshHelper(){timeout=null;var str=input.value;if(first=null,helper.innerHTML="",str||options.show_all_if_empty)if(that.onSearchBox){var list=that.onSearchBox(helper,str,graphcanvas);if(list)for(let i=0;i<list.length;++i)addResult(list[i])}else{var i,c=0,str=str.toLowerCase(),filter=graphcanvas.filter||graphcanvas.graph.filter;let sIn,sOut;for(i in sOut=options.do_type_filter&&that.search_box?(sIn=that.search_box.querySelector(".slot_in_type_filter"),that.search_box.querySelector(".slot_out_type_filter")):sIn=!1,LiteGraph.searchbox_extras){var i_srch,extra=LiteGraph.searchbox_extras[i],str_node=extra.desc.toLowerCase(),str_title=extra.title?extra.title.toLowerCase():"";let passTextSearch=!0;for(i_srch of str.toLowerCase().split(" "))if(""!==i_srch.trim()&&-1==str_node.indexOf(i_srch)&&-1==str_title.indexOf(i_srch)){passTextSearch=!1;break}if(options.show_all_if_empty&&!str||passTextSearch){var ctor=LiteGraph.registered_node_types[extra.type];if((!ctor||ctor.filter==filter)&&inner_test_filter(extra.type)&&(addResult(extra.desc,"searchbox_extra"),-1!==LGraphCanvas.search_limit)&&c++>LGraphCanvas.search_limit)break}}var filtered=null;if(Array.prototype.filter)filtered=Object.keys(LiteGraph.registered_node_types).filter(inner_test_filter);else{filtered=[];for(let i in LiteGraph.registered_node_types)inner_test_filter(i)&&filtered.push(i)}for(let i=0;i<filtered.length&&(addResult(filtered[i]),!(-1!==LGraphCanvas.search_limit&&c++>LGraphCanvas.search_limit));i++);if(options.show_general_after_typefiltered&&(sIn.value||sOut.value)){var filtered_extra=[];for(let i in LiteGraph.registered_node_types)inner_test_filter(i,{inTypeOverride:!(!sIn||!sIn.value)&&"*",outTypeOverride:!(!sOut||!sOut.value)&&"*"})&&filtered_extra.push(i);for(let i=0;i<filtered_extra.length&&(addResult(filtered_extra[i],"generic_type"),!(-1!==LGraphCanvas.search_limit&&c++>LGraphCanvas.search_limit));i++);}if((sIn.value||sOut.value)&&0==helper.childNodes.length&&options.show_general_if_none_on_typefilter){let filtered_extra=[];for(let i in LiteGraph.registered_node_types)inner_test_filter(i,{skipFilter:!0})&&filtered_extra.push(i);for(let i=0;i<filtered_extra.length&&(addResult(filtered_extra[i],"not_in_filter"),!(-1!==LGraphCanvas.search_limit&&c++>LGraphCanvas.search_limit));i++);}function inner_test_filter(type,optsIn={}){var optsIn=Object.assign({skipFilter:!1,inTypeOverride:!1,outTypeOverride:!1},optsIn),ctor=LiteGraph.registered_node_types[type];if(filter&&ctor.filter!=filter)return!1;var i_srch,str_node=type.toLowerCase();let passTextSearch=!0;for(i_srch of str.toLowerCase().split(" "))if(LiteGraph.log_verbose("search","check",i_srch,str_node),""!==i_srch.trim()&&-1==str_node.indexOf(i_srch)){passTextSearch=!1,LiteGraph.log_verbose("search","do not pass",i_srch,str_node);break}if((!options.show_all_if_empty||str)&&!passTextSearch)return!1;if(options.do_type_filter&&!optsIn.skipFilter){ctor=type;let doesInc;type=sIn.value;if(!1!==optsIn.inTypeOverride&&(type=optsIn.inTypeOverride),sIn&&type&&LiteGraph.registered_slot_in_types[type]&&LiteGraph.registered_slot_in_types[type].nodes&&!1===(doesInc=LiteGraph.registered_slot_in_types[type].nodes.includes(ctor)))return!1;if(type=sOut.value,!1!==optsIn.outTypeOverride&&(type=optsIn.outTypeOverride),sOut&&type&&LiteGraph.registered_slot_out_types[type]&&LiteGraph.registered_slot_out_types[type].nodes&&!1===(doesInc=LiteGraph.registered_slot_out_types[type].nodes.includes(ctor)))return!1}return!0}}function addResult(type,className){var help=document.createElement("div");first=first||type,help.innerText=type,help.dataset.type=escape(type),help.className="litegraph lite-search-item",className&&(help.className+=" "+className),help.addEventListener("click",function(_event){select(unescape(this.dataset.type))}),helper.appendChild(help)}}return def_options.width-left<470&&(left=def_options.width-470),def_options.height-top<220&&(top=def_options.height-220),left<def_options.left+20&&(left=def_options.left+20),top<def_options.top+20&&(top=def_options.top+20),dialog.style.left=left+"px",dialog.style.top=top+"px",input.focus(),options.show_all_on_open&&refreshHelper(),dialog}showEditPropertyValue(node,property,options){if(node&&void 0!==node.properties[property]){options=options||{};var info=node.getPropertyInfo(property);let type=info&&null!==info?info.type:"string",input_html;if("string"==type||"number"==type||"array"==type||"object"==type||"code"==type)input_html="<input autofocus type='text' class='value'/>";else if("enum"!=type&&"combo"!=type||!info.values){if("boolean"!=type&&"toggle"!=type)return void LiteGraph.log_warn("lgraphcanvas","showEditPropertyValue","unknown type",type);input_html="<input autofocus type='checkbox' class='value' "+(node.properties[property]?"checked":"")+"/>"}else{for(var i in LiteGraph.log_debug("lgraphcanvas","showEditPropertyValue","CREATING ENUM COMBO",input,type,dialog),input_html="<select autofocus type='text' class='value'>",info.values){var v=i;info.values.constructor===Array&&(v=info.values[i]),input_html+="<option value='"+v+"' "+(v==node.properties[property]?"selected":"")+">"+info.values[i]+"</option>"}input_html+="</select>"}var dialog=this.createDialog("<span class='name'>"+(info.label||property)+"</span>"+input_html+"<button>OK</button>",options),input=!1;return"enum"!=type&&"combo"!=type||!info.values?"boolean"==type||"toggle"==type?(LiteGraph.log_debug("lgraphcanvas","showEditPropertyValue","TOGGLE",input,type,dialog),(input=dialog.querySelector("input"))&&input.addEventListener("click",function(_event){dialog.modified(),setValue(!!input.checked)})):(input=dialog.querySelector("input"),LiteGraph.log_debug("lgraphcanvas","showEditPropertyValue",input,type,dialog),input&&(input.addEventListener("blur",function(_event){this.focus()}),v=void 0!==node.properties[property]?node.properties[property]:"","string"!==type&&(v=JSON.stringify(v)),input.value=v,input.addEventListener("keydown",function(e){if(27==e.keyCode)dialog.close();else if(13==e.keyCode)inner();else if(13!=e.keyCode)return void dialog.modified();e.preventDefault(),e.stopPropagation()}))):(LiteGraph.log_debug("lgraphcanvas","showEditPropertyValue","showEditPropertyValue ENUM COMBO",input,type,dialog),(input=dialog.querySelector("select")).addEventListener("change",function(e){dialog.modified(),LiteGraph.log_debug("lgraphcanvas","showEditPropertyValue","Enum change",input,info,e.target),setValue(e.target.value)})),input&&input.focus(),dialog.querySelector("button").addEventListener("click",inner),dialog;function inner(){setValue(input.value)}function setValue(value){info&&info.values&&info.values.constructor===Object&&null!=info.values[value]&&(value=info.values[value]),"number"==typeof node.properties[property]&&(value=Number(value)),"array"!=type&&"object"!=type||(value=JSON.parse(value));var prevValue=node.properties[property],r=(node.properties[property]=value,node.graph?.onGraphChanged({action:"propertyChanged",doSave:!0}),node.processCallbackHandlers("onPropertyChanged",{def_cb:node.onPropertyChanged},property,value,prevValue));(!1===r||null!==r&&"object"==typeof r&&!1===r.return_value)&&(node.properties[property]=prevValue,LiteGraph.log_debug("lgraphcanvas","showEditPropertyValue","setValue","prevent property set by cbHandler",property,value,prevValue,r)),options.onclose&&options.onclose(),dialog.close(),node.setDirtyCanvas(!0,!0)}}}createDialog(html,options){options=Object.assign({checkForInput:!1,closeOnLeave:!0,closeOnLeave_checkModified:!0},options||{});var dialog=document.createElement("div"),html=(dialog.className="graphdialog",dialog.innerHTML=html,dialog.is_modified=!1,this.canvas.getBoundingClientRect()),offsetx=-20,offsety=-20,dialogCloseTimer=(html&&(offsetx-=html.left,offsety-=html.top),options.position?(offsetx+=options.position[0],offsety+=options.position[1]):options.event?(offsetx+=options.event.clientX,offsety+=options.event.clientY):(offsetx+=.5*this.canvas.width,offsety+=.5*this.canvas.height),dialog.style.left=offsetx+"px",dialog.style.top=offsety+"px",this.canvas.parentNode.appendChild(dialog),options.checkForInput&&(html=[],html=dialog.querySelectorAll("input"))&&html.forEach(function(iX){iX.addEventListener("keydown",function(e){if(dialog.modified(),27==e.keyCode)dialog.close();else if(13!=e.keyCode)return;e.preventDefault(),e.stopPropagation()}),iX.focus()}),dialog.modified=function(){dialog.is_modified=!0},dialog.close=function(){dialog.parentNode&&dialog.parentNode.removeChild(dialog)},null),prevent_timeout=!1,offsetx=(dialog.addEventListener("pointerleave",function(_event){prevent_timeout||(options.closeOnLeave||LiteGraph.dialog_close_on_mouse_leave)&&!dialog.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(dialogCloseTimer=setTimeout(dialog.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),dialog.addEventListener("pointerenter",function(_event){(options.closeOnLeave||LiteGraph.dialog_close_on_mouse_leave)&&dialogCloseTimer&&clearTimeout(dialogCloseTimer)}),dialog.querySelectorAll("select"));return offsetx&&offsetx.forEach(function(selIn){selIn.addEventListener("click",function(_event){prevent_timeout++}),selIn.addEventListener("blur",function(_event){prevent_timeout=0}),selIn.addEventListener("change",function(_event){prevent_timeout=-1})}),dialog}createPanel(title,options){var ref_window=(options=options||{}).window||window,root=document.createElement("div");return root.className="litegraph dialog",root.innerHTML="<div class='dialog-header'><span class='dialog-title'></span></div><div class='dialog-content'></div><div style='display:none;' class='dialog-alt-content'></div><div class='dialog-footer'></div>",root.header=root.querySelector(".dialog-header"),options.width&&(root.style.width=options.width+(options.width.constructor===Number?"px":"")),options.height&&(root.style.height=options.height+(options.height.constructor===Number?"px":"")),options.closable&&((options=document.createElement("span")).innerHTML="&#10005;",options.classList.add("close"),options.addEventListener("click",function(){root.close()}),root.header.appendChild(options)),root.title_element=root.querySelector(".dialog-title"),root.title_element.innerText=title,root.content=root.querySelector(".dialog-content"),root.alt_content=root.querySelector(".dialog-alt-content"),root.footer=root.querySelector(".dialog-footer"),root.close=function(){root.onClose&&"function"==typeof root.onClose&&root.onClose(),root.parentNode&&root.parentNode.removeChild(root),this.parentNode&&this.parentNode.removeChild(this)},root.toggleAltContent=function(force){let vTo,vAlt;vAlt=void 0!==force?(vTo=force?"block":"none",force?"none":"block"):(vTo="block"!=root.alt_content.style.display?"block":"none","block"!=root.alt_content.style.display?"none":"block"),root.alt_content.style.display=vTo,root.content.style.display=vAlt},root.toggleFooterVisibility=function(force){let vTo;vTo=void 0!==force?force?"block":"none":"block"!=root.footer.style.display?"block":"none",root.footer.style.display=vTo},root.clear=function(){this.content.innerHTML=""},root.addHTML=function(code,classname,on_footer){var elem=document.createElement("div");return classname&&(elem.className=classname),elem.innerHTML=code,(on_footer?root.footer:root.content).appendChild(elem),elem},root.addButton=function(name,callback,options){var elem=document.createElement("button");return elem.innerText=name,elem.options=options,elem.classList.add("btn"),elem.addEventListener("click",callback),root.footer.appendChild(elem),elem},root.addSeparator=function(){var elem=document.createElement("div");elem.className="separator",root.content.appendChild(elem)},root.addWidget=function(type,name,value,options,callback){options=options||{};var str_value=String(value),elem=("number"==(type=type.toLowerCase())&&(str_value=LiteGraph.formatNumber(value,3)),document.createElement("div")),value_element=(elem.className="property",elem.innerHTML="<span class='property_name'></span><span class='property_value'></span>",elem.querySelector(".property_name").innerText=options.label||name,elem.querySelector(".property_value"));function innerChange(name,value){LiteGraph.log_debug("lgraphcanvas","createPanel","addWidget","innerChange",name,value,options),options.callback&&options.callback(name,value,options),callback&&callback(name,value,options)}return value_element.innerText=str_value,elem.dataset.property=name,elem.dataset.type=options.type||type,elem.options=options,elem.value=value,LiteGraph.log_debug("lgraphcanvas","createPanel","addWidget",type,value,value_element,options),"code"==type?elem.addEventListener("click",function(_event){root.inner_showCodePad(this.dataset.property)}):"boolean"==type?(elem.classList.add("boolean"),value&&elem.classList.add("bool-on"),elem.addEventListener("click",function(){var propname=this.dataset.property;this.value=!this.value,this.classList.toggle("bool-on"),this.querySelector(".property_value").innerText=this.value?"on":"off",innerChange(propname,this.value)})):"string"==type||"number"==type?(value_element.setAttribute("contenteditable",!0),value_element.addEventListener("keydown",function(e){"Enter"!=e.code||"string"==type&&e.shiftKey||(e.preventDefault(),this.blur())}),value_element.addEventListener("blur",function(){var v=this.innerText;innerChange(this.parentNode.dataset.property,v="number"==this.parentNode.dataset.type?Number(v):v)})):"enum"!=type&&"combo"!=type||(str_value=LGraphCanvas.getPropertyPrintableValue(value,options.values),value_element.innerText=str_value,LiteGraph.log_debug("lgraphcanvas","createPanel","addWidget","ENUM COMBO",type,str_value,value_element,options),value_element.addEventListener("click",function(event){var values=options.values||[],propname=this.parentNode.dataset.property,elem_that=this;LiteGraph.ContextMenu(values,{event:event,className:"dark",callback:function(v){return elem_that.innerText=v,innerChange(propname,v),!1}},ref_window)})),root.content.appendChild(elem),elem},root.onOpen&&"function"==typeof root.onOpen&&root.onOpen(),root}static getPropertyPrintableValue(value,values){if(!values)return String(value);if(values.constructor===Array)return String(value);if(values.constructor===Object){var k,desc_value="";for(k in values)if(values[k]==value){desc_value=k;break}return String(value)+" ("+desc_value+")"}}showShowGraphOptionsPanel(refOpts,obEv){let graphcanvas;if(this.constructor&&"HTMLDivElement"==this.constructor.name){if(!obEv?.event?.target?.lgraphcanvas)return LiteGraph.log_warn("lgraphcanvas","showShowGraphOptionsPanel","References not found to add optionPanel",refOpts,obEv),void LiteGraph.log_debug("lgraphcanvas","showShowGraphOptionsPanel","!obEv || !obEv.event || !obEv.event.target || !obEv.event.target.lgraphcanvas",obEv,obEv.event,obEv.event.target,obEv.event.target.lgraphcanvas);graphcanvas=obEv.event.target.lgraphcanvas}else graphcanvas=this;graphcanvas.closePanels();refOpts=graphcanvas.getCanvasWindow();panel=graphcanvas.createPanel("Options",{closable:!0,window:refOpts,onOpen:function(){graphcanvas.OPTIONPANEL_IS_OPEN=!0},onClose:function(){graphcanvas.OPTIONPANEL_IS_OPEN=!1,graphcanvas.options_panel=null}}),(graphcanvas.options_panel=panel).id="option-panel",panel.classList.add("settings"),panel.content.innerHTML="";var pI,fUpdate=(name,value,options)=>{LiteGraph.log_verbose("lgraphcanvas","showShowGraphOptionsPanel","want to update graph options: "+name+": "+value),options&&options.key&&(name=options.key),options.values&&(value=Object.values(options.values).indexOf(value)),LiteGraph.log_verbose("lgraphcanvas","showShowGraphOptionsPanel","update graph option: "+name+": "+value),graphcanvas[name]=value},aProps=LiteGraph.availableCanvasOptions;for(pI in aProps.sort(),aProps){var pX=aProps[pI];panel.addWidget("boolean",pX,graphcanvas[pX],{key:pX,on:"on",off:"off"},fUpdate)}panel.addWidget("combo","Render mode",LiteGraph.LINK_RENDER_MODES[graphcanvas.links_render_mode],{key:"links_render_mode",values:LiteGraph.LINK_RENDER_MODES},fUpdate),panel.addSeparator(),panel.footer.innerHTML="",graphcanvas.canvas.parentNode.appendChild(panel)}showShowNodePanel(node){this.SELECTED_NODE=node,this.closePanels();var ref_window=this.getCanvasWindow(),graphcanvas=this,panel=this.createPanel(node.title||"",{closable:!0,window:ref_window,onOpen:function(){graphcanvas.NODEPANEL_IS_OPEN=!0},onClose:function(){graphcanvas.NODEPANEL_IS_OPEN=!1,graphcanvas.node_panel=null}});function inner_refresh(){panel.content.innerHTML="",panel.addHTML("<span class='node_type'>"+node.type+"</span><span class='node_desc'>"+(node.constructor.desc||"")+"</span><span class='separator'></span>"),panel.addHTML("<h3>Properties</h3>");var pName,fUpdate=(name,value)=>{switch(graphcanvas.graph.beforeChange(node),name){case"Title":node.title=value;break;case"Mode":var kV=Object.values(LiteGraph.NODE_MODES).indexOf(value);0<=kV&&LiteGraph.NODE_MODES[kV]?node.changeMode(kV):LiteGraph.log_warn("lgraphcanvas","showShowNodePanel","unexpected mode",value,kV);break;case"Color":LGraphCanvas.node_colors[value]?(node.color=LGraphCanvas.node_colors[value].color,node.bgcolor=LGraphCanvas.node_colors[value].bgcolor):LiteGraph.log_warn("lgraphcanvas","showShowNodePanel","unexpected color",value);break;default:node.setProperty(name,value)}graphcanvas.graph.afterChange(),graphcanvas.dirty_canvas=!0},nodeCol=(panel.addWidget("string","Title",node.title,{},fUpdate),panel.addWidget("combo","Mode",LiteGraph.NODE_MODES[node.mode],{values:LiteGraph.NODE_MODES},fUpdate),"");for(pName in void 0!==node.color&&(nodeCol=Object.keys(LGraphCanvas.node_colors).filter(function(nK){return LGraphCanvas.node_colors[nK].color==node.color})),panel.addWidget("combo","Color",nodeCol,{values:Object.keys(LGraphCanvas.node_colors)},fUpdate),node.properties){var value=node.properties[pName],info=node.getPropertyInfo(pName),type=info&&null!==info?info.type:"string";node.onAddPropertyToPanel&&node.onAddPropertyToPanel(pName,panel,value,info,fUpdate)||panel.addWidget(info.widget||type,pName,value,info,fUpdate)}panel.addSeparator(),node.onShowCustomPanelInfo&&node.onShowCustomPanelInfo(panel),panel.footer.innerHTML="",panel.addButton("Delete",function(){node.block_delete||(node.graph.remove(node),panel.close())}).classList.add("delete")}(graphcanvas.node_panel=panel).id="node-panel",panel.node=node,panel.classList.add("settings"),panel.inner_showCodePad=function(propname){panel.classList.remove("settings"),panel.classList.add("centered"),panel.alt_content.innerHTML="<textarea class='code'></textarea>";var textarea=panel.alt_content.querySelector("textarea"),fDoneWith=()=>{panel.toggleAltContent(!1),panel.toggleFooterVisibility(!0),textarea.parentNode.removeChild(textarea),panel.classList.add("settings"),panel.classList.remove("centered"),inner_refresh()},assign=(textarea.value=node.properties[propname],textarea.addEventListener("keydown",function(e){"Enter"==e.code&&e.ctrlKey&&(node.setProperty(propname,textarea.value),fDoneWith())}),panel.toggleAltContent(!0),panel.toggleFooterVisibility(!1),textarea.style.height="calc(100% - 40px)",panel.addButton("Assign",function(){node.setProperty(propname,textarea.value),fDoneWith()})),assign=(panel.alt_content.appendChild(assign),panel.addButton("Close",fDoneWith));assign.style.float="right",panel.alt_content.appendChild(assign)},inner_refresh(),this.canvas.parentNode.appendChild(panel)}showSubgraphPropertiesDialog(node){LiteGraph.log_debug("lgraphcanvas","showSubgraphPropertiesDialog","showing subgraph properties dialog");var old_panel=this.canvas.parentNode.querySelector(".subgraph_dialog"),panel=(old_panel&&old_panel.close(),this.createPanel("Subgraph Inputs",{closable:!0,width:500}));function inner_refresh(){if(panel.clear(),node.inputs)for(let i=0;i<node.inputs.length;++i){var elem,input=node.inputs[i];input.not_subgraph_input||((elem=panel.addHTML("<button>&#10005;</button> <span class='bullet_icon'></span><span class='name'></span><span class='type'></span>","subgraph_property")).dataset.name=input.name,elem.dataset.slot=i,elem.querySelector(".name").innerText=input.name,elem.querySelector(".type").innerText=input.type,elem.querySelector("button").addEventListener("click",function(_event){node.removeInput(Number(this.parentNode.dataset.slot)),inner_refresh()}))}}panel.node=node,panel.classList.add("subgraph_dialog");return panel.addHTML(" + <span class='label'>Name</span><input class='name'/><span class='label'>Type</span><input class='type'></input><button>+</button>","subgraph_property extra",!0).querySelector("button").addEventListener("click",function(_event){var elem=this.parentNode,name=elem.querySelector(".name").value,type=elem.querySelector(".type").value;name&&-1==node.findInputSlot(name)&&(-1<["event","action"].indexOf(type)&&(type=LiteGraph.EVENT),node.addInput(name,type),elem.querySelector(".name").value="",elem.querySelector(".type").value="",inner_refresh())}),inner_refresh(),this.canvas.parentNode.appendChild(panel),panel}showSubgraphPropertiesDialogRight(node){LiteGraph.log_verbose("lgraphcanvas","showSubgraphPropertiesDialogRight","showing subgraph properties dialog RIGHT");var old_panel=this.canvas.parentNode.querySelector(".subgraph_dialog"),panel=(old_panel&&old_panel.close(),this.createPanel("Subgraph Outputs",{closable:!0,width:500}));function inner_refresh(){if(panel.clear(),node.outputs)for(let i=0;i<node.outputs.length;++i){var elem,input=node.outputs[i];input.not_subgraph_output||((elem=panel.addHTML("<button>&#10005;</button> <span class='bullet_icon'></span><span class='name'></span><span class='type'></span>","subgraph_property")).dataset.name=input.name,elem.dataset.slot=i,elem.querySelector(".name").innerText=input.name,elem.querySelector(".type").innerText=input.type,elem.querySelector("button").addEventListener("click",function(_event){node.removeOutput(Number(this.parentNode.dataset.slot)),inner_refresh()}))}}panel.node=node,panel.classList.add("subgraph_dialog");old_panel=panel.addHTML(" + <span class='label'>Name</span><input class='name'/><span class='label'>Type</span><input class='type'></input><button>+</button>","subgraph_property extra",!0);function addOutput(){var elem=this.parentNode,name=elem.querySelector(".name").value,type=elem.querySelector(".type").value;name&&-1==node.findOutputSlot(name)&&(-1<["event","action"].indexOf(type)&&(type=LiteGraph.EVENT),node.addOutput(name,type),elem.querySelector(".name").value="",elem.querySelector(".type").value="",inner_refresh())}return old_panel.querySelector(".name").addEventListener("keydown",function(_event){13==_event.keyCode&&addOutput.apply(this)}),old_panel.querySelector("button").addEventListener("click",function(_event){addOutput.apply(this)}),inner_refresh(),this.canvas.parentNode.appendChild(panel),panel}closePanels(){var panel=document.querySelector("#node-panel");panel&&panel.close(),(panel=document.querySelector("#option-panel"))&&panel.close()}checkPanels(){if(this.canvas){var panels=this.canvas.parentNode.querySelectorAll(".litegraph.dialog");for(let i=0;i<panels.length;++i){var panel=panels[i];!panel.node||panel.node.graph&&panel.graph==this.graph||panel.close()}}}static onMenuNodeCollapse(value,options,e,menu,node){node.graph.beforeChange();var graphcanvas=LGraphCanvas.active_canvas;if(!graphcanvas.selected_nodes||Object.keys(graphcanvas.selected_nodes).length<=1)node.collapse();else for(var i in graphcanvas.selected_nodes)graphcanvas.selected_nodes[i].collapse();node.graph.afterChange()}static onMenuNodePin(value,options,e,menu,node){node.pin()}static onMenuNodeMode(value,options,e,menu,node){return LiteGraph.ContextMenu(LiteGraph.NODE_MODES,{event:e,callback:function(v){if(node){var kV=Object.values(LiteGraph.NODE_MODES).indexOf(v),fApplyMultiNode=node=>{0<=kV&&LiteGraph.NODE_MODES[kV]?node.changeMode(kV):(LiteGraph.log_warn("lgraphcanvas","onMenuNodeMode","unexpected mode",v,kV),node.changeMode(LiteGraph.ALWAYS))},graphcanvas=LGraphCanvas.active_canvas;if(!graphcanvas.selected_nodes||Object.keys(graphcanvas.selected_nodes).length<=1)fApplyMultiNode(node);else for(var i in graphcanvas.selected_nodes)fApplyMultiNode(graphcanvas.selected_nodes[i])}},parentMenu:menu,node:node}),!1}static onMenuNodeColors(value,options,e,menu,node){if(node){var i,values=[];for(i in values.push({value:null,content:"<span style='display: block; padding-left: 4px;'>No color</span>"}),LGraphCanvas.node_colors){var color=LGraphCanvas.node_colors[i];value={value:i,content:"<span style='display: block; color: #999; padding-left: 4px; border-left: 8px solid "+color.color+"; background-color:"+color.bgcolor+"'>"+i+"</span>"},values.push(value)}return LiteGraph.ContextMenu(values,{event:e,callback:function(v){if(node){let color=v.value?LGraphCanvas.node_colors[v.value]:null;var fApplyColor=node=>{color?node.constructor===LiteGraph.LGraphGroup?node.color=color.groupcolor:(node.color=color.color,node.bgcolor=color.bgcolor):(delete node.color,delete node.bgcolor)},graphcanvas=LGraphCanvas.active_canvas;if(!graphcanvas.selected_nodes||Object.keys(graphcanvas.selected_nodes).length<=1)fApplyColor(node);else for(var i in graphcanvas.selected_nodes)fApplyColor(graphcanvas.selected_nodes[i]);node.setDirtyCanvas(!0,!0)}else LiteGraph.log_warn("lgraphcanvas","onMenuNodeColors","inner_clicked","no node")},parentMenu:menu,node:node}),!1}LiteGraph.log_warn("lgraphcanvas","onMenuNodeColors","invalid node")}static onMenuNodeShapes(value,options,e,menu,node){if(node)return LiteGraph.ContextMenu(LiteGraph.VALID_SHAPES,{event:e,callback:function(v){if(node){node.graph.beforeChange();var fApplyMultiNode=node=>{node.shape=v},graphcanvas=LGraphCanvas.active_canvas;if(!graphcanvas.selected_nodes||Object.keys(graphcanvas.selected_nodes).length<=1)fApplyMultiNode(node);else for(var i in graphcanvas.selected_nodes)fApplyMultiNode(graphcanvas.selected_nodes[i]);node.graph.afterChange(),node.setDirtyCanvas(!0)}else LiteGraph.log_warn("lgraphcanvas","onMenuNodeShapes","inner_clicked","no node")},parentMenu:menu,node:node}),!1;LiteGraph.log_warn("lgraphcanvas","onMenuNodeShapes","invalid node")}static onMenuNodeRemove(value,options,e,menu,node){if(node){var graph=node.graph,fApplyMultiNode=(graph.beforeChange(),node=>{!1!==node.removable&&graph.remove(node)}),graphcanvas=LGraphCanvas.active_canvas;if(!graphcanvas.selected_nodes||Object.keys(graphcanvas.selected_nodes).length<=1)fApplyMultiNode(node);else for(var i in graphcanvas.selected_nodes)fApplyMultiNode(graphcanvas.selected_nodes[i]);graph.afterChange(),node.setDirtyCanvas(!0,!0)}else LiteGraph.log_warn("lgraphcanvas","onMenuNodeShapes","invalid node")}static onMenuNodeToSubgraph(value,options,e,menu,node){var nodes_list,subgraph_node,graph=node.graph,graphcanvas=LGraphCanvas.active_canvas;graphcanvas?((nodes_list=Object.values(graphcanvas.selected_nodes||{})).length||(nodes_list=[node]),(subgraph_node=LiteGraph.createNode("graph/subgraph")).pos=node.pos.concat(),graph.add(subgraph_node),subgraph_node.buildFromNodes(nodes_list),graphcanvas.deselectAllNodes(),node.setDirtyCanvas(!0,!0)):LiteGraph.log_warn("lgraphcanvas","onMenuNodeToSubgraph","graphcanvas invalid")}static onMenuNodeClone(value,options,e,menu,node){node.graph.beforeChange();var newSelected={},fApplyMultiNode=node=>{var newnode;!1!==node.clonable&&(newnode=node.clone())&&(newnode.pos=[node.pos[0]+5,node.pos[1]+5],node.graph.add(newnode),newSelected[newnode.id]=newnode)},graphcanvas=LGraphCanvas.active_canvas;if(!graphcanvas.selected_nodes||Object.keys(graphcanvas.selected_nodes).length<=1)fApplyMultiNode(node);else for(var i in graphcanvas.selected_nodes)fApplyMultiNode(graphcanvas.selected_nodes[i]);Object.keys(newSelected).length&&graphcanvas.selectNodes(newSelected),node.graph.afterChange(),node.setDirtyCanvas(!0,!0)}getCanvasMenuOptions(){var options=null,r=this.processCallbackHandlers("getMenuOptions",{def_cb:this.getMenuOptions});return null!==r&&(!0===r||"object"==typeof r&&!0===r.return_value)||(options=[{content:"Add Node",has_submenu:!0,callback:LGraphCanvas.onMenuAdd},{content:"Search",has_submenu:!1,callback:this.showSearchBox},{content:"Add Group",callback:LGraphCanvas.onGroupAdd}],1<Object.keys(this.selected_nodes).length&&options.push({content:"Align",has_submenu:!0,callback:LGraphCanvas.onGroupAlign}),this._graph_stack&&0<this._graph_stack.length&&options.push(null,{content:"Close subgraph",callback:this.closeSubgraph.bind(this)})),options=null!==(r=this.processCallbackHandlers("getExtraMenuOptions",{def_cb:this.getExtraMenuOptions},this,options))&&"object"==typeof r&&"object"==typeof r.return_value?options.concat(r.return_value):options}getNodeMenuOptions(node){var options=null,r=node.processCallbackHandlers("getMenuOptions",{def_cb:node.getMenuOptions},this);return null===(options=null!==r&&"object"==typeof r&&"object"==typeof r.return_value?r.return_value:options)&&(!(options=[{content:"Inputs",has_submenu:!0,callback:LGraphCanvas.showMenuNodeOptionalInputs},{content:"Outputs",has_submenu:!0,callback:LGraphCanvas.showMenuNodeOptionalOutputs},null,{content:"Properties",has_submenu:!0,callback:LGraphCanvas.onShowMenuNodeProperties},null,{content:"Title",callback:LGraphCanvas.onShowNodeInfoEditor},{content:"Mode",has_submenu:!0,callback:LGraphCanvas.onMenuNodeMode}])!==node.resizable&&options.push({content:"Resize",callback:LGraphCanvas.onMenuResizeNode}),options.push({content:"Collapse",callback:LGraphCanvas.onMenuNodeCollapse},{content:"Pin",callback:LGraphCanvas.onMenuNodePin},{content:"Colors",has_submenu:!0,callback:LGraphCanvas.onMenuNodeColors},{content:"Shapes",has_submenu:!0,callback:LGraphCanvas.onMenuNodeShapes},null)),LiteGraph.do_add_triggers_slots&&(options[1].disabled=!1),null!==(r=node.processCallbackHandlers("getExtraMenuOptions",{def_cb:node.getExtraMenuOptions},this,options))&&"object"==typeof r&&"object"==typeof r.return_value&&void 0!==r.return_value.length&&r.return_value.length&&(extra.push(null),options=extra.concat(r.return_value)),!1!==node.clonable&&options.push({content:"Clone",callback:LGraphCanvas.onMenuNodeClone}),1<Object.keys(this.selected_nodes).length&&options.push({content:"Align Selected To",has_submenu:!0,callback:LGraphCanvas.onNodeAlign}),options.push(null,{content:"Remove",disabled:!(!1!==node.removable&&!node.block_delete),callback:LGraphCanvas.onMenuNodeRemove}),node.graph&&node.graph.processCallbackHandlers("onGetNodeMenuOptions",{def_cb:node.graph.onGetNodeMenuOptions},options,node),options}getGroupMenuOptions(){return[{content:"Title",callback:LGraphCanvas.onShowNodeInfoEditor},{content:"Color",has_submenu:!0,callback:LGraphCanvas.onMenuNodeColors},{content:"Font size",property:"font_size",type:"Number",callback:LGraphCanvas.onShowNodeInfoEditor},null,{content:"Remove",callback:LGraphCanvas.onMenuNodeRemove}]}processContextMenu(node,event){var r,that=this,ref_window=LGraphCanvas.active_canvas.getCanvasWindow(),menu_info=null,options={event:event,callback:function(v,options){if(v){let info;var slot_info,dialog,input,inner;"Remove Slot"==v.content?(info=v.slot,node.graph.beforeChange(),info.input?node.removeInput(info.slot):info.output&&node.removeOutput(info.slot),node.graph.afterChange()):"Disconnect Links"==v.content?(info=v.slot,node.graph.beforeChange(),info.output?node.disconnectOutput(info.slot):info.input&&node.disconnectInput(info.slot),node.graph.afterChange()):"Rename Slot"==v.content&&(slot_info=(info=v.slot).input?node.getInputInfo(info.slot):node.getOutputInfo(info.slot),dialog=that.createDialog("<span class='name'>Name</span><input autofocus type='text'/><button>OK</button>",options),(input=dialog.querySelector("input"))&&slot_info&&(input.value=slot_info.label||""),inner=function(){node.graph.beforeChange(),input.value&&(slot_info&&(slot_info.label=input.value),that.setDirty(!0)),dialog.close(),node.graph.afterChange()},dialog.querySelector("button").addEventListener("click",inner),input.addEventListener("keydown",function(e){if(dialog.is_modified=!0,27==e.keyCode)dialog.close();else if(13==e.keyCode)inner();else if(13!=e.keyCode&&"textarea"!=e.target.localName)return;e.preventDefault(),e.stopPropagation()}),input.focus())}},extra:node},slot=(node&&(options.title=node.type),null);node&&(slot=node.getSlotInPosition(event.canvasX,event.canvasY),LGraphCanvas.active_node=node),slot?(menu_info=[],null!==(r=node.processCallbackHandlers("getSlotMenuOptions",{def_cb:node.getSlotMenuOptions},slot))&&"object"==typeof r&&"object"==typeof r.return_value?menu_info=r.return_value:((slot?.output?.links?.length||slot.input?.link)&&menu_info.push({content:"Disconnect Links",slot:slot}),(r=slot.input||slot.output).removable&&LiteGraph.canRemoveSlots&&menu_info.push(r.locked?"Cannot remove":{content:"Remove Slot",slot:slot}),!r.nameLocked&&LiteGraph.canRenameSlots&&menu_info.push({content:"Rename Slot",slot:slot})),r=slot.input||slot.output,options.title=r.type||"*",r.type==LiteGraph.ACTION?options.title="Action":r.type==LiteGraph.EVENT&&(options.title="Event")):node?menu_info=this.getNodeMenuOptions(node):(menu_info=this.getCanvasMenuOptions(),slot=this.graph.getGroupOnPos(event.canvasX,event.canvasY),options.filter_enabled=!1,slot&&(menu_info.push(null,{content:"Edit Group",has_submenu:!0,submenu:{title:"Group",extra:slot,options:this.getGroupMenuOptions(slot)}}),menu_info.push(null,{content:"Select nodes",canvas:this,group:slot,callback:function(this_mi,options,e,menu){console.warn(this_mi),this_mi.canvas.selectNodes(this_mi.group._nodes)}}))),menu_info&&LiteGraph.ContextMenu(menu_info,options,ref_window)}static DEFAULT_BACKGROUND_IMAGE="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAIAAAD/gAIDAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQBJREFUeNrs1rEKwjAUhlETUkj3vP9rdmr1Ysammk2w5wdxuLgcMHyptfawuZX4pJSWZTnfnu/lnIe/jNNxHHGNn//HNbbv+4dr6V+11uF527arU7+u63qfa/bnmh8sWLBgwYJlqRf8MEptXPBXJXa37BSl3ixYsGDBMliwFLyCV/DeLIMFCxYsWLBMwSt4Be/NggXLYMGCBUvBK3iNruC9WbBgwYJlsGApeAWv4L1ZBgsWLFiwYJmCV/AK3psFC5bBggULloJX8BpdwXuzYMGCBctgwVLwCl7Be7MMFixYsGDBsu8FH1FaSmExVfAxBa/gvVmwYMGCZbBg/W4vAQYA5tRF9QYlv/QAAAAASUVORK5CYII=";static link_type_colors={"-1":"#A86",number:"#AAA",node:"#DCA",string:"#77F",boolean:"#F77"};static gradients={};static search_limit=-1;static node_colors={red:{color:"#322",bgcolor:"#533",groupcolor:"#A88"},brown:{color:"#332922",bgcolor:"#593930",groupcolor:"#b06634"},green:{color:"#232",bgcolor:"#353",groupcolor:"#8A8"},blue:{color:"#223",bgcolor:"#335",groupcolor:"#88A"},pale_blue:{color:"#2a363b",bgcolor:"#3f5159",groupcolor:"#3f789e"},cyan:{color:"#233",bgcolor:"#355",groupcolor:"#8AA"},purple:{color:"#323",bgcolor:"#535",groupcolor:"#a1309b"},yellow:{color:"#432",bgcolor:"#653",groupcolor:"#b58b2a"},black:{color:"#222",bgcolor:"#000",groupcolor:"#444"}};lowQualityRenderingRequired(activation_scale){return this.ds.scale<activation_scale&&this.low_quality_rendering_counter>this.low_quality_rendering_threshold}updateBackground(image,clearBackgroundColor){this._bg_img=new Image,this._bg_img.name=image,this._bg_img.src=image,this._bg_img.onload=()=>{this.draw(!0,!0)},this.background_image=image,this.clear_background=!0,this.clear_background_color=clearBackgroundColor,this._pattern=null}}var temp=new Float32Array(4),temp_vec2=new Float32Array(2),tmp_area=new Float32Array(4),margin_area=new Float32Array(4),link_bounding=new Float32Array(4),tempA=new Float32Array(2),tempB=new Float32Array(2);class LGraphGroup{static opts={inclusion_distance:36};constructor(title="Group"){this.title=title,this.font_size=24,this.color=LiteGraph.LGraphCanvas.node_colors.pale_blue?.groupcolor??"#AAA",this._bounding=new Float32Array([10,10,140,80]),this._pos=this._bounding.subarray(0,2),this._size=this._bounding.subarray(2,4),this._nodes=[],this._groups=[],this.graph=null,this.callbackhandler_setup()}callbackhandler_setup(){this.cb_handler=new CallbackHandler(this)}registerCallbackHandler(){return this.cb_handler||this.callbackhandler_setup(),this.cb_handler.registerCallbackHandler(...arguments)}unregisterCallbackHandler(){return this.cb_handler||this.callbackhandler_setup(),this.cb_handler.unregisterCallbackHandler(...arguments)}processCallbackHandlers(){return this.cb_handler||this.callbackhandler_setup(),this.cb_handler.processCallbackHandlers(...arguments)}set pos(v){!v||v.length<2||(this._pos[0]=v[0],this._pos[1]=v[1])}get pos(){return this._pos}set size(v){!v||v.length<2||(this._size[0]=Math.max(140,v[0]),this._size[1]=Math.max(80,v[1]))}get size(){return this._size}configure(o){this.title=o.title,this._bounding=LiteGraph.cloneObject(o.bounding,this._bounding),this.color=o.color,o.font_size&&(this.font_size=o.font_size)}serialize(){var b=this._bounding;return{title:this.title,bounding:b.map(value=>Math.round(value)),color:this.color,font_size:this.font_size}}move(deltax,deltay,ignore_nodes){isNaN(deltax)&&console.error?.("LGraphGroup.move() deltax NaN"),isNaN(deltay)&&console.error?.("LGraphGroup.move() deltay NaN"),this._pos[0]+=deltax,this._pos[1]+=deltay,ignore_nodes||(this._nodes.forEach(node=>{node.pos[0]+=deltax,node.pos[1]+=deltay}),this._groups.forEach(group=>{group.pos[0]+=deltax,group.pos[1]+=deltay}))}recomputeInsideNodes(){this._nodes.length=0;var nodes=this.graph._nodes,node_bounding=new Float32Array(4);this._nodes=nodes.filter(node=>(node.getBounding(node_bounding),LiteGraph.overlapBounding(this._bounding,node_bounding,-LGraphGroup.opts.inclusion_distance))),this.recomputeInsideGroups()}recomputeInsideGroups(){this._groups.length=0;var groups=this.graph._groups,group_bounding=new Float32Array(4);this._groups=groups.filter(group=>(group.getBounding(group_bounding),LiteGraph.isBoundingInsideRectangle(group_bounding,...this._bounding)))}getBounding=function(){LiteGraph.LGraphNode.prototype.getBounding.call(this,...arguments)};isPointInside=LiteGraph.LGraphNode.prototype.isPointInside;setDirtyCanvas=LiteGraph.LGraphNode.prototype.setDirtyCanvas}class LGraphNode{cb_handler=!1;constructor(title=""){LiteGraph.log_verbose("lgraphNODE","ORIGINAL constructor",this,title),this.title=title,this.post_constructor(...arguments)}post_constructor(){this.size??=LiteGraph.NODE_MIN_SIZE,this.size_basic??=this.size,this.graph??=null,this._pos??=new Float32Array(10,10),LiteGraph.use_uuids?this.id??=LiteGraph.uuidv4():this.id??=-1,this.type??=null,this.inputs??=[],this.outputs??=[],this.connections??=[],this.properties??={},this.properties_info??=[],this.flags??={},this.callbackhandler_setup(),this.processCallbackHandlers("onPostConstruct",{def_cb:this.onPostConstruct}),LiteGraph.processCallbackHandlers("on_lgraphnode_construct",{def_cb:LiteGraph.on_lgraphnode_construct},this)}callbackhandler_setup(){this.cb_handler=new CallbackHandler(this)}registerCallbackHandler(){return this.cb_handler||this.callbackhandler_setup(),this.cb_handler.registerCallbackHandler(...arguments)}unregisterCallbackHandler(){return this.cb_handler||this.callbackhandler_setup(),this.cb_handler.unregisterCallbackHandler(...arguments)}processCallbackHandlers(){return this.cb_handler||this.callbackhandler_setup(),this.cb_handler.processCallbackHandlers(...arguments)}set pos(v){!v||v.length<2||(this._pos??=new Float32Array(10,10),this._pos[0]=v[0],this._pos[1]=v[1])}get pos(){return this._pos}configure(info){LiteGraph.log_debug("lgraphnode","configure",this,info),this.graph&&this.graph.onGraphChanged({action:"nodeBeforeConfigure",doSave:!1}),Object.entries(info).forEach(([key,value])=>{if("properties"===key)for(var k in value)this.properties[k]=value[k],this.processCallbackHandlers("onPropertyChanged",{def_cb:this.onPropertyChanged},k,value[k]);else if(!LiteGraph.reprocess_slot_while_node_configure||"inputs"!==key&&"outputs"!==key)null===value?LiteGraph.log_verbose("lgraphnode","configure","should copy null value key? probably should",key,this[key]):"object"==typeof value?this[key]&&"function"==typeof this[key].configure?(this[key].configure(value),LiteGraph.log_verbose("lgraphnode","configure","use var internal configure method",key,value)):(LiteGraph.log_verbose("lgraphnode","configure","set ob var key",key,value,this[key]),this[key]=LiteGraph.cloneObject(value,this[key])):(LiteGraph.log_verbose("lgraphnode","configure","set node var",key,value),this[key]=value);else{LiteGraph.log_debug("lgraphnode","syncObjectByProperty",key,info[key],this[key]);var resSync=this.syncObjectByProperty(info[key],this[key],"name");if(this[key]=resSync.ob_dest,resSync.keys_remap&&Object.keys(resSync.keys_remap).length&&this.graph)for(var slotFrom in resSync.keys_remap){var slotTo=resSync.keys_remap[slotFrom];this.graph.updateNodeLinks(this,"inputs"===key,slotFrom,slotTo)}}}),info.title||(this.title=this.constructor.title),this.inputs?.forEach((input,i)=>{var link_info;input.link&&(link_info=this.graph?this.graph.links[input.link]:null,this.processCallbackHandlers("onConnectionsChange",{def_cb:this.onConnectionsChange},LiteGraph.INPUT,i,!0,link_info,input),this.processCallbackHandlers("onInputAdded",{def_cb:this.onInputAdded},input))}),this.outputs?.forEach((output,i)=>{output.links&&(output.links.forEach((link,i)=>{var link_info=this.graph?.links[link]||null;LiteGraph.log_verbose("lgraphnode","configure","cycle outputlinks",link,i,link_info),this.processCallbackHandlers("onConnectionsChange",{def_cb:this.onConnectionsChange},LiteGraph.OUTPUT,i,!0,link_info,output)}),this.processCallbackHandlers("onOutputAdded",{def_cb:this.onOutputAdded},output))}),this.widgets&&(this.widgets.forEach(w=>{w&&w.options&&w.options.property&&void 0!==this.properties[w.options.property]&&(w.value=JSON.parse(JSON.stringify(this.properties[w.options.property])))}),info.widgets_values?.forEach((value,i)=>{this.widgets[i]&&(this.widgets[i].value=value)})),this.processCallbackHandlers("onConfigure",{def_cb:this.onConfigure},info),this.graph?.onGraphChanged({action:"nodeConfigure",doSave:!1}),LiteGraph.log_debug("lgraphnode","configure complete",this)}serialize(){var o={id:this.id,type:this.type,pos:this.pos,size:this.size,flags:LiteGraph.cloneObject(this.flags),order:this.order,mode:this.mode};if(this.constructor===LGraphNode&&this.last_serialization)return this.last_serialization;this.inputs&&(o.inputs=LiteGraph.cloneObject(this.inputs)),this.outputs&&(this.outputs.forEach(output=>{delete output._data}),o.outputs=LiteGraph.cloneObject(this.outputs)),this.title&&this.title!=this.constructor.title&&(o.title=this.title),this.properties&&(o.properties=LiteGraph.cloneObject(this.properties)),this.widgets&&this.serialize_widgets&&(o.widgets_values=this.widgets.map(widget=>widget?.value??null)),o.type??=this.constructor.type,this.color&&(o.color=this.color),this.bgcolor&&(o.bgcolor=this.bgcolor),this.boxcolor&&(o.boxcolor=this.boxcolor),this.shape&&(o.shape=this.shape);var r=this.processCallbackHandlers("onSerialize",{def_cb:this.onSerialize},o);return null!==r&&"object"==typeof r&&null!==r.return_value&&LiteGraph.log_warn("lgraphnode","onSerialize shouldnt return anything, data should be stored in the object pass in the first parameter"),o}clone(){var data,node=LiteGraph.createNode(this.type);return node?((data=LiteGraph.cloneObject(this.serialize())).inputs?.forEach(input=>{input.link=null}),data.outputs?.forEach(output=>{output.links&&(output.links.length=0)}),delete data.id,LiteGraph.use_uuids&&(data.id=LiteGraph.uuidv4()),node.configure(data),node):null}toString(){return JSON.stringify(this.serialize())}getTitle(){return this.title??this.constructor.title}setProperty(name,value){var r,prevValue;this.properties||={},value!==this.properties[name]&&(prevValue=this.properties[name],this.properties[name]=value,(!1===(r=this.processCallbackHandlers("onPropertyChanged",{def_cb:this.onPropertyChanged},name,value,prevValue))||null!==r&&"object"==typeof r&&!1===r.return_value)&&(this.properties[name]=prevValue,LiteGraph.log_debug("lgraphnode","setProperty","prevent property set by cbHandler",name,value,prevValue,r)),prevValue=this.widgets?.find(widget=>widget&&widget.options?.property===name))&&(prevValue.value=value)}setOutputData(slot,data){var output_info;this.outputs&&-1!=(slot=slot?.constructor===String?this.findOutputSlot(slot):slot)&&!(slot>=this.outputs.length)&&(slot=this.getOutputSlot(slot),output_info=this.outputs[slot])&&(output_info._data=data,this.outputs[slot].links?.forEach(link_id=>{link_id=this.graph.links[link_id];link_id&&(link_id.data=data)}))}setOutputDataType(slot,type){var output_info;!this.outputs||-1==(slot=slot?.constructor===String?this.findOutputSlot(slot):slot)||slot>=this.outputs.length||(output_info=this.outputs[slot])&&(output_info.type=type,this.outputs[slot]?.links?.forEach(link_id=>{this.graph.links[link_id]&&(this.graph.links[link_id].type=type)}))}getInputData(slot,force_update,refresh_tree){var link_id;if(this.inputs&&(!(-1==(slot=slot?.constructor===String?this.findInputSlot(slot):slot)||slot>=this.inputs.length)&&this.inputs[slot].type!=LiteGraph.ACTION))return link_id=this.inputs[slot].link,(link_id=this.graph.links[link_id])?(force_update&&((force_update=this.graph.getNodeById(link_id.origin_id))?(refresh_tree&&(LiteGraph.log_warn("CHECK THIS","lgraphnode","getInputData","Refreshing ancestors tree by ForcedUpdateSlotData",link_id,slot,this),LiteGraph.log_debug("lgraphnode","getInputData","Refreshing ancestors tree by ForcedUpdateSlotData",link_id,slot,this),refresh_tree=this.id+"_getInputData_forced_"+LiteGraph.uuidv4(),this.refreshAncestors({action:refresh_tree,options:{action_call:refresh_tree}})),force_update.updateOutputData?force_update.updateOutputData(link_id.origin_slot):force_update.doExecute()):LiteGraph.log_debug("lgraphnode","getInputData","No origin node, return the link data",link_id.data,link_id,slot,this)),link_id.data):null}getInputDataType(slot){var link_id,link,node;return!this.inputs||(slot=slot?.constructor===String?this.findInputSlot(slot):slot)>=this.inputs.length||null==this.inputs[slot].link?null:this.inputs[slot].type!=LiteGraph.ACTION?(link_id=this.inputs[slot].link,(link=this.graph.links[link_id])?(node=this.graph.getNodeById(link.origin_id))?(node=node.outputs[link.origin_slot])?node.type:null:link.type:(LiteGraph.log_warn("lgraphnode","getInputDataType","No link",link_id,slot,this),null)):void 0}getInputDataByName(slot_name,force_update){slot_name=this.findInputSlot(slot_name);return-1==slot_name?null:this.getInputData(slot_name,force_update)}isInputConnected(slot){return!!this.inputs&&slot<this.inputs.length&&null!=this.inputs[slot].link}getInputInfo(slot){return this.inputs&&slot<this.inputs.length?this.inputs[slot]:null}getInputLink(slot){return this.inputs&&slot<this.inputs.length?(slot=this.inputs[slot],this.graph.links[slot.link]):null}getInputNode(slot){return this.inputs&&!(slot>=this.inputs.length)&&(slot=this.inputs[slot])&&null!==slot.link&&(slot=this.graph.links[slot.link])?this.graph.getNodeById(slot.origin_id):null}getInputOrProperty(name){if(this.inputs)for(var i=0,l=this.inputs.length;i<l;++i){var input_info=this.inputs[i];if(name==input_info.name&&null!=input_info.link){input_info=this.graph.links[input_info.link];if(input_info)return input_info.data}}return this.properties?this.properties[name]:null}getOutputData(slot){return!this.outputs||slot>=this.outputs.length?null:this.outputs[slot]._data}getOutputInfo(slot){return this.outputs&&slot<this.outputs.length?this.outputs[slot]:null}isOutputConnected(slot){return!!this.outputs&&slot<this.outputs.length&&this.outputs[slot].links&&this.outputs[slot].links.length}isAnyOutputConnected(){return!!this.outputs&&this.outputs.some(output=>output.links&&output.links.length)}getOutputNodes(slot){return this.outputs&&!(slot>=this.outputs.length)&&(slot=this.outputs[slot]).links&&0!==slot.links.length?slot.links.map(link_id=>this.graph.links[link_id]).filter(link=>link).map(link=>this.graph.getNodeById(link.target_id)).filter(target_node=>target_node):null}addOnTriggerInput(){var trigS=this.findInputSlot("onTrigger");return-1==trigS?(this.addInput("onTrigger",LiteGraph.EVENT,{removable:!0,nameLocked:!0}),this.findInputSlot("onTrigger")):trigS}addOnExecutedOutput(){var trigS=this.findOutputSlot("onExecuted");return-1==trigS?(this.addOutput("onExecuted",LiteGraph.ACTION,{removable:!0,nameLocked:!0}),this.findOutputSlot("onExecuted")):trigS}onAfterExecuteNode(param,options){var trigS=this.findOutputSlot("onExecuted");-1!=trigS&&(LiteGraph.log_verbose("lgraphnode","onAfterExecuteNode",this.id+":"+this.order+" triggering slot onAfterExecute",param,options),this.triggerSlot(trigS,param,null,options))}onAfterActionedNode(param,options){var trigS=this.findOutputSlot("onExecuted");-1!=trigS&&(LiteGraph.log_verbose("lgraphnode","onAfterActionedNode",this.id+":"+this.order+" triggering slot onAfterActionedNode",this,trigS,param,options),this.triggerSlot(trigS,param,null,options))}onResize(size){}changeMode(modeTo){switch(modeTo){case LiteGraph.ON_TRIGGER:this.addOnTriggerInput(),this.addOnExecutedOutput();break;case LiteGraph.ON_EVENT:case LiteGraph.NEVER:case LiteGraph.ALWAYS:case LiteGraph.ON_REQUEST:break;default:return!1}return this.mode=modeTo,!0}executePendingActions(){this._waiting_actions&&this._waiting_actions.length&&(this._waiting_actions.forEach(p=>{this.onAction(p[0],p[1],p[2],p[3],p[4])}),this._waiting_actions.length=0)}doExecute(param,options={}){this.mode===LiteGraph.NEVER?LiteGraph.log_verbose("lgraphNODE","doExecute","prevent execution in mode NEVER",this.id):(options.action_call??=this.id+"_exec_"+LiteGraph.uuidv4(),this.graph.nodes_executing&&this.graph.nodes_executing[this.id]?LiteGraph.log_debug("lgraphNODE","doExecute","already executing! Prevent! "+this.id+":"+this.order):LiteGraph.ensureNodeSingleExecution&&this.exec_version&&this.exec_version>=this.graph.iteration&&void 0!==this.exec_version?LiteGraph.log_debug("lgraphNODE","doExecute","!! NODE already EXECUTED THIS STEP !! "+this.exec_version):LiteGraph.ensureUniqueExecutionAndActionCall&&this.graph.nodes_executedAction[this.id]&&options&&options.action_call&&this.graph.nodes_executedAction[this.id]==options.action_call?LiteGraph.log_debug("lgraphNODE","doExecute","!! NODE already ACTION THIS STEP !! "+options.action_call):(this.graph.nodes_executing[this.id]=!0,LiteGraph.properties_allow_input_binding&&this.doUpdateBindedInputProperties(),this.processCallbackHandlers("onExecute",{def_cb:this.onExecute},param,options),this.graph.nodes_executing[this.id]=!1,this.exec_version=this.graph.iteration,options&&options.action_call&&(this.action_call=options.action_call,this.graph.nodes_executedAction[this.id]=options.action_call),this.execute_triggered=2,this.processCallbackHandlers("onAfterExecuteNode",{def_cb:this.onAfterExecuteNode},param,options)))}execute(param,options={}){return LiteGraph.log_debug("lgraphnode","execute","You should replace .execute with .doExecute, has been renamed"),this.doExecute(param,options)}actionDo(action,param,options={},action_slot){options.action_call??=this.id+`_${action||"action"}_`+LiteGraph.uuidv4(),LiteGraph.ensureNodeSingleAction&&this.graph.nodes_actioning&&this.graph.nodes_actioning[this.id]==options.action_call?LiteGraph.log_debug("lgraphnode","actionDo","already actioning! Prevent! "+this.id+":"+this.order+" :: "+options.action_call):(LiteGraph.log_debug("CheckActioned ? "+this.id+":"+this.order+" :: "+this.action_call),LiteGraph.ensureUniqueExecutionAndActionCall&&this.graph.nodes_executedAction[this.id]&&options&&options.action_call&&this.graph.nodes_executedAction[this.id]==options.action_call?LiteGraph.log_debug("lgraphnode","actionDo","!! NODE already ACTION THIS STEP !! "+options.action_call):(this.graph.nodes_actioning[this.id]=action||"actioning",this.processCallbackHandlers("onAction",{def_cb:this.onAction},action,param,options,action_slot),this.graph.nodes_actioning[this.id]=!1,options&&options.action_call&&(this.action_call=options.action_call,this.graph.nodes_executedAction[this.id]=options.action_call),this.action_triggered=2,this.processCallbackHandlers("onAfterActionedNode",{def_cb:this.onAfterActionedNode},param,options)))}trigger(action,param,options){if(this.outputs&&0!==this.outputs.length){this.graph&&(this.graph._last_trigger_time=LiteGraph.getTime());let triggered=0;this.outputs.forEach((output,i)=>{!output||output.type!==LiteGraph.EVENT||action&&output.name!==action?LiteGraph.log_verbose("lgraphnode","trigger","skip slot",output):(LiteGraph.log_verbose("lgraphnode","trigger","triggering slot",i,param,options),this.triggerSlot(i,param,null,options),triggered++)}),triggered||LiteGraph.log_debug("lgraphnode","trigger","nothing found",...arguments)}}triggerSlot(slot,param,link_id,options={}){if(this.outputs)if(null===slot)LiteGraph.log_error("lgraphnode","triggerSlot","wrong slot",slot);else{slot.constructor!==Number&&(slot=this.getOutputSlot(slot));slot=this.outputs[slot];if(slot){var links=slot.links;if(links&&links.length&&!(this.mode===LiteGraph.NEVER||this.graph&&this.graph.ancestorsCall)){this.graph&&(this.graph._last_trigger_time=LiteGraph.getTime());for(var k=0;k<links.length;++k){var node,target_slot,id=links[k];null!=link_id&&link_id!=id||(id=this.graph.links[links[k]])&&(id._last_time=LiteGraph.getTime(),node=this.graph.getNodeById(id.target_id))&&(target_slot=node.inputs[id.target_slot],node.mode===LiteGraph.ON_TRIGGER||"onTrigger"===target_slot?.name?(options.action_call||(options.action_call=this.id+"_trigg_"+LiteGraph.uuidv4()),LiteGraph.refreshAncestorsOnTriggers&&node.refreshAncestors({action:"trigger",param:param,options:options}),node.onExecute&&node.doExecute(param,options)):node.onAction?(options.action_call||(options.action_call=this.id+"_act_"+LiteGraph.uuidv4()),target_slot=node.inputs[id.target_slot],LiteGraph.refreshAncestorsOnActions&&node.refreshAncestors({action:target_slot.name,param:param,options:options}),LiteGraph.use_deferred_actions&&node.onExecute?(node._waiting_actions??=[],node._waiting_actions.push([target_slot.name,param,options,id.target_slot]),LiteGraph.log_debug("lgraphnode","triggerSlot","push to deferred",target_slot.name,param,options,id.target_slot)):(LiteGraph.log_debug("lgraphnode","triggerSlot","call actionDo",node,target_slot.name,param,options,id.target_slot),node.actionDo(target_slot.name,param,options,id.target_slot))):LiteGraph.log_debug("lgraphnode","triggerSlot","not executing node, what to do with this Node Mode on slot triggered?",node.mode,this))}}}}}clearTriggeredSlot(slot,link_id){this.outputs&&this.outputs[slot]&&this.outputs[slot].links&&this.outputs[slot].links.forEach(id=>{null!==link_id&&link_id!==id||(id=this.graph.links[id])&&(id._last_time=0)})}doUpdateBindedInputProperties(){let thisNode=this;this.inputs.forEach(ob_input=>{if(ob_input.param_bind)if(LiteGraph.log_debug("lgraphnode","doUpdateBindedInputProperties","has bind",ob_input,thisNode),thisNode.properties&&void 0!==thisNode.properties[ob_input.name]){let inputData=thisNode.getInputData(ob_input.name);LiteGraph.log_debug("lgraphnode","doUpdateBindedInputProperties","update value",ob_input.name,inputData,thisNode),this.setProperty(ob_input.name,inputData)}else LiteGraph.log_warn("lgraphnode","doUpdateBindedInputProperties","inexisting property",ob_input.name,inputData,thisNode)})}autoSize(only_greater_than_current){var minSize=this.computeSize(),only_greater_than_current=only_greater_than_current&&this.size?[Math.max(this.size[0],minSize[0]),Math.max(this.size[1],minSize[1])]:minSize;this.setSize(only_greater_than_current)}setSize(size){this.size=size,this.processCallbackHandlers("onResize",{def_cb:this.onResize},this.size)}addProperty(name,default_value,type,extra_info){type={name:name,type:type??=null,default_value:default_value??=null,...extra_info};return this.properties_info=this.properties_info??[],this.properties_info.push(type),this.properties=this.properties??{},this.properties[name]=default_value,type}addInput(name,type,extra_info){return this.addSlot(name,type,extra_info,!0)}addOutput(name,type,extra_info){return this.addSlot(name,type,extra_info,!1)}addSlot(name,type,extra_info,isInput){name=isInput?{name:name,type:type,link:null,...extra_info}:{name:name,type:type,links:null,...extra_info};return isInput?(this.inputs=this.inputs??[],this.inputs.push(name),this.processCallbackHandlers("onInputAdded",{def_cb:this.onInputAdded},name),LiteGraph.registerNodeAndSlotType(this,type)):(this.outputs=this.outputs??[],this.outputs.push(name),this.processCallbackHandlers("onOutputAdded",{def_cb:this.onOutputAdded},name),LiteGraph.auto_load_slot_types&&LiteGraph.registerNodeAndSlotType(this,type,!0)),this.autoSize(!0),this.setDirtyCanvas(!0,!0),name}addInputs(array){this.addSlots(array,!0)}addOutputs(array){this.addSlots(array,!1)}addSlots(array,isInput){(array="string"==typeof array?[array]:array).forEach(info=>{var slot=isInput?{name:info[0],type:info[1],link:null,...info[2]??{}}:{name:info[0],type:info[1],links:null,...info[2]??{}};isInput?(this.inputs=this.inputs??[],this.inputs.push(slot),this.processCallbackHandlers("onInputAdded",{def_cb:this.onInputAdded},slot),LiteGraph.registerNodeAndSlotType(this,info[1])):(this.outputs=this.outputs??[],this.outputs.push(slot),this.processCallbackHandlers("onOutputAdded",{def_cb:this.onOutputAdded},slot),LiteGraph.auto_load_slot_types&&LiteGraph.registerNodeAndSlotType(this,info[1],!0))}),this.autoSize(),this.setDirtyCanvas(!0,!0)}removeInput(slot){this.disconnectInput(slot);var removedInput=this.inputs.splice(slot,1)[0];this.inputs.slice(slot).filter(input=>!!input).forEach(input=>{input=this.graph.links[input.link];input?.target_slot&&input.target_slot--}),this.autoSize(),this.processCallbackHandlers("onInputRemoved",{def_cb:this.onInputRemoved},slot,removedInput),this.setDirtyCanvas(!0,!0)}removeOutput(slot){this.disconnectOutput(slot),this.outputs=this.outputs.filter((_,index)=>index!==slot),this.outputs.slice(slot).forEach(output=>{output&&output.links&&output.links.forEach(linkId=>{linkId=this.graph.links[linkId];linkId&&--linkId.origin_slot})}),this.autoSize(),this.processCallbackHandlers("onOutputRemoved",{def_cb:this.onOutputRemoved},slot),this.setDirtyCanvas(!0,!0)}addConnection(name,type,pos,direction){name={name:name,type:type,pos:pos,direction:direction,links:null};return this.connections.push(name),name}getDefaultCanvas(){return!!this.graph&&!(!this.graph.list_of_graphcanvas||!this.graph.list_of_graphcanvas.length)&&this.graph.list_of_graphcanvas[0]}computeSize(out){if(this.constructor.size)return this.constructor.size.concat();var node=this,size=out||new Float32Array([0,0]),font_size=LiteGraph.NODE_TEXT_SIZE;const get_text_width=(text,isTitle)=>{if(!text)return 0;var lgcanvas=node.getDefaultCanvas();if(lgcanvas&&lgcanvas.canvas&&lgcanvas.ctx){lgcanvas.ctx.font=isTitle?lgcanvas.title_text_font:lgcanvas.inner_text_font;isTitle=lgcanvas.ctx?.measureText(text);if(isTitle)return isTitle.width}return font_size*text.length*.423};out=node.title;try{out=this.getTitle()}catch(e){}var out=40+get_text_width(out,!0),input_width=0,output_width=0;this.inputs&&(input_width=this.inputs.reduce((maxWidth,input)=>{input=input.label||input.name||"",input=get_text_width(input);return Math.max(maxWidth,input)},0)),this.outputs&&(output_width=this.outputs.reduce((maxWidth,output)=>{output=output.label||output.name||"",output=get_text_width(output);return Math.max(maxWidth,output)},0)),this.horizontal?(size[0]=Math.max(size[0],out),size[1]=this.outputs.length?Math.max(size[1],LiteGraph.NODE_SLOT_HEIGHT+10):size[1]):(size[0]=Math.max(input_width+output_width+40+10,out),size[1]=this.getSlotsHeight()),size[0]=Math.max(size[0],LiteGraph.NODE_MIN_WIDTH),size[0]=Math.max(size[0],LiteGraph.NODE_MIN_SIZE[0]),size[1]=Math.max(size[1],LiteGraph.NODE_MIN_SIZE[1]);let widgetsHeight=0;if(this.widgets&&this.widgets.length){size[0]=Math.max(size[0],1.5*LiteGraph.NODE_MIN_WIDTH);for(var wSize,i=0,l=this.widgets.length;i<l;++i)this.widgets[i].computeSize?(wSize=this.widgets[i].computeSize(size[0]),widgetsHeight+=wSize[1]+4,size[0]=Math.max(size[0],wSize[0])):(widgetsHeight+=LiteGraph.NODE_WIDGET_HEIGHT+4,size[0]=Math.max(size[0],LiteGraph.NODE_WIDTH));widgetsHeight+=8}return this.widgets_up?size[1]=Math.max(size[1],widgetsHeight):null!=this.widgets_start_y?size[1]=Math.max(size[1],widgetsHeight+this.widgets_start_y):size[1]+=widgetsHeight,this.constructor.min_height&&(size[1]=Math.max(size[1],this.constructor.min_height)),size}getSlotsHeight(){return Math.max(this.inputs?this.inputs.length:1,this.outputs?this.outputs.length:1,1)*LiteGraph.NODE_SLOT_HEIGHT+10+(this.constructor.slot_start_y||0)}getPropertyInfo(property){var r,info=null;if(this.properties_info)for(var i=0;i<this.properties_info.length;++i)if(this.properties_info[i].name==property){info=this.properties_info[i];break}return this.constructor["@"+property]&&(info=this.constructor["@"+property]),(info=this.constructor.widgets_info&&this.constructor.widgets_info[property]?this.constructor.widgets_info[property]:info)||null!==(r=this.processCallbackHandlers("onGetPropertyInfo",{def_cb:this.onGetPropertyInfo},property))&&"object"==typeof r&&null!==r.return_value&&(info=r.return_value),(info=info||{}).type||(info.type=typeof this.properties[property]),"combo"==info.widget&&(info.type="enum"),info}addWidget(type,name,value,callback,options){this.widgets??=[],!options&&callback&&callback.constructor===Object&&(options=callback,callback=null),options&&options.constructor===String&&(options={property:options}),callback&&callback.constructor===String&&((options??={}).property=callback,callback=null),callback&&callback.constructor!==Function&&(LiteGraph.log_warn("lgraphnode","addWidget","callback must be a function",callback),callback=null);name={type:type.toLowerCase(),name:name,value:value,callback:callback,options:options||{}};if(void 0!==name.options.y&&(name.y=name.options.y),callback||name.options.callback||name.options.property,"combo"!=type||name.options.values)return this.widgets.push(name),this.setSize(this.computeSize()),name;LiteGraph.log_warn("lgraphnode","addWidget","combo requires to pass values in options eg: { values:['red','blue'] }")}addCustomWidget(custom_widget){return this.widgets??=[],this.widgets.push(custom_widget),custom_widget}getBounding(out=new Float32Array(4),compute_outer){var nodePos=this.pos,isCollapsed=this.flags?.collapsed,nodeSize=this.size;let left_offset=0,right_offset=1,top_offset=0,bottom_offset=0;return compute_outer&&(left_offset=4,right_offset=6+left_offset,top_offset=4,bottom_offset=5+top_offset),out[0]=nodePos[0]-left_offset,out[1]=nodePos[1]-LiteGraph.NODE_TITLE_HEIGHT-top_offset,out[2]=isCollapsed?(this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH)+right_offset:nodeSize[0]+right_offset,out[3]=isCollapsed?LiteGraph.NODE_TITLE_HEIGHT+bottom_offset:nodeSize[1]+LiteGraph.NODE_TITLE_HEIGHT+bottom_offset,this.processCallbackHandlers("onBounding",{def_cb:this.onBounding},out),out}isPointInside(x,y,margin=0,skip_title){var margin_top=this.graph&&this.graph.isLive()?0:LiteGraph.NODE_TITLE_HEIGHT;if(skip_title&&(margin_top=0),this.flags&&this.flags.collapsed){if(LiteGraph.isInsideRectangle(x,y,this.pos[0]-margin,this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT-margin,(this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH)+2*margin,LiteGraph.NODE_TITLE_HEIGHT+2*margin))return!0}else if(this.pos[0]-4-margin<x&&this.pos[0]+this.size[0]+4+margin>x&&this.pos[1]-margin_top-margin<y&&this.pos[1]+this.size[1]+margin>y)return!0;return!1}getSlotInPosition(x,y){var link_pos=new Float32Array(2);if(this.inputs)for(let i=0,l=this.inputs.length;i<l;++i){var input=this.inputs[i];if(this.getConnectionPos(!0,i,link_pos),LiteGraph.isInsideRectangle(x,y,link_pos[0]-10,link_pos[1]-5,20,10))return{input:input,slot:i,link_pos:link_pos}}if(this.outputs)for(let i=0,l=this.outputs.length;i<l;++i){var output=this.outputs[i];if(this.getConnectionPos(!1,i,link_pos),LiteGraph.isInsideRectangle(x,y,link_pos[0]-10,link_pos[1]-5,20,10))return{output:output,slot:i,link_pos:link_pos}}return null}findInputSlot(name,returnObj){if(this.inputs)for(var i=0,l=this.inputs.length;i<l;++i)if(name==this.inputs[i].name)return returnObj?this.inputs[i]:i;return-1}findOutputSlot(name,returnObj=!1){if(this.outputs)for(var i=0,l=this.outputs.length;i<l;++i)if(name==this.outputs[i].name)return returnObj?this.outputs[i]:i;return-1}getSlot(is_input,slot_index_or_name,returnObj=!1){return is_input&&is_input!==LiteGraph.OUTPUT?"undefined"!==this.inputs[slot_index_or_name]?returnObj?this.inputs[slot_index_or_name]:slot_index_or_name:this.findOutputSlot(slot_index_or_name,returnObj):"undefined"!==this.outputs[slot_index_or_name]?returnObj?this.outputs[slot_index_or_name]:slot_index_or_name:this.findInputSlot(slot_index_or_name,returnObj)}getOutputSlot(index_or_name,returnObj=!1){return this.getSlot(!1,index_or_name,returnObj)}getInputSlot(index_or_name,returnObj=!1){return this.getSlot(!0,index_or_name,returnObj)}findInputSlotFree(optsIn={}){var opts=Object.assign({returnObj:!1,typesNotAccepted:[]},optsIn);if(this.inputs)for(var i=0,l=this.inputs.length;i<l;++i)if(!(this.inputs[i].link&&null!=this.inputs[i].link||opts.typesNotAccepted&&opts.typesNotAccepted.includes&&opts.typesNotAccepted.includes(this.inputs[i].type)))return opts.returnObj?this.inputs[i]:i;return-1}findOutputSlotFree(optsIn={}){var opts=Object.assign({returnObj:!1,typesNotAccepted:[]},optsIn);if(this.outputs)for(let i=0,l=this.outputs.length;i<l;++i)if(!(this.outputs[i].links&&null!=this.outputs[i].links||opts.typesNotAccepted&&opts.typesNotAccepted.includes&&opts.typesNotAccepted.includes(this.outputs[i].type)))return opts.returnObj?this.outputs[i]:i;return-1}findInputSlotByType(type,returnObj,preferFreeSlot,doNotUseOccupied){return this.findSlotByType(!0,type,returnObj,preferFreeSlot,doNotUseOccupied)}findOutputSlotByType(type,returnObj,preferFreeSlot,doNotUseOccupied){return this.findSlotByType(!1,type,returnObj,preferFreeSlot,doNotUseOccupied)}findSlotByType(is_input=!1,type,returnObj=!1,preferFreeSlot=!1,doNotUseOccupied=!1){var aSlots=is_input?this.inputs:this.outputs;if(aSlots){type&&""!=type&&"*"!=type||(type=0);for(let i=0,l=aSlots.length;i<l;++i){var aSource=(type+"").toLowerCase().split(","),aDest=((aDest="0"==aSlots[i].type||"*"==aSlots[i].type?0:aSlots[i].type)+"").toLowerCase().split(",");for(let sI=0;sI<aSource.length;sI++)for(let dI=0;dI<aDest.length;dI++)if("_event_"==aSource[sI]&&(aSource[sI]=LiteGraph.EVENT),"_event_"==aDest[sI]&&(aDest[sI]=LiteGraph.EVENT),"*"==aSource[sI]&&(aSource[sI]=0),"*"==aDest[sI]&&(aDest[sI]=0),aSource[sI]==aDest[dI]){if(!preferFreeSlot||!(aSlots[i].link&&null!==aSlots[i].link||aSlots[i].links&&null!==aSlots[i].links))return LiteGraph.log_verbose("lgraphnode","findSlotByType","found right type",i,aSlots[i],"from types",type,"checked types",aSlots[i].type),returnObj?aSlots[i]:i;LiteGraph.log_verbose("lgraphnode","findSlotByType","preferFreeSlot but has link",aSource[sI],aDest[dI],"from types",type,"checked types",aSlots[i].type)}else LiteGraph.log_verbose("lgraphnode","findSlotByType","slot not right type",aSource[sI],aDest[dI],"from types",type,"checked types",aSlots[i].type)}if(preferFreeSlot&&!doNotUseOccupied)for(let i=0,l=aSlots.length;i<l;++i){let aSource=(type+"").toLowerCase().split(","),aDest="0"==aSlots[i].type||"*"==aSlots[i].type?"0":aSlots[i].type;aDest=(aDest+"").toLowerCase().split(",");for(let sI=0;sI<aSource.length;sI++)for(let dI=0;dI<aDest.length;dI++)if("*"==aSource[sI]&&(aSource[sI]=0),"*"==aDest[sI]&&(aDest[sI]=0),aSource[sI]==aDest[dI])return returnObj?aSlots[i]:i}}return-1}connectByType(slot,target_node,target_slotType="*",optsIn={}){var optsIn=Object.assign({createEventInCase:!0,firstFreeIfOutputGeneralInCase:!0,generalTypeInCase:!0,preferFreeSlot:!1},optsIn),target_slot=(target_node=target_node&&target_node.constructor===Number?this.graph.getNodeById(target_node):target_node).findInputSlotByType(target_slotType,!1,!0);return 0<=target_slot&&null!==target_slot?(LiteGraph.log_debug("lgraphnode","connectByType","type "+target_slotType+" for "+target_slot),this.connect(slot,target_node,target_slot)):optsIn.createEventInCase&&target_slotType==LiteGraph.EVENT?(LiteGraph.log_debug("lgraphnode","connectByType","connect WILL CREATE THE onTrigger "+target_slotType+" to "+target_node),this.connect(slot,target_node,-1)):optsIn.generalTypeInCase&&(target_slot=target_node.findInputSlotByType(0,!1,!0,!0),LiteGraph.log_debug("lgraphnode","connectByType","connect TO a general type (*, 0), if not found the specific type ",target_slotType," to ",target_node,"RES_SLOT:",target_slot),0<=target_slot)||optsIn.firstFreeIfOutputGeneralInCase&&(0==target_slotType||"*"==target_slotType||""==target_slotType)&&(target_slot=target_node.findInputSlotFree({typesNotAccepted:[LiteGraph.EVENT]}),LiteGraph.log_debug("lgraphnode","connectByType","connect TO TheFirstFREE ",target_slotType," to ",target_node,"RES_SLOT:",target_slot),0<=target_slot)?this.connect(slot,target_node,target_slot):(LiteGraph.log_debug("lgraphnode","connectByType","no way to connect type: ",target_slotType," to targetNODE ",target_node),null)}connectByTypeOutput(slot,source_node,source_slotType="*",optsIn={}){var optsIn=Object.assign({createEventInCase:!0,firstFreeIfInputGeneralInCase:!0,generalTypeInCase:!0},optsIn),source_slot=(source_node=source_node&&source_node.constructor===Number?this.graph.getNodeById(source_node):source_node).findOutputSlotByType(source_slotType,!1,!0);return 0<=source_slot&&null!==source_slot?(LiteGraph.log_debug("lgraphnode","connectByTypeOutput","type "+source_slotType+" for "+source_slot),source_node.connect(source_slot,this,slot)):optsIn.generalTypeInCase&&0<=(source_slot=source_node.findOutputSlotByType(0,!1,!0,!0))?source_node.connect(source_slot,this,slot):optsIn.createEventInCase&&source_slotType==LiteGraph.EVENT&&LiteGraph.do_add_triggers_slots?(source_slot=source_node.addOnExecutedOutput(),source_node.connect(source_slot,this,slot)):optsIn.firstFreeIfInputGeneralInCase&&(0==source_slotType||"*"==source_slotType||""==source_slotType||"undefined"==source_slotType)&&0<=(source_slot=source_node.findOutputSlotFree({typesNotAccepted:[LiteGraph.EVENT]}))?source_node.connect(source_slot,this,slot):(LiteGraph.log_debug("lgraphnode","connectByTypeOutput","no way to connect (not found or not free?) byOUT type: ",source_slotType," to sourceNODE ",source_node),null)}connect(slot,target_node,target_slot=0){if(!this.graph)return LiteGraph.log_warn("lgraphnode","connect","Error, node doesn't belong to any graph. Nodes must be added first to a graph before connecting them.",this),null;var changed,input,link_info,output,r;if(-1==(slot=this.getOutputSlot(slot)))return LiteGraph.log_warn("lgraphnode","connect","Slot not found",this,slot),null;if(target_node&&target_node.constructor===Number&&(LiteGraph.log_debug("lgraphnode","connect","Target node constructor is number",target_node),target_node=this.graph.getNodeById(target_node),LiteGraph.log_debug("lgraphnode","connect","Target node number constructor, looked for node by ID",target_node)),target_node){if(target_node==this)return null;if(target_slot===LiteGraph.EVENT){if(!LiteGraph.do_add_triggers_slots)return null;target_node.changeMode(LiteGraph.ON_TRIGGER),target_slot=target_node.findInputSlot("onTrigger"),LiteGraph.log_debug("lgraphnode","connect","Created onTrigger slot",target_slot)}else target_slot=target_node.getInputSlot(target_slot);return target_node.inputs&&-1!=target_slot?(changed=!1,input=target_node.inputs[target_slot],link_info=null,output=this.outputs[slot],this.outputs[slot]?(null!==(r=target_node.processCallbackHandlers("onBeforeConnectInput",{def_cb:target_node.onBeforeConnectInput},target_node))&&"object"==typeof r&&null!==r.return_value&&(LiteGraph.log_debug("lgraphnode","connect","Node onBeforeConnectInput changing target_slot",target_slot,r.return_value),target_slot=r.return_value),null!==(r=this.processCallbackHandlers("onConnectOutput",{def_cb:this.onConnectOutput},slot,input.type,input,target_node,target_slot))&&(!1===r||"object"==typeof r&&!1===r.return_value)?(LiteGraph.log_debug("lgraphnode","connect","Node onConnectOutput stopping connection",r.return_value),null):!1!==target_slot&&null!==target_slot&&LiteGraph.isValidConnection(output.type,input.type)?(LiteGraph.log_debug("lgraphnode","connect","target_slot is valid",target_slot),null!==(r=target_node.processCallbackHandlers("onConnectInput",{def_cb:target_node.onConnectInput},target_slot,output.type,output,this,slot))&&(!1===r||"object"==typeof r&&!1===r.return_value)?(LiteGraph.log_debug("lgraphnode","connect","targetNode onConnectInput stopping connection",r.return_value),null):(target_node.inputs[target_slot]&&null!=target_node.inputs[target_slot].link&&(this.graph.beforeChange(),target_node.disconnectInput(target_slot,{doProcessChange:!1}),changed=!0),output.links?.length&&output.type===LiteGraph.EVENT&&!LiteGraph.allow_multi_output_for_events&&(this.graph.beforeChange(),this.disconnectOutput(slot,!1,{doProcessChange:!1}),changed=!0),r=LiteGraph.use_uuids?LiteGraph.uuidv4():++this.graph.last_link_id,link_info=new LiteGraph.LLink(r,input.type||output.type,this.id,slot,target_node.id,target_slot),this.graph.links[link_info.id]=link_info,null==output.links&&(output.links=[]),output.links.push(link_info.id),void 0===target_node.inputs[target_slot]&&LiteGraph.log_warn("lgraphnode","connect","FIXME error, target_slot does not exists on target_node",target_node,target_slot),target_node.inputs[target_slot].link=link_info.id,this.processCallbackHandlers("onConnectionsChange",{def_cb:this.onConnectionsChange},LiteGraph.OUTPUT,slot,!0,link_info,output),target_node.processCallbackHandlers("onConnectionsChange",{def_cb:target_node.onConnectionsChange},LiteGraph.INPUT,target_slot,!0,link_info,input),this.graph&&(this.graph.processCallbackHandlers("onNodeConnectionChange",{def_cb:this.graph.onNodeConnectionChange},LiteGraph.INPUT,target_node,target_slot,this,slot),this.graph.processCallbackHandlers("onNodeConnectionChange",{def_cb:this.graph.onNodeConnectionChange},LiteGraph.OUTPUT,this,slot,target_node,target_slot)),this.graph.onGraphChanged({action:"connect"}),this.setDirtyCanvas(!1,!0),this.graph.afterChange(),this.graph.connectionChange(this,link_info),link_info)):(LiteGraph.log_warn("lgraphnode","connect","target_slot is NOT valid",target_slot,output.type,input.type),this.setDirtyCanvas(!1,!0),changed&&this.graph.connectionChange(this,null),null)):(LiteGraph.log_warn("lgraphnode","connect","Invalid processed output slot: ",slot,this.outputs),null)):(LiteGraph.log_warn("lgraphnode","connect","Target slot not found",target_slot,target_node.inputs),null)}LiteGraph.log_warn("lgraphnode","connect","Target node null",target_node)}disconnectOutput(slot,target_node,optsIn={}){var opts=Object.assign({doProcessChange:!0},optsIn),output=(slot=this.getOutputSlot(slot),this.outputs[slot]);if(!output||!output.links||0==output.links.length)return LiteGraph.log_warn("lgraphnode","disconnectOutput","Error, invalid slot or not linked",slot,output),!1;if(target_node){if(target_node.constructor===Number&&(LiteGraph.log_debug("lgraphnode","disconnectOutput","Target node constructor is number",target_node),target_node=this.graph.getNodeById(target_node),LiteGraph.log_debug("lgraphnode","disconnectOutput","Target node number constructor, looked for node by ID",target_node)),!target_node)return LiteGraph.log_warn("lgraphnode","disconnectOutput","target node not found",target_node),!1;for(let i=0,l=output.links.length;i<l;i++){var link_id=output.links[i],link_info=this.graph.links[link_id];if(link_info.target_id==target_node.id){output.links.splice(i,1);var input=target_node.inputs[link_info.target_slot];input.link=null,delete this.graph.links[link_id],this.graph?.onGraphChanged({action:"disconnectOutput",doSave:opts.doProcessChange}),target_node.processCallbackHandlers("onConnectionsChange",{def_cb:target_node.onConnectionsChange},LiteGraph.INPUT,link_info.target_slot,!1,link_info,input),this.processCallbackHandlers("onConnectionsChange",{def_cb:this.onConnectionsChange},LiteGraph.OUTPUT,slot,!1,link_info,output),this.graph&&(this.graph.processCallbackHandlers("onNodeConnectionChange",{def_cb:this.graph.onNodeConnectionChange},LiteGraph.OUTPUT,this,slot,target_node,link_info.target_slot),this.graph.processCallbackHandlers("onNodeConnectionChange",{def_cb:this.graph.onNodeConnectionChange},LiteGraph.INPUT,target_node,link_info.target_slot,this,slot));break}}}else{for(let i=0,l=output.links.length;i<l;i++){let link_id=output.links[i],link_info=this.graph.links[link_id];link_info?(target_node=this.graph.getNodeById(link_info.target_id),input=null,this.graph?.onGraphChanged({action:"disconnectOutput",doSave:opts.doProcessChange}),target_node&&((input=target_node.inputs[link_info.target_slot]).link=null,target_node.processCallbackHandlers("onConnectionsChange",{def_cb:target_node.onConnectionsChange},LiteGraph.INPUT,link_info.target_slot,!1,link_info,input),this.graph.processCallbackHandlers("onNodeConnectionChange",{def_cb:this.graph.onNodeConnectionChange},LiteGraph.INPUT,target_node,link_info.target_slot,this)),delete this.graph.links[link_id],this.processCallbackHandlers("onConnectionsChange",{def_cb:this.onConnectionsChange},LiteGraph.OUTPUT,slot,!1,link_info,output),this.graph.processCallbackHandlers("onNodeConnectionChange",{def_cb:this.graph.onNodeConnectionChange},LiteGraph.OUTPUT,this,slot,target_node,link_info.target_slot)):LiteGraph.log_warn("lgraphnode","disconnectOutput","A link is invalid",link_id,this,output)}output.links=null}return this.setDirtyCanvas(!1,!0),this.graph.connectionChange(this),!0}disconnectInput(slot,optsIn={}){var optsIn=Object.assign({doProcessChange:!0},optsIn),input=(slot=this.getInputSlot(slot),this.inputs[slot]);if(!input)return!1;var link_id=this.inputs[slot].link;if(null!=link_id){this.inputs[slot].link=null;var link_info=this.graph.links[link_id];if(link_info){var target_node=this.graph.getNodeById(link_info.origin_id);if(!target_node)return!1;var output=target_node.outputs[link_info.origin_slot];if(!output||!output.links||0==output.links.length)return!1;for(var i=0,l=output.links.length;i<l;i++)if(output.links[i]==link_id){output.links.splice(i,1);break}delete this.graph.links[link_id],this.graph?.onGraphChanged({action:"disconnectInput",doSave:optsIn.doProcessChange}),this.processCallbackHandlers("onConnectionsChange",{def_cb:this.onConnectionsChange},LiteGraph.INPUT,slot,!1,link_info,input),target_node.processCallbackHandlers("onConnectionsChange",{def_cb:target_node.onConnectionsChange},LiteGraph.OUTPUT,i,!1,link_info,output),this.graph&&(this.graph.processCallbackHandlers("onNodeConnectionChange",{def_cb:this.graph.onNodeConnectionChange},LiteGraph.OUTPUT,target_node,i),this.graph.processCallbackHandlers("onNodeConnectionChange",{def_cb:this.graph.onNodeConnectionChange},LiteGraph.INPUT,this,slot))}}return this.setDirtyCanvas(!1,!0),this.graph&&this.graph.connectionChange(this),!0}getConnectionPos(is_input,slot_number,out=new Float32Array(2)){var w,num_slots=0,offset=(is_input&&this.inputs&&(num_slots=this.inputs.length),!is_input&&this.outputs&&(num_slots=this.outputs.length),.5*LiteGraph.NODE_SLOT_HEIGHT);return this.flags.collapsed?(w=this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH,this.horizontal?(out[0]=this.pos[0]+.5*w,out[1]=is_input?this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT:this.pos[1]):(out[0]=is_input?this.pos[0]:this.pos[0]+w,out[1]=this.pos[1]-.5*LiteGraph.NODE_TITLE_HEIGHT)):is_input&&-1==slot_number?(LiteGraph.log_debug("lgraphnode","getConnectionPos","asking for connection slot -1"),out[0]=this.pos[0]+.5*LiteGraph.NODE_TITLE_HEIGHT,out[1]=this.pos[1]+.5*LiteGraph.NODE_TITLE_HEIGHT):is_input&&slot_number<num_slots&&this.inputs[slot_number].pos?(out[0]=this.pos[0]+this.inputs[slot_number].pos[0],out[1]=this.pos[1]+this.inputs[slot_number].pos[1]):!is_input&&slot_number<num_slots&&this.outputs[slot_number].pos?(out[0]=this.pos[0]+this.outputs[slot_number].pos[0],out[1]=this.pos[1]+this.outputs[slot_number].pos[1]):this.horizontal?(out[0]=this.pos[0]+(slot_number+.5)*(this.size[0]/num_slots),out[1]=is_input?this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT:this.pos[1]+this.size[1]):(out[0]=is_input?this.pos[0]+offset:this.pos[0]+this.size[0]+1-offset,out[1]=this.pos[1]+(slot_number+.7)*LiteGraph.NODE_SLOT_HEIGHT+(this.constructor.slot_start_y||0)),out}alignToGrid(){this.pos[0]=LiteGraph.CANVAS_GRID_SIZE*Math.round(this.pos[0]/LiteGraph.CANVAS_GRID_SIZE),this.pos[1]=LiteGraph.CANVAS_GRID_SIZE*Math.round(this.pos[1]/LiteGraph.CANVAS_GRID_SIZE)}trace(msg){this.console||(this.console=[]),this.console.push?.(msg),this.console.length>LGraphNode.MAX_CONSOLE&&this.console.shift?.(),this.graph.processCallbackHandlers("onNodeTrace",{def_cb:this.graph.onNodeTrace},this,msg)}setDirtyCanvas(dirty_foreground,dirty_background){this.graph&&this.graph.sendActionToCanvas("setDirty",[dirty_foreground,dirty_background])}loadImage(url){var img=new Image,that=(img.src=LiteGraph.node_images_path+url,img.ready=!1,this);return img.onload=function(){this.ready=!0,that.setDirtyCanvas(!0)},img}captureInput(v){if(this.graph&&this.graph.list_of_graphcanvas)for(var list=this.graph.list_of_graphcanvas,i=0;i<list.length;++i){var c=list[i];!v&&c.node_capturing_input!=this||(c.node_capturing_input=v?this:null)}}collapse(force){this.graph.onGraphChanged({action:"collapse"}),!1===this.constructor.collapsable&&!force||(this.flags.collapsed?this.flags.collapsed=!1:this.flags.collapsed=!0,this.setDirtyCanvas(!0,!0))}pin(v){this.graph.onGraphChanged({action:"pin"}),this.flags.pinned=void 0===v?!this.flags.pinned:v}localToScreen(x,y,graphcanvas){return[(x+this.pos[0])*graphcanvas.scale+graphcanvas.offset[0],(y+this.pos[1])*graphcanvas.scale+graphcanvas.offset[1]]}refreshAncestors(optsIn={}){var opts=Object.assign({action:"",param:null,options:null,passParam:!0},optsIn);if(this.inputs){if(!(LiteGraph.preventAncestorRecalculation&&this.graph.node_ancestorsCalculated&&this.graph.node_ancestorsCalculated[this.id])){opts.action&&""!=opts.action||(opts.action=this.id+"_ancestors"),opts.param&&""!=opts.param||(opts.param=this.id+"_ancestors"),opts.options||(opts.options={}),opts.options=Object.assign({action_call:opts.action},opts.options),LiteGraph.log_verbose("lgraphnode","refreshAncestors","ancestors processing",this.id+":"+this.order+" "+opts.options.action_call,this),this.graph.ancestorsCall=!0;var iN,optsIn={modesSkip:[LiteGraph.NEVER,LiteGraph.ON_EVENT,LiteGraph.ON_TRIGGER],modesOnly:[LiteGraph.ALWAYS,LiteGraph.ON_REQUEST],typesSkip:[LiteGraph.ACTION],typesOnly:[]},aAncestors=this.graph.getAncestors(this,optsIn);for(iN in aAncestors)LiteGraph.log_verbose("lgraphnode","refreshAncestors","doExecute ancestor",iN,aAncestors[iN],opts.param,opts.options),aAncestors[iN].doExecute(opts.param,opts.options),this.graph.node_ancestorsCalculated[aAncestors[iN].id]=!0;return this.graph.ancestorsCall=!1,this.graph.node_ancestorsCalculated[this.id]=!0}LiteGraph.log_verbose("lgraphnode","refreshAncestors","already calculated subtree! Prevent! "+this.id+":"+this.order,this)}}syncObjectByProperty(ob_from,ob_dest,property,optsIn){var opts=Object.assign({},{only_in_source:"append",fallback_checks:[{name:"type"}]},optsIn),new_dest=(null!==ob_from&&ob_from||(ob_from=[]),[]);let keys_remap={};optsIn=(ob_dest=null!==ob_dest&&ob_dest?ob_dest:[]).filter(input=>!ob_from.some(srcInput=>srcInput[property]===input[property]));let sourceUsedIds=[],aNotFoundInSource=[],destUsedIds=(ob_dest.forEach((destInput,destIndex)=>{let foundInSource=!1;ob_from.forEach((sourceInput,sourceIndex)=>{foundInSource||(sourceUsedIds.includes(sourceIndex)?LiteGraph.log_verbose("syncObjectByProperty","skip used",sourceInput,sourceIndex):sourceInput[property]===destInput[property]&&(foundInSource=!0,sourceUsedIds.push(sourceIndex),new_dest[destIndex]=LiteGraph.cloneObject(sourceInput),destIndex!=sourceIndex?(LiteGraph.log_debug("syncObjectByProperty","push SHIFTED",destInput[property],destInput,sourceIndex,destIndex),keys_remap[sourceIndex]=destIndex):LiteGraph.log_verbose("syncObjectByProperty","found ok, same index",destInput[property],sourceInput,destIndex)))}),foundInSource||aNotFoundInSource.push({ob:destInput,index:destIndex})}),aNotFoundInSource.length&&(opts.fallback_checks.length?aNotFoundInSource.forEach((ob,i)=>{let destInput=ob.ob,destIndex=ob.index,foundInSource=!1;opts.fallback_checks.forEach((checkX,ckI)=>{foundInSource||ob_from.forEach((sourceInput,sourceIndex)=>{foundInSource||(sourceUsedIds.includes(sourceIndex)?LiteGraph.log_verbose("syncObjectByProperty","aNotFoundInSource skip used slot",sourceInput,sourceIndex):sourceInput[checkX.name]===destInput[checkX.name]&&(foundInSource=!0,sourceUsedIds.push(sourceIndex),new_dest[destIndex]=LiteGraph.cloneObject(sourceInput),LiteGraph.log_debug("syncObjectByProperty","aNotFoundInSource",checkX,"push SHIFTED",destInput[checkX],destInput,sourceIndex,destIndex),keys_remap[sourceIndex]=destIndex))})}),foundInSource||(LiteGraph.log_debug("syncObjectByProperty","aNotFoundInSource, push !foundInSource",ob.ob[property],ob),new_dest[ob.index]=LiteGraph.cloneObject(ob.ob))}):aNotFoundInSource.forEach((ob,i)=>{LiteGraph.log_debug("syncObjectByProperty","!using fallback checks","push !foundInSource",ob.ob[property],ob),new_dest[ob.index]=LiteGraph.cloneObject(ob.ob)})),[]),only_in_source=[];return ob_from.forEach((sourceInput,sourceIndex)=>{let foundInDest=!1;sourceUsedIds.includes(sourceIndex)||(ob_dest.forEach((destInput,destIndex)=>{foundInDest||(destUsedIds.includes(destIndex)?LiteGraph.log_verbose("syncObjectByProperty","only_in_source","skip checked slot",sourceInput,sourceIndex):sourceInput[property]===destInput[property]&&(destUsedIds.push(destIndex),foundInDest=!0))}),foundInDest)||(LiteGraph.log_debug("syncObjectByProperty","push only_in_source",sourceInput[property],sourceInput),new_dest.push(LiteGraph.cloneObject(sourceInput)),keys_remap[sourceIndex]=new_dest.length-1,only_in_source.push(sourceInput))}),LiteGraph.log_info("lgraphnode","syncByProperty",{only_in_source:only_in_source,only_in_target:optsIn,ob_from:ob_from,ob_dest:ob_dest,new_dest:new_dest,keys_remap:keys_remap}),{ob_dest:new_dest,keys_remap:keys_remap,only_in_source:only_in_source,only_in_target:optsIn}}}class LLink{constructor(id,type,origin_id,origin_slot,target_id,target_slot){this.id=id,this.type=type,this.origin_id=origin_id,this.origin_slot=origin_slot,this.target_id=target_id,this.target_slot=target_slot,this._data=null,this._pos=new Float32Array(2)}configure(o){o.constructor===Array?(this.id=o[0],this.origin_id=o[1],this.origin_slot=o[2],this.target_id=o[3],this.target_slot=o[4],this.type=o[5]):(this.id=o.id,this.type=o.type,this.origin_id=o.origin_id,this.origin_slot=o.origin_slot,this.target_id=o.target_id,this.target_slot=o.target_slot)}serialize(){return[this.id,this.origin_id,this.origin_slot,this.target_id,this.target_slot,this.type]}}class Subgraph{static title="Subgraph";static desc="Graph inside a node";constructor(){this.size=[140,80],this.properties={enabled:!0},this.enabled=!0,this.subgraph=new LiteGraph.LGraph,(this.subgraph._subgraph_node=this).subgraph._is_subgraph=!0,this.subgraph.onTrigger=this.onSubgraphTrigger.bind(this),this.subgraph.onInputAdded=this.onSubgraphNewInput.bind(this),this.subgraph.onInputRenamed=this.onSubgraphRenamedInput.bind(this),this.subgraph.onInputTypeChanged=this.onSubgraphTypeChangeInput.bind(this),this.subgraph.onInputRemoved=this.onSubgraphRemovedInput.bind(this),this.subgraph.onOutputAdded=this.onSubgraphNewOutput.bind(this),this.subgraph.onOutputRenamed=this.onSubgraphRenamedOutput.bind(this),this.subgraph.onOutputTypeChanged=this.onSubgraphTypeChangeOutput.bind(this),this.subgraph.onOutputRemoved=this.onSubgraphRemovedOutput.bind(this)}onGetInputs(){return[["enabled","boolean"]]}onDblClick(e,pos,graphcanvas){var that=this;setTimeout(function(){graphcanvas.openSubgraph(that.subgraph)},10)}onAction(action,param){LiteGraph.log_debug("subgraph","onAction",...arguments),this.subgraph.onAction(action,param)}onExecute(){if(this.enabled=this.getInputOrProperty("enabled"),this.enabled){if(this.inputs)for(let i=0;i<this.inputs.length;i++){var input=this.inputs[i],value=this.getInputData(i);this.subgraph.setInputData(input.name,value)}if(LiteGraph.log_verbose("subgraph","onExecute","subgraph runStep",this.subgraph),this.subgraph.runStep(),this.outputs)for(let i=0;i<this.outputs.length;i++){var output=this.outputs[i];let value=this.subgraph.getOutputData(output.name);this.setOutputData(i,value)}}}sendEventToAllNodes(eventname,param,mode){this.enabled&&(LiteGraph.log_debug("subgraph","sendEventToAllNodes",...arguments),this.subgraph.sendEventToAllNodes(eventname,param,mode))}onDrawBackground(ctx,graphcanvas,canvas,pos){var y,over;this.flags.collapsed||(y=this.size[1]-LiteGraph.NODE_TITLE_HEIGHT+.5,over=LiteGraph.isInsideRectangle(pos[0],pos[1],this.pos[0],this.pos[1]+y,this.size[0],LiteGraph.NODE_TITLE_HEIGHT),pos=LiteGraph.isInsideRectangle(pos[0],pos[1],this.pos[0],this.pos[1]+y,this.size[0]/2,LiteGraph.NODE_TITLE_HEIGHT),ctx.fillStyle=over?"#555":"#222",ctx.beginPath(),this._shape==LiteGraph.BOX_SHAPE?pos?ctx.rect(0,y,this.size[0]/2+1,LiteGraph.NODE_TITLE_HEIGHT):ctx.rect(this.size[0]/2,y,this.size[0]/2+1,LiteGraph.NODE_TITLE_HEIGHT):pos?ctx.roundRect(0,y,this.size[0]/2+1,LiteGraph.NODE_TITLE_HEIGHT,[0,0,8,8]):ctx.roundRect(this.size[0]/2,y,this.size[0]/2+1,LiteGraph.NODE_TITLE_HEIGHT,[0,0,8,8]),over?ctx.fill():ctx.fillRect(0,y,this.size[0]+1,LiteGraph.NODE_TITLE_HEIGHT),ctx.textAlign="center",ctx.font="24px Arial",ctx.fillStyle=over?"#DDD":"#999",ctx.fillText("+",.25*this.size[0],24+y),ctx.fillText("+",.75*this.size[0],24+y))}onMouseDown(e,localpos,graphcanvas){var y=this.size[1]-LiteGraph.NODE_TITLE_HEIGHT+.5;console.log?.(0),localpos[1]>y&&(localpos[0]<this.size[0]/2?(console.log?.(1),graphcanvas.showSubgraphPropertiesDialog(this)):(console.log?.(2),graphcanvas.showSubgraphPropertiesDialogRight(this)))}computeSize(){var num_inputs=this.inputs?this.inputs.length:0,num_outputs=this.outputs?this.outputs.length:0;return[200,Math.max(num_inputs,num_outputs)*LiteGraph.NODE_SLOT_HEIGHT+LiteGraph.NODE_TITLE_HEIGHT]}onSubgraphTrigger(event){LiteGraph.log_debug("subgraph","onSubgraphTrigger",...arguments);event=this.findOutputSlot(event);-1!=event&&this.triggerSlot(event)}onSubgraphNewInput(name,type){-1==this.findInputSlot(name)&&this.addInput(name,type)}onSubgraphRenamedInput(oldname,name){oldname=this.findInputSlot(oldname);-1!=oldname&&(this.getInputInfo(oldname).name=name)}onSubgraphTypeChangeInput(name,type){name=this.findInputSlot(name);-1!=name&&(this.getInputInfo(name).type=type)}onSubgraphRemovedInput(name){name=this.findInputSlot(name);-1!=name&&this.removeInput(name)}onSubgraphNewOutput(name,type){-1==this.findOutputSlot(name)&&this.addOutput(name,type)}onSubgraphRenamedOutput(oldname,name){oldname=this.findOutputSlot(oldname);-1!=oldname&&(this.getOutputInfo(oldname).name=name)}onSubgraphTypeChangeOutput(name,type){name=this.findOutputSlot(name);-1!=name&&(this.getOutputInfo(name).type=type)}onSubgraphRemovedOutput(name){name=this.findOutputSlot(name);-1!=name&&this.removeOutput(name)}getExtraMenuOptions(graphcanvas){var that=this;return[{content:"Open",callback:function(){graphcanvas.openSubgraph(that.subgraph)}}]}onResize(size){size[1]+=20}serialize(){var data=LiteGraph.LGraphNode.prototype.serialize.call(this);return data.subgraph=this.subgraph.serialize(),data}reassignSubgraphUUIDs(graph){const idMap={nodeIDs:{},linkIDs:{}};for(const node of graph.nodes){var oldID=node.id,newID=LiteGraph.uuidv4();if(node.id=newID,idMap.nodeIDs[oldID]||idMap.nodeIDs[newID])throw new Error(`New/old node UUID wasn't unique in changed map! ${oldID} `+newID);idMap.nodeIDs[oldID]=newID,idMap.nodeIDs[newID]=oldID}for(const link of graph.links){const oldID=link[0],newID=LiteGraph.uuidv4();if(link[0]=newID,idMap.linkIDs[oldID]||idMap.linkIDs[newID])throw new Error(`New/old link UUID wasn't unique in changed map! ${oldID} `+newID);idMap.linkIDs[oldID]=newID,idMap.linkIDs[newID]=oldID;var nodeFrom=link[1],nodeTo=link[3];if(!idMap.nodeIDs[nodeFrom])throw new Error("Old node UUID not found in mapping! "+nodeFrom);if(link[1]=idMap.nodeIDs[nodeFrom],!idMap.nodeIDs[nodeTo])throw new Error("Old node UUID not found in mapping! "+nodeTo);link[3]=idMap.nodeIDs[nodeTo]}for(const node of graph.nodes){if(node.inputs)for(const input of node.inputs)input.link&&(input.link=idMap.linkIDs[input.link]);if(node.outputs)for(const output of node.outputs)output.links&&(output.links=output.links.map(l=>idMap.linkIDs[l]))}for(const node of graph.nodes){var merge;"graph/subgraph"===node.type&&(merge=reassignGraphUUIDs(node.subgraph),idMap.nodeIDs.assign(merge.nodeIDs),idMap.linkIDs.assign(merge.linkIDs))}}clone(){var subgraph,node=LiteGraph.createNode(this.type),data=this.serialize();return LiteGraph.use_uuids&&(subgraph=LiteGraph.cloneObject(data.subgraph),this.reassignSubgraphUUIDs(subgraph),data.subgraph=subgraph),delete data.id,delete data.inputs,delete data.outputs,node.configure(data),node}buildFromNodes(nodes){var ids={};for(let i=0;i<nodes.length;++i)ids[node.id]=nodes[i];for(let i=0;i<nodes.length;++i){let node=nodes[i];if(node.inputs)for(let j=0;j<node.inputs.length;++j){var link,input=node.inputs[j];input&&input.link&&((link=node.graph.links[input.link])&&!ids[link.origin_id]&&this.subgraph.addInput(input.name,link.type))}if(node.outputs)for(let j=0;j<node.outputs.length;++j){var output=node.outputs[j];if(output&&output.links&&output.links.length)for(let k=0;k<output.links.length;++k){let link=node.graph.links[output.links[k]];if(link&&!ids[link.target_id])break}}}}static title_color="#334"}class GraphInput{static title="Input";static desc="Input of the graph";constructor(){this.addOutput("","number"),this.name_in_graph="",this.properties={name:"",type:"number",value:0};var that=this;this.name_widget=this.addWidget("text","Name",this.properties.name,function(v){v&&that.setProperty("name",v)}),this.type_widget=this.addWidget("text","Type",this.properties.type,function(v){that.setProperty("type",v)}),this.value_widget=this.addWidget("number","Value",this.properties.value,function(v){that.setProperty("value",v)}),this.widgets_up=!0,this.size=[180,90]}onConfigure(){this.updateType()}updateType(){var type=this.properties.type;"action"!=(this.type_widget.value=type)&&"event"!=type||(type=LiteGraph.EVENT),this.outputs[0].type!==type&&(LiteGraph.isValidConnection(this.outputs[0].type,type)||this.disconnectOutput(0),this.outputs[0].type=type),"number"==(this.properties.type=type)?(this.value_widget.type="number",this.value_widget.value=Number()):"boolean"==type?(this.value_widget.type="toggle",this.value_widget.value=!(!this.value_widget.value||"false"===(this.value_widget.value+"").toLocaleLowerCase()||""===this.value_widget.value)):"string"==type?(this.value_widget.type="text",this.value_widget.value=this.value_widget.value+""):this.value_widget.type=null,this.properties.value=this.value_widget.value,this.graph&&this.name_in_graph&&this.graph.changeInputType(this.name_in_graph,type)}onPropertyChanged(name,v){if("name"==name){if(""==v||v==this.name_in_graph||"enabled"==v)return!1;this.graph&&(this.name_in_graph?this.graph.renameInput(this.name_in_graph,v):this.graph.addInput(v,this.properties.type)),this.name_widget.value=v,this.name_in_graph=v}else"type"==name&&this.updateType()}getTitle(){return this.flags.collapsed?this.properties.name:this.title}onAction(action,param){this.properties.type==LiteGraph.EVENT?(LiteGraph.log_debug("GraphInput","onAction","triggering slot",action,param),this.triggerSlot(0,param)):LiteGraph.log_debug("GraphInput","onAction","NOT eventAction TYPE","this",this,"arugments",...arguments)}onExecute(){var name=this.properties.name,name=this.graph.inputs[name];name?this.setOutputData(0,(void 0!==name.value?name:this.properties).value):this.setOutputData(0,this.properties.value)}onRemoved(){this.name_in_graph&&this.graph.removeInput(this.name_in_graph)}}class GraphOutput{static title="Output";static desc="Output of the graph";constructor(){this.addInput("",""),this.name_in_graph="",this.properties={name:"",type:""},this.name_widget=this.addWidget("text","Name",this.properties.name,"name"),this.type_widget=this.addWidget("text","Type",this.properties.type,"type"),this.widgets_up=!0,this.size=[180,60]}onPropertyChanged(name,v){if("name"==name){if(""==v||v==this.name_in_graph||"enabled"==v)return!1;this.graph&&(this.name_in_graph?this.graph.renameOutput(this.name_in_graph,v):this.graph.addOutput(v,this.properties.type)),this.name_widget.value=v,this.name_in_graph=v}else"type"==name&&this.updateType()}updateType(){var type=this.properties.type;this.type_widget&&(this.type_widget.value=type),"action"!=type&&"event"!=type||(type=LiteGraph.EVENT),this.inputs[0].type!==type&&(LiteGraph.isValidConnection(this.inputs[0].type,type)||this.disconnectInput(0),this.inputs[0].type=type),this.properties.type=type,this.graph&&this.name_in_graph&&this.graph.changeOutputType(this.name_in_graph,type)}onExecute(){this._value=this.getInputData(0),this.graph.setOutputData(this.properties.name,this._value)}onAction(action,param){this.properties.type==LiteGraph.ACTION?(LiteGraph.log_debug("GraphOutput","onAction",...arguments),LiteGraph.log_debug("GraphOutput","onAction","graphTrigger",this.properties.name,param),this.triggerSlot(this.properties.name,param),this.graph.trigger(this.properties.name,param)):LiteGraph.log_debug("GraphOutput","onAction","skipping not ACTION type",this.properties.type,this.properties)}onRemoved(){this.name_in_graph&&this.graph.removeOutput(this.name_in_graph)}getTitle(){return this.flags.collapsed?this.properties.name:this.title}}LiteGraph.initialize();class Time{static title="Time";static desc="Time";constructor(){this.addOutput("in ms","number"),this.addOutput("in sec","number")}onExecute(){this.setOutputData(0,1e3*this.graph.globaltime),this.setOutputData(1,this.graph.globaltime)}}LiteGraph.registerNodeType("basic/time",Time);class Empty{static title="";static desc="Empty node";constructor(){}onExecute(){}}LiteGraph.registerNodeType("basic/empty",Empty);class ConstantNumber{static title="Const Number";static desc="Constant number";constructor(){this.addOutput("value","number"),this.addProperty("value",1,"number"),this.addProperty("precision",12,"number",{min:0,max:12}),this.addProperty("step",1,"number"),this.addProperty("min",0,"number"),this.addProperty("max",Number.MAX_SAFE_INTEGER,"number"),this.widget=this.addWidget("number","value",1,"value",{precision:this.properties.precision,step:this.properties.step,min:this.properties.min}),this.widgets_up=!0,this.size=[180,30]}onPropertyChanged(name,value){if(-1!==["precision","step","min"].indexOf(name)){if("precision"==name)return value=Math.max(0,Math.min(value,12)),!1;this.widgets[0].options[name]=value}}onExecute(){this.setOutputData(0,parseFloat(this.properties.value))}getTitle(){return this.flags?.collapsed?this.properties?.value:this.title}setValue(v){this.setProperty("value",v)}onDrawBackground(){this.outputs[0].label=LiteGraph.formatNumber(this.properties.value,3)}}LiteGraph.registerNodeType("basic/const",ConstantNumber);class ConstantBoolean{static title="Const Boolean";static desc="Constant boolean";constructor(){this.addOutput("bool","boolean"),this.addProperty("value",!0),this.widget=this.addWidget("toggle","value",!0,"value"),this.serialize_widgets=!0,this.widgets_up=!0,this.size=[140,30]}onExecute(){this.setOutputData(0,this.properties.value)}onGetInputs(){return[["toggle",LiteGraph.ACTION]]}onAction(){this.setValue(!this.properties?.value)}}ConstantBoolean.prototype.getTitle=ConstantNumber.prototype.getTitle,ConstantBoolean.prototype.setValue=ConstantNumber.prototype.setValue,LiteGraph.registerNodeType("basic/boolean",ConstantBoolean);class ConstantString{static title="Const String";static desc="Constant string";constructor(){this.addOutput("string","string"),this.addProperty("value",""),this.widget=this.addWidget("text","value","","value"),this.widgets_up=!0,this.size=[180,30]}onExecute(){this.setOutputData(0,this.properties.value)}onDropFile(file){var that=this,reader=new FileReader;reader.onload=function(e){that.setProperty("value",e.target.result)},reader.readAsText(file)}}ConstantString.prototype.getTitle=ConstantNumber.prototype.getTitle,ConstantString.prototype.setValue=ConstantNumber.prototype.setValue,LiteGraph.registerNodeType("basic/string",ConstantString);class ConstantObject{static title="Const Object";static desc="Constant Object";constructor(){this.addOutput("obj","object"),this.size=[120,30],this._object={}}onExecute(){this.setOutputData(0,this._object)}}LiteGraph.registerNodeType("basic/object",ConstantObject);class ConstantFile{static title="Const File";static desc="Fetches a file from an url";constructor(){this.addInput("url","string"),this.addOutput("file","string"),this.addProperty("url",""),this.addProperty("type","text"),this.widget=this.addWidget("text","url","","url"),this._data=null}onPropertyChanged(name,value){"url"==name&&(null==value||""==value?this._data=null:this.fetchFile(value))}onExecute(){var url=this.getInputData(0)||this.properties.url;!url||url==this._url&&this._type==this.properties?.type||this.fetchFile(url),this.setOutputData(0,this._data)}fetchFile(url){var that=this;url&&url.constructor===String?(this._url=url,this._type=this.properties?.type,"http"==url.substr(0,4)&&LiteGraph.proxy&&(url=LiteGraph.proxy+url.substr(url.indexOf(":")+3)),fetch(url).then(function(response){if(response.ok)return"arraybuffer"==that.properties.type?response.arrayBuffer():"text"==that.properties.type?response.text():"json"==that.properties.type?response.json():"blob"==that.properties.type?response.blob():void 0;throw new Error("File not found")}).then(function(data){that._data=data,that.boxcolor="#AEA"}).catch(_error=>{that._data=null,that.boxcolor="red",console.error?.("error fetching file:",url)})):(that._data=null,that.boxcolor=null)}onDropFile(file){var that=this,reader=(this._url=file.name,this._type=this.properties?.type,this.properties.url=file.name,new FileReader);if(reader.onload=function(e){that.boxcolor="#AEA";e=e.target.result;"json"==that.properties.type&&(e=JSON.parse(e)),that._data=e},"arraybuffer"==that.properties.type)reader.readAsArrayBuffer(file);else if("text"==that.properties.type||"json"==that.properties.type)reader.readAsText(file);else if("blob"==that.properties.type)return reader.readAsBinaryString(file)}static"@type"={type:"enum",values:["text","arraybuffer","blob","json"]}}ConstantFile.prototype.setValue=ConstantNumber.prototype.setValue,LiteGraph.registerNodeType("basic/file",ConstantFile);class JSONParse{static title="JSON Parse";static desc="Parses JSON String into object";constructor(){this.addInput("parse",LiteGraph.ACTION),this.addInput("json","string"),this.addOutput("done",LiteGraph.EVENT),this.addOutput("object","object"),this.widget=this.addWidget("button","parse","",this.parse.bind(this)),this._str=null,this._obj=null}parse(){if(this._str)try{this._str=this.getInputData(1),this._obj=JSON.parse(this._str),this.boxcolor="#AEA",this.triggerSlot(0)}catch(err){this.boxcolor="red"}}onExecute(){this._str=this.getInputData(1),this.setOutputData(1,this._obj)}onAction(name){"parse"==name&&this.parse()}}LiteGraph.registerNodeType("basic/jsonparse",JSONParse);class ConstantData{static title="Const Data";static desc="Constant Data";constructor(){this.addOutput("data","object"),this.addProperty("value",""),this.widget=this.addWidget("text","json","","value"),this.widgets_up=!0,this.size=[140,30],this._value=null}onPropertyChanged(name,value){if(null!=(this.widget.value=value)&&""!=value)try{this._value=JSON.parse(value),this.boxcolor="#AEA"}catch(err){this.boxcolor="red"}}onExecute(){this.setOutputData(0,this._value)}}ConstantData.prototype.setValue=ConstantNumber.prototype.setValue,LiteGraph.registerNodeType("basic/data",ConstantData);class ConstantArray{static title="Const Array";static desc="Constant Array";constructor(){this._value=[],this.addInput("array",""),this.addOutput("arrayOut","array"),this.addOutput("length","number"),this.addProperty("value","[]"),this.addProperty("persistent",!1),this.widget=this.addWidget("text","array",this.properties?.value,"value"),this.addWidget("combo","persistent",this.properties?.persistent,!1,{values:[!0,!1]}),this.widgets_up=!0,this.size=[140,50]}onPropertyChanged(name,value){if(null!=(this.widget.value=value)&&""!=value)try{"["!=value[0]?this._value=JSON.parse("["+value+"]"):this._value=JSON.parse(value),this.boxcolor="#AEA"}catch(err){this.boxcolor="red"}}onExecute(){var v=this.getInputOrProperty("array");this._value=v,this._value&&this.properties?.persistent&&"false"!==this.properties?.persistent||(this._value=new Array),this.setOutputData(0,this._value),this.setOutputData(1,this._value&&this._value.length||0)}}ConstantArray.prototype.setValue=ConstantNumber.prototype.setValue,LiteGraph.registerNodeType("basic/array",ConstantArray);class ArrayLength{static title="aLength";static desc="Get the length of an array";constructor(){this.addInput("arr","array"),this.addOutput("length","number")}onExecute(){var arr=this.getInputData(0);arr&&(["array","object"].includes(typeof arr)&&void 0!==arr.length?this.setOutputData(0,arr.length):(console.debug?.("Not an array or object",typeof arr,arr),this.setOutputData(0,null)))}}LiteGraph.registerNodeType("basic/array_length",ArrayLength);class SetArray{static title="Set Array";static desc="Sets index of array";constructor(){this.addInput("arr","array"),this.addInput("value",""),this.addOutput("arr","array"),this.properties={index:0},this.widget=this.addWidget("number","i",this.properties?.index,"index",{precision:0,step:10,min:0})}onExecute(){var v,arr=this.getInputData(0);arr&&void 0!==(v=this.getInputData(1))&&(this.properties?.index&&(arr[Math.floor(this.properties?.index)]=v),this.setOutputData(0,arr))}}LiteGraph.registerNodeType("basic/set_array",SetArray);class ArrayElement{static title="Array[i]";static desc="Returns an element from an array";constructor(){this.addInput("array","array,table,string"),this.addInput("index","number"),this.addOutput("value",""),this.addProperty("index",0)}onExecute(){var array=this.getInputData(0),index=this.getInputData(1);null==index&&(index=this.properties?.index),null!=array&&null!=index&&this.setOutputData(0,array[Math.floor(Number(index))])}}LiteGraph.registerNodeType("basic/array[]",ArrayElement);class ArrayAppend{static title="Array Append";static desc="Pushes an element to an array";constructor(){this.addInput("array","array"),this.addInput("element",0),this.addOutput("success","boolean")}onExecute(){var array=this.getInputData(0),el=this.getInputData(1);null!==array&&array&&"function"==typeof array.push?(array.push(el),this.setOutputData(0,!0)):this.setOutputData(0,!1)}}LiteGraph.registerNodeType("basic/array_append",ArrayAppend);class TableElement{static title="Table[row][col]";static desc="Returns an element from a table";constructor(){this.addInput("table","table"),this.addInput("row","number"),this.addInput("col","number"),this.addOutput("value",""),this.addProperty("row",0),this.addProperty("column",0)}onExecute(){var table=this.getInputData(0),row=this.getInputData(1),col=this.getInputData(2);null==row&&(row=this.properties?.row),null==col&&(col=this.properties?.column),null!=table&&null!=row&&null!=col&&((row=table[Math.floor(Number(row))])?this.setOutputData(0,row[Math.floor(Number(col))]):this.setOutputData(0,null))}}LiteGraph.registerNodeType("basic/table[][]",TableElement);class Variable{static title="Variable";static desc="store/read variable value";constructor(){this.size=[60,30],this.addInput("in"),this.addOutput("out"),this.properties={varname:"myname",container:Variable.LITEGRAPH},this.value=null}onExecute(){var container=this.getContainer();this.isInputConnected(0)?(this.value=this.getInputData(0),container[this.properties?.varname]=this.value,this.setOutputData(0,this.value)):this.setOutputData(0,container[this.properties?.varname])}getContainer(){switch(this.properties?.container){case Variable.GRAPH:return this.graph?this.graph.vars:{};case Variable.GLOBALSCOPE:return global;default:return LiteGraph.Globals}}getTitle(){return this.properties?.varname}}function length(v){return v&&null!=v.length?Number(v.length):0}Variable.LITEGRAPH=0,Variable.GRAPH=1,Variable.GLOBALSCOPE=2,Variable["@container"]={type:"enum",values:{litegraph:Variable.LITEGRAPH,graph:Variable.GRAPH,global:Variable.GLOBALSCOPE}},LiteGraph.registerNodeType("basic/variable",Variable),LiteGraph.wrapFunctionAsNode("basic/length",length,[""],"number"),LiteGraph.wrapFunctionAsNode("basic/not",function(a){return!a},[""],"boolean");class DownloadData{static title="Download";static desc="Download some data";constructor(){this.size=[60,30],this.addInput("data",0),this.addInput("download",LiteGraph.ACTION),this.properties={filename:"data.json"},this.value=null;var that=this;this.addWidget("button","Download","",()=>{that.value&&that.downloadAsFile()})}downloadAsFile(){var url,str;null!=this.value&&(str=null,str=this.value.constructor===String?this.value:JSON.stringify(this.value),str=new Blob([str]),url=URL.createObjectURL(str),(str=document.createElement("a")).setAttribute("href",url),str.setAttribute("download",this.properties?.filename),str.style.display="none",document.body.appendChild(str),str.click(),document.body.removeChild(str),setTimeout(function(){URL.revokeObjectURL(url)},6e4))}onAction(){var that=this;setTimeout(function(){that.downloadAsFile()},100)}onExecute(){this.inputs[0]&&(this.value=this.getInputData(0))}getTitle(){return this.flags?.collapsed?this.properties?.filename:this.title}}LiteGraph.registerNodeType("basic/download",DownloadData);class Watch{static title="Watch";static desc="Show value of input";constructor(){this.size=[60,30],this.addInput("value",0,{label:""}),this.value=0}onConnectionChanged(connection,slot,connected,link_info){connection==LiteGraph.INPUT&&(this.value=this.getInputData(0,!0))}onExecute(){this.inputs[0]&&(this.value=this.getInputData(0))}getTitle(){return this.flags?.collapsed?this.inputs[0].label:this.title}static toString(o){if(null==o)return"null";if(o.constructor===Number)return o.toFixed(3);if(o.constructor!==Array)return String(o);for(var str="[",i=0;i<o.length;++i)str+=Watch.toString(o[i])+(i+1!=o.length?",":"");return str+="]"}onDrawBackground(){this.inputs[0].label=Watch.toString(this.value)}}LiteGraph.registerNodeType("basic/watch",Watch);class Cast{static title="Cast";static desc="Allows to connect different types";constructor(){this.addInput("in",0),this.addOutput("out",0),this.size=[40,30]}onExecute(){this.setOutputData(0,this.getInputData(0))}}LiteGraph.registerNodeType("basic/cast",Cast);class Console{static title="Console";static desc="Show value inside the console";constructor(){this.mode=LiteGraph.ON_EVENT,this.size=[80,30],this.addProperty("msg",""),this.addInput("log",LiteGraph.EVENT),this.addInput("msg",0)}onAction(action,param,options,slot_index){this.onExecute(action,param,options)}onExecute(param,options){var action=param;let msg=this.getInputData(1);msg=msg||this.properties?.msg,"log"==action?console.log(msg,param):"warn"==action?console.warn(msg,param):"error"==action?console.error(msg,param):(console.info("[ConsoleNode]",msg,param),console.verbose("[ConsoleNode]",msg,param,"options:",options))}onGetInputs(){return[["log",LiteGraph.ACTION],["warn",LiteGraph.ACTION],["error",LiteGraph.ACTION]]}}LiteGraph.registerNodeType("basic/console",Console);class Alert{static title="Alert";static desc="Show an alert window";constructor(){this.mode=LiteGraph.ON_EVENT,this.addProperty("msg",""),this.addInput("",LiteGraph.EVENT),this.widget=this.addWidget("text","Text","","msg"),this.widgets_up=!0,this.size=[200,30]}onConfigure(o){this.widget.value=o.properties.msg}onAction(){var msg=this.properties?.msg;setTimeout(function(){alert(msg)},10)}static color="#510"}LiteGraph.registerNodeType("basic/alert",Alert);class NodeScript{static title="Script";static desc="executes a code (max 256 characters)";constructor(){this.size=[60,30],this.addProperty("onExecute","return A;"),this.addInput("A",0),this.addInput("B",0),this.addOutput("out",0),this._func=null,this.data={}}onConfigure(o){o.properties.onExecute&&LiteGraph.allow_scripts?this.compileCode(o.properties.onExecute):console.warn?.("Script not compiled, LiteGraph.allow_scripts is false")}onPropertyChanged(name,value){"onExecute"==name&&LiteGraph.allow_scripts?this.compileCode(value):console.warn?.("Script not compiled, LiteGraph.allow_scripts is false")}compileCode(code){if(this._func=null,256<code.length)console.warn?.("Script too long, max 256 chars");else{for(var code_low=code.toLowerCase(),forbidden_words=["script","body","document","eval","nodescript","function"],i=0;i<forbidden_words.length;++i)if(-1!=code_low.indexOf(forbidden_words[i]))return void console.warn?.("invalid script");try{this._func=new Function("A","B","C","DATA","node",code)}catch(err){console.error?.("Error parsing script"),console.error?.(err)}}}onExecute(){if(this._func)try{var A=this.getInputData(0),B=this.getInputData(1),C=this.getInputData(2);this.setOutputData(0,this._func(A,B,C,this.data,this))}catch(err){console.error?.("Error in script"),console.error?.(err)}}onGetOutputs(){return[["C",""]]}static widgets_info={onExecute:{type:"code"}}}LiteGraph.registerNodeType("basic/script",NodeScript);class GenericCompare{static title="Compare *";static desc="evaluates condition between A and B";constructor(){this.addInput("A",0),this.addInput("B",0),this.addOutput("true","boolean"),this.addOutput("false","boolean"),this.addProperty("A",1),this.addProperty("B",1),this.addProperty("OP","==","enum",{values:GenericCompare.values}),this.addWidget("combo","Op.",this.properties?.OP,{property:"OP",values:GenericCompare.values}),this.size=[80,60]}getTitle(){return"*A "+this.properties?.OP+" *B"}onExecute(){var A=this.getInputData(0),B=(void 0===A?A=this.properties?.A:this.properties.A=A,this.getInputData(1)),result=(void 0===B?B=this.properties?.B:this.properties.B=B,!1);if(typeof A==typeof B)switch(this.properties?.OP){case"==":case"!=":if(result=!0,"object"==typeof A){var aProps=Object.getOwnPropertyNames(A),bProps=Object.getOwnPropertyNames(B);if(aProps.length!=bProps.length)result=!1;else for(var i=0;i<aProps.length;i++){var propName=aProps[i];if(A[propName]!==B[propName]){result=!1;break}}}else result=A==B;"!="==this.properties?.OP&&(result=!result)}this.setOutputData(0,result),this.setOutputData(1,!result)}static values=["==","!="];static"@OP"={type:"enum",title:"operation",values:GenericCompare.values}}LiteGraph.registerNodeType("basic/CompareValues",GenericCompare);class LogEvent{static title="Log Event";static desc="Log event in console";constructor(){this.size=[60,30],this.addInput("event",LiteGraph.ACTION)}onAction(action,param,options,slot_index){console.log("LogNode",action,param,options,slot_index)}}LiteGraph.registerNodeType("events/log",LogEvent);class TriggerEvent{static title="TriggerEvent";static desc="Triggers event if input evaluates to true";constructor(){this.size=[60,30],this.addInput("if",""),this.addOutput("true",LiteGraph.EVENT),this.addOutput("change",LiteGraph.EVENT),this.addOutput("false",LiteGraph.EVENT),this.properties={only_on_change:!0,tooltip:"Triggers event if input evaluates to true"},this.prev=0}onExecute(param,options){var v=this.getInputData(0),changed=v!=this.prev,must_resend=(changed=0===this.prev?!1:changed)&&this.properties.only_on_change||!changed&&!this.properties.only_on_change;v&&must_resend&&this.triggerSlot(0,param,null,options),!v&&must_resend&&this.triggerSlot(2,param,null,options),changed&&this.triggerSlot(1,param,null,options),this.prev=v}}LiteGraph.registerNodeType("events/trigger",TriggerEvent);class EvSequence{static title="Sequence";static desc="Triggers a sequence of events when an event arrives";constructor(){var that=this;this.addInput("",LiteGraph.ACTION,{removable:!0,nameLocked:!1}),this.addInput("",LiteGraph.ACTION,{removable:!0,nameLocked:!1}),this.addInput("",LiteGraph.ACTION,{removable:!0,nameLocked:!1}),this.addOutput("",LiteGraph.EVENT,{removable:!0,nameLocked:!1}),this.addOutput("",LiteGraph.EVENT,{removable:!0,nameLocked:!1}),this.addOutput("",LiteGraph.EVENT,{removable:!0,nameLocked:!1}),this.addWidget("button","+",null,function(){that.addInput("",LiteGraph.ACTION),that.addOutput("",LiteGraph.EVENT)}),this.size=[90,30],this.flags={horizontal:!0,render_box:!1}}getTitle(){return""}onAction(action,param,options){if(this.outputs){options=options||{};for(var i=0;i<this.outputs.length;++i)options.action_call?options.action_call=options.action_call+"_seq_"+i:options.action_call=this.id+"_"+(action||"action")+"_seq_"+i+"_"+Math.floor(9999*Math.random()),this.triggerSlot(i,param,null,options)}}}LiteGraph.registerNodeType("events/sequence",EvSequence);class WaitAll{static title="WaitAll";static desc="Wait until all input events arrive then triggers output";constructor(){var that=this;this.addInput("",LiteGraph.ACTION),this.addInput("",LiteGraph.ACTION),this.addOutput("",LiteGraph.EVENT),this.addWidget("button","+",null,function(){that.addInput("",LiteGraph.ACTION),that.size[0]=90}),this.size=[90,70],this.ready=[]}getTitle(){return""}onDrawBackground(ctx){if(!this.flags?.collapsed)for(var i=0;i<this.inputs.length;++i){var y=i*LiteGraph.NODE_SLOT_HEIGHT+10;ctx.fillStyle=this.ready[i]?"#AFB":"#000",ctx.fillRect(20,y,10,10)}}onAction(action,param,options,slot_index){if(null!=slot_index){this.ready.length=this.outputs.length,this.ready[slot_index]=!0;for(var i=0;i<this.ready.length;++i)if(!this.ready[i])return;this.reset(),this.triggerSlot(0)}}reset(){this.ready.length=0}}LiteGraph.registerNodeType("events/waitAll",WaitAll);class Stepper{static title="Stepper";static desc="Trigger events sequentially when an tick arrives";constructor(){var that=this;this.properties={index:0},this.addInput("index","number"),this.addInput("step",LiteGraph.ACTION),this.addInput("reset",LiteGraph.ACTION),this.addOutput("index","number"),this.addOutput("",LiteGraph.EVENT),this.addOutput("",LiteGraph.EVENT),this.addOutput("",LiteGraph.EVENT,{removable:!0}),this.addWidget("button","+",null,function(){that.addOutput("",LiteGraph.EVENT,{removable:!0})}),this.size=[120,120],this.flags={render_box:!1}}onDrawBackground(ctx){var w,index;this.flags?.collapsed||(index=this.properties.index||0,ctx.fillStyle="#AFB",w=this.size[0],index=(index+1)*LiteGraph.NODE_SLOT_HEIGHT+4,ctx.beginPath(),ctx.moveTo(w-30,index),ctx.lineTo(w-30,index+LiteGraph.NODE_SLOT_HEIGHT),ctx.lineTo(w-15,index+.5*LiteGraph.NODE_SLOT_HEIGHT),ctx.fill())}onExecute(){var index=this.getInputData(0);null!=index&&(index=Math.floor(index),(index=LiteGraph.clamp(index,0,this.outputs?this.outputs.length-2:0))!=this.properties.index)&&(this.properties.index=index,this.triggerSlot(index+1)),this.setOutputData(0,this.properties.index)}onAction(action,param){"reset"==action?this.properties.index=0:"step"==action&&(this.triggerSlot(this.properties.index+1,param),action=this.outputs?this.outputs.length-1:0,this.properties.index=(this.properties.index+1)%action)}}LiteGraph.registerNodeType("events/stepper",Stepper);class FilterEvent{static title="Filter Event";static desc="Blocks events that do not match the filter";constructor(){this.size=[60,30],this.addInput("event",LiteGraph.ACTION),this.addOutput("event",LiteGraph.EVENT),this.properties={equal_to:"",has_property:"",property_equal_to:""}}onAction(action,param,options){if(null!=param&&(!this.properties.equal_to||this.properties.equal_to==param)){if(this.properties.has_property){var prop=param[this.properties.has_property];if(null==prop)return;if(this.properties.property_equal_to&&this.properties.property_equal_to!=prop)return}this.triggerSlot(0,param,null,options)}}}LiteGraph.registerNodeType("events/filter",FilterEvent);class EventBranch{static title="Branch";static desc="If condition is true, outputs triggers true, otherwise false";constructor(){this.addInput("in",LiteGraph.ACTION),this.addInput("cond","boolean"),this.addOutput("true",LiteGraph.EVENT),this.addOutput("false",LiteGraph.EVENT),this.size=[120,60],this._value=!1}onExecute(){this._value=this.getInputData(1)}onAction(action,param,options){this._value=this.getInputData(1),this.triggerSlot(this._value?0:1,param,null,options)}}LiteGraph.registerNodeType("events/branch",EventBranch);class EventCounter{static title="Counter";static desc="Counts events";constructor(){this.addInput("inc",LiteGraph.ACTION),this.addInput("dec",LiteGraph.ACTION),this.addInput("reset",LiteGraph.ACTION),this.addOutput("change",LiteGraph.EVENT),this.addOutput("num","number"),this.addProperty("doCountExecution",!1,"boolean",{name:"Count Executions"}),this.addWidget("toggle","Count Exec.",this.properties.doCountExecution,"doCountExecution"),this.num=0}getTitle(){return this.flags?.collapsed?String(this.num):this.title}onAction(action){var v=this.num;"inc"==action?this.num+=1:"dec"==action?--this.num:"reset"==action&&(this.num=0),this.setOutputData(1,this.num),this.num!=v&&this.changed()}changed(){this.trigger("change",this.num)}onDrawBackground(ctx){this.flags?.collapsed||(ctx.fillStyle="#AAA",ctx.font="20px Arial",ctx.textAlign="center",ctx.fillText(this.num,.5*this.size[0],.5*this.size[1]))}onExecute(){this.properties.doCountExecution&&(this.num+=1,this.changed()),this.setOutputData(1,this.num)}}LiteGraph.registerNodeType("events/counter",EventCounter);class DelayEvent{static title="Delay";static desc="Delays one event";constructor(){this.size=[60,30],this.addProperty("time_in_ms",1e3),this.addInput("event",LiteGraph.ACTION),this.addOutput("on_time",LiteGraph.EVENT),this._pending=[]}onAction(action,param,options){var time=this.properties.time_in_ms;time<=0?this.trigger(null,param,options):this._pending.push([time,param])}onExecute(param,options){var dt=1e3*this.graph.elapsed_time;this.isInputConnected(1)&&(this.properties.time_in_ms=this.getInputData(1));for(var i=0;i<this._pending.length;++i){var actionPass=this._pending[i];actionPass[0]-=dt,0<actionPass[0]||(this._pending.splice(i,1),--i,this.trigger(null,actionPass[1],options))}}onGetInputs(){return[["event",LiteGraph.ACTION],["time_in_ms","number"]]}}LiteGraph.registerNodeType("events/delay",DelayEvent);class TimerEvent{static title="Timer";static desc="Sends an event every N milliseconds";constructor(){this.addProperty("interval",1e3),this.addProperty("event","tick"),this.addOutput("on_tick",LiteGraph.EVENT),this.time=0,this.last_interval=1e3,this.triggered=!1}onStart(){this.time=0}getTitle(){return"Timer: "+this.last_interval.toString()+"ms"}onDrawBackground(){this.boxcolor=this.triggered?TimerEvent.on_color:TimerEvent.off_color,this.triggered=!1}onExecute(){var dt=1e3*this.graph.elapsed_time,trigger=0==this.time;this.time+=dt,this.last_interval=Math.max(1,0|this.getInputOrProperty("interval")),!trigger&&(this.time<this.last_interval||isNaN(this.last_interval))?this.inputs&&1<this.inputs.length&&this.inputs[1]&&this.setOutputData(1,!1):(this.triggered=!0,this.time=this.time%this.last_interval,this.trigger("on_tick",this.properties.event),this.inputs&&1<this.inputs.length&&this.inputs[1]&&this.setOutputData(1,!0))}onGetInputs(){return[["interval","number"]]}onGetOutputs(){return[["tick","boolean"]]}}TimerEvent.on_color="#AAA",TimerEvent.off_color="#222",LiteGraph.registerNodeType("events/timer",TimerEvent);class SemaphoreEvent{static title="Semaphore Event";static desc="Until both events are not triggered, it doesnt continue.";constructor(){this.addInput("go",LiteGraph.ACTION),this.addInput("green",LiteGraph.ACTION),this.addInput("red",LiteGraph.ACTION),this.addOutput("continue",LiteGraph.EVENT),this.addOutput("blocked",LiteGraph.EVENT),this.addOutput("is_green","boolean"),this._ready=!1,this.properties={};var that=this;this.addWidget("button","reset","",function(){that._ready=!1})}onExecute(){this.setOutputData(1,this._ready),this.boxcolor=this._ready?"#9F9":"#FA5"}onAction(action){"go"==action?this.triggerSlot(this._ready?0:1):"green"==action?this._ready=!0:"red"==action&&(this._ready=!1)}}LiteGraph.registerNodeType("events/semaphore",SemaphoreEvent);class OnceEvent{static title="Once";static desc="Only passes an event once, then gets locked";constructor(){this.addInput("in",LiteGraph.ACTION),this.addInput("reset",LiteGraph.ACTION),this.addOutput("out",LiteGraph.EVENT),this._once=!1,this.properties={};var that=this;this.addWidget("button","reset","",function(){that._once=!1})}onAction(action,param){"in"!=action||this._once?"reset"==action&&(this._once=!1):(this._once=!0,this.triggerSlot(0,param))}}LiteGraph.registerNodeType("events/once",OnceEvent);class DataStore{static title="Data Store";static desc="Stores data and only changes when event is received";constructor(){this.addInput("data",0),this.addInput("assign",LiteGraph.ACTION),this.addOutput("data",0),this._last_value=null,this.properties={data:null,serialize:!0};var that=this;this.addWidget("button","store","",function(){that.properties.data=that._last_value})}onExecute(){this._last_value=this.getInputData(0),this.setOutputData(0,this.properties.data)}onAction(){this.properties.data=this._last_value}onSerialize(o){null==o.data||this.properties.serialize&&(o.data.constructor===String||o.data.constructor===Number||o.data.constructor===Boolean||o.data.constructor===Array||o.data.constructor===Object)||(o.data=null)}}LiteGraph.registerNodeType("basic/data_store",DataStore);class WidgetButton{static title="Button";static desc="Triggers an event";constructor(){this.addOutput("",LiteGraph.EVENT),this.addOutput("","boolean"),this.addProperty("text","DO"),this.addProperty("font_size",30),this.addProperty("message",""),this.size=[84,84],this.clicked=!1}onDrawForeground(ctx){var font_size;!this.flags.collapsed&&(ctx.fillStyle="black",ctx.fillRect(11,11,this.size[0]-20,this.size[1]-20),ctx.fillStyle="#AAF",ctx.fillRect(9,9,this.size[0]-20,this.size[1]-20),ctx.fillStyle=this.clicked?"white":this.mouseOver?"#668":"#334",ctx.fillRect(10,10,this.size[0]-20,this.size[1]-20),this.properties.text||0===this.properties.text)&&(font_size=this.properties.font_size||30,ctx.textAlign="center",ctx.fillStyle=this.clicked?"black":"white",ctx.font=font_size+"px "+WidgetButton.font,ctx.fillText(this.properties.text,.5*this.size[0],.5*this.size[1]+.3*font_size),ctx.textAlign="left")}onMouseDown(e,local_pos){if(console.warn("DBG","WidgetButton","onMouseDown",this),1<local_pos[0]&&1<local_pos[1]&&local_pos[0]<this.size[0]-2&&local_pos[1]<this.size[1]-2)return LiteGraph.log_info("WidgetButton","clicked inside"),this.clicked=!0,this.setOutputData(1,this.clicked),this.triggerSlot(0,this.properties.message),!0;LiteGraph.log_info("WidgetButton","clicked outside")}onExecute(){this.setOutputData(1,this.clicked)}onMouseUp(_e){this.clicked=!1,LiteGraph.log_info("WidgetButton","mouse up")}static font="Arial"}LiteGraph.registerNodeType("widget/button",WidgetButton);class WidgetToggle{static title="Toggle";static desc="Toggles between true or false";constructor(){this.addInput("","boolean"),this.addInput("e",LiteGraph.ACTION),this.addOutput("v","boolean"),this.addOutput("e",LiteGraph.EVENT),this.properties={font:"",value:!1},this.size=[160,44]}onDrawForeground(ctx){var size,h,w;this.flags.collapsed||(size=.5*this.size[1],h=.8*this.size[1],ctx.font=this.properties.font||(.8*size).toFixed(0)+"px Arial",w=ctx.measureText(this.title).width,w=.5*(this.size[0]-(w+size)),ctx.fillStyle="#AAA",ctx.fillRect(w,h-size,size,size),ctx.fillStyle=this.properties.value?"#AEF":"#000",ctx.fillRect(w+.25*size,h-size+.25*size,.5*size,.5*size),ctx.textAlign="left",ctx.fillStyle="#AAA",ctx.fillText(this.title,1.2*size+w,.85*h),ctx.textAlign="left")}onAction(_action){this.properties.value=!this.properties.value,this.trigger("e",this.properties.value)}onExecute(){var v=this.getInputData(0);null!=v&&(this.properties.value=v),this.setOutputData(0,this.properties.value)}onMouseDown(e,local_pos){if(1<local_pos[0]&&1<local_pos[1]&&local_pos[0]<this.size[0]-2&&local_pos[1]<this.size[1]-2)return this.properties.value=!this.properties.value,this.graph._version++,this.trigger("e",this.properties.value),!0}}LiteGraph.registerNodeType("widget/toggle",WidgetToggle);class WidgetNumber{static title="Number";static desc="Widget to select number value";constructor(){this.addOutput("","number"),this.size=[80,60],this.properties={min:-1e3,max:1e3,value:1,step:1},this.old_y=-1,this._remainder=0,this._precision=0,this.mouse_captured=!1}onDrawForeground(ctx){var x=.5*this.size[0],h=this.size[1];30<h?(ctx.fillStyle=WidgetNumber.markers_color,ctx.beginPath(),ctx.moveTo(x,.1*h),ctx.lineTo(x+.1*h,.2*h),ctx.lineTo(x+-.1*h,.2*h),ctx.fill(),ctx.beginPath(),ctx.moveTo(x,.9*h),ctx.lineTo(x+.1*h,.8*h),ctx.lineTo(x+-.1*h,.8*h),ctx.fill(),ctx.font=(.7*h).toFixed(1)+"px Arial"):ctx.font=(.8*h).toFixed(1)+"px Arial",ctx.textAlign="center",ctx.font=(.7*h).toFixed(1)+"px Arial",ctx.fillStyle="#EEE",ctx.fillText(this.properties.value.toFixed(this._precision),x,.75*h)}onExecute(){this.setOutputData(0,this.properties.value)}onPropertyChanged(_name,_value){var t=(this.properties.step+"").split(".");this._precision=1<t.length?t[1].length:0}onMouseDown(e,pos){if(!(pos[1]<0))return this.old_y=e.canvasY,this.captureInput(!0),this.mouse_captured=!0}onDblClick(e,pos,canvas){return console.warn("onDblClick",...arguments),canvas.showEditPropertyValue(this,"value",{event:e}),this.prevent_up=!0,e.preventDefault(),e.stopPropagation(),!0}onMouseMove(e){var delta;this.mouse_captured&&(delta=this.old_y-e.canvasY,e.shiftKey&&(delta*=10),(e.metaKey||e.altKey)&&(delta*=.1),this.old_y=e.canvasY,e=this._remainder+delta/WidgetNumber.pixels_threshold,this._remainder=e%1,delta=LiteGraph.clamp(this.properties.value+(e|=0)*this.properties.step,this.properties.min,this.properties.max),this.properties.value=delta,this.graph._version++,this.setDirtyCanvas(!0))}onMouseUp(e,pos){this.prevent_up?this.prevent_up=!1:(e.click_time<200&&(e=pos[1]>.5*this.size[1]?-1:1,this.properties.value=LiteGraph.clamp(this.properties.value+e*this.properties.step,this.properties.min,this.properties.max),this.graph._version++,this.setDirtyCanvas(!0)),this.mouse_captured&&(this.mouse_captured=!1,this.captureInput(!1)))}static pixels_threshold=10;static markers_color="#666"}LiteGraph.registerNodeType("widget/number",WidgetNumber);class WidgetCombo{static title="Combo";static desc="Widget to select from a list";constructor(){this.addOutput("","string"),this.addOutput("change",LiteGraph.EVENT),this.size=[80,60],this.properties={value:"A",values:"A;B;C"},this.old_y=-1,this.mouse_captured=!1,this._values=this.properties.values.split(";");var that=this;this.widgets_up=!0,this.widget=this.addWidget("combo","",this.properties.value,function(v){that.properties.value=v,that.triggerSlot(1,v)},{property:"value",values:this._values})}onExecute(){this.setOutputData(0,this.properties.value)}onPropertyChanged(name,value){"values"==name?(this._values=value.split(";"),this.widget.options.values=this._values):"value"==name&&(this.widget.value=value)}}LiteGraph.registerNodeType("widget/combo",WidgetCombo);class WidgetKnob{static title="Knob";static desc="Circular controller";static size=[80,100];constructor(){this.addOutput("","number"),this.size=[64,84],this.properties={min:0,max:1,value:.5,color:"#7AF",precision:2},this.value=-1}onDrawForeground(ctx){var center_x,center_y,radius,angle;this.flags.collapsed||(-1==this.value&&(this.value=(this.properties.value-this.properties.min)/(this.properties.max-this.properties.min)),center_x=.5*this.size[0],center_y=.5*this.size[1],radius=.5*Math.min(this.size[0],this.size[1])-5,ctx.globalAlpha=1,ctx.save(),ctx.translate(center_x,center_y),ctx.rotate(.75*Math.PI),ctx.fillStyle="rgba(0,0,0,0.5)",ctx.beginPath(),ctx.moveTo(0,0),ctx.arc(0,0,radius,0,1.5*Math.PI),ctx.fill(),ctx.strokeStyle="black",ctx.fillStyle=this.properties.color,ctx.lineWidth=2,ctx.beginPath(),ctx.moveTo(0,0),ctx.arc(0,0,radius-4,0,1.5*Math.PI*Math.max(.01,this.value)),ctx.closePath(),ctx.fill(),ctx.lineWidth=1,ctx.globalAlpha=1,ctx.restore(),ctx.fillStyle="black",ctx.beginPath(),ctx.arc(center_x,center_y,.75*radius,0,2*Math.PI,!0),ctx.fill(),ctx.fillStyle=this.mouseOver?"white":this.properties.color,ctx.beginPath(),angle=this.value*Math.PI*1.5+.75*Math.PI,ctx.arc(center_x+Math.cos(angle)*radius*.65,center_y+Math.sin(angle)*radius*.65,.05*radius,0,2*Math.PI,!0),ctx.fill(),ctx.fillStyle=this.mouseOver?"white":"#AAA",ctx.font=Math.floor(.5*radius)+"px Arial",ctx.textAlign="center",ctx.fillText(this.properties.value.toFixed(this.properties.precision),center_x,center_y+.15*radius))}onExecute(){this.setOutputData(0,this.properties.value),this.boxcolor=LiteGraph.colorToString([this.value,this.value,this.value])}onMouseDown(e){return this.center=[.5*this.size[0],.5*this.size[1]+20],this.radius=.5*this.size[0],!(e.canvasY-this.pos[1]<20||LiteGraph.distance([e.canvasX,e.canvasY],[this.pos[0]+this.center[0],this.pos[1]+this.center[1]])>this.radius||(this.oldmouse=[e.canvasX-this.pos[0],e.canvasY-this.pos[1]],this.captureInput(!0),0))}onMouseMove(e){var v;this.oldmouse&&(e=[e.canvasX-this.pos[0],e.canvasY-this.pos[1]],v=this.value,1<(v-=.01*(e[1]-this.oldmouse[1]))?v=1:v<0&&(v=0),this.value=v,this.properties.value=this.properties.min+(this.properties.max-this.properties.min)*this.value,this.oldmouse=e,this.setDirtyCanvas(!0))}onMouseUp(_e){this.oldmouse&&(this.oldmouse=null,this.captureInput(!1))}onPropertyChanged(name,value){if("min"==name||"max"==name||"value"==name)return this.properties[name]=parseFloat(value),!0}}LiteGraph.registerNodeType("widget/knob",WidgetKnob);class WidgetSliderGUI{static title="Inner Slider";constructor(){this.addOutput("","number"),this.properties={value:.5,min:0,max:1,text:"V"};var that=this;this.size=[140,40],this.slider=this.addWidget("slider","V",this.properties.value,function(v){that.properties.value=v},this.properties),this.widgets_up=!0}onPropertyChanged(name,value){"value"==name&&(this.slider.value=value)}onExecute(){this.setOutputData(0,this.properties.value)}}LiteGraph.registerNodeType("widget/internal_slider",WidgetSliderGUI);class WidgetHSlider{static title="H.Slider";static desc="Linear slider controller";constructor(){this.size=[160,26],this.addOutput("","number"),this.properties={color:"#7AF",min:0,max:1,value:.5},this.value=-1}onDrawForeground(ctx){-1==this.value&&(this.value=(this.properties.value-this.properties.min)/(this.properties.max-this.properties.min)),ctx.globalAlpha=1,ctx.lineWidth=1,ctx.fillStyle="#000",ctx.fillRect(2,2,this.size[0]-4,this.size[1]-4),ctx.fillStyle=this.properties.color,ctx.beginPath(),ctx.rect(4,4,(this.size[0]-8)*this.value,this.size[1]-8),ctx.fill()}onExecute(){this.properties.value=this.properties.min+(this.properties.max-this.properties.min)*this.value,this.setOutputData(0,this.properties.value),this.boxcolor=LiteGraph.colorToString([this.value,this.value,this.value])}onMouseDown(e){return!(e.canvasY-this.pos[1]<0||(this.oldmouse=[e.canvasX-this.pos[0],e.canvasY-this.pos[1]],this.captureInput(!0),0))}onMouseMove(e){var v;this.oldmouse&&(e=[e.canvasX-this.pos[0],e.canvasY-this.pos[1]],v=this.value,1<(v+=(e[0]-this.oldmouse[0])/this.size[0])?v=1:v<0&&(v=0),this.value=v,this.oldmouse=e,this.setDirtyCanvas(!0))}onMouseUp(_e){this.oldmouse=null,this.captureInput(!1)}}LiteGraph.registerNodeType("widget/hslider",WidgetHSlider);class WidgetProgress{static title="Progress";static desc="Shows data in linear progress";constructor(){this.size=[160,26],this.addInput("","number"),this.properties={min:0,max:1,value:0,color:"#AAF"}}onExecute(){var v=this.getInputData(0);null!=v&&(this.properties.value=v)}onDrawForeground(ctx){ctx.lineWidth=1,ctx.fillStyle=this.properties.color;var v=(this.properties.value-this.properties.min)/(this.properties.max-this.properties.min),v=Math.min(1,v);v=Math.max(0,v),ctx.fillRect(2,2,(this.size[0]-4)*v,this.size[1]-4)}}LiteGraph.registerNodeType("widget/progress",WidgetProgress);class WidgetText{static title="Text";static desc="Shows the input value";constructor(){this.addInputs("",0),this.properties={value:"...",font:"Arial",fontsize:18,color:"#AAA",align:"left",glowSize:0,decimals:1}}onDrawForeground(ctx){ctx.fillStyle=this.properties.color;var v=this.properties.value,fontsize=(this.properties.glowSize?(ctx.shadowColor=this.properties.color,ctx.shadowOffsetX=0,ctx.shadowOffsetY=0,ctx.shadowBlur=this.properties.glowSize):ctx.shadowColor="transparent",this.properties.fontsize);if(ctx.textAlign=this.properties.align,ctx.font=fontsize.toString()+"px "+this.properties.font,this.str="number"==typeof v?v.toFixed(this.properties.decimals):v,"string"==typeof this.str)for(var lines=this.str.replace(/[\r\n]/g,"\\n").split("\\n"),i=0;i<lines.length;i++)ctx.fillText(lines[i],"left"==this.properties.align?15:this.size[0]-15,-.15*fontsize+fontsize*(parseInt(i)+1));ctx.shadowColor="transparent",(this.last_ctx=ctx).textAlign="left"}onExecute(){var v=this.getInputData(0);null!=v&&(this.properties.value=v)}resize(){if(this.last_ctx){for(var lines=this.str.split("\\n"),max=(this.last_ctx.font=this.properties.fontsize+"px "+this.properties.font,0),i=0;i<lines.length;i++){var w=this.last_ctx.measureText(lines[i]).width;max<w&&(max=w)}this.size[0]=max+20,this.size[1]=4+lines.length*this.properties.fontsize,this.setDirtyCanvas(!0)}}onPropertyChanged(name,value){return this.properties[name]=value,this.str="number"==typeof value?value.toFixed(3):value,!0}static widgets=[{name:"resize",text:"Resize box",type:"button"},{name:"led_text",text:"LED",type:"minibutton"},{name:"normal_text",text:"Normal",type:"minibutton"}]}LiteGraph.registerNodeType("widget/text",WidgetText);class WidgetPanel{static title="Panel";static desc="Non interactive panel";constructor(){this.size=[200,100],this.properties={borderColor:"#ffffff",bgcolorTop:"#f0f0f0",bgcolorBottom:"#e0e0e0",shadowSize:2,borderRadius:3}}createGradient(ctx){""==this.properties.bgcolorTop||""==this.properties.bgcolorBottom?this.lineargradient=0:(this.lineargradient=ctx.createLinearGradient(0,0,0,this.size[1]),this.lineargradient.addColorStop(0,this.properties.bgcolorTop),this.lineargradient.addColorStop(1,this.properties.bgcolorBottom))}onDrawForeground(ctx){this.flags.collapsed||(null==this.lineargradient&&this.createGradient(ctx),this.lineargradient&&(ctx.lineWidth=1,ctx.strokeStyle=this.properties.borderColor,ctx.fillStyle=this.lineargradient,this.properties.shadowSize?(ctx.shadowColor="#000",ctx.shadowOffsetX=0,ctx.shadowOffsetY=0,ctx.shadowBlur=this.properties.shadowSize):ctx.shadowColor="transparent",ctx.roundRect(0,0,this.size[0]-1,this.size[1]-1,this.properties.shadowSize),ctx.fill(),ctx.shadowColor="transparent",ctx.stroke()))}widgets=[{name:"update",text:"Update",type:"button"}]}LiteGraph.registerNodeType("widget/panel",WidgetPanel);class GamepadInput{static title="Gamepad";static desc="gets the input of the gamepad";constructor(){this.addOutput("left_x_axis","number"),this.addOutput("left_y_axis","number"),this.addOutput("button_pressed",LiteGraph.EVENT),this.properties={gamepad_index:0,threshold:.1},this._left_axis=new Float32Array(2),this._right_axis=new Float32Array(2),this._triggers=new Float32Array(2),this._previous_buttons=new Uint8Array(17),this._current_buttons=new Uint8Array(17)}onExecute(){var gamepad=this.getGamepad(),threshold=this.properties.threshold||0;if(gamepad&&(this._left_axis[0]=Math.abs(gamepad.xbox.axes.lx)>threshold?gamepad.xbox.axes.lx:0,this._left_axis[1]=Math.abs(gamepad.xbox.axes.ly)>threshold?gamepad.xbox.axes.ly:0,this._right_axis[0]=Math.abs(gamepad.xbox.axes.rx)>threshold?gamepad.xbox.axes.rx:0,this._right_axis[1]=Math.abs(gamepad.xbox.axes.ry)>threshold?gamepad.xbox.axes.ry:0,this._triggers[0]=Math.abs(gamepad.xbox.axes.ltrigger)>threshold?gamepad.xbox.axes.ltrigger:0,this._triggers[1]=Math.abs(gamepad.xbox.axes.rtrigger)>threshold?gamepad.xbox.axes.rtrigger:0),this.outputs)for(var i=0;i<this.outputs.length;i++){var output=this.outputs[i];if(output.links&&output.links.length){var v=null;if(gamepad)switch(output.name){case"left_axis":v=this._left_axis;break;case"right_axis":v=this._right_axis;break;case"left_x_axis":v=this._left_axis[0];break;case"left_y_axis":v=this._left_axis[1];break;case"right_x_axis":v=this._right_axis[0];break;case"right_y_axis":v=this._right_axis[1];break;case"trigger_left":v=this._triggers[0];break;case"trigger_right":v=this._triggers[1];break;case"a_button":v=gamepad.xbox.buttons.a?1:0;break;case"b_button":v=gamepad.xbox.buttons.b?1:0;break;case"x_button":v=gamepad.xbox.buttons.x?1:0;break;case"y_button":v=gamepad.xbox.buttons.y?1:0;break;case"lb_button":v=gamepad.xbox.buttons.lb?1:0;break;case"rb_button":v=gamepad.xbox.buttons.rb?1:0;break;case"ls_button":v=gamepad.xbox.buttons.ls?1:0;break;case"rs_button":v=gamepad.xbox.buttons.rs?1:0;break;case"hat_left":v=gamepad.xbox.hatmap&GamepadInput.LEFT;break;case"hat_right":v=gamepad.xbox.hatmap&GamepadInput.RIGHT;break;case"hat_up":v=gamepad.xbox.hatmap&GamepadInput.UP;break;case"hat_down":v=gamepad.xbox.hatmap&GamepadInput.DOWN;break;case"hat":v=gamepad.xbox.hatmap;break;case"start_button":v=gamepad.xbox.buttons.start?1:0;break;case"back_button":v=gamepad.xbox.buttons.back?1:0;break;case"button_pressed":for(var j=0;j<this._current_buttons.length;++j)this._current_buttons[j]&&!this._previous_buttons[j]&&this.triggerSlot(i,GamepadInput.buttons[j])}else switch(output.name){case"button_pressed":break;case"left_axis":case"right_axis":v=GamepadInput.zero;break;default:v=0}this.setOutputData(i,v)}}}getGamepad(){var getGamepads=navigator.getGamepads||navigator.webkitGetGamepads||navigator.mozGetGamepads;if(!getGamepads)return null;var gamepads=getGamepads.call(navigator),gamepad=null;this._previous_buttons.set(this._current_buttons);for(var i=this.properties.gamepad_index;i<4;i++)if(gamepads[i]){var gamepad=gamepads[i],xbox=this.xbox_mapping;(xbox=xbox||(this.xbox_mapping={axes:[],buttons:{},hat:"",hatmap:GamepadInput.CENTER})).axes.lx=gamepad.axes[0],xbox.axes.ly=gamepad.axes[1],xbox.axes.rx=gamepad.axes[2],xbox.axes.ry=gamepad.axes[3],xbox.axes.ltrigger=gamepad.buttons[6].value,xbox.axes.rtrigger=gamepad.buttons[7].value,xbox.hat="",xbox.hatmap=GamepadInput.CENTER;for(var j=0;j<gamepad.buttons.length;j++)if(this._current_buttons[j]=gamepad.buttons[j].pressed,j<12)xbox.buttons[GamepadInput.mapping_array[j]]=gamepad.buttons[j].pressed,gamepad.buttons[j].was_pressed&&this.trigger(GamepadInput.mapping_array[j]+"_button_event");else switch(j){case 12:gamepad.buttons[j].pressed&&(xbox.hat+="up",xbox.hatmap|=GamepadInput.UP);break;case 13:gamepad.buttons[j].pressed&&(xbox.hat+="down",xbox.hatmap|=GamepadInput.DOWN);break;case 14:gamepad.buttons[j].pressed&&(xbox.hat+="left",xbox.hatmap|=GamepadInput.LEFT);break;case 15:gamepad.buttons[j].pressed&&(xbox.hat+="right",xbox.hatmap|=GamepadInput.RIGHT);break;case 16:xbox.buttons.home=gamepad.buttons[j].pressed}return gamepad.xbox=xbox,gamepad}}onDrawBackground(ctx){if(!this.flags.collapsed){var la=this._left_axis,ra=this._right_axis,h=(ctx.strokeStyle="#88A",ctx.strokeRect(.5*(la[0]+1)*this.size[0]-4,.5*(la[1]+1)*this.size[1]-4,8,8),ctx.strokeStyle="#8A8",ctx.strokeRect(.5*(ra[0]+1)*this.size[0]-4,.5*(ra[1]+1)*this.size[1]-4,8,8),this.size[1]/this._current_buttons.length);ctx.fillStyle="#AEB";for(var i=0;i<this._current_buttons.length;++i)this._current_buttons[i]&&ctx.fillRect(0,h*i,6,h)}}onGetOutputs(){return[["left_axis","vec2"],["right_axis","vec2"],["left_x_axis","number"],["left_y_axis","number"],["right_x_axis","number"],["right_y_axis","number"],["trigger_left","number"],["trigger_right","number"],["a_button","number"],["b_button","number"],["x_button","number"],["y_button","number"],["lb_button","number"],["rb_button","number"],["ls_button","number"],["rs_button","number"],["start_button","number"],["back_button","number"],["a_button_event",LiteGraph.EVENT],["b_button_event",LiteGraph.EVENT],["x_button_event",LiteGraph.EVENT],["y_button_event",LiteGraph.EVENT],["lb_button_event",LiteGraph.EVENT],["rb_button_event",LiteGraph.EVENT],["ls_button_event",LiteGraph.EVENT],["rs_button_event",LiteGraph.EVENT],["start_button_event",LiteGraph.EVENT],["back_button_event",LiteGraph.EVENT],["hat_left","number"],["hat_right","number"],["hat_up","number"],["hat_down","number"],["hat","number"],["button_pressed",LiteGraph.EVENT]]}static zero=new Float32Array(2);static buttons=["a","b","x","y","lb","rb","lt","rt","back","start","ls","rs","home"];static mapping={a:0,b:1,x:2,y:3,lb:4,rb:5,lt:6,rt:7,back:8,start:9,ls:10,rs:11};static mapping_array=["a","b","x","y","lb","rb","lt","rt","back","start","ls","rs"]}GamepadInput.CENTER=0,GamepadInput.LEFT=1,GamepadInput.RIGHT=2,GamepadInput.UP=4,GamepadInput.DOWN=8,LiteGraph.registerNodeType("input/gamepad",GamepadInput);class Converter{static title="Converter";static desc="type A to type B";constructor(){this.addInput("in",0),this.addOutput("out",0),this.size=[80,30]}onExecute(){var v=this.getInputData(0);if(null!=v&&this.outputs)for(var i=0;i<this.outputs.length;i++){var output=this.outputs[i];if(output.links&&output.links.length){var result=null;switch(output.name){case"number":result=v.length?v[0]:parseFloat(v);break;case"vec2":case"vec3":case"vec4":var result=null,count=1;switch(output.name){case"vec2":count=2;break;case"vec3":count=3;break;case"vec4":count=4}if(result=new Float32Array(count),v.length)for(var j=0;j<v.length&&j<result.length;j++)result[j]=v[j];else result[0]=parseFloat(v)}this.setOutputData(i,result)}}}onGetOutputs(){return[["number","number"],["vec2","vec2"],["vec3","vec3"],["vec4","vec4"]]}}LiteGraph.registerNodeType("math/converter",Converter);class Bypass{static title="Bypass";static desc="removes the type";constructor(){this.addInput("in"),this.addOutput("out"),this.size=[80,30]}onExecute(){var v=this.getInputData(0);this.setOutputData(0,v)}}LiteGraph.registerNodeType("math/bypass",Bypass);class ToNumber{static title="to Number";static desc="Cast to number";constructor(){this.addInput("in"),this.addOutput("out")}onExecute(){var v=this.getInputData(0);this.setOutputData(0,Number(v))}}LiteGraph.registerNodeType("math/to_number",ToNumber);class MathRange{static title="Range";static desc="Convert a number from one range to another";constructor(){this.addInput("in","number",{locked:!0}),this.addOutput("out","number",{locked:!0}),this.addOutput("clamped","number",{locked:!0}),this.addProperty("in",0),this.addProperty("in_min",0),this.addProperty("in_max",1),this.addProperty("out_min",0),this.addProperty("out_max",1),this.size=[120,50]}getTitle(){return this.flags?.collapsed?(this._last_v||0).toFixed(2):this.title}onExecute(){let v;if(this.inputs)for(let i=0;i<this.inputs.length;i++){var input=this.inputs[i];void 0!==(v=this.getInputData(i))&&(this.properties[input.name]=v)}void 0!==(v=this.properties.in)&&null!==v&&v.constructor===Number||(v=0);var in_min=this.properties.in_min,in_max=this.properties.in_max,out_min=this.properties.out_min,out_max=this.properties.out_max;this._last_v=(v-in_min)/(in_max-in_min)*(out_max-out_min)+out_min,this.setOutputData(0,this._last_v),this.setOutputData(1,LiteGraph.clamp(this._last_v,out_min,out_max))}onDrawBackground(_ctx){this._last_v?this.outputs[0].label=this._last_v.toFixed(3):this.outputs[0].label="?"}onGetInputs(){return[["in_min","number"],["in_max","number"],["out_min","number"],["out_max","number"]]}}LiteGraph.registerNodeType("math/range",MathRange);class MathRand{static title="Rand";static desc="Random number";constructor(){this.addOutput("value","number"),this.addProperty("min",0),this.addProperty("max",1),this.size=[80,30]}onExecute(){if(this.inputs)for(var i=0;i<this.inputs.length;i++){var input=this.inputs[i],v=this.getInputData(i);void 0!==v&&(this.properties[input.name]=v)}var min=this.properties.min,max=this.properties.max;this._last_v=Math.random()*(max-min)+min,this.setOutputData(0,this._last_v)}onDrawBackground(_ctx){this.outputs[0].label=(this._last_v||0).toFixed(3)}onGetInputs(){return[["min","number"],["max","number"]]}}LiteGraph.registerNodeType("math/rand",MathRand);class MathNoise{static title="Noise";static desc="Random number with temporal continuity";constructor(){this.addInput("in","number"),this.addOutput("out","number"),this.addProperty("min",0),this.addProperty("max",1),this.addProperty("smooth",!0),this.addProperty("seed",0),this.addProperty("octaves",1),this.addProperty("persistence",.8),this.addProperty("speed",1),this.size=[90,30]}static getValue(f,smooth){if(!MathNoise.data){MathNoise.data=new Float32Array(1024);for(var i=0;i<MathNoise.data.length;++i)MathNoise.data[i]=Math.random()}(f%=1024)<0&&(f+=1024);var f_min=Math.floor(f);return f-=f_min,MathNoise.data[f_min]*(1-(f=smooth?f*f*f*(f*(6*f-15)+10):f))+MathNoise.data[1023==f_min?0:f_min+1]*f}onExecute(){for(var f=this.getInputData(0)||0,iterations=this.properties.octaves||1,r=0,amp=1,speed=(f+=this.properties.seed||0,this.properties.speed||1),total_amp=0,i=0;i<iterations&&(r+=MathNoise.getValue(f*(1+i)*speed,this.properties.smooth)*amp,total_amp+=amp,!((amp*=this.properties.persistence)<.001));++i);var min=this.properties.min,max=this.properties.max;this._last_v=(r/=total_amp)*(max-min)+min,this.setOutputData(0,this._last_v)}onDrawBackground(_ctx){this.outputs[0].label=(this._last_v||0).toFixed(3)}static data=null}LiteGraph.registerNodeType("math/noise",MathNoise);class MathSpikes{constructor(){this.addOutput("out","number"),this.addProperty("min_time",1),this.addProperty("max_time",2),this.addProperty("duration",.2),this.size=[90,30],this._remaining_time=0,this._blink_time=0}onExecute(){var f,dt=this.graph.elapsed_time,dt=(this._remaining_time-=dt,this._blink_time-=dt,0);0<this._blink_time&&(f=this._blink_time/this.properties.duration,dt=1/(Math.pow(8*f-4,4)+1)),this._remaining_time<0?(this._remaining_time=Math.random()*(this.properties.max_time-this.properties.min_time)+this.properties.min_time,this._blink_time=this.properties.duration,this.boxcolor="#FFF"):this.boxcolor="#000",this.setOutputData(0,dt)}}LiteGraph.registerNodeType("math/spikes",MathSpikes);class MathClamp{static title="Clamp";static desc="Clamp number between min and max";constructor(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30],this.addProperty("min",0),this.addProperty("max",1)}onExecute(){var v=this.getInputData(0);null!=v&&(v=Math.max(this.properties.min,v),v=Math.min(this.properties.max,v),this.setOutputData(0,v))}getCode(){var code="";return this.isInputConnected(0)&&(code+="clamp({{0}},"+this.properties.min+","+this.properties.max+")"),code}}LiteGraph.registerNodeType("math/clamp",MathClamp);class MathLerp{static title="Lerp";static desc="Linear Interpolation";constructor(){this.properties={f:.5},this.addInput("A","number"),this.addInput("B","number"),this.addOutput("out","number")}onExecute(){var v1=this.getInputData(0),v2=(null==v1&&(v1=0),this.getInputData(1)),f=(null==v2&&(v2=0),this.properties.f),_f=this.getInputData(2);this.setOutputData(0,v1*(1-(f=void 0!==_f?_f:f))+v2*f)}onGetInputs(){return[["f","number"]]}}LiteGraph.registerNodeType("math/lerp",MathLerp);class MathAbs{static title="Abs";static desc="Absolute";constructor(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30]}onExecute(){var v=this.getInputData(0);null!=v&&this.setOutputData(0,Math.abs(v))}}LiteGraph.registerNodeType("math/abs",MathAbs);class MathFloor{static title="Floor";static desc="Floor number to remove fractional part";constructor(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30]}onExecute(){var v=this.getInputData(0);null!=v&&this.setOutputData(0,Math.floor(v))}}LiteGraph.registerNodeType("math/floor",MathFloor);class MathFrac{static title="Frac";static desc="Returns fractional part";constructor(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30]}onExecute(){var v=this.getInputData(0);null!=v&&this.setOutputData(0,v%1)}}LiteGraph.registerNodeType("math/frac",MathFrac);class MathSmoothStep{static title="Smoothstep";static desc="Smoothstep";constructor(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30],this.properties={A:0,B:1}}onExecute(){var edge0,edge1,v=this.getInputData(0);void 0!==v&&(edge0=this.properties.A,edge1=this.properties.B,v=LiteGraph.clamp((v-edge0)/(edge1-edge0),0,1),this.setOutputData(0,v=v*v*(3-2*v)))}}LiteGraph.registerNodeType("math/smoothstep",MathSmoothStep);class MathScale{static title="Scale";static desc="v * factor";constructor(){this.addInput("in","number",{label:""}),this.addOutput("out","number",{label:""}),this.size=[80,30],this.addProperty("factor",1)}onExecute(){var value=this.getInputData(0);null!=value&&this.setOutputData(0,value*this.properties.factor)}}LiteGraph.registerNodeType("math/scale",MathScale);class Gate{static title="Gate";static desc="if v is true, then outputs A, otherwise B";constructor(){this.addInput("v","boolean"),this.addInput("A"),this.addInput("B"),this.addOutput("out")}onExecute(){var v=this.getInputData(0);this.setOutputData(0,this.getInputData(v?1:2))}}LiteGraph.registerNodeType("math/gate",Gate);class MathAverageFilter{static title="Average";static desc="Average Filter";constructor(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30],this.addProperty("samples",10),this._values=new Float32Array(10),this._current=0}onExecute(){for(var v=this.getInputData(0),num_samples=this._values.length,avr=(this._values[this._current%num_samples]=v=null==v?0:v,this._current+=1,this._current>num_samples&&(this._current=0),0),i=0;i<num_samples;++i)avr+=this._values[i];this.setOutputData(0,avr/num_samples)}onPropertyChanged(name,value){value<1&&(value=1),"formula"==name&&(this.code_widget.value=value),this.properties.samples=Math.round(value);name=this._values;this._values=new Float32Array(this.properties.samples),name.length<=this._values.length?this._values.set(name):this._values.set(name.subarray(0,this._values.length))}}LiteGraph.registerNodeType("math/average",MathAverageFilter);class MathTendTo{static title="TendTo";static desc="moves the output value always closer to the input";constructor(){this.addInput("in","number"),this.addOutput("out","number"),this.addProperty("factor",.1),this.size=[80,30],this._value=null}onExecute(){var v=this.getInputData(0),f=(null==v&&(v=0),this.properties.factor);null==this._value?this._value=v:this._value=this._value*(1-f)+v*f,this.setOutputData(0,this._value)}}LiteGraph.registerNodeType("math/tendTo",MathTendTo);class MathOperation{static title="Operation";static desc="Easy math operators";constructor(){this.addInput("A","number,array,object"),this.addInput("B","number"),this.addOutput("=","number"),this.addProperty("A",1),this.addProperty("B",1),this.addProperty("OP","+","enum",{values:MathOperation.values}),this._func=MathOperation.funcs[this.properties.OP],this._result=[]}getTitle(){return"max"==this.properties.OP||"min"==this.properties.OP?this.properties.OP+"(A,B)":"A "+this.properties.OP+" B"}setValue(v){"string"==typeof v&&(v=parseFloat(v)),this.properties.value=v}onPropertyChanged(name,_value){"OP"!=name||(this._func=MathOperation.funcs[this.properties.OP],this._func)||(console.warn?.("Unknown operation: "+this.properties.OP),this._func=function(A){return A})}onExecute(){var result,A=this.getInputData(0),B=this.getInputData(1),func=(null!=A?A.constructor===Number&&(this.properties.A=A):A=this.properties.A,null!=B?this.properties.B=B:B=this.properties.B,MathOperation.funcs[this.properties.OP]);if(A.constructor===Number)result=0,result=func(A,B);else if(A.constructor===Array){(result=this._result).length=A.length;for(let i=0;i<A.length;++i)result[i]=func(A[i],B)}else for(var i in result={},A)result[i]=func(A[i],B);this.setOutputData(0,result)}onDrawBackground(ctx){this.flags?.collapsed||(ctx.font="36px Arial",ctx.fillStyle="#666",ctx.textAlign="center",ctx.fillText(this.properties.OP,.5*this.size[0],.5*(this.size[1]+LiteGraph.NODE_TITLE_HEIGHT)),ctx.textAlign="left")}static values=["+","-","*","/","%","^","max","min"];static funcs={"+":function(A,B){return A+B},"-":function(A,B){return A-B},x:function(A,B){return A*B},X:function(A,B){return A*B},"*":function(A,B){return A*B},"/":function(A,B){return A/B},"%":function(A,B){return A%B},"^":function(A,B){return Math.pow(A,B)},max:function(A,B){return Math.max(A,B)},min:function(A,B){return Math.min(A,B)}};static"@OP"={type:"enum",title:"operation",values:MathOperation.values}}LiteGraph.registerNodeType("math/operation",MathOperation),LiteGraph.registerSearchboxExtra("math/operation","MAX",{properties:{OP:"max"},title:"MAX()"}),LiteGraph.registerSearchboxExtra("math/operation","MIN",{properties:{OP:"min"},title:"MIN()"});class MathCompare{static title="Compare";static desc="compares between two values";constructor(){this.addInput("A","number"),this.addInput("B","number"),this.addOutput("A==B","boolean"),this.addOutput("A!=B","boolean"),this.addProperty("A",0),this.addProperty("B",0)}onExecute(){var A=Number(this.getInputOrProperty("A")),B=Number(this.getInputOrProperty("B"));this.setProperty("A",A),this.setProperty("B",B);for(var i=0,l=this.outputs.length;i<l;++i){var value,output=this.outputs[i];if(output.links&&output.links.length){switch(output.name){case"A==B":value=A==B;break;case"A!=B":value=A!=B;break;case"A>B":value=B<A;break;case"A<B":value=A<B;break;case"A<=B":value=A<=B;break;case"A>=B":value=B<=A}this.setOutputData(i,value)}}}onGetOutputs(){return[["A==B","boolean"],["A!=B","boolean"],["A>B","boolean"],["A<B","boolean"],["A>=B","boolean"],["A<=B","boolean"]]}}LiteGraph.registerNodeType("math/compare",MathCompare),LiteGraph.registerSearchboxExtra("math/compare","==",{outputs:[["A==B","boolean"]],title:"A==B"}),LiteGraph.registerSearchboxExtra("math/compare","!=",{outputs:[["A!=B","boolean"]],title:"A!=B"}),LiteGraph.registerSearchboxExtra("math/compare",">",{outputs:[["A>B","boolean"]],title:"A>B"}),LiteGraph.registerSearchboxExtra("math/compare","<",{outputs:[["A<B","boolean"]],title:"A<B"}),LiteGraph.registerSearchboxExtra("math/compare",">=",{outputs:[["A>=B","boolean"]],title:"A>=B"}),LiteGraph.registerSearchboxExtra("math/compare","<=",{outputs:[["A<=B","boolean"]],title:"A<=B"});class MathCondition{static title="Condition";static desc="evaluates condition between A and B";constructor(){this.addInput("A","number"),this.addInput("B","number"),this.addOutput("true","boolean"),this.addOutput("false","boolean"),this.addProperty("A",1),this.addProperty("B",1),this.addProperty("OP",">","enum",{values:MathCondition.values}),this.addWidget("combo","Cond.",this.properties.OP,{property:"OP",values:MathCondition.values}),this.size=[80,60]}getTitle(){return"A "+this.properties.OP+" B"}onExecute(){var A=this.getInputData(0),B=(void 0===A?A=this.properties.A:this.properties.A=A,this.getInputData(1)),result=(void 0===B?B=this.properties.B:this.properties.B=B,!0);switch(this.properties.OP){case">":result=B<A;break;case"<":result=A<B;break;case"==":result=A==B;break;case"!=":result=A!=B;break;case"<=":result=A<=B;break;case">=":result=B<=A;break;case"||":result=A||B;break;case"&&":result=A&&B}this.setOutputData(0,result),this.setOutputData(1,!result)}static values=[">","<","==","!=","<=",">=","||","&&"];static"@OP"={type:"enum",title:"operation",values:MathCondition.values}}LiteGraph.registerNodeType("math/condition",MathCondition);class MathBranch{static title="Branch";static desc="If condition is true, outputs IN in true, otherwise in false";constructor(){this.addInput("in",0),this.addInput("cond","boolean"),this.addOutput("true",0),this.addOutput("false",0),this.size=[80,60]}onExecute(){var V=this.getInputData(0);this.getInputData(1)?(this.setOutputData(0,V),this.setOutputData(1,null)):(this.setOutputData(0,null),this.setOutputData(1,V))}}LiteGraph.registerNodeType("math/branch",MathBranch);class MathAccumulate{static title="Accumulate";static desc="Increments a value every time";constructor(){this.addInput("inc","number"),this.addOutput("total","number"),this.addProperty("increment",1),this.addProperty("value",0)}onExecute(){null===this.properties.value&&(this.properties.value=0);var inc=this.getInputData(0);this.properties.value+=null!==inc?inc:this.properties.increment,this.setOutputData(0,this.properties.value)}}LiteGraph.registerNodeType("math/accumulate",MathAccumulate);class MathTrigonometry{static title="Trigonometry";static desc="Sin Cos Tan";constructor(){this.addInput("v","number"),this.addOutput("sin","number"),this.addProperty("amplitude",1),this.addProperty("offset",0),this.bgImageUrl="nodes/imgs/icon-sin.png"}onExecute(){var v=this.getInputData(0),amplitude=(null==v&&(v=0),this.properties.amplitude),slot=this.findInputSlot("amplitude"),offset=(-1!=slot&&(amplitude=this.getInputData(slot)),this.properties.offset);-1!=(slot=this.findInputSlot("offset"))&&(offset=this.getInputData(slot));for(var value,i=0,l=this.outputs.length;i<l;++i){switch(this.outputs[i].name){case"sin":value=Math.sin(v);break;case"cos":value=Math.cos(v);break;case"tan":value=Math.tan(v);break;case"asin":value=Math.asin(v);break;case"acos":value=Math.acos(v);break;case"atan":value=Math.atan(v)}this.setOutputData(i,amplitude*value+offset)}}onGetInputs(){return[["v","number"],["amplitude","number"],["offset","number"]]}onGetOutputs(){return[["sin","number"],["cos","number"],["tan","number"],["asin","number"],["acos","number"],["atan","number"]]}}LiteGraph.registerNodeType("math/trigonometry",MathTrigonometry),LiteGraph.registerSearchboxExtra("math/trigonometry","SIN()",{outputs:[["sin","number"]],title:"SIN()"}),LiteGraph.registerSearchboxExtra("math/trigonometry","COS()",{outputs:[["cos","number"]],title:"COS()"}),LiteGraph.registerSearchboxExtra("math/trigonometry","TAN()",{outputs:[["tan","number"]],title:"TAN()"});class MathFormula{static title="Formula";static desc="Compute formula";constructor(){this.addInput("x","number"),this.addInput("y","number"),this.addOutput("","number"),this.properties={x:1,y:1,formula:"x+y"},this.code_widget=this.addWidget("text","F(x,y)",this.properties.formula,function(v,canvas,node){node.properties.formula=v}),this.addWidget("toggle","allow",LiteGraph.allow_scripts,function(v){LiteGraph.allow_scripts=v}),this._func=null}onExecute(){if(LiteGraph.allow_scripts){var value,x=this.getInputData(0),y=this.getInputData(1);null!=x?this.properties.x=x:x=this.properties.x,null!=y?this.properties.y=y:y=this.properties.y;try{this._func&&this._func_code==this.properties.formula||(this._func=new Function("x","y","TIME","return "+this.properties.formula),this._func_code=this.properties.formula),value=this._func(x,y,this.graph.globaltime),this.boxcolor=null}catch(err){this.boxcolor="red"}this.setOutputData(0,value)}}getTitle(){return this._func_code||"Formula"}onDrawBackground(){var f=this.properties.formula;this.outputs&&this.outputs.length&&(this.outputs[0].label=f)}static size=[160,100]}LiteGraph.registerNodeType("math/formula",MathFormula);class Math3DVec2ToXY{static title="Vec2->XY";static desc="vector 2 to components";constructor(){this.addInput("vec2","vec2"),this.addOutput("x","number"),this.addOutput("y","number")}onExecute(){var v=this.getInputData(0);null!=v&&(this.setOutputData(0,v[0]),this.setOutputData(1,v[1]))}}LiteGraph.registerNodeType("math3d/vec2-to-xy",Math3DVec2ToXY);class Math3DXYToVec2{static title="XY->Vec2";static desc="components to vector2";constructor(){this.addInputs([["x","number"],["y","number"]]),this.addOutput("vec2","vec2"),this.properties={x:0,y:0},this._data=new Float32Array(2)}onExecute(){var x=this.getInputData(0),y=(null==x&&(x=this.properties.x),this.getInputData(1)),data=(null==y&&(y=this.properties.y),this._data);data[0]=x,data[1]=y,this.setOutputData(0,data)}}LiteGraph.registerNodeType("math3d/xy-to-vec2",Math3DXYToVec2);class Math3DVec3ToXYZ{static title="Vec3->XYZ";static desc="vector 3 to components";constructor(){this.addInput("vec3","vec3"),this.addOutput("x","number"),this.addOutput("y","number"),this.addOutput("z","number")}onExecute(){var v=this.getInputData(0);null!=v&&(this.setOutputData(0,v[0]),this.setOutputData(1,v[1]),this.setOutputData(2,v[2]))}}LiteGraph.registerNodeType("math3d/vec3-to-xyz",Math3DVec3ToXYZ);class Math3DXYZToVec3{static title="XYZ->Vec3";static desc="components to vector3";constructor(){this.addInputs([["x","number"],["y","number"],["z","number"]]),this.addOutput("vec3","vec3"),this.properties={x:0,y:0,z:0},this._data=new Float32Array(3)}onExecute(){var x=this.getInputData(0),y=(null==x&&(x=this.properties.x),this.getInputData(1)),z=(null==y&&(y=this.properties.y),this.getInputData(2)),data=(null==z&&(z=this.properties.z),this._data);data[0]=x,data[1]=y,data[2]=z,this.setOutputData(0,data)}}LiteGraph.registerNodeType("math3d/xyz-to-vec3",Math3DXYZToVec3);class Math3DVec4ToXYZW{static title="Vec4->XYZW";static desc="vector 4 to components";constructor(){this.addInput("vec4","vec4"),this.addOutput("x","number"),this.addOutput("y","number"),this.addOutput("z","number"),this.addOutput("w","number")}onExecute(){var v=this.getInputData(0);null!=v&&(this.setOutputData(0,v[0]),this.setOutputData(1,v[1]),this.setOutputData(2,v[2]),this.setOutputData(3,v[3]))}}LiteGraph.registerNodeType("math3d/vec4-to-xyzw",Math3DVec4ToXYZW);class Math3DXYZWToVec4{static title="XYZW->Vec4";static desc="components to vector4";constructor(){this.addInputs([["x","number"],["y","number"],["z","number"],["w","number"]]),this.addOutput("vec4","vec4"),this.properties={x:0,y:0,z:0,w:0},this._data=new Float32Array(4)}onExecute(){var x=this.getInputData(0),y=(null==x&&(x=this.properties.x),this.getInputData(1)),z=(null==y&&(y=this.properties.y),this.getInputData(2)),w=(null==z&&(z=this.properties.z),this.getInputData(3)),data=(null==w&&(w=this.properties.w),this._data);data[0]=x,data[1]=y,data[2]=z,data[3]=w,this.setOutputData(0,data)}}LiteGraph.registerNodeType("math3d/xyzw-to-vec4",Math3DXYZWToVec4);class Math3DMat4{static title="mat4";DEG2RAD=.0174532925;constructor(){this.addInput("T","vec3"),this.addInput("R","vec3"),this.addInput("S","vec3"),this.addOutput("mat4","mat4"),this.properties={T:[0,0,0],R:[0,0,0],S:[1,1,1],R_in_degrees:!0},this._result=mat4.create(),this._must_update=!0}onPropertyChanged(_name,_value){this._must_update=!0}onExecute(){var M=this._result,Q=Math3DMat4.temp_quat,temp_mat4=Math3DMat4.temp_mat4,temp_vec3=Math3DMat4.temp_vec3,T=this.getInputData(0),R=this.getInputData(1),S=this.getInputData(2);(this._must_update||T||R||S)&&(T=T||this.properties.T,R=R||this.properties.R,S=S||this.properties.S,mat4.identity(M),mat4.translate(M,M,T),this.properties.R_in_degrees?(temp_vec3.set(R),vec3.scale(temp_vec3,temp_vec3,this.DEG2RAD),quat.fromEuler(Q,temp_vec3)):quat.fromEuler(Q,R),mat4.fromQuat(temp_mat4,Q),mat4.multiply(M,M,temp_mat4),mat4.scale(M,M,S)),this.setOutputData(0,M)}static temp_quat=new Float32Array([0,0,0,1]);static temp_mat4=new Float32Array(16);static temp_vec3=new Float32Array(3)}LiteGraph.registerNodeType("math3d/mat4",Math3DMat4);class Math3DOperation{static title="Operation";static desc="Easy math 3D operators";constructor(){this.addInput("A","number,vec3"),this.addInput("B","number,vec3"),this.addOutput("=","number,vec3"),this.addProperty("OP","+","enum",{values:Math3DOperation.values}),this._result=vec3.create()}getTitle(){return"max"==this.properties.OP||"min"==this.properties.OP?this.properties.OP+"(A,B)":"A "+this.properties.OP+" B"}onExecute(){var A=this.getInputData(0),B=this.getInputData(1);if(null!=A&&null!=B){A.constructor===Number&&(A=[A,A,A]),B.constructor===Number&&(B=[B,B,B]);var result=this._result;switch(this.properties.OP){case"+":result=vec3.add(result,A,B);break;case"-":result=vec3.sub(result,A,B);break;case"x":case"X":case"*":result=vec3.mul(result,A,B);break;case"/":result=vec3.div(result,A,B);break;case"%":result[0]=A[0]%B[0],result[1]=A[1]%B[1],result[2]=A[2]%B[2];break;case"^":result[0]=Math.pow(A[0],B[0]),result[1]=Math.pow(A[1],B[1]),result[2]=Math.pow(A[2],B[2]);break;case"max":result[0]=Math.max(A[0],B[0]),result[1]=Math.max(A[1],B[1]),result[2]=Math.max(A[2],B[2]);break;case"min":result[0]=Math.min(A[0],B[0]),result[1]=Math.min(A[1],B[1]),result[2]=Math.min(A[2],B[2]);break;case"dot":result=vec3.dot(A,B);break;case"cross":vec3.cross(result,A,B);break;default:console.warn?.("Unknown operation: "+this.properties.OP)}this.setOutputData(0,result)}}onDrawBackground(ctx){this.flags.collapsed||(ctx.font="40px Arial",ctx.fillStyle="#666",ctx.textAlign="center",ctx.fillText(this.properties.OP,.5*this.size[0],.5*(this.size[1]+LiteGraph.NODE_TITLE_HEIGHT)),ctx.textAlign="left")}static values=["+","-","*","/","%","^","max","min","dot","cross"];static"@OP"={type:"enum",title:"operation",values:Math3DOperation.values};static size=[100,60]}LiteGraph.registerSearchboxExtra("math3d/operation","CROSS()",{properties:{OP:"cross"},title:"CROSS()"}),LiteGraph.registerSearchboxExtra("math3d/operation","DOT()",{properties:{OP:"dot"},title:"DOT()"}),LiteGraph.registerNodeType("math3d/operation",Math3DOperation);class Math3DVec3Scale{static title="vec3_scale";static desc="scales the components of a vec3";constructor(){this.addInput("in","vec3"),this.addInput("f","number"),this.addOutput("out","vec3"),this.properties={f:1},this._data=new Float32Array(3)}onExecute(){var f,data,v=this.getInputData(0);null!=v&&(null==(f=this.getInputData(1))&&(f=this.properties.f),(data=this._data)[0]=v[0]*f,data[1]=v[1]*f,data[2]=v[2]*f,this.setOutputData(0,data))}}LiteGraph.registerNodeType("math3d/vec3-scale",Math3DVec3Scale);class Math3DVec3Length{static title="vec3_length";static desc="returns the module of a vector";constructor(){this.addInput("in","vec3"),this.addOutput("out","number")}onExecute(){var v=this.getInputData(0);null!=v&&(v=Math.sqrt(v[0]*v[0]+v[1]*v[1]+v[2]*v[2]),this.setOutputData(0,v))}}LiteGraph.registerNodeType("math3d/vec3-length",Math3DVec3Length);class Math3DVec3Normalize{static title="vec3_normalize";static desc="returns the vector normalized";constructor(){this.addInput("in","vec3"),this.addOutput("out","vec3"),this._data=new Float32Array(3)}onExecute(){var dist,data,v=this.getInputData(0);null!=v&&(dist=Math.sqrt(v[0]*v[0]+v[1]*v[1]+v[2]*v[2]),(data=this._data)[0]=v[0]/dist,data[1]=v[1]/dist,data[2]=v[2]/dist,this.setOutputData(0,data))}}LiteGraph.registerNodeType("math3d/vec3-normalize",Math3DVec3Normalize);class Math3DVec3Lerp{static title="vec3_lerp";static desc="returns the interpolated vector";constructor(){this.addInput("A","vec3"),this.addInput("B","vec3"),this.addInput("f","vec3"),this.addOutput("out","vec3"),this.properties={f:.5},this._data=new Float32Array(3)}onExecute(){var B,f,data,A=this.getInputData(0);null!=A&&null!=(B=this.getInputData(1))&&(f=this.getInputOrProperty("f"),(data=this._data)[0]=A[0]*(1-f)+B[0]*f,data[1]=A[1]*(1-f)+B[1]*f,data[2]=A[2]*(1-f)+B[2]*f,this.setOutputData(0,data))}}LiteGraph.registerNodeType("math3d/vec3-lerp",Math3DVec3Lerp);class Math3DVec3Dot{static title="vec3_dot";static desc="returns the dot product";constructor(){this.addInput("A","vec3"),this.addInput("B","vec3"),this.addOutput("out","number")}onExecute(){var B,A=this.getInputData(0);null!=A&&null!=(B=this.getInputData(1))&&(A=A[0]*B[0]+A[1]*B[1]+A[2]*B[2],this.setOutputData(0,A))}}if(LiteGraph.registerNodeType("math3d/vec3-dot",Math3DVec3Dot),"undefined"!=typeof glMatrix){class Math3DQuaternion{static title="Quaternion";static desc="quaternion";constructor(){this.addOutput("quat","quat"),this.properties={x:0,y:0,z:0,w:1,normalize:!1},this._value=quat.create()}onExecute(){this._value[0]=this.getInputOrProperty("x"),this._value[1]=this.getInputOrProperty("y"),this._value[2]=this.getInputOrProperty("z"),this._value[3]=this.getInputOrProperty("w"),this.properties.normalize&&quat.normalize(this._value,this._value),this.setOutputData(0,this._value)}onGetInputs(){return[["x","number"],["y","number"],["z","number"],["w","number"]]}}LiteGraph.registerNodeType("math3d/quaternion",Math3DQuaternion);class Math3DRotation{static title="Rotation";static desc="quaternion rotation";constructor(){this.addInputs([["degrees","number"],["axis","vec3"]]),this.addOutput("quat","quat"),this.properties={angle:90,axis:vec3.fromValues(0,1,0)},this._value=quat.create()}onExecute(){var angle=this.getInputData(0),axis=(null==angle&&(angle=this.properties.angle),this.getInputData(1)),axis=(null==axis&&(axis=this.properties.axis),quat.setAxisAngle(this._value,axis,.0174532925*angle));this.setOutputData(0,axis)}}LiteGraph.registerNodeType("math3d/rotation",Math3DRotation);class MathEulerToQuat{static title="Euler->Quat";static desc="Converts euler angles (in degrees) to quaternion";constructor(){this.addInput("euler","vec3"),this.addOutput("quat","quat"),this.properties={euler:[0,0,0],use_yaw_pitch_roll:!1},this._degs=vec3.create(),this._value=quat.create()}onExecute(){var euler=this.getInputData(0),euler=(null==euler&&(euler=this.properties.euler),vec3.scale(this._degs,euler,this.DEG2RAD),this.properties.use_yaw_pitch_roll&&(this._degs=[this._degs[2],this._degs[0],this._degs[1]]),quat.fromEuler(this._value,this._degs));this.setOutputData(0,euler)}}LiteGraph.registerNodeType("math3d/euler_to_quat",MathEulerToQuat);class MathQuatToEuler{static title="Euler->Quat";static desc="Converts rotX,rotY,rotZ in degrees to quat";constructor(){this.addInput(["quat","quat"]),this.addOutput("euler","vec3"),this._value=vec3.create()}onExecute(){var q=this.getInputData(0);q&&(quat.toEuler(this._value,q),vec3.scale(this._value,this._value,this.DEG2RAD),this.setOutputData(0,this._value))}}LiteGraph.registerNodeType("math3d/quat_to_euler",MathQuatToEuler);class Math3DRotateVec3{static title="Rot. Vec3";static desc="rotate a point";constructor(){this.addInputs([["vec3","vec3"],["quat","quat"]]),this.addOutput("result","vec3"),this.properties={vec:[0,0,1]}}onExecute(){var vec=this.getInputData(0),quat=(null==vec&&(vec=this.properties.vec),this.getInputData(1));null==quat?this.setOutputData(vec):this.setOutputData(0,vec3.transformQuat(vec3.create(),vec,quat))}}LiteGraph.registerNodeType("math3d/rotate_vec3",Math3DRotateVec3);class Math3DMultQuat{static title="Mult. Quat";static desc="rotate quaternion";constructor(){this.addInputs([["A","quat"],["B","quat"]]),this.addOutput("A*B","quat"),this._value=quat.create()}onExecute(){var B,A=this.getInputData(0);null!=A&&null!=(B=this.getInputData(1))&&(A=quat.multiply(this._value,A,B),this.setOutputData(0,A))}}LiteGraph.registerNodeType("math3d/mult-quat",Math3DMultQuat);class Math3DQuatSlerp{static title="Quat Slerp";static desc="quaternion spherical interpolation";constructor(){this.addInputs([["A","quat"],["B","quat"],["factor","number"]]),this.addOutput("slerp","quat"),this.addProperty("factor",.5),this._value=quat.create()}onExecute(){var B,factor,A=this.getInputData(0);null!=A&&null!=(B=this.getInputData(1))&&(factor=this.properties.factor,null!=this.getInputData(2)&&(factor=this.getInputData(2)),A=quat.slerp(this._value,A,B,factor),this.setOutputData(0,A))}}LiteGraph.registerNodeType("math3d/quat-slerp",Math3DQuatSlerp);class Math3DRemapRange{static title="Remap Range";static desc="remap a 3D range";constructor(){this.addInput("vec3","vec3"),this.addOutput("remap","vec3"),this.addOutput("clamped","vec3"),this.properties={clamp:!0,range_min:[-1,-1,0],range_max:[1,1,0],target_min:[-1,-1,0],target_max:[1,1,0]},this._value=vec3.create(),this._clamped=vec3.create()}onExecute(){for(var vec=this.getInputData(0),range_min=(vec&&this._value.set(vec),this.properties.range_min),range_max=this.properties.range_max,target_min=this.properties.target_min,target_max=this.properties.target_max,i=0;i<3;++i){var t,r=range_max[i]-range_min[i];this._clamped[i]=LiteGraph.clamp(this._value[i],range_min[i],range_max[i]),0==r?this._value[i]=.5*(target_min[i]+target_max[i]):(r=(this._value[i]-range_min[i])/r,t=(this.properties.clamp&&(r=LiteGraph.clamp(r,0,1)),target_max[i]-target_min[i]),this._value[i]=target_min[i]+r*t)}this.setOutputData(0,this._value),this.setOutputData(1,this._clamped)}}LiteGraph.registerNodeType("math3d/remap_range",Math3DRemapRange)}else LiteGraph.debug&&console.warn?.("No glmatrix found, some Math3D nodes may not work");function toString(a){if(a&&a.constructor===Object)try{return JSON.stringify(a)}catch(err){}return String(a)}function compare(a,b){return a==b}function concatenate(a,b){return void 0===a?b:void 0===b?a:a+""+b}function contains(a,b){return void 0!==a&&void 0!==b&&-1!=a.indexOf(b)}function toUpperCase(a){return null!=a&&a.constructor===String?a.toUpperCase():a}function split(str,separator){if(null==separator&&(separator=this.properties.separator),null==str)return[];if(str.constructor===String)return str.split(separator||" ");if(str.constructor!==Array)return null;for(var r=[],i=0;i<str.length;++i)"string"==typeof str[i]&&(r[i]=str[i].split(separator||" "));return r}function toFixed(a){return null!=a&&a.constructor===Number?a.toFixed(this.properties.precision):a}LiteGraph.wrapFunctionAsNode("string/toString",toString,[""],"string"),LiteGraph.wrapFunctionAsNode("string/compare",compare,["string","string"],"boolean"),LiteGraph.wrapFunctionAsNode("string/concatenate",concatenate,["string","string"],"string"),LiteGraph.wrapFunctionAsNode("string/contains",contains,["string","string"],"boolean"),LiteGraph.wrapFunctionAsNode("string/toUpperCase",toUpperCase,["string"],"string"),LiteGraph.wrapFunctionAsNode("string/split",split,["string,array","string"],"array",{separator:","}),LiteGraph.wrapFunctionAsNode("string/toFixed",toFixed,["number"],"string",{precision:0});class StringToTable{static title="toTable";static desc="Splits a string to table";constructor(){this.addInput("","string"),this.addOutput("table","table"),this.addOutput("rows","number"),this.addProperty("value",""),this.addProperty("separator",","),this._table=null}onExecute(){var separator,input=this.getInputData(0);input&&(separator=this.properties.separator||",",input==this._str&&separator==this._last_separator||(this._last_separator=separator,this._str=input,this._table=input.split("\n").map(function(a){return a.trim().split(separator)})),this.setOutputData(0,this._table),this.setOutputData(1,this._table?this._table.length:0))}}LiteGraph.registerNodeType("string/toTable",StringToTable);class Selector{static title="Selector";static desc="selects an output";constructor(){this.addInput("sel","number"),this.addInput("A"),this.addInput("B"),this.addInput("C"),this.addInput("D"),this.addOutput("out"),this.selected=0}onDrawBackground(ctx){var y;this.flags.collapsed||(ctx.fillStyle="#AFB",y=(this.selected+1)*LiteGraph.NODE_SLOT_HEIGHT+6,ctx.beginPath(),ctx.moveTo(50,y),ctx.lineTo(50,y+LiteGraph.NODE_SLOT_HEIGHT),ctx.lineTo(34,y+.5*LiteGraph.NODE_SLOT_HEIGHT),ctx.fill())}onExecute(){var sel=this.getInputData(0),sel=(null!=sel&&sel.constructor===Number||(sel=0),this.selected=sel=Math.round(sel)%(this.inputs.length-1),this.getInputData(sel+1));void 0!==sel&&this.setOutputData(0,sel)}onGetInputs(){return[["E",0],["F",0],["G",0],["H",0]]}}LiteGraph.registerNodeType("logic/selector",Selector);class Sequence{static title="Sequence";static desc="select one element from a sequence from a string";constructor(){this.properties={sequence:"A,B,C"},this.addInput("index","number"),this.addInput("seq"),this.addOutput("out"),this.index=0,this.values=this.properties.sequence.split(",")}onPropertyChanged(name,value){"sequence"==name&&(this.values=value.split(","))}onExecute(){var seq=this.getInputData(1),seq=(seq&&seq!=this.current_sequence&&(this.values=seq.split(","),this.current_sequence=seq),this.getInputData(0));null==seq&&(seq=0),this.index=seq=Math.round(seq)%this.values.length,this.setOutputData(0,this.values[seq])}}LiteGraph.registerNodeType("logic/sequence",Sequence);class logicAnd{static title="AND";static desc="Return true if all inputs are true";constructor(){this.properties={},this.addInput("a","boolean"),this.addInput("b","boolean"),this.addOutput("out","boolean")}onExecute(){let ret=!0;for(var inX in this.inputs)if(!this.getInputData(inX)){ret=!1;break}this.setOutputData(0,ret)}onGetInputs(){return[["and","boolean"]]}}LiteGraph.registerNodeType("logic/AND",logicAnd);class logicOr{static title="OR";static desc="Return true if at least one input is true";constructor(){this.properties={},this.addInput("a","boolean"),this.addInput("b","boolean"),this.addOutput("out","boolean")}onExecute(){var inX,ret=!1;for(inX in this.inputs)if(this.getInputData(inX)){ret=!0;break}this.setOutputData(0,ret)}onGetInputs(){return[["or","boolean"]]}}LiteGraph.registerNodeType("logic/OR",logicOr);class logicNot{static title="NOT";static desc="Return the logical negation";constructor(){this.properties={},this.addInput("in","boolean"),this.addOutput("out","boolean")}onExecute(){var ret=!this.getInputData(0);this.setOutputData(0,ret)}}LiteGraph.registerNodeType("logic/NOT",logicNot);class logicCompare{static title="bool == bool";static desc="Compare for logical equality";constructor(){this.properties={},this.addInput("a","boolean"),this.addInput("b","boolean"),this.addOutput("out","boolean")}onExecute(){var inX,last=null,ret=!0;for(inX in this.inputs)if(null===last)last=this.getInputData(inX);else if(last!=this.getInputData(inX)){ret=!1;break}this.setOutputData(0,ret)}onGetInputs(){return[["bool","boolean"]]}}LiteGraph.registerNodeType("logic/CompareBool",logicCompare);class logicBranch{static title="Branch";static desc="Branch execution on condition";constructor(){this.properties={},this.addInput("onTrigger",LiteGraph.ACTION),this.addInput("condition","boolean"),this.addOutput("true",LiteGraph.EVENT),this.addOutput("false",LiteGraph.EVENT),this.mode=LiteGraph.ON_TRIGGER}onExecute(_param,_options){var conditition=this.getInputData(1);conditition?(console.debug(this,conditition),this.triggerSlot(0,_param,null,_options)):this.triggerSlot(1,_param,null,_options)}}LiteGraph.registerNodeType("logic/IF",logicBranch);class logicFor{constructor(){this.properties={},this.addInput("start","number"),this.addInput("nElements","number"),this.addInput("do",LiteGraph.ACTION),this.addInput("break",LiteGraph.ACTION),this.addOutput("do",LiteGraph.EVENT),this.addOutput("index","number"),this.started=!1,this.stopped=!1}static title="FOR";static desc="Cycle FOR";onExecute(param){if(this.started){for(var iI=this.getInputData(0),num=this.getInputData(1),k=iI;k<iI+num;k++)if(console.debug?.("for cycle "+k),this.setOutputData(1,k),this.triggerSlot(0,param),this.stopped){console.debug?.("for cycle stopped on index "+k);break}this.started=!1,this.stopped=!0}}onAction(action){switch(action){case"break":this.stopped=!0;break;case"do":this.started=!0,this.stopped=!1,this.doExecute()}}}LiteGraph.registerNodeType("logic/CycleFOR",logicFor);class logicForEach{constructor(){this.properties={},this.addInput("array","array"),this.addInput("do",LiteGraph.ACTION),this.addInput("break",LiteGraph.ACTION),this.addOutput("do",LiteGraph.EVENT),this.addOutput("index","number"),this.addOutput("element",0),this.started=!1,this.stopped=!1}static title="ForEach";static desc="Cycle for each element in array";onExecute(param){var ar;this.started&&(ar=this.getInputData(0),this.getInputData(1),null!==ar)&&ar&&"function"==typeof ar.forEach&&(ar.forEach((el,k)=>{console.debug?.("for cycle "+k),this.setOutputData(1,k),this.setOutputData(2,el),this.triggerSlot(0,param),this.stopped&&console.debug?.("foreach cycle stopped on index "+k)}),this.started=!1,this.stopped=!0)}onAction(action){switch(action){case"break":this.stopped=!0;break;case"do":this.started=!0,this.stopped=!1,this.doExecute()}}}LiteGraph.registerNodeType("logic/CycleForEach",logicForEach);class logicWhile{constructor(){this.properties={cycleLimit:999,checkOnStart:!0},this.addInput("do",LiteGraph.ACTION),this.addInput("condition","boolean"),this.addInput("break",LiteGraph.ACTION),this.addOutput("do",LiteGraph.EVENT),this.addOutput("index","number"),this.started=!1,this.stopped=!1,this.k=0,this.cond=!1,this.addWidget("toggle","checkOnStart",this.properties.checkOnStart,"checkOnStart")}static title="WHILE";static desc="Cycle WHILE";onExecute(){this.setOutputData(1,this.k),this.cond=this.getInputData(1)}onAction(action,param){switch(action){case"break":this.stopped=!0;break;case"do":this.started=!0,this.stopped=!1;for(var checkOnStart=this.getInputOrProperty("checkOnStart"),cycleLimit=(this.cond=!checkOnStart||this.getInputData(1),this.k=0,this.properties.cycleLimit||999);this.cond&&this.k<cycleLimit;){if(console.debug?.("while cycle "+this.k),this.setOutputData(1,this.k),this.triggerSlot(0,param),this.stopped){console.debug?.("while cycle stopped on index "+k);break}this.k++,this.cond=this.getInputData(1,!0,!0)}this.k=0,this.setOutputData(1,this.k),this.cond=this.getInputData(1),this.started=!1,this.stopped=!0}}}LiteGraph.registerNodeType("logic/CycleWHILE",logicWhile);class GraphicsPlot{static title="Plot";static desc="Plots data over time";constructor(){this.addInput("A","Number"),this.addInput("B","Number"),this.addInput("C","Number"),this.addInput("D","Number"),this.values=[[],[],[],[]],this.properties={scale:2}}onExecute(){if(!this.flags.collapsed)for(var size=this.size,i=0;i<4;++i){var values,v=this.getInputData(i);null!=v&&((values=this.values[i]).push(v),values.length>size[0])&&values.shift()}}onDrawBackground(ctx){if(!this.flags.collapsed){var size=this.size,scale=.5*size[1]/this.properties.scale,colors=GraphicsPlot.colors,offset=.5*size[1];if(ctx.fillStyle="#000",ctx.fillRect(0,0,size[0],size[1]),ctx.strokeStyle="#555",ctx.beginPath(),ctx.moveTo(0,offset),ctx.lineTo(size[0],offset),ctx.stroke(),this.inputs)for(let i=0;i<4;++i){var values=this.values[i];if(this.inputs[i]&&this.inputs[i].link){ctx.strokeStyle=colors[i],ctx.beginPath();var v=values[0]*scale*-1+offset;ctx.moveTo(0,LiteGraph.clamp(v,0,size[1]));for(let j=1;j<values.length&&j<size[0];++j)v=values[j]*scale*-1+offset,ctx.lineTo(j,LiteGraph.clamp(v,0,size[1]));ctx.stroke()}}}}static colors=["#FFF","#F99","#9F9","#99F"]}LiteGraph.registerNodeType("graphics/plot",GraphicsPlot);class GraphicsImage{static title="Image";static desc="Image loader";constructor(){this.addOutput("frame","image"),this.properties={url:""}}onAdded(){""!=this.properties.url&&null==this.img&&this.loadImage(this.properties.url)}onDrawBackground(ctx){this.flags.collapsed||this.img&&5<this.size[0]&&5<this.size[1]&&this.img.width&&ctx.drawImage(this.img,0,0,this.size[0],this.size[1])}onExecute(){this.img||(this.boxcolor="#000"),this.img&&this.img.width?this.setOutputData(0,this.img):this.setOutputData(0,null),this.img&&this.img.dirty&&(this.img.dirty=!1)}onPropertyChanged(name,value){return this.properties[name]=value,"url"==name&&""!=value&&this.loadImage(value),!0}loadImage(url,callback){var that;""==url?this.img=null:(this.img=document.createElement("img"),"http"==url.substr(0,4)&&LiteGraph.proxy&&(url=LiteGraph.proxy+url.substr(url.indexOf(":")+3)),this.img.src=url,this.boxcolor="#F95",(that=this).img.onload=function(){callback&&callback(this),console.log?.(`Image loaded, size: ${that.img.width}x`+that.img.height),this.dirty=!0,that.boxcolor="#9F9",that.setDirtyCanvas(!0)},this.img.onerror=function(){console.log?.("error loading the image:"+url)})}onWidget(e,widget){"load"==widget.name&&this.loadImage(this.properties.url)}onDropFile(file){var that=this;this._url&&URL.revokeObjectURL(this._url),this._url=URL.createObjectURL(file),this.properties.url=this._url,this.loadImage(this._url,function(img){that.size[1]=img.height/img.width*that.size[0]})}static widgets=[{name:"load",text:"Load",type:"button"}];static supported_extensions=["jpg","jpeg","png","gif"]}LiteGraph.registerNodeType("graphics/image",GraphicsImage);class ColorPalette{static title="Palette";static desc="Generates a color";constructor(){this.addInput("f","number"),this.addOutput("Color","color"),this.properties={colorA:"#444444",colorB:"#44AAFF",colorC:"#44FFAA",colorD:"#FFFFFF"}}onExecute(){var c=[],f=(null!=this.properties.colorA&&c.push(hex2num(this.properties.colorA)),null!=this.properties.colorB&&c.push(hex2num(this.properties.colorB)),null!=this.properties.colorC&&c.push(hex2num(this.properties.colorC)),null!=this.properties.colorD&&c.push(hex2num(this.properties.colorD)),this.getInputData(0));if(1<(f=null==f?.5:f)?f=1:f<0&&(f=0),0!=c.length){var c1,result=[0,0,0];0==f?result=c[0]:1==f?result=c[c.length-1]:(f=(c.length-1)*f,c1=c[Math.floor(f)],c=c[Math.floor(f)+1],f=f-Math.floor(f),result[0]=c1[0]*(1-f)+c[0]*f,result[1]=c1[1]*(1-f)+c[1]*f,result[2]=c1[2]*(1-f)+c[2]*f);for(var i=0;i<result.length;i++)result[i]/=255;this.boxcolor=colorToString(result),this.setOutputData(0,result)}}}LiteGraph.registerNodeType("color/palette",ColorPalette);class ImageFrame{static title="Frame";static desc="Frame viewer";constructor(){this.addInput("","image,canvas"),this.size=[200,200]}onDrawBackground(ctx){this.frame&&!this.flags.collapsed&&ctx.drawImage(this.frame,0,0,this.size[0],this.size[1])}onExecute(){this.frame=this.getInputData(0),this.setDirtyCanvas(!0)}onWidget(e,widget){var width,height;"resize"==widget.name&&this.frame?(width=this.frame.width,height=this.frame.height,width||null==this.frame.videoWidth||(width=this.frame.videoWidth,height=this.frame.videoHeight),width&&height&&(this.size=[width,height]),this.setDirtyCanvas(!0,!0)):"view"==widget.name&&this.show()}show(){showElement&&this.frame&&showElement(this.frame)}static widgets=[{name:"resize",text:"Resize box",type:"button"},{name:"view",text:"View Image",type:"button"}]}LiteGraph.registerNodeType("graphics/frame",ImageFrame);class ImageFade{static title="Image fade";static desc="Fades between images";constructor(){this.addInputs([["img1","image"],["img2","image"],["fade","number"]]),this.addOutput("","image"),this.properties={fade:.5,width:512,height:512}}onAdded(){this.createCanvas();var ctx=this.canvas.getContext("2d");ctx.fillStyle="#000",ctx.fillRect(0,0,this.properties.width,this.properties.height)}createCanvas(){this.canvas=document.createElement("canvas"),this.canvas.width=this.properties.width,this.canvas.height=this.properties.height}onExecute(){var ctx=this.canvas.getContext("2d"),A=this.getInputData(0),A=(null!=A&&ctx.drawImage(A,0,0,this.canvas.width,this.canvas.height),this.getInputData(2)),A=(null==A?A=this.properties.fade:this.properties.fade=A,ctx.globalAlpha=A,this.getInputData(1));null!=A&&ctx.drawImage(A,0,0,this.canvas.width,this.canvas.height),ctx.globalAlpha=1,this.setOutputData(0,this.canvas),this.setDirtyCanvas(!0)}static widgets=[{name:"resizeA",text:"Resize to A",type:"button"},{name:"resizeB",text:"Resize to B",type:"button"}]}LiteGraph.registerNodeType("graphics/imagefade",ImageFade);class ImageCrop{static title="Crop";static desc="Crop Image";constructor(){this.addInput("","image"),this.addOutput("","image"),this.properties={width:256,height:256,x:0,y:0,scale:1},this.size=[50,20]}onAdded(){this.createCanvas()}createCanvas(){this.canvas=document.createElement("canvas"),this.canvas.width=this.properties.width,this.canvas.height=this.properties.height}onExecute(){var input=this.getInputData(0);input&&(input.width?(this.canvas.getContext("2d").drawImage(input,-this.properties.x,-this.properties.y,input.width*this.properties.scale,input.height*this.properties.scale),this.setOutputData(0,this.canvas)):this.setOutputData(0,null))}onDrawBackground(ctx){this.flags.collapsed||this.canvas&&ctx.drawImage(this.canvas,0,0,this.canvas.width,this.canvas.height,0,0,this.size[0],this.size[1])}onPropertyChanged(name,value){return this.properties[name]=value,"scale"==name?(this.properties[name]=parseFloat(value),0==this.properties[name]&&(console.error?.("Error in scale"),this.properties[name]=1)):this.properties[name]=parseInt(value),this.createCanvas(),!0}}LiteGraph.registerNodeType("graphics/cropImage",ImageCrop);class CanvasNode{static title="Canvas";static desc="Canvas to render stuff";constructor(){this.addInput("clear",LiteGraph.ACTION),this.addOutput("","canvas"),this.properties={width:512,height:512,autoclear:!0},this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d")}onExecute(){var canvas=this.canvas,w=0|this.properties.width,h=0|this.properties.height;canvas.width!=w&&(canvas.width=w),canvas.height!=h&&(canvas.height=h),this.properties.autoclear&&this.ctx.clearRect(0,0,canvas.width,canvas.height),this.setOutputData(0,canvas)}onAction(action){"clear"==action&&this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}}LiteGraph.registerNodeType("graphics/canvas",CanvasNode);class DrawImageNode{static title="DrawImage";static desc="Draws image into a canvas";constructor(){this.addInput("canvas","canvas"),this.addInput("img","image,canvas"),this.addInput("x","number"),this.addInput("y","number"),this.properties={x:0,y:0,opacity:1}}onExecute(){var img,x,y,canvas=this.getInputData(0);canvas&&(img=this.getInputOrProperty("img"))&&(x=this.getInputOrProperty("x"),y=this.getInputOrProperty("y"),canvas.getContext("2d").drawImage(img,x,y))}}LiteGraph.registerNodeType("graphics/drawImage",DrawImageNode);class DrawRectangleNode{static title="DrawRectangle";static desc="Draws rectangle in canvas";constructor(){this.addInput("canvas","canvas"),this.addInput("x","number"),this.addInput("y","number"),this.addInput("w","number"),this.addInput("h","number"),this.properties={x:0,y:0,w:10,h:10,color:"white",opacity:1}}onExecute(){var x,y,w,h,canvas=this.getInputData(0);canvas&&(x=this.getInputOrProperty("x"),y=this.getInputOrProperty("y"),w=this.getInputOrProperty("w"),h=this.getInputOrProperty("h"),canvas.getContext("2d").fillRect(x,y,w,h))}}LiteGraph.registerNodeType("graphics/drawRectangle",DrawRectangleNode);class ImageVideo{static title="Video";static desc="Video playback";constructor(){this.addInput("t","number"),this.addOutputs([["frame","image"],["t","number"],["d","number"]]),this.properties={url:"",use_proxy:!0}}onExecute(){var t;this.properties.url&&(this.properties.url!=this._video_url&&this.loadVideo(this.properties.url),this._video)&&0!=this._video.width&&((t=this.getInputData(0))&&0<=t&&t<=1&&(this._video.currentTime=t*this._video.duration,this._video.pause()),this._video.dirty=!0,this.setOutputData(0,this._video),this.setOutputData(1,this._video.currentTime),this.setOutputData(2,this._video.duration),this.setDirtyCanvas(!0))}onStart(){this.play()}onStop(){this.stop()}loadVideo(url){var pos=(this._video_url=url).substr(0,10).indexOf(":"),protocol="",host="",that=((protocol=-1!=pos?url.substr(0,pos):protocol)&&(host=(host=url.substr(0,url.indexOf("/",protocol.length+3))).substr(protocol.length+3)),this.properties.use_proxy&&protocol&&LiteGraph.proxy&&host!=location.host&&(url=LiteGraph.proxy+url.substr(url.indexOf(":")+3)),this._video=document.createElement("video"),this._video.src=url,this._video.type="type=video/mp4",this._video.muted=!0,this._video.autoplay=!0,this);this._video.addEventListener("loadedmetadata",_event=>{console.log?.("Duration: "+this.duration+" seconds"),console.log?.("Size: "+this.videoWidth+","+this.videoHeight),that.setDirtyCanvas(!0),this.width=this.videoWidth,this.height=this.videoHeight}),this._video.addEventListener("progress",_event=>{console.log?.("video loading...")}),this._video.addEventListener("error",_event=>{if(console.error?.("Error loading video: "+this.src),this.error)switch(this.error.code){case this.error.MEDIA_ERR_ABORTED:console.error?.("You stopped the video.");break;case this.error.MEDIA_ERR_NETWORK:console.error?.("Network error - please try again later.");break;case this.error.MEDIA_ERR_DECODE:console.error?.("Video is broken..");break;case this.error.MEDIA_ERR_SRC_NOT_SUPPORTED:console.error?.("Sorry, your browser can't play this video.")}}),this._video.addEventListener("ended",_event=>{console.log?.("Video Ended."),this.play()})}onPropertyChanged(name,value){return this.properties[name]=value,"url"==name&&""!=value&&this.loadVideo(value),!0}play(){this._video&&this._video.videoWidth&&this._video.play()}playPause(){this._video&&(this._video.paused?this.play():this.pause())}stop(){this._video&&(this._video.pause(),this._video.currentTime=0)}pause(){this._video&&(console.log?.("Video paused"),this._video.pause())}onWidget(_e,_widget){}static widgets=[{name:"play",text:"PLAY",type:"minibutton"},{name:"stop",text:"STOP",type:"minibutton"},{name:"demo",text:"Demo video",type:"button"},{name:"mute",text:"Mute video",type:"button"}]}LiteGraph.registerNodeType("graphics/video",ImageVideo);class ImageWebcam{static title="Webcam";static desc="Webcam image";constructor(){this.addOutput("Webcam","image"),this.properties={filterFacingMode:!1,facingMode:"user"},this.boxcolor="black",this.frame=0}openStream(){var constraints,that;navigator.mediaDevices.getUserMedia?(constraints={audio:!(this._waiting_confirmation=!0),video:!this.properties.filterFacingMode||{facingMode:this.properties.facingMode}},navigator.mediaDevices.getUserMedia(constraints).then(this.streamReady.bind(this)).catch(function(e){console.log?.("Webcam rejected",e),that._webcam_stream=!1,ImageWebcam.is_webcam_open=!1,that.boxcolor="red",that.trigger("stream_error")}),that=this):console.log?.("getUserMedia() is not supported in your browser, use chrome and enable WebRTC from about://flags")}closeStream(){if(this._webcam_stream){var tracks=this._webcam_stream.getTracks();if(tracks.length)for(var i=0;i<tracks.length;++i)tracks[i].stop();ImageWebcam.is_webcam_open=!1,this._webcam_stream=null,this._video=null,this.boxcolor="black",this.trigger("stream_closed")}}onPropertyChanged(name,value){"facingMode"==name&&(this.properties.facingMode=value,this.closeStream(),this.openStream())}onRemoved(){this.closeStream()}streamReady(localMediaStream){this._webcam_stream=localMediaStream,this.boxcolor="green";var video=this._video;video||((video=document.createElement("video")).autoplay=!0,video.srcObject=localMediaStream,(this._video=video).onloadedmetadata=function(e){console.log?.(e),ImageWebcam.is_webcam_open=!0}),this.trigger("stream_ready",video)}onExecute(){if(null!=this._webcam_stream||this._waiting_confirmation||this.openStream(),this._video&&this._video.videoWidth){this._video.frame=++this.frame,this._video.width=this._video.videoWidth,this._video.height=this._video.videoHeight,this.setOutputData(0,this._video);for(var i=1;i<this.outputs.length;++i)if(this.outputs[i])switch(this.outputs[i].name){case"width":this.setOutputData(i,this._video.videoWidth);break;case"height":this.setOutputData(i,this._video.videoHeight)}}}getExtraMenuOptions(){var that=this;return[{content:that.properties.show?"Hide Frame":"Show Frame",callback:function(){that.properties.show=!that.properties.show}}]}onDrawBackground(ctx){this.flags.collapsed||this.size[1]<=20||!this.properties.show||this._video&&(ctx.save(),ctx.drawImage(this._video,0,0,this.size[0],this.size[1]),ctx.restore())}onGetOutputs(){return[["width","number"],["height","number"],["stream_ready",LiteGraph.EVENT],["stream_closed",LiteGraph.EVENT],["stream_error",LiteGraph.EVENT]]}static is_webcam_open=!1}LiteGraph.registerNodeType("graphics/webcam",ImageWebcam);let DEG2RAD=.0174532925;class LGraphTexture{static title="Texture";static desc="Texture";constructor(){this.addOutput("tex","Texture"),this.addOutput("name","string"),this.properties={name:"",filter:!0},this.size=[LGraphTexture.image_preview_size,LGraphTexture.image_preview_size]}static widgets_info={name:{widget:"texture"},filter:{widget:"checkbox"}};static loadTextureCallback=null;static image_preview_size=256;static UNDEFINED=0;static PASS_THROUGH=1;static COPY=2;static LOW=3;static HIGH=4;static REUSE=5;static DEFAULT=2;static MODE_VALUES={undefined:LGraphTexture.UNDEFINED,"pass through":LGraphTexture.PASS_THROUGH,copy:LGraphTexture.COPY,low:LGraphTexture.LOW,high:LGraphTexture.HIGH,reuse:LGraphTexture.REUSE,default:LGraphTexture.DEFAULT};static getTexturesContainer(){return gl.textures}static loadTexture(name,options){options=options||{};var url=name;return"http://"==url.substr(0,7)&&LiteGraph.proxy&&(url=LiteGraph.proxy+url.substr(7)),LGraphTexture.getTexturesContainer()[name]=GL.Texture.fromURL(url,options)}static getTexture(name){var container=this.getTexturesContainer();if(container)return!(container=container[name])&&name&&":"!=name[0]?this.loadTexture(name):container;throw new Error("Cannot load texture, container of textures not found")}static getTargetTexture(origin,target,mode){if(!origin)throw new Error("LGraphTexture.getTargetTexture expects a reference texture");var tex_type=null;switch(mode){case LGraphTexture.LOW:tex_type=gl.UNSIGNED_BYTE;break;case LGraphTexture.HIGH:tex_type=gl.HIGH_PRECISION_FORMAT;break;case LGraphTexture.REUSE:return origin;default:tex_type=origin?origin.type:gl.UNSIGNED_BYTE}return target=target&&target.width==origin.width&&target.height==origin.height&&target.type==tex_type&&target.format==origin.format?target:new GL.Texture(origin.width,origin.height,{type:tex_type,format:origin.format,filter:gl.LINEAR})}static getTextureType(precision,ref_texture){var type=ref_texture?ref_texture.type:gl.UNSIGNED_BYTE;switch(precision){case LGraphTexture.HIGH:type=gl.HIGH_PRECISION_FORMAT;break;case LGraphTexture.LOW:type=gl.UNSIGNED_BYTE}return type}static getWhiteTexture(){return this._white_texture||(this._white_texture=GL.Texture.fromMemory(1,1,[255,255,255,255],{format:gl.RGBA,wrap:gl.REPEAT,filter:gl.NEAREST}))}static getNoiseTexture(){if(this._noise_texture)return this._noise_texture;for(var noise=new Uint8Array(1048576),i=0;i<1048576;++i)noise[i]=255*Math.random();var texture=GL.Texture.fromMemory(512,512,noise,{format:gl.RGBA,wrap:gl.REPEAT,filter:gl.NEAREST});return this._noise_texture=texture}onDropFile(data,filename,file){var texture;data?(texture=null,texture="string"==typeof data?GL.Texture.fromURL(data):-1!=filename.toLowerCase().indexOf(".dds")?GL.Texture.fromDDSInMemory(data):(data=new Blob([file]),file=URL.createObjectURL(data),GL.Texture.fromURL(file)),this._drop_texture=texture,this.properties.name=filename):(this._drop_texture=null,this.properties.name="")}getExtraMenuOptions(){var that=this;if(this._drop_texture)return[{content:"Clear",callback:function(){that._drop_texture=null,that.properties.name=""}}]}onExecute(){var tex=null;if(tex=!(tex=!(tex=this.isOutputConnected(1)?this.getInputData(0):tex)&&this._drop_texture?this._drop_texture:tex)&&this.properties.name?LGraphTexture.getTexture(this.properties.name):tex){this._last_tex=tex,!1===this.properties.filter?tex.setParameter(gl.TEXTURE_MAG_FILTER,gl.NEAREST):tex.setParameter(gl.TEXTURE_MAG_FILTER,gl.LINEAR),this.setOutputData(0,tex),this.setOutputData(1,tex.fullpath||tex.filename);for(var i=2;i<this.outputs.length;i++){var v,output=this.outputs[i];output&&(v=null,"width"==output.name?v=tex.width:"height"==output.name?v=tex.height:"aspect"==output.name&&(v=tex.width/tex.height),this.setOutputData(i,v))}}else this.setOutputData(0,null),this.setOutputData(1,"")}onResourceRenamed(old_name,new_name){this.properties.name==old_name&&(this.properties.name=new_name)}onDrawBackground(ctx){if(!(this.flags.collapsed||this.size[1]<=20))if(this._drop_texture&&ctx.webgl)ctx.drawImage(this._drop_texture,0,0,this.size[0],this.size[1]);else{if(this._last_preview_tex!=this._last_tex)if(ctx.webgl)this._canvas=this._last_tex;else{var tex_canvas=LGraphTexture.generateLowResTexturePreview(this._last_tex);if(!tex_canvas)return;this._last_preview_tex=this._last_tex,this._canvas=GL.cloneCanvas(tex_canvas)}this._canvas&&(ctx.save(),ctx.webgl||(ctx.translate(0,this.size[1]),ctx.scale(1,-1)),ctx.drawImage(this._canvas,0,0,this.size[0],this.size[1]),ctx.restore())}}static generateLowResTexturePreview(tex){if(!tex)return null;var size=LGraphTexture.image_preview_size,temp_tex=tex;if(tex.format==gl.DEPTH_COMPONENT)return null;(tex.width>size||tex.height>size)&&(temp_tex=this._preview_temp_tex,this._preview_temp_tex||(temp_tex=new GL.Texture(size,size,{minFilter:gl.NEAREST}),this._preview_temp_tex=temp_tex),tex.copyTo(temp_tex),tex=temp_tex);tex=this._preview_canvas;return tex||(tex=GL.createCanvas(size,size),this._preview_canvas=tex),temp_tex&&temp_tex.toCanvas(tex),tex}getResources(res){return this.properties.name&&(res[this.properties.name]=GL.Texture),res}onGetInputs(){return[["in","Texture"]]}onGetOutputs(){return[["width","number"],["height","number"],["aspect","number"]]}static replaceCode(code,context){return code.replace(/\{\{[a-zA-Z0-9_]*\}\}/g,function(v){return v=v.replace(/[\{\}]/g,""),context[v]||""})}}LiteGraph.registerNodeType("texture/texture",LGraphTexture);class LGraphTexturePreview{constructor(){this.addInput("Texture","Texture"),this.properties={flipY:!1},this.size=[LGraphTexture.image_preview_size,LGraphTexture.image_preview_size]}static title="Preview";static desc="Show a texture in the graph canvas";static allow_preview=!1;onDrawBackground(ctx){var tex,tex_canvas;this.flags.collapsed||(ctx.webgl||LGraphTexturePreview.allow_preview)&&(tex=this.getInputData(0))&&(tex_canvas=null,tex_canvas=!tex.handle&&ctx.webgl?tex:LGraphTexture.generateLowResTexturePreview(tex),ctx.save(),this.properties.flipY&&(ctx.translate(0,this.size[1]),ctx.scale(1,-1)),ctx.drawImage(tex_canvas,0,0,this.size[0],this.size[1]),ctx.restore())}}LiteGraph.registerNodeType("texture/preview",LGraphTexturePreview);class LGraphTextureSave{constructor(){this.addInput("Texture","Texture"),this.addOutput("tex","Texture"),this.addOutput("name","string"),this.properties={name:"",generate_mipmaps:!1}}static title="Save";static desc="Save a texture in the repository";getPreviewTexture(){return this._texture}onExecute(){var tex=this.getInputData(0);tex&&(this.properties.generate_mipmaps&&(tex.bind(0),tex.setParameter(gl.TEXTURE_MIN_FILTER,gl.LINEAR_MIPMAP_LINEAR),gl.generateMipmap(tex.texture_type),tex.unbind(0)),this.properties.name&&(LGraphTexture.storeTexture?LGraphTexture.storeTexture(this.properties.name,tex):LGraphTexture.getTexturesContainer()[this.properties.name]=tex),this._texture=tex,this.setOutputData(0,tex),this.setOutputData(1,this.properties.name))}}LiteGraph.registerNodeType("texture/save",LGraphTextureSave);class LGraphTextureOperation{constructor(){this.addInput("Texture","Texture"),this.addInput("TextureB","Texture"),this.addInput("value","number"),this.addOutput("Texture","Texture"),this.help="<p>pixelcode must be vec3, uvcode must be vec2, is optional</p>        <p><strong>uv:</strong> tex. coords</p><p><strong>color:</strong> texture <strong>colorB:</strong> textureB</p><p><strong>time:</strong> scene time <strong>value:</strong> input value</p><p>For multiline you must type: result = ...</p>",this.properties={value:1,pixelcode:"color + colorB * value",uvcode:"",precision:LGraphTexture.DEFAULT},this.has_error=!1}static widgets_info={uvcode:{widget:"code"},pixelcode:{widget:"code"},precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}};static title="Operation";static desc="Texture shader operation";static presets={};getExtraMenuOptions(){var that=this;return[{content:that.properties.show?"Hide Texture":"Show Texture",callback:function(){that.properties.show=!that.properties.show}}]}onPropertyChanged(){this.has_error=!1}onDrawBackground(ctx){this.flags.collapsed||this.size[1]<=20||!this.properties.show||this._tex&&this._tex.gl==ctx&&(ctx.save(),ctx.drawImage(this._tex,0,0,this.size[0],this.size[1]),ctx.restore())}onExecute(){var tex=this.getInputData(0);if(this.isOutputConnected(0))if(this.properties.precision===LGraphTexture.PASS_THROUGH)this.setOutputData(0,tex);else{var texB=this.getInputData(1);if(this.properties.uvcode||this.properties.pixelcode){var value,time,width=512,height=512,type=(tex?(width=tex.width,height=tex.height):texB&&(width=texB.width,height=texB.height),texB=texB||GL.Texture.getWhiteTexture(),LGraphTexture.getTextureType(this.properties.precision,tex)),type=(tex||this._tex?this._tex=LGraphTexture.getTargetTexture(tex||this._tex,this._tex,this.properties.precision):this._tex=new GL.Texture(width,height,{type:type,format:gl.RGBA,filter:gl.LINEAR}),""),pixelcode=(this.properties.uvcode&&(type="uv = "+this.properties.uvcode,-1!=this.properties.uvcode.indexOf(";"))&&(type=this.properties.uvcode),""),shader=(this.properties.pixelcode&&(pixelcode="result = "+this.properties.pixelcode,-1!=this.properties.pixelcode.indexOf(";"))&&(pixelcode=this.properties.pixelcode),this._shader);if(!(this.has_error||shader&&this._shader_code==type+"|"+pixelcode)){var final_pixel_code=LGraphTexture.replaceCode(LGraphTextureOperation.pixel_shader,{UV_CODE:type,PIXEL_CODE:pixelcode});try{shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,final_pixel_code),this.boxcolor="#00FF00"}catch(err){return GL.Shader.dumpErrorToConsole(err,Shader.SCREEN_VERTEX_SHADER,final_pixel_code),this.boxcolor="#FF0000",void(this.has_error=!0)}this._shader=shader,this._shader_code=type+"|"+pixelcode}this._shader&&(null!=(value=this.getInputData(2))?this.properties.value=value:value=parseFloat(this.properties.value),time=this.graph.getTime(),this._tex.drawTo(function(){gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE),gl.disable(gl.BLEND),tex&&tex.bind(0),texB&&texB.bind(1);var mesh=Mesh.getScreenQuad();shader.uniforms({u_texture:0,u_textureB:1,value:value,texSize:[width,height,1/width,1/height],time:time}).draw(mesh)}),this.setOutputData(0,this._tex))}}}static pixel_shader=`
        precision highp float;
    
        uniform sampler2D u_texture;
        uniform sampler2D u_textureB;
        varying vec2 v_coord;
        uniform vec4 texSize;
        uniform float time;
        uniform float value;
    
        void main() {
            vec2 uv = v_coord;
            {{UV_CODE}};
            vec4 color4 = texture2D(u_texture, uv);
            vec3 color = color4.rgb;
            vec4 color4B = texture2D(u_textureB, uv);
            vec3 colorB = color4B.rgb;
            vec3 result = color;
            float alpha = 1.0;
            {{PIXEL_CODE}};
            gl_FragColor = vec4(result, alpha);
        }
    `;static registerPreset(name,code){LGraphTextureOperation.presets[name]=code}onInspect(widgets){var that=this;widgets.addCombo("Presets","",{values:Object.keys(LGraphTextureOperation.presets),callback:function(v){var code=LGraphTextureOperation.presets[v];code&&(that.setProperty("pixelcode",code),that.title=v,widgets.refresh())}})}}LGraphTextureOperation.registerPreset("",""),LGraphTextureOperation.registerPreset("bypass","color"),LGraphTextureOperation.registerPreset("add","color + colorB * value"),LGraphTextureOperation.registerPreset("substract","(color - colorB) * value"),LGraphTextureOperation.registerPreset("mate","mix( color, colorB, color4B.a * value)"),LGraphTextureOperation.registerPreset("invert","vec3(1.0) - color"),LGraphTextureOperation.registerPreset("multiply","color * colorB * value"),LGraphTextureOperation.registerPreset("divide","(color / colorB) / value"),LGraphTextureOperation.registerPreset("difference","abs(color - colorB) * value"),LGraphTextureOperation.registerPreset("max","max(color, colorB) * value"),LGraphTextureOperation.registerPreset("min","min(color, colorB) * value"),LGraphTextureOperation.registerPreset("displace","texture2D(u_texture, uv + (colorB.xy - vec2(0.5)) * value).xyz"),LGraphTextureOperation.registerPreset("grayscale","vec3(color.x + color.y + color.z) * value / 3.0"),LGraphTextureOperation.registerPreset("saturation","mix( vec3(color.x + color.y + color.z) / 3.0, color, value )"),LGraphTextureOperation.registerPreset("normalmap","\n    float z0 = texture2D(u_texture, uv + vec2(-texSize.z, -texSize.w) ).x;\n    float z1 = texture2D(u_texture, uv + vec2(0.0, -texSize.w) ).x;\n    float z2 = texture2D(u_texture, uv + vec2(texSize.z, -texSize.w) ).x;\n    float z3 = texture2D(u_texture, uv + vec2(-texSize.z, 0.0) ).x;\n    float z4 = color.x;\n    float z5 = texture2D(u_texture, uv + vec2(texSize.z, 0.0) ).x;\n    float z6 = texture2D(u_texture, uv + vec2(-texSize.z, texSize.w) ).x;\n    float z7 = texture2D(u_texture, uv + vec2(0.0, texSize.w) ).x;\n    float z8 = texture2D(u_texture, uv + vec2(texSize.z, texSize.w) ).x;\n    vec3 normal = vec3( z2 + 2.0*z4 + z7 - z0 - 2.0*z3 - z5, z5 + 2.0*z6 + z7 -z0 - 2.0*z1 - z2, 1.0 );\n    normal.xy *= value;\n    result.xyz = normalize(normal) * 0.5 + vec3(0.5);\n"),LGraphTextureOperation.registerPreset("threshold","vec3(color.x > colorB.x * value ? 1.0 : 0.0,color.y > colorB.y * value ? 1.0 : 0.0,color.z > colorB.z * value ? 1.0 : 0.0)"),LiteGraph.registerNodeType("texture/operation",LGraphTextureOperation);class LGraphTextureShader{constructor(){this.addOutput("out","Texture"),this.properties={code:"",u_value:1,u_color:[1,1,1,1],width:512,height:512,precision:LGraphTexture.DEFAULT},this.properties.code=LGraphTextureShader.pixel_shader,this._uniforms={u_value:1,u_color:vec4.create(),in_texture:0,texSize:vec4.create(),time:0}}static title="Shader";static desc="Texture shader";static widgets_info={code:{type:"code",lang:"glsl"},precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}};onPropertyChanged(name,_value){if("code"==name){var shader=this.getShader();if(shader){var i,uniforms=shader.uniformInfo;if(this.inputs){var already={};for(let i=0;i<this.inputs.length;++i){var info=this.getInputInfo(i);info&&(uniforms[info.name]&&!already[info.name]?already[info.name]=!0:(this.removeInput(i),i--))}}for(i in uniforms){let info=shader.uniformInfo[i];if(null!==info.loc&&"time"!=i){var type="number";if(this._shader.samplers[i])type="texture";else switch(info.size){case 1:type="number";break;case 2:type="vec2";break;case 3:type="vec3";break;case 4:type="vec4";break;case 9:type="mat3";break;case 16:type="mat4";break;default:continue}var input_info,slot=this.findInputSlot(i);-1!=slot&&(input_info=this.getInputInfo(slot))?input_info.type!=type&&(this.removeInput(slot,type),this.addInput(i,type)):this.addInput(i,type)}}}}}getShader(){if(!this._shader||this._shader_code!=this.properties.code){if(this._shader_code=this.properties.code,this._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,this.properties.code),!this._shader)return this.boxcolor="red",null;this.boxcolor="green"}return this._shader}onExecute(){if(this.isOutputConnected(0)){var shader=this.getShader();if(shader){var tex_slot=0,in_tex=null;if(this.inputs)for(var i=0;i<this.inputs.length;++i){var info=this.getInputInfo(i),data=this.getInputData(i);null!=data&&(data.constructor===GL.Texture&&(data.bind(tex_slot),in_tex=in_tex||data,data=tex_slot,tex_slot++),shader.setUniform(info.name,data))}var uniforms=this._uniforms,type=LGraphTexture.getTextureType(this.properties.precision,in_tex),w=0|this.properties.width,h=0|this.properties.height;0==w&&(w=(in_tex||gl.canvas).width),0==h&&(h=(in_tex||gl.canvas).height),uniforms.texSize[0]=w,uniforms.texSize[1]=h,uniforms.texSize[2]=1/w,uniforms.texSize[3]=1/h,uniforms.time=this.graph.getTime(),uniforms.u_value=this.properties.u_value,uniforms.u_color.set(this.properties.u_color),this._tex&&this._tex.type==type&&this._tex.width==w&&this._tex.height==h||(this._tex=new GL.Texture(w,h,{type:type,format:gl.RGBA,filter:gl.LINEAR})),this._tex.drawTo(function(){shader.uniforms(uniforms).draw(GL.Mesh.getScreenQuad())}),this.setOutputData(0,this._tex)}}}static pixel_shader=`
        precision highp float;
    
        varying vec2 v_coord;
        uniform float time; // time in seconds
        uniform vec4 texSize; // tex resolution
        uniform float u_value;
        uniform vec4 u_color;
    
        void main() {
            vec2 uv = v_coord;
            vec3 color = vec3(0.0);
            // Your custom code here
            color.xy = uv;
    
            gl_FragColor = vec4(color, 1.0);
        }
    `}LiteGraph.registerNodeType("texture/shader",LGraphTextureShader);class LGraphTextureScaleOffset{constructor(){this.addInput("in","Texture"),this.addInput("scale","vec2"),this.addInput("offset","vec2"),this.addOutput("out","Texture"),this.properties={offset:vec2.fromValues(0,0),scale:vec2.fromValues(1,1),precision:LGraphTexture.DEFAULT}}static widgets_info={precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}};static title="Scale/Offset";static desc="Applies an scaling and offseting";onExecute(){var width,height,type,shader,scale,offset,tex=this.getInputData(0);this.isOutputConnected(0)&&tex&&(this.properties.precision===LGraphTexture.PASS_THROUGH?this.setOutputData(0,tex):(width=tex.width,height=tex.height,type=this.precision===LGraphTexture.LOW?gl.UNSIGNED_BYTE:gl.HIGH_PRECISION_FORMAT,this.precision===LGraphTexture.DEFAULT&&(type=tex.type),this._tex&&this._tex.width==width&&this._tex.height==height&&this._tex.type==type||(this._tex=new GL.Texture(width,height,{type:type,format:gl.RGBA,filter:gl.LINEAR})),shader=(shader=this._shader)||new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,LGraphTextureScaleOffset.pixel_shader),(scale=this.getInputData(1))?(this.properties.scale[0]=scale[0],this.properties.scale[1]=scale[1]):scale=this.properties.scale,(offset=this.getInputData(2))?(this.properties.offset[0]=offset[0],this.properties.offset[1]=offset[1]):offset=this.properties.offset,this._tex.drawTo(function(){gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE),gl.disable(gl.BLEND),tex.bind(0);var mesh=Mesh.getScreenQuad();shader.uniforms({u_texture:0,u_scale:scale,u_offset:offset}).draw(mesh)}),this.setOutputData(0,this._tex)))}static pixel_shader=`
        precision highp float;
    
        uniform sampler2D u_texture;
        uniform sampler2D u_textureB;
        varying vec2 v_coord;
        uniform vec2 u_scale;
        uniform vec2 u_offset;
    
        void main() {
            vec2 uv = v_coord;
            uv = uv / u_scale - u_offset;
            gl_FragColor = texture2D(u_texture, uv);
        }
    `}LiteGraph.registerNodeType("texture/scaleOffset",LGraphTextureScaleOffset);class LGraphTextureWarp{constructor(){this.addInput("in","Texture"),this.addInput("warp","Texture"),this.addInput("factor","number"),this.addOutput("out","Texture"),this.properties={factor:.01,scale:[1,1],offset:[0,0],precision:LGraphTexture.DEFAULT},this._uniforms={u_texture:0,u_textureB:1,u_factor:1,u_scale:vec2.create(),u_offset:vec2.create()}}static widgets_info={precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}};static title="Warp";static desc="Texture warp operation";onExecute(){var texB,height,shader,width,uniforms,tex=this.getInputData(0);this.isOutputConnected(0)&&(this.properties.precision===LGraphTexture.PASS_THROUGH?this.setOutputData(0,tex):(texB=this.getInputData(1),height=width=512,tex?(width=tex.width,height=tex.height):texB&&(width=texB.width,height=texB.height),tex||this._tex?this._tex=LGraphTexture.getTargetTexture(tex||this._tex,this._tex,this.properties.precision):this._tex=new GL.Texture(width,height,{type:this.precision===LGraphTexture.LOW?gl.UNSIGNED_BYTE:gl.HIGH_PRECISION_FORMAT,format:gl.RGBA,filter:gl.LINEAR}),shader=(shader=this._shader)||new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,LGraphTextureWarp.pixel_shader),null!=(width=this.getInputData(2))?this.properties.factor=width:width=parseFloat(this.properties.factor),(uniforms=this._uniforms).u_factor=width,uniforms.u_scale.set(this.properties.scale),uniforms.u_offset.set(this.properties.offset),this._tex.drawTo(function(){gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE),gl.disable(gl.BLEND),tex&&tex.bind(0),texB&&texB.bind(1);var mesh=Mesh.getScreenQuad();shader.uniforms(uniforms).draw(mesh)}),this.setOutputData(0,this._tex)))}pixel_shader=`
        precision highp float;
    
        uniform sampler2D u_texture;
        uniform sampler2D u_textureB;
        varying vec2 v_coord;
        uniform float u_factor;
        uniform vec2 u_scale;
        uniform vec2 u_offset;
    
        void main() {
            vec2 uv = v_coord;
            uv += (texture2D(u_textureB, uv).rg - vec2(0.5)) * u_factor * u_scale + u_offset;
            gl_FragColor = texture2D(u_texture, uv);
        }
    `}LiteGraph.registerNodeType("texture/warp",LGraphTextureWarp);class LGraphTextureToViewport{constructor(){this.addInput("Texture","Texture"),this.properties={additive:!1,antialiasing:!1,filter:!0,disable_alpha:!1,gamma:1,viewport:[0,0,1,1]},this.size[0]=130}static title="to Viewport";static desc="Texture to viewport";static _prev_viewport=new Float32Array(4);onDrawBackground(ctx){var tex;this.flags.collapsed||this.size[1]<=40||(tex=this.getInputData(0))&&ctx.drawImage(ctx==gl?tex:gl.canvas,10,30,this.size[0]-20,this.size[1]-40)}onExecute(){var gamma,old_viewport,new_view,tex=this.getInputData(0);tex&&(this.properties.disable_alpha?gl.disable(gl.BLEND):(gl.enable(gl.BLEND),this.properties.additive?gl.blendFunc(gl.SRC_ALPHA,gl.ONE):gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA)),gl.disable(gl.DEPTH_TEST),gamma=this.properties.gamma||1,this.isInputConnected(1)&&(gamma=this.getInputData(1)),tex.setParameter(gl.TEXTURE_MAG_FILTER,this.properties.filter?gl.LINEAR:gl.NEAREST),(old_viewport=LGraphTextureToViewport._prev_viewport).set(gl.viewport_data),new_view=this.properties.viewport,gl.viewport(old_viewport[0]+old_viewport[2]*new_view[0],old_viewport[1]+old_viewport[3]*new_view[1],old_viewport[2]*new_view[2],old_viewport[3]*new_view[3]),this.properties.antialiasing?(LGraphTextureToViewport._shader||(LGraphTextureToViewport._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,LGraphTextureToViewport.aa_pixel_shader)),new_view=Mesh.getScreenQuad(),tex.bind(0),LGraphTextureToViewport._shader.uniforms({u_texture:0,uViewportSize:[tex.width,tex.height],u_igamma:1/gamma,inverseVP:[1/tex.width,1/tex.height]}).draw(new_view)):1!=gamma?(LGraphTextureToViewport._gamma_shader||(LGraphTextureToViewport._gamma_shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,LGraphTextureToViewport.gamma_pixel_shader)),tex.toViewport(LGraphTextureToViewport._gamma_shader,{u_texture:0,u_igamma:1/gamma})):tex.toViewport(),gl.viewport(old_viewport[0],old_viewport[1],old_viewport[2],old_viewport[3]))}onGetInputs(){return[["gamma","number"]]}static aa_pixel_shader=`
        precision highp float;
        varying vec2 v_coord;
        uniform sampler2D u_texture;
        uniform vec2 uViewportSize;
        uniform vec2 inverseVP;
        uniform float u_igamma;
        #define FXAA_REDUCE_MIN   (1.0/128.0)
        #define FXAA_REDUCE_MUL   (1.0/8.0)
        #define FXAA_SPAN_MAX     8.0
    
        vec4 applyFXAA(sampler2D tex, vec2 fragCoord) {
            vec4 color = vec4(0.0);
            vec3 rgbNW = texture2D(tex, (fragCoord + vec2(-1.0, -1.0)) * inverseVP).xyz;
            vec3 rgbNE = texture2D(tex, (fragCoord + vec2(1.0, -1.0)) * inverseVP).xyz;
            vec3 rgbSW = texture2D(tex, (fragCoord + vec2(-1.0, 1.0)) * inverseVP).xyz;
            vec3 rgbSE = texture2D(tex, (fragCoord + vec2(1.0, 1.0)) * inverseVP).xyz;
            vec3 rgbM  = texture2D(tex, fragCoord * inverseVP).xyz;
            vec3 luma = vec3(0.299, 0.587, 0.114);
            
            // Rest of the FXAA algorithm
            
            return color;
        }
    
        void main() {
            gl_FragColor = applyFXAA(u_texture, v_coord * uViewportSize);
        }
    `;static gamma_pixel_shader=`
        precision highp float;
        varying vec2 v_coord;
        uniform sampler2D u_texture;
        uniform float u_igamma;
    
        void main() {
            vec4 color = texture2D(u_texture, v_coord);
            color.xyz = pow(color.xyz, vec3(u_igamma));
            gl_FragColor = color;
        }
    `}LiteGraph.registerNodeType("texture/toviewport",LGraphTextureToViewport);class LGraphTextureCopy{constructor(){this.addInput("Texture","Texture"),this.addOutput("","Texture"),this.properties={size:0,generate_mipmaps:!1,precision:LGraphTexture.DEFAULT}}static title="Copy";static desc="Copy Texture";static widgets_info={size:{widget:"combo",values:[0,32,64,128,256,512,1024,2048]},precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}};onExecute(){var width,height,type,temp,tex=this.getInputData(0);(tex||this._temp_texture)&&this.isOutputConnected(0)&&(tex&&(width=tex.width,height=tex.height,0!=this.properties.size&&(width=this.properties.size,height=this.properties.size),temp=this._temp_texture,type=tex.type,this.properties.precision===LGraphTexture.LOW?type=gl.UNSIGNED_BYTE:this.properties.precision===LGraphTexture.HIGH&&(type=gl.HIGH_PRECISION_FORMAT),temp&&temp.width==width&&temp.height==height&&temp.type==type||(temp=gl.LINEAR,this.properties.generate_mipmaps&&GL.isPowerOfTwo(width)&&GL.isPowerOfTwo(height)&&(temp=gl.LINEAR_MIPMAP_LINEAR),this._temp_texture=new GL.Texture(width,height,{type:type,format:gl.RGBA,minFilter:temp,magFilter:gl.LINEAR})),tex.copyTo(this._temp_texture),this.properties.generate_mipmaps)&&(this._temp_texture.bind(0),gl.generateMipmap(this._temp_texture.texture_type),this._temp_texture.unbind(0)),this.setOutputData(0,this._temp_texture))}}LiteGraph.registerNodeType("texture/copy",LGraphTextureCopy);class LGraphTextureDownsample{constructor(){this.addInput("Texture","Texture"),this.addOutput("","Texture"),this.properties={iterations:1,generate_mipmaps:!1,precision:LGraphTexture.DEFAULT}}static title="Downsample";static desc="Downsample Texture";static widgets_info={iterations:{type:"number",step:1,precision:0,min:0},precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}};onExecute(){var tex=this.getInputData(0);if((tex||this._temp_texture)&&this.isOutputConnected(0)&&tex&&tex.texture_type===GL.TEXTURE_2D)if(this.properties.iterations<1)this.setOutputData(0,tex);else{var target,shader=LGraphTextureDownsample._shader,width=(shader||(LGraphTextureDownsample._shader=shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,LGraphTextureDownsample.pixel_shader)),0|tex.width),height=0|tex.height,type=tex.type,iterations=(this.properties.precision===LGraphTexture.LOW?type=gl.UNSIGNED_BYTE:this.properties.precision===LGraphTexture.HIGH&&(type=gl.HIGH_PRECISION_FORMAT),this.properties.iterations||1),origin=tex,temp=[],options={type:type,format:tex.format},offset=vec2.create(),uniforms={u_offset:offset};this._texture&&GL.Texture.releaseTemporary(this._texture);for(let i=0;i<iterations&&(offset[0]=1/width,offset[1]=1/height,width=width>>1||0,height=height>>1||0,target=GL.Texture.getTemporary(width,height,options),temp.push(target),origin.setParameter(GL.TEXTURE_MAG_FILTER,GL.NEAREST),origin.copyTo(target,shader,uniforms),1!=width||1!=height);++i)origin=target;this._texture=temp.pop();for(let i=0;i<temp.length;++i)GL.Texture.releaseTemporary(temp[i]);this.properties.generate_mipmaps&&(this._texture.bind(0),gl.generateMipmap(this._texture.texture_type),this._texture.unbind(0)),this.setOutputData(0,this._texture)}}static pixel_shader=`
        precision highp float;
        uniform sampler2D u_texture;
        uniform vec2 u_offset;
        varying vec2 v_coord;
    
        void main() {
            vec4 color = texture2D(u_texture, v_coord);
            color += texture2D(u_texture, v_coord + vec2(u_offset.x, 0.0));
            color += texture2D(u_texture, v_coord + vec2(0.0, u_offset.y));
            color += texture2D(u_texture, v_coord + u_offset);
            gl_FragColor = color * 0.25;
        }
    `}LiteGraph.registerNodeType("texture/downsample",LGraphTextureDownsample);class LGraphTextureResize{constructor(){this.addInput("Texture","Texture"),this.addOutput("","Texture"),this.properties={size:[512,512],generate_mipmaps:!1,precision:LGraphTexture.DEFAULT}}static title="Resize";static desc="Resize Texture";static widgets_info={iterations:{type:"number",step:1,precision:0,min:0},precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}};onExecute(){var width,height,type,tex=this.getInputData(0);(tex||this._temp_texture)&&this.isOutputConnected(0)&&tex&&tex.texture_type===GL.TEXTURE_2D&&(width=0|this.properties.size[0],height=0|this.properties.size[1],0==width&&(width=tex.width),0==height&&(height=tex.height),type=tex.type,this.properties.precision===LGraphTexture.LOW?type=gl.UNSIGNED_BYTE:this.properties.precision===LGraphTexture.HIGH&&(type=gl.HIGH_PRECISION_FORMAT),this._texture&&this._texture.width==width&&this._texture.height==height&&this._texture.type==type||(this._texture=new GL.Texture(width,height,{type:type})),tex.copyTo(this._texture),this.properties.generate_mipmaps&&(this._texture.bind(0),gl.generateMipmap(this._texture.texture_type),this._texture.unbind(0)),this.setOutputData(0,this._texture))}}LiteGraph.registerNodeType("texture/resize",LGraphTextureResize);class LGraphTextureAverage{constructor(){this.addInput("Texture","Texture"),this.addOutput("tex","Texture"),this.addOutput("avg","vec4"),this.addOutput("lum","number"),this.properties={use_previous_frame:!0,high_quality:!1},this._uniforms={u_texture:0,u_mipmap_offset:0},this._luminance=new Float32Array(4)}static title="Average";static desc="Compute a partial average (32 random samples) of a texture and stores it as a 1x1 pixel texture.\n If high_quality is true, then it generates the mipmaps first and reads from the lower one.";onExecute(){this.properties.use_previous_frame||this.updateAverage();var v=this._luminance;this.setOutputData(0,this._temp_texture),this.setOutputData(1,v),this.setOutputData(2,(v[0]+v[1]+v[2])/3)}onPreRenderExecute(){this.updateAverage()}updateAverage(){var tex=this.getInputData(0);if(tex&&(this.isOutputConnected(0)||this.isOutputConnected(1)||this.isOutputConnected(2))){if(!LGraphTextureAverage._shader){LGraphTextureAverage._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,LGraphTextureAverage.pixel_shader);for(var samples=new Float32Array(16),i=0;i<samples.length;++i)samples[i]=Math.random();LGraphTextureAverage._shader.uniforms({u_samples_a:samples.subarray(0,16),u_samples_b:samples.subarray(16,32)})}var v,temp=this._temp_texture,type=gl.UNSIGNED_BYTE,shader=(tex.type!=type&&(type=gl.FLOAT),temp&&temp.type==type||(this._temp_texture=new GL.Texture(1,1,{type:type,format:gl.RGBA,filter:gl.NEAREST})),this._uniforms.u_mipmap_offset=0,this.properties.high_quality&&(this._temp_pot2_texture&&this._temp_pot2_texture.type==type||(this._temp_pot2_texture=new GL.Texture(512,512,{type:type,format:gl.RGBA,minFilter:gl.LINEAR_MIPMAP_LINEAR,magFilter:gl.LINEAR})),tex.copyTo(this._temp_pot2_texture),(tex=this._temp_pot2_texture).bind(0),gl.generateMipmap(GL.TEXTURE_2D),this._uniforms.u_mipmap_offset=9),LGraphTextureAverage._shader),uniforms=this._uniforms;uniforms.u_mipmap_offset=this.properties.mipmap_offset,gl.disable(gl.DEPTH_TEST),gl.disable(gl.BLEND),this._temp_texture.drawTo(function(){tex.toViewport(shader,uniforms)}),(this.isOutputConnected(1)||this.isOutputConnected(2))&&(temp=this._temp_texture.getPixels())&&(v=this._luminance,type=this._temp_texture.type,v.set(temp),type==gl.UNSIGNED_BYTE?vec4.scale(v,v,1/255):type!=GL.HALF_FLOAT&&GL.HALF_FLOAT_OES)}}static pixel_shader=`
        precision highp float;
        uniform mat4 u_samples_a;
        uniform mat4 u_samples_b;
        uniform sampler2D u_texture;
        uniform float u_mipmap_offset;
        varying vec2 v_coord;
    
        void main() {
            vec4 color = vec4(0.0);
            
            // Random average
            for (int i = 0; i < 4; ++i) {
                for (int j = 0; j < 4; ++j) {
                    color += texture2D(u_texture, vec2(u_samples_a[i][j], u_samples_b[i][j]), u_mipmap_offset);
                    color += texture2D(u_texture, vec2(1.0 - u_samples_a[i][j], 1.0 - u_samples_b[i][j]), u_mipmap_offset);
                }
            }
            
            gl_FragColor = color * 0.03125;
        }
    `}LiteGraph.registerNodeType("texture/average",LGraphTextureAverage);class LGraphTextureMinMax{constructor(){this.addInput("Texture","Texture"),this.addOutput("min_t","Texture"),this.addOutput("max_t","Texture"),this.addOutput("min","vec4"),this.addOutput("max","vec4"),this.properties={mode:"max",use_previous_frame:!0},this._uniforms={u_texture:0},this._max=new Float32Array(4),this._min=new Float32Array(4),this._textures_chain=[]}static widgets_info={mode:{widget:"combo",values:["min","max","avg"]}};static title="MinMax";static desc="Compute the scene min max";onExecute(){this.properties.use_previous_frame||this.update(),this.setOutputData(0,this._temp_texture),this.setOutputData(1,this._luminance)}onPreRenderExecute(){this.update()}update(){var tex=this.getInputData(0);if(tex&&(this.isOutputConnected(0)||this.isOutputConnected(1))){LGraphTextureMinMax._shader||(LGraphTextureMinMax._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,LGraphTextureMinMax.pixel_shader));var type=gl.UNSIGNED_BYTE,size=(tex.type!=type&&(type=gl.FLOAT),512);if(!this._textures_chain.length||this._textures_chain[0].type!=type)for(;i&&(this._textures_chain[i]=new GL.Texture(size,size,{type:type,format:gl.RGBA,filter:gl.NEAREST}),i++,1!=(size>>=2)););tex.copyTo(this._textures_chain[0]);for(let i=1;i<=this._textures_chain.length;++i)tex=this._textures_chain[i];var shader=LGraphTextureMinMax._shader,uniforms=this._uniforms;uniforms.u_mipmap_offset=this.properties.mipmap_offset,gl.disable(gl.DEPTH_TEST),gl.disable(gl.BLEND),this._temp_texture.drawTo(function(){tex.toViewport(shader,uniforms)})}}static pixel_shader=`
        precision highp float;
        uniform mat4 u_samples_a;
        uniform mat4 u_samples_b;
        uniform sampler2D u_texture;
        uniform float u_mipmap_offset;
        varying vec2 v_coord;
    
        void main() {
            vec4 color = vec4(0.0);
    
            // Random average
            for (int i = 0; i < 4; ++i) {
                for (int j = 0; j < 4; ++j) {
                    vec2 sampleCoordA = vec2(u_samples_a[i][j], u_samples_b[i][j]);
                    vec2 sampleCoordB = vec2(1.0 - u_samples_a[i][j], 1.0 - u_samples_b[i][j]);
                    color += texture2D(u_texture, sampleCoordA, u_mipmap_offset);
                    color += texture2D(u_texture, sampleCoordB, u_mipmap_offset);
                }
            }
    
            gl_FragColor = color * 0.03125;
        }
    `}class LGraphTextureTemporalSmooth{constructor(){this.addInput("in","Texture"),this.addInput("factor","Number"),this.addOutput("out","Texture"),this.properties={factor:.5},this._uniforms={u_texture:0,u_textureB:1,u_factor:this.properties.factor}}static title="Smooth";static desc="Smooth texture over time";onExecute(){var temp,tempB,shader,uniforms,tex=this.getInputData(0);tex&&this.isOutputConnected(0)&&(LGraphTextureTemporalSmooth._shader||(LGraphTextureTemporalSmooth._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,LGraphTextureTemporalSmooth.pixel_shader)),(temp=this._temp_texture)&&temp.type==tex.type&&temp.width==tex.width&&temp.height==tex.height||(temp={type:tex.type,format:gl.RGBA,filter:gl.NEAREST},this._temp_texture=new GL.Texture(tex.width,tex.height,temp),this._temp_texture2=new GL.Texture(tex.width,tex.height,temp),tex.copyTo(this._temp_texture2)),temp=this._temp_texture,tempB=this._temp_texture2,shader=LGraphTextureTemporalSmooth._shader,(uniforms=this._uniforms).u_factor=1-this.getInputOrProperty("factor"),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),temp.drawTo(function(){tempB.bind(1),tex.toViewport(shader,uniforms)}),this.setOutputData(0,temp),this._temp_texture=tempB,this._temp_texture2=temp)}static pixel_shader="precision highp float;\n    precision highp float;\n    uniform sampler2D u_texture;\n    uniform sampler2D u_textureB;\n    uniform float u_factor;\n    varying vec2 v_coord;\n    \n    void main() {\n        gl_FragColor = mix( texture2D( u_texture, v_coord ), texture2D( u_textureB, v_coord ), u_factor );\n    }\n    "}LiteGraph.registerNodeType("texture/temporal_smooth",LGraphTextureTemporalSmooth);class LGraphTextureLinearAvgSmooth{constructor(){this.addInput("in","Texture"),this.addOutput("avg","Texture"),this.addOutput("array","Texture"),this.properties={samples:64,frames_interval:1},this._uniforms={u_texture:0,u_textureB:1,u_samples:this.properties.samples,u_isamples:1/this.properties.samples},this.frame=0}static title="Lineal Avg Smooth";static desc="Smooth texture linearly over time";static["@samples"]={type:"number",min:1,max:64,step:1,precision:1};getPreviewTexture(){return this._temp_texture2}onExecute(){var samples,frame,interval,tempA,tempB,shader_copy,shader_avg,uniforms,tex=this.getInputData(0);tex&&this.isOutputConnected(0)&&(LGraphTextureLinearAvgSmooth._shader||(LGraphTextureLinearAvgSmooth._shader_copy=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,LGraphTextureLinearAvgSmooth.pixel_shader_copy),LGraphTextureLinearAvgSmooth._shader_avg=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,LGraphTextureLinearAvgSmooth.pixel_shader_avg)),samples=clamp(this.properties.samples,0,64),frame=this.frame,0==(interval=this.properties.frames_interval)||frame%interval==0?((frame=this._temp_texture)&&frame.type==tex.type&&frame.width==samples||(interval={type:tex.type,format:gl.RGBA,filter:gl.NEAREST},this._temp_texture=new GL.Texture(samples,1,interval),this._temp_texture2=new GL.Texture(samples,1,interval),this._temp_texture_out=new GL.Texture(1,1,interval)),tempA=this._temp_texture,tempB=this._temp_texture2,shader_copy=LGraphTextureLinearAvgSmooth._shader_copy,shader_avg=LGraphTextureLinearAvgSmooth._shader_avg,(uniforms=this._uniforms).u_samples=samples,uniforms.u_isamples=1/samples,gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),tempA.drawTo(function(){tempB.bind(1),tex.toViewport(shader_copy,uniforms)}),this._temp_texture_out.drawTo(function(){tempA.toViewport(shader_avg,uniforms)}),this.setOutputData(0,this._temp_texture_out),this._temp_texture=tempB,this._temp_texture2=tempA):this.setOutputData(0,this._temp_texture_out),this.setOutputData(1,this._temp_texture2),this.frame++)}static pixel_shader_copy="precision highp float;\n    precision highp float;\n    uniform sampler2D u_texture;\n    uniform sampler2D u_textureB;\n    uniform float u_isamples;\n    varying vec2 v_coord;\n    \n    void main() {\n        if( v_coord.x <= u_isamples )\n            gl_FragColor = texture2D( u_texture, vec2(0.5) );\n        else\n            gl_FragColor = texture2D( u_textureB, v_coord - vec2(u_isamples,0.0) );\n    }\n    ";static pixel_shader_avg="precision highp float;\n    precision highp float;\n    uniform sampler2D u_texture;\n    uniform int u_samples;\n    uniform float u_isamples;\n    varying vec2 v_coord;\n    \n    void main() {\n        vec4 color = vec4(0.0);\n        for(int i = 0; i < 64; ++i)\n        {\n            color += texture2D( u_texture, vec2( float(i)*u_isamples,0.0) );\n            if(i == (u_samples - 1))\n                break;\n        }\n        gl_FragColor = color * u_isamples;\n    }\n    "}LiteGraph.registerNodeType("texture/linear_avg_smooth",LGraphTextureLinearAvgSmooth);class LGraphImageToTexture{constructor(){this.addInput("Image","image"),this.addOutput("","Texture"),this.properties={}}static title="Image to Texture";static desc="Uploads an image to the GPU";onExecute(){var img=this.getInputData(0);if(img){var width=img.videoWidth||img.width,height=img.videoHeight||img.height;if(img.gltexture)this.setOutputData(0,img.gltexture);else{var temp=this._temp_texture;temp&&temp.width==width&&temp.height==height||(this._temp_texture=new GL.Texture(width,height,{format:gl.RGBA,filter:gl.LINEAR}));try{this._temp_texture.uploadImage(img)}catch(err){return void console.error?.("image comes from an unsafe location, cannot be uploaded to webgl: "+err)}this.setOutputData(0,this._temp_texture)}}}}LiteGraph.registerNodeType("texture/imageToTexture",LGraphImageToTexture);class LGraphTextureLUT{constructor(){this.addInput("Texture","Texture"),this.addInput("LUT","Texture"),this.addInput("Intensity","number"),this.addOutput("","Texture"),this.properties={enabled:!0,intensity:1,precision:LGraphTexture.DEFAULT,texture:null},LGraphTextureLUT._shader||(LGraphTextureLUT._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,LGraphTextureLUT.pixel_shader))}static widgets_info={texture:{widget:"texture"},precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}};static title="LUT";static desc="Apply LUT to Texture";onExecute(){var tex,intensity,lut_tex;this.isOutputConnected(0)&&(tex=this.getInputData(0),this.properties.precision===LGraphTexture.PASS_THROUGH||!1===this.properties.enabled?this.setOutputData(0,tex):tex&&((lut_tex=(lut_tex=this.getInputData(1))||LGraphTexture.getTexture(this.properties.texture))?(lut_tex.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.bindTexture(gl.TEXTURE_2D,null),intensity=this.properties.intensity,this.isInputConnected(2)&&(this.properties.intensity=intensity=this.getInputData(2)),this._tex=LGraphTexture.getTargetTexture(tex,this._tex,this.properties.precision),this._tex.drawTo(function(){lut_tex.bind(1),tex.toViewport(LGraphTextureLUT._shader,{u_texture:0,u_textureB:1,u_amount:intensity})}),this.setOutputData(0,this._tex)):this.setOutputData(0,tex)))}static pixel_shader="precision highp float;\n    precision highp float;\n    varying vec2 v_coord;\n    uniform sampler2D u_texture;\n    uniform sampler2D u_textureB;\n    uniform float u_amount;\n    \n    void main() {\n            lowp vec4 textureColor = clamp( texture2D(u_texture, v_coord), vec4(0.0), vec4(1.0) );\n            mediump float blueColor = textureColor.b * 63.0;\n            mediump vec2 quad1;\n            quad1.y = floor(floor(blueColor) / 8.0);\n            quad1.x = floor(blueColor) - (quad1.y * 8.0);\n            mediump vec2 quad2;\n            quad2.y = floor(ceil(blueColor) / 8.0);\n            quad2.x = ceil(blueColor) - (quad2.y * 8.0);\n            highp vec2 texPos1;\n            texPos1.x = (quad1.x * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.r);\n            texPos1.y = 1.0 - ((quad1.y * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.g));\n            highp vec2 texPos2;\n            texPos2.x = (quad2.x * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.r);\n            texPos2.y = 1.0 - ((quad2.y * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.g));\n            lowp vec4 newColor1 = texture2D(u_textureB, texPos1);\n            lowp vec4 newColor2 = texture2D(u_textureB, texPos2);\n            lowp vec4 newColor = mix(newColor1, newColor2, fract(blueColor));\n            gl_FragColor = vec4( mix( textureColor.rgb, newColor.rgb, u_amount), textureColor.w);\n    }\n    "}LiteGraph.registerNodeType("texture/LUT",LGraphTextureLUT);class LGraphTextureEncode{constructor(){this.addInput("Texture","Texture"),this.addInput("Atlas","Texture"),this.addOutput("","Texture"),this.properties={enabled:!0,num_row_symbols:4,symbol_size:16,brightness:1,colorize:!1,filter:!1,invert:!1,precision:LGraphTexture.DEFAULT,generate_mipmaps:!1,texture:null},LGraphTextureEncode._shader||(LGraphTextureEncode._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,LGraphTextureEncode.pixel_shader)),this._uniforms={u_texture:0,u_textureB:1,u_row_simbols:4,u_simbol_size:16,u_res:vec2.create()}}static widgets_info={texture:{widget:"texture"},precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}};static title="Encode";static desc="Apply a texture atlas to encode a texture";onExecute(){var tex,uniforms,symbols_tex;this.isOutputConnected(0)&&(tex=this.getInputData(0),this.properties.precision===LGraphTexture.PASS_THROUGH||!1===this.properties.enabled?this.setOutputData(0,tex):tex&&((symbols_tex=(symbols_tex=this.getInputData(1))||LGraphTexture.getTexture(this.properties.texture))?(symbols_tex.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,this.properties.filter?gl.LINEAR:gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,this.properties.filter?gl.LINEAR:gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.bindTexture(gl.TEXTURE_2D,null),(uniforms=this._uniforms).u_row_simbols=Math.floor(this.properties.num_row_symbols),uniforms.u_symbol_size=this.properties.symbol_size,uniforms.u_brightness=this.properties.brightness,uniforms.u_invert=this.properties.invert?1:0,uniforms.u_colorize=this.properties.colorize?1:0,this._tex=LGraphTexture.getTargetTexture(tex,this._tex,this.properties.precision),uniforms.u_res[0]=this._tex.width,uniforms.u_res[1]=this._tex.height,this._tex.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),this._tex.drawTo(function(){symbols_tex.bind(1),tex.toViewport(LGraphTextureEncode._shader,uniforms)}),this.properties.generate_mipmaps&&(this._tex.bind(0),gl.generateMipmap(this._tex.texture_type),this._tex.unbind(0)),this.setOutputData(0,this._tex)):this.setOutputData(0,tex)))}static pixel_shader="precision highp float;\n    precision highp float;\n    varying vec2 v_coord;\n    uniform sampler2D u_texture;\n    uniform sampler2D u_textureB;\n    uniform float u_row_simbols;\n    uniform float u_symbol_size;\n    uniform float u_brightness;\n    uniform float u_invert;\n    uniform float u_colorize;\n    uniform vec2 u_res;\n    \n    void main() {\n        vec2 total_symbols = u_res / u_symbol_size;\n        vec2 uv = floor(v_coord * total_symbols) / total_symbols; //pixelate \n        vec2 local_uv = mod(v_coord * u_res, u_symbol_size) / u_symbol_size;\n        lowp vec4 textureColor = texture2D(u_texture, uv );\n        float lum = clamp(u_brightness * (textureColor.x + textureColor.y + textureColor.z)/3.0,0.0,1.0);\n        if( u_invert == 1.0 ) lum = 1.0 - lum;\n        float index = floor( lum * (u_row_simbols * u_row_simbols - 1.0));\n        float col = mod( index, u_row_simbols );\n        float row = u_row_simbols - floor( index / u_row_simbols ) - 1.0;\n        vec2 simbol_uv = ( vec2( col, row ) + local_uv ) / u_row_simbols;\n        vec4 color = texture2D( u_textureB, simbol_uv );\n        if(u_colorize == 1.0)\n            color *= textureColor;\n        gl_FragColor = color;\n    }\n    "}LiteGraph.registerNodeType("texture/encode",LGraphTextureEncode);class LGraphTextureChannels{constructor(){this.addInput("Texture","Texture"),this.addOutput("R","Texture"),this.addOutput("G","Texture"),this.addOutput("B","Texture"),this.addOutput("A","Texture"),LGraphTextureChannels._shader||(LGraphTextureChannels._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,LGraphTextureChannels.pixel_shader))}static title="Texture to Channels";static desc="Split texture channels";onExecute(){var texA=this.getInputData(0);if(texA){this._channels||(this._channels=Array(4));var format=gl.RGB,connections=0;for(let i=0;i<4;i++)this.isOutputConnected(i)?(this._channels[i]&&this._channels[i].width==texA.width&&this._channels[i].height==texA.height&&this._channels[i].type==texA.type&&this._channels[i].format==format||(this._channels[i]=new GL.Texture(texA.width,texA.height,{type:texA.type,format:format,filter:gl.LINEAR})),connections++):this._channels[i]=null;if(connections){gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var mesh=Mesh.getScreenQuad(),shader=LGraphTextureChannels._shader,masks=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]];for(let i=0;i<4;i++)this._channels[i]&&(this._channels[i].drawTo(function(){texA.bind(0),shader.uniforms({u_texture:0,u_mask:masks[i]}).draw(mesh)}),this.setOutputData(i,this._channels[i]))}}}static pixel_shader="precision highp float;\n        precision highp float;\n        varying vec2 v_coord;\n        uniform sampler2D u_texture;\n        uniform vec4 u_mask;\n        \n        void main() {\n            gl_FragColor = vec4( vec3( length( texture2D(u_texture, v_coord) * u_mask )), 1.0 );\n        }\n        "}LiteGraph.registerNodeType("texture/textureChannels",LGraphTextureChannels);class LGraphChannelsTexture{constructor(){this.addInput("R","Texture"),this.addInput("G","Texture"),this.addInput("B","Texture"),this.addInput("A","Texture"),this.addOutput("Texture","Texture"),this.properties={precision:LGraphTexture.DEFAULT,R:1,G:1,B:1,A:1},this._color=vec4.create(),this._uniforms={u_textureR:0,u_textureG:1,u_textureB:2,u_textureA:3,u_color:this._color}}static title="Channels to Texture";static desc="Split texture channels";static widgets_info={precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}};onExecute(){var white=LGraphTexture.getWhiteTexture(),texR=this.getInputData(0)||white,texG=this.getInputData(1)||white,texB=this.getInputData(2)||white,texA=this.getInputData(3)||white,mesh=(gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),Mesh.getScreenQuad()),shader=(LGraphChannelsTexture._shader||(LGraphChannelsTexture._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,LGraphChannelsTexture.pixel_shader)),LGraphChannelsTexture._shader),white=Math.max(texR.width,texG.width,texB.width,texA.width),h=Math.max(texR.height,texG.height,texB.height,texA.height),type=this.properties.precision==LGraphTexture.HIGH?LGraphTexture.HIGH_PRECISION_FORMAT:gl.UNSIGNED_BYTE,white=(this._texture&&this._texture.width==white&&this._texture.height==h&&this._texture.type==type||(this._texture=new GL.Texture(white,h,{type:type,format:gl.RGBA,filter:gl.LINEAR})),this._color),uniforms=(white[0]=this.properties.R,white[1]=this.properties.G,white[2]=this.properties.B,white[3]=this.properties.A,this._uniforms);this._texture.drawTo(function(){texR.bind(0),texG.bind(1),texB.bind(2),texA.bind(3),shader.uniforms(uniforms).draw(mesh)}),this.setOutputData(0,this._texture)}static pixel_shader="precision highp float;\n    precision highp float;\n    varying vec2 v_coord;\n    uniform sampler2D u_textureR;\n    uniform sampler2D u_textureG;\n    uniform sampler2D u_textureB;\n    uniform sampler2D u_textureA;\n    uniform vec4 u_color;\n    \n    void main() {\n        gl_FragColor = u_color * vec4(                 texture2D(u_textureR, v_coord).r,                texture2D(u_textureG, v_coord).r,                texture2D(u_textureB, v_coord).r,                texture2D(u_textureA, v_coord).r);\n    }\n    "}LiteGraph.registerNodeType("texture/channelsTexture",LGraphChannelsTexture);class LGraphTextureColor{constructor(){this.addOutput("Texture","Texture"),this._tex_color=vec4.create(),this.properties={color:vec4.create(),precision:LGraphTexture.DEFAULT}}static title="Color";static desc="Generates a 1x1 texture with a constant color";static widgets_info={precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}};onDrawBackground(ctx){var c=this.properties.color;ctx.fillStyle="rgb("+Math.floor(255*clamp(c[0],0,1))+","+Math.floor(255*clamp(c[1],0,1))+","+Math.floor(255*clamp(c[2],0,1))+")",this.flags.collapsed?this.boxcolor=ctx.fillStyle:ctx.fillRect(0,0,this.size[0],this.size[1])}onExecute(){var type=this.properties.precision==LGraphTexture.HIGH?LGraphTexture.HIGH_PRECISION_FORMAT:gl.UNSIGNED_BYTE,color=(this._tex&&this._tex.type==type||(this._tex=new GL.Texture(1,1,{format:gl.RGBA,type:type,minFilter:gl.NEAREST})),this.properties.color);if(this.inputs)for(var i=0;i<this.inputs.length;i++){var input=this.inputs[i],v=this.getInputData(i);if(void 0!==v)switch(input.name){case"RGB":case"RGBA":color.set(v);break;case"R":color[0]=v;break;case"G":color[1]=v;break;case"B":color[2]=v;break;case"A":color[3]=v}}.001<vec4.sqrDist(this._tex_color,color)&&(this._tex_color.set(color),this._tex.fill(color)),this.setOutputData(0,this._tex)}onGetInputs(){return[["RGB","vec3"],["RGBA","vec4"],["R","number"],["G","number"],["B","number"],["A","number"]]}}LiteGraph.registerNodeType("texture/color",LGraphTextureColor);class LGraphTextureGradient{constructor(){this.addInput("A","color"),this.addInput("B","color"),this.addOutput("Texture","Texture"),this.properties={angle:0,scale:1,A:[0,0,0],B:[1,1,1],texture_size:32},LGraphTextureGradient._shader||(LGraphTextureGradient._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,LGraphTextureGradient.pixel_shader)),this._uniforms={u_angle:0,u_colorA:vec3.create(),u_colorB:vec3.create()}}static title="Gradient";static desc="Generates a gradient";static["@A"]={type:"color"};static["@B"]={type:"color"};static["@texture_size"]={type:"enum",values:[32,64,128,256,512]};onExecute(){gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);for(var mesh=GL.Mesh.getScreenQuad(),shader=LGraphTextureGradient._shader,A=(A=this.getInputData(0))||this.properties.A,B=(B=this.getInputData(1))||this.properties.B,i=2;i<this.inputs.length;i++){var input=this.inputs[i],v=this.getInputData(i);void 0!==v&&(this.properties[input.name]=v)}var uniforms=this._uniforms,A=(this._uniforms.u_angle=this.properties.angle*DEG2RAD,this._uniforms.u_scale=this.properties.scale,vec3.copy(uniforms.u_colorA,A),vec3.copy(uniforms.u_colorB,B),parseInt(this.properties.texture_size));this._tex&&this._tex.width==A||(this._tex=new GL.Texture(A,A,{format:gl.RGB,filter:gl.LINEAR})),this._tex.drawTo(function(){shader.uniforms(uniforms).draw(mesh)}),this.setOutputData(0,this._tex)}onGetInputs(){return[["angle","number"],["scale","number"]]}static pixel_shader="precision highp float;\n        precision highp float;\n        varying vec2 v_coord;\n        uniform float u_angle;\n        uniform float u_scale;\n        uniform vec3 u_colorA;\n        uniform vec3 u_colorB;\n        \n        vec2 rotate(vec2 v, float angle)\n        {\n            vec2 result;\n            float _cos = cos(angle);\n            float _sin = sin(angle);\n            result.x = v.x * _cos - v.y * _sin;\n            result.y = v.x * _sin + v.y * _cos;\n            return result;\n        }\n        void main() {\n            float f = (rotate(u_scale * (v_coord - vec2(0.5)), u_angle) + vec2(0.5)).x;\n            vec3 color = mix(u_colorA,u_colorB,clamp(f,0.0,1.0));\n            gl_FragColor = vec4(color,1.0);\n        }\n        "}LiteGraph.registerNodeType("texture/gradient",LGraphTextureGradient);class LGraphTextureMix{constructor(){this.addInput("A","Texture"),this.addInput("B","Texture"),this.addInput("Mixer","Texture"),this.addOutput("Texture","Texture"),this.properties={factor:.5,size_from_biggest:!0,invert:!1,precision:LGraphTexture.DEFAULT},this._uniforms={u_textureA:0,u_textureB:1,u_textureMix:2,u_mix:vec4.create()}}static title="Mix";static desc="Generates a texture mixing two textures";static widgets_info={precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}};onExecute(){var texB,texMix,mesh,uniforms,shader,factor,invert,texA=this.getInputData(0);this.isOutputConnected(0)&&(this.properties.precision===LGraphTexture.PASS_THROUGH?this.setOutputData(0,texA):(texB=this.getInputData(1),texA&&texB&&(texMix=this.getInputData(2),factor=this.getInputData(3),this._tex=LGraphTexture.getTargetTexture(this.properties.size_from_biggest&&texB.width>texA.width?texB:texA,this._tex,this.properties.precision),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),mesh=Mesh.getScreenQuad(),shader=null,uniforms=this._uniforms,texMix?shader=(shader=LGraphTextureMix._shader_tex)||(LGraphTextureMix._shader_tex=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,LGraphTextureMix.pixel_shader,{MIX_TEX:""})):(shader=(shader=LGraphTextureMix._shader_factor)||(LGraphTextureMix._shader_factor=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,LGraphTextureMix.pixel_shader)),factor=null==factor?this.properties.factor:factor,uniforms.u_mix.set([factor,factor,factor,factor])),invert=this.properties.invert,this._tex.drawTo(function(){texA.bind(invert?1:0),texB.bind(invert?0:1),texMix&&texMix.bind(2),shader.uniforms(uniforms).draw(mesh)}),this.setOutputData(0,this._tex))))}onGetInputs(){return[["factor","number"]]}static pixel_shader="precision highp float;\n        precision highp float;\n        varying vec2 v_coord;\n        uniform sampler2D u_textureA;\n        uniform sampler2D u_textureB;\n        #ifdef MIX_TEX\n            uniform sampler2D u_textureMix;\n        #else\n            uniform vec4 u_mix;\n        #endif\n        \n        void main() {\n            #ifdef MIX_TEX\n                vec4 f = texture2D(u_textureMix, v_coord);\n            #else\n                vec4 f = u_mix;\n            #endif\n            gl_FragColor = mix( texture2D(u_textureA, v_coord), texture2D(u_textureB, v_coord), f );\n        }\n        "}LiteGraph.registerNodeType("texture/mix",LGraphTextureMix);class LGraphTextureEdges{constructor(){this.addInput("Tex.","Texture"),this.addOutput("Edges","Texture"),this.properties={invert:!0,threshold:!1,factor:1,precision:LGraphTexture.DEFAULT},LGraphTextureEdges._shader||(LGraphTextureEdges._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,LGraphTextureEdges.pixel_shader))}static title="Edges";static desc="Detects edges";static widgets_info={precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}};onExecute(){var tex,mesh,shader,invert,factor,threshold;this.isOutputConnected(0)&&(tex=this.getInputData(0),this.properties.precision===LGraphTexture.PASS_THROUGH?this.setOutputData(0,tex):tex&&(this._tex=LGraphTexture.getTargetTexture(tex,this._tex,this.properties.precision),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),mesh=Mesh.getScreenQuad(),shader=LGraphTextureEdges._shader,invert=this.properties.invert,factor=this.properties.factor,threshold=this.properties.threshold?1:0,this._tex.drawTo(function(){tex.bind(0),shader.uniforms({u_texture:0,u_isize:[1/tex.width,1/tex.height],u_factor:factor,u_threshold:threshold,u_invert:invert?1:0}).draw(mesh)}),this.setOutputData(0,this._tex)))}static pixel_shader="precision highp float;\n        precision highp float;\n        varying vec2 v_coord;\n        uniform sampler2D u_texture;\n        uniform vec2 u_isize;\n        uniform int u_invert;\n        uniform float u_factor;\n        uniform float u_threshold;\n        \n        void main() {\n            vec4 center = texture2D(u_texture, v_coord);\n            vec4 up = texture2D(u_texture, v_coord + u_isize * vec2(0.0,1.0) );\n            vec4 down = texture2D(u_texture, v_coord + u_isize * vec2(0.0,-1.0) );\n            vec4 left = texture2D(u_texture, v_coord + u_isize * vec2(1.0,0.0) );\n            vec4 right = texture2D(u_texture, v_coord + u_isize * vec2(-1.0,0.0) );\n            vec4 diff = abs(center - up) + abs(center - down) + abs(center - left) + abs(center - right);\n            diff *= u_factor;\n            if(u_invert == 1)\n                diff.xyz = vec3(1.0) - diff.xyz;\n            if( u_threshold == 0.0 )\n                gl_FragColor = vec4( diff.xyz, center.a );\n            else\n                gl_FragColor = vec4( diff.x > 0.5 ? 1.0 : 0.0, diff.y > 0.5 ? 1.0 : 0.0, diff.z > 0.5 ? 1.0 : 0.0, center.a );\n        }\n        "}LiteGraph.registerNodeType("texture/edges",LGraphTextureEdges);class LGraphTextureDepthRange{constructor(){this.addInput("Texture","Texture"),this.addInput("Distance","number"),this.addInput("Range","number"),this.addOutput("Texture","Texture"),this.properties={distance:100,range:50,only_depth:!1,high_precision:!1},this._uniforms={u_texture:0,u_distance:100,u_range:50,u_camera_planes:null}}static title="Depth Range";static desc="Generates a texture with a depth range";onExecute(){var tex,uniforms,range,mesh,shader,precision;this.isOutputConnected(0)&&(tex=this.getInputData(0))&&(precision=gl.UNSIGNED_BYTE,this.properties.high_precision&&(precision=gl.half_float_ext?gl.HALF_FLOAT_OES:gl.FLOAT),this._temp_texture&&this._temp_texture.type==precision&&this._temp_texture.width==tex.width&&this._temp_texture.height==tex.height||(this._temp_texture=new GL.Texture(tex.width,tex.height,{type:precision,format:gl.RGBA,filter:gl.LINEAR})),uniforms=this._uniforms,precision=this.properties.distance,this.isInputConnected(1)&&(precision=this.getInputData(1),this.properties.distance=precision),range=this.properties.range,this.isInputConnected(2)&&(range=this.getInputData(2),this.properties.range=range),uniforms.u_distance=precision,uniforms.u_range=range,gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),mesh=Mesh.getScreenQuad(),LGraphTextureDepthRange._shader||(LGraphTextureDepthRange._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,LGraphTextureDepthRange.pixel_shader),LGraphTextureDepthRange._shader_onlydepth=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,LGraphTextureDepthRange.pixel_shader,{ONLY_DEPTH:""})),shader=this.properties.only_depth?LGraphTextureDepthRange._shader_onlydepth:LGraphTextureDepthRange._shader,precision=null,precision=tex.near_far_planes||(window.LS&&LS.Renderer._main_camera?LS.Renderer._main_camera._uniforms.u_camera_planes:[.1,1e3]),uniforms.u_camera_planes=precision,this._temp_texture.drawTo(function(){tex.bind(0),shader.uniforms(uniforms).draw(mesh)}),this._temp_texture.near_far_planes=precision,this.setOutputData(0,this._temp_texture))}static pixel_shader="precision highp float;\n        precision highp float;\n        varying vec2 v_coord;\n        uniform sampler2D u_texture;\n        uniform vec2 u_camera_planes;\n        uniform float u_distance;\n        uniform float u_range;\n        \n        float LinearDepth()\n        {\n            float zNear = u_camera_planes.x;\n            float zFar = u_camera_planes.y;\n            float depth = texture2D(u_texture, v_coord).x;\n            depth = depth * 2.0 - 1.0;\n            return zNear * (depth + 1.0) / (zFar + zNear - depth * (zFar - zNear));\n        }\n        \n        void main() {\n            float depth = LinearDepth();\n            #ifdef ONLY_DEPTH\n                gl_FragColor = vec4(depth);\n            #else\n                float diff = abs(depth * u_camera_planes.y - u_distance);\n                float dof = 1.0;\n                if(diff <= u_range)\n                    dof = diff / u_range;\n                gl_FragColor = vec4(dof);\n            #endif\n        }\n    "}LiteGraph.registerNodeType("texture/depth_range",LGraphTextureDepthRange);class LGraphTextureLinearDepth{constructor(){this.addInput("Texture","Texture"),this.addOutput("Texture","Texture"),this.properties={precision:LGraphTexture.DEFAULT,invert:!1},this._uniforms={u_texture:0,u_camera_planes:null,u_ires:vec2.create()}}static widgets_info={precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}};static title="Linear Depth";static desc="Creates a color texture with linear depth";onExecute(){var tex,uniforms,mesh,shader,precision;!this.isOutputConnected(0)||!(tex=this.getInputData(0))||tex.format!=gl.DEPTH_COMPONENT&&tex.format!=gl.DEPTH_STENCIL||(precision=this.properties.precision==LGraphTexture.HIGH?gl.HIGH_PRECISION_FORMAT:gl.UNSIGNED_BYTE,this._temp_texture&&this._temp_texture.type==precision&&this._temp_texture.width==tex.width&&this._temp_texture.height==tex.height||(this._temp_texture=new GL.Texture(tex.width,tex.height,{type:precision,format:gl.RGB,filter:gl.LINEAR})),(uniforms=this._uniforms).u_invert=this.properties.invert?1:0,gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),mesh=Mesh.getScreenQuad(),LGraphTextureLinearDepth._shader||(LGraphTextureLinearDepth._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,LGraphTextureLinearDepth.pixel_shader)),shader=LGraphTextureLinearDepth._shader,precision=null,precision=tex.near_far_planes||(window.LS&&LS.Renderer._main_camera?LS.Renderer._main_camera._uniforms.u_camera_planes:[.1,1e3]),uniforms.u_camera_planes=precision,uniforms.u_ires.set([0,0]),this._temp_texture.drawTo(function(){tex.bind(0),shader.uniforms(uniforms).draw(mesh)}),this._temp_texture.near_far_planes=precision,this.setOutputData(0,this._temp_texture))}static pixel_shader="precision highp float;\n        precision highp float;\n        varying vec2 v_coord;\n        uniform sampler2D u_texture;\n        uniform vec2 u_camera_planes;\n        uniform int u_invert;\n        uniform vec2 u_ires;\n        \n        void main() {\n            float zNear = u_camera_planes.x;\n            float zFar = u_camera_planes.y;\n            float depth = texture2D(u_texture, v_coord + u_ires*0.5).x * 2.0 - 1.0;\n            float f = zNear * (depth + 1.0) / (zFar + zNear - depth * (zFar - zNear));\n            if( u_invert == 1 )\n                f = 1.0 - f;\n            gl_FragColor = vec4(vec3(f),1.0);\n        }\n        "}LiteGraph.registerNodeType("texture/linear_depth",LGraphTextureLinearDepth);class LGraphTextureBlur{constructor(){this.addInput("Texture","Texture"),this.addInput("Iterations","number"),this.addInput("Intensity","number"),this.addOutput("Blurred","Texture"),this.properties={intensity:1,iterations:1,preserve_aspect:!1,scale:[1,1],precision:LGraphTexture.DEFAULT}}static title="Blur";static desc="Blur a texture";static widgets_info={precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}};static max_iterations=20;onExecute(){var tex=this.getInputData(0);if(tex&&this.isOutputConnected(0)){var temp=this._final_texture,iterations=(temp&&temp.width==tex.width&&temp.height==tex.height&&temp.type==tex.type||(temp=this._final_texture=new GL.Texture(tex.width,tex.height,{type:tex.type,format:gl.RGBA,filter:gl.LINEAR})),this.properties.iterations);if(this.isInputConnected(1)&&(iterations=this.getInputData(1),this.properties.iterations=iterations),0==(iterations=Math.min(Math.floor(iterations),LGraphTextureBlur.max_iterations)))this.setOutputData(0,tex);else{var intensity=this.properties.intensity,aspect=(this.isInputConnected(2)&&(intensity=this.getInputData(2),this.properties.intensity=intensity),LiteGraph.camera_aspect),scale=(aspect=(aspect=aspect||void 0===window.gl?aspect:gl.canvas.height/gl.canvas.width)||1,aspect=this.properties.preserve_aspect?aspect:1,this.properties.scale||[1,1]);tex.applyBlur(aspect*scale[0],scale[1],intensity,temp);for(var i=1;i<iterations;++i)temp.applyBlur(aspect*scale[0]*(i+1),scale[1]*(i+1),intensity);this.setOutputData(0,temp)}}}}LiteGraph.registerNodeType("texture/blur",LGraphTextureBlur);class FXGlow{constructor(){this.intensity=.5,this.persistence=.6,this.iterations=8,this.threshold=.8,this.scale=1,this.dirt_texture=null,this.dirt_factor=.5,this._textures=[],this._uniforms={u_intensity:1,u_texture:0,u_glow_texture:1,u_threshold:0,u_texel_size:vec2.create()}}applyFX(tex,output_texture,glow_texture,average_texture){var width=tex.width,height=tex.height,texture_info={format:tex.format,type:tex.type,minFilter:GL.LINEAR,magFilter:GL.LINEAR,wrap:gl.CLAMP_TO_EDGE},uniforms=this._uniforms,textures=this._textures,shader=(shader=FXGlow._cut_shader)||(FXGlow._cut_shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,FXGlow.cut_pixel_shader));gl.disable(gl.DEPTH_TEST),gl.disable(gl.BLEND),uniforms.u_threshold=this.threshold;for(var dirt_texture,dirt_factor,currentDestination=textures[0]=GL.Texture.getTemporary(width,height,texture_info),currentSource=(tex.blit(currentDestination,shader.uniforms(uniforms)),currentDestination),iterations=this.iterations,iterations=0|clamp(iterations,1,16),texel_size=uniforms.u_texel_size,intensity=this.intensity,i=(uniforms.u_intensity=1,uniforms.u_delta=this.scale,shader=(shader=FXGlow._shader)||(FXGlow._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,FXGlow.scale_pixel_shader)),1);i<iterations&&(1<(0|height)&&(height>>=1),!((width>>=1)<2));i++)currentDestination=textures[i]=GL.Texture.getTemporary(width,height,texture_info),texel_size[0]=1/currentSource.width,texel_size[1]=1/currentSource.height,currentSource.blit(currentDestination,shader.uniforms(uniforms)),currentSource=currentDestination;for(average_texture&&(texel_size[0]=1/currentSource.width,texel_size[1]=1/currentSource.height,uniforms.u_intensity=intensity,uniforms.u_delta=1,currentSource.blit(average_texture,shader.uniforms(uniforms))),gl.enable(gl.BLEND),gl.blendFunc(gl.ONE,gl.ONE),uniforms.u_intensity=this.persistence,uniforms.u_delta=.5,i-=2;0<=i;i--)currentDestination=textures[i],textures[i]=null,texel_size[0]=1/currentSource.width,texel_size[1]=1/currentSource.height,currentSource.blit(currentDestination,shader.uniforms(uniforms)),GL.Texture.releaseTemporary(currentSource),currentSource=currentDestination;gl.disable(gl.BLEND),glow_texture&&currentSource.blit(glow_texture),output_texture&&(average_texture=output_texture,dirt_texture=this.dirt_texture,dirt_factor=this.dirt_factor,uniforms.u_intensity=intensity,shader=(shader=dirt_texture?FXGlow._dirt_final_shader:FXGlow._final_shader)||(dirt_texture?FXGlow._dirt_final_shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,FXGlow.final_pixel_shader,{USE_DIRT:""}):FXGlow._final_shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,FXGlow.final_pixel_shader)),average_texture.drawTo(function(){tex.bind(0),currentSource.bind(1),dirt_texture&&(shader.setUniform("u_dirt_factor",dirt_factor),shader.setUniform("u_dirt_texture",dirt_texture.bind(2))),shader.toViewport(uniforms)})),GL.Texture.releaseTemporary(currentSource)}static cut_pixel_shader="precision highp float;\n        varying vec2 v_coord;\n        uniform sampler2D u_texture;\n        uniform float u_threshold;\n        void main() {\n            gl_FragColor = max( texture2D( u_texture, v_coord ) - vec4( u_threshold ), vec4(0.0) );\n        }";static scale_pixel_shader="precision highp float;\n        varying vec2 v_coord;\n        uniform sampler2D u_texture;\n        uniform vec2 u_texel_size;\n        uniform float u_delta;\n        uniform float u_intensity;\n        \n        vec4 sampleBox(vec2 uv) {\n            vec4 o = u_texel_size.xyxy * vec2(-u_delta, u_delta).xxyy;\n            vec4 s = texture2D( u_texture, uv + o.xy ) + texture2D( u_texture, uv + o.zy) + texture2D( u_texture, uv + o.xw) + texture2D( u_texture, uv + o.zw);\n            return s * 0.25;\n        }\n        void main() {\n            gl_FragColor = u_intensity * sampleBox( v_coord );\n        }";static final_pixel_shader="precision highp float;\n        varying vec2 v_coord;\n        uniform sampler2D u_texture;\n        uniform sampler2D u_glow_texture;\n        #ifdef USE_DIRT\n            uniform sampler2D u_dirt_texture;\n        #endif\n        uniform vec2 u_texel_size;\n        uniform float u_delta;\n        uniform float u_intensity;\n        uniform float u_dirt_factor;\n        \n        vec4 sampleBox(vec2 uv) {\n            vec4 o = u_texel_size.xyxy * vec2(-u_delta, u_delta).xxyy;\n            vec4 s = texture2D( u_glow_texture, uv + o.xy ) + texture2D( u_glow_texture, uv + o.zy) + texture2D( u_glow_texture, uv + o.xw) + texture2D( u_glow_texture, uv + o.zw);\n            return s * 0.25;\n        }\n        void main() {\n            vec4 glow = sampleBox( v_coord );\n            #ifdef USE_DIRT\n                glow = mix( glow, glow * texture2D( u_dirt_texture, v_coord ), u_dirt_factor );\n            #endif\n            gl_FragColor = texture2D( u_texture, v_coord ) + u_intensity * glow;\n        }"}class LGraphTextureGlow{constructor(){this.addInput("in","Texture"),this.addInput("dirt","Texture"),this.addOutput("out","Texture"),this.addOutput("glow","Texture"),this.properties={enabled:!0,intensity:1,persistence:.99,iterations:16,threshold:0,scale:1,dirt_factor:.5,precision:LGraphTexture.DEFAULT},this.fx=new FXGlow}static title="Glow";static desc="Filters a texture giving it a glow effect";static widgets_info={iterations:{type:"number",min:0,max:16,step:1,precision:0},threshold:{type:"number",min:0,max:10,step:.01,precision:2},precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}};onGetInputs(){return[["enabled","boolean"],["threshold","number"],["intensity","number"],["persistence","number"],["iterations","number"],["dirt_factor","number"]]}onGetOutputs(){return[["average","Texture"]]}onExecute(){var fx,type,average_texture,glow_texture,final_texture,tex=this.getInputData(0);tex&&this.isAnyOutputConnected()&&(this.properties.precision===LGraphTexture.PASS_THROUGH||!1===this.getInputOrProperty("enabled")?this.setOutputData(0,tex):((fx=this.fx).threshold=this.getInputOrProperty("threshold"),fx.iterations=this.getInputOrProperty("iterations"),fx.intensity=this.getInputOrProperty("intensity"),fx.persistence=this.getInputOrProperty("persistence"),fx.dirt_texture=this.getInputData(1),fx.dirt_factor=this.getInputOrProperty("dirt_factor"),fx.scale=this.properties.scale,type=LGraphTexture.getTextureType(this.properties.precision,tex),average_texture=null,!this.isOutputConnected(2)||(average_texture=this._average_texture)&&average_texture.type==tex.type&&average_texture.format==tex.format||(average_texture=this._average_texture=new GL.Texture(1,1,{type:tex.type,format:tex.format,filter:gl.LINEAR})),glow_texture=null,!this.isOutputConnected(1)||(glow_texture=this._glow_texture)&&glow_texture.width==tex.width&&glow_texture.height==tex.height&&glow_texture.type==type&&glow_texture.format==tex.format||(glow_texture=this._glow_texture=new GL.Texture(tex.width,tex.height,{type:type,format:tex.format,filter:gl.LINEAR})),final_texture=null,!this.isOutputConnected(0)||(final_texture=this._final_texture)&&final_texture.width==tex.width&&final_texture.height==tex.height&&final_texture.type==type&&final_texture.format==tex.format||(final_texture=this._final_texture=new GL.Texture(tex.width,tex.height,{type:type,format:tex.format,filter:gl.LINEAR})),fx.applyFX(tex,final_texture,glow_texture,average_texture),this.isOutputConnected(0)&&this.setOutputData(0,final_texture),this.isOutputConnected(1)&&this.setOutputData(1,average_texture),this.isOutputConnected(2)&&this.setOutputData(2,glow_texture)))}}LiteGraph.registerNodeType("texture/glow",LGraphTextureGlow);class LGraphTextureKuwaharaFilter{static title="Kuwahara Filter";static desc="Filters a texture giving an artistic oil canvas painting";constructor(){this.addInput("Texture","Texture"),this.addOutput("Filtered","Texture"),this.properties={intensity:1,radius:5}}static max_radius=10;static _shaders=[];onExecute(){var intensity,aspect,shader,mesh,temp,tex=this.getInputData(0);tex&&this.isOutputConnected(0)&&((temp=this._temp_texture)&&temp.width==tex.width&&temp.height==tex.height&&temp.type==tex.type||(this._temp_texture=new GL.Texture(tex.width,tex.height,{type:tex.type,format:gl.RGBA,filter:gl.LINEAR})),temp=this.properties.radius,0==(temp=Math.min(Math.floor(temp),LGraphTextureKuwaharaFilter.max_radius))?this.setOutputData(0,tex):(intensity=this.properties.intensity,aspect=(aspect=(aspect=LiteGraph.camera_aspect)||void 0===window.gl?aspect:gl.canvas.height/gl.canvas.width)||1,aspect=this.properties.preserve_aspect?aspect:1,LGraphTextureKuwaharaFilter._shaders[temp]||(LGraphTextureKuwaharaFilter._shaders[temp]=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,LGraphTextureKuwaharaFilter.pixel_shader,{RADIUS:temp.toFixed(0)})),shader=LGraphTextureKuwaharaFilter._shaders[temp],mesh=GL.Mesh.getScreenQuad(),tex.bind(0),this._temp_texture.drawTo(function(){shader.uniforms({u_texture:0,u_intensity:intensity,u_resolution:[tex.width,tex.height],u_iResolution:[1/tex.width,1/tex.height]}).draw(mesh)}),this.setOutputData(0,this._temp_texture)))}static pixel_shader="\n    precision highp float;\n    varying vec2 v_coord;\n    uniform sampler2D u_texture;\n    uniform float u_intensity;\n    uniform vec2 u_resolution;\n    uniform vec2 u_iResolution;\n    #ifndef RADIUS\n    #define RADIUS 7\n    #endif\n    void main() {\n    \n    const int radius = RADIUS;\n    vec2 fragCoord = v_coord;\n    vec2 src_size = u_iResolution;\n    vec2 uv = v_coord;\n    float n = float((radius + 1) * (radius + 1));\n    int i;\n    int j;\n    vec3 m0 = vec3(0.0); vec3 m1 = vec3(0.0); vec3 m2 = vec3(0.0); vec3 m3 = vec3(0.0);\n    vec3 s0 = vec3(0.0); vec3 s1 = vec3(0.0); vec3 s2 = vec3(0.0); vec3 s3 = vec3(0.0);\n    vec3 c;\n    \n    for (int j = -radius; j <= 0; ++j)  {\n        for (int i = -radius; i <= 0; ++i)  {\n            c = texture2D(u_texture, uv + vec2(i,j) * src_size).rgb;\n            m0 += c;\n            s0 += c * c;\n        }\n    }\n    \n    for (int j = -radius; j <= 0; ++j)  {\n        for (int i = 0; i <= radius; ++i)  {\n            c = texture2D(u_texture, uv + vec2(i,j) * src_size).rgb;\n            m1 += c;\n            s1 += c * c;\n        }\n    }\n    \n    for (int j = 0; j <= radius; ++j)  {\n        for (int i = 0; i <= radius; ++i)  {\n            c = texture2D(u_texture, uv + vec2(i,j) * src_size).rgb;\n            m2 += c;\n            s2 += c * c;\n        }\n    }\n    \n    for (int j = 0; j <= radius; ++j)  {\n        for (int i = -radius; i <= 0; ++i)  {\n            c = texture2D(u_texture, uv + vec2(i,j) * src_size).rgb;\n            m3 += c;\n            s3 += c * c;\n        }\n    }\n    \n    float min_sigma2 = 1e+2;\n    m0 /= n;\n    s0 = abs(s0 / n - m0 * m0);\n    \n    float sigma2 = s0.r + s0.g + s0.b;\n    if (sigma2 < min_sigma2) {\n        min_sigma2 = sigma2;\n        gl_FragColor = vec4(m0, 1.0);\n    }\n    \n    m1 /= n;\n    s1 = abs(s1 / n - m1 * m1);\n    \n    sigma2 = s1.r + s1.g + s1.b;\n    if (sigma2 < min_sigma2) {\n        min_sigma2 = sigma2;\n        gl_FragColor = vec4(m1, 1.0);\n    }\n    \n    m2 /= n;\n    s2 = abs(s2 / n - m2 * m2);\n    \n    sigma2 = s2.r + s2.g + s2.b;\n    if (sigma2 < min_sigma2) {\n        min_sigma2 = sigma2;\n        gl_FragColor = vec4(m2, 1.0);\n    }\n    \n    m3 /= n;\n    s3 = abs(s3 / n - m3 * m3);\n    \n    sigma2 = s3.r + s3.g + s3.b;\n    if (sigma2 < min_sigma2) {\n        min_sigma2 = sigma2;\n        gl_FragColor = vec4(m3, 1.0);\n    }\n    }\n    "}LiteGraph.registerNodeType("texture/kuwahara",LGraphTextureKuwaharaFilter);class LGraphTextureXDoGFilter{static title="XDoG Filter";static desc="Filters a texture giving an artistic ink style";constructor(){this.addInput("Texture","Texture"),this.addOutput("Filtered","Texture"),this.properties={sigma:1.4,k:1.6,p:21.7,epsilon:79,phi:.017}}static max_radius=10;static _shaders=[];onExecute(){var temp,shader,mesh,sigma,k,p,epsilon,phi,tex=this.getInputData(0);tex&&this.isOutputConnected(0)&&((temp=this._temp_texture)&&temp.width==tex.width&&temp.height==tex.height&&temp.type==tex.type||(this._temp_texture=new GL.Texture(tex.width,tex.height,{type:tex.type,format:gl.RGBA,filter:gl.LINEAR})),LGraphTextureXDoGFilter._xdog_shader||(LGraphTextureXDoGFilter._xdog_shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,LGraphTextureXDoGFilter.xdog_pixel_shader)),shader=LGraphTextureXDoGFilter._xdog_shader,mesh=GL.Mesh.getScreenQuad(),sigma=this.properties.sigma,k=this.properties.k,p=this.properties.p,epsilon=this.properties.epsilon,phi=this.properties.phi,tex.bind(0),this._temp_texture.drawTo(function(){shader.uniforms({src:0,sigma:sigma,k:k,p:p,epsilon:epsilon,phi:phi,cvsWidth:tex.width,cvsHeight:tex.height}).draw(mesh)}),this.setOutputData(0,this._temp_texture))}static xdog_pixel_shader="\n    precision highp float;\n    uniform sampler2D src;\n\n    uniform float cvsHeight;\n    uniform float cvsWidth;\n\n    uniform float sigma;\n    uniform float k;\n    uniform float p;\n    uniform float epsilon;\n    uniform float phi;\n    varying vec2 v_coord;\n\n    float cosh(float val)\n    {\n    float tmp = exp(val);\n    float cosH = (tmp + 1.0 / tmp) / 2.0;\n    return cosH;\n    }\n\n    float tanh(float val)\n    {\n    float tmp = exp(val);\n    float tanH = (tmp - 1.0 / tmp) / (tmp + 1.0 / tmp);\n    return tanH;\n    }\n\n    float sinh(float val)\n    {\n    float tmp = exp(val);\n    float sinH = (tmp - 1.0 / tmp) / 2.0;\n    return sinH;\n    }\n\n    void main(void){\n    vec3 destColor = vec3(0.0);\n    float tFrag = 1.0 / cvsHeight;\n    float sFrag = 1.0 / cvsWidth;\n    vec2 Frag = vec2(sFrag,tFrag);\n    vec2 uv = gl_FragCoord.st;\n    float twoSigmaESquared = 2.0 * sigma * sigma;\n    float twoSigmaRSquared = twoSigmaESquared * k * k;\n    int halfWidth = int(ceil( 1.0 * sigma * k ));\n\n    const int MAX_NUM_ITERATION = 99999;\n    vec2 sum = vec2(0.0);\n    vec2 norm = vec2(0.0);\n\n    for(int cnt=0;cnt<MAX_NUM_ITERATION;cnt++){\n        if(cnt > (2*halfWidth+1)*(2*halfWidth+1)){break;}\n        int i = int(cnt / (2*halfWidth+1)) - halfWidth;\n        int j = cnt - halfWidth - int(cnt / (2*halfWidth+1)) * (2*halfWidth+1);\n\n        float d = length(vec2(i,j));\n        vec2 kernel = vec2( exp( -d * d / twoSigmaESquared ), \n                            exp( -d * d / twoSigmaRSquared ));\n\n        vec2 L = texture2D(src, (uv + vec2(i,j)) * Frag).xx;\n\n        norm += kernel;\n        sum += kernel * L;\n    }\n\n    sum /= norm;\n\n    float H = 100.0 * ((1.0 + p) * sum.x - p * sum.y);\n    float edge = ( H > epsilon )? 1.0 : 1.0 + tanh( phi * (H - epsilon));\n    destColor = vec3(edge);\n    gl_FragColor = vec4(destColor, 1.0);\n    }"}LiteGraph.registerNodeType("texture/xDoG",LGraphTextureXDoGFilter);class LGraphTextureWebcam{constructor(){this.addOutput("Webcam","Texture"),this.properties={texture_name:"",facingMode:"user"},this.boxcolor="black",this.version=0}static title="Webcam";static desc="Webcam texture";static is_webcam_open=!1;openStream(){var constraints,that;navigator.getUserMedia&&(constraints={audio:!(this._waiting_confirmation=!0),video:{facingMode:this.properties.facingMode}},navigator.mediaDevices.getUserMedia(constraints).then(this.streamReady.bind(this)).catch(function(e){LGraphTextureWebcam.is_webcam_open=!1,console.log?.("Webcam rejected",e),that._webcam_stream=!1,that.boxcolor="red",that.trigger("stream_error")}),that=this)}closeStream(){if(this._webcam_stream){var tracks=this._webcam_stream.getTracks();if(tracks.length)for(var i=0;i<tracks.length;++i)tracks[i].stop();LGraphTextureWebcam.is_webcam_open=!1,this._webcam_stream=null,this._video=null,this.boxcolor="black",this.trigger("stream_closed")}}streamReady(localMediaStream){this._webcam_stream=localMediaStream,this.boxcolor="green";var video=this._video;video||((video=document.createElement("video")).autoplay=!0,video.srcObject=localMediaStream,(this._video=video).onloadedmetadata=function(e){LGraphTextureWebcam.is_webcam_open=!0,console.log?.(e)}),this.trigger("stream_ready",video)}onPropertyChanged(name,value){"facingMode"==name&&(this.properties.facingMode=value,this.closeStream(),this.openStream())}onRemoved(){if(this._webcam_stream){var tracks=this._webcam_stream.getTracks();if(tracks.length)for(var i=0;i<tracks.length;++i)tracks[i].stop();this._webcam_stream=null,this._video=null}}onDrawBackground(ctx){this.flags.collapsed||this.size[1]<=20||this._video&&(ctx.save(),ctx.webgl?this._video_texture&&ctx.drawImage(this._video_texture,0,0,this.size[0],this.size[1]):ctx.drawImage(this._video,0,0,this.size[0],this.size[1]),ctx.restore())}onExecute(){if(null!=this._webcam_stream||this._waiting_confirmation||this.openStream(),this._video&&this._video.videoWidth){var width=this._video.videoWidth,height=this._video.videoHeight,temp=this._video_texture;temp&&temp.width==width&&temp.height==height||(this._video_texture=new GL.Texture(width,height,{format:gl.RGB,filter:gl.LINEAR})),this._video_texture.uploadImage(this._video),this._video_texture.version=++this.version,this.properties.texture_name&&(LGraphTexture.getTexturesContainer()[this.properties.texture_name]=this._video_texture),this.setOutputData(0,this._video_texture);for(var i=1;i<this.outputs.length;++i)if(this.outputs[i])switch(this.outputs[i].name){case"width":this.setOutputData(i,this._video.videoWidth);break;case"height":this.setOutputData(i,this._video.videoHeight)}}}onGetOutputs(){return[["width","number"],["height","number"],["stream_ready",LiteGraph.EVENT],["stream_closed",LiteGraph.EVENT],["stream_error",LiteGraph.EVENT]]}}LiteGraph.registerNodeType("texture/webcam",LGraphTextureWebcam);class LGraphLensFX{constructor(){this.addInput("in","Texture"),this.addInput("f","number"),this.addOutput("out","Texture"),this.properties={enabled:!0,factor:1,precision:LGraphTexture.LOW},this._uniforms={u_texture:0,u_factor:1}}static title="Lens FX";static desc="distortion and chromatic aberration";static widgets_info={precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}};onGetInputs(){return[["enabled","boolean"]]}onExecute(){var temp,shader,factor,uniforms,tex=this.getInputData(0);tex&&this.isOutputConnected(0)&&(this.properties.precision===LGraphTexture.PASS_THROUGH||!1===this.getInputOrProperty("enabled")?this.setOutputData(0,tex):((temp=this._temp_texture)&&temp.width==tex.width&&temp.height==tex.height&&temp.type==tex.type||(temp=this._temp_texture=new GL.Texture(tex.width,tex.height,{type:tex.type,format:gl.RGBA,filter:gl.LINEAR})),shader=(shader=LGraphLensFX._shader)||(LGraphLensFX._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,LGraphLensFX.pixel_shader)),null==(factor=this.getInputData(1))&&(factor=this.properties.factor),(uniforms=this._uniforms).u_factor=factor,gl.disable(gl.DEPTH_TEST),temp.drawTo(function(){tex.bind(0),shader.uniforms(uniforms).draw(GL.Mesh.getScreenQuad())}),this.setOutputData(0,temp)))}static pixel_shader="precision highp float;\n    varying vec2 v_coord;\n    uniform sampler2D u_texture;\n    uniform float u_factor;\n    vec2 barrelDistortion(vec2 coord, float amt) {\n        vec2 cc = coord - 0.5;\n        float dist = dot(cc, cc);\n        return coord + cc * dist * amt;\n    }\n    \n    float sat( float t )\n    {\n        return clamp( t, 0.0, 1.0 );\n    }\n    \n    float linterp( float t ) {\n        return sat( 1.0 - abs( 2.0*t - 1.0 ) );\n    }\n    \n    float remap( float t, float a, float b ) {\n        return sat( (t - a) / (b - a) );\n    }\n    \n    vec4 spectrum_offset( float t ) {\n        vec4 ret;\n        float lo = step(t,0.5);\n        float hi = 1.0-lo;\n        float w = linterp( remap( t, 1.0/6.0, 5.0/6.0 ) );\n        ret = vec4(lo,1.0,hi, 1.) * vec4(1.0-w, w, 1.0-w, 1.);\n    \n        return pow( ret, vec4(1.0/2.2) );\n    }\n    \n    const float max_distort = 2.2;\n    const int num_iter = 12;\n    const float reci_num_iter_f = 1.0 / float(num_iter);\n    \n    void main()\n    {\t\n        vec2 uv=v_coord;\n        vec4 sumcol = vec4(0.0);\n        vec4 sumw = vec4(0.0);\t\n        for ( int i=0; i<num_iter;++i )\n        {\n            float t = float(i) * reci_num_iter_f;\n            vec4 w = spectrum_offset( t );\n            sumw += w;\n            sumcol += w * texture2D( u_texture, barrelDistortion(uv, .6 * max_distort*t * u_factor ) );\n        }\n        gl_FragColor = sumcol / sumw;\n    }"}LiteGraph.registerNodeType("texture/lensfx",LGraphLensFX);class LGraphTextureFromData{static title="Data->Tex";static desc="Generates or applies a curve to a texture";constructor(){this.addInput("in",""),this.properties={precision:LGraphTexture.LOW,width:0,height:0,channels:1},this.addOutput("out","Texture")}static widgets_info={precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}};onExecute(){var data,w,h,format,channels,type;this.isOutputConnected(0)&&(data=this.getInputData(0))&&(channels=this.properties.channels,w=this.properties.width,h=this.properties.height,w&&h||(w=Math.floor(data.length/channels),h=1),format=gl.RGBA,3==channels?format=gl.RGB:1==channels&&(format=gl.LUMINANCE),channels=this._temp_texture,type=LGraphTexture.getTextureType(this.properties.precision),(channels=channels&&channels.width==w&&channels.height==h&&channels.type==type?channels:this._temp_texture=new GL.Texture(w,h,{type:type,format:format,filter:gl.LINEAR})).uploadData(data),this.setOutputData(0,channels))}}LiteGraph.registerNodeType("texture/fromdata",LGraphTextureFromData);class LGraphTextureCurve{static title="Curve";static desc="Generates or applies a curve to a texture";constructor(){this.addInput("in","Texture"),this.addOutput("out","Texture"),this.properties={precision:LGraphTexture.LOW,split_channels:!1},this._values=new Uint8Array(1024),this._values.fill(255),this._curve_texture=null,this._uniforms={u_texture:0,u_curve:1,u_range:1},this._must_update=!0,this._points={RGB:[[0,0],[1,1]],R:[[0,0],[1,1]],G:[[0,0],[1,1]],B:[[0,0],[1,1]]},this.curve_editor=null,this.addWidget("toggle","Split Channels",!1,"split_channels"),this.addWidget("combo","Channel","RGB",{values:["RGB","R","G","B"]}),this.curve_offset=68,this.size=[240,160]}static widgets_info={precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}};onExecute(){var tex,temp,type,shader,uniforms,curve_texture;this.isOutputConnected(0)&&(tex=this.getInputData(0),temp=this._temp_texture,tex?(type=LGraphTexture.getTextureType(this.properties.precision,tex),temp&&temp.type==type&&temp.width==tex.width&&temp.height==tex.height&&temp.format==tex.format||(temp=this._temp_texture=new GL.Texture(tex.width,tex.height,{type:type,format:tex.format,filter:gl.LINEAR})),shader=(shader=LGraphTextureCurve._shader)||(LGraphTextureCurve._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,LGraphTextureCurve.pixel_shader)),!this._must_update&&this._curve_texture||this.updateCurve(),uniforms=this._uniforms,curve_texture=this._curve_texture,temp.drawTo(function(){gl.disable(gl.DEPTH_TEST),tex.bind(0),curve_texture.bind(1),shader.uniforms(uniforms).draw(GL.Mesh.getScreenQuad())}),this.setOutputData(0,temp)):(!this._must_update&&this._curve_texture||this.updateCurve(),this.setOutputData(0,this._curve_texture)))}sampleCurve(f,points){if(points||=this._points.RGB){for(var i=0;i<points.length-1;++i){var r,p=points[i],pn=points[i+1];if(!(pn[0]<f))return r=pn[0]-p[0],Math.abs(r)<1e-5?p[1]:(r=(f-p[0])/r,p[1]*(1-r)+pn[1]*r)}return 0}}updateCurve(){for(var v,values=this._values,num=values.length/4,split=this.properties.split_channels,i=0;i<num;++i)split?(values[4*i]=clamp(255*this.sampleCurve(i/num,this._points.R),0,255),values[4*i+1]=clamp(255*this.sampleCurve(i/num,this._points.G),0,255),values[4*i+2]=clamp(255*this.sampleCurve(i/num,this._points.B),0,255)):(v=this.sampleCurve(i/num),values[4*i]=values[4*i+1]=values[4*i+2]=clamp(255*v,0,255)),values[4*i+3]=255;this._curve_texture||(this._curve_texture=new GL.Texture(256,1,{format:gl.RGBA,magFilter:gl.LINEAR,wrap:gl.CLAMP_TO_EDGE})),this._curve_texture.uploadData(values,null,!0)}onSerialize(o){var i,curves={};for(i in this._points)curves[i]=this._points[i].concat();o.curves=curves}onConfigure(o){this._points=o.curves,this.curve_editor&&(curve_editor.points=this._points),this._must_update=!0}onMouseDown(e,localpos,graphcanvas){if(this.curve_editor)return(localpos=this.curve_editor.onMouseDown([localpos[0],localpos[1]-this.curve_offset],graphcanvas))&&this.captureInput(!0),localpos}onMouseMove(e,localpos,graphcanvas){if(this.curve_editor)return this.curve_editor.onMouseMove([localpos[0],localpos[1]-this.curve_offset],graphcanvas)}onMouseUp(e,localpos,graphcanvas){if(this.curve_editor)return this.curve_editor.onMouseUp([localpos[0],localpos[1]-this.curve_offset],graphcanvas);this.captureInput(!1)}static channel_line_colors={RGB:"#666",R:"#F33",G:"#3F3",B:"#33F"};onDrawBackground(ctx,graphcanvas){var channel;this.flags.collapsed||(this.curve_editor||(this.curve_editor=new LiteGraph.CurveEditor(this._points.R)),ctx.save(),ctx.translate(0,this.curve_offset),channel=this.widgets[1].value,this.properties.split_channels?("RGB"==channel&&(this.widgets[1].value=channel="R",this.widgets[1].disabled=!1),this.curve_editor.points=this._points.R,this.curve_editor.draw(ctx,[this.size[0],this.size[1]-this.curve_offset],graphcanvas,"#111",LGraphTextureCurve.channel_line_colors.R,!0),ctx.globalCompositeOperation="lighten",this.curve_editor.points=this._points.G,this.curve_editor.draw(ctx,[this.size[0],this.size[1]-this.curve_offset],graphcanvas,null,LGraphTextureCurve.channel_line_colors.G,!0),this.curve_editor.points=this._points.B,this.curve_editor.draw(ctx,[this.size[0],this.size[1]-this.curve_offset],graphcanvas,null,LGraphTextureCurve.channel_line_colors.B,!0),ctx.globalCompositeOperation="source-over"):(this.widgets[1].value=channel="RGB",this.widgets[1].disabled=!0),this.curve_editor.points=this._points[channel],this.curve_editor.draw(ctx,[this.size[0],this.size[1]-this.curve_offset],graphcanvas,this.properties.split_channels?null:"#111",LGraphTextureCurve.channel_line_colors[channel]),ctx.restore())}pixel_shader="precision highp float;\n        varying vec2 v_coord;\n        uniform sampler2D u_texture;\n        uniform sampler2D u_curve;\n        uniform float u_range;\n        \n        void main() {\n            vec4 color = texture2D( u_texture, v_coord ) * u_range;\n            color.x = texture2D( u_curve, vec2( color.x, 0.5 ) ).x;\n            color.y = texture2D( u_curve, vec2( color.y, 0.5 ) ).y;\n            color.z = texture2D( u_curve, vec2( color.z, 0.5 ) ).z;\n            //color.w = texture2D( u_curve, vec2( color.w, 0.5 ) ).w;\n            gl_FragColor = color;\n        }"}LiteGraph.registerNodeType("texture/curve",LGraphTextureCurve);class LGraphExposition{constructor(){this.addInput("in","Texture"),this.addInput("exp","number"),this.addOutput("out","Texture"),this.properties={exposition:1,precision:LGraphTexture.LOW},this._uniforms={u_texture:0,u_exposition:1}}static title="Exposition";static desc="Controls texture exposition";static widgets_info={exposition:{widget:"slider",min:0,max:3},precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}};onExecute(){var temp,shader,exp_input,uniforms,tex=this.getInputData(0);tex&&this.isOutputConnected(0)&&((temp=this._temp_texture)&&temp.width==tex.width&&temp.height==tex.height&&temp.type==tex.type||(temp=this._temp_texture=new GL.Texture(tex.width,tex.height,{type:tex.type,format:gl.RGBA,filter:gl.LINEAR})),shader=(shader=LGraphExposition._shader)||(LGraphExposition._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,LGraphExposition.pixel_shader)),this.properties.exposition,null!=(exp_input=this.getInputData(1))&&(this.properties.exposition=exp_input),uniforms=this._uniforms,temp.drawTo(function(){gl.disable(gl.DEPTH_TEST),tex.bind(0),shader.uniforms(uniforms).draw(GL.Mesh.getScreenQuad())}),this.setOutputData(0,temp))}static pixel_shader=`
        precision highp float;
        varying vec2 v_coord;
        uniform sampler2D u_texture;
        uniform float u_exposition;
    
        void main() {
            vec4 color = texture2D(u_texture, v_coord);
            gl_FragColor = vec4(color.xyz * u_exposition, color.a);
        }
    `}LiteGraph.registerNodeType("texture/exposition",LGraphExposition);class LGraphToneMapping{constructor(){this.addInput("in","Texture"),this.addInput("avg","number,Texture"),this.addOutput("out","Texture"),this.properties={enabled:!0,scale:1,gamma:1,average_lum:1,lum_white:1,precision:LGraphTexture.LOW},this._uniforms={u_texture:0,u_lumwhite2:1,u_igamma:1,u_scale:1,u_average_lum:1}}static title="Tone Mapping";static desc="Applies Tone Mapping to convert from high to low";static widgets_info={precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}};onGetInputs(){return[["enabled","boolean"]]}onExecute(){var temp,avg,uniforms,shader,tex=this.getInputData(0);tex&&this.isOutputConnected(0)&&(this.properties.precision===LGraphTexture.PASS_THROUGH||!1===this.getInputOrProperty("enabled")?this.setOutputData(0,tex):((temp=this._temp_texture)&&temp.width==tex.width&&temp.height==tex.height&&temp.type==tex.type||(temp=this._temp_texture=new GL.Texture(tex.width,tex.height,{type:tex.type,format:gl.RGBA,filter:gl.LINEAR})),null==(avg=this.getInputData(1))&&(avg=this.properties.average_lum),uniforms=this._uniforms,shader=null,avg.constructor===Number?(this.properties.average_lum=avg,uniforms.u_average_lum=this.properties.average_lum,shader=(shader=LGraphToneMapping._shader)||(LGraphToneMapping._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,LGraphToneMapping.pixel_shader))):avg.constructor===GL.Texture&&(uniforms.u_average_texture=avg.bind(1),shader=(shader=LGraphToneMapping._shader_texture)||(LGraphToneMapping._shader_texture=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,LGraphToneMapping.pixel_shader,{AVG_TEXTURE:""}))),uniforms.u_lumwhite2=this.properties.lum_white*this.properties.lum_white,uniforms.u_scale=this.properties.scale,uniforms.u_igamma=1/this.properties.gamma,gl.disable(gl.DEPTH_TEST),temp.drawTo(function(){tex.bind(0),shader.uniforms(uniforms).draw(GL.Mesh.getScreenQuad())}),this.setOutputData(0,this._temp_texture)))}static pixel_shader="precision highp float;\n    varying vec2 v_coord;\n    uniform sampler2D u_texture;\n    uniform float u_scale;\n    #ifdef AVG_TEXTURE\n        uniform sampler2D u_average_texture;\n    #else\n        uniform float u_average_lum;\n    #endif\n    uniform float u_lumwhite2;\n    uniform float u_igamma;\n    vec3 RGB2xyY (vec3 rgb)\n    {\n            const mat3 RGB2XYZ = mat3(0.4124, 0.3576, 0.1805,\n                                    0.2126, 0.7152, 0.0722,\n                                    0.0193, 0.1192, 0.9505);\n        vec3 XYZ = RGB2XYZ * rgb;\n        \n        float f = (XYZ.x + XYZ.y + XYZ.z);\n        return vec3(XYZ.x / f,\n                    XYZ.y / f,\n                    XYZ.y);\n    }\n    \n    void main() {\n        vec4 color = texture2D( u_texture, v_coord );\n        vec3 rgb = color.xyz;\n        float average_lum = 0.0;\n        #ifdef AVG_TEXTURE\n            vec3 pixel = texture2D(u_average_texture,vec2(0.5)).xyz;\n            average_lum = (pixel.x + pixel.y + pixel.z) / 3.0;\n        #else\n            average_lum = u_average_lum;\n        #endif\n        //Ld - this part of the code is the same for both versions\n        float lum = dot(rgb, vec3(0.2126, 0.7152, 0.0722));\n        float L = (u_scale / average_lum) * lum;\n        float Ld = (L * (1.0 + L / u_lumwhite2)) / (1.0 + L);\n        //first\n        //vec3 xyY = RGB2xyY(rgb);\n        //xyY.z *= Ld;\n        //rgb = xyYtoRGB(xyY);\n        //second\n        rgb = (rgb / lum) * Ld;\n        rgb = max(rgb,vec3(0.001));\n        rgb = pow( rgb, vec3( u_igamma ) );\n        gl_FragColor = vec4( rgb, color.a );\n    }"}LiteGraph.registerNodeType("texture/tonemapping",LGraphToneMapping);class LGraphTexturePerlin{constructor(){this.addOutput("out","Texture"),this.properties={width:512,height:512,seed:0,persistence:.1,octaves:8,scale:1,offset:[0,0],amplitude:1,precision:LGraphTexture.DEFAULT},this._key=0,this._texture=null,this._uniforms={u_persistence:.1,u_seed:0,u_offset:vec2.create(),u_scale:1,u_viewport:vec2.create()}}static title="Perlin";static desc="Generates a perlin noise texture";static widgets_info={precision:{widget:"combo",values:LGraphTexture.MODE_VALUES},width:{type:"number",precision:0,step:1},height:{type:"number",precision:0,step:1},octaves:{type:"number",precision:0,step:1,min:1,max:50}};onGetInputs(){return[["seed","number"],["persistence","number"],["octaves","number"],["scale","number"],["amplitude","number"],["offset","vec2"]]}onExecute(){var w,h,temp,persistence,octaves,offset,scale,amplitude,type,key,uniforms,shader;this.isOutputConnected(0)&&(w=0|this.properties.width,h=0|this.properties.height,0==w&&(w=gl.viewport_data[2]),0==h&&(h=gl.viewport_data[3]),type=LGraphTexture.getTextureType(this.properties.precision),(temp=this._texture)&&temp.width==w&&temp.height==h&&temp.type==type||(temp=this._texture=new GL.Texture(w,h,{type:type,format:gl.RGB,filter:gl.LINEAR})),persistence=this.getInputOrProperty("persistence"),octaves=this.getInputOrProperty("octaves"),offset=this.getInputOrProperty("offset"),scale=this.getInputOrProperty("scale"),amplitude=this.getInputOrProperty("amplitude"),(key=""+w+h+type+persistence+octaves+scale+(type=this.getInputOrProperty("seed"))+offset[0]+offset[1]+amplitude)!=this._key&&(this._key=key,(uniforms=this._uniforms).u_persistence=persistence,uniforms.u_octaves=octaves,uniforms.u_offset.set(offset),uniforms.u_scale=scale,uniforms.u_amplitude=amplitude,uniforms.u_seed=128*type,uniforms.u_viewport[0]=w,uniforms.u_viewport[1]=h,shader=(shader=LGraphTexturePerlin._shader)||(LGraphTexturePerlin._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,LGraphTexturePerlin.pixel_shader)),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),temp.drawTo(function(){shader.uniforms(uniforms).draw(GL.Mesh.getScreenQuad())})),this.setOutputData(0,temp))}static pixel_shader="precision highp float;\n        varying vec2 v_coord;\n        uniform vec2 u_offset;\n        uniform float u_scale;\n        uniform float u_persistence;\n        uniform int u_octaves;\n        uniform float u_amplitude;\n        uniform vec2 u_viewport;\n        uniform float u_seed;\n        #define M_PI 3.14159265358979323846\n        \n        float rand(vec2 c){\treturn fract(sin(dot(c.xy ,vec2( 12.9898 + u_seed,78.233 + u_seed))) * 43758.5453); }\n        \n        float noise(vec2 p, float freq ){\n            float unit = u_viewport.x/freq;\n            vec2 ij = floor(p/unit);\n            vec2 xy = mod(p,unit)/unit;\n            //xy = 3.*xy*xy-2.*xy*xy*xy;\n            xy = .5*(1.-cos(M_PI*xy));\n            float a = rand((ij+vec2(0.,0.)));\n            float b = rand((ij+vec2(1.,0.)));\n            float c = rand((ij+vec2(0.,1.)));\n            float d = rand((ij+vec2(1.,1.)));\n            float x1 = mix(a, b, xy.x);\n            float x2 = mix(c, d, xy.x);\n            return mix(x1, x2, xy.y);\n        }\n        \n        float pNoise(vec2 p, int res){\n            float persistance = u_persistence;\n            float n = 0.;\n            float normK = 0.;\n            float f = 4.;\n            float amp = 1.0;\n            int iCount = 0;\n            for (int i = 0; i<50; i++){\n                n+=amp*noise(p, f);\n                f*=2.;\n                normK+=amp;\n                amp*=persistance;\n                if (iCount >= res)\n                    break;\n                iCount++;\n            }\n            float nf = n/normK;\n            return nf*nf*nf*nf;\n        }\n        void main() {\n            vec2 uv = v_coord * u_scale * u_viewport + u_offset * u_scale;\n            vec4 color = vec4( pNoise( uv, u_octaves ) * u_amplitude );\n            gl_FragColor = color;\n        }"}LiteGraph.registerNodeType("texture/perlin",LGraphTexturePerlin);class LGraphTextureCanvas2D{constructor(){this.addInput("v"),this.addOutput("out","Texture"),this.properties={code:LGraphTextureCanvas2D.default_code,width:512,height:512,clear:!0,precision:LGraphTexture.DEFAULT,use_html_canvas:!1},this._func=null,this._temp_texture=null,this.compileCode()}static title="Canvas2D";static desc="Executes Canvas2D code inside a texture or the viewport.";static help="Set width and height to 0 to match viewport size.";static default_code="//vars: canvas,ctx,time\nctx.fillStyle='red';\nctx.fillRect(0,0,50,50);\n";static widgets_info={precision:{widget:"combo",values:LGraphTexture.MODE_VALUES},code:{type:"code"},width:{type:"number",precision:0,step:1},height:{type:"number",precision:0,step:1}};onPropertyChanged(name,value){"code"==name&&this.compileCode(value)}compileCode(code){if(this._func=null,LiteGraph.allow_scripts)try{this._func=new Function("canvas","ctx","time","script","v",code),this.boxcolor="#00FF00"}catch(err){this.boxcolor="#FF0000",console.error?.("Error parsing script"),console.error?.(err)}}onExecute(){var func=this._func;func&&this.isOutputConnected(0)&&this.executeDraw(func)}executeDraw(func_context){var width=this.properties.width||gl.canvas.width,height=this.properties.height||gl.canvas.height,temp=this._temp_texture,type=LGraphTexture.getTextureType(this.properties.precision),v=(temp&&temp.width==width&&temp.height==height&&temp.type==type||(temp=this._temp_texture=new GL.Texture(width,height,{format:gl.RGBA,filter:gl.LINEAR,type:type})),this.getInputData(0)),properties=this.properties,that=this,time=this.graph.getTime(),ctx=gl,canvas=gl.canvas;if(!this.properties.use_html_canvas&&enableWebGLCanvas||(ctx=this._canvas?(canvas=this._canvas,this._ctx):(canvas=this._canvas=GL.createCanvas(width.height),this._ctx=canvas.getContext("2d")),canvas.width=width,canvas.height=height),ctx==gl)temp.drawTo(function(){gl.start2D(),properties.clear&&(gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT));try{(func_context.draw||func_context).call(that,canvas,ctx,time,func_context,v),that.boxcolor="#00FF00"}catch(err){that.boxcolor="#FF0000",console.error?.("Error executing script"),console.error?.(err)}gl.finish2D()});else{properties.clear&&ctx.clearRect(0,0,canvas.width,canvas.height);try{(func_context.draw||func_context).call(this,canvas,ctx,time,func_context,v),this.boxcolor="#00FF00"}catch(err){this.boxcolor="#FF0000",console.error?.("Error executing script"),console.error?.(err)}temp.uploadImage(canvas)}this.setOutputData(0,temp)}}LiteGraph.registerNodeType("texture/canvas2D",LGraphTextureCanvas2D);class LGraphTextureMatte{constructor(){this.addInput("in","Texture"),this.addOutput("out","Texture"),this.properties={key_color:vec3.fromValues(0,1,0),threshold:.8,slope:.2,precision:LGraphTexture.DEFAULT}}static title="Matte";static desc="Extracts background";static widgets_info={key_color:{widget:"color"},precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}};onExecute(){var tex,uniforms,mesh,shader;this.isOutputConnected(0)&&(tex=this.getInputData(0),this.properties.precision===LGraphTexture.PASS_THROUGH?this.setOutputData(0,tex):tex&&(this._tex=LGraphTexture.getTargetTexture(tex,this._tex,this.properties.precision),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),this._uniforms||(this._uniforms={u_texture:0,u_key_color:this.properties.key_color,u_threshold:1,u_slope:1}),uniforms=this._uniforms,mesh=Mesh.getScreenQuad(),shader=(shader=LGraphTextureMatte._shader)||(LGraphTextureMatte._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,LGraphTextureMatte.pixel_shader)),uniforms.u_key_color=this.properties.key_color,uniforms.u_threshold=this.properties.threshold,uniforms.u_slope=this.properties.slope,this._tex.drawTo(function(){tex.bind(0),shader.uniforms(uniforms).draw(mesh)}),this.setOutputData(0,this._tex)))}static pixel_shader="precision highp float;\n        varying vec2 v_coord;\n        uniform sampler2D u_texture;\n        uniform vec3 u_key_color;\n        uniform float u_threshold;\n        uniform float u_slope;\n        \n        void main() {\n            vec3 color = texture2D( u_texture, v_coord ).xyz;\n            float diff = length( normalize(color) - normalize(u_key_color) );\n            float edge = u_threshold * (1.0 - u_slope);\n            float alpha = smoothstep( edge, u_threshold, diff);\n            gl_FragColor = vec4( color, alpha );\n        }"}LiteGraph.registerNodeType("texture/matte",LGraphTextureMatte);class LGraphCubemapToTexture2D{constructor(){this.addInput("in","texture"),this.addInput("yaw","number"),this.addOutput("out","texture"),this.properties={yaw:0}}static title="CubemapToTexture2D";static desc="Transforms a CUBEMAP texture into a TEXTURE2D in Polar Representation";onExecute(){var tex,yaw;this.isOutputConnected(0)&&(tex=this.getInputData(0))&&tex.texture_type==GL.TEXTURE_CUBE_MAP&&(!this._last_tex||this._last_tex.height==tex.height&&this._last_tex.type==tex.type||(this._last_tex=null),yaw=this.getInputOrProperty("yaw"),this._last_tex=GL.Texture.cubemapToTexture2D(tex,tex.height,this._last_tex,!0,yaw),this.setOutputData(0,this._last_tex))}}LiteGraph.registerNodeType("texture/cubemapToTexture2D",LGraphCubemapToTexture2D);var SHADERNODES_COLOR="#345",LGShaders=LiteGraph.Shaders={},GLSL_types=LGShaders.GLSL_types=["float","vec2","vec3","vec4","mat3","mat4","sampler2D","samplerCube"],GLSL_types_const=LGShaders.GLSL_types_const=["float","vec2","vec3","vec4"],GLSL_functions_desc={radians:"T radians(T degrees)",degrees:"T degrees(T radians)",sin:"T sin(T angle)",cos:"T cos(T angle)",tan:"T tan(T angle)",asin:"T asin(T x)",acos:"T acos(T x)",atan:"T atan(T x)",atan2:"T atan(T x,T y)",pow:"T pow(T x,T y)",exp:"T exp(T x)",log:"T log(T x)",exp2:"T exp2(T x)",log2:"T log2(T x)",sqrt:"T sqrt(T x)",inversesqrt:"T inversesqrt(T x)",abs:"T abs(T x)",sign:"T sign(T x)",floor:"T floor(T x)",round:"T round(T x)",ceil:"T ceil(T x)",fract:"T fract(T x)",mod:"T mod(T x,T y)",min:"T min(T x,T y)",max:"T max(T x,T y)",clamp:"T clamp(T x,T minVal = 0.0,T maxVal = 1.0)",mix:"T mix(T x,T y,T a)",step:"T step(T edge, T edge2, T x)",smoothstep:"T smoothstep(T edge, T edge2, T x)",length:"float length(T x)",distance:"float distance(T p0, T p1)",normalize:"T normalize(T x)",dot:"float dot(T x,T y)",cross:"vec3 cross(vec3 x,vec3 y)",reflect:"vec3 reflect(vec3 V,vec3 N)",refract:"vec3 refract(vec3 V,vec3 N, float IOR)"},GLSL_functions={},GLSL_functions_name=[];function parseGLSLDescriptions(){for(var i in GLSL_functions_name.length=0,GLSL_functions_desc){var j,op=GLSL_functions_desc[i],index=op.indexOf(" "),return_type=op.substr(0,index),index2=op.indexOf("(",index),index=op.substr(index,index2-index).trim(),params=op.substr(index2+1,op.length-index2-2).split(",");for(j in params){var p=params[j].split(" ").filter(function(a){return a});params[j]={type:p[0].trim(),name:p[1].trim()},"="==p[2]&&(params[j].value=p[3].trim())}GLSL_functions[i]={return_type:return_type,func:index,params:params},GLSL_functions_name.push(index)}}function registerShaderNode(type,node_ctor){node_ctor.color=SHADERNODES_COLOR,node_ctor.filter="shader",node_ctor.prototype.clearDestination=function(){this.shader_destination={}},node_ctor.prototype.propagateDestination=function(dest_name){if(this.shader_destination[dest_name]=!0,this.inputs)for(var i=0;i<this.inputs.length;++i){var origin_node=this.getInputNode(i);origin_node&&origin_node.propagateDestination(dest_name)}},node_ctor.prototype.onPropertyChanged||(node_ctor.prototype.onPropertyChanged=function(){this.graph&&this.graph._version++}),LiteGraph.registerNodeType("shader::"+type,node_ctor)}function getShaderNodeVarName(node,name){return"VAR_"+(name||"TEMP")+"_"+node.id}function getInputLinkID(node,slot){return node.inputs&&(slot=node.getInputLink(slot))&&(node=node.graph.getNodeById(slot.origin_id))?node.getOutputVarName?node.getOutputVarName(slot.origin_slot):"link_"+node.id+"_"+slot.origin_slot:null}function getOutputLinkID(node,slot){return node.isOutputConnected(slot)?"link_"+node.id+"_"+slot:null}function valueToGLSL(v,type,precision){var n=null!=precision?precision:5;if(!type)if(v.constructor===Number)type="float";else{if(!v.length)throw new Error("unknown type for glsl value: "+v.constructor);switch(v.length){case 2:type="vec2";break;case 3:type="vec3";break;case 4:type="vec4";break;case 9:type="mat3";break;case 16:type="mat4";break;default:throw new Error("unknown type for glsl value size")}}switch(type){case"float":return v.toFixed(n);case"vec2":return`vec2(${v[0].toFixed(n)},${v[1].toFixed(n)})`;case"color3":case"vec3":return`vec3(${v[0].toFixed(n)},${v[1].toFixed(n)},${v[2].toFixed(n)})`;case"color4":case"vec4":return`vec4(${v[0].toFixed(n)},${v[1].toFixed(n)},${v[2].toFixed(n)},${v[3].toFixed(n)})`;case"mat3":return"mat3(1.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,1.0)";case"mat4":return"mat4(1.0,0.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,0.0,1.0)";default:throw type}}parseGLSLDescriptions(),LGShaders.ALL_TYPES="float,vec2,vec3,vec4",LGShaders.registerShaderNode=registerShaderNode,LGShaders.getInputLinkID=getInputLinkID,LGShaders.getOutputLinkID=getOutputLinkID,LGShaders.getShaderNodeVarName=getShaderNodeVarName,LGShaders.parseGLSLDescriptions=parseGLSLDescriptions;var varToTypeGLSL=LiteGraph.varToTypeGLSL=function(v,input_type,output_type){if(input_type==output_type)return v;if(null==v)switch(output_type){case"float":return"0.0";case"vec2":return"vec2(0.0)";case"vec3":return"vec3(0.0)";case"vec4":return"vec4(0.0,0.0,0.0,1.0)";default:return null}if(!output_type)throw new Error("error: no output type specified");if("float"==output_type)switch(input_type){case"vec2":case"vec3":case"vec4":return v+".x";default:return"0.0"}else if("vec2"==output_type)switch(input_type){case"float":return"vec2("+v+")";case"vec3":case"vec4":return v+".xy";default:return"vec2(0.0)"}else if("vec3"==output_type)switch(input_type){case"float":return"vec3("+v+")";case"vec2":return"vec3("+v+",0.0)";case"vec4":return v+".xyz";default:return"vec3(0.0)"}else if("vec4"==output_type)switch(input_type){case"float":return"vec4("+v+")";case"vec2":return"vec4("+v+",0.0,1.0)";case"vec3":return"vec4("+v+",1.0)";default:return"vec4(0.0,0.0,0.0,1.0)"}throw new Error("type cannot be converted")},convertVarToGLSLType=LiteGraph.convertVarToGLSLType=function(varname,type,target_type){if(type==target_type)return varname;if("float"==type)return target_type+"("+varname+")";if("vec2"==target_type)return"vec2("+varname+".xy)";if("vec3"==target_type){if("vec2"==type)return"vec3("+varname+",0.0)";if("vec4"==type)return"vec4("+varname+".xyz)"}if("vec4"==target_type){if("vec2"==type)return"vec4("+varname+",0.0,0.0)";if("vec3"==target_type)return"vec4("+varname+",1.0)"}return null};class LGShaderContext{constructor(){this.vs_template="",this.fs_template="",this.buffer_names={uvs:"v_coord"},this.extra={},this._functions={},this._uniforms={},this._codeparts={},this._uniform_value=null}clear(){this._uniforms={},this._functions={},this._codeparts={},this._uniform_value=null,this.extra={}}addUniform(name,type,value){this._uniforms[name]=type,null!=value&&(this._uniform_value||(this._uniform_value={}),this._uniform_value[name]=value)}addFunction(name,code){this._functions[name]=code}addCode(hook,code,destinations){for(var i in destinations=destinations||{"":""}){i=i?i+"_"+hook:hook;this._codeparts[i]?this._codeparts[i]+=code+"\n":this._codeparts[i]=code+"\n"}}computeCodeBlocks(graph,extra_uniforms){this.clear();var vertexout=(vertexout=graph.findNodesByType("shader::output/vertex"))&&vertexout.length?vertexout[0]:null,fragmentout=graph.findNodesByType("shader::output/fragcolor");if(!(fragmentout=fragmentout&&fragmentout.length?fragmentout[0]:null))return null;graph.sendEventToAllNodes("clearDestination"),vertexout&&vertexout.propagateDestination("vs"),fragmentout&&fragmentout.propagateDestination("fs"),graph.sendEventToAllNodes("onGetCode",this);var i,uniforms="";for(i in this._uniforms)uniforms+="uniform "+this._uniforms[i]+" "+i+";\n";if(extra_uniforms)for(let i in extra_uniforms)uniforms+="uniform "+extra_uniforms[i]+" "+i+";\n";var functions="";for(let i in this._functions)functions+="//"+i+"\n"+this._functions[i]+"\n";vertexout=this._codeparts;return vertexout.uniforms=uniforms,vertexout.functions=functions,vertexout}computeShaderCode(graph){graph=this.computeCodeBlocks(graph);return{vs_code:GL.Shader.replaceCodeUsingContext(this.vs_template,graph),fs_code:GL.Shader.replaceCodeUsingContext(this.fs_template,graph)}}computeShader(graph,shader){graph=this.computeShaderCode(graph);if(console.log?.(graph.vs_code,graph.fs_code),!LiteGraph.catch_exceptions)return this._shader_error=!0,shader?shader.updateShader(graph.vs_code,graph.fs_code):shader=new GL.Shader(graph.vs_code,graph.fs_code),this._shader_error=!1,shader;try{return shader?shader.updateShader(graph.vs_code,graph.fs_code):shader=new GL.Shader(graph.vs_code,graph.fs_code),this._shader_error=!1,shader}catch(err){return this._shader_error||(console.error?.(err),-1!=err.indexOf("Fragment shader")?console.log?.(graph.fs_code.split("\n").map(function(v,i){return i+".- "+v}).join("\n")):console.log?.(graph.vs_code)),this._shader_error=!0,null}}getShader(graph){var shader;return this._shader&&this._shader._version==graph._version?this._shader:(shader=this.computeShader(graph,this._shader))?((this._shader=shader)._version=graph._version,shader):null}fillUniforms(uniforms,param){if(this._uniform_value)for(var i in this._uniform_value){var v=this._uniform_value[i];null!=v&&(v.constructor===Function?uniforms[i]=v.call(this,param):v.constructor!==GL.Texture&&(uniforms[i]=v))}}}class LGraphShaderGraph{constructor(){this.subgraph=new LiteGraph.LGraph,(this.subgraph._subgraph_node=this).subgraph._is_subgraph=!0,this.subgraph.filter="shader",this.addInput("in","texture"),this.addOutput("out","texture"),this.properties={width:0,height:0,alpha:!1,precision:void 0!==LGraphTexture?LGraphTexture.DEFAULT:2};var inputNode=this.subgraph.findNodesByType("shader::input/uniform")[0],sampler=(inputNode.pos=[200,300],LiteGraph.createNode("shader::texture/sampler2D")),outnode=(sampler.pos=[400,300],this.subgraph.add(sampler),LiteGraph.createNode("shader::output/fragcolor"));outnode.pos=[600,300],this.subgraph.add(outnode),inputNode.connect(0,sampler),sampler.connect(0,outnode),this.size=[180,60],this.redraw_on_mouse=!0,this._uniforms={},this._shader=null,this._context=new LGShaderContext,this._context.vs_template="#define VERTEX\n"+GL.Shader.SCREEN_VERTEX_SHADER,this._context.fs_template=LGraphShaderGraph.template}static template=`
        #define FRAGMENT
        precision highp float;
        varying vec2 v_coord;
        {{varying}}
        {{uniforms}}
        {{functions}}
        {{fs_functions}}
        void main() {
    
            vec2 uv = v_coord;
            vec4 fragcolor = vec4(0.0);
            vec4 fragcolor1 = vec4(0.0);
            {{fs_code}}
            gl_FragColor = fragcolor;
        }
    `;static widgets_info={precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}};static title="ShaderGraph";static desc="Builds a shader using a graph";static input_node_type="input/uniform";static output_node_type="output/fragcolor";static title_color=SHADERNODES_COLOR;onSerialize(o){o.subgraph=this.subgraph.serialize()}onConfigure(o){this.subgraph.configure(o.subgraph)}onExecute(){if(this.isOutputConnected(0)){var intex=this.getInputData(0),w=(intex&&intex.constructor!=GL.Texture&&(intex=null),0|this.properties.width),h=0|this.properties.height,intex=(0==w&&(w=intex?intex.width:gl.viewport_data[2]),0==h&&(h=intex?intex.height:gl.viewport_data[3]),LGraphTexture.getTextureType(this.properties.precision,intex)),texture=this._texture,shader=(texture&&texture.width==w&&texture.height==h&&texture.type==intex||(texture=this._texture=new GL.Texture(w,h,{type:intex,format:this.alpha?gl.RGBA:gl.RGB,filter:gl.LINEAR})),this.getShader(this.subgraph));if(shader){var uniforms=this._uniforms,tex_slot=(this._context.fillUniforms(uniforms),0);if(this.inputs)for(var i=0;i<this.inputs.length;++i){var input=this.inputs[i],data=this.getInputData(i);null!=(data="texture"==input.type?(data=data||GL.Texture.getWhiteTexture()).bind(tex_slot++):data)&&(uniforms["u_"+input.name]=data)}var mesh=GL.Mesh.getScreenQuad();gl.disable(gl.DEPTH_TEST),gl.disable(gl.BLEND),texture.drawTo(function(){shader.uniforms(uniforms),shader.draw(mesh)}),this.setOutputData(0,texture)}}}onInputAdded(slot_info){var subnode=LiteGraph.createNode("shader::input/uniform");subnode.setProperty("name",slot_info.name),subnode.setProperty("type",slot_info.type),this.subgraph.add(subnode)}onInputRemoved(slot,slot_info){for(var nodes=this.subgraph.findNodesByType("shader::input/uniform"),i=0;i<nodes.length;++i){var node=nodes[i];node.properties.name==slot_info.name&&this.subgraph.remove(node)}}computeSize(){var num_inputs=this.inputs?this.inputs.length:0,num_outputs=this.outputs?this.outputs.length:0;return[200,Math.max(num_inputs,num_outputs)*LiteGraph.NODE_SLOT_HEIGHT+LiteGraph.NODE_TITLE_HEIGHT+10]}getShader(){var shader=this._context.getShader(this.subgraph);return this.boxcolor=shader?null:"red",shader}onDrawBackground(ctx,graphcanvas,canvas,pos){var inputs_y,y,tex;this.flags.collapsed||(tex=this.getOutputData(0),inputs_y=this.inputs?this.inputs.length*LiteGraph.NODE_SLOT_HEIGHT:0,tex&&ctx==tex.gl&&this.size[1]>inputs_y+LiteGraph.NODE_TITLE_HEIGHT&&ctx.drawImage(tex,10,y,this.size[0]-20,this.size[1]-inputs_y-LiteGraph.NODE_TITLE_HEIGHT),y=this.size[1]-LiteGraph.NODE_TITLE_HEIGHT+.5,tex=LiteGraph.isInsideRectangle(pos[0],pos[1],this.pos[0],this.pos[1]+y,this.size[0],LiteGraph.NODE_TITLE_HEIGHT),ctx.fillStyle=tex?"#555":"#222",ctx.beginPath(),this._shape==LiteGraph.BOX_SHAPE?ctx.rect(0,y,this.size[0]+1,LiteGraph.NODE_TITLE_HEIGHT):ctx.roundRect(0,y,this.size[0]+1,LiteGraph.NODE_TITLE_HEIGHT,0,8),ctx.fill(),ctx.textAlign="center",ctx.font="24px Arial",ctx.fillStyle=tex?"#DDD":"#999",ctx.fillText("+",.5*this.size[0],y+24))}onMouseDown(e,localpos,graphcanvas){var y=this.size[1]-LiteGraph.NODE_TITLE_HEIGHT+.5;localpos[1]>y&&graphcanvas.showSubgraphPropertiesDialog(this)}getExtraMenuOptions(){var that=this;return[{content:"Print Code",callback:function(){var code=that._context.computeShaderCode();console.log?.(code.vs_code,code.fs_code)}}]}}LiteGraph.registerNodeType("texture/shaderGraph",LGraphShaderGraph);class LGraphShaderUniform{constructor(){this.addOutput("out",""),this.properties={name:"",type:""}}static title="Uniform";static desc="Input data for the shader";getTitle(){return this.properties.name&&this.flags.collapsed?this.properties.type+" "+this.properties.name:"Uniform"}onPropertyChanged(){this.outputs[0].name=this.properties.type+" "+this.properties.name}onGetCode(context){if(this.shader_destination){var type=this.properties.type;if(!type){if(!context.onGetPropertyInfo)return;var info=context.onGetPropertyInfo(this.property.name);if(!info)return;type=info.type}"number"==type?type="float":"texture"==type&&(type="sampler2D"),-1!=LGShaders.GLSL_types.indexOf(type)&&(context.addUniform("u_"+this.properties.name,type),this.setOutputData(0,type))}}getOutputVarName(){return"u_"+this.properties.name}}registerShaderNode("input/uniform",LGraphShaderUniform);class LGraphShaderAttribute{constructor(){this.addOutput("out","vec2"),this.properties={name:"coord",type:"vec2"}}static title="Attribute";static desc="Input data from mesh attribute";getTitle(){return"att. "+this.properties.name}onGetCode(context){var type;this.shader_destination&&(type=this.properties.type)&&-1!=LGShaders.GLSL_types.indexOf(type)&&("number"==type&&(type="float"),"coord"!=this.properties.name&&context.addCode("varying"," varying "+type+" v_"+this.properties.name+";"),this.setOutputData(0,type))}getOutputVarName(){return"v_"+this.properties.name}}registerShaderNode("input/attribute",LGraphShaderAttribute);class LGraphShaderSampler2D{constructor(){this.addInput("tex","sampler2D"),this.addInput("uv","vec2"),this.addOutput("rgba","vec4"),this.addOutput("rgb","vec3")}static title="Sampler2D";static desc="Reads a pixel from a texture";onGetCode(context){var texname,varname,code;this.shader_destination&&(texname=getInputLinkID(this,0),code="vec4 "+(varname=getShaderNodeVarName(this))+" = vec4(0.0);\n",texname&&(code+=varname+" = texture2D("+texname+","+(getInputLinkID(this,1)||context.buffer_names.uvs)+");\n"),getOutputLinkID(this,0)&&(code+="vec4 "+getOutputLinkID(this,0)+" = "+varname+";\n"),getOutputLinkID(this,1)&&(code+="vec3 "+getOutputLinkID(this,1)+" = "+varname+".xyz;\n"),context.addCode("code",code,this.shader_destination),this.setOutputData(0,"vec4"),this.setOutputData(1,"vec3"))}}registerShaderNode("texture/sampler2D",LGraphShaderSampler2D);class LGraphShaderConstant{constructor(){this.addOutput("","float"),this.properties={type:"float",value:0},this.addWidget("combo","type","float",null,{values:GLSL_types_const,property:"type"}),this.updateWidgets()}static title="const";getTitle(){return this.flags.collapsed?valueToGLSL(this.properties.value,this.properties.type,2):"Const"}onPropertyChanged(name,value){"type"==name&&(this.outputs[0].type!=value&&(this.disconnectOutput(0),this.outputs[0].type=value),this.widgets.length=1,this.updateWidgets()),"value"==name&&(value.length?(this.widgets[1].value=value[1],2<value.length&&(this.widgets[2].value=value[2]),3<value.length&&(this.widgets[3].value=value[3])):this.widgets[1].value=value)}updateWidgets(old_value){var that=this,options=(old_value=this.properties.value,{step:.01});switch(this.properties.type){case"float":this.properties.value=0,this.addWidget("number","v",0,{step:.01,property:"value"});break;case"vec2":this.properties.value=old_value&&2==old_value.length?[old_value[0],old_value[1]]:[0,0,0],this.addWidget("number","x",this.properties.value[0],function(v){that.properties.value[0]=v},options),this.addWidget("number","y",this.properties.value[1],function(v){that.properties.value[1]=v},options);break;case"vec3":this.properties.value=old_value&&3==old_value.length?[old_value[0],old_value[1],old_value[2]]:[0,0,0],this.addWidget("number","x",this.properties.value[0],function(v){that.properties.value[0]=v},options),this.addWidget("number","y",this.properties.value[1],function(v){that.properties.value[1]=v},options),this.addWidget("number","z",this.properties.value[2],function(v){that.properties.value[2]=v},options);break;case"vec4":this.properties.value=old_value&&4==old_value.length?[old_value[0],old_value[1],old_value[2],old_value[3]]:[0,0,0,0],this.addWidget("number","x",this.properties.value[0],function(v){that.properties.value[0]=v},options),this.addWidget("number","y",this.properties.value[1],function(v){that.properties.value[1]=v},options),this.addWidget("number","z",this.properties.value[2],function(v){that.properties.value[2]=v},options),this.addWidget("number","w",this.properties.value[3],function(v){that.properties.value[3]=v},options);break;default:console.error?.("unknown type for constant")}}onGetCode(context){var value,link_name;this.shader_destination&&(value=valueToGLSL(this.properties.value,this.properties.type),link_name=getOutputLinkID(this,0))&&(link_name="\t"+this.properties.type+" "+link_name+" = "+value+";",context.addCode("code",link_name,this.shader_destination),this.setOutputData(0,this.properties.type))}}registerShaderNode("const/const",LGraphShaderConstant);class LGraphShaderVec2{constructor(){this.addInput("xy","vec2"),this.addInput("x","float"),this.addInput("y","float"),this.addOutput("xy","vec2"),this.addOutput("x","float"),this.addOutput("y","float"),this.properties={x:0,y:0}}static title="vec2";static varmodes=["xy","x","y"];onPropertyChanged(){this.graph&&this.graph._version++}onGetCode(context){if(this.shader_destination){var props=this.properties,varname=getShaderNodeVarName(this),code="\tvec2 "+varname+" = "+valueToGLSL([props.x,props.y])+";\n";for(let i=0;i<LGraphShaderVec2.varmodes.length;++i){var varmode=LGraphShaderVec2.varmodes[i],inlink=getInputLinkID(this,i);inlink&&(code+="\t"+varname+"."+varmode+" = "+inlink+";\n")}for(let i=0;i<LGraphShaderVec2.varmodes.length;++i){let varmode=LGraphShaderVec2.varmodes[i];var type,outlink=getOutputLinkID(this,i);outlink&&(code+="\t"+(type=GLSL_types_const[varmode.length-1])+" "+outlink+" = "+varname+"."+varmode+";\n",this.setOutputData(i,type))}context.addCode("code",code,this.shader_destination)}}}registerShaderNode("const/vec2",LGraphShaderVec2);class LGraphShaderVec3{constructor(){this.addInput("xyz","vec3"),this.addInput("x","float"),this.addInput("y","float"),this.addInput("z","float"),this.addInput("xy","vec2"),this.addInput("xz","vec2"),this.addInput("yz","vec2"),this.addOutput("xyz","vec3"),this.addOutput("x","float"),this.addOutput("y","float"),this.addOutput("z","float"),this.addOutput("xy","vec2"),this.addOutput("xz","vec2"),this.addOutput("yz","vec2"),this.properties={x:0,y:0,z:0}}static title="vec3";static varmodes=["xyz","x","y","z","xy","xz","yz"];onPropertyChanged(){this.graph&&this.graph._version++}onGetCode(context){if(this.shader_destination){var props=this.properties,varname=getShaderNodeVarName(this),code="vec3 "+varname+" = "+valueToGLSL([props.x,props.y,props.z])+";\n";for(let i=0;i<LGraphShaderVec3.varmodes.length;++i){var varmode=LGraphShaderVec3.varmodes[i],inlink=getInputLinkID(this,i);inlink&&(code+="\t"+varname+"."+varmode+" = "+inlink+";\n")}for(let i=0;i<LGraphShaderVec3.varmodes.length;++i){let varmode=LGraphShaderVec3.varmodes[i];var type,outlink=getOutputLinkID(this,i);outlink&&(code+="\t"+(type=GLSL_types_const[varmode.length-1])+" "+outlink+" = "+varname+"."+varmode+";\n",this.setOutputData(i,type))}context.addCode("code",code,this.shader_destination)}}}registerShaderNode("const/vec3",LGraphShaderVec3);class LGraphShaderVec4{constructor(){this.addInput("xyzw","vec4"),this.addInput("xyz","vec3"),this.addInput("x","float"),this.addInput("y","float"),this.addInput("z","float"),this.addInput("w","float"),this.addInput("xy","vec2"),this.addInput("yz","vec2"),this.addInput("zw","vec2"),this.addOutput("xyzw","vec4"),this.addOutput("xyz","vec3"),this.addOutput("x","float"),this.addOutput("y","float"),this.addOutput("z","float"),this.addOutput("xy","vec2"),this.addOutput("yz","vec2"),this.addOutput("zw","vec2"),this.properties={x:0,y:0,z:0,w:0}}static title="vec4";static varmodes=["xyzw","xyz","x","y","z","w","xy","yz","zw"];onPropertyChanged(){this.graph&&this.graph._version++}onGetCode(context){if(this.shader_destination){var props=this.properties,varname=getShaderNodeVarName(this),code="vec4 "+varname+" = "+valueToGLSL([props.x,props.y,props.z,props.w])+";\n";for(let i=0;i<LGraphShaderVec4.varmodes.length;++i){var varmode=LGraphShaderVec4.varmodes[i],inlink=getInputLinkID(this,i);inlink&&(code+="\t"+varname+"."+varmode+" = "+inlink+";\n")}for(let i=0;i<LGraphShaderVec4.varmodes.length;++i){let varmode=LGraphShaderVec4.varmodes[i];var type,outlink=getOutputLinkID(this,i);outlink&&(code+="\t"+(type=GLSL_types_const[varmode.length-1])+" "+outlink+" = "+varname+"."+varmode+";\n",this.setOutputData(i,type))}context.addCode("code",code,this.shader_destination)}}}registerShaderNode("const/vec4",LGraphShaderVec4);class LGraphShaderFragColor{constructor(){this.addInput("color",LGShaders.ALL_TYPES),this.block_delete=!0}static title="FragColor";static desc="Pixel final color";onGetCode(context){var type,link_name=getInputLinkID(this,0);link_name&&(type=this.getInputData(0),link_name=varToTypeGLSL(link_name,type,"vec4"),context.addCode("fs_code","fragcolor = "+link_name+";"))}}registerShaderNode("output/fragcolor",LGraphShaderFragColor);class LGraphShaderOperation{constructor(){this.addInput("A",LGShaders.ALL_TYPES),this.addInput("B",LGShaders.ALL_TYPES),this.addOutput("out",""),this.properties={operation:"*"},this.addWidget("combo","op.",this.properties.operation,{property:"operation",values:LGraphShaderOperation.operations})}static title="Operation";static operations=["+","-","*","/"];getTitle(){return this.flags.collapsed?"A"+this.properties.operation+"B":"Operation"}onGetCode(context){if(this.shader_destination&&this.isOutputConnected(0)){var inlinks=[];for(let i=0;i<3;++i)inlinks.push({name:getInputLinkID(this,i),type:this.getInputData(i)||"float"});var outlink=getOutputLinkID(this,0);if(outlink){var base_type=inlinks[0].type,return_type=base_type,op=this.properties.operation,params=[];for(let i=0;i<2;++i){var param_code=inlinks[i].name;null==param_code&&(param_code=null!=p.value?p.value:"(1.0)",inlinks[i].type="float"),inlinks[i].type!=base_type&&("float"!=inlinks[i].type||"*"!=op&&"/"!=op)&&(param_code=convertVarToGLSLType(param_code,inlinks[i].type,base_type)),params.push(param_code)}context.addCode("code",return_type+" "+outlink+" = "+params[0]+op+params[1]+";",this.shader_destination),this.setOutputData(0,return_type)}}}}registerShaderNode("math/operation",LGraphShaderOperation);class LGraphShaderFunc{constructor(){this.addInput("A",LGShaders.ALL_TYPES),this.addInput("B",LGShaders.ALL_TYPES),this.addOutput("out",""),this.properties={func:"floor"},this._current="floor",this.addWidget("combo","func",this.properties.func,{property:"func",values:GLSL_functions_name})}static title="Func";onPropertyChanged(name,value){if(this.graph&&this.graph._version++,"func"==name){var func_desc=GLSL_functions[value];if(func_desc){for(let i=func_desc.params.length;i<this.inputs.length;++i)this.removeInput(i);for(let i=0;i<func_desc.params.length;++i){var p=func_desc.params[i];this.inputs[i]?this.inputs[i].name=p.name+(p.value?" ("+p.value+")":""):this.addInput(p.name,LGShaders.ALL_TYPES)}}}}getTitle(){return this.flags.collapsed?this.properties.func:"Func"}onGetCode(context){if(this.shader_destination&&this.isOutputConnected(0)){var inlinks=[];for(let i=0;i<3;++i)inlinks.push({name:getInputLinkID(this,i),type:this.getInputData(i)||"float"});var outlink=getOutputLinkID(this,0);if(outlink){var func_desc=GLSL_functions[this.properties.func];if(func_desc){var base_type=inlinks[0].type,return_type=func_desc.return_type,params=("T"==return_type&&(return_type=base_type),[]);for(let i=0;i<func_desc.params.length;++i){var p=func_desc.params[i],param_code=inlinks[i].name;null==param_code&&(param_code=null!=p.value?p.value:"(1.0)",inlinks[i].type="float"),("T"==p.type&&inlinks[i].type!=base_type||"T"!=p.type&&inlinks[i].type!=base_type)&&(param_code=convertVarToGLSLType(param_code,inlinks[i].type,base_type)),params.push(param_code)}context.addFunction("round","float round(float v){ return floor(v+0.5); }\nvec2 round(vec2 v){ return floor(v+vec2(0.5));}\nvec3 round(vec3 v){ return floor(v+vec3(0.5));}\nvec4 round(vec4 v){ return floor(v+vec4(0.5)); }\n"),context.addCode("code",return_type+" "+outlink+" = "+func_desc.func+"("+params.join(",")+");",this.shader_destination),this.setOutputData(0,return_type)}}}}}registerShaderNode("math/func",LGraphShaderFunc);class LGraphShaderSnippet{constructor(){this.addInput("A",LGShaders.ALL_TYPES),this.addInput("B",LGShaders.ALL_TYPES),this.addOutput("C","vec4"),this.properties={code:"C = A+B",type:"vec4"},this.addWidget("text","code",this.properties.code,{property:"code"}),this.addWidget("combo","type",this.properties.type,{values:["float","vec2","vec3","vec4"],property:"type"})}static title="Snippet";onPropertyChanged(name,value){this.graph&&this.graph._version++,"type"==name&&this.outputs[0].type!=value&&(this.disconnectOutput(0),this.outputs[0].type=value)}getTitle(){return this.flags.collapsed?this.properties.code:"Snippet"}onGetCode(context){if(this.shader_destination&&this.isOutputConnected(0)){var inlinkA=(inlinkA=getInputLinkID(this,0))||"1.0",inlinkB=(inlinkB=getInputLinkID(this,1))||"1.0",outlink=getOutputLinkID(this,0);if(outlink){var inA_type=this.getInputData(0)||"float",inB_type=this.getInputData(1)||"float",return_type=this.properties.type;if("T"==inA_type||"T"==inB_type)return null;var funcname="funcSnippet"+this.id,inA_type=(inA_type="\n"+return_type+" "+funcname+"( "+inA_type+" A, "+inB_type+" B) {\n")+("\t"+return_type+" C = "+return_type+"(0.0);\n")+("\t"+this.properties.code+";\n");context.addCode("functions",inA_type+="\treturn C;\n}\n",this.shader_destination),context.addCode("code",return_type+" "+outlink+" = "+funcname+"("+inlinkA+","+inlinkB+");",this.shader_destination),this.setOutputData(0,return_type)}}}}registerShaderNode("utils/snippet",LGraphShaderSnippet);class LGraphShaderRand{constructor(){this.addOutput("out","float")}static title="Rand";onGetCode(context){var outlink;this.shader_destination&&this.isOutputConnected(0)&&(outlink=getOutputLinkID(this,0),context.addUniform("u_rand"+this.id,"float",function(){return Math.random()}),context.addCode("code","float "+outlink+" = u_rand"+this.id+";",this.shader_destination),this.setOutputData(0,"float"))}}registerShaderNode("input/rand",LGraphShaderRand);class LGraphShaderNoise{constructor(){this.addInput("out",LGShaders.ALL_TYPES),this.addInput("scale","float"),this.addOutput("out","float"),this.properties={type:"noise",scale:1},this.addWidget("combo","type",this.properties.type,{property:"type",values:LGraphShaderNoise.NOISE_TYPES}),this.addWidget("number","scale",this.properties.scale,{property:"scale"})}static NOISE_TYPES=["noise","rand"];static title="noise";onGetCode(context){var inlink,outlink,intype;this.shader_destination&&this.isOutputConnected(0)&&(inlink=getInputLinkID(this,0),outlink=getOutputLinkID(this,0),intype=this.getInputData(0),inlink||(intype="vec2",inlink=context.buffer_names.uvs),context.addFunction("noise",LGraphShaderNoise.shader_functions),context.addUniform("u_noise_scale"+this.id,"float",this.properties.scale),"float"==intype?context.addCode("code","float "+outlink+" = snoise( vec2("+inlink+") * u_noise_scale"+this.id+");",this.shader_destination):"vec2"==intype||"vec3"==intype?context.addCode("code","float "+outlink+" = snoise("+inlink+" * u_noise_scale"+this.id+");",this.shader_destination):"vec4"==intype&&context.addCode("code","float "+outlink+" = snoise("+inlink+".xyz * u_noise_scale"+this.id+");",this.shader_destination),this.setOutputData(0,"float"))}static shader_functions=`
        vec3 permute(vec3 x) { return mod(((x * 34.0) + 1.0) * x, 289.0); }

        float snoise(vec2 v) {
            const vec4 C = vec4(0.211324865405187, 0.366025403784439, -0.577350269189626, 0.024390243902439);
            vec2 i = floor(v + dot(v, C.yy));
            vec2 x0 = v - i + dot(i, C.xx);
            vec2 i1;
            i1 = (x0.x > x0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);
            vec4 x12 = x0.xyxy + C.xxzz;
            x12.xy -= i1;
            i = mod(i, 289.0);
            vec3 p = permute(permute(i.y + vec3(0.0, i1.y, 1.0)) + i.x + vec3(0.0, i1.x, 1.0));
            vec3 m = max(0.5 - vec3(dot(x0, x0), dot(x12.xy, x12.xy), dot(x12.zw, x12.zw)), 0.0);
            m = m * m ;
            m = m * m ;
            vec3 x = 2.0 * fract(p * C.www) - 1.0;
            vec3 h = abs(x) - 0.5;
            vec3 ox = floor(x + 0.5);
            vec3 a0 = x - ox;
            m *= 1.79284291400159 - 0.85373472095314 * (a0 * a0 + h * h);
            vec3 g;
            g.x = a0.x  * x0.x + h.x  * x0.y;
            g.yz = a0.yz * x12.xz + h.yz * x12.yw;
            return 130.0 * dot(m, g);
        }

        vec4 permute(vec4 x) { return mod(((x * 34.0) + 1.0) * x, 289.0); }

        vec4 taylorInvSqrt(vec4 r) { return 1.79284291400159 - 0.85373472095314 * r; }

        float snoise(vec3 v) {
            const vec2 C = vec2(1.0/6.0, 1.0/3.0);
            const vec4 D = vec4(0.0, 0.5, 1.0, 2.0);

            vec3 i  = floor(v + dot(v, C.yyy));
            vec3 x0 = v - i + dot(i, C.xxx);

            vec3 g = step(x0.yzx, x0.xyz);
            vec3 l = 1.0 - g;
            vec3 i1 = min(g.xyz, l.zxy);
            vec3 i2 = max(g.xyz, l.zxy);

            vec3 x1 = x0 - i1 + 1.0 * C.xxx;
            vec3 x2 = x0 - i2 + 2.0 * C.xxx;
            vec3 x3 = x0 - 1.0 + 3.0 * C.xxx;

            i = mod(i, 289.0);
            vec4 p = permute(permute(permute(i.z + vec4(0.0, i1.z, i2.z, 1.0)) + i.y + vec4(0.0, i1.y, i2.y, 1.0)) + i.x + vec4(0.0, i1.x, i2.x, 1.0));

            float n_ = 1.0 / 7.0;
            vec3 ns = n_ * D.wyz - D.xzx;

            vec4 j = p - 49.0 * floor(p * ns.z * ns.z);

            vec4 x_ = floor(j * ns.z);
            vec4 y_ = floor(j - 7.0 * x_);
            
            vec4 x = x_ * ns.x + ns.yyyy;
            vec4 y = y_ * ns.x + ns.yyyy;
            vec4 h = 1.0 - abs(x) - abs(y);
            
            vec4 b0 = vec4(x.xy, y.xy);
            vec4 b1 = vec4(x.zw, y.zw);
            
            vec4 s0 = floor(b0) * 2.0 + 1.0;
            vec4 s1 = floor(b1) * 2.0 + 1.0;
            vec4 sh = -step(h, vec4(0.0));
            
            vec4 a0 = b0.xzyw + s0.xzyw * sh.xxyy;
            vec4 a1 = b1.xzyw + s1.xzyw * sh.zzww;
            
            vec3 p0 = vec3(a0.xy, h.x);
            vec3 p1 = vec3(a0.zw, h.y);
            vec3 p2 = vec3(a1.xy, h.z);
            vec3 p3 = vec3(a1.zw, h.w);
            
            vec4 norm = taylorInvSqrt(vec4(dot(p0, p0), dot(p1, p1), dot(p2, p2), dot(p3, p3)));
            p0 *= norm.x;
            p1 *= norm.y;
            p2 *= norm.z;
            p3 *= norm.w;
            
            vec4 m = max(0.6 - vec4(dot(x0, x0), dot(x1, x1), dot(x2, x2), dot(x3, x3)), 0.0);
            m = m * m;
            
            return 42.0 * dot(m * m, vec4(dot(p0, x0), dot(p1, x1), dot(p2, x2), dot(p3, x3)));
        }

        vec3 hash3(vec2 p) {
            vec3 q = vec3(dot(p, vec2(127.1, 311.7)),
                        dot(p, vec2(269.5, 183.3)),
                        dot(p, vec2(419.2, 371.9)));
            return fract(sin(q) * 43758.5453);
        }

        vec4 hash4(vec3 p) {
            vec4 q = vec4(dot(p, vec3(127.1, 311.7, 257.3)),
                        dot(p, vec3(269.5, 183.3, 335.1)),
                        dot(p, vec3(314.5, 235.1, 467.3)),
                        dot(p, vec3(419.2, 371.9, 114.9)));
            return fract(sin(q) * 43758.5453);
        }

        float iqnoise(in vec2 x, float u, float v) {
            vec2 p = floor(x);
            vec2 f = fract(x);
            
            float k = 1.0 + 63.0 * pow(1.0 - v, 4.0);
            
            float va = 0.0;
            float wt = 0.0;
            for (int j = -2; j <= 2; j++)
                for (int i = -2; i <= 2; i++) {
                    vec2 g = vec2(float(i), float(j));
                    vec3 o = hash3(p + g) * vec3(u, u, 1.0);
                    vec2 r = g - f + o.xy;
                    float d = dot(r, r);
                    float ww = pow(1.0 - smoothstep(0.0, 1.414, sqrt(d)), k);
                    va += o.z * ww;
                    wt += ww;
                }
            
            return va / wt;
        }
    `}registerShaderNode("math/noise",LGraphShaderNoise);class LGraphShaderTime{constructor(){this.addOutput("out","float")}static title="Time";onGetCode(context){var outlink;this.shader_destination&&this.isOutputConnected(0)&&(outlink=getOutputLinkID(this,0),context.addUniform("u_time"+this.id,"float",function(){return.001*getTime()}),context.addCode("code","float "+outlink+" = u_time"+this.id+";",this.shader_destination),this.setOutputData(0,"float"))}}registerShaderNode("input/time",LGraphShaderTime);class LGraphShaderDither{constructor(){this.addInput("in","T"),this.addOutput("out","float")}static title="Dither";onGetCode(context){var outlink,intype,inlink;this.shader_destination&&this.isOutputConnected(0)&&(inlink=getInputLinkID(this,0),outlink=getOutputLinkID(this,0),intype=this.getInputData(0),inlink=varToTypeGLSL(inlink,intype,"float"),context.addFunction("dither8x8",LGraphShaderDither.dither_func),context.addCode("code","float "+outlink+" = dither8x8("+inlink+");",this.shader_destination),this.setOutputData(0,"float"))}static dither_values=[.515625,.140625,.640625,.046875,.546875,.171875,.671875,.765625,.265625,.890625,.390625,.796875,.296875,.921875,.421875,.203125,.703125,.078125,.578125,.234375,.734375,.109375,.609375,.953125,.453125,.828125,.328125,.984375,.484375,.859375,.359375,.0625,.5625,.1875,.6875,.03125,.53125,.15625,.65625,.8125,.3125,.9375,.4375,.78125,.28125,.90625,.40625,.25,.75,.125,.625,.21875,.71875,.09375,.59375,1.0001,.5,.875,.375,.96875,.46875,.84375,.34375];static dither_func=`
        float dither8x8(float brightness) {
            vec2 position = vec2(0.0);
            #ifdef FRAGMENT
            position = gl_FragCoord.xy;
            #endif
            int x = int(mod(position.x, 8.0));
            int y = int(mod(position.y, 8.0));
            int index = x + y * 8;
            float limit = 0.0;
            if (x < 8) {
                if (index == 0) limit = 0.015625;
                // Add more conditions or code here if needed
                // Example: if (condition) { ... }
            }
            ${LGraphShaderDither.dither_values.map((v,i)=>`else if (index == ${i+1}) limit = ${v};`).join("\n")}
            return brightness < limit ? 0.0 : 1.0;
        }
    `}registerShaderNode("math/dither",LGraphShaderDither);class LGraphShaderRemap{constructor(){this.addInput("",LGShaders.ALL_TYPES),this.addOutput("",""),this.properties={min_value:0,max_value:1,min_value2:0,max_value2:1},this.addWidget("number","min",0,{step:.1,property:"min_value"}),this.addWidget("number","max",1,{step:.1,property:"max_value"}),this.addWidget("number","min2",0,{step:.1,property:"min_value2"}),this.addWidget("number","max2",1,{step:.1,property:"max_value2"})}static title="Remap";onPropertyChanged(){this.graph&&this.graph._version++}onConnectionsChange(){var return_type=this.getInputDataType(0);this.outputs[0].type=return_type||"T"}onGetCode(context){var inlink,outlink,return_type,minv,maxv,minv2,maxv2;this.shader_destination&&this.isOutputConnected(0)&&(inlink=getInputLinkID(this,0),outlink=getOutputLinkID(this,0),inlink||outlink)&&(return_type=this.getInputDataType(0),"T"==(this.outputs[0].type=return_type)?console.warn?.("node type is T and cannot be resolved"):inlink?(minv=valueToGLSL(this.properties.min_value),maxv=valueToGLSL(this.properties.max_value),minv2=valueToGLSL(this.properties.min_value2),maxv2=valueToGLSL(this.properties.max_value2),context.addCode("code",return_type+` ${outlink} = ( (${inlink} - ${minv}) / (${maxv} - ${minv}) ) * (${maxv2} - ${minv2}) + ${minv2};`,this.shader_destination),this.setOutputData(0,return_type)):context.addCode("code","\t"+return_type+" "+outlink+" = "+return_type+"(0.0);\n"))}}registerShaderNode("math/remap",LGraphShaderRemap);var view_matrix=new Float32Array(16),projection_matrix=new Float32Array(16),viewprojection_matrix=new Float32Array(16),model_matrix=new Float32Array(16),global_uniforms={u_view:view_matrix,u_projection:projection_matrix,u_viewprojection:viewprojection_matrix,u_model:model_matrix};const LGraphRender={onRequestCameraMatrices:null};function generateGeometryId(){return 1e5*Math.random()|0}class LGraphPoints3D{constructor(){this.addInput("obj",""),this.addInput("radius","number"),this.addOutput("out","geometry"),this.addOutput("points","[vec3]"),this.properties={radius:1,num_points:4096,generate_normals:!0,regular:!1,mode:LGraphPoints3D.SPHERE,force_update:!1},this.points=new Float32Array(3*this.properties.num_points),this.normals=new Float32Array(3*this.properties.num_points),this.must_update=!0,this.version=0;var that=this;this.addWidget("button","update",null,function(){that.must_update=!0}),this.geometry={vertices:null,_id:generateGeometryId()},this._old_obj=null,this._last_radius=null}onPropertyChanged(_name,_value){this.must_update=!0}onExecute(){var obj=this.getInputData(0),obj=((obj!=this._old_obj||obj&&obj._version!=this._old_obj_version)&&(this._old_obj=obj,this.must_update=!0),this.getInputData(1));null==obj&&(obj=this.properties.radius),this._last_radius!=obj&&(this._last_radius=obj,this.must_update=!0),(this.must_update||this.properties.force_update)&&(this.must_update=!1,this.updatePoints()),this.geometry.vertices=this.points,this.geometry.normals=this.normals,this.geometry._version=this.version,this.setOutputData(0,this.geometry)}updatePoints(){var num_points=0|this.properties.num_points,radius=(num_points<1&&(num_points=1),this.points&&this.points.length==3*num_points||(this.points=new Float32Array(3*num_points)),this.properties.generate_normals?this.normals&&this.normals.length==this.points.length||(this.normals=new Float32Array(this.points.length)):this.normals=null,this._last_radius||this.properties.radius),mode=this.properties.mode,obj=this.getInputData(0);this._old_obj_version=obj?obj._version:null,this.points=LGraphPoints3D.generatePoints(radius,num_points,mode,this.points,this.normals,this.properties.regular,obj),this.version++}static generatePoints(radius,num_points,mode,points,normals,regular,obj){var size=3*num_points,temp=(points&&points.length==size||(points=new Float32Array(size)),new Float32Array(3)),UP=new Float32Array([0,1,0]);if(regular){if(mode==LGraphPoints3D.RECTANGLE){var side=Math.floor(Math.sqrt(num_points));for(let i=0;i<side;++i)for(let j=0;j<side;++j){var pos=3*i+3*j*side;points[pos]=(i/side-.5)*radius*2,points[1+pos]=0,points[2+pos]=(j/side-.5)*radius*2}if(points=new Float32Array(points.subarray(0,side*side*3)),normals)for(let i=0;i<normals.length;i+=3)normals.set(UP,i)}else if(mode==LGraphPoints3D.SPHERE){let side=Math.floor(Math.sqrt(num_points));for(let i=0;i<side;++i)for(let j=0;j<side;++j){let pos=3*i+3*j*side;GL.polarToCartesian(temp,i/side*2*Math.PI,2*(j/side-.5)*Math.PI,radius),points[pos]=temp[0],points[1+pos]=temp[1],points[2+pos]=temp[2]}points=new Float32Array(points.subarray(0,side*side*3)),normals&&LGraphPoints3D.generateSphericalNormals(points,normals)}else if(mode==LGraphPoints3D.CIRCLE){for(let i=0;i<size;i+=3){var angle=2*Math.PI*(i/size);points[i]=Math.cos(angle)*radius,points[i+1]=0,points[i+2]=Math.sin(angle)*radius}if(normals)for(let i=0;i<normals.length;i+=3)normals.set(UP,i)}}else if(mode==LGraphPoints3D.RECTANGLE){for(let i=0;i<size;i+=3)points[i]=(Math.random()-.5)*radius*2,points[i+1]=0,points[i+2]=(Math.random()-.5)*radius*2;if(normals)for(let i=0;i<normals.length;i+=3)normals.set(UP,i)}else if(mode==LGraphPoints3D.CUBE){for(let i=0;i<size;i+=3)points[i]=(Math.random()-.5)*radius*2,points[i+1]=(Math.random()-.5)*radius*2,points[i+2]=(Math.random()-.5)*radius*2;if(normals)for(let i=0;i<normals.length;i+=3)normals.set(UP,i)}else mode==LGraphPoints3D.SPHERE?(LGraphPoints3D.generateSphere(points,size,radius),normals&&LGraphPoints3D.generateSphericalNormals(points,normals)):mode==LGraphPoints3D.HEMISPHERE?(LGraphPoints3D.generateHemisphere(points,size,radius),normals&&LGraphPoints3D.generateSphericalNormals(points,normals)):mode==LGraphPoints3D.CIRCLE?(LGraphPoints3D.generateInsideCircle(points,size,radius),normals&&LGraphPoints3D.generateSphericalNormals(points,normals)):mode==LGraphPoints3D.INSIDE_SPHERE?(LGraphPoints3D.generateInsideSphere(points,size,radius),normals&&LGraphPoints3D.generateSphericalNormals(points,normals)):mode==LGraphPoints3D.OBJECT?LGraphPoints3D.generateFromObject(points,normals,size,obj,!1):mode==LGraphPoints3D.OBJECT_UNIFORMLY?LGraphPoints3D.generateFromObject(points,normals,size,obj,!0):mode==LGraphPoints3D.OBJECT_INSIDE?LGraphPoints3D.generateFromInsideObject(points,size,obj):console.warn?.("wrong mode in LGraphPoints3D");return points}static generateSphericalNormals(points,normals){for(var temp=new Float32Array(3),i=0;i<normals.length;i+=3)temp[0]=points[i],temp[1]=points[i+1],temp[2]=points[i+2],vec3.normalize(temp,temp),normals.set(temp,i)}static generateSphere(points,size,radius){for(var i=0;i<size;i+=3){var r1=Math.random(),r2=Math.random(),x=2*Math.cos(2*Math.PI*r1)*Math.sqrt(r2*(1-r2)),y=1-2*r2,r1=2*Math.sin(2*Math.PI*r1)*Math.sqrt(r2*(1-r2));points[i]=x*radius,points[i+1]=y*radius,points[i+2]=r1*radius}}static generateHemisphere(points,size,radius){for(var i=0;i<size;i+=3){var r1=Math.random(),r2=Math.random(),x=Math.cos(2*Math.PI*r1)*Math.sqrt(1-r2*r2),y=r2,r1=Math.sin(2*Math.PI*r1)*Math.sqrt(1-r2*r2);points[i]=x*radius,points[i+1]=y*radius,points[i+2]=r1*radius}}static generateInsideCircle(points,size,radius){for(var i=0;i<size;i+=3){var r1=Math.random(),r2=Math.random(),x=Math.cos(2*Math.PI*r1)*Math.sqrt(1-r2*r2),r1=Math.sin(2*Math.PI*r1)*Math.sqrt(1-r2*r2);points[i]=x*radius,points[i+1]=0,points[i+2]=r1*radius}}static generateInsideSphere(points,size,radius){for(var i=0;i<size;i+=3){var u=Math.random(),v=Math.random(),u=2*u*Math.PI,v=Math.acos(2*v-1),r=Math.cbrt(Math.random())*radius,sinTheta=Math.sin(u),u=Math.cos(u),sinPhi=Math.sin(v),v=Math.cos(v);points[i]=r*sinPhi*u,points[i+1]=r*sinPhi*sinTheta,points[i+2]=r*v}}static generateFromObject(points,normals,size,obj,evenly){if(obj){var vertices=null,mesh_normals=null,indices=null,areas=null;if(obj.constructor===GL.Mesh&&(vertices=obj.vertexBuffers.vertices.data,mesh_normals=obj.vertexBuffers.normals?obj.vertexBuffers.normals.data:null,indices=(indices=obj.indexBuffers.indices?obj.indexBuffers.indices.data:null)||(obj.indexBuffers.triangles?obj.indexBuffers.triangles.data:null)),!vertices)return null;var num_triangles=indices?indices.length/3:vertices.length/9,total_area=0;if(evenly){areas=new Float32Array(num_triangles);for(let i=0;i<num_triangles;++i){var c=indices?(a=3*indices[3*i],b=3*indices[3*i+1],3*indices[3*i+2]):(a=9*i,b=9*i+3,9*i+6),P1=vertices.subarray(a,a+3),P2=vertices.subarray(b,b+3),P3=vertices.subarray(c,c+3),aL=vec3.distance(P1,P2),P2=vec3.distance(P2,P3),P3=vec3.distance(P3,P1),s=(aL+P2+P3)/2;total_area+=Math.sqrt(s*(s-aL)*(s-P2)*(s-P3)),areas[i]=total_area}for(let i=0;i<num_triangles;++i)areas[i]/=total_area}for(let i=0;i<size;i+=3){var r=Math.random(),r=evenly?function(areas,f){var l=areas.length,imin=0,imid=0,imax=l;if(0==l)return-1;if(1==l)return 0;for(;imin<=imax;){var t=areas[imid=.5*(imax+imin)|0];if(t==f)return imid;if(imin==imax-1)return imin;t<f?imin=imid:imax=imid}return imid}(areas,r):Math.floor(r*num_triangles),a=0,b=0,c=0,s=(c=indices?(a=3*indices[3*r],b=3*indices[3*r+1],3*indices[3*r+2]):(b=(a=9*r)+3,9*r+6),Math.random()),r=Math.random(),sqrt_s=Math.sqrt(s),af=1-sqrt_s,bf=sqrt_s*(1-r),r=r*sqrt_s;points[i]=af*vertices[a]+bf*vertices[b]+r*vertices[c],points[i+1]=af*vertices[a+1]+bf*vertices[b+1]+r*vertices[c+1],points[i+2]=af*vertices[a+2]+bf*vertices[b+2]+r*vertices[c+2],normals&&mesh_normals&&(normals[i]=af*mesh_normals[a]+bf*mesh_normals[b]+r*mesh_normals[c],normals[i+1]=af*mesh_normals[a+1]+bf*mesh_normals[b+1]+r*mesh_normals[c+1],normals[i+2]=af*mesh_normals[a+2]+bf*mesh_normals[b+2]+r*mesh_normals[c+2],sqrt_s=normals.subarray(i,i+3),vec3.normalize(sqrt_s,sqrt_s))}}}static generateFromInsideObject(points,size,mesh){if(mesh&&mesh.constructor===GL.Mesh)for(var aabb=mesh.getBoundingBox(),octree=(mesh.octree||(mesh.octree=new GL.Octree(mesh)),mesh.octree),origin=vec3.create(),direction=vec3.fromValues(1,0,0),temp=vec3.create(),i=0,tries=0;i<size&&tries<10*points.length;){tries+=1;var r=vec3.random(temp),hit=(r[0]=(2*r[0]-1)*aabb[3]+aabb[0],r[1]=(2*r[1]-1)*aabb[4]+aabb[1],r[2]=(2*r[2]-1)*aabb[5]+aabb[2],origin.set(r),octree.testRay(origin,direction,0,1e4,!0,GL.Octree.ALL));hit&&hit.length%2!=0&&(points.set(r,i),i+=3)}}static RECTANGLE=1;static CIRCLE=2;static CUBE=10;static SPHERE=11;static HEMISPHERE=12;static INSIDE_SPHERE=13;static OBJECT=20;static OBJECT_UNIFORMLY=21;static OBJECT_INSIDE=22;static MODE_VALUES={rectangle:LGraphPoints3D.RECTANGLE,circle:LGraphPoints3D.CIRCLE,cube:LGraphPoints3D.CUBE,sphere:LGraphPoints3D.SPHERE,hemisphere:LGraphPoints3D.HEMISPHERE,inside_sphere:LGraphPoints3D.INSIDE_SPHERE,object:LGraphPoints3D.OBJECT,object_uniformly:LGraphPoints3D.OBJECT_UNIFORMLY,object_inside:LGraphPoints3D.OBJECT_INSIDE};static widgets_info={mode:{widget:"combo",values:LGraphPoints3D.MODE_VALUES}};static title="list of points";static desc="returns an array of points"}LiteGraph.registerNodeType("geometry/points3D",LGraphPoints3D);class LGraphPointsToInstances{constructor(){this.addInput("points","geometry"),this.addOutput("instances","[mat4]"),this.properties={mode:1,autoupdate:!0},this.must_update=!0,this.matrices=[],this.first_time=!0}onExecute(){var geo=this.getInputData(0);geo?this.isOutputConnected(0)&&(((geo._version!=this._version||geo._id!=this._geometry_id)&&this.properties.autoupdate||this.first_time)&&(this.first_time=!1,this.updateInstances(geo)),this.setOutputData(0,this.matrices)):this.setOutputData(0,null)}updateInstances(geometry){var vertices=geometry.vertices;if(!vertices)return null;for(var normals=geometry.normals,matrices=this.matrices,num_points=vertices.length/3,identity=(matrices.length!=num_points&&(matrices.length=num_points),mat4.create()),temp=vec3.create(),UP=vec3.fromValues(0,1,0),FRONT=vec3.fromValues(0,0,-1),R=quat.create(),front=vec3.create(),right=vec3.create(),top=vec3.create(),i=0;i<vertices.length;i+=3){var normal,index=i/3,m=matrices[index],point=((m=m||(matrices[index]=mat4.create())).set(identity),vertices.subarray(i,i+3));switch(this.properties.mode){case LGraphPointsToInstances.NORMAL:mat4.setTranslation(m,point),normals&&(normal=normals.subarray(i,i+3),top.set(normal),vec3.normalize(top,top),vec3.cross(right,FRONT,top),vec3.normalize(right,right),vec3.cross(front,right,top),vec3.normalize(front,front),m.set(right,0),m.set(top,4),m.set(front,8),mat4.setTranslation(m,point));break;case LGraphPointsToInstances.VERTICAL:mat4.setTranslation(m,point);break;case LGraphPointsToInstances.SPHERICAL:front.set(point),vec3.normalize(front,front),vec3.cross(right,UP,front),vec3.normalize(right,right),vec3.cross(top,front,right),vec3.normalize(top,top),m.set(right,0),m.set(top,4),m.set(front,8),mat4.setTranslation(m,point);break;case LGraphPointsToInstances.RANDOM:temp[0]=2*Math.random()-1,temp[1]=2*Math.random()-1,temp[2]=2*Math.random()-1,vec3.normalize(temp,temp),quat.setAxisAngle(R,temp,2*Math.random()*Math.PI),mat4.fromQuat(m,R),mat4.setTranslation(m,point);break;case LGraphPointsToInstances.RANDOM_VERTICAL:quat.setAxisAngle(R,UP,2*Math.random()*Math.PI),mat4.fromQuat(m,R),mat4.setTranslation(m,point)}}this._version=geometry._version,this._geometry_id=geometry._id}static NORMAL=0;static VERTICAL=1;static SPHERICAL=2;static RANDOM=3;static RANDOM_VERTICAL=4;static modes={normal:0,vertical:1,spherical:2,random:3,random_vertical:4};static widgets_info={mode:{widget:"combo",values:LGraphPointsToInstances.modes}};static title="points to inst"}LiteGraph.registerNodeType("geometry/points_to_instances",LGraphPointsToInstances);class LGraphGeometryTransform{constructor(){this.addInput("in","geometry,[mat4]"),this.addInput("mat4","mat4"),this.addOutput("out","geometry"),this.properties={},this.geometry={type:"triangles",vertices:null,_id:generateGeometryId(),_version:0},this._last_geometry_id=-1,this._last_version=-1,this._last_key="",this.must_update=!0}onExecute(){var geo,key,input=this.getInputData(0),model=this.getInputData(1);if(input)if(input.constructor===Array){if(0!=input.length&&(this.outputs[0].type="[mat4]",this.isOutputConnected(0)))if(model){this._output||(this._output=new Array),this._output.length!=input.length&&(this._output.length=input.length);for(var i=0;i<input.length;++i){var m=(m=this._output[i])||(this._output[i]=mat4.create());mat4.multiply(m,input[i],model)}this.setOutputData(0,this._output)}else this.setOutputData(0,input)}else input.vertices&&input.vertices.length&&(geo=input,this.outputs[0].type="geometry",this.isOutputConnected(0))&&(model?(key=Array.from(model).join(","),!this.must_update&&geo._id==this._last_geometry_id&&geo._version==this._last_version&&key==this._last_key||(this.updateGeometry(geo,model),this._last_key=key,this._last_version=geo._version,this._last_geometry_id=geo._id,this.must_update=!1),this.setOutputData(0,this.geometry)):this.setOutputData(0,geo))}updateGeometry(geometry,model){var old_vertices=geometry.vertices,vertices=this.geometry.vertices,temp=(vertices&&vertices.length==old_vertices.length||(vertices=this.geometry.vertices=new Float32Array(old_vertices.length)),vec3.create());for(let i=0,l=vertices.length;i<l;i+=3)temp[0]=old_vertices[i],temp[1]=old_vertices[i+1],temp[2]=old_vertices[i+2],mat4.multiplyVec3(temp,model,temp),vertices[i]=temp[0],vertices[i+1]=temp[1],vertices[i+2]=temp[2];if(geometry.normals){this.geometry.normals&&this.geometry.normals.length==geometry.normals.length||(this.geometry.normals=new Float32Array(geometry.normals.length));var normals=this.geometry.normals,normal_model=mat4.invert(mat4.create(),model),old_normals=(normal_model&&mat4.transpose(normal_model,normal_model),geometry.normals);for(let i=0,l=normals.length;i<l;i+=3)temp[0]=old_normals[i],temp[1]=old_normals[i+1],temp[2]=old_normals[i+2],mat4.multiplyVec3(temp,normal_model,temp),normals[i]=temp[0],normals[i+1]=temp[1],normals[i+2]=temp[2]}this.geometry.type=geometry.type,this.geometry._version++}static title="Transform"}LiteGraph.registerNodeType("geometry/transform",LGraphGeometryTransform);class LGraphGeometryPolygon{constructor(){this.addInput("sides","number"),this.addInput("radius","number"),this.addOutput("out","geometry"),this.properties={sides:6,radius:1,uvs:!1},this.geometry={type:"line_loop",vertices:null,_id:generateGeometryId()},this.geometry_id=-1,this.version=-1,this.must_update=!0,this.last_info={sides:-1,radius:-1}}onExecute(){var radius,sides;this.isOutputConnected(0)&&(sides=this.getInputOrProperty("sides"),radius=this.getInputOrProperty("radius"),sides=0|Math.max(3,sides),this.last_info.sides==sides&&this.last_info.radius==radius||this.updateGeometry(sides,radius),this.setOutputData(0,this.geometry))}updateGeometry(sides,radius){var vertices=this.geometry.vertices,delta=(vertices&&vertices.length==3*sides||(vertices=this.geometry.vertices=new Float32Array(3*sides)),2*Math.PI/sides);this.properties.uvs&&(uvs=this.geometry.coords=new Float32Array(3*sides));for(var i=0;i<sides;++i){var angle=delta*-i,x=Math.cos(angle)*radius,angle=Math.sin(angle)*radius;vertices[3*i]=x,vertices[3*i+1]=0,vertices[3*i+2]=angle}this.geometry._id=++this.geometry_id,this.geometry._version=++this.version,this.last_info.sides=sides,this.last_info.radius=radius}static title="Polygon"}LiteGraph.registerNodeType("geometry/polygon",LGraphGeometryPolygon);class LGraphGeometryExtrude{constructor(){this.addInput("","geometry"),this.addOutput("","geometry"),this.properties={top_cap:!0,bottom_cap:!0,offset:[0,100,0]},this.version=-1,this._last_geo_version=-1,this._must_update=!0}onPropertyChanged(_name,_value){this._must_update=!0}onExecute(){var geo=this.getInputData(0);geo&&this.isOutputConnected(0)&&(geo.version==this._last_geo_version&&!this._must_update||(this._geo=this.extrudeGeometry(geo,this._geo),this._geo&&(this._geo.version=this.version++),this._must_update=!1),this.setOutputData(0,this._geo))}extrudeGeometry(geo){var vertices=geo.vertices,num_points=vertices.length/3,tempA=vec3.create(),tempB=vec3.create(),tempC=vec3.create(),tempD=vec3.create(),offset=new Float32Array(this.properties.offset);if("line_loop"==geo.type)for(var new_vertices=new Float32Array(6*num_points*3),npos=0,i=0,l=vertices.length;i<l;i+=3)tempA[0]=vertices[i],tempA[1]=vertices[i+1],tempA[2]=vertices[i+2],i+3<l?(tempB[0]=vertices[i+3],tempB[1]=vertices[i+4],tempB[2]=vertices[i+5]):(tempB[0]=vertices[0],tempB[1]=vertices[1],tempB[2]=vertices[2]),vec3.add(tempC,tempA,offset),vec3.add(tempD,tempB,offset),new_vertices.set(tempA,npos),new_vertices.set(tempB,npos+=3),new_vertices.set(tempC,npos+=3),new_vertices.set(tempB,npos+=3),new_vertices.set(tempD,npos+=3),new_vertices.set(tempC,npos+=3),npos+=3;return{_id:generateGeometryId(),type:"triangles",vertices:new_vertices}}static title="extrude"}LiteGraph.registerNodeType("geometry/extrude",LGraphGeometryExtrude);class LGraphGeometryEval{constructor(){this.addInput("in","geometry"),this.addOutput("out","geometry"),this.properties={code:"V[1] += 0.01 * Math.sin(I + T*0.001);",execute_every_frame:!1},this.geometry=null,this.geometry_id=-1,this.version=-1,this.must_update=!0,this.vertices=null,this.func=null}onConfigure(){this.compileCode()}compileCode(){if(this.properties.code)try{this.func=new Function("V","I","T",this.properties.code),this.boxcolor="#AFA",this.must_update=!0}catch(err){this.boxcolor="red"}}onPropertyChanged(name,value){"code"==name&&(this.properties.code=value,this.compileCode())}onExecute(){var geometry=this.getInputData(0);if(geometry)if(this.func){if(this.geometry_id!=geometry._id||this.version!=geometry._version||this.must_update||this.properties.execute_every_frame){this.must_update=!1,this.geometry_id=geometry._id,this.properties.execute_every_frame?this.version++:this.version=geometry._version;var i,func=this.func,T=getTime();for(i in this.geometry||(this.geometry={}),geometry)null!=geometry[i]&&(geometry[i].constructor==Float32Array?this.geometry[i]=new Float32Array(geometry[i]):this.geometry[i]=geometry[i]);this.geometry._id=geometry._id,this.properties.execute_every_frame?this.geometry._version=this.version:this.geometry._version=geometry._version+1;var V=vec3.create(),vertices=this.vertices;vertices&&this.vertices.length==geometry.vertices.length?vertices.set(geometry.vertices):vertices=this.vertices=new Float32Array(geometry.vertices);for(let i=0;i<vertices.length;i+=3)V[0]=vertices[i],V[1]=vertices[i+1],V[2]=vertices[i+2],func(V,i/3,T),vertices[i]=V[0],vertices[i+1]=V[1],vertices[i+2]=V[2];this.geometry.vertices=vertices}this.setOutputData(0,this.geometry)}else this.setOutputData(0,geometry)}static title="geoeval";static desc="eval code";static widgets_info={code:{widget:"code"}}}LiteGraph.registerNodeType("geometry/eval",LGraphGeometryEval);class LGraphConnectPoints{constructor(){this.addInput("in","geometry"),this.addOutput("out","geometry"),this.properties={min_dist:.4,max_dist:.5,max_connections:0,probability:1},this.geometry_id=-1,this.version=-1,this.my_version=1,this.must_update=!0}onPropertyChanged(_name,_value){this.must_update=!0}onExecute(){var geometry=this.getInputData(0);if(geometry){if(this.geometry_id!=geometry._id||this.version!=geometry._version||this.must_update){for(var i in this.must_update=!1,this.geometry_id=geometry._id,this.version=geometry._version,this.geometry={},geometry)this.geometry[i]=geometry[i];this.geometry._id=generateGeometryId(),this.geometry._version=this.my_version++;var vertices=geometry.vertices,l=vertices.length,min_dist=this.properties.min_dist,max_dist=this.properties.max_dist,probability=this.properties.probability,max_connections=this.properties.max_connections,indices=[];for(let i=0;i<l;i+=3){var x=vertices[i],y=vertices[i+1],z=vertices[i+2],connections=0;for(let j=i+3;j<l;j+=3){var x2=vertices[j],y2=vertices[j+1],z2=vertices[j+2],x2=Math.sqrt((x-x2)*(x-x2)+(y-y2)*(y-y2)+(z-z2)*(z-z2));if(!(max_dist<x2||x2<min_dist||probability<1&&probability<Math.random())&&(indices.push(i/3,j/3),connections+=1,max_connections&&max_connections<connections))break}}this.geometry.indices=this.indices=new Uint32Array(indices)}this.indices&&this.indices.length?(this.geometry.indices=this.indices,this.setOutputData(0,this.geometry)):this.setOutputData(0,null)}}static title="connect points";static desc="adds indices between near points"}if(LiteGraph.registerNodeType("geometry/connectPoints",LGraphConnectPoints),"undefined"!=typeof GL){class LGraphToGeometry{constructor(){this.addInput("mesh","mesh"),this.addOutput("out","geometry"),this.geometry={},this.last_mesh=null}onExecute(){var mesh=this.getInputData(0);if(mesh){if(mesh!=this.last_mesh){for(i in(this.last_mesh=mesh).vertexBuffers){var buffer=mesh.vertexBuffers[i];this.geometry[i]=buffer.data}mesh.indexBuffers.triangles&&(this.geometry.indices=mesh.indexBuffers.triangles.data),this.geometry._id=generateGeometryId(),this.geometry._version=0}this.setOutputData(0,this.geometry),this.geometry&&this.setOutputData(1,this.geometry.vertices)}}static title="to geometry";static desc="converts a mesh to geometry"}LiteGraph.registerNodeType("geometry/toGeometry",LGraphToGeometry);class LGraphGeometryToMesh{constructor(){this.addInput("in","geometry"),this.addOutput("mesh","mesh"),this.properties={},this.version=-1,this.mesh=null}updateMesh(geometry){for(var i in this.mesh||(this.mesh=new GL.Mesh),geometry){var buffer_data,info,mesh_buffer;"_"!=i[0]&&(buffer_data=geometry[i],(info=GL.Mesh.common_buffers[i])||"indices"==i)&&(info=info?info.spacing:3,(mesh_buffer=this.mesh.vertexBuffers[i])&&mesh_buffer.data.length==buffer_data.length?(mesh_buffer.data.set(buffer_data),mesh_buffer.upload(GL.DYNAMIC_DRAW)):mesh_buffer=new GL.Buffer("indices"==i?GL.ELEMENT_ARRAY_BUFFER:GL.ARRAY_BUFFER,buffer_data,info,GL.DYNAMIC_DRAW),this.mesh.addBuffer(i,mesh_buffer))}if(this.mesh.vertexBuffers.normals&&this.mesh.vertexBuffers.normals.data.length!=this.mesh.vertexBuffers.vertices.data.length){var n=new Float32Array([0,1,0]),normals=new Float32Array(this.mesh.vertexBuffers.vertices.data.length);for(let i=0;i<normals.length;i+=3)normals.set(n,i);mesh_buffer=new GL.Buffer(GL.ARRAY_BUFFER,normals,3),this.mesh.addBuffer("normals",mesh_buffer)}return this.mesh.updateBoundingBox(),this.geometry_id=this.mesh.id=geometry._id,this.version=this.mesh.version=geometry._version,this.mesh}onExecute(){var geometry=this.getInputData(0);geometry&&(this.version==geometry._version&&this.geometry_id==geometry._id||this.updateMesh(geometry),this.setOutputData(0,this.mesh))}static title="Geo to Mesh"}LiteGraph.registerNodeType("geometry/toMesh",LGraphGeometryToMesh);class LGraphRenderMesh{constructor(){this.addInput("mesh","mesh"),this.addInput("mat4","mat4"),this.addInput("tex","texture"),this.properties={enabled:!0,primitive:GL.TRIANGLES,additive:!1,color:[1,1,1],opacity:1},this.color=vec4.create([1,1,1,1]),this.model_matrix=mat4.create(),this.uniforms={u_color:this.color,u_model:this.model_matrix}}onExecute(){var mesh,shader,m,model_matrix;this.properties.enabled&&(mesh=this.getInputData(0))&&(LGraphRender.onRequestCameraMatrices?(LGraphRender.onRequestCameraMatrices(view_matrix,projection_matrix,viewprojection_matrix),shader=null,shader=this.getInputData(2)?(shader=gl.shaders.textured)||(gl.shaders.textured=new GL.Shader(LGraphRenderPoints.vertex_shader_code,LGraphRenderPoints.fragment_shader_code,{USE_TEXTURE:""})):(shader=gl.shaders.flat)||(gl.shaders.flat=new GL.Shader(LGraphRenderPoints.vertex_shader_code,LGraphRenderPoints.fragment_shader_code)),this.color.set(this.properties.color),this.color[3]=this.properties.opacity,model_matrix=this.model_matrix,(m=this.getInputData(1))?model_matrix.set(m):mat4.identity(model_matrix),this.uniforms.u_point_size=1,m=this.properties.primitive,shader.uniforms(global_uniforms),shader.uniforms(this.uniforms),1<=this.properties.opacity?gl.disable(gl.BLEND):gl.enable(gl.BLEND),gl.enable(gl.DEPTH_TEST),this.properties.additive?(gl.blendFunc(gl.SRC_ALPHA,gl.ONE),gl.depthMask(!1)):gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),model_matrix="indices",mesh.indexBuffers.triangles&&(model_matrix="triangles"),shader.draw(mesh,m,model_matrix),gl.disable(gl.BLEND),gl.depthMask(!0)):console.warn?.("cannot render geometry, LiteGraph.onRequestCameraMatrices is null, remember to fill this with a callback(view_matrix, projection_matrix,viewprojection_matrix) to use 3D rendering from the graph"))}static title="Render Mesh";static desc="renders a mesh flat";static PRIMITIVE_VALUES={points:GL.POINTS,lines:GL.LINES,line_loop:GL.LINE_LOOP,line_strip:GL.LINE_STRIP,triangles:GL.TRIANGLES,triangle_fan:GL.TRIANGLE_FAN,triangle_strip:GL.TRIANGLE_STRIP};static widgets_info={primitive:{widget:"combo",values:LGraphRenderMesh.PRIMITIVE_VALUES},color:{widget:"color"}}}LiteGraph.registerNodeType("geometry/render_mesh",LGraphRenderMesh);class LGraphGeometryPrimitive{constructor(){this.addInput("size","number"),this.addOutput("out","mesh"),this.properties={type:1,size:1,subdivisions:32},this.version=1e5*Math.random()|0,this.last_info={type:-1,size:-1,subdivisions:-1}}onExecute(){var size;this.isOutputConnected(0)&&(size=this.getInputOrProperty("size"),this.last_info.type==this.properties.type&&this.last_info.size==size&&this.last_info.subdivisions==this.properties.subdivisions||this.updateMesh(this.properties.type,size,this.properties.subdivisions),this.setOutputData(0,this._mesh))}updateMesh(type,size,subdivisions){switch(subdivisions=0|Math.max(0,subdivisions),type){case 1:this._mesh=GL.Mesh.cube({size:size,normals:!0,coords:!0});break;case 2:this._mesh=GL.Mesh.plane({size:size,xz:!0,detail:subdivisions,normals:!0,coords:!0});break;case 3:this._mesh=GL.Mesh.cylinder({size:size,subdivisions:subdivisions,normals:!0,coords:!0});break;case 4:this._mesh=GL.Mesh.sphere({size:size,long:subdivisions,lat:subdivisions,normals:!0,coords:!0});break;case 5:this._mesh=GL.Mesh.circle({size:size,slices:subdivisions,normals:!0,coords:!0});break;case 6:this._mesh=GL.Mesh.sphere({size:size,long:subdivisions,lat:subdivisions,normals:!0,coords:!0,hemi:!0});break;case 7:this._mesh=GL.Mesh.icosahedron({size:size,subdivisions:subdivisions});break;case 8:this._mesh=GL.Mesh.cone({radius:size,height:size,subdivisions:subdivisions});break;case 9:this._mesh=GL.Mesh.plane({size:size,xz:!1,detail:subdivisions,normals:!0,coords:!0})}this.last_info.type=type,this.last_info.size=size,this.last_info.subdivisions=subdivisions,this._mesh.version=this.version++}static title="Primitive";static VALID={CUBE:1,PLANE:2,CYLINDER:3,SPHERE:4,CIRCLE:5,HEMISPHERE:6,ICOSAHEDRON:7,CONE:8,QUAD:9};static widgets_info={type:{widget:"combo",values:LGraphGeometryPrimitive.VALID}}}LiteGraph.registerNodeType("geometry/mesh_primitive",LGraphGeometryPrimitive);class LGraphRenderPoints{constructor(){this.addInput("in","geometry"),this.addInput("mat4","mat4"),this.addInput("tex","texture"),this.properties={enabled:!0,point_size:.1,fixed_size:!1,additive:!0,color:[1,1,1],opacity:1},this.color=vec4.create([1,1,1,1]),this.uniforms={u_point_size:1,u_perspective:1,u_point_perspective:1,u_color:this.color},this.geometry_id=-1,this.version=-1,this.mesh=null}updateMesh(geometry){this.buffer&&this.buffer.data&&this.buffer.data.length==geometry.vertices.length?(this.buffer.data.set(geometry.vertices),this.buffer.upload(GL.DYNAMIC_DRAW)):this.buffer=new GL.Buffer(GL.ARRAY_BUFFER,geometry.vertices,3,GL.DYNAMIC_DRAW),this.mesh||(this.mesh=new GL.Mesh),this.mesh.addBuffer("vertices",this.buffer),this.geometry_id=this.mesh.id=geometry._id,this.version=this.mesh.version=geometry._version}onExecute(){var geometry,m;this.properties.enabled&&(geometry=this.getInputData(0))&&(this.version==geometry._version&&this.geometry_id==geometry._id||this.updateMesh(geometry),LGraphRender.onRequestCameraMatrices?(LGraphRender.onRequestCameraMatrices(view_matrix,projection_matrix,viewprojection_matrix),geometry=null,geometry=this.getInputData(2)?(geometry=gl.shaders.textured_points)||(gl.shaders.textured_points=new GL.Shader(LGraphRenderPoints.vertex_shader_code,LGraphRenderPoints.fragment_shader_code,{USE_TEXTURED_POINTS:""})):(geometry=gl.shaders.points)||(gl.shaders.points=new GL.Shader(LGraphRenderPoints.vertex_shader_code,LGraphRenderPoints.fragment_shader_code,{USE_POINTS:""})),this.color.set(this.properties.color),this.color[3]=this.properties.opacity,(m=this.getInputData(1))?model_matrix.set(m):mat4.identity(model_matrix),this.uniforms.u_point_size=this.properties.point_size,this.uniforms.u_point_perspective=this.properties.fixed_size?0:1,this.uniforms.u_perspective=gl.viewport_data[3]*projection_matrix[5],geometry.uniforms(global_uniforms),geometry.uniforms(this.uniforms),1<=this.properties.opacity?gl.disable(gl.BLEND):gl.enable(gl.BLEND),gl.enable(gl.DEPTH_TEST),this.properties.additive?(gl.blendFunc(gl.SRC_ALPHA,gl.ONE),gl.depthMask(!1)):gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),geometry.draw(this.mesh,GL.POINTS),gl.disable(gl.BLEND),gl.depthMask(!0)):console.warn?.("cannot render geometry, LiteGraph.onRequestCameraMatrices is null, remember to fill this with a callback(view_matrix, projection_matrix,viewprojection_matrix) to use 3D rendering from the graph"))}static title="renderPoints";static desc="render points with a texture";static widgets_info={color:{widget:"color"}};static vertex_shader_code=`
            precision mediump float;
            attribute vec3 a_vertex;
            varying vec3 v_vertex;
            attribute vec3 a_normal;
            varying vec3 v_normal;
            #ifdef USE_COLOR
                attribute vec4 a_color;
                varying vec4 v_color;
            #endif
            attribute vec2 a_coord;
            varying vec2 v_coord;
            #ifdef USE_SIZE
                attribute float a_extra;
            #endif
            #ifdef USE_INSTANCING
                attribute mat4 u_model;
            #else
                uniform mat4 u_model;
            #endif
            uniform mat4 u_viewprojection;
            uniform float u_point_size;
            uniform float u_perspective;
            uniform float u_point_perspective;
            float computePointSize(float radius, float w)
            {
                if(radius < 0.0)
                    return -radius;
                return u_perspective * radius / w;
            }
            void main() {
                v_coord = a_coord;
                #ifdef USE_COLOR
                    v_color = a_color;
                #endif
                v_vertex = ( u_model * vec4( a_vertex, 1.0 )).xyz;
                v_normal = ( u_model * vec4( a_normal, 0.0 )).xyz;
                gl_Position = u_viewprojection * vec4(v_vertex,1.0);
                gl_PointSize = u_point_size;
                #ifdef USE_SIZE
                    gl_PointSize = a_extra;
                #endif
                if(u_point_perspective != 0.0)
                    gl_PointSize = computePointSize( gl_PointSize, gl_Position.w );
            }
        `;static fragment_shader_code=`
            precision mediump float;
            uniform vec4 u_color;
            #ifdef USE_COLOR
                varying vec4 v_color;
            #endif
            varying vec2 v_coord;
            uniform sampler2D u_texture;
            void main() {
                vec4 color = u_color;
                #ifdef USE_TEXTURED_POINTS
                    color *= texture2D(u_texture, gl_PointCoord.xy);
                #else
                    #ifdef USE_TEXTURE
                        color *= texture2D(u_texture, v_coord);
                        if(color.a < 0.1)
                            discard;
                    #endif
                    #ifdef USE_POINTS
                        float dist = length( gl_PointCoord.xy - vec2(0.5) );
                        if( dist > 0.45 )
                            discard;
                    #endif
                #endif
                #ifdef USE_COLOR
                    color *= v_color;
                #endif
                gl_FragColor = color;
            }
        `}LiteGraph.registerNodeType("geometry/render_points",LGraphRenderPoints)}class LGraphFXLens{constructor(){this.addInput("Texture","Texture"),this.addInput("Aberration","number"),this.addInput("Distortion","number"),this.addInput("Blur","number"),this.addOutput("Texture","Texture"),this.properties={aberration:1,distortion:1,blur:1,precision:LGraphTexture.DEFAULT},LGraphFXLens._shader||(LGraphFXLens._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,LGraphFXLens.pixel_shader),LGraphFXLens._texture=new GL.Texture(3,1,{format:gl.RGB,wrap:gl.CLAMP_TO_EDGE,magFilter:gl.LINEAR,minFilter:gl.LINEAR,pixel_data:[255,0,0,0,255,0,0,0,255]}))}static title="Lens";static desc="Camera Lens distortion";static widgets_info={precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}};onExecute(){var aberration,distortion,blur,mesh,shader,tex=this.getInputData(0);this.properties.precision===LGraphTexture.PASS_THROUGH?this.setOutputData(0,tex):tex&&(this._tex=LGraphTexture.getTargetTexture(tex,this._tex,this.properties.precision),aberration=this.properties.aberration,this.isInputConnected(1)&&(aberration=this.getInputData(1),this.properties.aberration=aberration),distortion=this.properties.distortion,this.isInputConnected(2)&&(distortion=this.getInputData(2),this.properties.distortion=distortion),blur=this.properties.blur,this.isInputConnected(3)&&(blur=this.getInputData(3),this.properties.blur=blur),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),mesh=Mesh.getScreenQuad(),shader=LGraphFXLens._shader,this._tex.drawTo(function(){tex.bind(0),shader.uniforms({u_texture:0,u_aberration:aberration,u_distortion:distortion,u_blur:blur}).draw(mesh)}),this.setOutputData(0,this._tex))}static pixel_shader=`
        precision highp float;
        varying vec2 v_coord;
        uniform sampler2D u_texture;
        uniform vec2 u_camera_planes;
        uniform float u_aberration;
        uniform float u_distortion;
        uniform float u_blur;
        
        void main() {
            vec2 coord = v_coord;
            float dist = distance(vec2(0.5), coord);
            vec2 dist_coord = coord - vec2(0.5);
            float percent = 1.0 + ((0.5 - dist) / 0.5) * u_distortion;
            dist_coord *= percent;
            coord = dist_coord + vec2(0.5);
            vec4 color = texture2D(u_texture, coord, u_blur * dist);
            color.r = texture2D(u_texture, vec2(0.5) + dist_coord * (1.0 + 0.01 * u_aberration), u_blur * dist).r;
            color.b = texture2D(u_texture, vec2(0.5) + dist_coord * (1.0 - 0.01 * u_aberration), u_blur * dist).b;
            gl_FragColor = color;
        }
    `}LiteGraph.registerNodeType("fx/lens",LGraphFXLens);class LGraphFXBokeh{constructor(){this.addInput("Texture","Texture"),this.addInput("Blurred","Texture"),this.addInput("Mask","Texture"),this.addInput("Threshold","number"),this.addOutput("Texture","Texture"),this.properties={shape:"",size:10,alpha:1,threshold:1,high_precision:!1}}static title="Bokeh";static desc="applies an Bokeh effect";static widgets_info={shape:{widget:"texture"}};onExecute(){var shape_tex,threshold,precision,first_shader,second_shader,points_mesh,screen_mesh,point_size,alpha,tex=this.getInputData(0),blurred_tex=this.getInputData(1),mask_tex=this.getInputData(2);tex&&mask_tex&&this.properties.shape?(blurred_tex=blurred_tex||tex,(shape_tex=LGraphTexture.getTexture(this.properties.shape))&&(threshold=this.properties.threshold,this.isInputConnected(3)&&(threshold=this.getInputData(3),this.properties.threshold=threshold),precision=gl.UNSIGNED_BYTE,this.properties.high_precision&&(precision=gl.half_float_ext?gl.HALF_FLOAT_OES:gl.FLOAT),this._temp_texture&&this._temp_texture.type==precision&&this._temp_texture.width==tex.width&&this._temp_texture.height==tex.height||(this._temp_texture=new GL.Texture(tex.width,tex.height,{type:precision,format:gl.RGBA,filter:gl.LINEAR})),first_shader=(first_shader=LGraphFXBokeh._first_shader)||(LGraphFXBokeh._first_shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,LGraphFXBokeh._first_pixel_shader)),second_shader=(second_shader=LGraphFXBokeh._second_shader)||(LGraphFXBokeh._second_shader=new GL.Shader(LGraphFXBokeh._second_vertex_shader,LGraphFXBokeh._second_pixel_shader)),(points_mesh=this._points_mesh)&&points_mesh._width==tex.width&&points_mesh._height==tex.height&&2==points_mesh._spacing||(points_mesh=this.createPointsMesh(tex.width,tex.height,2)),screen_mesh=Mesh.getScreenQuad(),point_size=this.properties.size,alpha=this.properties.alpha,gl.disable(gl.DEPTH_TEST),gl.disable(gl.BLEND),this._temp_texture.drawTo(function(){tex.bind(0),blurred_tex.bind(1),mask_tex.bind(2),first_shader.uniforms({u_texture:0,u_texture_blur:1,u_mask:2,u_texsize:[tex.width,tex.height]}).draw(screen_mesh)}),this._temp_texture.drawTo(function(){gl.enable(gl.BLEND),gl.blendFunc(gl.ONE,gl.ONE),tex.bind(0),shape_tex.bind(3),second_shader.uniforms({u_texture:0,u_mask:2,u_shape:3,u_alpha:alpha,u_threshold:threshold,u_pointSize:point_size,u_itexsize:[1/tex.width,1/tex.height]}).draw(points_mesh,gl.POINTS)}),this.setOutputData(0,this._temp_texture))):this.setOutputData(0,tex)}createPointsMesh(width,height,spacing){for(var nwidth=Math.round(width/spacing),nheight=Math.round(height/spacing),vertices=new Float32Array(nwidth*nheight*2),ny=-1,dx=2/width*spacing,dy=2/height*spacing,y=0;y<nheight;++y){for(var nx=-1,x=0;x<nwidth;++x){var pos=y*nwidth*2+2*x;vertices[pos]=nx,vertices[1+pos]=ny,nx+=dx}ny+=dy}return this._points_mesh=GL.Mesh.load({vertices2D:vertices}),this._points_mesh._width=width,this._points_mesh._height=height,this._points_mesh._spacing=spacing,this._points_mesh}static _first_pixel_shader=`
        precision highp float;
        varying vec2 v_coord;
        uniform sampler2D u_texture;
        uniform sampler2D u_texture_blur;
        uniform sampler2D u_mask;

        void main() {
            vec4 color = texture2D(u_texture, v_coord);
            vec4 blurred_color = texture2D(u_texture_blur, v_coord);
            float mask = texture2D(u_mask, v_coord).x;
            gl_FragColor = mix(color, blurred_color, mask);
        }
    `;static _second_vertex_shader=`
        precision highp float;
        attribute vec2 a_vertex2D;
        varying vec4 v_color;
        uniform sampler2D u_texture;
        uniform sampler2D u_mask;
        uniform vec2 u_itexsize;
        uniform float u_pointSize;
        uniform float u_threshold;
        
        void main() {
            vec2 coord = a_vertex2D * 0.5 + 0.5;
            v_color = texture2D(u_texture, coord);
            v_color += texture2D(u_texture, coord + vec2(u_itexsize.x, 0.0));
            v_color += texture2D(u_texture, coord + vec2(0.0, u_itexsize.y));
            v_color += texture2D(u_texture, coord + u_itexsize);
            v_color *= 0.25;
            float mask = texture2D(u_mask, coord).x;
            float luminance = length(v_color) * mask;
            // luminance /= (u_pointSize * u_pointSize) * 0.01;
            luminance -= u_threshold;
            if (luminance < 0.0) {
                gl_Position.x = -100.0;
                return;
            }
            gl_PointSize = u_pointSize;
            gl_Position = vec4(a_vertex2D, 0.0, 1.0);
        }
    `;static _second_pixel_shader=`
        precision highp float;
        varying vec4 v_color;
        uniform sampler2D u_shape;
        uniform float u_alpha;
        
        void main() {
            vec4 color = texture2D(u_shape, gl_PointCoord);
            color *= v_color * u_alpha;
            gl_FragColor = color;
        }
    `}LiteGraph.registerNodeType("fx/bokeh",LGraphFXBokeh);class LGraphFXGeneric{constructor(){this.addInput("Texture","Texture"),this.addInput("value1","number"),this.addInput("value2","number"),this.addOutput("Texture","Texture"),this.properties={fx:"halftone",value1:1,value2:1,precision:LGraphTexture.DEFAULT}}static title="FX";static desc="applies an FX from a list";static widgets_info={fx:{widget:"combo",values:["halftone","pixelate","lowpalette","noise","gamma"]},precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}};static shaders={};onExecute(){if(this.isOutputConnected(0)){var tex=this.getInputData(0);if(this.properties.precision===LGraphTexture.PASS_THROUGH)this.setOutputData(0,tex);else if(tex){this._tex=LGraphTexture.getTargetTexture(tex,this._tex,this.properties.precision);var value1=this.properties.value1,value2=(this.isInputConnected(1)&&(value1=this.getInputData(1),this.properties.value1=value1),this.properties.value2),fx=(this.isInputConnected(2)&&(value2=this.getInputData(2),this.properties.value2=value2),this.properties.fx),shader=LGraphFXGeneric.shaders[fx];if(!shader){var pixel_shader_code=LGraphFXGeneric["pixel_shader_"+fx];if(!pixel_shader_code)return;shader=LGraphFXGeneric.shaders[fx]=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,pixel_shader_code)}gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var mesh=Mesh.getScreenQuad(),camera_planes=(LS?LS.Renderer._current_camera:null)?[LS.Renderer._current_camera.near,LS.Renderer._current_camera.far]:[1,100],noise=null;"noise"==fx&&(noise=LGraphTexture.getNoiseTexture()),this._tex.drawTo(function(){tex.bind(0),"noise"==fx&&noise.bind(1),shader.uniforms({u_texture:0,u_noise:1,u_size:[tex.width,tex.height],u_rand:[Math.random(),Math.random()],u_value1:value1,u_value2:value2,u_camera_planes:camera_planes}).draw(mesh)}),this.setOutputData(0,this._tex)}}}static pixel_shader_halftone=`
        precision highp float;
        varying vec2 v_coord;
        uniform sampler2D u_texture;
        uniform vec2 u_camera_planes;
        uniform vec2 u_size;
        uniform float u_value1;
        uniform float u_value2;
        
        float pattern() {
            float s = sin(u_value1 * 3.1415), c = cos(u_value1 * 3.1415);
            vec2 tex = v_coord * u_size.xy;
            vec2 point = vec2(
                c * tex.x - s * tex.y ,
                s * tex.x + c * tex.y
            ) * u_value2;
            return (sin(point.x) * sin(point.y)) * 4.0;
        }
        
        void main() {
            vec4 color = texture2D(u_texture, v_coord);
            float average = (color.r + color.g + color.b) / 3.0;
            gl_FragColor = vec4(vec3(average * 10.0 - 5.0 + pattern()), color.a);
        }
    `;static pixel_shader_pixelate=`
        precision highp float;
        varying vec2 v_coord;
        uniform sampler2D u_texture;
        uniform vec2 u_camera_planes;
        uniform vec2 u_size;
        uniform float u_value1;
        uniform float u_value2;
        
        void main() {
            vec2 coord = vec2(floor(v_coord.x * u_value1) / u_value1, floor(v_coord.y * u_value2) / u_value2);
            vec4 color = texture2D(u_texture, coord);
            gl_FragColor = color;
        }
    `;static pixel_shader_lowpalette=`
        precision highp float;
        varying vec2 v_coord;
        uniform sampler2D u_texture;
        uniform vec2 u_camera_planes;
        uniform vec2 u_size;
        uniform float u_value1;
        uniform float u_value2;
        
        void main() {
            vec4 color = texture2D(u_texture, v_coord);
            gl_FragColor = floor(color * u_value1) / u_value1;
        }
    `;static pixel_shader_noise=`
        precision highp float;
        varying vec2 v_coord;
        uniform sampler2D u_texture;
        uniform sampler2D u_noise;
        uniform vec2 u_size;
        uniform float u_value1;
        uniform float u_value2;
        uniform vec2 u_rand;
        
        void main() {
            vec4 color = texture2D(u_texture, v_coord);
            vec3 noise = texture2D(u_noise, v_coord * vec2(u_size.x / 512.0, u_size.y / 512.0) + u_rand).xyz - vec3(0.5);
            gl_FragColor = vec4(color.xyz + noise * u_value1, color.a);
        }
    `;static pixel_shader_gamma=`
        precision highp float;
        varying vec2 v_coord;
        uniform sampler2D u_texture;
        uniform float u_value1;
        
        void main() {
            vec4 color = texture2D(u_texture, v_coord);
            float gamma = 1.0 / u_value1;
            gl_FragColor = vec4(pow(color.xyz, vec3(gamma)), color.a);
        }
    `}LiteGraph.registerNodeType("fx/generic",LGraphFXGeneric);class LGraphFXVigneting{constructor(){this.addInput("Tex.","Texture"),this.addInput("intensity","number"),this.addOutput("Texture","Texture"),this.properties={intensity:1,invert:!1,precision:LGraphTexture.DEFAULT},LGraphFXVigneting._shader||(LGraphFXVigneting._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,LGraphFXVigneting.pixel_shader))}static title="Vigneting";static desc="Vigneting";static widgets_info={precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}};onExecute(){var intensity,mesh,shader,invert,tex=this.getInputData(0);this.properties.precision===LGraphTexture.PASS_THROUGH?this.setOutputData(0,tex):tex&&(this._tex=LGraphTexture.getTargetTexture(tex,this._tex,this.properties.precision),intensity=this.properties.intensity,this.isInputConnected(1)&&(intensity=this.getInputData(1),this.properties.intensity=intensity),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),mesh=Mesh.getScreenQuad(),shader=LGraphFXVigneting._shader,invert=this.properties.invert,this._tex.drawTo(function(){tex.bind(0),shader.uniforms({u_texture:0,u_intensity:intensity,u_isize:[1/tex.width,1/tex.height],u_invert:invert?1:0}).draw(mesh)}),this.setOutputData(0,this._tex))}static pixel_shader=`
        precision highp float;
        varying vec2 v_coord;
        uniform sampler2D u_texture;
        uniform float u_intensity;
        uniform int u_invert;
        
        void main() {
            float luminance = 1.0 - length(v_coord - vec2(0.5)) * 1.414;
            vec4 color = texture2D(u_texture, v_coord);
            
            if (u_invert == 1) {
                luminance = 1.0 - luminance;
            }
            
            luminance = mix(1.0, luminance, u_intensity);
            gl_FragColor = vec4(luminance * color.xyz, color.a);
        }
    `}LiteGraph.registerNodeType("fx/vigneting",LGraphFXVigneting);var MIDI_COLOR="#243",i;class MIDIEvent{constructor(data){this.channel=0,this.cmd=0,this.data=new Uint32Array(3),data&&this.setup(data)}fromJSON(o){this.setup(o.data)}setup(data){var raw_data=data,data=(data.constructor===Object&&(raw_data=data.data),this.data.set(raw_data),raw_data[0]),raw_data=240&(this.status=data);this.cmd=240<=data?data:raw_data,this.cmd==MIDIEvent.NOTEON&&0==this.velocity&&(this.cmd=MIDIEvent.NOTEOFF),this.cmd_str=MIDIEvent.commands[this.cmd]||"",(raw_data>=MIDIEvent.NOTEON||raw_data<=MIDIEvent.NOTEOFF)&&(this.channel=15&data)}get velocity(){return this.cmd==MIDIEvent.NOTEON?this.data[2]:-1}set velocity(v){this.data[2]=v}get note(){return this.cmd!=MIDIEvent.NOTEON?-1:MIDIEvent.toNoteString(this.data[1],!0)}set note(v){throw new Error("notes cannot be assigned this way, must modify the data[1]")}get octave(){var octave;return this.cmd!=MIDIEvent.NOTEON?-1:(octave=this.data[1]-24,Math.floor(octave/12+1))}set octave(v){throw new Error("octave cannot be assigned this way, must modify the data[1]")}getPitch(){return 440*Math.pow(2,(this.data[1]-69)/12)}static computePitch(note){return 440*Math.pow(2,(note-69)/12)}getCC(){return this.data[1]}getCCValue(){return this.data[2]}getPitchBend(){return this.data[1]+(this.data[2]<<7)-8192}static computePitchBend(v1,v2){return v1+(v2<<7)-8192}setCommandFromString(str){this.cmd=MIDIEvent.computeCommandFromString(str)}static computeCommandFromString(str){if(!str)return 0;if(str&&str.constructor===Number)return str;switch(str=str.toUpperCase()){case"NOTE ON":case"NOTEON":return MIDIEvent.NOTEON;case"NOTE OFF":case"NOTEOFF":return MIDIEvent.NOTEON;case"KEY PRESSURE":case"KEYPRESSURE":return MIDIEvent.KEYPRESSURE;case"CONTROLLER CHANGE":case"CONTROLLERCHANGE":case"CC":return MIDIEvent.CONTROLLERCHANGE;case"PROGRAM CHANGE":case"PROGRAMCHANGE":case"PC":return MIDIEvent.PROGRAMCHANGE;case"CHANNEL PRESSURE":case"CHANNELPRESSURE":return MIDIEvent.CHANNELPRESSURE;case"PITCH BEND":case"PITCHBEND":return MIDIEvent.PITCHBEND;case"TIME TICK":case"TIMETICK":return MIDIEvent.TIMETICK;default:return Number(str)}}static toNoteString(d,skip_octave){var note=(d=Math.round(d))-21,d=Math.floor((d-24)/12+1);return(note%=12)<0&&(note=12+note),MIDIEvent.notes[note]+(skip_octave?"":d)}static NoteStringToPitch(str){var note=(str=str.toUpperCase())[0],octave=4,str=("#"==str[1]?(note+="#",2<str.length&&(octave=Number(str[2]))):1<str.length&&(octave=Number(str[1])),MIDIEvent.note_to_index[note]);return null==str?null:12*(octave-1)+str+21}toString(){var str=this.channel+". ";switch(this.cmd){case MIDIEvent.NOTEON:str+="NOTEON "+MIDIEvent.toNoteString(this.data[1]);break;case MIDIEvent.NOTEOFF:str+="NOTEOFF "+MIDIEvent.toNoteString(this.data[1]);break;case MIDIEvent.CONTROLLERCHANGE:str+="CC "+this.data[1]+" "+this.data[2];break;case MIDIEvent.PROGRAMCHANGE:str+="PC "+this.data[1];break;case MIDIEvent.PITCHBEND:str+="PITCHBEND "+this.getPitchBend();break;case MIDIEvent.KEYPRESSURE:str+="KEYPRESS "+this.data[1]}return str}toHexString(){return this.data.map(byte=>byte.toString(16)).join(" ")}toJSON(){return{data:[this.data[0],this.data[1],this.data[2]],object_class:"MIDIEvent"}}static notes=["A","A#","B","C","C#","D","D#","E","F","F#","G","G#"];static note_to_index={A:0,"A#":1,B:2,C:3,"C#":4,D:5,"D#":6,E:7,F:8,"F#":9,G:10,"G#":11};static commands={128:"note off",144:"note on",160:"key pressure",176:"controller change",192:"program change",208:"channel pressure",224:"pitch bend",240:"system",242:"Song pos",243:"Song select",246:"Tune request",248:"time tick",250:"Start Song",251:"Continue Song",252:"Stop Song",254:"Sensing",255:"Reset"};static commands_short={128:"NOTEOFF",144:"NOTEOFF",160:"KEYP",176:"CC",192:"PC",208:"CP",224:"PB",240:"SYS",242:"POS",243:"SELECT",246:"TUNEREQ",248:"TT",250:"START",251:"CONTINUE",252:"STOP",254:"SENS",255:"RESET"};static commands_reversed={}}for(i in MIDIEvent.NOTEOFF=128,MIDIEvent.NOTEON=144,MIDIEvent.KEYPRESSURE=160,MIDIEvent.CONTROLLERCHANGE=176,MIDIEvent.PROGRAMCHANGE=192,MIDIEvent.CHANNELPRESSURE=208,MIDIEvent.PITCHBEND=224,MIDIEvent.TIMETICK=248,LiteGraph.MIDIEvent=MIDIEvent,MIDIEvent.commands)MIDIEvent.commands_reversed[MIDIEvent.commands[i]]=i;class MIDIInterface{constructor(on_ready,on_error){navigator.requestMIDIAccess?(this.on_ready=on_ready,this.state={note:[],cc:[]},this.input_ports=null,this.input_ports_info=[],this.output_ports=null,this.output_ports_info=[],navigator.requestMIDIAccess().then(this.onMIDISuccess.bind(this),this.onMIDIFailure.bind(this))):(this.error="not suppoorted",on_error?on_error("Not supported"):console.error?.("MIDI NOT SUPPORTED, enable by chrome://flags"))}onMIDISuccess(midiAccess){console.log?.("MIDI ready!"),LiteGraph.debug&&console.log?.(midiAccess),this.midi=midiAccess,this.updatePorts(),this.on_ready&&this.on_ready(this)}updatePorts(){for(var midi=this.midi,num=(this.input_ports=midi.inputs,this.input_ports_info=[],this.output_ports=midi.outputs,this.output_ports_info=[],0),it=this.input_ports.values(),it_value=it.next();it_value&&!1===it_value.done;){var port_info=it_value.value;this.input_ports_info.push(port_info),LiteGraph.debug&&console.log?.("Input port [type:'"+port_info.type+"'] id:'"+port_info.id+"' manufacturer:'"+port_info.manufacturer+"' name:'"+port_info.name+"' version:'"+port_info.version+"'"),num++,it_value=it.next()}for(this.num_input_ports=num,num=0,it_value=(it=this.output_ports.values()).next();it_value&&!1===it_value.done;){let port_info=it_value.value;this.output_ports_info.push(port_info),LiteGraph.debug&&console.log?.("Output port [type:'"+port_info.type+"'] id:'"+port_info.id+"' manufacturer:'"+port_info.manufacturer+"' name:'"+port_info.name+"' version:'"+port_info.version+"'"),num++,it_value=it.next()}this.num_output_ports=num}onMIDIFailure(msg){console.error?.("Failed to get MIDI access - "+msg)}openInputPort(port,callback){var that,port=this.input_ports.get("input-"+port);return!!port&&(that=MIDIInterface.input=this,port.onmidimessage=function(a){var midi_event=new MIDIEvent(a.data);that.updateState(midi_event),callback&&callback(a.data,midi_event),MIDIInterface.on_message&&MIDIInterface.on_message(a.data,midi_event)},console.log?.("port open: ",port),!0)}updateState(midi_event){switch(midi_event.cmd){case MIDIEvent.NOTEON:this.state.note[0|midi_event.value1]=midi_event.value2;break;case MIDIEvent.NOTEOFF:this.state.note[0|midi_event.value1]=0;break;case MIDIEvent.CONTROLLERCHANGE:this.state.cc[midi_event.getCC()]=midi_event.getCCValue()}}sendMIDI(port,midi_data){midi_data&&(port=this.output_ports_info[port])&&(MIDIInterface.output=this,midi_data.constructor===MIDIEvent?port.send(midi_data.data):port.send(midi_data))}static input=null}MIDIInterface.MIDIEvent=MIDIEvent;class LGMIDIIn{static title="MIDI Input";static desc="Reads MIDI from a input port";constructor(){this.addOutput("on_midi",LiteGraph.EVENT),this.addOutput("out","midi"),this.properties={port:0},this._last_midi_event=null,this._current_midi_event=null,this.boxcolor="#AAA",this._last_time=0;var that=this;new MIDIInterface(function(midi){that._midi=midi,that._waiting&&that.onStart(),that._waiting=!1})}getPropertyInfo(name){if(this._midi&&"port"==name){for(var values={},i=0;i<this._midi.input_ports_info.length;++i){var input=this._midi.input_ports_info[i];values[i]=i+".- "+input.name+" version:"+input.version}return{type:"enum",values:values}}}onStart(){this._midi?this._midi.openInputPort(this.properties.port,this.onMIDIEvent.bind(this)):this._waiting=!0}onMIDIEvent(data,midi_event){this._last_midi_event=midi_event,this.boxcolor="#AFA",this._last_time=LiteGraph.getTime(),this.trigger("on_midi",midi_event),midi_event.cmd==MIDIEvent.NOTEON?this.trigger("on_noteon",midi_event):midi_event.cmd==MIDIEvent.NOTEOFF?this.trigger("on_noteoff",midi_event):midi_event.cmd==MIDIEvent.CONTROLLERCHANGE?this.trigger("on_cc",midi_event):midi_event.cmd==MIDIEvent.PROGRAMCHANGE?this.trigger("on_pc",midi_event):midi_event.cmd==MIDIEvent.PITCHBEND&&this.trigger("on_pitchbend",midi_event)}onDrawBackground(ctx){var now,t;this.boxcolor="#AAA",!this.flags.collapsed&&this._last_midi_event&&(ctx.fillStyle="white",now=LiteGraph.getTime(),0<(now=1-Math.max(0,.001*(now-this._last_time))))&&(t=ctx.globalAlpha,ctx.globalAlpha*=now,ctx.font="12px Tahoma",ctx.fillText(this._last_midi_event.toString(),2,.5*this.size[1]+3),ctx.globalAlpha=t)}onExecute(){if(this.outputs)for(var last=this._last_midi_event,i=0;i<this.outputs.length;++i){var v=null;switch(this.outputs[i].name){case"midi":v=this._midi;break;case"last_midi":v=last;break;default:continue}this.setOutputData(i,v)}}onGetOutputs(){return[["last_midi","midi"],["on_midi",LiteGraph.EVENT],["on_noteon",LiteGraph.EVENT],["on_noteoff",LiteGraph.EVENT],["on_cc",LiteGraph.EVENT],["on_pc",LiteGraph.EVENT],["on_pitchbend",LiteGraph.EVENT]]}static color=MIDI_COLOR}LGMIDIIn.MIDIInterface=MIDIInterface,LiteGraph.registerNodeType("midi/input",LGMIDIIn);class LGMIDIOut{static title="MIDI Output";static desc="Sends MIDI to output channel";constructor(){this.addInput("send",LiteGraph.EVENT),this.properties={port:0};var that=this;new MIDIInterface(function(midi){that._midi=midi,that.widget.options.values=that.getMIDIOutputs()}),this.widget=this.addWidget("combo","Device",this.properties.port,{property:"port",values:this.getMIDIOutputs.bind(this)}),this.size=[340,60]}onGetPropertyInfo(name){return this._midi&&"port"==name?{type:"enum",values:this.getMIDIOutputs()}:void 0}getMIDIOutputs(){var values={};if(!this._midi)return LGMIDIOut.default_ports;if(this._midi.output_ports_info)for(var i=0;i<this._midi.output_ports_info.length;++i){var output=this._midi.output_ports_info[i];output&&(output=i+".- "+output.name+" version:"+output.version,values[i]=output)}return values}onAction(event,midi_event){this._midi&&("send"==event&&this._midi.sendMIDI(this.properties.port,midi_event),this.trigger("midi",midi_event))}onGetInputs(){return[["send",LiteGraph.ACTION]]}onGetOutputs(){return[["on_midi",LiteGraph.EVENT]]}static color=MIDI_COLOR;static default_ports={0:"unknown"}}LGMIDIOut.MIDIInterface=MIDIInterface,LiteGraph.registerNodeType("midi/output",LGMIDIOut);class LGMIDIShow{static title="MIDI Show";static desc="Shows MIDI in the graph";constructor(){this.addInput("on_midi",LiteGraph.EVENT),this._str="",this.size=[200,40]}getTitle(){return this.flags.collapsed?this._str:this.title}onAction(event,midi_event){midi_event&&(midi_event.constructor===MIDIEvent?this._str=midi_event.toString():this._str="???")}onDrawForeground(ctx){this._str&&!this.flags.collapsed&&(ctx.font="30px Arial",ctx.fillText(this._str,10,.8*this.size[1]))}onGetInputs(){return[["in",LiteGraph.ACTION]]}onGetOutputs(){return[["on_midi",LiteGraph.EVENT]]}static color=MIDI_COLOR}LiteGraph.registerNodeType("midi/show",LGMIDIShow);class LGMIDIFilter{static title="MIDI Filter";static desc="Filters MIDI messages";constructor(){this.properties={channel:-1,cmd:-1,min_value:-1,max_value:-1};var that=this;this._learning=!1,this.addWidget("button","Learn","",function(){that._learning=!0,that.boxcolor="#FA3"}),this.addInput("in",LiteGraph.EVENT),this.addOutput("on_midi",LiteGraph.EVENT),this.boxcolor="#AAA"}getTitle(){var str=null,str=-1==this.properties.cmd?"Nothing":MIDIEvent.commands_short[this.properties.cmd]||"Unknown";return-1!=this.properties.min_value&&-1!=this.properties.max_value&&(str+=" "+(this.properties.min_value==this.properties.max_value?this.properties.max_value:this.properties.min_value+".."+this.properties.max_value)),"Filter: "+str}onPropertyChanged(name,value){"cmd"==name&&(name=Number(value),isNaN(name)&&(name=MIDIEvent.commands[value]||0),this.properties.cmd=name)}onAction(event,midi_event){if(midi_event&&midi_event.constructor===MIDIEvent){if(this._learning)this._learning=!1,this.boxcolor="#AAA",this.properties.channel=midi_event.channel,this.properties.cmd=midi_event.cmd,this.properties.min_value=this.properties.max_value=midi_event.data[1];else{if(-1!=this.properties.channel&&midi_event.channel!=this.properties.channel)return;if(-1!=this.properties.cmd&&midi_event.cmd!=this.properties.cmd)return;if(-1!=this.properties.min_value&&midi_event.data[1]<this.properties.min_value)return;if(-1!=this.properties.max_value&&midi_event.data[1]>this.properties.max_value)return}this.trigger("on_midi",midi_event)}}static color=MIDI_COLOR;static"@cmd"={type:"enum",title:"Command",values:MIDIEvent.commands_reversed}}LiteGraph.registerNodeType("midi/filter",LGMIDIFilter);class LGMIDIEvent{static title="MIDIEvent";static desc="Create a MIDI Event";constructor(){this.properties={channel:0,cmd:144,value1:1,value2:1},this.addInput("send",LiteGraph.EVENT),this.addInput("assign",LiteGraph.EVENT),this.addOutput("on_midi",LiteGraph.EVENT),this.midi_event=new MIDIEvent,this.gate=!1}onAction(event,midi_event){"assign"==event?(this.properties.channel=midi_event.channel,this.properties.cmd=midi_event.cmd,this.properties.value1=midi_event.data[1],this.properties.value2=midi_event.data[2],midi_event.cmd==MIDIEvent.NOTEON?this.gate=!0:midi_event.cmd==MIDIEvent.NOTEOFF&&(this.gate=!1)):((midi_event=this.midi_event).channel=this.properties.channel,this.properties.cmd&&this.properties.cmd.constructor===String?midi_event.setCommandFromString(this.properties.cmd):midi_event.cmd=this.properties.cmd,midi_event.data[0]=midi_event.cmd|midi_event.channel,midi_event.data[1]=Number(this.properties.value1),midi_event.data[2]=Number(this.properties.value2),this.trigger("on_midi",midi_event))}onExecute(){var props=this.properties;if(this.inputs)for(let i=0;i<this.inputs.length;++i){var input=this.inputs[i];if(-1!=input.link){let v;switch(input.name){case"note":null!=(v=this.getInputData(i))&&(v.constructor===String&&(v=MIDIEvent.NoteStringToPitch(v)),this.properties.value1=(0|v)%255);break;case"cmd":null!=(v=this.getInputData(i))&&(this.properties.cmd=v);break;case"value1":null!=(v=this.getInputData(i))&&(this.properties.value1=LiteGraph.clamp(0|v,0,127));break;case"value2":null!=(v=this.getInputData(i))&&(this.properties.value2=LiteGraph.clamp(0|v,0,127))}}}if(this.outputs)for(let i=0;i<this.outputs.length;++i){let v=null;switch(this.outputs[i].name){case"midi":(v=new MIDIEvent).setup([props.cmd,props.value1,props.value2]),v.channel=props.channel;break;case"command":v=props.cmd;break;case"cc":v=props.value1;break;case"cc_value":v=props.value2;break;case"note":v=props.cmd==MIDIEvent.NOTEON||props.cmd==MIDIEvent.NOTEOFF?props.value1:null;break;case"velocity":v=props.cmd==MIDIEvent.NOTEON?props.value2:null;break;case"pitch":v=props.cmd==MIDIEvent.NOTEON?MIDIEvent.computePitch(props.value1):null;break;case"pitchbend":v=props.cmd==MIDIEvent.PITCHBEND?MIDIEvent.computePitchBend(props.value1,props.value2):null;break;case"gate":v=this.gate;break;default:continue}null!==v&&this.setOutputData(i,v)}}onPropertyChanged(name,value){"cmd"==name&&(this.properties.cmd=MIDIEvent.computeCommandFromString(value))}onGetInputs(){return[["cmd","number"],["note","number"],["value1","number"],["value2","number"]]}onGetOutputs(){return[["midi","midi"],["on_midi",LiteGraph.EVENT],["command","number"],["note","number"],["velocity","number"],["cc","number"],["cc_value","number"],["pitch","number"],["gate","bool"],["pitchbend","number"]]}static color=MIDI_COLOR}LiteGraph.registerNodeType("midi/event",LGMIDIEvent);class LGMIDICC{static title="MIDICC";static desc="gets a Controller Change";constructor(){this.properties={cc:1,value:0},this.addOutput("value","number")}onExecute(){MIDIInterface.input&&(this.properties.value=MIDIInterface.input.state.cc[this.properties.cc]),this.setOutputData(0,this.properties.value)}static color=MIDI_COLOR}LiteGraph.registerNodeType("midi/cc",LGMIDICC);class LGMIDIGenerator{static title="MIDI Generator";static desc="Generates a random MIDI note";constructor(){this.addInput("generate",LiteGraph.ACTION),this.addInput("scale","string"),this.addInput("octave","number"),this.addOutput("note",LiteGraph.EVENT),this.properties={notes:"A,A#,B,C,C#,D,D#,E,F,F#,G,G#",octave:2,duration:.5,mode:"sequence"},this.notes_pitches=LGMIDIGenerator.processScale(this.properties.notes),this.sequence_index=0}static processScale(scale){for(var notes=scale.split(","),i=0;i<notes.length;++i){var n=notes[i];2==n.length&&"#"!=n[1]||2<n.length?notes[i]=-LiteGraph.MIDIEvent.NoteStringToPitch(n):notes[i]=MIDIEvent.note_to_index[n]||0}return notes}onPropertyChanged(name,value){"notes"==name&&(this.notes_pitches=LGMIDIGenerator.processScale(value))}onExecute(){var octave=this.getInputData(2),octave=(null!=octave&&(this.properties.octave=octave),this.getInputData(1));octave&&(this.notes_pitches=LGMIDIGenerator.processScale(octave))}onAction(event,midi_event){var pitch=0,range=this.notes_pitches.length,index=0,range=("sequence"==this.properties.mode?index=this.sequence_index=(this.sequence_index+1)%range:"random"==this.properties.mode&&(index=Math.floor(Math.random()*range)),this.notes_pitches[index]),pitch=0<=range?range+12*(this.properties.octave-1)+33:-range,index=((midi_event=new MIDIEvent).setup([MIDIEvent.NOTEON,pitch,10]),this.properties.duration||1);this.trigger("note",midi_event),setTimeout(function(){var midi_event=new MIDIEvent;midi_event.setup([MIDIEvent.NOTEOFF,pitch,0]),this.trigger("note",midi_event)}.bind(this),1e3*index)}static color=MIDI_COLOR}LiteGraph.registerNodeType("midi/generator",LGMIDIGenerator);class LGMIDITranspose{static title="MIDI Transpose";static desc="Transpose a MIDI note";constructor(){this.properties={amount:0},this.addInput("in",LiteGraph.ACTION),this.addInput("amount","number"),this.addOutput("out",LiteGraph.EVENT),this.midi_event=new MIDIEvent}onAction(event,midi_event){midi_event&&midi_event.constructor===MIDIEvent&&(midi_event.data[0]==MIDIEvent.NOTEON||midi_event.data[0]==MIDIEvent.NOTEOFF?(this.midi_event=new MIDIEvent,this.midi_event.setup(midi_event.data),this.midi_event.data[1]=Math.round(this.midi_event.data[1]+this.properties.amount),this.trigger("out",this.midi_event)):this.trigger("out",midi_event))}onExecute(){var amount=this.getInputData(1);null!=amount&&(this.properties.amount=amount)}static color=MIDI_COLOR}LiteGraph.registerNodeType("midi/transpose",LGMIDITranspose);class LGMIDIQuantize{static title="MIDI Quantize Pitch";static desc="Transpose a MIDI note tp fit an scale";constructor(){this.properties={scale:"A,A#,B,C,C#,D,D#,E,F,F#,G,G#"},this.addInput("note",LiteGraph.ACTION),this.addInput("scale","string"),this.addOutput("out",LiteGraph.EVENT),this.valid_notes=new Array(12),this.offset_notes=new Array(12),this.processScale(this.properties.scale)}onPropertyChanged(name,value){"scale"==name&&this.processScale(value)}processScale(scale){this._current_scale=scale,this.notes_pitches=LGMIDIGenerator.processScale(scale);for(let i=0;i<12;++i)this.valid_notes[i]=-1!=this.notes_pitches.indexOf(i);for(let i=0;i<12;++i)if(this.valid_notes[i])this.offset_notes[i]=0;else for(var j=1;j<12;++j){if(this.valid_notes[(i-j)%12]){this.offset_notes[i]=-j;break}if(this.valid_notes[(i+j)%12]){this.offset_notes[i]=j;break}}}onAction(event,midi_event){var note;midi_event&&midi_event.constructor===MIDIEvent&&(midi_event.data[0]==MIDIEvent.NOTEON||midi_event.data[0]==MIDIEvent.NOTEOFF?(this.midi_event=new MIDIEvent,this.midi_event.setup(midi_event.data),note=midi_event.note,note=MIDIEvent.note_to_index[note],note=this.offset_notes[note],this.midi_event.data[1]+=note,this.trigger("out",this.midi_event)):this.trigger("out",midi_event))}onExecute(){var scale=this.getInputData(1);null!=scale&&scale!=this._current_scale&&this.processScale(scale)}static color=MIDI_COLOR}LiteGraph.registerNodeType("midi/quantize",LGMIDIQuantize);class LGMIDIFromFile{static title="MIDI fromFile";static desc="Plays a MIDI file";constructor(){this.properties={url:"",autoplay:!0},this.addInput("play",LiteGraph.ACTION),this.addInput("pause",LiteGraph.ACTION),this.addOutput("note",LiteGraph.EVENT),this._midi=null,this._current_time=0,this._playing=!1,"undefined"==typeof MidiParser&&(console.error?.("midi-parser.js not included, LGMidiPlay requires that library: https://raw.githubusercontent.com/colxi/midi-parser-js/master/src/main.js"),this.boxcolor="red")}onAction(name){"play"==name?this.play():"pause"==name&&(this._playing=!this._playing)}onPropertyChanged(name,value){"url"==name&&this.loadMIDIFile(value)}onExecute(){if(this._midi&&this._playing){this._current_time+=this.graph.elapsed_time;for(var current_time=100*this._current_time,i=0;i<this._midi.tracks;++i){var midi_event,track=this._midi.track[i],elem=(track._last_pos||(track._last_pos=0,track._time=0),track.event[track._last_pos]);elem&&track._time+elem.deltaTime<=current_time&&(track._last_pos++,track._time+=elem.deltaTime,elem.data)&&(track=elem.type<<4+elem.channel,(midi_event=new MIDIEvent).setup([track,elem.data[0],elem.data[1]]),this.trigger("note",midi_event))}}}play(){if(this._playing=!0,this._current_time=0,this._midi)for(var i=0;i<this._midi.tracks;++i){var track=this._midi.track[i];track._last_pos=0,track._time=0}}loadMIDIFile(url){LiteGraph.fetchFile(url,"arraybuffer",data=>{this.boxcolor="#AFA",this._midi=MidiParser.parse(new Uint8Array(data)),this.properties.autoplay&&this.play()},()=>{this.boxcolor="#FAA",this._midi=null})}onDropFile(file){this.properties.url="",this.loadMIDIFile(file)}static color=MIDI_COLOR}LiteGraph.registerNodeType("midi/fromFile",LGMIDIFromFile);class LGMIDIPlay{static title="MIDI Play";static desc="Plays a MIDI note";constructor(){var Synth;this.properties={volume:.5,duration:1},this.addInput("note",LiteGraph.ACTION),this.addInput("volume","number"),this.addInput("duration","number"),this.addOutput("note",LiteGraph.EVENT),"undefined"==typeof AudioSynth?(console.error?.("Audiosynth.js not included, LGMidiPlay requires that library"),this.boxcolor="red"):(Synth=this.synth=new AudioSynth,this.instrument=Synth.createInstrument("piano"))}onAction(event,midi_event){if(midi_event&&midi_event.constructor===MIDIEvent){if(this.instrument&&midi_event.data[0]==MIDIEvent.NOTEON){var note=midi_event.note;if(!note||"undefined"==note||note.constructor!==String)return;this.instrument.play(note,midi_event.octave,this.properties.duration,this.properties.volume)}this.trigger("note",midi_event)}}onExecute(){var volume=this.getInputData(1),volume=(null!=volume&&(this.properties.volume=volume),this.getInputData(2));null!=volume&&(this.properties.duration=volume)}static color=MIDI_COLOR}LiteGraph.registerNodeType("midi/play",LGMIDIPlay);class LGMIDIKeys{static title="MIDI Keys";static desc="Keyboard to play notes";constructor(){this.properties={num_octaves:2,start_octave:2},this.addInput("note",LiteGraph.ACTION),this.addInput("reset",LiteGraph.ACTION),this.addOutput("note",LiteGraph.EVENT),this.size=[400,100],this.keys=[],this._last_key=-1}onDrawForeground(ctx){if(!this.flags.collapsed){var num_keys=12*this.properties.num_octaves,key_width=(this.keys.length=num_keys,this.size[0]/(7*this.properties.num_octaves)),key_height=this.size[1];ctx.globalAlpha=1;for(var k=0;k<2;k++)for(var i=0;i<num_keys;++i){var x,key_info=LGMIDIKeys.keys[i%12];key_info.t==k&&(x=7*Math.floor(i/12)*key_width+key_info.x*key_width,ctx.fillStyle=0==k?this.keys[i]?"#CCC":"white":this.keys[i]?"#333":"black",ctx.fillRect(1+x,0,key_width*key_info.w-2,key_height*key_info.h))}}}getKeyIndex(pos){for(var key_width=this.size[0]/(7*this.properties.num_octaves),key_height=this.size[1],k=1;0<=k;k--)for(var i=0;i<this.keys.length;++i){var key_info=LGMIDIKeys.keys[i%12];if(key_info.t==k){var x=7*Math.floor(i/12)*key_width+key_info.x*key_width,w=key_width*key_info.w,key_info=key_height*key_info.h;if(!(pos[0]<x||pos[0]>x+w||pos[1]>key_info))return i}}return-1}onAction(event,params){if("reset"==event)for(var i=0;i<this.keys.length;++i)this.keys[i]=!1;else params&&params.constructor===MIDIEvent&&(event=12*(this.properties.start_octave-1)+29,0<=(event=(params=params).data[1]-event)&&event<this.keys.length&&(params.data[0]==MIDIEvent.NOTEON?this.keys[event]=!0:params.data[0]==MIDIEvent.NOTEOFF&&(this.keys[event]=!1)),this.trigger("note",params))}onMouseDown(e,pos){var midi_event;if(!(pos[1]<0))return pos=this.getKeyIndex(pos),this.keys[pos]=!0,this._last_key=pos,pos=12*(this.properties.start_octave-1)+29+pos,(midi_event=new MIDIEvent).setup([MIDIEvent.NOTEON,pos,100]),this.trigger("note",midi_event),!0}onMouseMove(e,pos){var pitch,midi_event;if(!(pos[1]<0||-1==this._last_key))return this.setDirtyCanvas(!0),pos=this.getKeyIndex(pos),this._last_key!=pos&&(this.keys[this._last_key]=!1,pitch=12*(this.properties.start_octave-1)+29+this._last_key,(midi_event=new MIDIEvent).setup([MIDIEvent.NOTEOFF,pitch,100]),this.trigger("note",midi_event),this.keys[pos]=!0,pitch=12*(this.properties.start_octave-1)+29+pos,(midi_event=new MIDIEvent).setup([MIDIEvent.NOTEON,pitch,100]),this.trigger("note",midi_event),this._last_key=pos),!0}onMouseUp(e,pos){var midi_event;if(!(pos[1]<0))return pos=this.getKeyIndex(pos),this.keys[pos]=!1,this._last_key=-1,pos=12*(this.properties.start_octave-1)+29+pos,(midi_event=new MIDIEvent).setup([MIDIEvent.NOTEOFF,pos,100]),this.trigger("note",midi_event),!0}static color=MIDI_COLOR;static keys=[{x:0,w:1,h:1,t:0},{x:.75,w:.5,h:.6,t:1},{x:1,w:1,h:1,t:0},{x:1.75,w:.5,h:.6,t:1},{x:2,w:1,h:1,t:0},{x:2.75,w:.5,h:.6,t:1},{x:3,w:1,h:1,t:0},{x:4,w:1,h:1,t:0},{x:4.75,w:.5,h:.6,t:1},{x:5,w:1,h:1,t:0},{x:5.75,w:.5,h:.6,t:1},{x:6,w:1,h:1,t:0}]}LiteGraph.registerNodeType("midi/keys",LGMIDIKeys);class LGAudio{static audios_connected={};static getAudioContext(){if(!this._audio_context){if(window.AudioContext=window.AudioContext||window.webkitAudioContext,console.debug("LGAudio","init _audio_context",window.AudioContext),!window.AudioContext)return console.error?.("AudioContext not supported by browser"),null;try{this._audio_context=new AudioContext}catch(e){console.error("LGAudio","_audio_context failed",this._audio_context),this._audio_context=!1}this._audio_context&&(this._audio_context.onmessage=function(msg){console.log?.("msg",msg)},this._audio_context.onended=function(msg){console.log?.("ended",msg)},this._audio_context.oncomplete=function(msg){console.log?.("complete",msg)})}return this._audio_context}static connect(audionodeA,audionodeB){try{audionodeA.connect(audionodeB),this.audios_connected[audionodeA]=audionodeB,console.debug("LGraphAudio:","audioNodesConnected",audionodeA,audionodeB)}catch(err){console.warn?.("LGraphAudio:","connect",err)}}static disconnect(audionodeA,audionodeB){try{this.audios_connected[audionodeA]?(audionodeA.disconnect(audionodeB),this.audios_connected[audionodeA]=!1,console.debug("LGraphAudio:","audioNodesDisconnected",audionodeA,audionodeB)):console.debug("LGraphAudio:","Not disconnecting unexisting connection",this.audios_connected,audionodeA,audionodeB)}catch(err){console.warn?.("LGraphAudio:","disconnect",err)}}static changeAllAudiosConnections(node,connect){if(node.inputs)for(let i=0;i<node.inputs.length;++i){var input=node.inputs[i],input=node.graph.links[input.link];if(input){var origin_node=node.graph.getNodeById(input.origin_id);let origin_audionode=null,target_audionode=(origin_audionode=origin_node.getAudioNodeInOutputSlot?origin_node.getAudioNodeInOutputSlot(input.origin_slot):origin_node.audionode,null);target_audionode=node.getAudioNodeInInputSlot?node.getAudioNodeInInputSlot(i):node.audionode,connect?LGAudio.connect(origin_audionode,target_audionode):LGAudio.disconnect(origin_audionode,target_audionode)}}if(node.outputs)for(let i=0;i<node.outputs.length;++i){var output=node.outputs[i];for(let j=0;j<output.links.length;++j){let link_info=node.graph.links[output.links[j]];if(link_info){let origin_audionode=null;origin_audionode=node.getAudioNodeInOutputSlot?node.getAudioNodeInOutputSlot(i):node.audionode;var target_node=node.graph.getNodeById(link_info.target_id);let target_audionode=null;target_audionode=target_node.getAudioNodeInInputSlot?target_node.getAudioNodeInInputSlot(link_info.target_slot):target_node.audionode,connect?LGAudio.connect(origin_audionode,target_audionode):LGAudio.disconnect(origin_audionode,target_audionode)}}}}static onConnectionsChange(connection,slot,connected,link_info){var local_audionode;console.debug("LGAudio","onConnectionsChange",connection,slot,connected,link_info),connection!=LiteGraph.OUTPUT?console.warn("LGAudio","onConnectionsChange","skip cheking INPUT"):(connection=null,(connection=link_info?this.graph.getNodeById(link_info.target_id):connection)?(local_audionode=null,local_audionode=this.getAudioNodeInOutputSlot?this.getAudioNodeInOutputSlot(slot):this.audionode,slot=null,slot=connection.getAudioNodeInInputSlot?connection.getAudioNodeInInputSlot(link_info.target_slot):connection.audionode,connected?(LGAudio.connect(local_audionode,slot),console.debug("LGAudio","onConnectionsChange","CONNECT")):(LGAudio.disconnect(local_audionode,slot),console.debug("LGAudio","onConnectionsChange","DISCONNECT"))):console.warn("LGAudio","onConnectionsChange","no target_node"))}static createAudioNodeWrapper(class_object){var old_func=class_object.prototype.onPropertyChanged;class_object.prototype.onPropertyChanged=function(name,value){old_func&&old_func.call(this,name,value),this.audionode&&void 0!==this.audionode[name]&&(void 0!==this.audionode[name].value?this.audionode[name].value=value:this.audionode[name]=value)},class_object.prototype.onConnectionsChange=LGAudio.onConnectionsChange,class_object.prototype.onConfigure=function(that){console.debug(that.type,that.id,"audio node configured")}}static cached_audios={};static loadSound(url,on_complete,on_error){var request,context;if(!LGAudio.cached_audios[url]||!url.includes("blob:"))return LGAudio.onProcessAudioURL&&(url=LGAudio.onProcessAudioURL(url)),(request=new XMLHttpRequest).open("GET",url,!0),request.responseType="arraybuffer",context=LGAudio.getAudioContext(),request.onload=function(){console.log?.("AudioSource loaded"),context.decodeAudioData(request.response,function(buffer){console.log?.("AudioSource decoded"),LGAudio.cached_audios[url]=buffer,on_complete&&on_complete(buffer)},onError)},request.send(),request;function onError(err){console.log?.("Audio loading sample error:",err),on_error&&on_error(err)}on_complete&&on_complete(LGAudio.cached_audios[url])}}class LGAudioSource{static title="Source";static desc="Plays an audio file";constructor(){this.properties={src:"",gain:.5,loop:!0,autoplay:!0,playbackRate:1},this._loading_audio=!1,this._audiobuffer=null,this._audionodes=[],this._last_sourcenode=null,this.addOutput("out","audio"),this.addInput("gain","number");var context=LGAudio.getAudioContext();this.audionode=context.createGain(),(this.audionode.graphnode=this).audionode.gain.value=this.properties.gain,this.properties.src&&this.loadSound(this.properties.src)}onAdded(graph){graph.status===LiteGraph.LGraph.STATUS_RUNNING&&this.onStart()}onStart(){this._audiobuffer&&this.properties.autoplay&&this.playBuffer(this._audiobuffer)}onStop(){this.stopAllSounds()}onPause(){this.pauseAllSounds()}onUnpause(){this.unpauseAllSounds()}onRemoved(){this.stopAllSounds(),this._dropped_url&&URL.revokeObjectURL(this._url)}stopAllSounds(){for(var i=0;i<this._audionodes.length;++i)this._audionodes[i].started&&(this._audionodes[i].started=!1,this._audionodes[i].stop());this._audionodes.length=0}pauseAllSounds(){LGAudio.getAudioContext().suspend()}unpauseAllSounds(){LGAudio.getAudioContext().resume()}onExecute(){if(this.inputs)for(let i=0;i<this.inputs.length;++i){var input=this.inputs[i];if(null!=input.link){var v=this.getInputData(i);if(void 0!==v)if("gain"==input.name)this.audionode.gain.value=v;else if("src"==input.name)this.setProperty("src",v);else if("playbackRate"==input.name){this.properties.playbackRate=v;for(let j=0;j<this._audionodes.length;++j)this._audionodes[j].playbackRate.value=v}}}if(this.outputs)for(let i=0;i<this.outputs.length;++i)"buffer"==this.outputs[i].name&&this._audiobuffer&&this.setOutputData(i,this._audiobuffer)}onAction(event){this._audiobuffer&&("Play"==event?this.playBuffer(this._audiobuffer):"Stop"==event&&this.stopAllSounds())}onPropertyChanged(name,value){if("src"==name)this.loadSound(value);else if("gain"==name)this.audionode.gain.value=value;else if("playbackRate"==name)for(var j=0;j<this._audionodes.length;++j)this._audionodes[j].playbackRate.value=value}playBuffer(buffer){var that=this,audionode=LGAudio.getAudioContext().createBufferSource();return(this._last_sourcenode=audionode).graphnode=this,audionode.buffer=buffer,audionode.loop=this.properties.loop,audionode.playbackRate.value=this.properties.playbackRate,this._audionodes.push(audionode),audionode.connect(this.audionode),this._audionodes.push(audionode),this.trigger("start"),audionode.onended=function(){that.trigger("ended");var index=that._audionodes.indexOf(audionode);-1!=index&&that._audionodes.splice(index,1)},audionode.started||(audionode.started=!0,audionode.start()),audionode}loadSound(url){var that=this;this._request&&(this._request.abort(),this._request=null),this._audiobuffer=null,this._loading_audio=!1,url&&(this._request=LGAudio.loadSound(url,buffer=>{this.boxcolor=LiteGraph.NODE_DEFAULT_BOXCOLOR,that._audiobuffer=buffer,that._loading_audio=!1,that.graph&&that.graph.status===LiteGraph.LGraph.STATUS_RUNNING&&that.onStart()}),this._loading_audio=!0,this.boxcolor="#AA4")}onGetInputs(){return[["playbackRate","number"],["src","string"],["Play",LiteGraph.ACTION],["Stop",LiteGraph.ACTION]]}onGetOutputs(){return[["buffer","audiobuffer"],["start",LiteGraph.EVENT],["ended",LiteGraph.EVENT]]}onDropFile(file){this._dropped_url&&URL.revokeObjectURL(this._dropped_url);file=URL.createObjectURL(file);this.properties.src=file,this.loadSound(file),this._dropped_url=file}static supported_extensions=["wav","ogg","mp3"];static"@src"={widget:"resource"}}LGAudioSource.prototype.onConnectionsChange=LGAudio.onConnectionsChange,LiteGraph.registerNodeType("audio/source",LGAudioSource);class LGAudioMediaSource{static title="MediaSource";static desc="Plays microphone";constructor(){this.properties={gain:.5},this._audionodes=[],this._media_stream=null,this.addOutput("out","audio"),this.addInput("gain","number");var context=LGAudio.getAudioContext();this.audionode=context.createGain(),(this.audionode.graphnode=this).audionode.gain.value=this.properties.gain}onAdded(graph){graph.status===LiteGraph.LGraph.STATUS_RUNNING&&this.onStart()}onStart(){null!=this._media_stream||this._waiting_confirmation||this.openStream()}onStop(){this.audionode.gain.value=0}onPause(){this.audionode.gain.value=0}onUnpause(){this.audionode.gain.value=this.properties.gain}onRemoved(){var tracks;this.audionode.gain.value=0,this.audiosource_node&&(this.audiosource_node.disconnect(this.audionode),this.audiosource_node=null),this._media_stream&&(tracks=this._media_stream.getTracks()).length&&tracks[0].stop()}openStream(){var that;navigator.mediaDevices?(this._waiting_confirmation=!0,navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(this.streamReady.bind(this)).catch(function(err){console.log?.("Media rejected",err),that._media_stream=!1,that.boxcolor="red"}),that=this):console.log?.("getUserMedia() is not supported in your browser, use chrome and enable WebRTC from about://flags")}streamReady(localMediaStream){this._media_stream=localMediaStream,this.audiosource_node&&this.audiosource_node.disconnect(this.audionode);var context=LGAudio.getAudioContext();this.audiosource_node=context.createMediaStreamSource(localMediaStream),(this.audiosource_node.graphnode=this).audiosource_node.connect(this.audionode),this.boxcolor="white"}onExecute(){if(null!=this._media_stream||this._waiting_confirmation||this.openStream(),this.inputs)for(var i=0;i<this.inputs.length;++i){var v,input=this.inputs[i];null!=input.link&&(void 0!==(v=this.getInputData(i))&&"gain"==input.name)&&(this.audionode.gain.value=this.properties.gain=v)}}onAction(event){"Play"==event?this.audionode.gain.value=this.properties.gain:"Stop"==event&&(this.audionode.gain.value=0)}onPropertyChanged(name,value){"gain"==name&&(this.audionode.gain.value=value)}onGetInputs(){return[["playbackRate","number"],["Play",LiteGraph.ACTION],["Stop",LiteGraph.ACTION]]}}LGAudioMediaSource.prototype.onConnectionsChange=LGAudio.onConnectionsChange,LiteGraph.registerNodeType("audio/media_source",LGAudioMediaSource);class LGAudioAnalyser{static title="Analyser";static desc="Audio Analyser";constructor(){this.properties={fftSize:2048,minDecibels:-100,maxDecibels:-10,smoothingTimeConstant:.5};var context=LGAudio.getAudioContext();this.audionode=context.createAnalyser(),(this.audionode.graphnode=this).audionode.fftSize=this.properties.fftSize,this.audionode.minDecibels=this.properties.minDecibels,this.audionode.maxDecibels=this.properties.maxDecibels,this.audionode.smoothingTimeConstant=this.properties.smoothingTimeConstant,this.addInput("in","audio"),this.addOutput("freqs","array"),this.addOutput("samples","array"),this._freq_bin=null,this._time_bin=null}onPropertyChanged(name,value){this.audionode[name]=value}onExecute(){let bufferLength;this.isOutputConnected(0)&&(bufferLength=this.audionode.frequencyBinCount,this._freq_bin&&this._freq_bin.length==bufferLength||(this._freq_bin=new Uint8Array(bufferLength)),this.audionode.getByteFrequencyData(this._freq_bin),this.setOutputData(0,this._freq_bin)),this.isOutputConnected(1)&&(bufferLength=this.audionode.frequencyBinCount,this._time_bin&&this._time_bin.length==bufferLength||(this._time_bin=new Uint8Array(bufferLength)),this.audionode.getByteTimeDomainData(this._time_bin),this.setOutputData(1,this._time_bin));for(var i=1;i<this.inputs.length;++i){var v,input=this.inputs[i];null!=input.link&&void 0!==(v=this.getInputData(i))&&(this.audionode[input.name].value=v)}}onGetInputs(){return[["minDecibels","number"],["maxDecibels","number"],["smoothingTimeConstant","number"]]}onGetOutputs(){return[["freqs","array"],["samples","array"]]}}LiteGraph.registerNodeType("audio/analyser",LGAudioAnalyser);class LGAudioGain{static title="Gain";static desc="Audio gain";constructor(){this.properties={gain:1},this.audionode=LGAudio.getAudioContext().createGain(),this.addInput("in","audio"),this.addInput("gain","number"),this.addOutput("out","audio")}onExecute(){if(this.inputs&&this.inputs.length)for(var i=1;i<this.inputs.length;++i){var input=this.inputs[i],v=this.getInputData(i);void 0!==v&&(this.audionode[input.name].value=v)}}}LGAudio.createAudioNodeWrapper(LGAudioGain),LiteGraph.registerNodeType("audio/gain",LGAudioGain);class LGAudioConvolver{static title="Convolver";static desc="Convolves the signal (used for reverb)";constructor(){this.properties={impulse_src:"",normalize:!0},this.audionode=LGAudio.getAudioContext().createConvolver(),this.addInput("in","audio"),this.addOutput("out","audio")}onRemove(){this._dropped_url&&URL.revokeObjectURL(this._dropped_url)}onPropertyChanged(name,value){"impulse_src"==name?this.loadImpulse(value):"normalize"==name&&(this.audionode.normalize=value)}onDropFile(file){this._dropped_url&&URL.revokeObjectURL(this._dropped_url),this._dropped_url=URL.createObjectURL(file),this.properties.impulse_src=this._dropped_url,this.loadImpulse(this._dropped_url)}loadImpulse(url){var that=this;this._request&&(this._request.abort(),this._request=null),this._impulse_buffer=null,this._loading_impulse=!1,url&&(this._request=LGAudio.loadSound(url,function(buffer){that._impulse_buffer=buffer,that.audionode.buffer=buffer,console.log?.("Impulse signal set"),that._loading_impulse=!1}),this._loading_impulse=!0)}}LGAudio.createAudioNodeWrapper(LGAudioConvolver),LiteGraph.registerNodeType("audio/convolver",LGAudioConvolver);class LGAudioDynamicsCompressor{static title="DynamicsCompressor";static desc="Dynamics Compressor";constructor(){this.properties={threshold:-50,knee:40,ratio:12,reduction:-20,attack:0,release:.25},this.audionode=LGAudio.getAudioContext().createDynamicsCompressor(),this.addInput("in","audio"),this.addOutput("out","audio")}onExecute(){if(this.inputs&&this.inputs.length)for(var i=1;i<this.inputs.length;++i){var v,input=this.inputs[i];null!=input.link&&void 0!==(v=this.getInputData(i))&&(this.audionode[input.name].value=v)}}onGetInputs(){return[["threshold","number"],["knee","number"],["ratio","number"],["reduction","number"],["attack","number"],["release","number"]]}}LGAudio.createAudioNodeWrapper(LGAudioDynamicsCompressor),LiteGraph.registerNodeType("audio/dynamicsCompressor",LGAudioDynamicsCompressor);class LGAudioWaveShaper{static title="WaveShaper";static desc="Distortion using wave shape";constructor(){this.properties={},this.audionode=LGAudio.getAudioContext().createWaveShaper(),this.addInput("in","audio"),this.addInput("shape","waveshape"),this.addOutput("out","audio")}onExecute(){var v;this.inputs&&this.inputs.length&&void 0!==(v=this.getInputData(1))&&(this.audionode.curve=v)}setWaveShape(shape){this.audionode.curve=shape}}LGAudio.createAudioNodeWrapper(LGAudioWaveShaper);class LGAudioMixer{static title="Mixer";static desc="Audio mixer";constructor(){this.properties={gain1:.5,gain2:.5},this.audionode=LGAudio.getAudioContext().createGain(),this.audionode1=LGAudio.getAudioContext().createGain(),this.audionode1.gain.value=this.properties.gain1,this.audionode2=LGAudio.getAudioContext().createGain(),this.audionode2.gain.value=this.properties.gain2,this.audionode1.connect(this.audionode),this.audionode2.connect(this.audionode),this.addInput("in1","audio"),this.addInput("in1 gain","number"),this.addInput("in2","audio"),this.addInput("in2 gain","number"),this.addOutput("out","audio")}getAudioNodeInInputSlot(slot){return 0==slot?this.audionode1:2==slot?this.audionode2:void 0}onPropertyChanged(name,value){"gain1"==name?this.audionode1.gain.value=value:"gain2"==name&&(this.audionode2.gain.value=value)}onExecute(){if(this.inputs&&this.inputs.length)for(var i=1;i<this.inputs.length;++i){var input=this.inputs[i];null!=input.link&&"audio"!=input.type&&void 0!==(input=this.getInputData(i))&&(1==i?this.audionode1.gain.value=input:3==i&&(this.audionode2.gain.value=input))}}}LGAudio.createAudioNodeWrapper(LGAudioMixer),LiteGraph.registerNodeType("audio/mixer",LGAudioMixer);class LGAudioADSR{static title="ADSR";static desc="Audio envelope";constructor(){this.properties={A:.1,D:.1,S:.1,R:.1},this.audionode=LGAudio.getAudioContext().createGain(),this.audionode.gain.value=0,this.addInput("in","audio"),this.addInput("gate","boolean"),this.addOutput("out","audio"),this.gate=!1}onExecute(){var now=LGAudio.getAudioContext().currentTime,gain=this.audionode.gain,current_gate=this.getInputData(1),A=this.getInputOrProperty("A"),D=this.getInputOrProperty("D"),S=this.getInputOrProperty("S"),R=this.getInputOrProperty("R");!this.gate&&current_gate?(gain.cancelScheduledValues(0),gain.setValueAtTime(0,now),gain.linearRampToValueAtTime(1,now+A),gain.linearRampToValueAtTime(S,now+A+D)):this.gate&&!current_gate&&(gain.cancelScheduledValues(0),gain.setValueAtTime(gain.value,now),gain.linearRampToValueAtTime(0,now+R)),this.gate=current_gate}onGetInputs(){return[["A","number"],["D","number"],["S","number"],["R","number"]]}}LGAudio.createAudioNodeWrapper(LGAudioADSR),LiteGraph.registerNodeType("audio/adsr",LGAudioADSR);class LGAudioDelay{static title="Delay";static desc="Audio delay";constructor(){this.properties={delayTime:.5},this.audionode=LGAudio.getAudioContext().createDelay(10),this.audionode.delayTime.value=this.properties.delayTime,this.addInput("in","audio"),this.addInput("time","number"),this.addOutput("out","audio")}onExecute(){var v=this.getInputData(1);void 0!==v&&(this.audionode.delayTime.value=v)}}LGAudio.createAudioNodeWrapper(LGAudioDelay),LiteGraph.registerNodeType("audio/delay",LGAudioDelay);class LGAudioBiquadFilter{static title="BiquadFilter";static desc="Audio filter";constructor(){this.properties={frequency:350,detune:0,Q:1},this.addProperty("type","lowpass","enum",{values:["lowpass","highpass","bandpass","lowshelf","highshelf","peaking","notch","allpass"]}),this.audionode=LGAudio.getAudioContext().createBiquadFilter(),this.addInput("in","audio"),this.addOutput("out","audio")}onExecute(){if(this.inputs&&this.inputs.length)for(var i=1;i<this.inputs.length;++i){var v,input=this.inputs[i];null!=input.link&&void 0!==(v=this.getInputData(i))&&(this.audionode[input.name].value=v)}}onGetInputs(){return[["frequency","number"],["detune","number"],["Q","number"]]}}LGAudio.createAudioNodeWrapper(LGAudioBiquadFilter),LiteGraph.registerNodeType("audio/biquadfilter",LGAudioBiquadFilter);class LGAudioOscillatorNode{static title="Oscillator";static desc="Oscillator";constructor(){this.properties={frequency:440,detune:0,type:"sine"},this.addProperty("type","sine","enum",{values:["sine","square","sawtooth","triangle","custom"]}),this.audionode=LGAudio.getAudioContext().createOscillator(),this.addOutput("out","audio")}onStart(){if(!this.audionode.started){this.audionode.started=!0;try{this.audionode.start()}catch(error){console.warn?.(error)}}}onStop(){this.audionode.started&&(this.audionode.started=!1,this.audionode.stop())}onPause(){this.onStop()}onUnpause(){this.onStart()}onExecute(){if(this.inputs&&this.inputs.length)for(var i=0;i<this.inputs.length;++i){var v,input=this.inputs[i];null!=input.link&&void 0!==(v=this.getInputData(i))&&(this.audionode[input.name].value=v)}}onGetInputs(){return[["frequency","number"],["detune","number"],["type","string"]]}}LGAudio.createAudioNodeWrapper(LGAudioOscillatorNode),LiteGraph.registerNodeType("audio/oscillator",LGAudioOscillatorNode);class LGAudioVisualization{static title="Visualization";static desc="Audio Visualization";constructor(){this.properties={continuous:!0,mark:-1},this.addInput("data","array"),this.addInput("mark","number"),this.size=[300,200],this._last_buffer=null}onExecute(){this._last_buffer=this.getInputData(0);var v=this.getInputData(1);void 0!==v&&(this.properties.mark=v),this.setDirtyCanvas(!0,!1)}onDrawForeground(ctx){if(this._last_buffer){var binfreq,buffer=this._last_buffer,delta=buffer.length/this.size[0],h=this.size[1],x=(ctx.fillStyle="black",ctx.fillRect(0,0,this.size[0],this.size[1]),ctx.strokeStyle="white",ctx.beginPath(),0);if(this.properties.continuous){ctx.moveTo(x,h);for(let i=0;i<buffer.length;i+=delta)ctx.lineTo(x,h-buffer[0|i]/255*h),x++}else for(let i=0;i<buffer.length;i+=delta)ctx.moveTo(x+.5,h),ctx.lineTo(x+.5,h-buffer[0|i]/255*h),x++;ctx.stroke(),0<=this.properties.mark&&(binfreq=LGAudio.getAudioContext().sampleRate/buffer.length,(x=this.properties.mark/binfreq*2/delta)>=this.size[0]&&(x=this.size[0]-1),ctx.strokeStyle="red",ctx.beginPath(),ctx.moveTo(x,h),ctx.lineTo(x,0),ctx.stroke())}}}LiteGraph.registerNodeType("audio/visualization",LGAudioVisualization);class LGAudioBandSignal{static title="Signal";static desc="extract the signal of some frequency";constructor(){this.properties={band:440,amplitude:1},this.addInput("freqs","array"),this.addOutput("signal","number")}onExecute(){var pos,band,v;this._freqs=this.getInputData(0),this._freqs&&(band=this.properties.band,(band=(band=void 0!==(v=this.getInputData(1))?v:band)/(LGAudio.getAudioContext().sampleRate/this._freqs.length)*2)<(v=0)&&(v=this._freqs[0]),v=band>=this._freqs.length?this._freqs[this._freqs.length-1]:this._freqs[pos=0|band]*(1-(band=band-pos))+this._freqs[1+pos]*band,this.setOutputData(0,v/255*this.properties.amplitude))}onGetInputs(){return[["band","number"]]}}LiteGraph.registerNodeType("audio/signal",LGAudioBandSignal);class LGAudioScript{static title="Script";static desc="apply script to signal";constructor(){LGAudioScript.default_code||(index=(code=LGAudioScript.default_function.toString()).indexOf("{")+1,index2=code.lastIndexOf("}"),LGAudioScript.default_code=code.substr(index,index2-index)),this.properties={code:LGAudioScript.default_code};var index,index2,code=LGAudio.getAudioContext();code.createScriptProcessor?this.audionode=code.createScriptProcessor(4096,1,1):(console.warn?.("ScriptProcessorNode deprecated"),this.audionode=code.createGain()),this.processCode(),LGAudioScript._bypass_function||(LGAudioScript._bypass_function=this.audionode.onaudioprocess),this.addInput("in","audio"),this.addOutput("out","audio")}onAdded(graph){graph.status==LiteGraph.LGraph.STATUS_RUNNING&&(this.audionode.onaudioprocess=this._callback)}onStart(){this.audionode.onaudioprocess=this._callback}onStop(){this.audionode.onaudioprocess=LGAudioScript._bypass_function}onPause(){this.audionode.onaudioprocess=LGAudioScript._bypass_function}onUnpause(){this.audionode.onaudioprocess=this._callback}onExecute(){}onRemoved(){this.audionode.onaudioprocess=LGAudioScript._bypass_function}processCode(){try{var func=new Function("properties",this.properties.code);this._script=new func(this.properties),this._old_code=this.properties.code,this._callback=this._script.onaudioprocess}catch(err){console.error?.("Error in onaudioprocess code",err),this._callback=LGAudioScript._bypass_function,this.audionode.onaudioprocess=this._callback}}onPropertyChanged(name,value){"code"==name&&(this.properties.code=value,this.processCode(),this.graph)&&this.graph.status==LiteGraph.LGraph.STATUS_RUNNING&&(this.audionode.onaudioprocess=this._callback)}static default_function(){this.onaudioprocess=function(audioProcessingEvent){for(var inputBuffer=audioProcessingEvent.inputBuffer,outputBuffer=audioProcessingEvent.outputBuffer,channel=0;channel<outputBuffer.numberOfChannels;channel++)for(var inputData=inputBuffer.getChannelData(channel),outputData=outputBuffer.getChannelData(channel),sample=0;sample<inputBuffer.length;sample++)outputData[sample]=inputData[sample]}}"@code"={widget:"code",type:"code"}}LGAudio.createAudioNodeWrapper(LGAudioScript),LiteGraph.registerNodeType("audio/script",LGAudioScript);class LGAudioDestination{static title="Destination";static desc="Audio output";constructor(){this.audionode=LGAudio.getAudioContext().destination,this.addInput("in","audio")}}LiteGraph.registerNodeType("audio/destination",LGAudioDestination);class LGWebSocket{static title="WS Client";static desc="Connect to a WebSocket to send and receive data";constructor(){this.size=[60,20],this.addInput("send",LiteGraph.ACTION),this.addOutput("received",LiteGraph.EVENT),this.addInput("in",0),this.addOutput("out",0),this.properties={url:"ws://127.0.0.1:8080",room:!1,only_send_changes:!0,runOnServerToo:!1},this._ws=null,this._last_sent_data=[],this._last_received_data=[],this._hasWarned=!1}onPropertyChanged(name,_value){"url"===name&&this.connectSocket()}onExecute(){if(!this._ws&&this.properties.url&&this.connectSocket(),this._ws&&this._ws.readyState===WebSocket.OPEN){var room=this.properties.room,only_changes=this.properties.only_send_changes;for(let i=1;i<this.inputs.length;++i){var data=this.getInputData(i);if(null!=data){let json;try{json=JSON.stringify({type:0,channel:i,data:data}),room&&(json.room=room)}catch(err){console.error("Error stringifying data:",err);continue}if(!only_changes||this._last_sent_data[i]!==json){this._last_sent_data[i]=json;try{this._ws.send(json),console.log("WS sent by execute:",i,json)}catch(err){console.error("Error sending data:",err)}}}}for(let i=1;i<this.outputs.length;++i)this.setOutputData(i,this._last_received_data[i]);"#AFA"===this.boxcolor&&(this.boxcolor="#6C6")}}connectSocket(){if("undefined"!=typeof process&&process.versions&&process.versions.node&&!this.properties.runOnServerToo)this._hasWarned||(console.warn("WebSocket connection is not allowed to run on the server. Set 'runOnServerToo' to true to enable."),this._hasWarned=!0);else{this._ws&&this._ws.close();var url=this.properties.url.startsWith("ws")?this.properties.url:"ws://"+this.properties.url;try{this._ws=new WebSocket(url)}catch(err){return void console.error("Error creating WebSocket:",err)}this._ws.onopen=()=>{console.log("WS ready"),this.boxcolor="#6C6"},this._ws.onmessage=e=>{this.boxcolor="#AFA",console.info("WS on message:",e.data);let data=e.data;var binaryString;if("string"==typeof data)try{data=JSON.parse(data)}catch(err){console.warn("Received non-JSON data:",data)}else data instanceof ArrayBuffer&&(console.log("Received binary data"),e=new Uint8Array(data),binaryString=new TextDecoder("utf-8").decode(e),console.log("Binary data as string:",binaryString),e=btoa(String.fromCharCode.apply(null,e)),console.log("Binary data as base64:",e),data=binaryString);if(data.room&&data.room!==this.properties.room)console.debug("WS: received message for different room");else if(1===data.type)if(data.data.object_class&&LiteGraph[data.data.object_class])try{var obj=new LiteGraph[data.data.object_class](data.data);this.triggerSlot(0,obj),console.debug("WS received object:",obj)}catch(err){console.error("Error creating object:",err)}else void 0!==data.data&&(this.triggerSlot(0,data.data),console.debug("WS received data:",data.data));else void 0!==data.data&&(this._last_received_data[void 0!==data.channel?data.channel:0]=data.data,console.debug("WS received channel data:",data.channel,data.data))},this._ws.onerror=err=>{console.error("WS connection error:",err),this.boxcolor="#E88"},this._ws.onclose=()=>{console.log("WS connection closed"),this.boxcolor="#000"}}}disconnectSocket(){this._ws&&(this._ws.close(),this._ws=null)}send(data){if(this._ws&&this._ws.readyState===WebSocket.OPEN){data=JSON.stringify({type:1,msg:data});try{this._ws.send(data),console.log("WS sent:",data)}catch(err){console.error("Error sending data:",err)}}}onAction(action,param){if(this._ws&&this._ws.readyState===WebSocket.OPEN){action={type:1,action:action,data:param},param=(this.properties.room&&(action.room=this.properties.room),JSON.stringify(action));try{this._ws.send(param),console.log("WS sent by Action:",action)}catch(err){console.error("Error sending data by action:",err)}}}onGetInputs(){return[["in",0]]}onGetOutputs(){return[["out",0]]}onRemove(){this.disconnectSocket()}}LiteGraph.registerNodeType("network/websocket",LGWebSocket);class HTTPRequestNode{static title="HTTP Request";static desc="Fetch data through HTTP";constructor(){this.addInput("request",LiteGraph.ACTION),this.addInput("url","string"),this.addProperty("url",""),this.addOutput("ready",LiteGraph.EVENT),this.addOutput("data","string"),this.addWidget("button","Fetch",null,this.fetch.bind(this)),this._data=null,this._fetching=null}fetch(){var that,url=this.getInputOrProperty("url");url&&(this.boxcolor="#FF0",(that=this)._fetching=fetch(url).then(resp=>{if(resp.ok)return this.boxcolor="#0F0",resp.text();this.boxcolor="#F00",that.trigger("error")}).then(data=>{that._data=data,that._fetching=null,that.trigger("ready")}))}onAction(evt){"request"==evt&&this.fetch()}onExecute(){this.setOutputData(1,this._data)}onGetOutputs(){return[["error",LiteGraph.EVENT]]}}LiteGraph.registerNodeType("network/httprequest",HTTPRequestNode);class WebRTCNode{static title="WebRTC";static desc="Send and receive data through WebRTC";constructor(){this.size=[100,60],this.addInput("send",LiteGraph.ACTION),this.addInput("data",0),this.addInput("offer","string"),this.addInput("answer","string"),this.addOutput("offer","string"),this.addOutput("answer","string"),this.addOutput("received",LiteGraph.EVENT),this.addOutput("data",0),this.properties={signalingServer:"",stunServer:"",turnServer:"",username:"",credential:""},this.peerConnection=null,this.dataChannel=null,this._lastReceivedData=null}onPropertyChanged(name,value){["signalingServer","stunServer","turnServer","username","credential"].includes(name)&&this.createPeerConnection()}createPeerConnection(){if(!this.properties.stunServer||!this.properties.turnServer&&(this.properties.username||this.properties.credential))console.warn("Incomplete WebRTC configuration. Ensure stunServer and (optionally) turnServer with username and credential are set.");else try{this.peerConnection&&this.peerConnection.close();var iceServers=[{urls:this.properties.stunServer}];this.properties.turnServer&&iceServers.push({urls:this.properties.turnServer,username:this.properties.username,credential:this.properties.credential}),this.peerConnection=new RTCPeerConnection({iceServers:iceServers}),this.peerConnection.ondatachannel=event=>{this.dataChannel=event.channel,this.setupDataChannel()},this.peerConnection.onicecandidate=event=>{event.candidate?console.debug("ICE candidate:",event.candidate):"offer"===this.peerConnection.localDescription.type?this.setOutputData(0,JSON.stringify(this.peerConnection.localDescription)):this.setOutputData(1,JSON.stringify(this.peerConnection.localDescription))},this.dataChannel=this.peerConnection.createDataChannel("dataChannel"),this.setupDataChannel(),this.peerConnection.createOffer().then(offer=>this.peerConnection.setLocalDescription(offer)).catch(error=>console.error("Error creating offer:",error))}catch(error){console.error("Error creating peer connection:",error)}}setupDataChannel(){this.dataChannel&&(this.dataChannel.onopen=()=>{console.debug("Data channel open"),this.boxcolor="#00FF00"},this.dataChannel.onclose=()=>{console.debug("Data channel closed"),this.boxcolor="#990000"},this.dataChannel.onmessage=event=>{try{var receivedData=JSON.parse(event.data);this._lastReceivedData=receivedData,this.setOutputData(3,receivedData),this.triggerSlot(2,receivedData),console.debug("Data received:",event.data)}catch(error){console.error("Error parsing received data:",error)}},this.dataChannel.onerror=error=>{console.error("Data channel error:",error),this.boxcolor="#FF0000"})}onExecute(){if(this.peerConnection||this.createPeerConnection(),this.dataChannel&&"open"===this.dataChannel.readyState){var data=this.getInputData(1);if(null!=data)try{this.dataChannel.send(JSON.stringify(data)),console.debug("Data sent:",data)}catch(error){console.error("Error sending data:",error)}}this.setOutputData(3,this._lastReceivedData)}onAction(action,param){if(this.peerConnection||this.createPeerConnection(),this.dataChannel&&"open"===this.dataChannel.readyState)try{this.dataChannel.send(JSON.stringify(param)),console.debug("Data sent by action:",param)}catch(error){console.error("Error sending data by action:",error)}}onConnectionsChange(input){input&&"string"===input.type&&("offer"===input.name?this.handleOffer(input.data):"answer"===input.name&&this.handleAnswer(input.data))}async handleOffer(offer){try{await this.peerConnection.setRemoteDescription(new RTCSessionDescription(JSON.parse(offer)));var answer=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(answer),this.setOutputData(1,JSON.stringify(answer))}catch(error){console.error("Error handling offer:",error)}}async handleAnswer(answer){try{await this.peerConnection.setRemoteDescription(new RTCSessionDescription(JSON.parse(answer)))}catch(error){console.error("Error handling answer:",error)}}onRemove(){this.peerConnection&&this.peerConnection.close()}}LiteGraph.registerNodeType("network/webrtc",WebRTCNode);class OSCNode{static title="OSC";static desc="Send and receive data through OSC";constructor(){this.size=[100,60],this.addInput("send",LiteGraph.ACTION),this.addInput("data",0),this.addOutput("received",LiteGraph.EVENT),this.addOutput("data",0),this.properties={host:"127.0.0.1",port:57121,localPort:57120,address:"/osc/address",useWebSocket:!0,webSocketURL:"ws://localhost:8080"},this._osc=null,this._lastReceivedData=null,this.isNode="undefined"!=typeof process&&process.versions&&process.versions.node,this._connected=!1,this._cant_connect=!1}onPropertyChanged(name,value){["host","port","localPort","address","useWebSocket","webSocketURL"].includes(name)&&(this._cant_connect=!1,this.initConnection())}initConnection(){this._osc&&(this._osc.close(),this._osc=null),void 0===this._title&&(this._title=this.title),this.isNode?(this.initNodeOSC(),void 0!==this._title&&(this.title=this._title)):this.properties.useWebSocket?(this.initBrowserOSC(),void 0!==this._title&&(this.title=this._title)):(console.warn("OSCNode can only run on Node.js server or WebSocket in the browser"),this.boxcolor="#FF0000",this.title="OSC (useWebSocket disabled)",this._cant_connect=!0)}initNodeOSC(){var osc=require("osc");try{this._osc=new osc.UDPPort({localAddress:"0.0.0.0",localPort:this.properties.localPort,remoteAddress:this.properties.host,remotePort:this.properties.port}),this._osc.on("ready",()=>{console.debug("OSC server is ready on "+this.properties.localPort),this._connected=!0,this.boxcolor="#00FF00"}),this._osc.on("message",oscMessage=>{this._lastReceivedData=oscMessage.args,this.setOutputData(1,this._lastReceivedData),this.triggerSlot(0,this._lastReceivedData),console.debug("OSC message received:",oscMessage)}),this._osc.on("error",err=>{console.error("OSC error:",err),this._connected=!1,this.boxcolor="#FF0000"}),this._osc.open()}catch(error){console.error("Error initializing Node.js OSC connection:",error),this.boxcolor="#FF0000"}}initBrowserOSC(){try{this._osc=new WebSocket(this.properties.webSocketURL),this._osc.onopen=()=>{console.debug("WebSocket connection opened"),this._connected=!0,this.boxcolor="#00FF00"},this._osc.onmessage=event=>{try{var oscMessage=JSON.parse(event.data);this._lastReceivedData=oscMessage.args,this.setOutputData(1,this._lastReceivedData),this.triggerSlot(0,this._lastReceivedData),console.debug("OSC message received via WebSocket:",oscMessage)}catch(error){console.error("Error parsing OSC message via WebSocket:",error)}},this._osc.onerror=err=>{console.error("WebSocket error:",err),this._connected=!1,this.boxcolor="#FF0000"},this._osc.onclose=()=>{console.debug("WebSocket connection closed"),this._connected=!1,this.boxcolor="#AA0000"}}catch(error){console.error("Error initializing WebSocket OSC connection:",error),this.boxcolor="#FF0000"}}onExecute(){if(this._connected&&this._osc){var data=this.getInputData(1);if(null!=data){data={address:this.properties.address,args:Array.isArray(data)?data:[data]};try{this.isNode?this._osc.send(data):this._osc.send(JSON.stringify(data)),console.debug("OSC message sent:",data)}catch(error){console.error("Error sending OSC message:",error)}}this.setOutputData(1,this._lastReceivedData)}else this._cant_connect||this.initConnection()}onAction(action,param){if(this._connected&&this._osc){param={address:this.properties.address,args:Array.isArray(param)?param:[param]};try{this.isNode?this._osc.send(param):this._osc.send(JSON.stringify(param)),console.debug("OSC message sent by action:",param)}catch(error){console.error("Error sending OSC message by action:",error)}}}onRemove(){this._osc&&this._osc.close()}}LiteGraph.registerNodeType("network/osc",OSCNode);class LGWebSocketServer{static title="WebSocket Server";static desc="WebSocket server node";constructor(){this.size=[60,20],this.addInput("send",LiteGraph.ACTION),this.addOutput("received",LiteGraph.EVENT),this.addInput("in",0),this.addOutput("out",0),this.properties={port:8080,room:!1,only_send_changes:!0,broadcast:!0},this._wsServer=null,this._clients=new Set,this._last_sent_data=[],this._last_received_data=[],"undefined"==typeof process||process.browser?(console.warn("WebSocket Server node is designed to run in Node.js, not in a browser."),this.boxcolor="#FF0000",this.title="WSServer (run on server)"):this.startWebSocketServer()}onPropertyChanged(name,_value){"port"==name&&this._wsServer&&this.restartWebSocketServer()}onExecute(){if(this._wsServer){var only_changes=this.properties.only_send_changes;for(let i=1;i<this.inputs.length;++i){var data=this.getInputData(i);if(null!=data){let json;try{json=JSON.stringify({type:0,channel:i,data:data})}catch(err){console.error("Error stringifying data:",err);continue}if(!only_changes||this._last_sent_data[i]!=json){this._last_sent_data[i]=json;for(const client of this._clients)1===client.readyState&&client.send(json);console.log?.("WS sent by execute:",i,json)}}}for(let i=1;i<this.outputs.length;++i)this.setOutputData(i,this._last_received_data[i]);"#AFA"==this.boxcolor&&(this.boxcolor="#6C6")}}startWebSocketServer(){var WebSocket=require("ws");const port=this.properties.port;this._wsServer=new WebSocket.Server({port:port}),this._wsServer.on("connection",ws=>{this._clients.add(ws),ws.on("message",message=>this.handleMessage(ws,message)),ws.on("close",()=>this._clients.delete(ws)),console.log?.("New client connected")}),this._wsServer.on("listening",()=>{console.log("WebSocket server is running on ws://localhost:"+port),this.boxcolor="#6C6"}),this._wsServer.on("error",error=>{console.error("WebSocket server error:",error),this.boxcolor="#E88"})}restartWebSocketServer(){this._wsServer&&this._wsServer.close(()=>{this.startWebSocketServer()})}handleMessage(ws,message){this.boxcolor="#AFA",console.info("WS on message:",message);let data;try{data=JSON.parse(message)}catch(err){return void console.error("Error parsing message:",err)}if(1===data.type)if(data.data.object_class&&LiteGraph[data.data.object_class])try{var obj=new LiteGraph[data.data.object_class](data.data);this.triggerSlot(0,obj),console.debug("WS received object:",obj)}catch(err){console.error("Error creating object:",err)}else this.triggerSlot(0,data.data),console.debug("WS received data:",data.data);else this._last_received_data[data.channel??0]=data.data,console.debug("WS received channel data:",data.channel,data.data);if(this.properties.broadcast){var broadcastMessage=JSON.stringify(data);for(const client of this._clients)client!==ws&&1===client.readyState&&client.send(broadcastMessage);console.debug("WS broadcasted message:",broadcastMessage)}}send(data){if(this._wsServer){var msg=JSON.stringify({type:1,msg:data});for(const client of this._clients)1===client.readyState&&client.send(msg);console.log?.("WS sent:",msg)}}onAction(action,param,options){if(this._wsServer){var data=this.getInputData("in");if(null!=data){var msg=JSON.stringify({type:1,action:action,msg:data});for(const client of this._clients)1===client.readyState&&client.send(msg);console.debug?.("WS sent by Action:",msg,options)}}}onGetInputs(){return[["in",0]]}onGetOutputs(){return[["out",0]]}}LiteGraph.registerNodeType("network/websocketserver",LGWebSocketServer);class UDPNode{static title="UDP";static desc="Send and receive data through UDP";constructor(){this.size=[60,20],this.addInput("send",LiteGraph.ACTION),this.addInput("data",0),this.addOutput("received",LiteGraph.EVENT),this.addOutput("data",0),this.properties={host:"127.0.0.1",port:41234,only_send_changes:!0},this._dgram=null,this._last_sent_data=null,this._last_received_data=null,this.isNode="undefined"!=typeof process&&process.versions&&process.versions.node,this.isNode?(console.debug("UDPNode initialized in Node.js environment"),this.connectSocket()):(console.warn("UDPNode can only run on Node.js server"),this.boxcolor="#FF0000",this.title="UDP (run on server)")}onPropertyChanged(name,value){"host"!=name&&"port"!=name||this.isNode&&(console.debug("Property changed:",name,value),this.connectSocket())}onExecute(){if(!this._dgram){if(!this.isNode)return;this.connectSocket()}var only_changes=this.properties.only_send_changes,data=this.getInputData(1);if(null!=data){var message=Buffer.from(JSON.stringify(data));if(only_changes&&this._last_sent_data==message.toString())return;this._last_sent_data=message.toString(),this._dgram.send(message,0,message.length,this.properties.port,this.properties.host,err=>{err?console.error("UDP send error:",err):console.debug("UDP message sent",message.toString())})}this.setOutputData(1,this._last_received_data),"#AFA"==this.boxcolor&&(this.boxcolor="#6C6")}connectSocket(){var dgram=require("dgram");this._dgram&&this._dgram.close(),this._dgram=dgram.createSocket("udp4"),this._dgram.on("message",(msg,rinfo)=>{this._last_received_data=JSON.parse(msg.toString()),this.triggerSlot(0,this._last_received_data),console.debug("UDP message received",msg.toString())}),this._dgram.on("error",err=>{console.error("UDP error:",err),this._dgram.close()}),this._dgram.on("listening",()=>{var address=this._dgram.address();console.debug(`UDP server listening ${address.address}:`+address.port)}),this._dgram.bind(this.properties.port)}onAction(action,param){this.send(param)}onGetInputs(){return[["data",0]]}onGetOutputs(){return[["data",0]]}onRemove(){this._dgram&&this._dgram.close()}}LiteGraph.registerNodeType("network/udp",UDPNode);class objProperties{static title="OBJ props";static desc="Properties for objects";constructor(){this.addInput("obj","object"),this.addOutput("properties","array"),this._value=null,this._properties=[]}onExecute(){var data=this.getInputData(0);if(null!=data){this._value=data;try{this._properties=Object.keys(this._value)}catch(e){console.error?.(e)}this.setOutputData(0,this._properties)}}onAction(){}onGetInputs(){}onGetOutputs(){}getTitle(){return this.title}onPropertyChanged(){}}LiteGraph.registerNodeType("objects/properties",objProperties);class objPropertyWidget{static title="Obj Prop widget";static desc="Choose a property for an object";constructor(){this.addInput("obj","object"),this.addOutput("value","*"),this.addProperty("prop",0),this.widg_prop=this.addWidget("combo","prop.",this.properties.prop,{property:"prop",values:[]}),this._obin=null,this._value=null,this._properties=[]}setValue(v){this.properties.prop=v,this.widg_prop.value=v}updateFromInput(){var data=this.getInputData(0);if(null!=data)if(this._obin=data,this._obin){try{this._properties=Object.keys(this._obin),this._properties&&this._properties.sort&&(this._properties=this._properties.sort())}catch(e){console.error?.(e)}this._properties&&(this.widgets=[],this.widg_prop=this.addWidget("combo","prop",this.properties.prop,{property:"prop",values:this._properties})),void 0!==this._obin[this.properties.prop]?this._value=this._obin[this.properties.prop]:this._value=null}else this._value=null,this._properties=[];this.widg_prop.options||(this.widg_prop.options={}),this.widg_prop.options.values=this._properties,this.setOutputData(0,this._value)}onConnectionChanged(connection,slot,connected,link_info){connection==LiteGraph.INPUT&&this.updateFromInput()}onExecute(){this.updateFromInput()}onAction(){this.updateFromInput()}onGetInputs(){}onGetOutputs(){}getTitle(){return this.flags.collapsed?this.properties.prop:this.title}onPropertyChanged(name,value){"value"==name&&(this.widg_prop.value=value)}getExtraMenuOptions(){return[{content:"Console DBG",callback:function(menuitO,obX,ev,htmO,nodeX){console.debug?.(nodeX.widg_prop),console.debug?.(nodeX)}}]}}LiteGraph.registerNodeType("objects/property_widget",objPropertyWidget);class objMethodWidget{static title="Obj Method widget";static desc="Choose and execute a method from an object";constructor(){this.addInput("obj","object"),this.addInput("refresh",LiteGraph.ACTION),this.addInput("execute",LiteGraph.ACTION),this.addOutput("executed",LiteGraph.EVENT),this.addOutput("method","function"),this.addOutput("return","*"),this.addProperty("method",null),this.widg_prop=this.addWidget("combo","method",this.properties.method,{property:"method",values:[]}),this._obin=null,this._function=null,this._methods=[]}setValue(v){this.properties.method=v,this.widg_prop.value=v}updateFromInput(v){var that=this,data=this.getInputData(0);if(null!=data)if(this._obin=data,this._obin){try{for(this._methods=[],this._properties=[],currentObj=this._obin;Object.getOwnPropertyNames(currentObj).map(function(item){that._properties.includes(item)||that._properties.push(item)}),currentObj=Object.getPrototypeOf(currentObj););for(var iM in this._properties)"function"==typeof this._obin[this._properties[iM]]&&this._methods.push(this._properties[iM]);this._methods&&this._methods.sort&&(this._methods=this._methods.sort())}catch(e){console.warn?.("Err on methods get",e)}this._methods&&(this.widgets=[],this.widg_prop=this.addWidget("combo","method",this.properties.method,{property:"method",values:this._methods}))}else console.debug?.("Invalid obj",data),this._function=null,this._methods=[];this.widg_prop.options||(this.widg_prop.options={}),this.widg_prop.options.values=this._methods,this.updateInputsForMethod()}updateInputsForMethod(){var actVal=this.widg_prop.value;if(actVal&&this._obin&&void 0!==this._obin[actVal]){this._function=this._obin[actVal];Array(this._function.length);for(var names=LiteGraph.getParameterNames(this._function),i=0;i<names.length;++i)-1==this.findInputSlot(names[i])&&this.addInput(names[i],"",{auto:!0,removable:!1,nameLocked:!0});this._params=names}else console.debug?.("Invalid method",actVal),this._function=null;this.setOutputData(1,this._function)}onExecute(){}onWidgetChanged(name,value,prev_value){if(console.debug?.("Widget changed",name,value,prev_value),this.properties.method!==value)for(var i=3;i<this.inputs.length;++i)this.removeInput(i);this.updateInputsForMethod()}onAction(action){if("refresh"==action)this.updateFromInput();else if("execute"==action)if(this._function&&"function"==typeof this._function){for(var parValues=[],i=3;i<this.inputs.length;i++)parValues.push(this.getInputData(i));console.debug?.("NodeObjMethod Execute",parValues);action=this._function(parValues);this.triggerSlot(0),this.setOutputData(2,action)}else this.setOutputData(1,null),this.setOutputData(2,null)}onGetInputs(){}onGetOutputs(){}getTitle(){return this.flags.collapsed?this.properties.method:this.title}onPropertyChanged(name,value){"value"==name&&(this.widg_prop.value=value)}getExtraMenuOptions(){return[{content:"NodeObjMethod DBG",callback:function(menuitO,obX,ev,htmO,nodeX){console.debug?.(NodeObjMethod,nodeX.widg_prop,nodeX)}}]}}LiteGraph.registerNodeType("objects/method_widget",objMethodWidget);class objEvalGlo{static title="Eval Obj";static desc="Evaluate an object";constructor(){this.size=[60,30],this.addProperty("obj_eval","window"),this.addOutput("obj","object"),this._func=null,this.data={}}onConfigure=function(o){o.properties.obj_eval&&this.compileCode(o.properties.obj_eval)};static widgets_info={obj_eval:{type:"code"}};onPropertyChanged=function(name,value){"obj_eval"==name&&this.compileCode(value)};compileCode(code){if(this._func=null,LiteGraph.allow_scripts||console.warn("Obj string not evaluated, LiteGraph.allow_scripts is false"),256<code.length)console.warn?.("Script too long, max 256 chars");else{var code_eval="return "+code;try{this._func=new Function("DATA","node",code_eval),console.debug("Evaluated",code,this._func)}catch(err){console.error?.("Error parsing obj evaluation"),console.error?.(err)}}return!1}onExecute(){if(this.properties.obj_eval&&this.compileCode(this.properties.obj_eval),this._func)try{this.setOutputData(0,this._func(this.data,this))}catch(err){this.setOutputData(0,null),console.error?.("Error in code eval"),console.error?.(err)}else this.setOutputData(0,null)}}LiteGraph.registerNodeType("objects/evaluate",objEvalGlo);class EventAsFunction{static title="Event Function";static desc="Get a function binded to an event";constructor(){this.size=[60,30],this.addOutput("fun","function"),this.addOutput("executed",LiteGraph.EVENT);var that=this;this._func=function(){that.triggerSlot(1)},this.setOutputData("fun",this._func),this.data={}}onConfigure(o){this.setOutputData("fun",this._func)}onExecute(){this._func&&this.setOutputData("fun",this._func)}}LiteGraph.registerNodeType("objects/event_function",EventAsFunction);class ObjectProperty{static title="Object property";static desc="Outputs the property of an object";constructor(){this.addInput("obj","object"),this.addOutput("property",0),this.addProperty("value",0),this.widget=this.addWidget("text","prop.","",this.setValue.bind(this)),this.widgets_up=!0,this.size=[140,30],this._value=null}setValue(v){this.properties.value=v,this.widget.value=v}getTitle(){return this.flags.collapsed?"in."+this.properties.value:this.title}onPropertyChanged(name,value){this.widget.value=value}onExecute(){var data=this.getInputData(0);null!=data&&this.setOutputData(0,data[this.properties.value])}}LiteGraph.registerNodeType("objects/get_property",ObjectProperty);class ObjectKeys{static title="Object keys";static desc="Outputs an array with the keys of an object";constructor(){this.addInput("obj","object"),this.addOutput("keys","array"),this.size=[140,30]}onExecute(){var data=this.getInputData(0);null!=data&&this.setOutputData(0,Object.keys(data))}}LiteGraph.registerNodeType("objects/object_keys",ObjectKeys);class SetObject{static title="Set property";static desc="Set property of object";constructor(){this.addInput("obj","object"),this.addInput("value",""),this.addOutput("obj","object"),this.properties={property:""},this.name_widget=this.addWidget("text","prop.",this.properties.property,"property")}onExecute(){var v,obj=this.getInputData(0);obj&&void 0!==(v=this.getInputData(1))&&(this.properties.property&&(obj[this.properties.property]=v),this.setOutputData(0,obj))}}LiteGraph.registerNodeType("objects/set_property",SetObject);class MergeObjects{static title="Merge Objects";static desc="Creates an object copying properties from others";constructor(){this.addInput("A","object"),this.addInput("B","object"),this.addOutput("out","object"),this._result={};var that=this;this.addWidget("button","clear","",function(){that._result={}}),this.size=this.computeSize()}onExecute(){var A=this.getInputData(0),B=this.getInputData(1),C=this._result;if(A)for(var i in A)C[i]=A[i];if(B)for(let i in B)C[i]=B[i];this.setOutputData(0,C)}}LiteGraph.registerNodeType("objects/merge_objects",MergeObjects);class CDNLibSearch{constructor(){this.addInput("search",LiteGraph.ACTION),this.addProperty("name","","string"),this.addOutput("ready",LiteGraph.EVENT),this.addOutput("results","array"),this.addOutput("first name","object"),this.addOutput("first object","object"),this.addWidget("string","name",this.properties.name,"name"),this._data=null,this._fetching=null,this.base_url="https://api.cdnjs.com/libraries"}static title="CDN Search";static desc="Search and fetch CDN libraries";search(){var that=this,url=this.base_url,name=this.getInputOrProperty("name");name&&""!==name&&(url+="?search="+name),this._fetching=fetch(url).then(resp=>{if(resp.ok)return this.boxcolor="#0F0",resp.text();this.boxcolor="#F00",that.trigger("error")}).then(data=>{if(that._data=data,that._fetching=null,this._data&&"string"==typeof this._data)try{this._data=JSON.parse(this._data)}catch(e){console.warn?.("Not a JSON resp",this._data)}this._data&&"object"==typeof this._data&&this._data.results&&this._data.results.length&&this._data.results[0].name?(this.setOutputData(1,this._data.results),this.setOutputData(2,this._data.results[0].name),this.setOutputData(3,this._data.results[0])):(this.setOutputData(2,null),this.setOutputData(3,null)),that.trigger("ready")})}onAction(evt){"search"==evt&&this.search()}onExecute(){}onGetInputs(){return[["name","string"]]}onGetOutputs(){return[["error",LiteGraph.EVENT]]}}LiteGraph.registerNodeType("libraries/search_CDN_lib",CDNLibSearch);class CDNLibInclude{static title="CDN Load";static desc="Load and include a CDN library";constructor(){this.addInput("load",LiteGraph.ACTION),this.addInput("lib_spec","object"),this.addOutput("ready",LiteGraph.EVENT),this.addOutput("error",LiteGraph.EVENT)}load(){var url,script,that=this,lib_spec=this.getInputOrProperty("lib_spec");lib_spec&&"object"==typeof lib_spec&&lib_spec.latest&&(url=lib_spec.latest,(script=document.createElement("script")).type="text/javascript",script.onload=function(a){that.on_loaded(lib_spec,a)},script.onerror=function(e){that.on_error(lib_spec,e)},script.src=url,document.head.appendChild(script))}on_loaded(ob_lib,a){console.debug?.("Loaded library",ob_lib,a),ob_lib&&ob_lib.name?(this.trigger("ready"),libraries_loaded[ob_lib.name]=ob_lib,this.boxcolor="#0F0"):this.on_error(ob_lib)}on_error(ob_lib,e){this.trigger("error"),this.boxcolor="#F00",console.warn?.("Lib loading failed",ob_lib,e)}onAction(evt){"load"==evt&&this.load()}onExecute(){}onGetInputs(){}onGetOutputs(){}}function nodeEmpower_htmlElement(nodeX){nodeX.htmlCreateElement=function(){if(!this._added)if("undefined"!=typeof graphcanvas&&graphcanvas){const htEl=document.createElement("div"),htGraph=(this._el=htEl,this._el.classList.add("lg-html-element"),this._el.style.position="absolute",graphcanvas.canvas?.parentNode?.appendChild(this._el),this._el_cont=document.createElement("div"),this._el_cont.style.display="flex",this._el_cont.style.justifyContent="center",this._el_cont.style.overflow="auto",this._el_cont.style.position="relative",this._el_cont.style.width="100%",this._el_cont.style.height="100%",this._el_cont.style.margin="0px",this._el_cont.style.padding="0px",this._el.appendChild(this._el_cont),this._added=!0,this.htmlRefreshElement(),graphcanvas.graph);graphcanvas.registerCallbackHandler("onOpenSubgraph",function(info,graph,prev_graph){htGraph==graph?(console.debug("htmlEmpoweredNode","restore on onOpenSubgraph",this,graph),htEl.style.display=htEl.style.display_prev||"block"):(console.debug("htmlEmpoweredNode","hide on onOpenSubgraph",this,graph),htEl.style.display_prev=htEl.style.display,htEl.style.display="none")}),graphcanvas.registerCallbackHandler("onCloseSubgraph",function(info,graph,prev_graph,subgraph_node){htGraph==graph?(console.debug("htmlEmpoweredNode","restore on onCloseSubgraph",this,graph),htEl.style.display=htEl.style.display_prev||"block"):(console.debug("htmlEmpoweredNode","hide on onCloseSubgraph",this,graph),htEl.style.display_prev=htEl.style.display,htEl.style.display="none")})}else console.warn(this,"NO CANVAS")}.bind(nodeX),nodeX.htmlRefreshElement=function(){var absPos;this._added||this.htmlCreateElement(),this.pos&&this.size&&(absPos=graphcanvas.convertOffsetToCanvas(this.pos),this._el.style.left=absPos[0]+"px",this._el.style.top=absPos[1]+this.getSlotsHeight()+"px",this._el.style.width=Math.round(this.size[0]*graphcanvas.ds.scale)+"px",this._el.style.height=Math.round(this.size[1]*graphcanvas.ds.scale)-this.getSlotsHeight()+"px")}.bind(nodeX),nodeX.setHtml=function(html){this._html=html,this._el&&this._el_cont||this.htmlRefreshElement(),this._el_cont.innerHTML=this._html},nodeX.registerCallbackHandler("onConfigure",function(info){console.info("empoweredHtmlNode",this,"onConfigure",...arguments),console.info(this,"configure",info),this.refreshSlots(),this.htmlRefreshElement()}),nodeX.registerCallbackHandler("onDrawForeground",function(){this.htmlRefreshElement()}),nodeX.registerCallbackHandler("onSelected",function(){console.info("empoweredHtmlNode",this,"onSelected",...arguments)}),nodeX.registerCallbackHandler("onDeselected",function(){console.info("empoweredHtmlNode",this,"onDeselected",...arguments)}),nodeX.registerCallbackHandler("onRemoved",function(){console.info("empoweredHtmlNode",this,"onRemoved",...arguments),this._el?.parentNode?.removeChild(this._el)})}LiteGraph.registerNodeType("libraries/load",CDNLibInclude);class DOMSelector{static title="DOMSelector";static desc="Execute a selection query on the document returning the corresponging DOM element";constructor(){this.addInput("selector","string"),this.addOutput("result","htmlelement"),this.properties={}}onExecute(){var sSel=this.getInputData(0),res=null;if(sSel)try{res=document.querySelector(sSel)}catch(e){res=!1}this.setOutputData(0,res)}}LiteGraph.registerNodeType("html/dom_selector",DOMSelector);class HtmlNode{static title="Html Node";static desc="Have html inside a node";constructor(){this.addInput("html","html"),this.addOutput("element","htmlelement"),this.properties={html:""},this._added=!1,this._html="",this.size=[210,210/1.618]}refreshSlots(){this.htmlRefreshElement?.();var sHtml=this.getInputData(0);if(sHtml)try{this.setHtml?.(sHtml)}catch(e){console.log(this,"failed setting html content"),this.setHtml?.("")}else this.setHtml?.("");this.setOutputData(0,this._el_cont||!1)}onPropertyChanged(){this.refreshSlots()}onExecute(){this.refreshSlots()}onPostConstruct(){nodeEmpower_htmlElement(this)}}LiteGraph.registerNodeType("html/node_html",HtmlNode);class JsonViewerNode{static title="Json View";static desc="Show and navigate a value structure";constructor(){this.addInput("value",0),this.properties={html:""},this._added=!1,this._html="",this.size=[210,210/1.618]}onPostConstruct(){nodeEmpower_htmlElement(this)}refreshSlots(){this.htmlRefreshElement?.();var sHtml=htmlJsonViewerHelper(this.getInputData(0));if(sHtml)try{this.setHtml?.(sHtml)}catch(e){this.setHtml?.(""),console.log(this,"failed setting html content")}else this.setHtml?.("");this.setOutputData(0,this._el_cont||!1)}onPropertyChanged(){this.refreshSlots()}onExecute(){this.refreshSlots()}}function htmlJsonViewerHelper(json,collapsible=!1){var TEMPLATES={item:'<div class="json__item"><div class="json__key">%KEY%</div><div class="json__value json__value--%TYPE%">%VALUE%</div></div>',itemCollapsible:'<label class="json__item json__item--collapsible"><input type="checkbox" class="json__toggle"/><div class="json__key">%KEY%</div><div class="json__value json__value--type-%TYPE%">%VALUE%</div>%CHILDREN%</label>',itemCollapsibleOpen:'<label class="json__item json__item--collapsible"><input type="checkbox" checked class="json__toggle"/><div class="json__key">%KEY%</div><div class="json__value json__value--type-%TYPE%">%VALUE%</div>%CHILDREN%</label>'};function handleChildren(key,value,type){var item,html="";for(item in value)html+=handleItem(item,value[item]);return function(key,type,children){var tpl="itemCollapsible";return tpl=(tpl=(tpl=(tpl=TEMPLATES[tpl=collapsible?"itemCollapsibleOpen":tpl].replace("%KEY%",key)).replace("%VALUE%",type)).replace("%TYPE%",type)).replace("%CHILDREN%",children)}(key,type,html)}function handleItem(key,value){var type=typeof value;return("object"==typeof value?handleChildren:function(key,value,type){return key=TEMPLATES.item.replace("%KEY%",key),key=(key="string"==type?key.replace("%VALUE%",'"'+value+'"'):key.replace("%VALUE%",value)).replace("%TYPE%",type)})(key,value,type)}var item,obj=json,_result='<div class="html__json">';for(item in obj)_result+=handleItem(item,obj[item]);return _result+="</div>"}LiteGraph.registerNodeType("html/json_viewer",JsonViewerNode);class DOMSelectorAll{static title="DOMSelectorAll";static desc="Execute a querySelectorAll() on the document returning the corresponding Elements";constructor(){this.addInput("selector","string"),this.addOutput("result","array"),this.properties={}}onExecute(){var sSel=this.getInputData(0),res=null;sSel&&(res=document.querySelectorAll(sSel)),this.setOutputData(0,res)}}LiteGraph.registerNodeType("html/dom_selector_all",DOMSelectorAll);class HtmlEventListener{static title="HTML Listener";static desc="Add an event listener on an html element";constructor(){this.addInput("element","htmlelement"),this.addInput("add_listener",LiteGraph.ACTION),this.addOutput("listener","htmlelement_listener"),this.addOutput("on_event",LiteGraph.EVENT),this.addOutput("last_event",""),this.addOutput("current_event",""),this.addProperty("eventType",""),this.addWidget("combo","eventType",this.properties.eventType,"eventType",{values:["click","dblclick","mouseover","mousedown","mouseup","mousemove","mouseout","keydown","keyup","keypress","load","unload","mousewheel","contextmenu","focus","change","blur","pointerdown","pointerup","pointermove","pointerover","pointerout","pointerenter","pointerleave","pointercancel","gotpointercapture","lostpointercapture","touchstart","touchmove","touchend","touchcancel","submit","scroll","resize","hashchange"]}),this.mode=LiteGraph.ON_ACTION}onExecute(param,options){this.mode==LiteGraph.ON_TRIGGER?(action=this.id+"_"+(action||"action")+"_exectoact_"+LiteGraph.uuidv4(),this.onAction(action,param,options)):this.setOutputData(3,null)}onAction(action){var that,fEv,sSel=this.getInputData(0),eventType=this.getInputOrProperty("eventType"),res=null;sSel&&eventType&&sSel.addEventListener?(sSel.attributes["data-listener-"+eventType]?fEv=sSel.attributes["data-listener-"+eventType]:(that=this,sSel.addEventListener(eventType,fEv=function(e){that.setOutputData(2,e),that.setOutputData(3,e),that.triggerSlot(1)}),sSel.attributes["data-listener-"+eventType]=fEv),res={element:sSel,function:fEv,event:eventType}):console.log?.("no el to add event"),this.setOutputData(0,res)}}LiteGraph.registerNodeType("html/event_listener",HtmlEventListener);class HtmlEventListenerRemove{static title="HTML Remove Listener";static desc="Remove an event listener by passing his reference";constructor(){this.addInput("listener","htmlelement_listener"),this.addInput("remove_listener",LiteGraph.ACTION),this.addOutput("result","boolean"),this.mode=LiteGraph.ON_ACTION}onExecute(param,options){this.mode==LiteGraph.ON_TRIGGER&&(action=this.id+"_"+(action||"action")+"_exectoact_"+LiteGraph.uuidv4(),this.onAction(action,param,options))}onAction(){var oLis=this.getInputData(0),res=!1;oLis&&oLis.element&&oLis.function&&oLis.event&&oLis.element.removeEventListener?(oLis.element.attributes["data-listener-"+oLis.event]=!1,oLis.element.removeEventListener(oLis.event,oLis.function),res=!0):console.log?.("bad element to remove listener"),this.setOutputData(0,res)}}LiteGraph.registerNodeType("html/event_listener_remove",HtmlEventListenerRemove);class HtmlValue{static title="HTML GET Value";static desc="Get the value (or the text content) of an HTML element";constructor(){this.addInput("element","htmlelement"),this.addOutput("result","string")}onExecute(){var el=this.getInputData(0),res=!1;el&&"object"==typeof el&&(res=void 0!==el.value?el.value:void 0!==el.checked?!!el.checked:void 0!==el.textContent?el.textContent:""),this.setOutputData(0,res)}}LiteGraph.registerNodeType("html/element_value",HtmlValue);class HtmlValueSet{static title="HTML SET Value";static desc="Set the value (or the text content) of an HTML element";constructor(){this.addInput("element","htmlelement"),this.addInput("value","string"),this.addOutput("result","boolean"),this.addProperty("value","")}onExecute(){var el=this.getInputData(0),sVal=this.getInputOrProperty("value"),res=!1;el&&"object"==typeof el&&(void 0!==el.value?(el.value=sVal+"",res=!0):void 0!==el.checked?(el.checked=!!sVal,res=!0):void 0!==el.textContent?(el.textContent=sVal+"",res=!0):console.log?.("unkonwn element to set value")),this.setOutputData(0,res)}}LiteGraph.registerNodeType("html/element_value_set",HtmlValueSet);class HtmlCreateElement{static title="HTML Create El";static desc="Create an HTML element";constructor(){this.addInput("create",LiteGraph.ACTION),this.addInput("type","string"),this.addInput("content","html"),this.addInput("id","string"),this.addInput("class","string"),this.addOutput("element","htmlelement"),this.addProperty("type",""),this.addProperty("content",""),this.addProperty("id",""),this.addProperty("class",""),this.addWidget("combo","type",this.properties.type,"type",{values:["div","a","span","input","form","br","hr","table","th","tr","td","h1","h2","h3","h4","h5","h6"]}),this.mode=LiteGraph.ON_ACTION}onExecute(param,options){this.mode==LiteGraph.ON_TRIGGER&&(action=this.id+"_"+(action||"action")+"_exectoact_"+LiteGraph.uuidv4(),this.onAction(action,param,options))}onAction(){var sType=this.getInputOrProperty("type"),sId=this.getInputOrProperty("id"),sClass=this.getInputOrProperty("class"),sContent=this.getInputOrProperty("class"),res=null;sType&&(sType=document.createElement(sType))&&(sId&&(sType.id=sId+""),sClass&&(sType.className=sClass+""),sContent&&(sType.innerHTML=sContent+""),res=sType),this.setOutputData(0,res)}}LiteGraph.registerNodeType("html/create_element",HtmlCreateElement);class HtmlAppendChild{static title="HTML Append Child";static desc="Append an HTML element to another";constructor(){this.addInput("parent","htmlelement"),this.addInput("child","htmlelement"),this.addInput("add",LiteGraph.ACTION),this.addOutput("result",""),this.mode=LiteGraph.ON_ACTION}onExecute(param,options){this.mode==LiteGraph.ON_TRIGGER&&(action=this.id+"_"+(action||"action")+"_exectoact_"+LiteGraph.uuidv4(),this.onAction(action,param,options))}onAction(){var parent=this.getInputData(0),child=this.getInputData(1),res=null;parent&&child&&parent.appendChild&&(res=!!parent.appendChild(child)),this.setOutputData(0,res)}}LiteGraph.registerNodeType("html/append_child",HtmlAppendChild);class HtmlRemoveElement{static title="HTML Remove element";static desc="Remove an HTML element";constructor(){this.addInput("element","htmlelement"),this.addInput("remove",LiteGraph.ACTION),this.addOutput("result",""),this.mode=LiteGraph.ON_ACTION}onExecute(param,options){this.mode==LiteGraph.ON_TRIGGER&&(action=this.id+"_"+(action||"action")+"_exectoact_"+LiteGraph.uuidv4(),this.onAction(action,param,options))}onAction(){var element=this.getInputData(0),res=null;element&&element.remove&&(res=!!element.remove()),this.setOutputData(0,res)}}LiteGraph.registerNodeType("html/remove_element",HtmlRemoveElement);class HtmlElementStyle{static title="HTML Css";static desc="HTML Element apply Css Style";constructor(){this.addInput("element","htmlelement"),this.addInput("apply",LiteGraph.ACTION),this.addProperty("cssProperty",""),this.addProperty("cssValue",""),this.addOutput("result",""),this.mode=LiteGraph.ON_ACTION}static commonProperties=[{property:"box-decoration-break",values:null},{property:"hyphens",values:null},{property:"line-break",values:null},{property:"overflow-wrap",values:null},{property:"text-combine-upright",values:null},{property:"text-underline-position",values:null},{property:"@font-feature-values",values:null},{property:"font-feature-settings",values:null},{property:"font-kerning",values:null},{property:"font-language-override",values:null},{property:"font-synthesis",values:null},{property:"font-variant-alternates",values:null},{property:"font-variant-caps",values:null},{property:"font-variant-east-asian",values:null},{property:"font-variant-ligatures",values:null},{property:"font-variant-numeric",values:null},{property:"font-variant-position",values:null},{property:"text-orientation",values:null},{property:"text-combine-upright",values:null},{property:"writing-mode",values:null},{property:"ime-mode",values:null},{property:"break-after",values:null},{property:"break-before",values:null},{property:"break-inside",values:null},{property:"widows",values:null},{property:"orphans",values:null},{property:"marks",values:null},{property:"image-orientation",values:null},{property:"image-rendering",values:null},{property:"image-resolution",values:null},{property:"object-fit",values:null},{property:"object-position",values:null},{property:"mask",values:null},{property:"mask-type",values:null},{property:"mark",values:null},{property:"mark-after",values:null},{property:"mark-before",values:null},{property:"phonemes",values:null},{property:"rest",values:null},{property:"rest-after",values:null},{property:"rest-before",values:null},{property:"voice-balance",values:null},{property:"voice-duration",values:null},{property:"voice-pitch",values:null},{property:"voice-pitch-range",values:null},{property:"voice-rate",values:null},{property:"voice-stress",values:null},{property:"voice-volume",values:null},{property:"marquee-direction",values:null},{property:"marquee-play-count",values:null},{property:"marquee-speed",values:null},{property:"marquee-style",values:null},{property:"color",values:["color","initial","inherit"]},{property:"opacity",values:["number","initial","inherit"]},{property:"background-position",values:["left top\r\n      left center\r\n      left bottom\r\n      right top\r\n      right center\r\n      right bottom\r\n      center top\r\n      center center\r\n      center bottom","x% y%","xpos ypos","initial","inherit"]},{property:"background-image",values:["url('URL')","none","initial","inherit"]},{property:"background-color",values:["color","transparent","initial","inherit"]},{property:"border",values:["border-width","border-style","border-color","initial","inherit"]},{property:"word-wrap",values:["normal","break-word","initial","inherit"]},{property:"direction",values:["ltr","rtl","initial","inherit"]},{property:"unicode-bidi",values:["normal","embed","bidi-override","initial","inherit"]},{property:"font-size",values:["medium","xx-small","x-small","small","large","x-large","xx-large","smaller","larger","length","%","initial","inherit"]},{property:"text-decoration-line",values:["none","underline","overline","line-through","initial","inherit"]},{property:"border-collapse",values:["separate","collapse","initial","inherit"]},{property:"background-size",values:["auto","length","percentage"," cover"," contain","initial","inherit"]},{property:"list-style-type",values:["disc","armenian","circle","cjk-ideographic","decimal","decimal-leading-zero","georgian","hebrew","hiragana","hiragana-iroha","katakana","katakana-iroha","lower-alpha","lower-greek","lower-latin","lower-roman","none","square","upper-alpha","upper-latin","upper-roman","initial","inherit"]},{property:"@keyframes",values:["animationname","keyframes-selector","css-styles"]},{property:"border-top-width",values:["medium","thin","thick","length","initial","inherit"]},{property:"background-blend-mode",values:["normal","multiply","screen","overlay","darken","lighten","color-dodge","saturation","color","luminosity"]},{property:"background-repeat",values:["repeat","repeat-x","repeat-y","no-repeat","initial","inherit"]},{property:"background-clip",values:["border-box","padding-box","content-box","initial","inherit"]},{property:"animation-direction",values:["normal","reverse","alternate","alternate-reverse","initial","inherit"]},{property:"animation-duration",values:["time","initial","inherit"]},{property:"counter-reset",values:["none","name","number","initial","inherit"]},{property:"padding-left",values:["length","%","initial","inherit"]},{property:"border-bottom-style",values:["none","hidden","dotted","dashed","solid","double","groove","ridge","inset","outset","initial","inherit"]},{property:"list-style",values:["list-style-type","list-style-position","list-style-image","initial","inherit"]},{property:"counter-increment",values:["none","id number","initial","inherit"]},{property:"align-self",values:["auto","stretch","center","flex-start","flex-end","baseline","initial","inherit"]},{property:"min-height",values:["length","%","initial","inherit"]},{property:"visibility",values:["visible","hidden","collapse","initial","inherit"]},{property:"max-height",values:["none","length","%","initial","inherit"]},{property:"position",values:["static","absolute","fixed","relative","initial","inherit"]},{property:"border-left-width",values:["medium","thin","thick","length","initial","inherit"]},{property:"border-image-outset",values:["length"," number","initial","inherit"]},{property:"overflow-x",values:["visible","hidden","scroll","auto","initial","inherit"]},{property:"border-left-color",values:["color","transparent","initial","inherit"]},{property:"quotes",values:["none","string string string string","initial","inherit","",'"',"'","�","�","�","�","�","�","�","�","�"]},{property:"perspective-origin",values:["x-axis","y-axis","initial","inherit"]},{property:"flex",values:["flex-grow","flex-shrink","flex-basis","auto","initial","none","inherit"]},{property:"border-image",values:[" border-image-source"," border-image-slice"," border-image-width"," border-image-outset"," border-image-repeat","initial","inherit"]},{property:"animation-delay",values:["time","initial","inherit"]},{property:"border-color",values:["color","transparent","initial","inherit"]},{property:"clear",values:["none","left","right","both","initial","inherit"]},{property:"border-width",values:["medium","thin","thick","length","initial","inherit"]},{property:"overflow\r\n    ",values:["visible","hidden","scroll","auto","initial","inherit"]},{property:"column-rule-color",values:[" color","initial","inherit"]},{property:"border-right-width",values:["medium","thin","thick","length","initial","inherit"]},{property:"border-image-source",values:[" none"," image","initial","inherit"]},{property:"background-attachment",values:["scroll","fixed","local","initial","inherit"]},{property:"border-right",values:["border-right-width","border-right-style","border-right-color","initial","inherit"]},{property:"margin-right",values:["length","%","auto","initial","inherit"]},{property:"border-bottom",values:["border-bottom-width","border-bottom-style","border-bottom-color","initial","inherit"]},{property:"border-right-color",values:["color","transparent","initial","inherit"]},{property:"margin-top",values:["length","%","auto","initial","inherit"]},{property:"border-radius",values:["length","%","initial","inherit"]},{property:"max-width",values:["none","length","%","initial","inherit"]},{property:"min-width",values:["length","%","initial","inherit"]},{property:"z-index",values:["auto","number","initial","inherit"]},{property:"border-bottom-left-radius",values:["length","%","initial","inherit"]},{property:"text-transform",values:["none","capitalize","uppercase","lowercase","initial","inherit"]},{property:"text-indent",values:["length","%","initial","inherit"]},{property:"text-justify",values:["auto","inter-word","inter-ideograph","inter-cluster","distribute","kashida","trim","none","initial","inherit"]},{property:"text-align",values:["left","right","center","justify","initial","inherit"]},{property:"border-bottom-color",values:["color","transparent","initial","inherit"]},{property:"background",values:["background-color","background-image","background-position","background-size","background-repeat","background-origin","background-clip","background-attachment","initial","inherit"]},{property:"letter-spacing",values:["normal","length","initial","inherit"]},{property:"align-items",values:["stretch","center","flex-start","flex-end","baseline","initial","inherit"]},{property:"tab-size",values:["number","length","initial","inherit"]},{property:"flex-wrap",values:["nowrap","wrap","wrap-reverse","initial","inherit"]},{property:"flex-direction",values:["row","row-reverse","column","column-reverse","initial","inherit"]},{property:"flex-basis",values:["number","auto","initial","inherit"]},{property:"flex-shrink",values:["number","initial","inherit"]},{property:"bottom",values:["auto","length","%","initial","inherit"]},{property:"clip",values:["auto","shape","initial","inherit"]},{property:"flex-grow",values:["number","initial","inherit"]},{property:"font",values:["font-style","font-variant","font-weight","font-size/line-height","font-family","caption","icon","menu","message-box","small-caption","status-bar","initial","inherit"]},{property:"margin-left",values:["length","%","auto","initial","inherit"]},{property:"text-decoration-color",values:["color","initial","inherit"]},{property:"border-bottom-right-radius",values:["length","%","initial","inherit"]},{property:"list-style-position",values:["inside","outside","initial","inherit"]},{property:"top",values:["auto","length","%","initial","inherit"]},{property:"right",values:["auto","length","%","initial","inherit"]},{property:"background-origin",values:["padding-box","border-box","content-box","initial","inherit"]},{property:"table-layout",values:["auto","fixed","initial","inherit"]},{property:"margin-bottom",values:["length","%","auto","initial","inherit"]},{property:"padding-bottom",values:["length","%","initial","inherit"]},{property:"border-image-slice",values:[" number"," %"," fill","initial","inherit"]},{property:"flex-flow",values:["flex-direction","flex-wrap","initial","inherit"]},{property:"float",values:["none","left","right","initial","inherit"]},{property:"vertical-align",values:["baseline","length","%","sub","super","top","text-top","middle","bottom","text-bottom","initial","inherit"]},{property:"padding-right",values:["length","%","initial","inherit"]},{property:"width",values:["auto","length","%","initial","inherit"]},{property:"align-content",values:["stretch","center","flex-start","flex-end","space-between","space-around","initial","inherit"]},{property:"padding",values:["length","%","initial","inherit"]},{property:"hanging-punctuation",values:["none","first","last","allow-end","force-end","initial","inherit"]},{property:"border-bottom-width",values:["medium","thin","thick","length","initial","inherit"]},{property:"border-left-style",values:["none","hidden","dotted","dashed","solid","double","groove","ridge","inset","outset","initial","inherit"]},{property:"text-align-last",values:["auto","left","right","center","justify","start","end","initial","inherit"]},{property:"order",values:["number","initial","inherit"]},{property:"border-top-style",values:["none","hidden","dotted","dashed","solid","double","groove","ridge","inset","outset","initial","inherit"]},{property:"border-top-color",values:["color","transparent","initial","inherit"]},{property:"display",values:["inline","block","flex","inline-block","inline-flex","inline-table","list-item","run-in","table","table-caption","\r\n      table-column-group","table-header-group","table-footer-group","table-row-group","table-cell","table-column","table-row","none","initial","inherit"]},{property:"left",values:["auto","length","%","initial","inherit"]},{property:"border-top-left-radius",values:["length","%","initial","inherit"]},{property:"margin",values:["length","%","auto","initial","inherit"]},{property:"border-image-repeat",values:[" stretch"," repeat"," round","space","initial","inherit"]},{property:"box-shadow",values:["none","h-shadow","v-shadow","blur","spread","color","inset","initial","inherit"]},{property:"border-top-right-radius",values:["length","%","initial","inherit"]},{property:"text-decoration-style",values:["solid","double","dotted","dashed","wavy","initial","inherit"]},{property:"height",values:["auto","length","%","initial","inherit"]},{property:"border-right-style",values:["none","hidden","dotted","dashed","solid","double","groove","ridge","inset","outset","initial","inherit"]},{property:"border-left",values:["border-left-width","border-left-style","border-left-color","initial","inherit"]},{property:"border-image-width",values:["length","number","%","auto","initial","inherit"]},{property:"font-family",values:["family-name\r\n      generic-family","initial","inherit"]},{property:"border-top",values:["border-top-width","border-top-style","border-top-color","initial","inherit"]},{property:"empty-cells",values:["show","hide","initial","inherit"]},{property:"justify-content",values:["flex-start","flex-end","center","space-between","space-around","initial","inherit"]},{property:"text-shadow",values:["h-shadow","v-shadow","blur-radius","color","none","initial","inherit"]},{property:"overflow-y",values:["visible","hidden","scroll","auto","initial","inherit"]},{property:"padding-top",values:["length","%","initial","inherit"]},{property:"border-style",values:["none","hidden","dotted","dashed","solid","double","groove","ridge","inset","outset","initial","inherit"]},{property:"border-spacing",values:["length length","initial","inherit"]},{property:"word-break",values:["normal","break-all","keep-all ","initial","inherit"]},{property:"@font-face",values:["font-family","src","font-stretch","font-style","font-weight","unicode-range"]},{property:"text-decoration",values:["none","underline","overline","line-through","initial","inherit"]},{property:"white-space",values:["normal","nowrap","pre","pre-line","pre-wrap","initial","inherit"]},{property:"font-size-adjust",values:["number","none","initial","inherit"]},{property:"font-style",values:["normal","italic","oblique","initial","inherit"]},{property:"line-height",values:["normal","number","length","%","initial","inherit"]},{property:"font-weight",values:["normal","bold","bolder","lighter","100\r\n      200\r\n      300\r\n      400\r\n      500\r\n      600\r\n      700\r\n      800\r\n      900","initial","inherit"]},{property:"word-spacing",values:["normal","length","initial","inherit"]},{property:"page-break-after",values:["auto","always","avoid","left","right","initial","inherit"]},{property:"outline-color",values:["invert","color","initial","inherit"]},{property:"column-gap",values:["length","normal","initial","inherit"]},{property:"column-rule",values:[" column-rule-width"," column-rule-style"," column-rule-color","initial","inherit"]},{property:"columns",values:["auto","column-width","column-count","initial","inherit"]},{property:"column-rule-style",values:[" none"," hidden"," dotted"," dashed"," solid"," double"," groove"," ridge"," inset"," outset","initial","inherit"]},{property:"font-variant",values:["normal","small-caps","initial","inherit"]},{property:"column-rule-width",values:[" medium"," thin"," thick"," length","initial","inherit"]},{property:"cursor",values:["alias","all-scroll","auto","cell","context-menu","col-resize","copy","crosshair","default","e-resize","ew-resize","grab","grabbing","help","move","n-resize","ne-resize","nesw-resize","ns-resize","nw-resize","nwse-resize","no-drop","none","not-allowed","pointer","progress","row-resize","s-resize","se-resize","sw-resize","text","URL","vertical-text","w-resize","wait","zoom-in","zoom-out","initial","inherit"]},{property:"column-fill",values:["balance","auto","initial","inherit"]},{property:"animation-fill-mode",values:["none","forwards","backwards","both","initial","inherit"]},{property:"nav-left",values:["auto","id","target-name","initial","inherit"]},{property:"outline-width",values:["medium","thin","thick","length","initial","inherit"]},{property:"nav-right",values:["auto","id","target-name","initial","inherit"]},{property:"nav-up",values:["auto","id","target-name","initial","inherit"]},{property:"nav-down",values:["auto","id","target-name","initial","inherit"]},{property:"outline",values:["outline-color","outline-style","outline-width","initial","inherit"]},{property:"animation",values:["animation-name","animation-duration","\r\n\tanimation-timing-function","animation-delay","\r\n\tanimation-iteration-count","animation-direction","animation-fill-mode","animation-play-state","initial","inherit"]},{property:"nav-index",values:["auto","number","initial","inherit"]},{property:"font-stretch",values:["ultra-condensed","extra-condensed","condensed","semi-condensed","normal","semi-expanded","expanded","extra-expanded","ultra-expanded","initial","inherit"]},{property:"list-style-image",values:["none","url","initial","inherit"]},{property:"transition-duration",values:["time","initial","inherit"]},{property:"perspective",values:["length","none","initial","inherit"]},{property:"animation-play-state",values:["paused","running","initial","inherit"]},{property:"backface-visibility",values:["visible","hidden","initial","inherit"]},{property:"column-count",values:["number","auto","initial","inherit"]},{property:"transition-delay",values:["time","initial","inherit"]},{property:"transform",values:["none","matrix(n,n,n,n,n,n)","matrix3d\r\n\t(n,n,n,n,n,n,n,n,n,n,n,n,n,n,n,n)","translate(x,y)","translate3d(x,y,z)","translateX(x)","translateY(y)","translateZ(z)","scale(x,y)","scale3d(x,y,z)","scaleX(x)","scaleY(y)","scaleZ(z)","rotate(angle)","rotate3d(x,y,z,angle)","rotateX(angle)","rotateY(angle)","rotateZ(angle)","skew(x-angle,y-angle)","skewX(angle)","skewY(angle)","perspective(n)","initial","inherit"]},{property:"resize",values:[" none"," both"," horizontal"," vertical","initial","inherit"]},{property:"text-overflow",values:["clip","ellipsis","string","initial","inherit"]},{property:"caption-side",values:["top","bottom","initial","inherit"]},{property:"filter",values:["none","blur(px)","brightness(%)","contrast(%)","drop-shadow(h-shadow v-shadow blur spread color)","grayscale(%)","hue-rotate(deg)","invert(%)","opacity(%)","saturate(%)","sepia(%)","url()","initial","inherit"]},{property:"content",values:["normal","none","counter","attr(attribute)","string","open-quote","close-quote","no-open-quote","no-close-quote","url(url)","initial","inherit"]},{property:"transition-timing-function",values:["ease","linear","ease-in","ease-out","ease-in-out","cubic-bezier(n,n,n,n)","initial","inherit"]},{property:"box-sizing",values:[" content-box"," border-box","initial","inherit"]},{property:"page-break-before",values:["auto","always","avoid","left","right","initial","inherit"]},{property:"animation-timing-function",values:["linear","ease","ease-in","ease-out","ease-in-out","cubic-bezier(n,n,n,n)","initial","inherit"]},{property:"outline-offset",values:[" length","initial","inherit"]},{property:"column-width",values:["auto","length","initial","inherit"]},{property:"outline-style",values:["none","hidden","dotted","dashed","solid","double","groove","ridge","inset","outset","initial","inherit"]},{property:"transform-origin",values:["x-axis","y-axis","z-axis","initial","inherit"]},{property:"transform-style",values:["flat","preserve-3d","initial","inherit"]},{property:"transition",values:["transition-property","transition-duration","transition-timing-function","transition-delay","initial","inherit"]},{property:"page-break-inside",values:["auto","avoid","initial","inherit"]},{property:"column-span",values:["1","all","initial","inherit"]},{property:"transition-property",values:["none","all","property","initial","inherit"]},{property:"animation-iteration-count",values:["number","infinite","initial","inherit"]},{property:"animation-name",values:["keyframename","none","initial","inherit"]}][{property:"animation-name",values:["keyframename","none","initial","inherit"]}];onGetInputs(){var entries=[];return entries.push(["cssProperty","string",{nameLocked:!0,removable:!0}]),entries.push(["cssValue","",{nameLocked:!0,removable:!0}]),entries}onGetOutputs(){var entries=[];return entries.push(["some output"]),entries}onExecute(param,options){this.mode==LiteGraph.ON_TRIGGER&&(action=this.id+"_"+(action||"action")+"_exectoact_"+LiteGraph.uuidv4(),this.onAction(action,param,options))}onAction(){var element=this.getInputData(0),res=null,cssProperty=this.getInputOrProperty("cssProperty"),cssValue=this.getInputOrProperty("cssValue");element&&element.style?(res=element.style[cssProperty]=cssValue,console.log?.("applied",cssProperty,cssValue,"to",element)):console.log?.("no el to apply css"),this.setOutputData(0,res)}}LiteGraph.registerNodeType("html/apply_element_css",HtmlElementStyle);export{getGlobalObject,setGlobalVariable,getGlobalVariable,LiteGraphClass,root,LiteGraph,CallbackHandler,ContextMenu,CurveEditor,DragAndScale,LGraph,LGraphCanvas,LGraphGroup,LGraphNode,LLink,Subgraph,GraphInput,GraphOutput,LGraphTexture,valueToGLSL,LGShaderContext};

